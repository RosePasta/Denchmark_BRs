{"BR": {"BR_id": "4001", "BR_author": "wyessen", "BRopenT": "2020-10-08T19:23:57Z", "BRcloseT": "2020-10-20T19:07:27Z", "BR_text": {"BRsummary": "on_train_epoch_end and on_epoch_end are out of order", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n Consider the following order in which the  hooks are called from <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/issues/2816>#2816</denchmark-link>\n  (I have confirmed that in PytorchLightning version 0.10 this is still an issue):\n <denchmark-code>on_epoch_start\n on_train_epoch_start\n on_validation_start\n on_validation_epoch_start\n on_validation_epoch_end\n on_validation_end\n on_epoch_end\n on_train_epoch_end\n </denchmark-code>\n \n Naturally one would expect the opening and closing scope hooks to match. However, on_train_epoch_end is called after on_epoch_end, which seems incorrect. It is natural to open the epoch scope before the train epoch scope (as is being done currently), in which case the epoch scope should be closed after closing the train epoch scope (which is not currently being done)\n \n PyTorch Version (e.g., 1.0): 1.6.0\n OS (e.g., Linux): Ubuntu 18.04\n How you installed PyTorch (conda, pip, source): pip\n Build command you used (if compiling from source):\n Python version: 3.8.5\n CUDA/cuDNN version: NA\n GPU models and configuration: NA\n Any other relevant information: NA\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "wyessen", "commentT": "2020-10-08T19:24:37Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "wyessen", "commentT": "2020-10-08T20:29:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/wyessen>@wyessen</denchmark-link>\n  it seems that the flow is incorrect the  shall be before \n cc: <denchmark-link:https://github.com/williamFalcon>@williamFalcon</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "wyessen", "commentT": "2020-10-08T21:38:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n \n True, but depends how we should look at it: should validation be considered part of the training epoch scope? If so, then the current flow is fine; otherwise, you're right, it's incorrect.\n So, the original bug report complains about incorrect closing of the scope given the order in which the scopes were opened. You raise a valid issue, and in the broader scheme of things the current flow should be reconsidered.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "wyessen", "commentT": "2020-10-08T21:57:15Z", "comment_text": "\n \t\tyes. validation is part of the flow. as mentioned many times, big research requires checking val multiple times within an epoch\n Train: --------------------------- (1 epoch = 2 days)\n Val                --             --             --\n Then we have:\n e1 = on_epoch_start\n e2 = on_epoch_end\n t1 = on_train_epoch_start\n t2 = on_train_epoch_end\n v1 = on_val_epoch_start\n v2 = on_val_epoch_end\n Train:          e1 t1 ------------------------------------------------------------- t2 e2\n Val   :                    ________(e1 v1 --val--- v2 e2) ___ (e1 v1 --val---v2 e2)\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "wyessen", "commentT": "2020-10-08T22:06:56Z", "comment_text": "\n \t\there is an added test to check the actual flow <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/4010>#4010</denchmark-link>\n \n I think the confusion comes from using smaller models or just one validation per epoch, then you would expect to have called the validation after training...\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "wyessen", "commentT": "2020-10-08T22:55:43Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/williamFalcon>@williamFalcon</denchmark-link>\n  <denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n  So as to not hijack the original bug report, I want to clarify:\n The flow executed by PytorchLightning is incorrect in the sense that opening of a scope (with _start) does not match closing of the scope with (with _end). In particular on_epoch_end is called before on_train_epoch_end, which is not correct.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "wyessen", "commentT": "2020-10-20T17:53:27Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SeanNaren>@SeanNaren</denchmark-link>\n  Why did you close this issue? Your PR does not fix this.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "wyessen", "commentT": "2020-10-20T18:58:03Z", "comment_text": "\n \t\tApologies, I think the PR associated with this issue was incorrect!\n EDIT: after looking at the associated PR and the discussion here, I do think this PR addresses the issue of ensuring the order is correct. Was there anything in particular that wasn't addressed <denchmark-link:https://github.com/wyessen>@wyessen</denchmark-link>\n ?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "wyessen", "commentT": "2020-10-20T19:06:41Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/wyessen>@wyessen</denchmark-link>\n  this was closed with <denchmark-link:https://github.com/williamFalcon>@williamFalcon</denchmark-link>\n  explanation that the behavior is as expected \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "wyessen", "commentT": "2020-10-20T19:07:27Z", "comment_text": "\n \t\tWill close again for now...\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "wyessen", "commentT": "2020-10-20T19:10:46Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n  the behavior is not expected, please read my explanation (<denchmark-link:https://github.com/williamFalcon>@williamFalcon</denchmark-link>\n  was responding to <denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n \u2019s message, which was different from my original issue).\n \t\t"}}}, "commit": {"commit_id": "3777988502d1013508455a5fd34dc7d1a7e8e035", "commit_author": "Jirka Borovec", "commitT": "2020-10-20 13:33:46+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\utilities\\model_utils.py", "file_new_name": "pytorch_lightning\\utilities\\model_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "26", "deleted_lines": "26,27,28", "method_info": {"method_name": "is_overridden", "method_params": "str,LightningModule", "method_startline": "21", "method_endline": "43"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 36, "file_old_name": "tests\\models\\test_hooks.py", "file_new_name": "tests\\models\\test_hooks.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "252,253,254", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_start", "method_params": "self", "method_startline": "252", "method_endline": "254"}}, "hunk_1": {"Ismethod": 1, "added_lines": "168,169,170", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_epoch_end", "method_params": "self", "method_startline": "168", "method_endline": "170"}}, "hunk_2": {"Ismethod": 1, "added_lines": "248,249,250", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_epoch_end", "method_params": "self", "method_startline": "248", "method_endline": "250"}}, "hunk_3": {"Ismethod": 1, "added_lines": "208,209,210", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_end", "method_params": "self", "method_startline": "208", "method_endline": "210"}}, "hunk_4": {"Ismethod": 1, "added_lines": "256,257,258", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_end", "method_params": "self", "method_startline": "256", "method_endline": "258"}}, "hunk_5": {"Ismethod": 1, "added_lines": "224,225,226", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_epoch_end", "method_params": "self,outputs", "method_startline": "224", "method_endline": "226"}}, "hunk_6": {"Ismethod": 1, "added_lines": "164,165,166", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_epoch_start", "method_params": "self", "method_startline": "164", "method_endline": "166"}}, "hunk_7": {"Ismethod": 1, "added_lines": "172,173,174", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_fit_start", "method_params": "self", "method_startline": "172", "method_endline": "174"}}, "hunk_8": {"Ismethod": 1, "added_lines": "204,205,206", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_start", "method_params": "self", "method_startline": "204", "method_endline": "206"}}, "hunk_9": {"Ismethod": 1, "added_lines": "268,269,270", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_epoch_start", "method_params": "self", "method_startline": "268", "method_endline": "270"}}, "hunk_10": {"Ismethod": 1, "added_lines": "280,281,282", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_model_train", "method_params": "self", "method_startline": "280", "method_endline": "282"}}, "hunk_11": {"Ismethod": 1, "added_lines": "160,161,162", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_before_zero_grad", "method_params": "self,optimizer", "method_startline": "160", "method_endline": "162"}}, "hunk_12": {"Ismethod": 1, "added_lines": "232,233,234", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_end", "method_params": "self", "method_startline": "232", "method_endline": "234"}}, "hunk_13": {"Ismethod": 1, "added_lines": "200,201,202", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_pretrain_routine_end", "method_params": "self", "method_startline": "200", "method_endline": "202"}}, "hunk_14": {"Ismethod": 1, "added_lines": "260,261,262", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_batch_start", "method_params": "self,batch,batch_idx,dataloader_idx", "method_startline": "260", "method_endline": "262"}}, "hunk_15": {"Ismethod": 1, "added_lines": "196,197,198", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_pretrain_routine_start", "method_params": "self", "method_startline": "196", "method_endline": "198"}}, "hunk_16": {"Ismethod": 1, "added_lines": "180,181,182", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_hpc_load", "method_params": "self,checkpoint", "method_startline": "180", "method_endline": "182"}}, "hunk_17": {"Ismethod": 1, "added_lines": "188,189,190", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_load_checkpoint", "method_params": "self,checkpoint", "method_startline": "188", "method_endline": "190"}}, "hunk_18": {"Ismethod": 1, "added_lines": "152,153,154", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.__init__", "method_params": "self", "method_startline": "152", "method_endline": "154"}}, "hunk_19": {"Ismethod": 1, "added_lines": "216,217,218", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_batch_end", "method_params": "self,outputs,batch,batch_idx,dataloader_idx", "method_startline": "216", "method_endline": "218"}}, "hunk_20": {"Ismethod": 1, "added_lines": "264,265,266", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_batch_end", "method_params": "self,outputs,batch,batch_idx,dataloader_idx", "method_startline": "264", "method_endline": "266"}}, "hunk_21": {"Ismethod": 1, "added_lines": "176,177,178", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_fit_end", "method_params": "self", "method_startline": "176", "method_endline": "178"}}, "hunk_22": {"Ismethod": 1, "added_lines": "272,273,274", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_epoch_end", "method_params": "self", "method_startline": "272", "method_endline": "274"}}, "hunk_23": {"Ismethod": 1, "added_lines": "276,277,278", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_model_eval", "method_params": "self", "method_startline": "276", "method_endline": "278"}}, "hunk_24": {"Ismethod": 1, "added_lines": "228,229,230", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_start", "method_params": "self", "method_startline": "228", "method_endline": "230"}}, "hunk_25": {"Ismethod": 1, "added_lines": "148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system", "method_params": "tmpdir", "method_startline": "148", "method_endline": "358"}}, "hunk_26": {"Ismethod": 1, "added_lines": "212,213,214", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_batch_start", "method_params": "self,batch,batch_idx,dataloader_idx", "method_startline": "212", "method_endline": "214"}}, "hunk_27": {"Ismethod": 1, "added_lines": "284,285,286", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_model_eval", "method_params": "self", "method_startline": "284", "method_endline": "286"}}, "hunk_28": {"Ismethod": 1, "added_lines": "156,157,158", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_after_backward", "method_params": "self", "method_startline": "156", "method_endline": "158"}}, "hunk_29": {"Ismethod": 1, "added_lines": "236,237,238", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_batch_start", "method_params": "self,batch,batch_idx,dataloader_idx", "method_startline": "236", "method_endline": "238"}}, "hunk_30": {"Ismethod": 1, "added_lines": "192,193,194", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_save_checkpoint", "method_params": "self,checkpoint", "method_startline": "192", "method_endline": "194"}}, "hunk_31": {"Ismethod": 1, "added_lines": "288,289,290", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_test_model_train", "method_params": "self", "method_startline": "288", "method_endline": "290"}}, "hunk_32": {"Ismethod": 1, "added_lines": "220,221,222", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_train_epoch_start", "method_params": "self", "method_startline": "220", "method_endline": "222"}}, "hunk_33": {"Ismethod": 1, "added_lines": "240,241,242", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_batch_end", "method_params": "self,outputs,batch,batch_idx,dataloader_idx", "method_startline": "240", "method_endline": "242"}}, "hunk_34": {"Ismethod": 1, "added_lines": "244,245,246", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_validation_epoch_start", "method_params": "self", "method_startline": "244", "method_endline": "246"}}, "hunk_35": {"Ismethod": 1, "added_lines": "184,185,186", "deleted_lines": null, "method_info": {"method_name": "test_trainer_model_hook_system.on_hpc_save", "method_params": "self,checkpoint", "method_startline": "184", "method_endline": "186"}}}}}}}