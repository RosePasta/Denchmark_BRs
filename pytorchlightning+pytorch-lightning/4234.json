{"BR": {"BR_id": "4234", "BR_author": "pbmstrk", "BRopenT": "2020-10-19T14:34:45Z", "BRcloseT": "2020-10-20T16:33:19Z", "BR_text": {"BRsummary": "Values logged in test_epoch_end not returned when calling test()", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n When calling test(), if values are logged only in the test_epoch_end method they are not returned. This leads to the following somewhat inconsistent behaviour:\n \n Values logged only in step method -> appear in list returned by test().\n Values logged in step and epoch_end -> both appear in list returned by test().\n Values logged only in epoch_end -> values do not appear.\n \n <denchmark-h:h2>Please reproduce using the BoringModel and post here</denchmark-h>\n \n <denchmark-link:https://colab.research.google.com/drive/1C1UiT815EAP6CGZcumhQ_JP8RMVBdFpX?usp=sharing>https://colab.research.google.com/drive/1C1UiT815EAP6CGZcumhQ_JP8RMVBdFpX?usp=sharing</denchmark-link>\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n If values are logged only in epoch_end they should be returned by test().\n <denchmark-h:h3>Environment</denchmark-h>\n \n PL version: 1.0.2\n see colab.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "pbmstrk", "commentT": "2020-10-19T14:54:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SeanNaren>@SeanNaren</denchmark-link>\n  mind have look? :]\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "pbmstrk", "commentT": "2020-10-19T16:25:32Z", "comment_text": "\n \t\tThanks for the report <denchmark-link:https://github.com/pbmstrk>@pbmstrk</denchmark-link>\n ! Fairly simple but with a couple of ways to fix this.\n The issue arises because when we log metrics, we do not include any custom logged epoch end metrics. The reason why this is included when something happens within the  function is because we actually complete the loop <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/blob/master/pytorch_lightning/trainer/connectors/logger_connector.py#L174>here</denchmark-link>\n  which reduces step metrics per dataloader.\n At <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/blob/master/pytorch_lightning/trainer/connectors/logger_connector.py#L197>this</denchmark-link>\n  line we add everything in callback_metrics which includes our custom logged metric in .\n Solution 1\n Add the below lines in the step metrics calculation in logger_connector.py, replacing the simple continue operation:\n if len(self.callback_metrics) > 0:\n     self.eval_loop_results.append(self.callback_metrics)\n continue\n The issue with this solution is that if we had multiple data-loaders, our custom metric will be added to every result for each data-loader. This is currently already the case if there is another metric already that is being reduced per dataloader.\n will return with multi dl:\n [\n     {\n         'custom_metric': 0.4\n     },\n     {\n         'custom_metric': 0.4\n     }\n ]\n Solution 2\n Add the below lines after the step metrics calculation, creating a separate entry in the return Results List for custom metrics. I.e add after the dataloader metrics loop:\n                 if len(self.callback_metrics) > 0:\n                     self.eval_loop_results.append(self.callback_metrics)\n will return:\n [\n     {\n         'y/dl1': 1.4e-4,\n     },\n     {\n         'x/dl2': 1.8e-3,\n     },\n     {\n         'custom_metric': 0.4\n     }\n ]\n cc <denchmark-link:https://github.com/tchaton>@tchaton</denchmark-link>\n  <denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "pbmstrk", "commentT": "2020-10-20T09:25:13Z", "comment_text": "\n \t\tWill implement solution 1, as this reflects what we see if there are step logging.\n \t\t"}}}, "commit": {"commit_id": "c33688195964f7582011d10464cced0bc43fbe55", "commit_author": "Sean Naren", "commitT": "2020-10-20 18:33:18+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\connectors\\logger_connector.py", "file_new_name": "pytorch_lightning\\trainer\\connectors\\logger_connector.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "176,177,178", "deleted_lines": null, "method_info": {"method_name": "_log_on_evaluation_epoch_end_metrics", "method_params": "self,epoch_logs", "method_startline": "137", "method_endline": "209"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\trainer\\logging\\test_eval_loop_logging_1_0.py", "file_new_name": "tests\\trainer\\logging\\test_eval_loop_logging_1_0.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "322,323,324", "deleted_lines": null, "method_info": {"method_name": "test_eval_epoch_only_logging.test_epoch_end", "method_params": "self,outputs", "method_startline": "322", "method_endline": "324"}}, "hunk_1": {"Ismethod": 1, "added_lines": "315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344", "deleted_lines": null, "method_info": {"method_name": "test_eval_epoch_only_logging", "method_params": "tmpdir,batches,log_interval,max_epochs", "method_startline": "315", "method_endline": "344"}}}}}}}