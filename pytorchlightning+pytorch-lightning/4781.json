{"BR": {"BR_id": "4781", "BR_author": "junwen-austin", "BRopenT": "2020-11-20T03:55:48Z", "BRcloseT": "2020-12-05T14:49:46Z", "BR_text": {"BRsummary": "Potential bug in metric when updated with a slice of tensor in DDP", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n when a metric is updated with a slice of tensor as one of the inputs (either pred or target) with multiple GPU with DDP, it throws out an error:\n <denchmark-code>RuntimeError: Tensors must be non-overlapping and dense\n </denchmark-code>\n \n Once the slice of the tensor is clone and detach, then it works.\n <denchmark-h:h2>Please reproduce using [the BoringModel and post here]</denchmark-h>\n \n The issue can be reproduced below:\n <denchmark-link:https://colab.research.google.com/drive/1yuqwb8BHhmDATp2IUNRNjSXOg3kV73Wp?usp=sharing>https://colab.research.google.com/drive/1yuqwb8BHhmDATp2IUNRNjSXOg3kV73Wp?usp=sharing</denchmark-link>\n \n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n the metric update should work with a slice of tensor\n <denchmark-h:h3>Environment</denchmark-h>\n \n CUDA:\n - GPU:\n - Tesla P100-PCIE-16GB\n - available:         True\n - version:           10.1\n \n Packages:\n \n numpy:             1.18.5\n pyTorch_debug:     True\n pyTorch_version:   1.7.0+cu101\n pytorch-lightning: 1.0.7\n tqdm:              4.41.1\n \n \n System:\n \n OS:                Linux\n architecture:\n \n 64bit\n \n \n \n processor:         x86_64\n python:            3.6.9\n version:           #1 SMP Thu Jul 23 08:00:38 PDT 2020\n \n \n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "junwen-austin", "commentT": "2020-11-20T05:02:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SkafteNicki>@SkafteNicki</denchmark-link>\n  I thought we solved something like this?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "junwen-austin", "commentT": "2020-11-20T07:37:18Z", "comment_text": "\n \t\tI also though we already fixed this.\n <denchmark-link:https://github.com/junwen-austin>@junwen-austin</denchmark-link>\n  when I try to run the colab you linked to, I cannot reproduce. Is this only happening in ddp mode?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "junwen-austin", "commentT": "2020-11-20T14:09:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SkafteNicki>@SkafteNicki</denchmark-link>\n  Could you try the notebook again with the ddp (which I just updated). The issue was initially identified with ddp but you are right the issue does not replicate without ddp. I'll also update the post once you confirm this issue exists in the ddp model even with 1 GPU. Thanks.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "junwen-austin", "commentT": "2020-11-22T10:25:13Z", "comment_text": "\n \t\tSo I can confirm that this happens when running in ddp mode, however I am not sure if this is a bug. It had nothing to do with detach bug we had some weeks ago.\n This happens because all_gather requires all tensors to be contiguous (data is stored in an uninterrupted block of memory). When you take a slice of a tensor, you don\u00b4t alter the underlying memory location of data, just how you read it (basically changing the stride). If you try this in your code, you can see for yourself\n <denchmark-code>print('output', output.is_contiguous()) # True\n print('output slice', output[:,0].is_contiguous()) # False\n </denchmark-code>\n \n the reason why calling output[:,0].detach().clone() works is that clone takes a contiguous copy of the data (the detach() is not nessesary). The more correct solution would be to call:\n <denchmark-code>self.metric.update(output[:, 0].contiguous(),  \n                    output[:, 1].contiguous())\n </denchmark-code>\n \n We could easily implement calling  inside the lightning metric on all tensors, however I at least want <denchmark-link:https://github.com/ananyahjha93>@ananyahjha93</denchmark-link>\n  opinion on this before moving forward.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "junwen-austin", "commentT": "2020-11-22T13:45:10Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SkafteNicki>@SkafteNicki</denchmark-link>\n   thanks for the follow-up and good to know the more correct solution :)\n \t\t"}}}, "commit": {"commit_id": "1b40a4053d4b2116de02938b747946446443c54a", "commit_author": "Nicki Skafte", "commitT": "2020-12-05 15:49:45+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "123,124,125", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\utilities\\distributed.py", "file_new_name": "pytorch_lightning\\utilities\\distributed.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "92,93,94", "deleted_lines": null, "method_info": {"method_name": "gather_all_tensors", "method_params": "None", "method_startline": "76", "method_endline": "103"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tests\\metrics\\test_ddp.py", "file_new_name": "tests\\metrics\\test_ddp.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65", "deleted_lines": null, "method_info": {"method_name": "_test_non_contiguous_tensors", "method_params": "rank,worldsize", "method_startline": "49", "method_endline": "65"}}, "hunk_1": {"Ismethod": 1, "added_lines": "69,70,71", "deleted_lines": null, "method_info": {"method_name": "test_non_contiguous_tensors", "method_params": "", "method_startline": "69", "method_endline": "71"}}, "hunk_2": {"Ismethod": 1, "added_lines": "60,61,62", "deleted_lines": null, "method_info": {"method_name": "_test_non_contiguous_tensors.compute", "method_params": "self", "method_startline": "60", "method_endline": "62"}}, "hunk_3": {"Ismethod": 1, "added_lines": "53,54,55", "deleted_lines": null, "method_info": {"method_name": "_test_non_contiguous_tensors.__init__", "method_params": "self", "method_startline": "53", "method_endline": "55"}}, "hunk_4": {"Ismethod": 1, "added_lines": "57,58", "deleted_lines": null, "method_info": {"method_name": "_test_non_contiguous_tensors.update", "method_params": "self,x", "method_startline": "57", "method_endline": "58"}}}}}}}