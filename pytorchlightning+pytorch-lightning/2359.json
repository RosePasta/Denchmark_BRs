{"BR": {"BR_id": "2359", "BR_author": "narain1", "BRopenT": "2020-06-25T11:45:38Z", "BRcloseT": "2020-07-23T13:32:12Z", "BR_text": {"BRsummary": "Problem with loading checkpoint of a model with embeddings", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n Unable to load from checkpoint for model with embeddings\n <denchmark-h:h4>Code sample</denchmark-h>\n \n model arch\n <denchmark-code>class Model(pl.LightningModule):\n       def __init__(self, emb_szs):\n             super().__init__()\n             m = get_base()\n             self.enc =  nn.Sequential(*list(m.children())[:-1], nn.Flatten())    \n             nc = list(m.children())[-1].in_features\n             self.head = nn.Sequential(nn.Linear(2*nc+25,512),Mish(),\n                                 nn.BatchNorm1d(512), nn.Dropout(0.5),nn.Linear(512,2))\n             self.embs = nn.ModuleList([nn.Embedding(c, s) for c,s in emb_szs])\n     \n       def forward(self, xb, x_cat, x_cont):\n              x1 = [e(x_cat[:,i]-1) for i,e in enumerate(self.embs)]\n              x1 = torch.cat(x1, 1)\n              x_img = self.enc(xb)\n              x = torch.cat([x1, x_cont.unsqueeze(1)], 1)\n              x = torch.cat([x, x_img], 1)\n              return self.head(x)\n </denchmark-code>\n \n <denchmark-code>  checkpoint_callback = ModelCheckpoint(\n              filepath=os.path.join(os.getcwd(), 'model_dir'),\n              #     save_top_k=True,\n              verbose=True,\n              monitor='val_loss',\n              mode='min',\n              prefix=''\n              )\n \n    trainer = Trainer(max_epochs=15, \n               early_stop_callback = early_stopping,\n               gpus=1,\n               gradient_clip_val=1.0,\n               weights_save_path=os.getcwd(),\n               checkpoint_callback = checkpoint_callback,\n               num_sanity_val_steps=0\n              )\n </denchmark-code>\n \n <denchmark-h:h4>the training loop has no problem but when I call trainer.test() a runtime error arrises</denchmark-h>\n \n RuntimeError: Error(s) in loading state_dict for Model:\n Unexpected key(s) in state_dict: \"embs.0.weight\", \"embs.1.weight\", \"embs.2.weight\", \"embs.3.weight\".\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n As in the documentation It should have used the best checkpoint for test but loading checkpoint fails\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n CUDA:\n \n GPU:\n \n Tesla P100-PCIE-16GB\n \n \n available:         True\n version:           10.1\n \n \n Packages:\n \n numpy:             1.18.1\n pyTorch_debug:     False\n pyTorch_version:   1.5.1\n pytorch-lightning: 0.8.1\n tensorboard:       2.2.2\n tqdm:              4.45.0\n \n \n System:\n \n OS:                Linux\n architecture:\n \n 64bit\n \n \n \n processor:         x86_64\n python:            3.7.6\n version:           #1 SMP Sat Jun 13 11:04:33 PDT 2020\n \n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "narain1", "commentT": "2020-06-25T11:46:23Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "narain1", "commentT": "2020-06-28T19:35:09Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/narain1>@narain1</denchmark-link>\n  mind sharing a minimal running example, in your case there are several functions that cannot be traced...\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "narain1", "commentT": "2020-06-29T03:33:52Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/narain1/projects/blob/master/melanoma-lit-x2.ipynb>https://github.com/narain1/projects/blob/master/melanoma-lit-x2.ipynb</denchmark-link>\n \n Above is the link to the jupyter notebook along with the stack trace\n \t\t"}}}, "commit": {"commit_id": "51711c265a9e234f2b4164f1a2fab73373707d61", "commit_author": "Jirka Borovec", "commitT": "2020-06-27 16:38:03-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": ".github\\PULL_REQUEST_TEMPLATE.md", "file_new_name": ".github\\PULL_REQUEST_TEMPLATE.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "14", "deleted_lines": "14"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "43,44", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\core\\saving.py", "file_new_name": "pytorch_lightning\\core\\saving.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "173,187,188,189,192,193,194,195,197,198,200,203", "deleted_lines": "173,187,190,191,193,194,196,199", "method_info": {"method_name": "_load_model_state", "method_params": "cls,str,args,kwargs", "method_startline": "173", "method_endline": "205"}}, "hunk_1": {"Ismethod": 1, "added_lines": "173,187,188,189,192,193,194,195,197,198,200,203", "deleted_lines": "173,187,190,191,193,194,196,199", "method_info": {"method_name": "_load_model_state", "method_params": "cls,str,cls_args,cls_kwargs", "method_startline": "173", "method_endline": "209"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\training_io.py", "file_new_name": "pytorch_lightning\\trainer\\training_io.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "327", "deleted_lines": "327", "method_info": {"method_name": "dump_checkpoint", "method_params": "self,bool", "method_startline": "315", "method_endline": "374"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\base\\model_template.py", "file_new_name": "tests\\base\\model_template.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "39,40,41,42,43,44,45,46,47,48,49,50,51", "deleted_lines": "39,40,41,42,43,44,45,46,47,48,49,50,51", "method_info": {"method_name": "__init__", "method_params": "self,args,float,int,int,float,str,str,int,int,float,float,kwargs", "method_startline": "39", "method_endline": "51"}}, "hunk_1": {"Ismethod": 1, "added_lines": "39,40,41,42,43,44,45,46,47,48,49,50", "deleted_lines": "39,40,41,42,43,44,45,46,47,48,49,50", "method_info": {"method_name": "__init__", "method_params": "self,float,int,int,float,str,str,int,int,float,float", "method_startline": "39", "method_endline": "50"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\models\\test_hparams.py", "file_new_name": "tests\\models\\test_hparams.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "278,279,280,281,282,283,284,285,286", "deleted_lines": "278,279,280,281,282,283,284,285,286,287", "method_info": {"method_name": "test_collect_init_arguments", "method_params": "tmpdir,cls", "method_startline": "249", "method_endline": "290"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_deprecated.py", "file_new_name": "tests\\test_deprecated.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "132,145", "deleted_lines": "131,133,146", "method_info": {"method_name": "test_tbd_remove_in_v1_0_0_model_hooks", "method_params": "", "method_startline": "130", "method_endline": "156"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\trainer\\test_lr_finder.py", "file_new_name": "tests\\trainer\\test_lr_finder.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "185", "deleted_lines": "185", "method_info": {"method_name": "test_suggestion_with_non_finite_values", "method_params": "tmpdir", "method_startline": "181", "method_endline": "199"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\trainer\\test_optimizers.py", "file_new_name": "tests\\trainer\\test_optimizers.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "234", "deleted_lines": "234", "method_info": {"method_name": "test_configure_optimizer_from_dict", "method_params": "tmpdir", "method_startline": "223", "method_endline": "242"}}}}}}}