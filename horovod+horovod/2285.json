{"BR": {"BR_id": "2285", "BR_author": "BobLiu20", "BRopenT": "2020-09-17T13:39:00Z", "BRcloseT": "2020-09-21T23:12:24Z", "BR_text": {"BRsummary": "tf-keras example is not working well when scale worker up in elastic mode", "BRdescription": "\n Environment:\n \n Framework: tf-keras\n Framework version: 1.15.0\n Horovod version: v0.20.0\n \n Bug report:\n Just run this example examples/elastic/tensorflow_keras_mnist_elastic.py in elastic mode. It will be blocked when try to scale worker up.\n FYI\n I am trying to resolve this issue. Unfortunately, I can't find out how to reset the uniq id of op name.\n For example, sync state in first time, the name is dict.sz. But the second time is dict.sz_1 and so on. In this case the new worker's name is dict.sz in first time. It is mismatch between new and old worker.\n Any idea for this issue?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "BobLiu20", "commentT": "2020-09-17T13:51:22Z", "comment_text": "\n \t\tThanks for raising this issue <denchmark-link:https://github.com/BobLiu20>@BobLiu20</denchmark-link>\n , let me take a look.  We definitely have this working in CI, so it may be we just need to tweak this script to use the same structure as our tests.  Worst case, we may need to call <denchmark-link:https://www.tensorflow.org/api_docs/python/tf/keras/backend/reset_uids>tf.keras.backend.reset_uids</denchmark-link>\n  to avoid the incrementing.  I will take a look today.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "BobLiu20", "commentT": "2020-09-17T13:53:45Z", "comment_text": "\n \t\tHmm, looks like we don't TensorFlow Keras v1 under CI for elastic mode, let me add that and see if we can fix this along the way.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "BobLiu20", "commentT": "2020-09-17T22:36:24Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/BobLiu20>@BobLiu20</denchmark-link>\n , can you try <denchmark-link:https://github.com/horovod/horovod/pull/2289>#2289</denchmark-link>\n  and let me know if it works for you?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "BobLiu20", "commentT": "2020-09-18T03:22:16Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  Thanks. The issue still here:\n Scale worker from 2 to 3. The each worker have 4 process.\n <denchmark-code>Fri Sep 18 03:11:09 2020[0]<stderr>:[2020-09-18 03:11:09.347196: W /tmp/pip-req-build-dc48wa7r/horovod/common/stall_inspector.cc:105] One or more ten[283/1927]\n submitted to be reduced, gathered or broadcasted by subset of ranks and are waiting for remainder of ranks for more than 60 seconds. This may indicate that dif\n ferent ranks are trying to submit different tensors or that only subset of ranks is submitting tensors, which will cause deadlock.\n Fri Sep 18 03:11:09 2020[0]<stderr>:Missing ranks:\n Fri Sep 18 03:11:09 2020[0]<stderr>:0: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:1: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:2: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:3: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:4: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:5: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:6: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:7: [broadcast_object_fn.sz]\n Fri Sep 18 03:11:09 2020[0]<stderr>:8: [training/DistributedAdadelta_Allreduce/cond/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_Conv2D_grad_$\n onv2DBackpropFilter_0, training/DistributedAdadelta_Allreduce/cond_1/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_BiasAdd_grad_BiasAddGrad_0,\n training/DistributedAdadelta_Allreduce/cond_2/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_Conv2D_grad_Conv2DBackpropFilter_0, training/Dis$\n ributedAdadelta_Allreduce/cond_3/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_BiasAdd_grad_BiasAddGrad_0, training/DistributedAdadelta_Allr$\n duce/cond_4/HorovodAllreduce_training_Adadelta_gradients_gradients_dense_MatMul_grad_MatMul_1_0, training/DistributedAdadelta_Allreduce/cond_5/HorovodAllreduc$\n _training_Adadelta_gradients_gradients_dense_BiasAdd_grad_BiasAddGrad_0 ...]\n Fri Sep 18 03:11:09 2020[0]<stderr>:9: [training/DistributedAdadelta_Allreduce/cond/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_Conv2D_grad_$\n onv2DBackpropFilter_0, training/DistributedAdadelta_Allreduce/cond_1/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_BiasAdd_grad_BiasAddGrad_0,\n training/DistributedAdadelta_Allreduce/cond_2/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_Conv2D_grad_Conv2DBackpropFilter_0, training/Dis$\n ributedAdadelta_Allreduce/cond_3/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_BiasAdd_grad_BiasAddGrad_0, training/DistributedAdadelta_Allr$\n duce/cond_4/HorovodAllreduce_training_Adadelta_gradients_gradients_dense_MatMul_grad_MatMul_1_0, training/DistributedAdadelta_Allreduce/cond_5/HorovodAllreduc$\n _training_Adadelta_gradients_gradients_dense_BiasAdd_grad_BiasAddGrad_0 ...]\n Fri Sep 18 03:11:09 2020[0]<stderr>:10: [training/DistributedAdadelta_Allreduce/cond/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_Conv2D_grad$\n Conv2DBackpropFilter_0, training/DistributedAdadelta_Allreduce/cond_1/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_BiasAdd_grad_BiasAddGrad_0$\n  training/DistributedAdadelta_Allreduce/cond_2/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_Conv2D_grad_Conv2DBackpropFilter_0, training/Di$\n tributedAdadelta_Allreduce/cond_3/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_BiasAdd_grad_BiasAddGrad_0, training/DistributedAdadelta_All$\n educe/cond_4/HorovodAllreduce_training_Adadelta_gradients_gradients_dense_MatMul_grad_MatMul_1_0, training/DistributedAdadelta_Allreduce/cond_5/HorovodAllredu$\n e_training_Adadelta_gradients_gradients_dense_BiasAdd_grad_BiasAddGrad_0 ...]\n Fri Sep 18 03:11:09 2020[0]<stderr>:11: [training/DistributedAdadelta_Allreduce/cond/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_Conv2D_grad$\n Conv2DBackpropFilter_0, training/DistributedAdadelta_Allreduce/cond_1/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_BiasAdd_grad_BiasAddGrad_0$\n  training/DistributedAdadelta_Allreduce/cond_2/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_Conv2D_grad_Conv2DBackpropFilter_0, training/Di$\n tributedAdadelta_Allreduce/cond_3/HorovodAllreduce_training_Adadelta_gradients_gradients_conv2d_1_BiasAdd_grad_BiasAddGrad_0, training/DistributedAdadelta_All$\n educe/cond_4/HorovodAllreduce_training_Adadelta_gradients_gradients_dense_MatMul_grad_MatMul_1_0, training/DistributedAdadelta_Allreduce/cond_5/HorovodAllredu$\n e_training_Adadelta_gradients_gradients_dense_BiasAdd_grad_BiasAddGrad_0 ...]\n Fri Sep 18 03:12:09 2020[0]<stderr>:[2020-09-18 03:12:09.351095: W /tmp/pip-req-build-dc48wa7r/horovod/common/stall_inspector.cc:105] One or more tensors were\n submitted to be reduced, gathered or broadcasted by subset of ranks and are waiting for remainder of ranks for more than 60 seconds. This may indicate that di$\n ferent ranks are trying to submit different tensors or that only subset of ranks is submitting tensors, which will cause deadlock.\n </denchmark-code>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "BobLiu20", "commentT": "2020-09-18T04:29:12Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  After debug, It seems new worker will trigger on_batch_end in CommitStateCallbackImpl before sync weight. So new worker will call check_host_updates() immediately  but old worker is not.\n <denchmark-link:https://user-images.githubusercontent.com/6102702/93556119-80ddd680-f9aa-11ea-95b2-8eb1c752bd13.png></denchmark-link>\n \n I don't konw why...\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "BobLiu20", "commentT": "2020-09-18T13:35:35Z", "comment_text": "\n \t\tThanks for digging into this <denchmark-link:https://github.com/BobLiu20>@BobLiu20</denchmark-link>\n , and apologies for the ongoing issues.  I'll look into this a bit more today and see if I can figure out what's going on.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "BobLiu20", "commentT": "2020-09-18T15:32:56Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/BobLiu20>@BobLiu20</denchmark-link>\n , I was able to repro the issue in my environment and resolve it.  It appears the problem was due to the Keras Callback state not being reinitialized when workers were added or removed.  As a result, the old workers were committing at different steps from the new workers.  I have updated the PR with changes to address this, please try it again and let me know if it works this time.  Thanks.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "BobLiu20", "commentT": "2020-09-21T02:29:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  Cool. It is working well now. Thanks\n \t\t"}}}, "commit": {"commit_id": "0f37436eae7485aa586231f85b8fc6b2ad4b78ca", "commit_author": "Travis Addair", "commitT": "2020-09-21 16:12:23-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": ".buildkite\\gen-pipeline.sh", "file_new_name": ".buildkite\\gen-pipeline.sh", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "271", "deleted_lines": "271"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "examples\\elastic\\tensorflow_keras_mnist_elastic.py", "file_new_name": "examples\\elastic\\tensorflow_keras_mnist_elastic.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "108,109,111", "deleted_lines": null, "method_info": {"method_name": "train", "method_params": "state", "method_startline": "107", "method_endline": "114"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "horovod\\_keras\\__init__.py", "file_new_name": "horovod\\_keras\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "33,34,35,36,37,38,39,40", "deleted_lines": "32,33,34,35,37", "method_info": {"method_name": "__init__", "method_params": "self,kwargs", "method_startline": "30", "method_endline": "41"}}, "hunk_1": {"Ismethod": 1, "added_lines": "64,66", "deleted_lines": "61,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94", "method_info": {"method_name": "_allreduce", "method_params": "self,gradients", "method_startline": "61", "method_endline": "94"}}, "hunk_2": {"Ismethod": 1, "added_lines": "64,66", "deleted_lines": "64,65,66", "method_info": {"method_name": "_allreduce", "method_params": "self,grads", "method_startline": "64", "method_endline": "66"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "horovod\\_keras\\elastic.py", "file_new_name": "horovod\\_keras\\elastic.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "35,36", "deleted_lines": null, "method_info": {"method_name": "on_epoch_end", "method_params": "self,epoch,logs", "method_startline": "35", "method_endline": "36"}}, "hunk_1": {"Ismethod": 1, "added_lines": "32", "deleted_lines": null, "method_info": {"method_name": "on_batch_end", "method_params": "self,batch,logs", "method_startline": "29", "method_endline": "33"}}, "hunk_2": {"Ismethod": 1, "added_lines": "25,26,27", "deleted_lines": null, "method_info": {"method_name": "on_train_begin", "method_params": "self,logs", "method_startline": "25", "method_endline": "27"}}, "hunk_3": {"Ismethod": 1, "added_lines": "38,39", "deleted_lines": null, "method_info": {"method_name": "commit", "method_params": "self", "method_startline": "38", "method_endline": "39"}}, "hunk_4": {"Ismethod": 1, "added_lines": "72,73,74,75", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,backend,state,args", "method_startline": "67", "method_endline": "75"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\common\\stall_inspector.cc", "file_new_name": "horovod\\common\\stall_inspector.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "76", "deleted_lines": "76", "method_info": {"method_name": "horovod::common::StallInspector::CheckForStalledTensors", "method_params": "global_size", "method_startline": "26", "method_endline": "110"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\runner\\elastic\\driver.py", "file_new_name": "horovod\\runner\\elastic\\driver.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "148,149", "deleted_lines": "148", "method_info": {"method_name": "wait_for_available_slots", "method_params": "self,min_np,min_hosts", "method_startline": "145", "method_endline": "168"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "horovod\\runner\\launch.py", "file_new_name": "horovod\\runner\\launch.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "707,708,709", "deleted_lines": null, "method_info": {"method_name": "_run", "method_params": "args", "method_startline": "689", "method_endline": "713"}}, "hunk_1": {"Ismethod": 1, "added_lines": "509", "deleted_lines": "485,486,511", "method_info": {"method_name": "_run_static", "method_params": "args", "method_startline": "484", "method_endline": "572"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\tensorflow\\__init__.py", "file_new_name": "horovod\\tensorflow\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "263,264,265,266,267,268", "deleted_lines": "263,264,265,266,267,268", "method_info": {"method_name": "allreduce_grads", "method_params": "grads", "method_startline": "255", "method_endline": "270"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "horovod\\tensorflow\\elastic.py", "file_new_name": "horovod\\tensorflow\\elastic.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "133", "deleted_lines": null, "method_info": {"method_name": "sync", "method_params": "self", "method_startline": "132", "method_endline": "135"}}, "hunk_1": {"Ismethod": 1, "added_lines": "111,112,113,114,115,116,117,118,120", "deleted_lines": "111,112,113,114,116", "method_info": {"method_name": "__init__", "method_params": "self,model,optimizer,backend,kwargs", "method_startline": "102", "method_endline": "122"}}, "hunk_2": {"Ismethod": 1, "added_lines": "111,112", "deleted_lines": "111,112", "method_info": {"method_name": "__init__.broadcast_object_with_session", "method_params": "obj", "method_startline": "111", "method_endline": "112"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\data\\expected_buildkite_pipeline.yaml", "file_new_name": "test\\data\\expected_buildkite_pipeline.yaml", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "656", "deleted_lines": "656"}}}, "file_10": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "test\\integration\\data\\elastic_tensorflow_keras_main.py"}, "file_11": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "test\\integration\\test_elastic_tensorflow_keras.py"}}}}