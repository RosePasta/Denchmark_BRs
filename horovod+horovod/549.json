{"BR": {"BR_id": "549", "BR_author": "Jongchan", "BRopenT": "2018-10-08T09:19:51Z", "BRcloseT": "2018-10-15T18:30:23Z", "BR_text": {"BRsummary": "Unexpected segmentation fault with PyTorch + Horovod", "BRdescription": "\n System configuration\n \n Azure VM of size NC24s_v2 (four P100)\n Ubuntu 16.04\n Docker image from Horovod with Docker, skip Tensorflow/keras installation\n \n Before beginning, I want to state that this problem is resolved for me. I am writing this issue for the record.\n For learning rate decay, I define the optimizer every epoch\n <denchmark-code>def train(epoch):\n     net.train()\n     optimizer = optim.SGD(net.parameters(), lr=cf.learning_rate(args.lr, epoch)*hvd.size(), momentum=0.9, weight_decay=5e-4)\n     optimizer = hvd.DistributedOptimizer(optimizer, named_parameters=net.named_parameters())\n     ...\n </denchmark-code>\n \n The mpirun command was simply\n <denchmark-code>mpirun -np 4 -H localhost:4 python <PYTHON_CODE_PATH> --datadir <DATA_DIR>\n </denchmark-code>\n \n At the very beginning of the 2nd epoch (during the first loss calculation and backprop), the code fails with the below stack trace\n <denchmark-code>[fe535b5ccf9b:00019] *** Process received signal ***\n [fe535b5ccf9b:00019] Signal: Segmentation fault (11)\n [fe535b5ccf9b:00019] Signal code: Address not mapped (1)\n [fe535b5ccf9b:00019] Failing at address: 0x28\n [fe535b5ccf9b:00019] [ 0] /lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fbf2779c390]\n [fe535b5ccf9b:00019] [ 1] /usr/local/lib/python2.7/dist-packages/horovod/torch/mpi_lib_impl/_mpi_lib_impl.so(+0x58d71)[0x7fbeaabf4d71]\n [fe535b5ccf9b:00019] [ 2] /usr/local/lib/python2.7/dist-packages/horovod/torch/mpi_lib_impl/_mpi_lib_impl.so(+0x5de24)[0x7fbeaabf9e24]\n [fe535b5ccf9b:00019] [ 3] /usr/local/lib/python2.7/dist-packages/horovod/torch/mpi_lib_impl/_mpi_lib_impl.so(+0x692d8)[0x7fbeaac052d8]\n [fe535b5ccf9b:00019] [ 4] /usr/local/lib/python2.7/dist-packages/horovod/torch/mpi_lib_impl/_mpi_lib_impl.so(+0x6a65b)[0x7fbeaac0665b]\n [fe535b5ccf9b:00019] [ 5] /usr/lib/x86_64-linux-gnu/libstdc++.so.6(+0xb8c80)[0x7fbf1e97bc80]\n [fe535b5ccf9b:00019] [ 6] /lib/x86_64-linux-gnu/libpthread.so.0(+0x76ba)[0x7fbf277926ba]\n [fe535b5ccf9b:00019] [ 7] /lib/x86_64-linux-gnu/libc.so.6(clone+0x6d)[0x7fbf274c841d]\n [fe535b5ccf9b:00019] *** End of error message ***\n -------------------------------------------------------\n Primary job  terminated normally, but 1 process returned\n a non-zero exit code. Per user-direction, the job has been aborted.\n -------------------------------------------------------\n fe535b5ccf9b:18:122 [0] INFO comm 0x7fc7381be150 rank 0 nranks 4\n fe535b5ccf9b:20:126 [2] INFO comm 0x7fbe601ba6e0 rank 2 nranks 4\n --------------------------------------------------------------------------\n mpirun.real noticed that process rank 1 with PID 0 on node fe535b5ccf9b exited on signal 11 (Segmentation fault).\n --------------------------------------------------------------------------\n </denchmark-code>\n \n Which means I am running this code in single node, 4 processes for 4 GPUs.\n The question is - Is this an expected outcome?\n It is redundant to define optimizer every epoch, but I just kept the original baseline code.\n This issue has been resolved for me, I just wanted to record this case in case other people may face a similar problem. This is not a problem in a native PyTorch code, but it is a problem with Horovod.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Jongchan", "commentT": "2018-10-08T16:49:21Z", "comment_text": "\n \t\tThanks for reporting this issue.  It's a bug we should fix.  Specifically, if you instantiate additional hvd.DistributedOptimizer(), you have an additional set of hooks that will cause the same gradients to be all-reduced multiple times.  It's still an error, but we should show a nice error message there instead of a segfault.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Jongchan", "commentT": "2019-02-02T14:33:25Z", "comment_text": "\n \t\tHi, I have the same segmentation fault issue. I used mpirun to train Pytorch model with 4 GPUs in the same node with Horovod. But sometimes got the seg fault while most of the time is fine. The error massage is very brief and it's very hard for me to debug. Is this issue resolved on top of tree? Thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Jongchan", "commentT": "2019-02-02T19:09:49Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/HaiguangWen>@HaiguangWen</denchmark-link>\n , please open a new issue.  Please collect a core dump and attach a backtrace, as well as describe versions of components.\n \t\t"}}}, "commit": {"commit_id": "0f46d7902cfe0790408dac5967e023186782e1e5", "commit_author": "Alex Sergeev", "commitT": "2018-10-15 11:30:22-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\common\\common.cc", "file_new_name": "horovod\\common\\common.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "47,48,49", "deleted_lines": null, "method_info": {"method_name": "horovod::common::Status::InvalidArgument", "method_params": "message", "method_startline": "47", "method_endline": "49"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "horovod\\common\\common.h", "file_new_name": "horovod\\common\\common.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "28,33,44", "deleted_lines": "28,33"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "horovod\\common\\operations.cc", "file_new_name": "horovod\\common\\operations.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2069,2072,2073,2074,2075,2076,2077,2078", "deleted_lines": "2061,2062,2063,2064,2065", "method_info": {"method_name": "horovod::common::EnqueueTensorAllgather", "method_params": "context,tensor,ready_event,name,device,callback", "method_startline": "2045", "method_endline": "2079"}}, "hunk_1": {"Ismethod": 1, "added_lines": "2031,2034,2035,2036,2037,2038,2039,2040", "deleted_lines": "2026,2027,2028,2029,2030", "method_info": {"method_name": "horovod::common::EnqueueTensorAllreduce", "method_params": "context,tensor,output,ready_event,name,device,callback", "method_startline": "2005", "method_endline": "2041"}}, "hunk_2": {"Ismethod": 1, "added_lines": "2111,2114,2115,2116,2117,2118,2119,2120", "deleted_lines": "2100,2101,2102,2103,2104", "method_info": {"method_name": "horovod::common::EnqueueTensorBroadcast", "method_params": "context,tensor,output,root_rank,ready_event,name,device,callback", "method_startline": "2083", "method_endline": "2121"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "horovod\\tensorflow\\mpi_ops.cc", "file_new_name": "horovod\\tensorflow\\mpi_ops.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "60,70,71", "deleted_lines": null, "method_info": {"method_name": "horovod::tensorflow::ConvertStatus", "method_params": "status", "method_startline": "60", "method_endline": "75"}}, "hunk_1": {"Ismethod": 1, "added_lines": "43,53,54", "deleted_lines": "43,58", "method_info": {"method_name": "horovod::tensorflow::ConvertStatus", "method_params": "status", "method_startline": "43", "method_endline": "58"}}, "hunk_2": {"Ismethod": 1, "added_lines": "60,70,71", "deleted_lines": "58", "method_info": {"method_name": "horovod::tensorflow::ConvertStatus", "method_params": "status", "method_startline": "58", "method_endline": "71"}}, "hunk_3": {"Ismethod": 1, "added_lines": "43,53,54", "deleted_lines": "43", "method_info": {"method_name": "horovod::tensorflow::ConvertStatus", "method_params": "status", "method_startline": "43", "method_endline": "56"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\torch\\adapter.cc", "file_new_name": "horovod\\torch\\adapter.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "147,148", "deleted_lines": null, "method_info": {"method_name": "horovod::torch::ThrowIfError", "method_params": "status", "method_startline": "139", "method_endline": "152"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "horovod\\torch\\adapter_v2.cc", "file_new_name": "horovod\\torch\\adapter_v2.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "111,112", "deleted_lines": null, "method_info": {"method_name": "horovod::torch::ThrowIfError", "method_params": "status", "method_startline": "103", "method_endline": "116"}}}}}}}