{"BR": {"BR_id": "392", "BR_author": "andfoy", "BRopenT": "2018-07-20T19:05:11Z", "BRcloseT": "2018-07-23T19:04:28Z", "BR_text": {"BRsummary": "Error broadcasting Adam optimizer parameters on PyTorch", "BRdescription": "\n Thanks for your great work on horovod, it is a great library that speeds up our training processes significatively.\n I've tried to use the novel hvd.broadcast_optimizer_state function introduced on 0.13.10, however, it seems to fail on optimizers different from torch.optim.SGD, because they seem to define additional model parameters that are not necessarily of type torch.tensor.\n For instance, if I try to use Adam as optimizer (As shown on the example snippet), the function will fail with the following traceback:\n optimizer = optim.Adam(net.parameters(), lr=args.lr * args.nodes)\n optimizer = hvd.DistributedOptimizer(\n     optimizer, named_parameters=net.named_parameters())\n \n if osp.exists(args.optim_snapshot) and args.rank == 0:\n     optimizer.load_state_dict(torch.load(args.optim_snapshot))\n \n hvd.broadcast_optimizer_state(optimizer, root_rank=0)\n <denchmark-code>File \"/media/SSD1/score-textseg/ref_score_net/train.py\", line 327, in <module>\n     hvd.broadcast_optimizer_state(optimizer, root_rank=0)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/__init__.py\", line 199, in broadcast_optimizer_state\n     broadcast_parameters(params, root_rank)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/__init__.py\", line 152, in broadcast_parameters\n     handle = broadcast_async_(p, root_rank, name)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/mpi_ops.py\", line 348, in broadcast_async_\n     return _broadcast_async(tensor, tensor, root_rank, name)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/mpi_ops.py\", line 256, in _broadcast_async\n     function = _check_function(_broadcast_function_factory, tensor)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/mpi_ops.py\", line 39, in _check_function\n     function = function_factory(tensor)\n   File \"/home/eamargffoy/anaconda3/envs/parallel/lib/python3.6/site-packages/horovod/torch/mpi_ops.py\", line 252, in _broadcast_function_factory\n     return 'horovod_torch_broadcast_async_' + tensor.type().replace('.', '_')\n AttributeError: 'int' object has no attribute 'type'\n </denchmark-code>\n \n I would like to know if the above appreciation is the cause of such failure, and if it is, if I can contribute to the project by fixing it.\n Thanks in advance.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "andfoy", "commentT": "2018-07-21T04:37:48Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/andfoy>@andfoy</denchmark-link>\n , thanks for reporting this issue!\n cc <denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  - we should definitely fix it, and contributions are certainly welcome.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "andfoy", "commentT": "2018-07-21T21:33:27Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/andfoy>@andfoy</denchmark-link>\n , thanks for raising this issue! Please take a look at <denchmark-link:https://github.com/horovod/horovod/pull/395>#395</denchmark-link>\n  if you get a chance and let me know if it fixes the issue for your model.\n <denchmark-link:https://github.com/alsrgv>@alsrgv</denchmark-link>\n  Given the hackiness of dealing with optimizer state and all its exceptions, I think the best longterm solution may be to go back to simply serializing/deserializing the  into a blob with  once we drop support for v0.3.0.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "andfoy", "commentT": "2018-07-22T19:03:21Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  I've tried PR <denchmark-link:https://github.com/horovod/horovod/pull/395>#395</denchmark-link>\n  and it seems to be working as expected! I think you can mark this issue as fixed\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "andfoy", "commentT": "2018-07-23T18:51:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n , sounds good.  We'll just need to make sure broadcasting mechanics works for very large objects (vanilla MPI is limited to 2GB) and doesn't consume too much RAM.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "andfoy", "commentT": "2018-07-23T19:04:28Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/andfoy>@andfoy</denchmark-link>\n !  <denchmark-link:https://github.com/horovod/horovod/pull/395>#395</denchmark-link>\n  has been landed, so marking this as resolved.\n \t\t"}}}, "commit": {"commit_id": "5a526531132326699913e7debba6b97b906723b8", "commit_author": "Travis Addair", "commitT": "2018-07-23 12:03:35-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "horovod\\torch\\__init__.py", "file_new_name": "horovod\\torch\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "196,197", "deleted_lines": "196,197", "method_info": {"method_name": "broadcast_optimizer_state.broadcast_optimizer_state._create_callback._from_tensor", "method_params": "", "method_startline": "196", "method_endline": "197"}}, "hunk_1": {"Ismethod": 1, "added_lines": "169,170,171,172,173,174,188,191,192,193,194,195,196,197,198,199,210,211,212,213,214,215,216,217,219,220,221,223,224,225,226,227", "deleted_lines": "168,169,196,197", "method_info": {"method_name": "broadcast_optimizer_state", "method_params": "optimizer,root_rank", "method_startline": "160", "method_endline": "227"}}, "hunk_2": {"Ismethod": 1, "added_lines": "195,196,197,198", "deleted_lines": "196,197", "method_info": {"method_name": "broadcast_optimizer_state._create_callback", "method_params": "pid,name,t,p", "method_startline": "195", "method_endline": "198"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "test\\test_torch.py", "file_new_name": "test\\test_torch.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "678,679,680", "deleted_lines": "678,680", "method_info": {"method_name": "test_broadcast_state.get_model_param_values", "method_params": "model", "method_startline": "678", "method_endline": "680"}}, "hunk_1": {"Ismethod": 1, "added_lines": "695,696,697,698,700", "deleted_lines": "695,696,697,698,699,700", "method_info": {"method_name": "test_broadcast_state.new_optimizer", "method_params": "cls", "method_startline": "695", "method_endline": "700"}}, "hunk_2": {"Ismethod": 1, "added_lines": "678", "deleted_lines": "677,678", "method_info": {"method_name": "test_broadcast_state.get_model_param_value", "method_params": "model", "method_startline": "677", "method_endline": "678"}}, "hunk_3": {"Ismethod": 1, "added_lines": "665,672", "deleted_lines": "671", "method_info": {"method_name": "test_broadcast_state.create_model", "method_params": "create_opt", "method_startline": "665", "method_endline": "676"}}, "hunk_4": {"Ismethod": 1, "added_lines": "665,672,678,679,680,682,683,685,686,687,688,689,690,691,692,693,694,695,696,697,698,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779", "deleted_lines": "664,671,677,678,680,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720", "method_info": {"method_name": "test_broadcast_state", "method_params": "self", "method_startline": "658", "method_endline": "779"}}, "hunk_5": {"Ismethod": 1, "added_lines": "665,672", "deleted_lines": "664,671", "method_info": {"method_name": "test_broadcast_state.create_model", "method_params": "", "method_startline": "664", "method_endline": "675"}}, "hunk_6": {"Ismethod": 1, "added_lines": "680,682,683", "deleted_lines": "680,682,683", "method_info": {"method_name": "test_broadcast_state.get_optimizer_param_value", "method_params": "optimizer", "method_startline": "680", "method_endline": "683"}}, "hunk_7": {"Ismethod": 1, "added_lines": "682,683,685,686,687,688,689,690,691", "deleted_lines": "682,683,684,685,686,687,688,689,690,691", "method_info": {"method_name": "test_broadcast_state.get_optimizer_param_values", "method_params": "optimizer", "method_startline": "682", "method_endline": "691"}}}}}}}