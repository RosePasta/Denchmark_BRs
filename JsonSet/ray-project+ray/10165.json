{"BR": {"BR_id": "10165", "BR_author": "concretevitamin", "BRopenT": "2020-08-17T21:21:07Z", "BRcloseT": "2020-08-26T01:34:19Z", "BR_text": {"BRsummary": "[rllib] Action mask support using -inf for PyTorch is broken", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Ray 0.8.7\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n <denchmark-code># Set inside \"num_gpus\": 1.\n rllib/examples$ p parametric_actions_cartpole.py  --torch\n </denchmark-code>\n \n hits\n <denchmark-code>\n   File \"/home/ubuntu/anaconda3/envs/exp/lib/python3.7/site-packages/tree/__init__.py\", line 516, in <listcomp>\n     [func(*args) for args in zip(*map(flatten, structures))])\n   File \"/home/ubuntu/anaconda3/envs/exp/lib/python3.7/site-packages/ray/rllib/utils/torch_ops.py\", line 121, in mapping\n     item.cpu().detach().numpy()\n RuntimeError: CUDA error: device-side assert triggered\n </denchmark-code>\n \n Using this same setup on my custom environment & (torch) model, the error manifests explicitly as:\n \n Using StochasticSampling, plus making sure my model return -1e15 for invalid actions: works.\n Using EpsilonGreedy, plus making sure my model return -float('inf') for invalids: ERROR, model weights quickly get trained to NaN.\n \n Suggestion: perhaps using float.min gives better numerical stability.\n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "concretevitamin", "commentT": "2020-08-17T22:15:38Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/concretevitamin>@concretevitamin</denchmark-link>\n  does this fix the example <denchmark-link:https://github.com/ray-project/ray/pull/10168/files>https://github.com/ray-project/ray/pull/10168/files</denchmark-link>\n  ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "concretevitamin", "commentT": "2020-08-17T22:22:13Z", "comment_text": "\n \t\tJust that change isn't enough.  See\n <denchmark-link:https://github.com/ray-project/ray/blob/master/rllib/utils/exploration/epsilon_greedy.py#L142>https://github.com/ray-project/ray/blob/master/rllib/utils/exploration/epsilon_greedy.py#L142</denchmark-link>\n \n .\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Mon, Aug 17, 2020 at 3:15 PM Eric Liang ***@***.***> wrote:\n  @concretevitamin <https://github.com/concretevitamin> does this fix the\n  example https://github.com/ray-project/ray/pull/10168/files ?\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#10165 (comment)>,\n  or unsubscribe\n  <https://github.com/notifications/unsubscribe-auth/AAEQWHR6KJ57MKY4KWGSHXDSBGTZRANCNFSM4QCHR26A>\n  .\n \n \n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "concretevitamin", "commentT": "2020-08-17T22:24:59Z", "comment_text": "\n \t\tPushed another change to that file as well.\n \t\t"}}}, "commit": {"commit_id": "deea1861ab87b64394d461f8739814937fed69bc", "commit_author": "Eric Liang", "commitT": "2020-08-25 18:34:19-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "doc\\source\\rllib-examples.rst", "file_new_name": "doc\\source\\rllib-examples.rst", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "105", "deleted_lines": "105"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\agents\\dqn\\dqn_torch_policy.py", "file_new_name": "rllib\\agents\\dqn\\dqn_torch_policy.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "218,237,246,247", "deleted_lines": "218,237,246", "method_info": {"method_name": "build_q_losses", "method_params": "policy,model,_,train_batch", "method_startline": "196", "method_endline": "259"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\examples\\models\\parametric_actions_model.py", "file_new_name": "rllib\\examples\\models\\parametric_actions_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "105,106", "deleted_lines": "104,105", "method_info": {"method_name": "forward", "method_params": "self,input_dict,state,seq_lens", "method_startline": "85", "method_endline": "107"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\utils\\exploration\\epsilon_greedy.py", "file_new_name": "rllib\\utils\\exploration\\epsilon_greedy.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "143", "deleted_lines": "142", "method_info": {"method_name": "_get_torch_exploration_action", "method_params": "self,q_values,explore,timestep", "method_startline": "122", "method_endline": "157"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\utils\\torch_ops.py", "file_new_name": "rllib\\utils\\torch_ops.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "9,10,11,12,13", "deleted_lines": null}}}}}}