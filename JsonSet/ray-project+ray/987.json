{"BR": {"BR_id": "987", "BR_author": "robertnishihara", "BRopenT": "2017-09-15T08:00:35Z", "BRcloseT": "2018-10-27T02:16:59Z", "BR_text": {"BRsummary": "Plasma managers die when running stressful workloads on a large cluster.", "BRdescription": "\n I've seen the following problem arise for stressful workloads on 200 nodes (m4.16xlarge).\n From the logs, some plasma managers and some local schedulers kill themselves because they go long enough without sending a heartbeat. In the past this arose because a plasma manager could be blocked in a call to connect when trying to establish a TCP connection to ship an object to another plasma manager. When too many managers did this at once, some would retry and due to exponential backoff some would end up blocked for tens of seconds. I think the relevant line is the one below.\n \n \n \n ray/src/plasma/plasma_manager.cc\n \n \n          Line 822\n       in\n       6601bb5\n \n \n \n \n \n \n  int fd = connect_inet_sock(ip_addr, port); \n \n \n \n \n \n This was addressed in <denchmark-link:https://github.com/ray-project/ray/pull/661>#661</denchmark-link>\n .\n This time, it looks like the blocking call that is taking too long is the following.\n \n \n \n ray/src/common/state/redis.cc\n \n \n         Lines 612 to 613\n       in\n       6601bb5\n \n \n \n \n \n \n  redisReply *reply = (redisReply *) redisCommand( \n \n \n \n      db->sync_context, \"RAY.GET_CLIENT_ADDRESS %b\", (char *) db_client_id.id, \n \n \n \n \n \n Now, each individual synchronous Redis command there isn't taking too long (the slowest ones according to my print statements took 300 or 400 milliseconds), but we're doing it in a loop at\n \n \n \n ray/src/common/state/redis.cc\n \n \n         Lines 710 to 713\n       in\n       6601bb5\n \n \n \n \n \n \n  for (int i = 0; i < manager_count; ++i) { \n \n \n \n    DBClientID manager_id = from_flatbuf(message->manager_ids()->Get(i)); \n \n \n \n  redis_get_cached_db_client(db, manager_id, &manager_vector[i]); \n \n \n \n  } \n \n \n \n \n \n This is inside of object_table_redis_subscribe_to_notifications_callback, so if one manager is trying to fetch a particular object, and that object is present on 200 other nodes, and if the primary Redis shard happens to be somewhat overwhelmed (e.g., it is exporting tons of remote function definitions to tons and tons of workers), then that loop can take tens of seconds and kill the plasma manager.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "robertnishihara", "commentT": "2018-10-27T02:16:58Z", "comment_text": "\n \t\tNo longer relevant.\n \t\t"}}}, "commit": {"commit_id": "1488975d1b1480655f8317a4b762ae642da63ab0", "commit_author": "Robert Nishihara", "commitT": "2017-10-02 10:46:21-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\common\\state\\object_table.h", "file_new_name": "src\\common\\state\\object_table.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,20,21,28", "deleted_lines": "16,20,21,28,29"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "src\\common\\state\\redis.cc", "file_new_name": "src\\common\\state\\redis.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "665,666,667,673,674,675,677,678,679,680,683,684,685,686,687,688,689,690,691,692", "deleted_lines": "658,659,660,661,662,663,664,667,668,669,670", "method_info": {"method_name": "redis_object_table_lookup_callback", "method_params": "c,r,privdata", "method_startline": "657", "method_endline": "700"}}, "hunk_1": {"Ismethod": 1, "added_lines": "736,737,738,741,744,745,746,751,752,761,762", "deleted_lines": "707,708,709,712,719,720,722,730", "method_info": {"method_name": "object_table_redis_subscribe_to_notifications_callback", "method_params": "c,r,privdata", "method_startline": "702", "method_endline": "771"}}, "hunk_2": {"Ismethod": 1, "added_lines": "604,605,608,619,621,623,624,625", "deleted_lines": "605,606,607,620,622", "method_info": {"method_name": "redis_get_cached_db_client", "method_params": "db,db_client_id", "method_startline": "604", "method_endline": "625"}}, "hunk_3": {"Ismethod": 1, "added_lines": "627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654", "deleted_lines": "635,636,637,642,643,644,645,646,647,651,652", "method_info": {"method_name": "redis_get_cached_db_clients", "method_params": "db,manager_ids", "method_startline": "627", "method_endline": "655"}}, "hunk_4": {"Ismethod": 1, "added_lines": "605,608,619,621,623,624", "deleted_lines": "605,606,607,620,622", "method_info": {"method_name": "redis_get_cached_db_client", "method_params": "db,db_client_id,manager", "method_startline": "605", "method_endline": "624"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\common\\test\\db_tests.cc", "file_new_name": "src\\common\\test\\db_tests.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "41,42,44,45,49", "deleted_lines": "41,42,44,45,46,50,51", "method_info": {"method_name": "lookup_done_callback", "method_params": "object_id,manager_count,user_context", "method_startline": "40", "method_endline": "55"}}, "hunk_1": {"Ismethod": 1, "added_lines": "41,42,44,45,49", "deleted_lines": "41,42,44,45,46,50,51", "method_info": {"method_name": "lookup_done_callback", "method_params": "object_id,never_created,manager_vector,user_context", "method_startline": "40", "method_endline": "53"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 23, "file_old_name": "src\\common\\test\\object_table_tests.cc", "file_new_name": "src\\common\\test\\object_table_tests.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "229", "deleted_lines": "229,230", "method_info": {"method_name": "subscribe_done_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "227", "method_endline": "234"}}, "hunk_1": {"Ismethod": 1, "added_lines": "359,360,361,362,363,365", "deleted_lines": null, "method_info": {"method_name": "add_remove_lookup_done_callback", "method_params": "object_id,never_created,manager_vector,context", "method_startline": "359", "method_endline": "367"}}, "hunk_2": {"Ismethod": 1, "added_lines": "648,655", "deleted_lines": "654,655", "method_info": {"method_name": "subscribe_object_present_object_available_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "645", "method_endline": "656"}}, "hunk_3": {"Ismethod": 1, "added_lines": "771", "deleted_lines": "771,772,780", "method_info": {"method_name": "subscribe_object_available_later_object_available_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "768", "method_endline": "781"}}, "hunk_4": {"Ismethod": 1, "added_lines": null, "deleted_lines": "721,722", "method_info": {"method_name": "subscribe_object_not_present_object_available_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "718", "method_endline": "726"}}, "hunk_5": {"Ismethod": 1, "added_lines": null, "deleted_lines": "531,532,533,534", "method_info": {"method_name": "subscribe_late_done_callback", "method_params": "object_id,manager_count,user_context", "method_startline": "531", "method_endline": "537"}}, "hunk_6": {"Ismethod": 1, "added_lines": null, "deleted_lines": "443,444", "method_info": {"method_name": "lookup_late_done_callback", "method_params": "object_id,manager_count,context", "method_startline": "442", "method_endline": "448"}}, "hunk_7": {"Ismethod": 1, "added_lines": "594", "deleted_lines": "593,594,595,596,597,600", "method_info": {"method_name": "subscribe_success_object_available_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "593", "method_endline": "602"}}, "hunk_8": {"Ismethod": 1, "added_lines": "587,588,589,590,591", "deleted_lines": "581,582,583,584", "method_info": {"method_name": "subscribe_success_done_callback", "method_params": "object_id,manager_count,user_context", "method_startline": "581", "method_endline": "591"}}, "hunk_9": {"Ismethod": 1, "added_lines": "229", "deleted_lines": "229,230", "method_info": {"method_name": "subscribe_done_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "227", "method_endline": "233"}}, "hunk_10": {"Ismethod": 1, "added_lines": null, "deleted_lines": "296,297,298,299,300,301,302", "method_info": {"method_name": "lookup_retry_done_callback", "method_params": "object_id,manager_count,context", "method_startline": "296", "method_endline": "302"}}, "hunk_11": {"Ismethod": 1, "added_lines": "574,575,576,577,578", "deleted_lines": "581,582,583,584", "method_info": {"method_name": "subscribe_success_done_callback", "method_params": "object_id,never_created,manager_vector,user_context", "method_startline": "574", "method_endline": "585"}}, "hunk_12": {"Ismethod": 1, "added_lines": "587,588,589,590,591,594", "deleted_lines": "593,594,595,596", "method_info": {"method_name": "subscribe_success_object_available_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "587", "method_endline": "596"}}, "hunk_13": {"Ismethod": 1, "added_lines": null, "deleted_lines": "319,320,323,324", "method_info": {"method_name": "add_lookup_done_callback", "method_params": "object_id,manager_count,context", "method_startline": "318", "method_endline": "326"}}, "hunk_14": {"Ismethod": 1, "added_lines": "148,149", "deleted_lines": "148,149", "method_info": {"method_name": "lookup_done_callback", "method_params": "object_id,manager_count,context", "method_startline": "147", "method_endline": "153"}}, "hunk_15": {"Ismethod": 1, "added_lines": "435,436", "deleted_lines": null, "method_info": {"method_name": "lookup_late_done_callback", "method_params": "object_id,never_created,manager_vector,context", "method_startline": "434", "method_endline": "440"}}, "hunk_16": {"Ismethod": 1, "added_lines": null, "deleted_lines": "368,369,370,371,373", "method_info": {"method_name": "add_remove_lookup_done_callback", "method_params": "object_id,manager_count,context", "method_startline": "368", "method_endline": "375"}}, "hunk_17": {"Ismethod": 1, "added_lines": "523,524,525,526,527", "deleted_lines": null, "method_info": {"method_name": "subscribe_late_done_callback", "method_params": "object_id,never_created,manager_vector,user_context", "method_startline": "523", "method_endline": "530"}}, "hunk_18": {"Ismethod": 1, "added_lines": "310,311,314,315", "deleted_lines": null, "method_info": {"method_name": "add_lookup_done_callback", "method_params": "object_id,never_created,manager_vector,context", "method_startline": "309", "method_endline": "317"}}, "hunk_19": {"Ismethod": 1, "added_lines": "763,771", "deleted_lines": "771,772", "method_info": {"method_name": "subscribe_object_available_later_object_available_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "760", "method_endline": "772"}}, "hunk_20": {"Ismethod": 1, "added_lines": "714", "deleted_lines": null, "method_info": {"method_name": "subscribe_object_not_present_object_available_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "711", "method_endline": "718"}}, "hunk_21": {"Ismethod": 1, "added_lines": "148,149", "deleted_lines": "148,149", "method_info": {"method_name": "lookup_done_callback", "method_params": "object_id,never_created,manager_vector,context", "method_startline": "147", "method_endline": "153"}}, "hunk_22": {"Ismethod": 1, "added_lines": "655", "deleted_lines": "654,655,662", "method_info": {"method_name": "subscribe_object_present_object_available_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "651", "method_endline": "663"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\global_scheduler\\global_scheduler.cc", "file_new_name": "src\\global_scheduler\\global_scheduler.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "281,282,283,284,285,292,293,307,317", "deleted_lines": "281,282,283,284,285,292,293,307,317", "method_info": {"method_name": "object_table_subscribe_callback", "method_params": "object_id,data_size,manager_count,user_context", "method_startline": "281", "method_endline": "320"}}, "hunk_1": {"Ismethod": 1, "added_lines": "281,282,283,284,285,292,293,307,317", "deleted_lines": "281,282,283,284,285,292,293,307,317", "method_info": {"method_name": "object_table_subscribe_callback", "method_params": "object_id,data_size,manager_vector,user_context", "method_startline": "281", "method_endline": "320"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\local_scheduler\\local_scheduler.cc", "file_new_name": "src\\local_scheduler\\local_scheduler.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "726,727,728,729,730,737,743", "deleted_lines": "726,727,728,729,736,742", "method_info": {"method_name": "reconstruct_object_lookup_callback", "method_params": "reconstruct_object_id,manager_count,user_context", "method_startline": "726", "method_endline": "749"}}, "hunk_1": {"Ismethod": 1, "added_lines": "726,727,728,729,730,737,743", "deleted_lines": "726,727,728,729,736,742", "method_info": {"method_name": "reconstruct_object_lookup_callback", "method_params": "reconstruct_object_id,never_created,manager_vector,user_context", "method_startline": "726", "method_endline": "750"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 16, "file_old_name": "src\\plasma\\plasma_manager.cc", "file_new_name": "src\\plasma\\plasma_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "998,1003", "deleted_lines": "1001", "method_info": {"method_name": "object_present_callback", "method_params": "object_id,manager_vector,context", "method_startline": "997", "method_endline": "1009"}}, "hunk_1": {"Ismethod": 1, "added_lines": "998,1003,1013,1014,1015,1016,1017,1022,1025", "deleted_lines": "995,996,1001,1018,1019,1020,1021,1022,1023,1024,1025,1027,1028,1030,1031,1032,1033,1034,1035,1036", "method_info": {"method_name": "request_transfer", "method_params": "object_id,manager_count,context", "method_startline": "994", "method_endline": "1040"}}, "hunk_2": {"Ismethod": 1, "added_lines": "917", "deleted_lines": "905,907,910,911", "method_info": {"method_name": "fetch_timeout_handler", "method_params": "loop,id,context", "method_startline": "900", "method_endline": "942"}}, "hunk_3": {"Ismethod": 1, "added_lines": "424", "deleted_lines": null, "method_info": {"method_name": "create_fetch_request", "method_params": "manager_state,object_id", "method_startline": "422", "method_endline": "427"}}, "hunk_4": {"Ismethod": 1, "added_lines": "981,990", "deleted_lines": null, "method_info": {"method_name": "call_request_transfer", "method_params": "object_id,manager_vector,context", "method_startline": "980", "method_endline": "991"}}, "hunk_5": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1062,1063,1068", "method_info": {"method_name": "object_present_callback", "method_params": "object_id,manager_count,context", "method_startline": "1061", "method_endline": "1074"}}, "hunk_6": {"Ismethod": 1, "added_lines": "440,441", "deleted_lines": null, "method_info": {"method_name": "remove_fetch_request", "method_params": "manager_state,fetch_req", "method_startline": "436", "method_endline": "442"}}, "hunk_7": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1044,1045,1054", "method_info": {"method_name": "call_request_transfer", "method_params": "object_id,manager_count,context", "method_startline": "1043", "method_endline": "1055"}}, "hunk_8": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1232,1233,1236,1237", "method_info": {"method_name": "request_status_done", "method_params": "object_id,manager_count,context", "method_startline": "1231", "method_endline": "1242"}}, "hunk_9": {"Ismethod": 1, "added_lines": "1175,1184,1185,1186,1187,1188", "deleted_lines": null, "method_info": {"method_name": "request_status", "method_params": "object_id,manager_vector,context", "method_startline": "1174", "method_endline": "1189"}}, "hunk_10": {"Ismethod": 1, "added_lines": "949,954,972", "deleted_lines": "963", "method_info": {"method_name": "request_transfer", "method_params": "object_id,manager_vector,context", "method_startline": "948", "method_endline": "977"}}, "hunk_11": {"Ismethod": 1, "added_lines": "1013,1014,1015,1016,1017,1022,1025", "deleted_lines": "1018,1019,1020,1021,1022,1023,1024,1025", "method_info": {"method_name": "object_table_subscribe_callback", "method_params": "object_id,data_size,manager_vector,context", "method_startline": "1013", "method_endline": "1026"}}, "hunk_12": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1078,1079,1080,1081,1082,1087,1090", "method_info": {"method_name": "object_table_subscribe_callback", "method_params": "object_id,data_size,manager_count,context", "method_startline": "1078", "method_endline": "1091"}}, "hunk_13": {"Ismethod": 1, "added_lines": "1163,1164,1167", "deleted_lines": null, "method_info": {"method_name": "request_status_done", "method_params": "object_id,never_created,manager_vector,context", "method_startline": "1162", "method_endline": "1172"}}, "hunk_14": {"Ismethod": 1, "added_lines": "859,861,864,865,897", "deleted_lines": null, "method_info": {"method_name": "request_transfer_from", "method_params": "manager_state,fetch_req", "method_startline": "857", "method_endline": "898"}}, "hunk_15": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1245,1246,1255,1256,1257,1258", "method_info": {"method_name": "request_status", "method_params": "object_id,manager_count,context", "method_startline": "1244", "method_endline": "1259"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\plasma\\plasma_manager.h", "file_new_name": "src\\plasma\\plasma_manager.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "189", "deleted_lines": "24,185,191,192,203,204,205,206,207,208,209,210,211,212,213"}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\plasma\\test\\manager_tests.cc", "file_new_name": "src\\plasma\\test\\manager_tests.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "161,162,163,164,165,166,167,168", "deleted_lines": "165,166,167,168,169,170,171,172,173,174,175", "method_info": {"method_name": "request_transfer_retry_test", "method_params": "void", "method_startline": "157", "method_endline": "194"}}, "hunk_1": {"Ismethod": 1, "added_lines": "121,122,123,124", "deleted_lines": "121,122,123,124,125,126,127,143", "method_info": {"method_name": "request_transfer_test", "method_params": "void", "method_startline": "118", "method_endline": "143"}}}}}}}