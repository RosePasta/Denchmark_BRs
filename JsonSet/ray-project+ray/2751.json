{"BR": {"BR_id": "2751", "BR_author": "atumanov", "BRopenT": "2018-08-27T22:16:09Z", "BRcloseT": "2018-08-29T06:53:41Z", "BR_text": {"BRsummary": "test/actor_test.py::ActorsWithGPUs::testActorMultipleGPUsFromMultipleTasks failing", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): macosx\n Ray installed from (source or binary): source\n Ray version: upstream/master , atumanov/raylet-scheduling-simple\n Python version: py2.7.12\n Exact command to reproduce:\n RAY_USE_XRAY=1 python -m pytest  -v  -s test/actor_test.py::ActorsWithGPUs\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n test/actor_test.py::ActorsWithGPUs::testActorMultipleGPUsFromMultipleTasks may intermittently fail when run on either macosx or linux. The first problematic output captured from the failing test so far:\n <denchmark-code>sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n sh: fork: Resource temporarily unavailable\n </denchmark-code>\n \n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "atumanov", "commentT": "2018-08-27T22:22:18Z", "comment_text": "\n \t\tI've seen this as well. The problem seems most acute on machines with few cores. It could be that we're starting up actors too quickly and that we should reduce the number of concurrent workers that can be started in\n \n \n \n ray/src/ray/raylet/worker_pool.cc\n \n \n         Lines 97 to 105\n       in\n       b4cba9a\n \n \n \n \n \n \n  void WorkerPool::StartWorkerProcess(const Language &language, bool force_start) { \n \n \n \n  // The first condition makes sure that we are always starting up to \n \n \n \n  // num_cpus_ number of processes in parallel. \n \n \n \n  if (static_cast<int>(starting_worker_processes_.size()) >= num_cpus_ && !force_start) { \n \n \n \n  // Workers have been started, but not registered. Force start disabled -- returning. \n \n \n \n  RAY_LOG(DEBUG) << starting_worker_processes_.size() \n \n \n \n                     << \" worker processes pending registration\"; \n \n \n \n  return; \n \n \n \n    } \n \n \n \n \n \n from num_cpus_ to something smaller.\n EDIT: Although in this test we artificially pass in a much larger value of num_cpus.\n \t\t"}}}, "commit": {"commit_id": "132f133214b8631ad789152f9950cdb3db44964b", "commit_author": "Robert Nishihara", "commitT": "2018-08-29 14:53:40+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\runner\\RunManager.java", "file_new_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\runner\\RunManager.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "626,627,628,629,632,633", "deleted_lines": "628,629", "method_info": {"method_name": "RunManager::startRaylet", "method_params": "storeName,info,numWorkers,redisAddress,ip,redirect,staticResources,cleanup", "method_startline": "606", "method_endline": "654"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\services.py", "file_new_name": "python\\ray\\services.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1011,1012,1013,1014,1015,1043", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\main.cc", "file_new_name": "src\\ray\\raylet\\main.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "19,27,28,29,30,52", "deleted_lines": "19,27,28,29", "method_info": {"method_name": "main", "method_params": "argc", "method_startline": "17", "method_endline": "117"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "89", "deleted_lines": "89,90", "method_info": {"method_name": "ray::raylet::NodeManager::NodeManager", "method_params": "io_service,config,object_manager,gcs_client", "method_startline": "78", "method_endline": "124"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\node_manager.h", "file_new_name": "src\\ray\\raylet\\node_manager.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29,30,31", "deleted_lines": null}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\worker_pool.cc", "file_new_name": "src\\ray\\raylet\\worker_pool.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "47,48,50,51,53", "deleted_lines": "44,46", "method_info": {"method_name": "ray::raylet::WorkerPool::WorkerPool", "method_params": "num_worker_processes,num_workers_per_process,num_cpus,worker_commands", "method_startline": "43", "method_endline": "62"}}, "hunk_1": {"Ismethod": 1, "added_lines": "104,105,106,107,108", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::WorkerPool::StartWorkerProcess", "method_params": "language,force_start", "method_startline": "103", "method_endline": "143"}}, "hunk_2": {"Ismethod": 1, "added_lines": "47,48,50,51,53", "deleted_lines": "46", "method_info": {"method_name": "ray::raylet::WorkerPool::WorkerPool", "method_params": "num_worker_processes,num_workers_per_process,maximum_startup_concurrency,worker_commands", "method_startline": "46", "method_endline": "68"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\worker_pool.h", "file_new_name": "src\\ray\\raylet\\worker_pool.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "33,34,35,36,40,41,50,51,52,56,57,146,147", "deleted_lines": "36,45,46,47,51,140,141,142"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\worker_pool_test.cc", "file_new_name": "src\\ray\\raylet\\worker_pool_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "16", "deleted_lines": "16", "method_info": {"method_name": "ray::raylet::WorkerPoolMock::WorkerPoolMock", "method_params": "", "method_startline": "15", "method_endline": "18"}}}}, "file_8": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "src\\ray\\test\\start_raylet.sh", "file_new_name": "None"}, "file_9": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "src\\ray\\test\\start_raylets.sh", "file_new_name": "None"}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\actor_test.py", "file_new_name": "test\\actor_test.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "926,927,928"}}}}}}