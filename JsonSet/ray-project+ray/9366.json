{"BR": {"BR_id": "9366", "BR_author": "MaximeBouton", "BRopenT": "2020-07-09T00:17:39Z", "BRcloseT": "2020-07-10T09:23:41Z", "BR_text": {"BRsummary": "[rllib] incorrect model output for DQN with torch and dueling=false", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n The output fo the DQN model is not within the action space.\n Something is wrong when constructing the torch model when dueling is off. The output dimension of the model is equal to whatever is passed in \"fcnet_hiddens\" instead of being of the size of the action space.\n Ray version and other system information (Python version, TensorFlow version, OS):\n \n ray==0.9.0.dev0\n python 3.6.10\n mac OS\n \n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n import ray\n from ray import tune\n \n ray.init()\n \n config = {\n     \"env\": \"CartPole-v1\",\n     \"num_workers\": 1,\n     \"train_batch_size\": 128,\n     \"learning_starts\": 128,\n     \"model\": {\"fcnet_hiddens\": [32]},\n     \"dueling\": False ,\n     \"framework\": \"torch\"\n }\n \n tune.run(\"DQN\", name=\"MWE\", config=config, stop={\"training_iteration\": 100})\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "MaximeBouton", "commentT": "2020-07-09T22:11:36Z", "comment_text": "\n \t\tCan you just change the following in your rllib/agents/dqn/dqn_torch_model.py (c'tor) ?\n <denchmark-code>        advantage_module = nn.Sequential()\n         value_module = nn.Sequential()\n \n         # Dueling case: Build the shared (advantages and value) fc-network.\n         if self.dueling:\n             for i, n in enumerate(q_hiddens):\n                 advantage_module.add_module(\"dueling_A_{}\".format(i),\n                                             nn.Linear(ins, n))\n                 value_module.add_module(\"dueling_V_{}\".format(i),\n                                         nn.Linear(ins, n))\n                 # Add activations if necessary.\n                 if dueling_activation == \"relu\":\n                     advantage_module.add_module(\"dueling_A_act_{}\".format(i),\n                                                 nn.ReLU())\n                     value_module.add_module(\"dueling_V_act_{}\".format(i),\n                                             nn.ReLU())\n                 elif dueling_activation == \"tanh\":\n                     advantage_module.add_module(\"dueling_A_act_{}\".format(i),\n                                                 nn.Tanh())\n                     value_module.add_module(\"dueling_V_act_{}\".format(i),\n                                             nn.Tanh())\n \n                 # Add LayerNorm after each Dense.\n                 if add_layer_norm:\n                     advantage_module.add_module(\"LayerNorm_A_{}\".format(i),\n                                                 nn.LayerNorm(n))\n                     value_module.add_module(\"LayerNorm_V_{}\".format(i),\n                                             nn.LayerNorm(n))\n                 ins = n\n \n         # Actual Advantages layer (nodes=num-actions) and\n         # value layer (nodes=1).\n         advantage_module.add_module(\"A\", nn.Linear(ins, action_space.n))\n         value_module.add_module(\"V\", nn.Linear(ins, 1))\n </denchmark-code>\n \n That should fix it. Will PR now ...\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "MaximeBouton", "commentT": "2020-07-09T22:11:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/MaximeBouton>@MaximeBouton</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "MaximeBouton", "commentT": "2020-07-10T03:49:35Z", "comment_text": "\n \t\tJust saw this, I can give it a try tomorrow morning\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "MaximeBouton", "commentT": "2020-07-10T09:23:40Z", "comment_text": "\n \t\tThis PR fixes the issue: <denchmark-link:https://github.com/ray-project/ray/pull/9386>#9386</denchmark-link>\n \n Will be merged today into master. Thanks for filing this!\n Closing it now. Please feel free to re-open should this still not work on your end.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "MaximeBouton", "commentT": "2020-07-10T16:36:46Z", "comment_text": "\n \t\tI installed the nightly version and it works, thanks for the quick fix!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "MaximeBouton", "commentT": "2020-07-10T21:37:24Z", "comment_text": "\n \t\tThis has been merged into master.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "MaximeBouton", "commentT": "2020-07-11T20:07:07Z", "comment_text": "\n \t\tAwesome! Glad it's working. :)\n \t\t"}}}, "commit": {"commit_id": "14160ca58c8d37ea4c08639be12c6569a80eb190", "commit_author": "Sven Mika", "commitT": "2020-07-10 12:43:03+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\agents\\dqn\\dqn_torch_model.py", "file_new_name": "rllib\\agents\\dqn\\dqn_torch_model.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "57,58,59,60,61,63,64,65,66,67,69,70,71,72,74,75,77,78,79,81,82,83,84,85,86,90,91,92,93,94", "deleted_lines": "56,58,59,60,61,62,63,64,66,67,68,69,70,72,73,74,75,78,79,80,81,82,84,85,86,88,89,90,91,92,95"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\examples\\parametric_actions_cartpole.py", "file_new_name": "rllib\\examples\\parametric_actions_cartpole.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "51", "deleted_lines": "51"}}}}}}