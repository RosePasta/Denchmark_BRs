{"BR": {"BR_id": "2608", "BR_author": "stephanie-wang", "BRopenT": "2018-08-08T21:36:08Z", "BRcloseT": "2018-08-28T01:31:27Z", "BR_text": {"BRsummary": "Java and Python `UniqueID` generation does not match", "BRdescription": "\n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n The Java and Python frontends currently use different algorithms to generate TaskIDs and ObjectIDs. Ideally, they should both use the functions in src/ray/id.h to generate UniqueIDs. This is the code that is currently shared between the Python frontend and the Raylet backend.\n This problem manifests itself when the Raylet backend tries to compute the  of the task that generated a given . It does this, for instance, when trying to decide whether to reconstruct an object. As of <denchmark-link:https://github.com/ray-project/ray/pull/2526>#2526</denchmark-link>\n , the exact sequence of steps is:\n \n The ReconstructionPolicy is asked to reconstruct an object_id, which was computed with the code in java/runtime-common/src/main/java/org/ray/core/UniqueIdHelper.java.\n The ReconstructionPolicy computes the task ID from object_id, but gets the wrong task ID, since it uses the ComputeTaskId helper function in src/ray/id.h to do so. It begins to listen for task lease notifications for the wrong task ID.\n The ReconstructionPolicy soon times out the task since no notifications were received and attempts to reconstruct the task. However, it can't find the TaskSpec since it has the wrong task ID.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "stephanie-wang", "commentT": "2018-08-08T22:56:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  thanks for reporting this!\n cc @kingchin1218 <denchmark-link:https://github.com/salah-man>@salah-man</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "stephanie-wang", "commentT": "2018-08-09T03:07:48Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  . I am following this issue.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "stephanie-wang", "commentT": "2018-08-09T04:18:15Z", "comment_text": "\n \t\tThanks. It's a known issue. IIRC, there're also some dependencies on the task ID generation. So it might not be a very straightforward change. we'll look into this.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "stephanie-wang", "commentT": "2018-08-09T04:35:15Z", "comment_text": "\n \t\tGreat, thanks! @kingchin1218 and <denchmark-link:https://github.com/raulchen>@raulchen</denchmark-link>\n , as a first step, we should at least make sure that the function to compute the task ID that created an object matches in both frontends. That way, at least we can have reconstruction work for the Java frontend.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "stephanie-wang", "commentT": "2018-08-09T14:12:53Z", "comment_text": "\n \t\tIt is best that we can come up a manual id logic version defined in Java/Python/Core, respectively. And let's check their consistency upon every startup.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "stephanie-wang", "commentT": "2018-08-28T01:26:42Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/robertnishihara>@robertnishihara</denchmark-link>\n \n It's time to close this issue. :)\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "stephanie-wang", "commentT": "2018-08-28T01:31:27Z", "comment_text": "\n \t\tThanks!\n \t\t"}}}, "commit": {"commit_id": "b4cba9a49f96e649811f16e8144e3a29116a37b0", "commit_author": "Wang Qing", "commitT": "2018-08-27 13:11:33-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "java\\api\\src\\main\\java\\org\\ray\\api\\UniqueID.java", "file_new_name": "java\\api\\src\\main\\java\\org\\ray\\api\\UniqueID.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "45,46", "deleted_lines": "45", "method_info": {"method_name": "UniqueID::UniqueID", "method_params": "id", "method_startline": "43", "method_endline": "50"}}, "hunk_1": {"Ismethod": 1, "added_lines": "90", "deleted_lines": "89,90,91", "method_info": {"method_name": "UniqueID::isNil", "method_params": "", "method_startline": "89", "method_endline": "91"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\RayRuntime.java", "file_new_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\RayRuntime.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "116", "method_info": {"method_name": "RayRuntime::init", "method_params": "slink,plink,remoteLoader,pathManager", "method_startline": "110", "method_endline": "130"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 33, "file_old_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\UniqueIdHelper.java", "file_new_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\UniqueIdHelper.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "163,164,165,166,167", "method_info": {"method_name": "UniqueIdHelper::setType", "method_params": "", "method_startline": "163", "method_endline": "167"}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137", "method_info": {"method_name": "UniqueIdHelper::objectIdFromTaskId", "method_params": "", "method_startline": "120", "method_endline": "137"}}, "hunk_2": {"Ismethod": 1, "added_lines": "33,34,35,36,38,40,43,44", "deleted_lines": "33,34,35,36,37,38,39,40,41,42,43,44", "method_info": {"method_name": "UniqueIdHelper::setThreadRandomSeed", "method_params": "", "method_startline": "33", "method_endline": "44"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "102,103,104,105,106", "method_info": {"method_name": "UniqueIdHelper::getUniqueness", "method_params": "", "method_startline": "102", "method_endline": "106"}}, "hunk_4": {"Ismethod": 1, "added_lines": null, "deleted_lines": "197,198,199,200", "method_info": {"method_name": "UniqueIdHelper::getHasMultipleReturn", "method_params": "", "method_startline": "197", "method_endline": "200"}}, "hunk_5": {"Ismethod": 1, "added_lines": "23,24,25", "deleted_lines": "23,24,25", "method_info": {"method_name": "UniqueIdHelper::computeReturnId", "method_params": "taskId,returnIndex", "method_startline": "23", "method_endline": "25"}}, "hunk_6": {"Ismethod": 1, "added_lines": null, "deleted_lines": "96,97,98,99,100", "method_info": {"method_name": "UniqueIdHelper::setIsTest", "method_params": "", "method_startline": "96", "method_endline": "100"}}, "hunk_7": {"Ismethod": 1, "added_lines": "46,47,48,49,50,51,52,55,56,57,58,59,60,61,62,63,64,65,67", "deleted_lines": "46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69", "method_info": {"method_name": "UniqueIdHelper::getNextCreateThreadRandomSeed", "method_params": "", "method_startline": "46", "method_endline": "69"}}, "hunk_8": {"Ismethod": 1, "added_lines": null, "deleted_lines": "187,188,189", "method_info": {"method_name": "UniqueIdHelper::taskComputePutId", "method_params": "", "method_startline": "187", "method_endline": "189"}}, "hunk_9": {"Ismethod": 1, "added_lines": null, "deleted_lines": "259,260,261,262,263", "method_info": {"method_name": "UniqueIdHelper::isNonLambdaCreateActorStage1Function", "method_params": "", "method_startline": "259", "method_endline": "263"}}, "hunk_10": {"Ismethod": 1, "added_lines": null, "deleted_lines": "169,170,171,172,173", "method_info": {"method_name": "UniqueIdHelper::setHasMultipleReturn", "method_params": "", "method_startline": "169", "method_endline": "173"}}, "hunk_11": {"Ismethod": 1, "added_lines": null, "deleted_lines": "139,140,141,142,143", "method_info": {"method_name": "UniqueIdHelper::newZero", "method_params": "", "method_startline": "139", "method_endline": "143"}}, "hunk_12": {"Ismethod": 1, "added_lines": null, "deleted_lines": "265,266,267,268", "method_info": {"method_name": "UniqueIdHelper::isNonLambdaCommonFunction", "method_params": "", "method_startline": "265", "method_endline": "269"}}, "hunk_13": {"Ismethod": 1, "added_lines": null, "deleted_lines": "91,92,93,94", "method_info": {"method_name": "UniqueIdHelper::setTest", "method_params": "", "method_startline": "91", "method_endline": "94"}}, "hunk_14": {"Ismethod": 1, "added_lines": null, "deleted_lines": "181,182,183,184,185", "method_info": {"method_name": "UniqueIdHelper::setWithinTaskIndex", "method_params": "", "method_startline": "181", "method_endline": "185"}}, "hunk_15": {"Ismethod": 1, "added_lines": null, "deleted_lines": "175,176,177,178,179", "method_info": {"method_name": "UniqueIdHelper::setIsReturn", "method_params": "", "method_startline": "175", "method_endline": "179"}}, "hunk_16": {"Ismethod": 1, "added_lines": "33,34,35,36,38,40", "deleted_lines": "33,34,35,36,37,38,39,40,41", "method_info": {"method_name": "UniqueIdHelper::computeObjectId", "method_params": "taskId,index", "method_startline": "33", "method_endline": "41"}}, "hunk_17": {"Ismethod": 1, "added_lines": null, "deleted_lines": "191,192,193,194,195", "method_info": {"method_name": "UniqueIdHelper::hasMultipleReturnOrNotFromReturnObjectId", "method_params": "", "method_startline": "191", "method_endline": "195"}}, "hunk_18": {"Ismethod": 1, "added_lines": null, "deleted_lines": "252,253,254,255", "method_info": {"method_name": "UniqueIdHelper::markCreateActorStage1Function", "method_params": "", "method_startline": "252", "method_endline": "256"}}, "hunk_19": {"Ismethod": 1, "added_lines": null, "deleted_lines": "81,82,83,84", "method_info": {"method_name": "UniqueIdHelper::getIsReturn", "method_params": "", "method_startline": "81", "method_endline": "84"}}, "hunk_20": {"Ismethod": 1, "added_lines": null, "deleted_lines": "76,77,78,79", "method_info": {"method_name": "UniqueIdHelper::getIsTest", "method_params": "", "method_startline": "76", "method_endline": "79"}}, "hunk_21": {"Ismethod": 1, "added_lines": null, "deleted_lines": "157,158,159,160,161", "method_info": {"method_name": "UniqueIdHelper::setUniqueness", "method_params": "", "method_startline": "157", "method_endline": "161"}}, "hunk_22": {"Ismethod": 1, "added_lines": null, "deleted_lines": "145,146,147", "method_info": {"method_name": "UniqueIdHelper::setBatch", "method_params": "", "method_startline": "145", "method_endline": "147"}}, "hunk_23": {"Ismethod": 1, "added_lines": null, "deleted_lines": "149,150,151", "method_info": {"method_name": "UniqueIdHelper::getBatch", "method_params": "", "method_startline": "149", "method_endline": "151"}}, "hunk_24": {"Ismethod": 1, "added_lines": null, "deleted_lines": "153,154,155", "method_info": {"method_name": "UniqueIdHelper::setUniqueness", "method_params": "", "method_startline": "153", "method_endline": "155"}}, "hunk_25": {"Ismethod": 1, "added_lines": null, "deleted_lines": "86,87,88,89", "method_info": {"method_name": "UniqueIdHelper::getWithinTaskIndex", "method_params": "", "method_startline": "86", "method_endline": "89"}}, "hunk_26": {"Ismethod": 1, "added_lines": "50,51,52", "deleted_lines": "50,51,52,53", "method_info": {"method_name": "UniqueIdHelper::computePutId", "method_params": "taskId,putIndex", "method_startline": "50", "method_endline": "53"}}, "hunk_27": {"Ismethod": 1, "added_lines": null, "deleted_lines": "202,203,204,205,206,208,209,210,211,212", "method_info": {"method_name": "UniqueIdHelper::taskIdFromObjectId", "method_params": "", "method_startline": "202", "method_endline": "212"}}, "hunk_28": {"Ismethod": 1, "added_lines": null, "deleted_lines": "214,215,216,217,218,219,220,221,222,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249", "method_info": {"method_name": "UniqueIdHelper::nextTaskId", "method_params": "", "method_startline": "214", "method_endline": "250"}}, "hunk_29": {"Ismethod": 1, "added_lines": null, "deleted_lines": "71,72,73,74", "method_info": {"method_name": "UniqueIdHelper::getType", "method_params": "", "method_startline": "71", "method_endline": "74"}}, "hunk_30": {"Ismethod": 1, "added_lines": null, "deleted_lines": "112,113,114,115,116,117,118", "method_info": {"method_name": "UniqueIdHelper::taskComputeReturnId", "method_params": "", "method_startline": "112", "method_endline": "118"}}, "hunk_31": {"Ismethod": 1, "added_lines": "61,62,63,64,65,67", "deleted_lines": "61,62,63,64,65,66,67,68", "method_info": {"method_name": "UniqueIdHelper::computeTaskId", "method_params": "objectId", "method_startline": "61", "method_endline": "68"}}, "hunk_32": {"Ismethod": 1, "added_lines": null, "deleted_lines": "108,109,110", "method_info": {"method_name": "UniqueIdHelper::getUniqueness", "method_params": "", "method_startline": "108", "method_endline": "110"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\Worker.java", "file_new_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\core\\Worker.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "85,86,87", "deleted_lines": "85", "method_info": {"method_name": "Worker::submit", "method_params": "func,args", "method_startline": "83", "method_endline": "93"}}, "hunk_1": {"Ismethod": 1, "added_lines": "128", "deleted_lines": null, "method_info": {"method_name": "Worker::getCurrentTaskNextPutId", "method_params": "", "method_startline": "127", "method_endline": "130"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\spi\\LocalSchedulerLink.java", "file_new_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\spi\\LocalSchedulerLink.java", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "24,25", "deleted_lines": null}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\spi\\LocalSchedulerProxy.java", "file_new_name": "java\\runtime-common\\src\\main\\java\\org\\ray\\spi\\LocalSchedulerProxy.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "133,134,135", "deleted_lines": null, "method_info": {"method_name": "LocalSchedulerProxy::generateTaskId", "method_params": "driverId,parentTaskId,taskIndex", "method_startline": "133", "method_endline": "135"}}, "hunk_1": {"Ismethod": 1, "added_lines": "53", "deleted_lines": "53", "method_info": {"method_name": "LocalSchedulerProxy::genReturnIds", "method_params": "taskId,numReturns", "method_startline": "50", "method_endline": "56"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime-dev\\src\\main\\java\\org\\ray\\core\\impl\\RayDevRuntime.java", "file_new_name": "java\\runtime-dev\\src\\main\\java\\org\\ray\\core\\impl\\RayDevRuntime.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "36", "deleted_lines": "36", "method_info": {"method_name": "RayDevRuntime::createLocalActor", "method_params": "className", "method_startline": "34", "method_endline": "61"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime-dev\\src\\main\\java\\org\\ray\\spi\\impl\\MockLocalScheduler.java", "file_new_name": "java\\runtime-dev\\src\\main\\java\\org\\ray\\spi\\impl\\MockLocalScheduler.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "93,94,95", "deleted_lines": null, "method_info": {"method_name": "MockLocalScheduler::generateTaskId", "method_params": "driverId,parentTaskId,taskIndex", "method_startline": "93", "method_endline": "95"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\core\\impl\\RayNativeRuntime.java", "file_new_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\core\\impl\\RayNativeRuntime.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "246,247,248,249,250,251,252", "deleted_lines": "246,247", "method_info": {"method_name": "RayNativeRuntime::create", "method_params": "cls", "method_startline": "245", "method_endline": "265"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\spi\\impl\\DefaultLocalSchedulerClient.java", "file_new_name": "java\\runtime-native\\src\\main\\java\\org\\ray\\spi\\impl\\DefaultLocalSchedulerClient.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "119,120,121,122", "deleted_lines": null, "method_info": {"method_name": "DefaultLocalSchedulerClient::reconstructObjects", "method_params": "objectIds,fetchOnly", "method_startline": "118", "method_endline": "124"}}, "hunk_1": {"Ismethod": 1, "added_lines": "127,128,129,130", "deleted_lines": null, "method_info": {"method_name": "DefaultLocalSchedulerClient::generateTaskId", "method_params": "driverId,parentTaskId,taskIndex", "method_startline": "127", "method_endline": "130"}}}}, "file_10": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "java\\test\\src\\main\\java\\org\\ray\\api\\test\\UniqueIdTest.java"}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\local_scheduler\\lib\\java\\org_ray_spi_impl_DefaultLocalSchedulerClient.cc", "file_new_name": "src\\local_scheduler\\lib\\java\\org_ray_spi_impl_DefaultLocalSchedulerClient.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326", "deleted_lines": null, "method_info": {"method_name": "Java_org_ray_spi_impl_DefaultLocalSchedulerClient__1generateTaskId", "method_params": "env,jclass,did,ptid,parent_task_counter", "method_startline": "304", "method_endline": "326"}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\local_scheduler\\lib\\java\\org_ray_spi_impl_DefaultLocalSchedulerClient.h", "file_new_name": "src\\local_scheduler\\lib\\java\\org_ray_spi_impl_DefaultLocalSchedulerClient.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "133,134,135,136,137,138,139,140,141,142,143,144", "deleted_lines": null}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\id.cc", "file_new_name": "src\\ray\\id.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "181", "deleted_lines": null, "method_info": {"method_name": "ray::ComputePutId", "method_params": "task_id,put_index", "method_startline": "179", "method_endline": "183"}}, "hunk_1": {"Ismethod": 1, "added_lines": "195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213", "deleted_lines": null, "method_info": {"method_name": "ray::GenerateTaskId", "method_params": "driver_id,parent_task_id,parent_task_counter", "method_startline": "195", "method_endline": "213"}}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\id.h", "file_new_name": "src\\ray\\id.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "13,14,15,16,88,89,90,91,92,93,94,95,96", "deleted_lines": null}}}, "file_15": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1198,1199,1200,1201,1202", "deleted_lines": "1198,1199,1200,1201,1202,1203,1204", "method_info": {"method_name": "ray::raylet::NodeManager::HandleTaskReconstruction", "method_params": "task_id", "method_startline": "1180", "method_endline": "1204"}}}}, "file_16": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\task_spec.cc", "file_new_name": "src\\ray\\raylet\\task_spec.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "66,67", "deleted_lines": "66,67,68,69,70,71,72,73,74,75,76,77,78,79", "method_info": {"method_name": "ray::raylet::TaskSpecification::TaskSpecification", "method_params": "driver_id,parent_task_id,parent_counter,actor_creation_id,actor_creation_dummy_object_id,actor_id,actor_handle_id,actor_counter,function_id,task_arguments,num_returns,required_resources,language", "method_startline": "55", "method_endline": "105"}}}}}}}