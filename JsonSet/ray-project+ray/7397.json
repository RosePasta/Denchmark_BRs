{"BR": {"BR_id": "7397", "BR_author": "soundway", "BRopenT": "2020-03-02T08:22:54Z", "BRcloseT": "2020-03-02T10:29:11Z", "BR_text": {"BRsummary": "[rllib] TorchDiagGaussian doesn\u2019t handle multiple actions correctly.", "BRdescription": "\n This is not a contribution.\n Ray version: 0.8.2\n Python version: 3.6.8\n Pytorch version: 1.4\n OS: Ubuntu 18.04 Docker\n TorchDiagGaussian doesn\u2019t handle multiple actions correctly. As a result, training PPO with Pytorch will crash when the action space has more than 1 action. Here\u2019s minimal reproduction script:\n import gym\n from gym.spaces import Box\n from ray import tune\n \n class ContinuousEnv(gym.Env):\n    def __init__(self, config):\n        self.action_space = Box(0.0, 1.0, shape=(2,))\n        self.observation_space = Box(0.0, 1.0, shape=(1, ))\n \n    def reset(self):\n        return [0.0]\n \n    def step(self, action):\n        return [0.0], 1.0, False, {}\n \n tune.run(\n    \"PPO\",\n    config={\"env\": ContinuousEnv, \"use_pytorch\": True, \"num_workers\": 1})\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "soundway", "commentT": "2020-03-02T09:03:09Z", "comment_text": "\n \t\tThanks for filing this. Taking a look ...\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "soundway", "commentT": "2020-03-02T10:29:11Z", "comment_text": "\n \t\tPlease try this PR for a fix. This will go into master within the next few days.\n <denchmark-link:https://github.com/ray-project/ray/pull/7398>#7398</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "soundway", "commentT": "2020-03-04T03:09:46Z", "comment_text": "\n \t\tThis works. Thanks for the quick fix!\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "soundway", "commentT": "2020-03-30T13:38:26Z", "comment_text": "\n \t\tHad the same problem, so i updated to the 0.8.3 version. Now the bug happens in the GAE calculation:\n File \"/home/spider-sense01/PycharmProjects/multi-agent-emergence-environments/.venv/lib/python3.6/site-packages/ray/rllib/agents/ppo/ppo_torch_policy.py\", line 105, in init\n vf_loss_coeff * vf_loss - entropy_coeff * curr_entropy)\n RuntimeError: The size of tensor a (512) must match the size of tensor b (2) at non-singleton dimension 1\n \t\t"}}}, "commit": {"commit_id": "d8eeb9641314740572e81f9836cbce3e5b8f2b73", "commit_author": "Sven Mika", "commitT": "2020-03-02 10:53:19-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "rllib\\agents\\ppo\\ppo_torch_policy.py", "file_new_name": "rllib\\agents\\ppo\\ppo_torch_policy.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "118", "deleted_lines": "116,117,118", "method_info": {"method_name": "ppo_surrogate_loss", "method_params": "policy,model,dist_class,train_batch", "method_startline": "114", "method_endline": "144"}}, "hunk_1": {"Ismethod": 1, "added_lines": "72,73", "deleted_lines": "72", "method_info": {"method_name": "reduce_mean_valid", "method_params": "t", "method_startline": "72", "method_endline": "73"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "rllib\\models\\torch\\torch_action_dist.py", "file_new_name": "rllib\\models\\torch\\torch_action_dist.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "74", "deleted_lines": "74", "method_info": {"method_name": "logp", "method_params": "self,actions", "method_startline": "73", "method_endline": "74"}}, "hunk_1": {"Ismethod": 1, "added_lines": "81,82", "deleted_lines": null, "method_info": {"method_name": "kl", "method_params": "self,other", "method_startline": "81", "method_endline": "82"}}, "hunk_2": {"Ismethod": 1, "added_lines": "77,78", "deleted_lines": null, "method_info": {"method_name": "entropy", "method_params": "self", "method_startline": "77", "method_endline": "78"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "rllib\\tests\\test_supported_spaces.py", "file_new_name": "rllib\\tests\\test_supported_spaces.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "80,83,84,92,93,94,99,100,101,102,103,104,106,107,108,109,110,111", "deleted_lines": "80,81,93,94,96", "method_info": {"method_name": "check_support", "method_params": "alg,config,stats,check_bounds,name", "method_startline": "75", "method_endline": "135"}}, "hunk_1": {"Ismethod": 1, "added_lines": "231,232,233,234,235,236,237", "deleted_lines": null, "method_info": {"method_name": "test_pg", "method_params": "self", "method_startline": "230", "method_endline": "237"}}, "hunk_2": {"Ismethod": 1, "added_lines": "219,220,221,222,223,224,225,226,227,228", "deleted_lines": "218,219,220,221,222", "method_info": {"method_name": "test_ppo", "method_params": "self", "method_startline": "218", "method_endline": "228"}}, "hunk_3": {"Ismethod": 1, "added_lines": "162,163,164,165,166,167,168,169,170", "deleted_lines": null, "method_info": {"method_name": "test_a3c", "method_params": "self", "method_startline": "161", "method_endline": "170"}}}}}}}