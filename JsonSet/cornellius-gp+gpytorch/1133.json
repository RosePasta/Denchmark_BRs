{"BR": {"BR_id": "1133", "BR_author": "wjmaddox", "BRopenT": "2020-05-04T15:26:19Z", "BRcloseT": "2020-06-14T00:44:08Z", "BR_text": {"BRsummary": "[Bug] ConstantMulLazyTensor can only add batched tensors", "BRdescription": "\n <denchmark-h:h1>\ud83d\udc1b Bug</denchmark-h>\n \n ConstantMulLazyTensor attempts to expand _constant according to batch dimensions which fails when there is no batch dimension.\n <denchmark-h:h2>To reproduce</denchmark-h>\n \n ** Code snippet to reproduce **\n import gpytorch\n import torch\n \n tlt = gpytorch.lazy.ToeplitzLazyTensor(torch.randn(100).abs())\n cmtlt = torch.ones(1) * tlt\n cmtlt + torch.randn(100, 100)\n \n #more specifically\n cmtlt._constant.expand(*torch.Size([])) # fails\n ** Stack trace/error message **\n <denchmark-code>---------------------------------------------------------------------------\n TypeError                                 Traceback (most recent call last)\n <ipython-input-16-0d626e17adaf> in <module>\n ----> 1 cmtlt + torch.randn(100, 100)\n \n ~/Documents/GitHub/gpytorch/gpytorch/lazy/lazy_tensor.py in __add__(self, other)\n    1625             other = lazify(other)\n    1626             shape = _mul_broadcast_shape(self.shape, other.shape)\n -> 1627             return SumLazyTensor(self.expand(shape), other.expand(shape))\n    1628         else:\n    1629             return SumLazyTensor(self, other)\n \n ~/Documents/GitHub/gpytorch/gpytorch/lazy/lazy_tensor.py in expand(self, *sizes)\n     857             raise RuntimeError(\"Invalid arguments {} to expand.\".format(sizes))\n     858 \n --> 859         res = self._expand_batch(batch_shape=shape[:-2])\n     860         return res\n     861 \n \n ~/Documents/GitHub/gpytorch/gpytorch/lazy/constant_mul_lazy_tensor.py in _expand_batch(self, batch_shape)\n      70     def _expand_batch(self, batch_shape):\n ---> 71         return self.__class__(self.base_lazy_tensor._expand_batch(batch_shape), self._constant.expand(*batch_shape))\n      72 \n      73     def _get_indices(self, row_index, col_index, *batch_indices):\n \n TypeError: expand() missing 1 required positional arguments: \"size\"\n </denchmark-code>\n \n <denchmark-h:h2>Expected Behavior</denchmark-h>\n \n It should return a SumLazyTensor of shape 100 x 100.\n <denchmark-h:h2>System information</denchmark-h>\n \n Please complete the following information:\n gpytorch 1.0.1 (code hasn't changed in 1.1.0)\n pytorch 1.4.0\n MacOS\n <denchmark-h:h2>Additional context</denchmark-h>\n \n The fix is to force the tensor that is being added to have a batch dimension.\n cmtlt + torch.randn(1, 100, 100)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "wjmaddox", "commentT": "2020-05-13T12:45:14Z", "comment_text": "\n \t\tHuh this seems strange. Thanks for the bug catch!\n I'm swamped right now but I can get to this in a week or two, or LMK if you can submit a PR.\n \t\t"}}}, "commit": {"commit_id": "98e1fc360539d530628b4b48b1270c62987396b4", "commit_author": "Geoff Pleiss", "commitT": "2020-06-09 10:32:56-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "gpytorch\\lazy\\cat_lazy_tensor.py", "file_new_name": "gpytorch\\lazy\\cat_lazy_tensor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "129,130,131,132,133,134,135,136,137,138,139,140,141,142", "deleted_lines": "129", "method_info": {"method_name": "_expand_batch", "method_params": "self,batch_shape", "method_startline": "128", "method_endline": "144"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "gpytorch\\lazy\\constant_mul_lazy_tensor.py", "file_new_name": "gpytorch\\lazy\\constant_mul_lazy_tensor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "71,72,73,74", "deleted_lines": "71", "method_info": {"method_name": "_expand_batch", "method_params": "self,batch_shape", "method_startline": "70", "method_endline": "74"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "gpytorch\\lazy\\lazy_tensor.py", "file_new_name": "gpytorch\\lazy\\lazy_tensor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1627,1628,1629", "deleted_lines": "1627", "method_info": {"method_name": "__add__", "method_params": "self,other", "method_startline": "1600", "method_endline": "1631"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "gpytorch\\lazy\\sum_lazy_tensor.py", "file_new_name": "gpytorch\\lazy\\sum_lazy_tensor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "84,85,86", "deleted_lines": "84,85,86,87,88", "method_info": {"method_name": "__add__", "method_params": "self,other", "method_startline": "64", "method_endline": "88"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "gpytorch\\test\\lazy_tensor_test_case.py", "file_new_name": "gpytorch\\test\\lazy_tensor_test_case.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "48,49,50,51,52,53,54,55,56,57,58,59", "deleted_lines": null, "method_info": {"method_name": "test_add", "method_params": "self", "method_startline": "48", "method_endline": "59"}}}}}}}