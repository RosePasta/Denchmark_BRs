{"BR": {"BR_id": "13202", "BR_author": "yaroslavvb", "BRopenT": "2017-09-21T03:44:15Z", "BRcloseT": "2018-04-02T04:20:16Z", "BR_text": {"BRsummary": "tf.InteractiveSession leaks sessions", "BRdescription": "\n The following works fine with tf.Session() but will fail to release resources in tf.InteractiveSession\n <denchmark-code>sess = tf.InteractiveSession()\n # do stuff  \n sess.close()\n del sess\n </denchmark-code>\n \n The reason is that interactive session enters a context using __enter()__ and never quits it, leaving a reference from a DefaultStack object. I found this when debugging why my notebook was hogging all GPU RAM.\n The two work-arounds:\n \n Force C_API to close the session using sess.__del__()\n Get rid of the dangling reference\n \n <denchmark-code>    sess._default_session.__exit__(None, None, None)\n     del sess\n     import gc\n     gc.collect()\n </denchmark-code>\n \n I think a better solution would be to have sess.close() call both TF_CloseSession and TF_DeleteSession, or have a method that will reset all sessions like session_lib.Reset\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yaroslavvb", "commentT": "2017-09-21T15:31:16Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  do you know if anyone's planning to make  work for local sessions?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yaroslavvb", "commentT": "2017-09-21T16:39:15Z", "comment_text": "\n \t\tDerek, could you please take a look. Thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yaroslavvb", "commentT": "2017-09-21T16:44:55Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/yaroslavvb>@yaroslavvb</denchmark-link>\n  I'm confused by your diagnosis, because the  method <denchmark-link:https://github.com/tensorflow/tensorflow/blob/e9d5ee1ebffba25cef65f1f354b9e4ca9bcea10c/tensorflow/python/client/session.py#L1627>explicitly calls __exit__()</denchmark-link>\n  on the context managers it enters in the constructor. Where is the dangling reference?\n  is <denchmark-link:https://github.com/tensorflow/tensorflow/blob/e9d5ee1ebffba25cef65f1f354b9e4ca9bcea10c/tensorflow/core/common_runtime/direct_session.cc#L183>implemented</denchmark-link>\n  for local sessions, but it's not clear what you think it should do....\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yaroslavvb", "commentT": "2017-09-21T16:47:26Z", "comment_text": "\n \t\tI'm experiencing the same with the normal tf.Session and also while using the C API directly. The following code keeps the memory on the GPU allocated until it exits.\n <denchmark-code>#include <tensorflow/c/c_api.h>\n #include <unistd.h>  // usleep\n \n \n int main() {\n     TF_Graph* graph = TF_NewGraph();\n     TF_SessionOptions* options = TF_NewSessionOptions();\n     TF_Status* status = TF_NewStatus();\n     TF_Session* sess = TF_NewSession(graph, options, status);\n     TF_CloseSession(sess, status);\n     TF_DeleteSession(sess, status);\n     TF_DeleteSessionOptions(options);\n     TF_DeleteGraph(graph);\n     TF_DeleteStatus(status);\n     usleep(5000000);  // gpu resources are still allocated here\n }\n </denchmark-code>\n \n I'm running Ubuntu 16.04, cudnn 6.0, cuda 8.0, tensorflow-master build is 2 hours old.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yaroslavvb", "commentT": "2017-09-21T17:04:15Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/PhilJd>@PhilJd</denchmark-link>\n  that's a different issue -- the memory allocator is global to the process, so it will keep the memory allocated even if the session gets closed.\n <denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  indeed that method gets called, but somehow session doesn't get garbage collected. I assumed DefaultStack was to blame by looking at \n CPython is supposed to call __del__ immediately after ref-count gets decremented to 0, and somehow it doesn't. Adding import gc; gc.collect() after __exit__ seems to remove the leak as well\n Repro: <denchmark-link:https://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report.py>https://github.com/yaroslavvb/stuff/blob/master/resnet_leak_report.py</denchmark-link>\n \n When I run it, I see\n <denchmark-code>Run 0, GB's in use 2.1\n Run 1, GB's in use 3.4\n Run 2, GB's in use 5.0\n <OOM crash>\n \n Calling __del__\n Calling __del__\n Calling __del__\n </denchmark-code>\n \n I'll update this issue if I find why CPython doesn't call del\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "yaroslavvb", "commentT": "2017-09-21T18:58:48Z", "comment_text": "\n \t\tOK, looks like  isn't called because there's a cycle and ref count never goes to zero.\n  points back to sess (args are filled in <denchmark-link:https://github.com/tensorflow/tensorflow/blob/03619fab3f4dd6f28b67418455a953b0fccdd9bf/tensorflow/python/framework/ops.py#L4507>here</denchmark-link>\n ), but there's no such cycle when using \n Running gc.collect detects cycles and cleans them up.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "yaroslavvb", "commentT": "2017-09-21T19:25:04Z", "comment_text": "\n \t\tIronically InteractiveSession only causes this problem during interactive use, when you have a notebook open and create new graphs/sessions without restarting the process.\n The underlying issue is that sess needs to keep a reference to the default context manager (otherwise it gets garbage collected and closed), whereas default context manager must link back to session. This seems hard to fix this issue without big refactoring of context manager logic. Perhaps it should be a docs issue and mentioned in docs of InteractiveSession that gc.collect must be called to reclaim resources\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "yaroslavvb", "commentT": "2017-09-25T21:50:44Z", "comment_text": "\n \t\tWould it make sense to make tf.InteractiveSession() a singleton and add a warnings.warn('Use tf.Session() instead if you intend to have multiple sessions') upon the second call? Singletons are typically bad, but maybe very fitting in this particular case.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "yaroslavvb", "commentT": "2017-09-25T21:56:26Z", "comment_text": "\n \t\tI think that would be better than status quo which is \"1. create multiple interactive sessions by accident. 2. run out of GPU memory 3. restart notebook server\"\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "yaroslavvb", "commentT": "2017-12-20T01:13:14Z", "comment_text": "\n \t\tIt has been 14 days with no activity and this issue has an assignee.Please update the label and/or status accordingly.\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "yaroslavvb", "commentT": "2018-01-03T19:15:24Z", "comment_text": "\n \t\tIt has been 14 days with no activity and this issue has an assignee.Please update the label and/or status accordingly.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "yaroslavvb", "commentT": "2018-01-18T19:16:00Z", "comment_text": "\n \t\tNagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "yaroslavvb", "commentT": "2018-01-18T20:49:23Z", "comment_text": "\n \t\tFix in progress...\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "yaroslavvb", "commentT": "2018-02-06T07:47:49Z", "comment_text": "\n \t\tNagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "yaroslavvb", "commentT": "2018-02-20T19:40:31Z", "comment_text": "\n \t\tNagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "yaroslavvb", "commentT": "2018-03-07T13:18:22Z", "comment_text": "\n \t\tNagging Assignee <denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n : It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_16": {"comment_id": 17, "comment_author": "yaroslavvb", "commentT": "2018-03-15T16:21:46Z", "comment_text": "\n \t\tSo after implementing a couple of fixes for this, it seems there's no way to stop the leak without breaking an existing use case. The \"fix\" will be a warning, as <denchmark-link:https://github.com/carlthome>@carlthome</denchmark-link>\n  suggested, and we will investigate a more principled fix for TensorFlow 2.0.\n \t\t"}, "comments_17": {"comment_id": 18, "comment_author": "yaroslavvb", "commentT": "2018-03-16T23:15:53Z", "comment_text": "\n \t\tPS, the work-around is to do the following\n <denchmark-code>sess = tf.InteractiveSession()\n import gc; gc.collect()\n </denchmark-code>\n \n That will run cyclic garbage collector and remove all the dangling sessions\n \t\t"}, "comments_18": {"comment_id": 19, "comment_author": "yaroslavvb", "commentT": "2018-03-16T23:25:50Z", "comment_text": "\n \t\tNote that we've had to roll back <denchmark-link:https://github.com/tensorflow/tensorflow/commit/0f508d4de379e800ad7f990de08959bbd6fcabb5>0f508d4</denchmark-link>\n  internally, because it has a bug that produces spurious warnings. We will fix it after the weekend, but in the mean time the nightly build will have the spurious messages.\n \t\t"}, "comments_19": {"comment_id": 20, "comment_author": "yaroslavvb", "commentT": "2018-03-16T23:31:18Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  maybe you can just do  in the first call to  of InteractiveSession\n \t\t"}, "comments_20": {"comment_id": 21, "comment_author": "yaroslavvb", "commentT": "2018-03-16T23:41:00Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/yaroslavvb>@yaroslavvb</denchmark-link>\n  The  trick doesn't solve the problem for me.  Not sure why yet.\n \t\t"}, "comments_21": {"comment_id": 22, "comment_author": "yaroslavvb", "commentT": "2018-03-31T18:25:56Z", "comment_text": "\n \t\tNagging Assignee <denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n : It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_22": {"comment_id": 23, "comment_author": "yaroslavvb", "commentT": "2018-04-02T04:20:16Z", "comment_text": "\n \t\tThe warning was re-added in <denchmark-link:https://github.com/tensorflow/tensorflow/commit/a80fb2b1cad1bb9c868222b8c25f162d69a509e6>a80fb2b</denchmark-link>\n  so I'm marking this as closed.\n \t\t"}}}, "commit": {"commit_id": "0f508d4de379e800ad7f990de08959bbd6fcabb5", "commit_author": "Derek Murray", "commitT": "2018-03-15 12:37:47-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\client\\session.py", "file_new_name": "tensorflow\\python\\client\\session.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1659,1660,1661,1662,1663,1664,1665,1666,1667", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,target,graph,config", "method_startline": "1631", "method_endline": "1675"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1680,1681,1682,1683,1684,1685", "deleted_lines": null, "method_info": {"method_name": "close", "method_params": "self", "method_startline": "1677", "method_endline": "1688"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\client\\session_test.py", "file_new_name": "tensorflow\\python\\client\\session_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "70,71,72", "deleted_lines": null, "method_info": {"method_name": "setUp", "method_params": "self", "method_startline": "70", "method_endline": "72"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1199,1200,1201,1202,1203,1204,1205,1206,1207,1208,1209,1210,1211,1212,1213,1214,1215,1216,1217,1218,1219,1220,1221,1222,1223", "deleted_lines": null, "method_info": {"method_name": "testMultipleInteractiveSessionsWarning", "method_params": "self", "method_startline": "1199", "method_endline": "1223"}}}}}}}