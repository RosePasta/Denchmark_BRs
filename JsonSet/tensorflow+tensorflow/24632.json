{"BR": {"BR_id": "24632", "BR_author": "ageron", "BRopenT": "2018-12-30T16:10:30Z", "BRcloseT": "2019-03-05T22:32:45Z", "BR_text": {"BRsummary": "Interrupting tf.keras training while using the TensorBoard callback wreaks havoc", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n Yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04):\n Mac OS X 10.13.6\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\n N/A\n TensorFlow installed from (source or binary):\n binary\n TensorFlow version (use command below):\n VERSION=\"1.13.0-dev20181226\" (this is the TF 2.0-preview)\n GIT_VERSION=\"b'v1.12.0-5133-gc343196842'\"\n Python version:\n 3.6.6\n Bazel version (if compiling from source):\n N/A\n GCC/Compiler version (if compiling from source):\n N/A\n CUDA/cuDNN version:\n N/A\n GPU model and memory:\n N/A\n \n Describe the current behavior\n Using tf.keras in Jupyter (or a Python shell) with the TensorBoard callback, some problems occur if I interrupt training. These problems did not occur in TF 1.12:\n \n I get an exception if I call fit() again on the same model:\n \n <denchmark-code>tensorflow.python.framework.errors_impl.NotFoundError: Resource\n localhost/logdir:logs/run1/N10tensorflow22SummaryWriterInterfaceE does not exist.\n [Op:WriteScalarSummary] name: epoch_loss/\n </denchmark-code>\n \n I can workaround this problem by recompiling the model.\n \n I also get an exception if I interrupt training, then I delete the logs directory, then I try to use the TensorBoard callback on the same logs directory again:\n \n <denchmark-code>tensorflow.python.framework.errors_impl.UnknownError: The events file logs/run1/events.out.tfevents.1546185456.macmix.local.v2 has disappeared.\n \tFailed to flush 1 events to logs/run1/events.out.tfevents.1546185456.macmix.local.v2\n \tCould not flush events file. [Op:FlushSummaryWriter]\n </denchmark-code>\n \n This one is more severe: sometimes it recovers by itself after a while. Sometimes is doesn't and I cannot find any way to manually recover from this error, other than restarting the Jupyter kernel (or the Python shell).\n Describe the expected behavior\n I expect the TensorBoard callback to gracefully handle these issues, perhaps display a warning, but do not force a recompile or a kernel restart.\n Code to reproduce the issue\n import shutil\n import numpy as np\n import tensorflow as tf\n from tensorflow import keras\n \n X_train = np.random.rand(1000, 10)\n y_train = np.random.rand(1000)\n model = keras.models.Sequential([keras.layers.Dense(1)])\n model.compile(loss=\"mse\", optimizer=\"sgd\")\n tensorboard_cb = keras.callbacks.TensorBoard(\"logs/run1\")\n model.fit(X_train, y_train, epochs=1000, callbacks=[tensorboard_cb])\n # NOTE: you must interrupt training (Ctrl-C) before it finishes\n \n # For issue #1, try this:\n model.fit(X_train, y_train, epochs=1000, callbacks=[tensorboard_cb])\n \n # For issue #2, try this (you may need to interrupt and retry a few times):\n shutil.rmtree(\"logs\")\n model = keras.models.Sequential([keras.layers.Dense(1)])\n model.compile(loss=\"mse\", optimizer=\"sgd\")\n tensorboard_cb = keras.callbacks.TensorBoard(\"logs/run1\")\n model.fit(X_train, y_train, epochs=1000, callbacks=[tensorboard_cb])\n \n Here is a gist with the full session output:\n <denchmark-link:https://gist.github.com/ageron/1d430d4a7716c7a2bae44ee82c321f01>https://gist.github.com/ageron/1d430d4a7716c7a2bae44ee82c321f01</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ageron", "commentT": "2018-12-30T16:15:23Z", "comment_text": "\n \t\tNote: I checked, this issue does not occur with TF 1.12.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ageron", "commentT": "2019-01-07T21:01:46Z", "comment_text": "\n \t\tHello <denchmark-link:https://github.com/martinwicke>@martinwicke</denchmark-link>\n , In this issue <denchmark-link:https://github.com/ageron>@ageron</denchmark-link>\n  has outlined that for r2.0 (a) tf.Keras model training when interrupted by TensorBoard callback and then resume training generates an exception (b) interrupting training and deleting logs and invoking TensorBoard callback generates an exception. Thanks.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ageron", "commentT": "2019-01-25T05:21:41Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/omalleyt12>@omalleyt12</denchmark-link>\n  are you working on TensorBoard integration? Can you take a look at this?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ageron", "commentT": "2019-01-25T08:35:21Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/martinwicke>@martinwicke</denchmark-link>\n  Yep, will do\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ageron", "commentT": "2019-01-28T19:37:29Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/ageron>@ageron</denchmark-link>\n , to clarify, this issue is occurring after you've 'd a cell in the Jupyter notebook?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ageron", "commentT": "2019-01-28T19:50:19Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/omalleyt12>@omalleyt12</denchmark-link>\n  ,\n It's either in the Python shell (command line) after I press Ctrl-C during training, or in a Jupyter notebook after I interrupt the kernel during training.\n Hope this helps.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ageron", "commentT": "2019-01-28T19:55:21Z", "comment_text": "\n \t\tI can confirm that I could reproduce the issue in a Python shell and in a Jupyter notebook, using the latest tf-nightly-2.0-preview (version '2.0.0-dev20190126', \"b'v1.12.0-6726-g5522d670af'\").\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "ageron", "commentT": "2019-02-12T23:52:02Z", "comment_text": "\n \t\tThanks for the reports!\n Issue 1 has the root cause <denchmark-link:https://github.com/tensorflow/tensorflow/issues/25707>#25707</denchmark-link>\n  which is actually independent of Keras.\n Issue 2 is not strictly speaking the same problem, but the proposed solution to <denchmark-link:https://github.com/tensorflow/tensorflow/issues/25707>#25707</denchmark-link>\n  would also fix issue 2, because it would mean each execution of the callback would create a new event file (the same as the 1.x behavior).\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "ageron", "commentT": "2019-03-05T22:32:44Z", "comment_text": "\n \t\tThe root cause <denchmark-link:https://github.com/tensorflow/tensorflow/issues/25707>#25707</denchmark-link>\n  has been fixed in <denchmark-link:https://github.com/tensorflow/tensorflow/commit/826027dbd4277a2636fc2935ed245700fd01e7cd>826027d</denchmark-link>\n , and propagated into the Keras callback by <denchmark-link:https://github.com/wchargin>@wchargin</denchmark-link>\n  in <denchmark-link:https://github.com/tensorflow/tensorflow/commit/059ea3ba68db861e40d750eba688281011d2735f>059ea3b</denchmark-link>\n .\n Issue 1 should be completely fixed, and issue 2 should only occur if you delete the event files in the middle of training (without interrupting the keras callback, as described in the OP) while the writer is still open and then it tries to flush to the no-longer-existing file.  In that case I think it's reasonable to report the error and I believe that matches previous behavior.\n \t\t"}}}, "commit": {"commit_id": "826027dbd4277a2636fc2935ed245700fd01e7cd", "commit_author": "Nick Felt", "commitT": "2019-02-22 13:44:32-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\BUILD", "file_new_name": "tensorflow\\python\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "3306", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\kernel_tests\\BUILD", "file_new_name": "tensorflow\\python\\kernel_tests\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1096", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 38, "file_old_name": "tensorflow\\python\\kernel_tests\\summary_ops_test.py", "file_new_name": "tensorflow\\python\\kernel_tests\\summary_ops_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "70,71,72", "deleted_lines": "70", "method_info": {"method_name": "testWrite_fromFunction.f", "method_params": "", "method_startline": "70", "method_endline": "72"}}, "hunk_1": {"Ismethod": 1, "added_lines": "130,131,132", "deleted_lines": null, "method_info": {"method_name": "testWrite_tensor_fromFunction.f", "method_params": "t", "method_startline": "130", "method_endline": "132"}}, "hunk_2": {"Ismethod": 1, "added_lines": "336,337,338,339,340,341,342,343,344,345,346,347", "deleted_lines": "336,337,338,339,340,341,342,345,346", "method_info": {"method_name": "testCreate_fromFunction", "method_params": "self", "method_startline": "336", "method_endline": "347"}}, "hunk_3": {"Ismethod": 1, "added_lines": "563", "deleted_lines": null, "method_info": {"method_name": "testDereference_closesOpenFile", "method_params": "self", "method_startline": "554", "method_endline": "569"}}, "hunk_4": {"Ismethod": 1, "added_lines": "423,424,425,426,427", "deleted_lines": null, "method_info": {"method_name": "testNoSharing_fromFunction.f1", "method_params": "", "method_startline": "423", "method_endline": "427"}}, "hunk_5": {"Ismethod": 1, "added_lines": "210", "deleted_lines": "207", "method_info": {"method_name": "testWrite_recordIf_callable", "method_params": "self", "method_startline": "203", "method_endline": "221"}}, "hunk_6": {"Ismethod": 1, "added_lines": "87", "deleted_lines": "86", "method_info": {"method_name": "testWrite_metadata", "method_params": "self", "method_startline": "82", "method_endline": "96"}}, "hunk_7": {"Ismethod": 1, "added_lines": "339,340,341,342,343", "deleted_lines": "339,340,341,342", "method_info": {"method_name": "testCreate_fromFunction.f", "method_params": "", "method_startline": "339", "method_endline": "343"}}, "hunk_8": {"Ismethod": 1, "added_lines": "128,129,130,131,132", "deleted_lines": "126,127,128,129", "method_info": {"method_name": "testWrite_tensor_fromFunction", "method_params": "self", "method_startline": "125", "method_endline": "138"}}, "hunk_9": {"Ismethod": 1, "added_lines": "370,371,372,373,374,375,376,377,378,379,380,381,382", "deleted_lines": "372,373,375,377,378,379", "method_info": {"method_name": "testCreate_fromFunction_unpersistedResource_raisesError", "method_params": "self", "method_startline": "370", "method_endline": "382"}}, "hunk_10": {"Ismethod": 1, "added_lines": "479", "deleted_lines": null, "method_info": {"method_name": "testWriterFlush", "method_params": "self", "method_startline": "475", "method_endline": "490"}}, "hunk_11": {"Ismethod": 1, "added_lines": "349,351,352,354,355,356,357", "deleted_lines": "349,350,351,352,355,356,357", "method_info": {"method_name": "testCreate_graphTensorArgument_raisesError", "method_params": "self", "method_startline": "349", "method_endline": "357"}}, "hunk_12": {"Ismethod": 1, "added_lines": "68,69,70,71,72", "deleted_lines": "67,68,69,70", "method_info": {"method_name": "testWrite_fromFunction", "method_params": "self", "method_startline": "65", "method_endline": "80"}}, "hunk_13": {"Ismethod": 1, "added_lines": "189,190,191,192,193,194,195,196", "deleted_lines": "189,190,191,192", "method_info": {"method_name": "testWrite_recordIf_constant_fromFunction.f", "method_params": "", "method_startline": "189", "method_endline": "196"}}, "hunk_14": {"Ismethod": 1, "added_lines": "522,523,524,525,526,527,528,529,530,531,532,533,534,535", "deleted_lines": null, "method_info": {"method_name": "testClose_preventsLaterUse", "method_params": "self", "method_startline": "522", "method_endline": "535"}}, "hunk_15": {"Ismethod": 1, "added_lines": "319,322,324,325,328,331,334", "deleted_lines": "319,320,321,322,325,328,331,332,333,334", "method_info": {"method_name": "testCreate_withInitAndClose", "method_params": "self", "method_startline": "319", "method_endline": "334"}}, "hunk_16": {"Ismethod": 1, "added_lines": "226,234", "deleted_lines": "230,246", "method_info": {"method_name": "testWrite_recordIf_callable_fromFunction", "method_params": "self", "method_startline": "223", "method_endline": "246"}}, "hunk_17": {"Ismethod": 1, "added_lines": "429,430,431,432,433", "deleted_lines": null, "method_info": {"method_name": "testNoSharing_fromFunction.f2", "method_params": "", "method_startline": "429", "method_endline": "433"}}, "hunk_18": {"Ismethod": 1, "added_lines": "254,255,256,257", "deleted_lines": null, "method_info": {"method_name": "testWrite_recordIf_tensorInput_fromFunction.f", "method_params": "step", "method_startline": "254", "method_endline": "257"}}, "hunk_19": {"Ismethod": 1, "added_lines": "234", "deleted_lines": null, "method_info": {"method_name": "testWrite_recordIf_callable_fromFunction.f", "method_params": "", "method_startline": "233", "method_endline": "239"}}, "hunk_20": {"Ismethod": 1, "added_lines": "384,385,386,387,388,391,392,393,394,395,398,399,400,401,403,404,405,406,407,409,412,413,414,415,416", "deleted_lines": "384,399,415", "method_info": {"method_name": "testNoSharing", "method_params": "self", "method_startline": "384", "method_endline": "418"}}, "hunk_21": {"Ismethod": 1, "added_lines": "519", "deleted_lines": null, "method_info": {"method_name": "testEagerMemory", "method_params": "self", "method_startline": "517", "method_endline": "520"}}, "hunk_22": {"Ismethod": 1, "added_lines": "495", "deleted_lines": null, "method_info": {"method_name": "testFlushFunction", "method_params": "self", "method_startline": "492", "method_endline": "514"}}, "hunk_23": {"Ismethod": 1, "added_lines": "464", "deleted_lines": "468", "method_info": {"method_name": "testMaxQueue", "method_params": "self", "method_startline": "461", "method_endline": "473"}}, "hunk_24": {"Ismethod": 1, "added_lines": "342,343,344,345,346,347,348,349,351,352,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379", "deleted_lines": "342,345,346,349,350,351,352,355,356,357,358,359,360,361,363,365,366,372,373,375,377,378,379", "method_info": {"method_name": "testSharedName", "method_params": "self", "method_startline": "342", "method_endline": "379"}}, "hunk_25": {"Ismethod": 1, "added_lines": "362,363", "deleted_lines": "363", "method_info": {"method_name": "testCreate_fromFunction_graphTensorArgument_raisesError.f", "method_params": "", "method_startline": "362", "method_endline": "363"}}, "hunk_26": {"Ismethod": 1, "added_lines": "359,360,361,362,363,364,365,366,367,368", "deleted_lines": "359,360,361,363,365,366", "method_info": {"method_name": "testCreate_fromFunction_graphTensorArgument_raisesError", "method_params": "self", "method_startline": "359", "method_endline": "368"}}, "hunk_27": {"Ismethod": 1, "added_lines": "173", "deleted_lines": "171", "method_info": {"method_name": "testWrite_recordIf_constant", "method_params": "self", "method_startline": "170", "method_endline": "182"}}, "hunk_28": {"Ismethod": 1, "added_lines": "319,322,324,325,328,331,334,335,336,337,338,339,340", "deleted_lines": "314,317,319,320,321,322,325,328,331,332,333,334,335,336,337,338,339,340", "method_info": {"method_name": "testWriterInitAndClose", "method_params": "self", "method_startline": "314", "method_endline": "340"}}, "hunk_29": {"Ismethod": 1, "added_lines": "420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,452,453,454,455,456,457,458", "deleted_lines": "439,451", "method_info": {"method_name": "testNoSharing_fromFunction", "method_params": "self", "method_startline": "420", "method_endline": "459"}}, "hunk_30": {"Ismethod": 1, "added_lines": "118", "deleted_lines": "117", "method_info": {"method_name": "testWrite_tensor", "method_params": "self", "method_startline": "114", "method_endline": "123"}}, "hunk_31": {"Ismethod": 1, "added_lines": "187,188,189,190,191,192,193,194,195,196", "deleted_lines": "184,185,186,187,188,189,190,191,192", "method_info": {"method_name": "testWrite_recordIf_constant_fromFunction", "method_params": "self", "method_startline": "184", "method_endline": "201"}}, "hunk_32": {"Ismethod": 1, "added_lines": "55", "deleted_lines": "55", "method_info": {"method_name": "testWrite", "method_params": "self", "method_startline": "52", "method_endline": "63"}}, "hunk_33": {"Ismethod": 1, "added_lines": "143", "deleted_lines": "141", "method_info": {"method_name": "testWrite_stringTensor", "method_params": "self", "method_startline": "140", "method_endline": "147"}}, "hunk_34": {"Ismethod": 1, "added_lines": "108", "deleted_lines": "107", "method_info": {"method_name": "testWrite_ndarray", "method_params": "self", "method_startline": "105", "method_endline": "112"}}, "hunk_35": {"Ismethod": 1, "added_lines": "251,252,253,254,255,256,257", "deleted_lines": "248,249,250,251", "method_info": {"method_name": "testWrite_recordIf_tensorInput_fromFunction", "method_params": "self", "method_startline": "248", "method_endline": "267"}}, "hunk_36": {"Ismethod": 1, "added_lines": "546", "deleted_lines": null, "method_info": {"method_name": "testClose_closesOpenFile", "method_params": "self", "method_startline": "537", "method_endline": "552"}}, "hunk_37": {"Ismethod": 1, "added_lines": "373,374,375", "deleted_lines": "373,375", "method_info": {"method_name": "testCreate_fromFunction_unpersistedResource_raisesError.f", "method_params": "", "method_startline": "373", "method_endline": "375"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 14, "file_old_name": "tensorflow\\python\\ops\\summary_ops_v2.py", "file_new_name": "tensorflow\\python\\ops\\summary_ops_v2.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "135,136,137", "deleted_lines": "135,136,137", "method_info": {"method_name": "set_as_default", "method_params": "self", "method_startline": "135", "method_endline": "137"}}, "hunk_1": {"Ismethod": 1, "added_lines": "161,162,163,164,166,167,168,169,172,173,174,175", "deleted_lines": "161,162,165,166,167,169,172,173,174,175", "method_info": {"method_name": "__init__", "method_params": "self,shared_name,init_op_fn,name,v2", "method_startline": "161", "method_endline": "175"}}, "hunk_2": {"Ismethod": 1, "added_lines": "135,136,137,138,139,140,141", "deleted_lines": "135,136,137,139", "method_info": {"method_name": "__init__", "method_params": "self,resource,init_op_fn", "method_startline": "135", "method_endline": "141"}}, "hunk_3": {"Ismethod": 1, "added_lines": "179,180", "deleted_lines": "177,178,179,180", "method_info": {"method_name": "_close", "method_params": "self", "method_startline": "177", "method_endline": "180"}}, "hunk_4": {"Ismethod": 1, "added_lines": "449,450,451,452,453,454", "deleted_lines": null, "method_info": {"method_name": "create_noop_writer", "method_params": "", "method_startline": "449", "method_endline": "454"}}, "hunk_5": {"Ismethod": 1, "added_lines": "141,142,143", "deleted_lines": null, "method_info": {"method_name": "as_default", "method_params": "self", "method_startline": "141", "method_endline": "143"}}, "hunk_6": {"Ismethod": 1, "added_lines": "555", "deleted_lines": null, "method_info": {"method_name": "write", "method_params": "tag,tensor,step,metadata,name", "method_startline": "544", "method_endline": "588"}}, "hunk_7": {"Ismethod": 1, "added_lines": "145,146,147", "deleted_lines": null, "method_info": {"method_name": "init", "method_params": "self", "method_startline": "145", "method_endline": "147"}}, "hunk_8": {"Ismethod": 1, "added_lines": "853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874", "deleted_lines": null, "method_info": {"method_name": "_check_create_file_writer_args", "method_params": "inside_function,kwargs", "method_startline": "853", "method_endline": "874"}}, "hunk_9": {"Ismethod": 1, "added_lines": "153,154,155", "deleted_lines": "153,154,155", "method_info": {"method_name": "close", "method_params": "self", "method_startline": "153", "method_endline": "155"}}, "hunk_10": {"Ismethod": 1, "added_lines": "149,150,151", "deleted_lines": "149,150", "method_info": {"method_name": "flush", "method_params": "self", "method_startline": "149", "method_endline": "151"}}, "hunk_11": {"Ismethod": 1, "added_lines": "169", "deleted_lines": "169", "method_info": {"method_name": "_flush", "method_params": "self", "method_startline": "169", "method_endline": "170"}}, "hunk_12": {"Ismethod": 1, "added_lines": "328,329,330,331,332,333,334,335,336,337,338", "deleted_lines": "328,329,330,331,332,333,334,335,336,337,338", "method_info": {"method_name": "_make_summary_writer", "method_params": "name,factory,kwargs", "method_startline": "328", "method_endline": "338"}}, "hunk_13": {"Ismethod": 1, "added_lines": "289,290,291,292,293", "deleted_lines": null, "method_info": {"method_name": "create_file_writer_v2", "method_params": "logdir,max_queue,flush_millis,filename_suffix,name", "method_startline": "289", "method_endline": "293"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\tools\\api\\golden\\v2\\tensorflow.summary.-summary-writer.pbtxt", "file_new_name": "tensorflow\\tools\\api\\golden\\v2\\tensorflow.summary.-summary-writer.pbtxt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "7"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\tools\\api\\golden\\v2\\tensorflow.summary.pbtxt", "file_new_name": "tensorflow\\tools\\api\\golden\\v2\\tensorflow.summary.pbtxt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "15,16,17,18", "deleted_lines": null}}}}}}