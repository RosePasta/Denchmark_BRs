{"BR": {"BR_id": "27705", "BR_author": "perara", "BRopenT": "2019-04-10T07:26:10Z", "BRcloseT": "2019-08-13T21:55:39Z", "BR_text": {"BRsummary": "Keras subclassing and explicit dtype of Input", "BRdescription": "\n System information\n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Arch Linux\n Tensorflow Version: 2.0.0-alpha0\n Description\n When using Keras subclassing there is no apparent way of defining the dtype of the Input node of the network. In some cases, it would be neccecary to use tf.float16 instead of 32 but as of now i cannot find any way to adjust this. Also trying to set the dtype using self.dtype = tf.float16 is not permitted.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "perara", "commentT": "2019-04-11T10:36:20Z", "comment_text": "\n \t\tIn order to expedite the trouble-shooting process, please provide a code snippet to reproduce the issue reported here. Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "perara", "commentT": "2019-04-11T20:29:21Z", "comment_text": "\n \t\tMethod 1:\n <denchmark-code>import tensorflow as tf\n \n \n class SomeClass(tf.keras.Model):\n \n     def __init__(self, dtype):\n         super(SomeClass, self).__init__(dtype=dtype)  # Set Input of dtype either like this\n \n         self.h_1 = tf.keras.layers.Dense(10, dtype=dtype)\n \n     def call(self, inputs):\n         return self.h_1(inputs)\n \n \n if __name__ == \"__main__\":\n \n     model = SomeClass(dtype=tf.float16)\n     model([1, 2, 0])\n </denchmark-code>\n \n Exception:\n <denchmark-code>TypeError: _init_subclassed_network() got an unexpected keyword argument 'dtype'\n </denchmark-code>\n \n Method 2\n <denchmark-code>import tensorflow as tf\n \n \n class SomeClass(tf.keras.Model):\n \n     def __init__(self, dtype):\n         self.dtype = dtype  # Or this?\n \n         self.h_1 = tf.keras.layers.Dense(10, dtype=dtype)\n \n     def call(self, inputs):\n         return self.h_1(inputs)\n \n \n if __name__ == \"__main__\":\n \n     model = SomeClass(dtype=tf.float16)\n     model([1, 2, 0])\n </denchmark-code>\n \n Exception:\n <denchmark-code>AttributeError: can't set attribute\n </denchmark-code>\n \n Use case\n The use case is when you want specifically to use custom dtypes for the whole net, typically when running on TensorCores etc.\n Freetext\n I dont know if this would be the correct way of defining this, but it should be possible (if its not already) to set the dtype of the input excplictly ( i assume there is a tf.cast in there somewhere anyways...)\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "perara", "commentT": "2019-04-25T19:51:12Z", "comment_text": "\n \t\tHi! A workaround you can do now is to directly set the private property _dtype. I'll make a change that adds dtype as one of the allowed keyword arguments super().init.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "perara", "commentT": "2019-07-24T00:09:03Z", "comment_text": "\n \t\tAutomatically closing this out since I understand it to be resolved, but please let me know if I'm mistaken.Thanks!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "perara", "commentT": "2019-07-24T00:15:46Z", "comment_text": "\n \t\tReopening as I find some issues are there still with  . Here is the <denchmark-link:https://colab.sandbox.google.com/gist/jvishnuvardhan/4ee37c87967ef4abfa7c7cb3bed63c0c/tf_27705.ipynb>gist</denchmark-link>\n . Thanks!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "perara", "commentT": "2019-08-09T18:43:36Z", "comment_text": "\n \t\tFor method 2:\n dtype is a property therefore we see error\n The error message is fixed with latest tf-nightly 2.0 build version '2.0.0-dev20190809'\n AttributeError: Can't set the attribute \"dtype\", likely because it conflicts with an existing read-only @property of the object. Please choose a different name..\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "perara", "commentT": "2019-08-13T21:55:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jvishnuvardhan>@jvishnuvardhan</denchmark-link>\n  Use method 1.\n <denchmark-code>ValueError: Layer dense expects 1 inputs, but it received 3 input tensors. Inputs received: [<tf.Tensor: id=1, shape=(), dtype=int32, numpy=1>, <tf.Tensor: id=2, shape=(), dtype=int32, numpy=2>, <tf.Tensor: id=3, shape=(), dtype=int32, numpy=0>]\n </denchmark-code>\n \n The above error is appearing because [1, 2, 0] is being converted into separate tensors. Using tf.constant to convert the entire array into a tensor (try model(tf.constant([[1, 2, 0]]))).\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "perara", "commentT": "2019-08-13T21:55:40Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=27705>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=27705>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "1b96e5212002b7ac5027a7538a8f6e5780b669f5", "commit_author": "Katherine Wu", "commitT": "2019-04-30 19:30:39-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\keras\\engine\\base_layer.py", "file_new_name": "tensorflow\\python\\keras\\engine\\base_layer.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "154", "deleted_lines": "154,155,156"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tensorflow\\python\\keras\\engine\\network.py", "file_new_name": "tensorflow\\python\\keras\\engine\\network.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "251,252,253,254,255,271", "deleted_lines": "233,249,260", "method_info": {"method_name": "_init_graph_network", "method_params": "self,inputs,outputs,name", "method_startline": "233", "method_endline": "328"}}, "hunk_1": {"Ismethod": 1, "added_lines": "181,189,190,196,197,198,199,202,231", "deleted_lines": "182,213,233", "method_info": {"method_name": "_base_init", "method_params": "self,name,kwargs", "method_startline": "181", "method_endline": "248"}}, "hunk_2": {"Ismethod": 1, "added_lines": "181,189,190,196,197,198,199,202", "deleted_lines": "169,182,213", "method_info": {"method_name": "_base_init", "method_params": "self,name", "method_startline": "169", "method_endline": "230"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "350,351,353", "method_info": {"method_name": "_init_subclassed_network", "method_params": "self,name,dynamic", "method_startline": "350", "method_endline": "362"}}, "hunk_4": {"Ismethod": 1, "added_lines": "371,372", "deleted_lines": null, "method_info": {"method_name": "_init_subclassed_network", "method_params": "self,name,kwargs", "method_startline": "371", "method_endline": "382"}}, "hunk_5": {"Ismethod": 1, "added_lines": "251,252,253,254,255,271", "deleted_lines": "260", "method_info": {"method_name": "_init_graph_network", "method_params": "self,inputs,outputs,name,kwargs", "method_startline": "251", "method_endline": "349"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\engine\\network_test.py", "file_new_name": "tensorflow\\python\\keras\\engine\\network_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969", "deleted_lines": null, "method_info": {"method_name": "test_model_initialization", "method_params": "self", "method_startline": "945", "method_endline": "969"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\utils\\generic_utils.py", "file_new_name": "tensorflow\\python\\keras\\utils\\generic_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "595,596", "deleted_lines": null, "method_info": {"method_name": "validate_kwargs", "method_params": "kwargs,allowed_kwargs,error_message", "method_startline": "595", "method_endline": "596"}}}}}}}