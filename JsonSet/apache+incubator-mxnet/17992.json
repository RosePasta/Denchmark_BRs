{"BR": {"BR_id": "17992", "BR_author": "leezu", "BRopenT": "2020-04-07T17:36:10Z", "BRcloseT": "2020-04-08T18:28:35Z", "BR_text": {"BRsummary": "MKLDNNConvolutionBackward accesses out of bound elements", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n CI with updated toolchain (ie <denchmark-link:https://github.com/apache/incubator-mxnet/pull/17984>#17984</denchmark-link>\n ) catches the bug.\n vector: :_M_range_check: __n (which is 2) >= this->size() (which is 2)\n <denchmark-h:h3>Error Message</denchmark-h>\n \n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n Build with this simple patch\n diff --git a/src/operator/nn/mkldnn/mkldnn_convolution.cc b/src/operator/nn/mkldnn/mkldnn_convolution.cc\n index ada42a22c..95b44fd92 100644\n --- a/src/operator/nn/mkldnn/mkldnn_convolution.cc\n +++ b/src/operator/nn/mkldnn/mkldnn_convolution.cc\n @@ -480,7 +480,7 @@ void MKLDNNConvolutionBackward(const nnvm::NodeAttrs& attrs, const OpContext &ct\n                                             {MKLDNN_ARG_DIFF_SRC, *in_grad_mem.second}});\n      CommitOutput(in_grad[conv::kData], in_grad_mem);\n    }\n -  if (req[conv::kWeight] || req[conv::kBias]) {\n +  if (req.at(conv::kWeight) || req.at(conv::kBias)) {\n      if (convBwd.GetDataPd().diff_dst_desc() != convBwd.GetWeightsPd().diff_dst_desc())\n        out_grad_mem = out_grad.GetMKLDNNDataReorder(convBwd.GetWeightsPd().diff_dst_desc());\n      auto data_mem = data.GetMKLDNNDataReorder(convBwd.GetWeightsPd().src_desc());\n \n OR follow the instructions in <denchmark-link:https://github.com/apache/incubator-mxnet/issues/17987>#17987</denchmark-link>\n  to trigger this via glibc assertions in debug build.\n Run test_operator.test_convolution_independent_gradients to trigger the bug.\n cc <denchmark-link:https://github.com/TaoLv>@TaoLv</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leezu", "commentT": "2020-04-07T17:38:10Z", "comment_text": "\n \t\tNotice that there are also other issues with this test\n <denchmark-link:https://github.com/apache/incubator-mxnet/pull/15631>#15631</denchmark-link>\n \n <denchmark-link:https://github.com/apache/incubator-mxnet/issues/15638>#15638</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "leezu", "commentT": "2020-04-08T15:02:50Z", "comment_text": "\n \t\tI doubt whether <denchmark-link:https://github.com/apache/incubator-mxnet/issues/15638>#15638</denchmark-link>\n  is related. It seems it's a correctness issue.\n \t\t"}}}, "commit": {"commit_id": "da95add57bee137422ec838a7016ee986a880982", "commit_author": "Tao Lv", "commitT": "2020-04-08 18:28:33+00:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "483,484,485,486", "deleted_lines": "483", "method_info": {"method_name": "mxnet::op::MKLDNNConvolutionBackward", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "453", "method_endline": "511"}}}}}}}