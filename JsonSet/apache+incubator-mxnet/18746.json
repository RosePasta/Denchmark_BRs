{"BR": {"BR_id": "18746", "BR_author": "leezu", "BRopenT": "2020-07-17T21:29:47Z", "BRcloseT": "2020-08-01T00:06:22Z", "BR_text": {"BRsummary": "Numpy Op fallback does not work for functions without return value", "BRdescription": "\n \n \n \n incubator-mxnet/python/mxnet/numpy/multiarray.py\n \n \n         Lines 332 to 365\n       in\n       cec86ad\n \n \n \n \n \n \n  @staticmethod \n \n \n \n  def __array_function__(self, func, types, args, kwargs):  # pylint: disable=bad-staticmethod-argument \n \n \n \n  \"\"\" \n \n \n \n          Dispatch official NumPy operators that comply with the array function protocol to \n \n \n \n          this function. \n \n \n \n          \"\"\" \n \n \n \n  mx_np_func = _NUMPY_ARRAY_FUNCTION_DICT.get(func, None) \n \n \n \n  func_name = func.__name__ \n \n \n \n  if mx_np_func is None: \n \n \n \n  # try to fallback to official NumPy op \n \n \n \n  if is_recording(): \n \n \n \n  raise ValueError(\"Falling back to NumPy operator {} with autograd active is not supported.\" \n \n \n \n  \"Please consider moving the operator to the outside of the autograd scope.\")\\ \n \n \n \n                                   .format(func) \n \n \n \n  new_args, cur_ctx = _as_onp_array(args) \n \n \n \n  if cur_ctx is None: \n \n \n \n  raise ValueError('Unknown context for the input ndarrays. It is probably a bug. Please' \n \n \n \n  ' create an issue on GitHub.') \n \n \n \n  new_kwargs = {} \n \n \n \n  for k, v in kwargs.items(): \n \n \n \n  new_kwargs[k] = v.asnumpy() if isinstance(v, ndarray) else v \n \n \n \n  if func not in _FALLBACK_ARRAY_FUNCTION_WARNED_RECORD: \n \n \n \n  import logging \n \n \n \n  logging.warning(\"np.%s is a fallback operator, \" \n \n \n \n  \"which is actually using official numpy's implementation.\", func_name) \n \n \n \n  _FALLBACK_ARRAY_FUNCTION_WARNED_RECORD[func] = True \n \n \n \n  out = func(*new_args, **new_kwargs) \n \n \n \n  return _as_mx_np_array(out, ctx=cur_ctx) \n \n \n \n  else: \n \n \n \n  # Note: this allows subclasses that don't override \n \n \n \n  # __array_function__ to handle mxnet.numpy.ndarray objects \n \n \n \n  if not py_all(issubclass(t, ndarray) for t in types): \n \n \n \n  return NotImplemented \n \n \n \n  return mx_np_func(*args, **kwargs) \n \n \n \n \n \n Will fail in line 359 if out is None.\n Example function is np.save.\n \t"}, "comments": {}}, "commit": {"commit_id": "5a22193b5588848a2c0879ea17b4d7a0bcfdddc7", "commit_author": "Sheng Zha", "commitT": "2020-07-31 17:06:17-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "python\\mxnet\\numpy\\multiarray.py", "file_new_name": "python\\mxnet\\numpy\\multiarray.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "183,184,185,188,189,194,195,196", "deleted_lines": "183,184,185,188,189,192,193,194", "method_info": {"method_name": "_as_mx_np_array", "method_params": "object,ctx,zero_copy", "method_startline": "183", "method_endline": "198"}}, "hunk_1": {"Ismethod": 1, "added_lines": "183,184,185,188,189,194,195,196", "deleted_lines": "183,184,185,188,189,192,193,194", "method_info": {"method_name": "_as_mx_np_array", "method_params": "object,ctx", "method_startline": "183", "method_endline": "198"}}, "hunk_2": {"Ismethod": 1, "added_lines": "395,396,397,398,399,400,401,402,403,404,405", "deleted_lines": "395,396,397,398,399", "method_info": {"method_name": "__array_function__", "method_params": "self,func,types,args,kwargs", "method_startline": "367", "method_endline": "405"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\python\\unittest\\test_numpy_ndarray.py", "file_new_name": "tests\\python\\unittest\\test_numpy_ndarray.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1405,1406,1407,1408", "deleted_lines": null, "method_info": {"method_name": "test_mixed_array_types", "method_params": "", "method_startline": "1405", "method_endline": "1408"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1410,1411,1412,1413,1414,1415,1416,1417,1418,1419,1420,1421,1422,1423", "deleted_lines": null, "method_info": {"method_name": "test_mixed_array_types_share_memory", "method_params": "", "method_startline": "1410", "method_endline": "1423"}}}}}}}