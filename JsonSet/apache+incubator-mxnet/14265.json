{"BR": {"BR_id": "14265", "BR_author": "satyakrishnagorti", "BRopenT": "2019-02-27T20:45:04Z", "BRcloseT": "2019-03-07T18:13:32Z", "BR_text": {"BRsummary": "Bug in Optimizer's serializeState and deserializeState methods (Scala)", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n Currently there is a bug in the way Optimizer is trying to serialize state which fails when trying to deserialize Optimizer that has no states (like SGD without momentum).\n <denchmark-h:h2>Issue</denchmark-h>\n \n Currently the way serialize is being done is as below: (pasting Optimizer.serailizeState())\n   override def serializeState(): Array[Byte] = {\n         val bos = new ByteArrayOutputStream()\n         try {\n           val out = new ObjectOutputStream(bos)\n           out.writeInt(states.size)\n           states.foreach { case (k, v) =>\n             if (v != null) {\n               out.writeInt(k)\n               val stateBytes = optimizer.serializeState(v)\n               if (stateBytes == null) {\n                 out.writeInt(0)\n               } else {\n                 out.writeInt(stateBytes.length)\n                 out.write(stateBytes)\n               }\n             }\n           }\n           out.flush()\n           bos.toByteArray\n         } finally {\n          ...\n       }\n   }\n When an Optimizer without states like SGD with momentum set as 0 is being used. The states map (Map[Int, AnyRef]) contains a (key, value) pair as (some integer index, null).\n The above serialize method does not write k as the value of key and 0 as the value of stateBytes, due to the null check if (v != null)\n Now while deserializing: (Pasting code from Optimizer.deserializeState())\n   override def deserializeState(bytes: Array[Byte]): Unit = {\n         val bis = new ByteArrayInputStream(bytes)\n         var in: ObjectInputStream = null\n         try {\n           in = new ObjectInputStream(bis)\n           val size = in.readInt()\n           (0 until size).foreach(_ => {\n             val key = in.readInt()\n             val bytesLength = in.readInt()\n             val value =\n               if (bytesLength > 0) {\n                 val bytes = Array.fill[Byte](bytesLength)(0)\n                 in.readFully(bytes)\n                 optimizer.deserializeState(bytes)\n               } else {\n                 null\n               }\n             states.update(key, value)\n           })\n         } finally {\n           ...\n       }\n   }\n In the foreach loop, the key is being read (which wasn't serialized previously) hence, this would cause an java.io.EOFException.\n <denchmark-h:h2>Solution.</denchmark-h>\n \n Get rid of if (v != null) check and retain the rest.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "satyakrishnagorti", "commentT": "2019-02-27T20:45:08Z", "comment_text": "\n \t\tHey, this is the MXNet Label Bot.\n Thank you for submitting the issue! I will try and suggest some labels so that the appropriate MXNet community members can help resolve it.\n Here are my recommended labels: Scala, Bug\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "satyakrishnagorti", "commentT": "2019-02-28T00:27:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-label-bot>@mxnet-label-bot</denchmark-link>\n  add [Scala, Bug]\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "satyakrishnagorti", "commentT": "2019-03-01T19:42:17Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/satyakrishnagorti>@satyakrishnagorti</denchmark-link>\n , it sounds like you have looked at this and know what to change. If you are interested, you are also more than welcome to open a pull request and contribute the fixes yourself. Let me know if you need any help\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "satyakrishnagorti", "commentT": "2019-03-01T21:02:36Z", "comment_text": "\n \t\tYeah, I will send a PR soon.\n \t\t"}}}, "commit": {"commit_id": "12c41e6580da4dc41788a9bd3bed73e9dbb7e3db", "commit_author": "Satya Krishna Gorti", "commitT": "2019-03-07 10:13:31-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CONTRIBUTORS.md", "file_new_name": "CONTRIBUTORS.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "218", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "scala-package\\core\\src\\main\\scala\\org\\apache\\mxnet\\Optimizer.scala", "file_new_name": "scala-package\\core\\src\\main\\scala\\org\\apache\\mxnet\\Optimizer.scala", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "55,56,57,58,59,60,61", "deleted_lines": "55,56,57,58,59,60,61,62,63", "method_info": {"method_name": "serializeState", "method_params": "", "method_startline": "49", "method_endline": "75"}}, "hunk_1": {"Ismethod": 1, "added_lines": "55,56,57,58,59,60,61", "deleted_lines": "55,56,57,58,59,60,61,62,63", "method_info": {"method_name": "getUpdater", "method_params": "Optimizer", "method_startline": "28", "method_endline": "106"}}}}}}}