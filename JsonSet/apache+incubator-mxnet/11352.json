{"BR": {"BR_id": "11352", "BR_author": "anbrjohn", "BRopenT": "2018-06-21T11:46:35Z", "BRcloseT": "2018-06-26T18:46:20Z", "BR_text": {"BRsummary": "CRF weights never updated in Bi-LSTM-CRF", "BRdescription": "\n When using incubator-mxnet/example/gluon/lstm_crf.py, CRF transition matrix weights are never updated during training, defeating the purpose of the CRF layer. Printing model.transitions.data() each epoch confirmed this.\n Compare these lines of MXNet <denchmark-link:https://github.com/apache/incubator-mxnet/blob/master/example/gluon/lstm_crf.py>version</denchmark-link>\n  and the PyTorch <denchmark-link:https://pytorch.org/tutorials/beginner/nlp/advanced_tutorial.html>reference</denchmark-link>\n :\n <denchmark-code>self.transitions = nd.random.normal(shape=(self.tagset_size, self.tagset_size)) # MXNet\n self.transitions = nn.Parameter(torch.randn(self.tagset_size, self.tagset_size)) # PyTorch\n </denchmark-code>\n \n I was able to solve this issue by changing the above line to:\n <denchmark-code>self.transitions = gluon.Parameter(\"crf_transition_matrix\", \n     shape=(self.tagset_size, self.tagset_size))\n </denchmark-code>\n \n Making this change required adding .data() to all other references to self.transitions in the code, eg:\n <denchmark-code>self.transitions[next_tag].reshape((1, -1) # Before\n self.transitions.data()[next_tag].reshape((1, -1) # After\n </denchmark-code>\n \n and manually updating the parameter dictionary outside of the class before model initialization:\n <denchmark-code>model.params.update({'crf_transition_matrix':model.transitions}) # Added this line\n model.initialize(mx.init.Xavier(magnitude=2.24), ctx=mx.cpu())\n optimizer = gluon.Trainer(model.collect_params(), 'sgd', {'learning_rate': 0.01, 'wd': 1e-4})\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "anbrjohn", "commentT": "2018-06-21T16:51:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/anbrjohn>@anbrjohn</denchmark-link>\n  thanks for reporting. Would you send a patch to fix the example?\n \t\t"}}}, "commit": {"commit_id": "4db5a83abb79296e5a40a29b3ac6db8e21226b3b", "commit_author": "anbrjohn", "commitT": "2018-06-26 11:46:19-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "example\\gluon\\lstm_crf.py", "file_new_name": "example\\gluon\\lstm_crf.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "138,148", "deleted_lines": "137,147", "method_info": {"method_name": "_viterbi_decode", "method_params": "self,feats", "method_startline": "121", "method_endline": "161"}}, "hunk_1": {"Ismethod": 1, "added_lines": "65,66,67", "deleted_lines": "65,66", "method_info": {"method_name": "__init__", "method_params": "self,vocab_size,tag2idx,embedding_dim,hidden_dim", "method_startline": "48", "method_endline": "68"}}, "hunk_2": {"Ismethod": 1, "added_lines": "89,97", "deleted_lines": "88,96", "method_info": {"method_name": "_forward_alg", "method_params": "self,feats", "method_startline": "74", "method_endline": "99"}}, "hunk_3": {"Ismethod": 1, "added_lines": "116,117", "deleted_lines": "115,116", "method_info": {"method_name": "_score_sentence", "method_params": "self,feats,tags", "method_startline": "110", "method_endline": "119"}}}}}}}