{"BR": {"BR_id": "738", "BR_author": "ehsanmok", "BRopenT": "2020-04-02T18:46:16Z", "BRcloseT": "2020-04-03T18:25:02Z", "BR_text": {"BRsummary": "Multiprocessing broken code", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n The very recently added <denchmark-link:https://github.com/awslabs/gluon-ts/pull/689>parallelized_loaded</denchmark-link>\n  breaks my already working code in SageMaker\n def evaluate(\n     model: Predictor, test_data: ListDataset, num_samples: int = 10\n ) -> Tuple[List[Forecast], List[pd.Series], Dict[str, float], pd.DataFrame]:\n     forecast_it, ts_it = make_evaluation_predictions(\n         dataset=test_data, predictor=model, num_samples=num_samples\n     )\n     forecasts = list(forecast_it)\n     tss = list(ts_it)\n     evaluator = MultivariateEvaluator()\n     agg_metrics, item_metrics = evaluator(\n         iter(tss), iter(forecasts), num_series=len(test_data)\n     )\n     return forecasts, tss, agg_metrics, item_metrics\n <denchmark-h:h2>Error message or code output</denchmark-h>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"/usr/local/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/usr/local/lib/python3.6/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/opt/ml/code/train.py\", line 137, in <module>\n     forecasts, tss, agg_metrics, item_metrics = evaluate(predictor, dataset.test)\n   File \"/opt/ml/code/utils.py\", line 30, in evaluate\n     forecasts = list(forecast_it)\n   File \"/usr/local/lib/python3.6/site-packages/gluonts/model/predictor.py\", line 317, in predict\n     num_samples=num_samples,\n   File \"/usr/local/lib/python3.6/site-packages/gluonts/model/forecast_generator.py\", line 195, in __call__\n     for batch in inference_data_loader:\n   File \"/usr/local/lib/python3.6/site-packages/gluonts/dataset/loader.py\", line 101, in __iter__\n     yield from self.parallel_data_loader\n   File \"/usr/local/lib/python3.6/site-packages/gluonts/dataset/parallelized_loader.py\", line 572, in same_process_iter\n     for k, v in batch.items()\n   File \"/usr/local/lib/python3.6/site-packages/gluonts/dataset/parallelized_loader.py\", line 572, in <dictcomp>\n     for k, v in batch.items()\n   File \"/usr/local/lib/python3.6/site-packages/mxnet/ndarray/ndarray.py\", line 2765, in as_in_context\n     return self.copyto(context)\n   File \"/usr/local/lib/python3.6/site-packages/mxnet/ndarray/ndarray.py\", line 2632, in copyto\n     return _internal._copyto(self, out=hret)\n   File \"<string>\", line 27, in _copyto\n   File \"/usr/local/lib/python3.6/site-packages/mxnet/_ctypes/ndarray.py\", line 107, in _imperative_invoke\n     ctypes.byref(out_stypes)))\n   File \"/usr/local/lib/python3.6/site-packages/mxnet/base.py\", line 255, in check_call\n     raise MXNetError(py_str(_LIB.MXGetLastError()))\n mxnet.base.MXNetError: [18:26:25] src/imperative/./imperative_utils.h:146: Operator _copyto inferring shapes failed.\n input shapes:\n [1,321,-1]\n output shapes:\n [1,321,-1]\n operator attributes:\n \n Stack trace:\n   [bt] (0) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x6dfb0b) [0x7f99a9e28b0b]\n   [bt] (1) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(mxnet::imperative::SetShapeType(mxnet::Context const&, nnvm::NodeAttrs const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&, mxnet::DispatchMode*)+0x363b) [0x7f99ad0da57b]\n   [bt] (2) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(mxnet::Imperative::Invoke(mxnet::Context const&, nnvm::NodeAttrs const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&, std::vector<mxnet::NDArray*, std::allocator<mxnet::NDArray*> > const&)+0x1db) [0x7f99ad0e24bb]\n   [bt] (3) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x3847f3f) [0x7f99acf90f3f]\n   [bt] (4) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(MXImperativeInvokeEx+0x62) [0x7f99acf91502]\n   [bt] (5) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call_unix64+0x4c) [0x7f9a01ccf4e6]\n   [bt] (6) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call+0x3f1) [0x7f9a01cce241]\n   [bt] (7) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(_ctypes_callproc+0x2cf) [0x7f9a01cc58ff]\n [2020-04-02 18:26:25.315 ip-10-0-168-31.us-west-2.compute.internal:213 INFO utils.py:25] The end of training job file will not be written for jobs running under SageMaker.\n   [bt] (8) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(+0x9829) [0x7f9a01cbc829]\n </denchmark-code>\n \n <denchmark-h:h2>Environment</denchmark-h>\n \n \n Operating system: Amazon linux (amzn1.x86_64 SMP Thu Feb 27 23:49:15 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux)\n Python version: 3.6\n GluonTS version: master\n MXNet: 1.6.0\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ehsanmok", "commentT": "2020-04-02T21:44:04Z", "comment_text": "\n \t\tHi, thanks for the bug report!\n Cold you maybe provide a minimal working example that reproduces the error?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ehsanmok", "commentT": "2020-04-03T14:10:00Z", "comment_text": "\n \t\tHi, I looked into it, and while I was not able so far to recreate the problem, I think I might have found a solution nonetheless.\n Could you please confirm whether the problem was fixed by trying out this version:\n !pip install git+https://github.com/AaronSpieler/gluon-ts.git@mp_data_loader_updates\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ehsanmok", "commentT": "2020-04-03T16:58:51Z", "comment_text": "\n \t\tThanks, <denchmark-link:https://github.com/AaronSpieler>@AaronSpieler</denchmark-link>\n \n I had same problem.\n \n GluonTS version:0.4.3\n MXNet: 1.6.0\n \n But your version works well on my env.\n !pip install git+https://github.com/AaronSpieler/gluon-ts.git@mp_data_loader_updates\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ehsanmok", "commentT": "2020-04-03T18:12:50Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/AaronSpieler>@AaronSpieler</denchmark-link>\n , thanks for the fix! It works for me now.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ehsanmok", "commentT": "2020-04-03T18:15:38Z", "comment_text": "\n \t\tThx for the quick feedback and bug report <denchmark-link:https://github.com/ehsanmok>@ehsanmok</denchmark-link>\n  , and thank you too <denchmark-link:https://github.com/AtsunoriFujita>@AtsunoriFujita</denchmark-link>\n  !\n \t\t"}}}, "commit": {"commit_id": "a822353785cb03147e717a2575aeb0ae6509e952", "commit_author": "Aaron Spieler", "commitT": "2020-04-03 20:25:01+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\gluonts\\dataset\\loader.py", "file_new_name": "src\\gluonts\\dataset\\loader.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "222,223,224,225,226,227,228,229,230,231"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 14, "file_old_name": "src\\gluonts\\dataset\\parallelized_loader.py", "file_new_name": "src\\gluonts\\dataset\\parallelized_loader.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "193", "deleted_lines": null, "method_info": {"method_name": "_worker_initializer", "method_params": "Dataset,Transformation,int,Queue", "method_startline": "190", "method_endline": "194"}}, "hunk_1": {"Ismethod": 1, "added_lines": "417,418,419,420,421,422,423", "deleted_lines": "414", "method_info": {"method_name": "__del__", "method_params": "self", "method_startline": "414", "method_endline": "423"}}, "hunk_2": {"Ismethod": 1, "added_lines": "392,393,394", "deleted_lines": "380,381,382,383,384,385,386,387,388,389", "method_info": {"method_name": "__next__", "method_params": "self", "method_startline": "357", "method_endline": "405"}}, "hunk_3": {"Ismethod": 1, "added_lines": "137,138,139,140,141,142", "deleted_lines": "136,137,138,139,140,141,142", "method_info": {"method_name": "_as_in_context", "method_params": "data,ctx", "method_startline": "136", "method_endline": "142"}}, "hunk_4": {"Ismethod": 1, "added_lines": "137,138,139,140,141", "deleted_lines": "137,138,139,140,141", "method_info": {"method_name": "default_batchify_fn", "method_params": "DType,bool,None", "method_startline": "137", "method_endline": "141"}}, "hunk_5": {"Ismethod": 1, "added_lines": "156,157,158,159", "deleted_lines": "155,156,158", "method_info": {"method_name": "_worker_initializer", "method_params": "Dataset,int,int,Transformation,bool,Queue", "method_startline": "153", "method_endline": "159"}}, "hunk_6": {"Ismethod": 1, "added_lines": "86,87,88,89,90", "deleted_lines": null, "method_info": {"method_name": "stack", "method_params": "data,bool,DType,None", "method_startline": "86", "method_endline": "90"}}, "hunk_7": {"Ismethod": 1, "added_lines": "156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171", "deleted_lines": "156,158,163,164,165,166,167,168,169,170,171", "method_info": {"method_name": "_as_in_context", "method_params": "dict,Context", "method_startline": "156", "method_endline": "171"}}, "hunk_8": {"Ismethod": 1, "added_lines": "193", "deleted_lines": "188", "method_info": {"method_name": "sequential_sample_generator", "method_params": "dataset,transformation,is_train,cyclic", "method_startline": "188", "method_endline": "194"}}, "hunk_9": {"Ismethod": 1, "added_lines": "211", "deleted_lines": "211,212,214,215,216", "method_info": {"method_name": "_sequential_sample_generator", "method_params": "dataset,transformation,is_train,cyclic", "method_startline": "211", "method_endline": "217"}}, "hunk_10": {"Ismethod": 1, "added_lines": "123,125,126,127,128", "deleted_lines": "123,129", "method_info": {"method_name": "default_batchify_fn", "method_params": "data,dtype,parallel_processing", "method_startline": "123", "method_endline": "133"}}, "hunk_11": {"Ismethod": 1, "added_lines": "86,87,88,89,90,91,97,110,111,112,113,118", "deleted_lines": "85,91,104,109,111,113", "method_info": {"method_name": "stack", "method_params": "data,parallel_processing,dtype", "method_startline": "85", "method_endline": "119"}}, "hunk_12": {"Ismethod": 1, "added_lines": "568,570", "deleted_lines": "561,565,566,567,568,569,570,571,572,573", "method_info": {"method_name": "__iter__.same_process_iter", "method_params": "", "method_startline": "554", "method_endline": "573"}}, "hunk_13": {"Ismethod": 1, "added_lines": "550,568,570", "deleted_lines": "561,565,566,567,568,569,570,571,572,573", "method_info": {"method_name": "__iter__", "method_params": "self", "method_startline": "547", "method_endline": "601"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\gluonts\\dataset\\util.py", "file_new_name": "src\\gluonts\\dataset\\util.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "47,48", "deleted_lines": "47,48", "method_info": {"method_name": "set_worker_info", "method_params": "cls,int,int", "method_startline": "47", "method_endline": "48"}}, "hunk_1": {"Ismethod": 1, "added_lines": "45,46", "deleted_lines": null, "method_info": {"method_name": "set_worker_info", "method_params": "cls,int,int,bool", "method_startline": "45", "method_endline": "46"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "test\\dataset\\test_multiprocessing_loader.py", "file_new_name": "test\\dataset\\test_multiprocessing_loader.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243", "deleted_lines": "231", "method_info": {"method_name": "test_inference_loader_equivalence", "method_params": "", "method_startline": "188", "method_endline": "243"}}}}}}}