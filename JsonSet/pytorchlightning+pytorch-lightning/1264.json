{"BR": {"BR_id": "1264", "BR_author": "leemengtaiwan", "BRopenT": "2020-03-27T14:14:42Z", "BRcloseT": "2020-03-30T22:37:03Z", "BR_text": {"BRsummary": "Multiple undesired checkpoints created during single epoch", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n Thanks for the great project! When I sent custom ModelCheckpoint to Trainer and hoping to get one checkpoint each epoch, the Trainer eventually produced a lot of versioned checkpoints within a single epoch, wasting lots of disk space and were causing confusion. An example is shown as below:\n <denchmark-code>checkpoints/\n \u2514\u2500\u2500 gan\n     \u251c\u2500\u2500 _ckpt_epoch_0.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v0.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v10.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v11.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v12.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v13.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v14.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v15.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v16.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v17.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v18.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v19.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v1.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v20.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v21.ckpt\n </denchmark-code>\n \n The minimal code I used for training (below I have showed how to reproduce this exactly):\n checkpoint_callback = ModelCheckpoint(\n         filepath=os.path.join(\n             \"gan\",\n             experiment_name\n         ),\n         save_top_k=-1,\n         period=10\n     )\n     \n     trainer = Trainer(\n         checkpoint_callback=checkpoint_callback,\n \t\t...\n     )\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior:\n \n Clone the repo\n \n git clone https://github.com/leemengtaiwan/learnable_ai.git\n git checkout 66b4cc9db5d1b9f1e2cf6c190d1172cdf6adbe92\n \n Run the script to train a GAN with MNIST\n \n cd learnable_ai/\n python applications/image_generation/train_gan.py\\\n     --dataset mnist\\\n     --latent_dim 128\\\n     --dim 32\\\n     --channels 1\\\n     --batch_size 256 \\\n     --max_epochs 3\n \n See the generated check points under checkpoints:\n \n tree checkpoints/\n \n There should be multiple checkpoints within a single epoch\n \n checkpoints/\n \u2514\u2500\u2500 gan\n     \u251c\u2500\u2500 _ckpt_epoch_0.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v0.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v10.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v11.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v12.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v13.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v14.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v15.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v16.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v17.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v18.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v19.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v1.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v20.ckpt\n     \u251c\u2500\u2500 _ckpt_epoch_0_v21.ckpt\n ...\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n One checkpoint for each epoch when using custom ModelCheckpoint for pl.LightningModule which don't simply use val_loss for evaulation metric (thus the default checkpoint functionality on Trainer will not work)\n <denchmark-h:h3>Environment</denchmark-h>\n \n <denchmark-code>cuda:\n         GPU:\n                 Tesla V100-SXM2-16GB\n         available:           True\n         version:             10.1\n packages:\n         numpy:               1.18.1\n         pyTorch_debug:       False\n         pyTorch_version:     1.4.0\n         pytorch-lightning:   0.7.1\n         tensorboard:         2.2.0\n         tqdm:                4.43.0\n system:\n         OS:                  Linux\n         architecture:\n                 64bit\n                 ELF\n         processor:           x86_64\n         python:              3.6.10\n         version:             #1 SMP Tue Dec 24 03:25:32 UTC 2019\n </denchmark-code>\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n \n Related Slack discussion\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leemengtaiwan", "commentT": "2020-03-27T14:26:25Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "leemengtaiwan", "commentT": "2020-03-28T00:08:49Z", "comment_text": "\n \t\tit seems that it triggered with step interval instead of epoch interval, continue debug\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "leemengtaiwan", "commentT": "2020-03-28T18:24:26Z", "comment_text": "\n \t\tthe issue with checkpoint is that it just specifies the interval of being called assuming ha it is called just once per epoch... but in your case, you turned to fast run mode and the checkpoint is called every batch so the period is correct just it every 10 steps instead of every 10 epochs...\n I am going to change the checkpointing to cunt epochs explicitly...\n \t\t"}}}, "commit": {"commit_id": "09167efdb59e1be8ffe9ff7010393bff084390be", "commit_author": "Jirka Borovec", "commitT": "2020-03-30 18:37:02-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pl_examples\\multi_node_examples\\multi_node_ddp_demo.py", "file_new_name": "pl_examples\\multi_node_examples\\multi_node_ddp_demo.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "19", "deleted_lines": "19,20,21,22,23", "method_info": {"method_name": "main", "method_params": "hparams", "method_startline": "18", "method_endline": "37"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\callbacks\\base.py", "file_new_name": "pytorch_lightning\\callbacks\\base.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "3", "deleted_lines": "3"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "file_new_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212", "deleted_lines": "184,185,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212", "method_info": {"method_name": "on_validation_end", "method_params": "self,trainer,pl_module", "method_startline": "176", "method_endline": "212"}}, "hunk_1": {"Ismethod": 1, "added_lines": "142,143,144,145,146,147,148,149,150,151,152,153,154,155", "deleted_lines": "142,143,144,145,146,147,148,149,150,151,152,153,154,155,156", "method_info": {"method_name": "format_checkpoint_name", "method_params": "self,epoch,metrics,ver", "method_startline": "139", "method_endline": "174"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 11, "file_old_name": "pytorch_lightning\\profiler\\profiler.py", "file_new_name": "pytorch_lightning\\profiler\\profiler.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "24", "deleted_lines": "24", "method_info": {"method_name": "stop", "method_params": "self,action_name", "method_startline": "24", "method_endline": "25"}}, "hunk_1": {"Ismethod": 1, "added_lines": "46", "deleted_lines": "46", "method_info": {"method_name": "profile_iterable", "method_params": "self,iterable,str", "method_startline": "46", "method_endline": "56"}}, "hunk_2": {"Ismethod": 1, "added_lines": "129,131,132,133,134,135,136", "deleted_lines": "129,131,132,133,134,135", "method_info": {"method_name": "__init__", "method_params": "self,output_filename,line_count_restriction", "method_startline": "129", "method_endline": "139"}}, "hunk_3": {"Ismethod": 1, "added_lines": "20", "deleted_lines": "20", "method_info": {"method_name": "start", "method_params": "self,action_name", "method_startline": "20", "method_endline": "21"}}, "hunk_4": {"Ismethod": 1, "added_lines": "24", "deleted_lines": "24", "method_info": {"method_name": "stop", "method_params": "self,str", "method_startline": "24", "method_endline": "25"}}, "hunk_5": {"Ismethod": 1, "added_lines": "58", "deleted_lines": "58", "method_info": {"method_name": "describe", "method_params": "self", "method_startline": "58", "method_endline": "60"}}, "hunk_6": {"Ismethod": 1, "added_lines": "129,131,132,133,134,135,136", "deleted_lines": "129,131,132,133,134,135", "method_info": {"method_name": "__init__", "method_params": "self,str,float", "method_startline": "129", "method_endline": "140"}}, "hunk_7": {"Ismethod": 1, "added_lines": "28", "deleted_lines": "28", "method_info": {"method_name": "profile", "method_params": "self,action_name", "method_startline": "28", "method_endline": "44"}}, "hunk_8": {"Ismethod": 1, "added_lines": "20", "deleted_lines": "20", "method_info": {"method_name": "start", "method_params": "self,str", "method_startline": "20", "method_endline": "21"}}, "hunk_9": {"Ismethod": 1, "added_lines": "46", "deleted_lines": "46", "method_info": {"method_name": "profile_iterable", "method_params": "self,iterable,action_name", "method_startline": "46", "method_endline": "56"}}, "hunk_10": {"Ismethod": 1, "added_lines": "28", "deleted_lines": "28", "method_info": {"method_name": "profile", "method_params": "self,str", "method_startline": "28", "method_endline": "44"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\distrib_data_parallel.py", "file_new_name": "pytorch_lightning\\trainer\\distrib_data_parallel.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "202,203,204", "deleted_lines": "202,203,204,205", "method_info": {"method_name": "set_distributed_mode", "method_params": "self,distributed_backend,num_gpu_nodes", "method_startline": "173", "method_endline": "217"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\trainer\\distrib_parts.py", "file_new_name": "pytorch_lightning\\trainer\\distrib_parts.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "584,585,586,587", "deleted_lines": "587,588", "method_info": {"method_name": "sanitize_gpu_ids", "method_params": "gpus", "method_startline": "574", "method_endline": "588"}}, "hunk_1": {"Ismethod": 1, "added_lines": "514,515,516,517", "deleted_lines": "515,516,517,518,519,520", "method_info": {"method_name": "dp_train", "method_params": "self,model", "method_startline": "502", "method_endline": "528"}}, "hunk_2": {"Ismethod": 1, "added_lines": "494,495", "deleted_lines": "494,495,496", "method_info": {"method_name": "tpu_train", "method_params": "self,tpu_core_idx,model", "method_startline": "471", "method_endline": "500"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_new_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "325,326,327", "deleted_lines": "325,326,327", "method_info": {"method_name": "run_evaluation", "method_params": "self,bool", "method_startline": "322", "method_endline": "404"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\trainer\\trainer.py", "file_new_name": "pytorch_lightning\\trainer\\trainer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "739,740,746,747,753,754", "deleted_lines": "742,743,749,750,756", "method_info": {"method_name": "__attach_dataloaders", "method_params": "self,model,train_dataloader,val_dataloaders,test_dataloaders", "method_startline": "734", "method_endline": "756"}}, "hunk_1": {"Ismethod": 1, "added_lines": "855", "deleted_lines": "858,859", "method_info": {"method_name": "run_pretrain_routine", "method_params": "self,LightningModule", "method_startline": "814", "method_endline": "916"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "pytorch_lightning\\trainer\\training_io.py", "file_new_name": "pytorch_lightning\\trainer\\training_io.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "344,345,346,347,348,349", "method_info": {"method_name": "restore_hpc_weights_if_needed", "method_params": "self,model", "method_startline": "344", "method_endline": "362"}}, "hunk_1": {"Ismethod": 1, "added_lines": "146", "deleted_lines": "146,152,153,154", "method_info": {"method_name": "restore_weights", "method_params": "self,LightningModule", "method_startline": "146", "method_endline": "180"}}, "hunk_2": {"Ismethod": 1, "added_lines": null, "deleted_lines": "263,271,272,273,274", "method_info": {"method_name": "restore", "method_params": "self,checkpoint_path,on_gpu", "method_startline": "263", "method_endline": "292"}}, "hunk_3": {"Ismethod": 1, "added_lines": "230,237,240", "deleted_lines": "233,240,243", "method_info": {"method_name": "_atomic_save", "method_params": "self,checkpoint,str", "method_startline": "230", "method_endline": "245"}}, "hunk_4": {"Ismethod": 1, "added_lines": "237,240", "deleted_lines": "233,240,243", "method_info": {"method_name": "_atomic_save", "method_params": "self,checkpoint,filepath", "method_startline": "233", "method_endline": "248"}}, "hunk_5": {"Ismethod": 1, "added_lines": "260", "deleted_lines": "263,271,272,273,274", "method_info": {"method_name": "restore", "method_params": "self,str,bool", "method_startline": "260", "method_endline": "285"}}, "hunk_6": {"Ismethod": 1, "added_lines": "337,338", "deleted_lines": "344,345,346,347,348,349", "method_info": {"method_name": "restore_hpc_weights_if_needed", "method_params": "self,LightningModule", "method_startline": "337", "method_endline": "351"}}, "hunk_7": {"Ismethod": 1, "added_lines": "146", "deleted_lines": "146,152,153,154", "method_info": {"method_name": "restore_weights", "method_params": "self,model", "method_startline": "146", "method_endline": "183"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "pytorch_lightning\\trainer\\training_loop.py", "file_new_name": "pytorch_lightning\\trainer\\training_loop.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "464,485,486,487,488,489,490,491", "deleted_lines": "464,465", "method_info": {"method_name": "run_training_epoch", "method_params": "self", "method_startline": "385", "method_endline": "498"}}, "hunk_1": {"Ismethod": 1, "added_lines": "726,727,728,730,731,747", "deleted_lines": "721,722,724,725,741,742,743,744", "method_info": {"method_name": "update_learning_rates", "method_params": "self,interval", "method_startline": "721", "method_endline": "747"}}, "hunk_2": {"Ismethod": 1, "added_lines": "718,719", "deleted_lines": "712,713,714,721,722,724", "method_info": {"method_name": "training_forward", "method_params": "self,batch,batch_idx,opt_idx,hiddens", "method_startline": "654", "method_endline": "724"}}, "hunk_3": {"Ismethod": 1, "added_lines": "726,727,728,730,731,747,748,749,750,751", "deleted_lines": "741,742,743,744", "method_info": {"method_name": "update_learning_rates", "method_params": "self,str", "method_startline": "726", "method_endline": "754"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tests\\base\\__init__.py", "file_new_name": "tests\\base\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "43,54", "deleted_lines": "43,54"}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\base\\mixins.py", "file_new_name": "tests\\base\\mixins.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "65,66,67", "deleted_lines": "69,70", "method_info": {"method_name": "validation_epoch_end", "method_params": "self,outputs", "method_startline": "62", "method_endline": "94"}}, "hunk_1": {"Ismethod": 1, "added_lines": "17", "deleted_lines": "17,18,19,20,21", "method_info": {"method_name": "validation_step", "method_params": "self,batch,batch_idx,args,kwargs", "method_startline": "16", "method_endline": "53"}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tests\\base\\models.py", "file_new_name": "tests\\base\\models.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "68", "deleted_lines": "50,51,52,53,54", "method_info": {"method_name": "__init__", "method_params": "self,hparams,force_remove_distributed_sampler", "method_startline": "50", "method_endline": "68"}}, "hunk_1": {"Ismethod": 1, "added_lines": "68", "deleted_lines": "74,75", "method_info": {"method_name": "__build_model", "method_params": "self", "method_startline": "67", "method_endline": "75"}}, "hunk_2": {"Ismethod": 1, "added_lines": "81", "deleted_lines": "90", "method_info": {"method_name": "forward", "method_params": "self,x", "method_startline": "80", "method_endline": "90"}}, "hunk_3": {"Ismethod": 1, "added_lines": "47,48", "deleted_lines": "47,48,50,51,52,53,54", "method_info": {"method_name": "__init__", "method_params": "self,hparams,bool", "method_startline": "47", "method_endline": "62"}}, "hunk_4": {"Ismethod": 1, "added_lines": "97", "deleted_lines": "110,111,112,113,114", "method_info": {"method_name": "training_step", "method_params": "self,batch,batch_idx,optimizer_idx", "method_startline": "96", "method_endline": "121"}}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tests\\test_profiler.py", "file_new_name": "tests\\test_profiler.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "38,39,40,41,42,57,58,59,60,61,107,108,109,110,111,129,130,131,132,133", "deleted_lines": "38,53,99,117"}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\trainer\\test_trainer.py", "file_new_name": "tests\\trainer\\test_trainer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "251,252,253,254,255,256,257,258,259,260,261,262,263,275,285,287,288,291", "deleted_lines": "251,261,262,265,266,267,277,279,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397", "method_info": {"method_name": "test_model_checkpoint_options", "method_params": "tmpdir", "method_startline": "251", "method_endline": "398"}}, "hunk_1": {"Ismethod": 1, "added_lines": "263,275,285,287,288,291", "deleted_lines": "265,266,267,277,279,282,283,284,285,286,287,288,289,290,291,292", "method_info": {"method_name": "test_model_checkpoint_options", "method_params": "tmpdir,save_top_k,file_prefix,expected_files", "method_startline": "263", "method_endline": "292"}}}}}}}