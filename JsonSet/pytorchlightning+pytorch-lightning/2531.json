{"BR": {"BR_id": "2531", "BR_author": "lucmos", "BRopenT": "2020-07-06T17:15:51Z", "BRcloseT": "2020-07-27T21:56:56Z", "BR_text": {"BRsummary": "IndexError with multiple validation loaders and fast_dev_run", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n An IndexError when using multiple validation datasets and fast_dev_run=True\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior:\n \n Use multiple val_dataloaders\n Use fast_dev_run=True\n \n <denchmark-h:h3>Code sample</denchmark-h>\n \n <denchmark-link:https://colab.research.google.com/drive/107nKJxF4ttWPtQbo8-Wb0RG3Sa_fxjQP?usp=sharing>https://colab.research.google.com/drive/107nKJxF4ttWPtQbo8-Wb0RG3Sa_fxjQP?usp=sharing</denchmark-link>\n \n <denchmark-h:h3>Traceback</denchmark-h>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"/home/luca/Repositories/set-operations/src/run_experiment.py\", line 73, in <module>\n     trainer.fit(model,)\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 979, in fit\n     self.single_gpu_train(model)\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/distrib_parts.py\", line 185, in single_gpu_train\n     self.run_pretrain_routine(model)\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 1156, in run_pretrain_routine\n     self.train()\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/training_loop.py\", line 370, in train\n     self.run_training_epoch()\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/training_loop.py\", line 470, in run_training_epoch\n     self.run_evaluation(test_mode=False)\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/evaluation_loop.py\", line 409, in run_evaluation\n     eval_results = self._evaluate(self.model, dataloaders, max_batches, test_mode)\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/pytorch_lightning/trainer/evaluation_loop.py\", line 270, in _evaluate\n     dl_max_batches = max_batches[dataloader_idx]\n IndexError: list index out of range\n \n                               Exception ignored in: <function tqdm.__del__ at 0x7fe5848ba710>\n Traceback (most recent call last):\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/tqdm/std.py\", line 1086, in __del__\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/tqdm/std.py\", line 1293, in close\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/tqdm/std.py\", line 1471, in display\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/tqdm/std.py\", line 1089, in __repr__\n   File \"/home/luca/.cache/pypoetry/virtualenvs/set-operations-GbjOlTQ2-py3.7/lib/python3.7/site-packages/tqdm/std.py\", line 1433, in format_dict\n TypeError: cannot unpack non-iterable NoneType object\n \n Process finished with exit code 1\n </denchmark-code>\n \n <denchmark-h:h3>Reason</denchmark-h>\n \n If fast_dev_run=True here max_batches is set to [1]\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/evaluation_loop.py\n \n \n         Lines 376 to 377\n       in\n       afdfba1\n \n \n \n \n \n \n  if self.fast_dev_run: \n \n \n \n  max_batches = [1] \n \n \n \n \n \n Thus, later on, it does not pass this test and it remains stuck to [1]:\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/evaluation_loop.py\n \n \n         Lines 256 to 257\n       in\n       afdfba1\n \n \n \n \n \n \n  if isinstance(max_batches, int): \n \n \n \n  max_batches = [max_batches] * len(dataloaders) \n \n \n \n \n \n Then, the loop iterates over all the dataloaders, causing a IndexError at line 270 at the second iteration:\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/evaluation_loop.py\n \n \n         Lines 260 to 270\n       in\n       afdfba1\n \n \n \n \n \n \n  for dataloader_idx, dataloader in enumerate(dataloaders): \n \n \n \n  dl_outputs = [] \n \n \n \n  \n \n \n \n  # on TPU we have to wrap it under the ParallelLoader \n \n \n \n  if self.use_tpu: \n \n \n \n  device = xm.xla_device(self.tpu_id) \n \n \n \n  dataloader = xla_pl.ParallelLoader(dataloader, [device]) \n \n \n \n  dataloader = dataloader.per_device_loader(device) \n \n \n \n  \n \n \n \n  # each dataloader has a max num batches \n \n \n \n  dl_max_batches = max_batches[dataloader_idx] \n \n \n \n \n \n <denchmark-h:h3>Possible solution</denchmark-h>\n \n \n Let fast_dev_run=True use all validation loaders\n Modify the evaluation for loop to use only the first val loader\n \n <denchmark-h:h3>Environment</denchmark-h>\n \n \n CUDA:\n \n GPU:\n available:         False\n version:           10.1\n \n \n Packages:\n \n numpy:             1.18.5\n pyTorch_debug:     False\n pyTorch_version:   1.5.1+cu101\n pytorch-lightning: 0.8.4\n tensorboard:       2.2.2\n tqdm:              4.41.1\n \n \n System:\n \n OS:                Linux\n architecture:\n \n 64bit\n \n \n \n processor:         x86_64\n python:            3.6.9\n version:           1 SMP Wed Feb 19 05:26:34 PST 2020\n \n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lucmos", "commentT": "2020-07-06T18:23:05Z", "comment_text": "\n \t\t\n Let fast_dev_run=True use all validation loaders\n \n This is a better choice since Dataset of different dataloaders can be different and we need to check all of them using fast_dev_run.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "lucmos", "commentT": "2020-07-07T08:06:17Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/lucmos>@lucmos</denchmark-link>\n  seems you digged in... mind send a PR?\n \t\t"}}}, "commit": {"commit_id": "84c507c4df5f5c336deb19ce7f70fa02329f39f6", "commit_author": "Rohit Gupta", "commitT": "2020-07-27 17:56:55-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "35,36", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\callbacks\\progress.py", "file_new_name": "pytorch_lightning\\callbacks\\progress.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "101,102,103", "deleted_lines": "101,103,104", "method_info": {"method_name": "total_val_batches", "method_params": "self", "method_startline": "94", "method_endline": "104"}}, "hunk_1": {"Ismethod": 1, "added_lines": "113", "deleted_lines": "107", "method_info": {"method_name": "total_test_batches", "method_params": "self", "method_startline": "107", "method_endline": "113"}}, "hunk_2": {"Ismethod": 1, "added_lines": "91", "deleted_lines": "91", "method_info": {"method_name": "total_train_batches", "method_params": "self", "method_startline": "85", "method_endline": "91"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\__init__.py", "file_new_name": "pytorch_lightning\\trainer\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "396", "deleted_lines": "396"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_new_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "516,520,521,522,523", "method_info": {"method_name": "run_evaluation", "method_params": "self,bool", "method_startline": "497", "method_endline": "559"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\trainer.py", "file_new_name": "pytorch_lightning\\trainer\\trainer.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "281,508,509,510,511,512,535,536,537", "deleted_lines": "281,508"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\trainer\\training_loop.py", "file_new_name": "pytorch_lightning\\trainer\\training_loop.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "551", "deleted_lines": "551", "method_info": {"method_name": "check_checkpoint_callback", "method_params": "self,should_check_val", "method_startline": "548", "method_endline": "554"}}, "hunk_1": {"Ismethod": 1, "added_lines": "404", "deleted_lines": "404", "method_info": {"method_name": "train", "method_params": "self", "method_startline": "329", "method_endline": "422"}}, "hunk_2": {"Ismethod": 1, "added_lines": "510,533", "deleted_lines": "510,533", "method_info": {"method_name": "run_training_epoch", "method_params": "self", "method_startline": "452", "method_endline": "546"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "pytorch_lightning\\utilities\\debugging.py", "file_new_name": "pytorch_lightning\\utilities\\debugging.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "14,15", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,trainer", "method_startline": "7", "method_endline": "17"}}, "hunk_1": {"Ismethod": 1, "added_lines": "88,89,90,91,92,93", "deleted_lines": null, "method_info": {"method_name": "num_seen_test_check_batches", "method_params": "self", "method_startline": "88", "method_endline": "93"}}, "hunk_2": {"Ismethod": 1, "added_lines": "29,30,31,32,33,34,35,36,37,38,39,40,41,42", "deleted_lines": null, "method_info": {"method_name": "track_eval_loss_history", "method_params": "self,test_mode,batch_idx,dataloader_idx,output", "method_startline": "29", "method_endline": "42"}}, "hunk_3": {"Ismethod": 1, "added_lines": "75,76,77", "deleted_lines": null, "method_info": {"method_name": "num_seen_sanity_check_batches", "method_params": "self", "method_startline": "75", "method_endline": "77"}}, "hunk_4": {"Ismethod": 1, "added_lines": "80,81,82,83,84,85", "deleted_lines": null, "method_info": {"method_name": "num_seen_val_check_batches", "method_params": "self", "method_startline": "80", "method_endline": "85"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\callbacks\\test_progress_bar.py", "file_new_name": "tests\\callbacks\\test_progress_bar.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "119,120", "deleted_lines": null, "method_info": {"method_name": "test_progress_bar_fast_dev_run", "method_params": "tmpdir", "method_startline": "111", "method_endline": "141"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\models\\test_grad_norm.py", "file_new_name": "tests\\models\\test_grad_norm.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "46", "deleted_lines": "46", "method_info": {"method_name": "test_grad_tracking", "method_params": "tmpdir,norm_type,rtol", "method_startline": "46", "method_endline": "74"}}, "hunk_1": {"Ismethod": 1, "added_lines": "46", "deleted_lines": "46", "method_info": {"method_name": "test_grad_tracking", "method_params": "tmpdir,norm_type,rtol", "method_startline": "46", "method_endline": "74"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\trainer\\test_dataloaders.py", "file_new_name": "tests\\trainer\\test_dataloaders.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "310,311,329,330,331,332,338,340,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362", "deleted_lines": "332", "method_info": {"method_name": "test_dataloaders_with_limit_num_batches", "method_params": "tmpdir,limit_train_batches,limit_val_batches,limit_test_batches", "method_startline": "308", "method_endline": "362"}}, "hunk_1": {"Ismethod": 1, "added_lines": "365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396", "deleted_lines": null, "method_info": {"method_name": "test_dataloaders_with_fast_dev_run", "method_params": "tmpdir", "method_startline": "365", "method_endline": "396"}}}}}}}