{"BR": {"BR_id": "2337", "BR_author": "randyzwitch", "BRopenT": "2020-11-11T14:27:53Z", "BRcloseT": "2020-12-21T21:16:16Z", "BR_text": {"BRsummary": "st.bokeh_chart double plot until browser resized", "BRdescription": "\n Between versions 0.65 and 0.66 of Streamlit, running the following code snippet will cause a Bokeh plot to be duplicated:\n <denchmark-link:https://gist.github.com/BitBernd/4cc06473d71de4a67ede607a618b0a83>https://gist.github.com/BitBernd/4cc06473d71de4a67ede607a618b0a83</denchmark-link>\n \n <denchmark-link:https://user-images.githubusercontent.com/2762787/98823322-efb23b80-23ff-11eb-9a79-16226624604d.png></denchmark-link>\n \n To trigger the difference, running pip install streamlit=0.65 to see the correct version, then pip install streamlit==0.66 (or any version above that) to see the double-plotting. Move/resize the browser window slightly using 0.66+ and the duplicate plot will disappear.\n Ref: <denchmark-link:https://discuss.streamlit.io/t/bokeh-produces-two-charts-when-deployed/5820/11>https://discuss.streamlit.io/t/bokeh-produces-two-charts-when-deployed/5820/11</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "randyzwitch", "commentT": "2020-11-12T19:00:55Z", "comment_text": "\n \t\tDev notes: Fairly sure this was broken by the migration to React Hooks:\n <denchmark-link:https://github.com/streamlit/streamlit/commit/6d204cab8c335c22794fbeec98f45ddb4b00cc44#diff-0232e1ad414e4bd3a00925d15370625f7a4b0db94c36e28862fc1e1da90e31b6>6d204ca#diff-0232e1ad414e4bd3a00925d15370625f7a4b0db94c36e28862fc1e1da90e31b6</denchmark-link>\n \n As it was the only thing in that timeline 0.65 to 0.66 that changed in BokehChart. Indeed, reverting back to non-hooks stops the duplication. Still need to root-cause what about hooks is bad\n Quick dump of working version:\n <denchmark-code>/**\n  * @license\n  * Copyright 2018-2020 Streamlit Inc.\n  *\n  * Licensed under the Apache License, Version 2.0 (the \"License\");\n  * you may not use this file except in compliance with the License.\n  * You may obtain a copy of the License at\n  *\n  *    http://www.apache.org/licenses/LICENSE-2.0\n  *\n  * Unless required by applicable law or agreed to in writing, software\n  * distributed under the License is distributed on an \"AS IS\" BASIS,\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n \n import React, { PureComponent, ReactNode } from \"react\"\n import { embed as BokehEmbed } from \"@bokeh/bokehjs\"\n import withFullScreenWrapper from \"hocs/withFullScreenWrapper\"\n import { BokehChart as BokehChartProto } from \"autogen/proto\"\n \n interface Props {\n   width: number\n   element: BokehChartProto\n   index: number\n }\n \n export interface PropsWithHeight extends Props {\n   height: number | undefined\n }\n \n interface Dimensions {\n   width: number\n   height: number\n }\n \n export class BokehChart extends PureComponent<PropsWithHeight> {\n   private chartId = `bokeh-chart-${this.props.index}`\n \n   private getChartData = (): any => {\n     return JSON.parse(this.props.element.figure)\n     // const figure = this.props.element.get(\"figure\")\n     // return JSON.parse(figure)\n   }\n \n   public getChartDimensions = (plot: any): Dimensions => {\n     const useContainerWidth = this.props.element.useContainerWidth\n     // Default values\n     let width = plot.attributes.plot_width\n     let height = plot.attributes.plot_height\n \n     // if is not fullscreen and useContainerWidth==false, we should use default values\n     if (this.props.height) {\n       // fullscreen\n       width = this.props.width\n       height = this.props.height\n     } else if (useContainerWidth) {\n       width = this.props.width\n     }\n \n     return { width, height }\n   }\n \n   private updateChart = (data: any): void => {\n     const chart = document.getElementById(this.chartId)\n \n     /**\n      * When you create a bokeh chart in your python script, you can specify\n      * the width: p = figure(title=\"simple line example\", x_axis_label=\"x\", y_axis_label=\"y\", plot_width=200);\n      * In that case, the json object will contains an attribute called\n      * plot_width (or plot_heigth) inside the plot reference.\n      * If that values are missing, we can set that values to make the chart responsive.\n      */\n     const plot =\n       data && data.doc && data.doc.roots && data.doc.roots.references\n         ? data.doc.roots.references.find((e: any) => e.type === \"Plot\")\n         : undefined\n \n     if (plot) {\n       const { width, height } = this.getChartDimensions(plot)\n \n       if (width > 0) {\n         plot.attributes.plot_width = width\n       }\n       if (height > 0) {\n         plot.attributes.plot_height = height\n       }\n     }\n \n     if (chart !== null) {\n       this.removeAllChildNodes(chart)\n       BokehEmbed.embed_item(data, this.chartId)\n     }\n   }\n \n   private removeAllChildNodes = (element: Node): void => {\n     while (element.lastChild) {\n       element.lastChild.remove()\n     }\n   }\n \n   public componentDidMount = (): void => {\n     const data = this.getChartData()\n     this.updateChart(data)\n   }\n \n   public componentDidUpdate = (): void => {\n     const data = this.getChartData()\n     this.updateChart(data)\n   }\n \n   public render = (): ReactNode => (\n     <div id={this.chartId} className=\"stBokehChart\" />\n   )\n }\n \n export default withFullScreenWrapper(BokehChart)\n \n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "randyzwitch", "commentT": "2020-11-13T20:56:12Z", "comment_text": "\n \t\tBy console logging: the react hook version calls useEffect() multiple (~4ish) times on each rerun? But the original version only does it once, correctly.\n Solution appears to be to add dependencies into useEffect() -- empty array? all arguments?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "randyzwitch", "commentT": "2020-12-16T17:38:55Z", "comment_text": "\n \t\tThis morning I upgraded to the latest  to squash <denchmark-link:https://github.com/streamlit/streamlit/issues/2311#issuecomment-745774600>this bug</denchmark-link>\n  (and that did indeed work), but I am still encountering this double Bokeh plot issue with the current nightly dev package. I would really appreciate it if this could be addressed in 0.73.0, or as soon as y'all can, as this currently breaks my app and is preventing me from deploying\n this is a regression; I did not encounter this with 0.71.0 -- only in 0.72.0 and the currently nightly build\n \t\t"}}}, "commit": {"commit_id": "b4574554892dfafdc2ec78909eb4cdc04ff6529d", "commit_author": "Austin Chen", "commitT": "2020-12-21 13:16:15-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "frontend\\src\\components\\elements\\BokehChart\\BokehChart.tsx", "file_new_name": "frontend\\src\\components\\elements\\BokehChart\\BokehChart.tsx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "18,43,45,98,99,100,105,106,107,108,109,110,111,112,113,114,116,117,118,119,120,121,122,123,124", "deleted_lines": "18,43,45,103,104"}}}}}}