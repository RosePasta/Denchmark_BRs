{"BR": {"BR_id": "629", "BR_author": "yousifKashef", "BRopenT": "2018-06-05T06:27:00Z", "BRcloseT": "2018-07-05T20:38:22Z", "BR_text": {"BRsummary": "loss is nan when using beta to train detector", "BRdescription": "\n Hi,\n I\u2019m using the beta (turiCreate 5) to train an image detector. The code I\u2019m using to train the detector is the same that I used to train a detector using the last version of Turi Create (which went fine). Now, I\u2019m getting nan in the loss category as it\u2019s training with my mac\u2019s GPU. Is this a bug or should I adjust my code to fix this?\n Thanks!\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yousifKashef", "commentT": "2018-06-05T14:34:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/yousifKashef>@yousifKashef</denchmark-link>\n : Can you tell us which GPU you have. We have seen some select GPUs where we get a nan loss and are trying to track it down and fix it soon.\n For now you can do:\n <denchmark-code>import turicreate\n turicreate.config.set_num_gpus(0)\n </denchmark-code>\n \n This is an important bug and its high on our list.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yousifKashef", "commentT": "2018-06-05T16:11:39Z", "comment_text": "\n \t\tHi Srikris,\n I have an imac 5k (late 2015) with an AMD Radeon R9 M395 graphics processor with 2 GB of dedicated GDDR5 memory. I\u2019ll Post the log from terminal later today.\n Thanks\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yousifKashef", "commentT": "2018-06-19T18:07:26Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/yousifKashef>@yousifKashef</denchmark-link>\n  - If you can post the logs you mentioned, that would be helpful.\n It would also be helpful if you can share the code too. In particular I would like to know the value getting used for the model parameter in image_classifier.create(...). Are you using VisionFeaturePrint_Screen?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yousifKashef", "commentT": "2018-06-25T01:49:31Z", "comment_text": "\n \t\tYousifs-iMac:training yousif$ python train.py\n Downloading <denchmark-link:https://docs-assets.developer.apple.com/turicreate/models/darknet.params>https://docs-assets.developer.apple.com/turicreate/models/darknet.params</denchmark-link>\n \n Download completed: /var/folders/3y/ykbsfsg52n91gbvh45m00zlc0000gn/T/model_cache/darknet.params\n Using GPU to create model (AMD Radeon R9 M380)\n +--------------+--------------+--------------+\n | Iteration    | Loss         | Elapsed Time |\n +--------------+--------------+--------------+\n | 1            | 4.287        | 30.0         |\n | 5            | nan          | 50.3         |\n | 9            | nan          | 61.9         |\n | 12           | nan          | 74.3         |\n | 15           | nan          | 86.4         |\n | 20           | nan          | 101.2        |\n | 25           | nan          | 116.7        |\n | 31           | nan          | 133.0        |\n | 36           | nan          | 150.8        |\n | 41           | nan          | 166.8        |\n | 46           | nan          | 184.5        |\n | 51           | nan          | 202.4        |\n | 57           | nan          | 220.5        |\n | 61           | nan          | 230.6        |\n | 63           | nan          | 254.2        |\n | 67           | nan          | 267.7        |\n | 72           | nan          | 284.4        |\n | 77           | nan          | 302.0        |\n | 81           | nan          | 312.2        |\n | 84           | nan          | 324.8        |\n | 88           | nan          | 339.0        |\n | 93           | nan          | 355.5        |\n | 97           | nan          | 365.9        |\n | 99           | nan          | 376.6        |\n | 103          | nan          | 391.8        |\n | 108          | nan          | 411.7        |\n | 112          | nan          | 423.4        |\n | 114          | nan          | 434.7        |\n | 118          | nan          | 444.8        |\n | 120          | nan          | 455.1        |\n | 124          | nan          | 468.4        |\n | 129          | nan          | 485.6        |\n | 134          | nan          | 500.6        |\n | 140          | nan          | 516.9        |\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yousifKashef", "commentT": "2018-06-25T01:50:34Z", "comment_text": "\n \t\timport turicreate as tc\n modelName = 'output'\n <denchmark-h:h1>Load the data</denchmark-h>\n \n data = tc.SFrame('training.sframe')\n <denchmark-h:h1>Make a train-test split</denchmark-h>\n \n train_data, test_data = data.random_split(0.8)\n <denchmark-h:h1>Automatically picks the right model based on your data.</denchmark-h>\n \n model = tc.object_detector.create(train_data, feature='image', annotations='annotations', max_iterations=10000)\n <denchmark-h:h1>Save the model for later use in Turi Create</denchmark-h>\n \n <denchmark-h:h1>Important to save in case something after breaks the script</denchmark-h>\n \n model.save(modelName + '.model')\n <denchmark-h:h1>Mean average Precision</denchmark-h>\n \n scores = model.evaluate(data)\n print(scores['mean_average_precision'])\n <denchmark-h:h1>Export for use in CoreML</denchmark-h>\n \n model.export_coreml(modelName.title() + 'Classifier.mlmodel')\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "yousifKashef", "commentT": "2018-06-28T20:50:55Z", "comment_text": "\n \t\tOkay, we've figured out that this problem is ultimately due to running out of memory on the GPU. A smaller batch size resolves the issue. We should make the batch size scale automatically according to available memory, but in the meantime you should be able to get things going by changing your invocation to something like:\n <denchmark-code>model = tc.object_detector.create(train_data, feature='image', annotations='annotations',\n     _advanced_parameters={'batch_size' : 16})\n </denchmark-code>\n \n Note that if you specify the number of iterations explicitly, you'll need to double that number to achieve the same number of passes through the training data. (The current default batch size is 32.)\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "yousifKashef", "commentT": "2018-08-24T23:08:22Z", "comment_text": "\n \t\tI am also seeing the same 'NaN' for loss after the first iteration while using GPU.  When changing to CPU it runs correctly.  The OS version is 10.14 (Mojave).  GPU is AMD Radeon 455  (2048 MB).  Batch size is 16.  I tried changing the batch size to 8, but it did not take it.  The Mac is a MacBook Pro with 16GB RAM.\n Does this mean I cannot use GPU to train?\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "yousifKashef", "commentT": "2019-02-01T23:15:49Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/silvywilson>@silvywilson</denchmark-link>\n  Sigh, I suspect this is the same issue as <denchmark-link:https://github.com/apple/turicreate/issues/1236>#1236</denchmark-link>\n , which is resolved in macOS 10.14.4. Let me know if you encounter this issue after upgrading to that version (currently still in public beta).\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "yousifKashef", "commentT": "2019-02-26T04:00:15Z", "comment_text": "\n \t\tI have the same problem \u201cbatch_size doesn\u2019t stick\u201d even after updating to 10.14.4 beta 3 and turicreate 5.3.1\n I\u2019m using object detector with image sizes of 1024x1024 (some objects I\u2019m attempting to detect are small). My GPU is Radeon 455\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "yousifKashef", "commentT": "2019-03-05T20:23:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/chompysticks>@chompysticks</denchmark-link>\n  Hmm, what do you mean \"batch_size doesn't stick\"? Could you copy how you're invoking  and what the initial output is?\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "yousifKashef", "commentT": "2019-03-16T23:51:31Z", "comment_text": "\n \t\tSeeing same issue running macOS 10.14.4 Beta (18E215a).\n After adding _advanced_parameters={'batch_size' : 8}...\n I got this error:\n <denchmark-code>Traceback (most recent call last):\n   File \"Train.py\", line 25, in <module>\n     model = tc.object_detector.create(train_data, feature='image', annotations='annotations', _advanced_parameters={'batch_size' : 8}) #, max_iterations=5)\n   File \"/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/turicreate/toolkits/object_detector/object_detector.py\", line 264, in create\n     raise _ToolkitError('Unknown advanced parameters: {}'.format(unsupported))\n turicreate.toolkits._main.ToolkitError: Unknown advanced parameters: {'batch_size'}\n </denchmark-code>\n \n MacBook Pro (15-inch, 2016)\n 2.7 GHz Intel Core i7\n 16 GB 2133 MHz LPDDR3\n Radeon Pro 455 2 GB\n Intel HD Graphics 530 1536 MB\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "yousifKashef", "commentT": "2019-03-29T18:52:17Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/dmcgloin>@dmcgloin</denchmark-link>\n  add it as a regular parameter and not an object, that got rid of the error for me.\n model = tc.object_detector.create(train_data, feature='image', annotations='annotations', batch_size=16)\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "yousifKashef", "commentT": "2019-03-29T19:13:34Z", "comment_text": "\n \t\tAh, yes, since my comment last June, batch_size got promoted to a real (documented) parameter\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "yousifKashef", "commentT": "2019-04-01T04:59:55Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/vhicks>@vhicks</denchmark-link>\n  and <denchmark-link:https://github.com/nickjong>@nickjong</denchmark-link>\n . I corrected to use  real parameter, but it seems to ignore value of . Anyway, still getting  as  for second iteration onward.\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "yousifKashef", "commentT": "2019-04-02T23:22:06Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/dmcgloin>@dmcgloin</denchmark-link>\n  What version of Turi Create are you running? And what output do you get in response to your  call?\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "yousifKashef", "commentT": "2019-05-08T16:47:01Z", "comment_text": "\n \t\tJust noticed for the first time the nan issue when I enabled GPU.  Read the notes above and made the batch size change and it worked and did not work.  Here is my line of code:\n newModel = tc.object_detector.create(test_data, feature='image', annotations='annotation', \\ max_iterations=iterations, model=\"darknet-yolo\", batch_size=16)\n Strangely, the first time I run it with GPU enabled and batch_size=16 added to the parameters, it fails with the following error:\n Traceback (most recent call last):  File \"turiObjects.py\", line 277, in <module>    output = turiObjects(imagefolder, gtfolder, modelname, iterations, fixorient)  File \"turiObjects.py\", line 206, in __init__   max_iterations=iterations, model=\"darknet-yolo\", batch_size=16) File \"/Users/jamey/Library/Python/2.7/lib/python/site-packages/turicreate/toolkits/object_detector/object_detector.py\", line 349, in create    iterations=num_iterations)  File \"/Users/jamey/Library/Python/2.7/lib/python/site-packages/turicreate/toolkits/object_detector/_sframe_loader.py\", line 295, in __init__   \"The following row(s) did not conform to this format:\" + s) turicreate.toolkits._main.ToolkitError: Invalid object annotations discovered. A valid annotation is a dictionary that defines 'label' and 'coordinates', the latter being a dictionary that defines 'x', 'y', 'width', and 'height'. The following row(s) did not conform to this format:\n For some reason, I decided to simply run it again (I know, makes no sense) and it worked.  I'm not sure this is related to enabling GPU but wanted to add my comment just in case.\n Turi version: 5.4\n macOS: 10.14.4\n Machines: MacBook Pro (Radeon Pro 460 4GB) and iMac (AMD Radeon R9 M395 2GB)\n \t\t"}}}, "commit": {"commit_id": "229c241052dd3611f3da9efb754fdb87771f507a", "commit_author": "Nick Jong", "commitT": "2018-07-05 13:38:21-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\unity\\python\\turicreate\\toolkits\\_mps_utils.py", "file_new_name": "src\\unity\\python\\turicreate\\toolkits\\_mps_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "216,217,218,219,220,221,222,223,224,225,226,227", "deleted_lines": null, "method_info": {"method_name": "mps_device_memory_limit", "method_params": "", "method_startline": "216", "method_endline": "227"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\unity\\python\\turicreate\\toolkits\\object_detector\\object_detector.py", "file_new_name": "src\\unity\\python\\turicreate\\toolkits\\object_detector\\object_detector.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "101", "method_info": {"method_name": "create", "method_params": "dataset,annotations,feature,model,classes,max_iterations,verbose,kwargs", "method_startline": "100", "method_endline": "101"}}, "hunk_1": {"Ismethod": 1, "added_lines": "102,103", "deleted_lines": "101", "method_info": {"method_name": "create", "method_params": "dataset,annotations,feature,model,classes,batch_size,max_iterations,verbose,kwargs", "method_startline": "101", "method_endline": "103"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\unity\\toolkits\\tcmps\\CMakeLists.txt", "file_new_name": "src\\unity\\toolkits\\tcmps\\CMakeLists.txt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "18", "deleted_lines": "18"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_cnnmodule.h", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_cnnmodule.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "13,14"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_cnnmodule.mm", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_cnnmodule.mm", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25", "deleted_lines": null, "method_info": {"method_name": "turi::mps::MPSCNNModule::MPSCNNModule", "method_params": "", "method_startline": "24", "method_endline": "34"}}}}, "file_5": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_dev.h", "file_new_name": "None"}, "file_6": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_dev.mm", "file_new_name": "None"}, "file_7": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_device_manager.h"}, "file_8": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_device_manager.m"}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_graph_cnnmodule.mm", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_graph_cnnmodule.mm", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "39", "deleted_lines": "39", "method_info": {"method_name": "turi::mps::MPSGraphModule::MPSGraphModule", "method_params": "", "method_startline": "37", "method_endline": "51"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_graph_trainer.h", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_graph_trainer.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12", "deleted_lines": null}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\unity\\toolkits\\tcmps\\mps_graph_trainer.mm", "file_new_name": "src\\unity\\toolkits\\tcmps\\mps_graph_trainer.mm", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "15", "deleted_lines": "15", "method_info": {"method_name": "TCMPSHasHighPowerMetalDevice", "method_params": "has_device", "method_startline": "12", "method_endline": "19"}}, "hunk_1": {"Ismethod": 1, "added_lines": "23", "deleted_lines": "23", "method_info": {"method_name": "TCMPSMetalDeviceName", "method_params": "name,max_len", "method_startline": "21", "method_endline": "29"}}, "hunk_2": {"Ismethod": 1, "added_lines": "31,32,33,34,35,36,37,38,39,40,41,42", "deleted_lines": null, "method_info": {"method_name": "TCMPSMetalDeviceMemoryLimit", "method_params": "size", "method_startline": "31", "method_endline": "42"}}}}}}}