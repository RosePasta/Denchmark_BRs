{"BR": {"BR_id": "2035", "BR_author": "yeliang2258", "BRopenT": "2020-02-11T13:00:30Z", "BRcloseT": "2020-04-15T06:10:14Z", "BR_text": {"BRsummary": "The AGP_Pruner example provided can not run successfully, An error occurred: TypeError: unsupported operand type (s) for *: 'Tensor' and 'dict'", "BRdescription": "\n The error is:\n <denchmark-link:https://user-images.githubusercontent.com/30516196/74238560-01e83780-4d11-11ea-8864-98d74396143d.png></denchmark-link>\n \n The first epoch can run, but the second epoch reports an error.\n The code is from  the sample main_torch_pruner.py\uff08<denchmark-link:https://github.com/microsoft/nni/blob/master/examples/model_compress/main_torch_pruner.py%EF%BC%89>https://github.com/microsoft/nni/blob/master/examples/model_compress/main_torch_pruner.py\uff09</denchmark-link>\n \n code\uff1a\n from nni.compression.torch import AGP_Pruner\n import torch\n import torch.nn.functional as F\n from torchvision import datasets, transforms\n class Mnist(torch.nn.Module):\n def init(self):\n super().init()\n self.conv1 = torch.nn.Conv2d(1, 20, 5, 1)\n self.conv2 = torch.nn.Conv2d(20, 50, 5, 1)\n self.fc1 = torch.nn.Linear(4 * 4 * 50, 500)\n self.fc2 = torch.nn.Linear(500, 10)\n <denchmark-code>def forward(self, x):\n     x = F.relu(self.conv1(x))\n     x = F.max_pool2d(x, 2, 2)\n     x = F.relu(self.conv2(x))\n     x = F.max_pool2d(x, 2, 2)\n     x = x.view(-1, 4 * 4 * 50)\n     x = F.relu(self.fc1(x))\n     x = self.fc2(x)\n     return F.log_softmax(x, dim=1)\n </denchmark-code>\n \n def train(model, device, train_loader, optimizer):\n model.train()\n for batch_idx, (data, target) in enumerate(train_loader):\n data, target = data.to(device), target.to(device)\n optimizer.zero_grad()\n output = model(data)\n loss = F.nll_loss(output, target)\n loss.backward()\n optimizer.step()\n if batch_idx % 100 == 0:\n print('{:2.0f}%  Loss {}'.format(100 * batch_idx / len(train_loader), loss.item()))\n def test(model, device, test_loader):\n model.eval()\n test_loss = 0\n correct = 0\n with torch.no_grad():\n for data, target in test_loader:\n data, target = data.to(device), target.to(device)\n output = model(data)\n test_loss += F.nll_loss(output, target, reduction='sum').item()\n pred = output.argmax(dim=1, keepdim=True)\n correct += pred.eq(target.view_as(pred)).sum().item()\n test_loss /= len(test_loader.dataset)\n <denchmark-code>print('Loss: {}  Accuracy: {}%)\\n'.format(\n     test_loss, 100 * correct / len(test_loader.dataset)))\n </denchmark-code>\n \n def main():\n torch.manual_seed(0)\n device = torch.device('cpu')\n <denchmark-code>trans = transforms.Compose([transforms.ToTensor(), transforms.Normalize((0.1307,), (0.3081,))])\n train_loader = torch.utils.data.DataLoader(\n     datasets.MNIST('data', train=True, download=True, transform=trans),\n     batch_size=64, shuffle=True)\n test_loader = torch.utils.data.DataLoader(\n     datasets.MNIST('data', train=False, transform=trans),\n     batch_size=1000, shuffle=True)\n \n model = Mnist()\n model.to(device)\n \n '''you can change this to LevelPruner to implement it\n pruner = LevelPruner(configure_list)\n '''\n configure_list = [{\n     'initial_sparsity': 0,\n     'final_sparsity': 0.8,\n     'start_epoch': 0,\n     'end_epoch': 10,\n     'frequency': 1,\n     'op_types': ['default']\n }]\n \n pruner = AGP_Pruner(model, configure_list)\n model = pruner.compress()\n \n optimizer = torch.optim.SGD(model.parameters(), lr=0.01, momentum=0.5)\n for epoch in range(10):\n     pruner.update_epoch(epoch)\n     print('# Epoch {} #'.format(epoch))\n     train(model, device, train_loader, optimizer)\n     test(model, device, test_loader)\n pruner.export_model('model.pth', 'mask.pth', 'model.onnx', [1, 1, 28, 28])\n </denchmark-code>\n \n if name == 'main':\n main()\n Thanks\uff01\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yeliang2258", "commentT": "2020-02-11T15:09:43Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n  , thanks for bringing up this issue\uff01Could you try using nni v1.4? This is fixed in latest version.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yeliang2258", "commentT": "2020-02-12T06:52:37Z", "comment_text": "\n \t\t\n Hi @yeliang2258 , thanks for bringing up this issue\uff01Could you try using nni v1.4? This is fixed in latest version.\n \n Hello, using cpu, AGP can work normally, but using cuda will report an error, the error message is as follows. The code is the provided example, I changed cpu to cuda, Thanks\uff01\n <denchmark-link:https://user-images.githubusercontent.com/30516196/74310011-1d9e1d00-4da7-11ea-82ca-a79dae0f90f0.png></denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yeliang2258", "commentT": "2020-02-12T07:35:00Z", "comment_text": "\n \t\tHi, <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n  , could you try add  after line  and see if it works? It seems some buffers registered by pruner are not transfered into cuda, which caused the error. Thanks!\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yeliang2258", "commentT": "2020-02-12T07:46:20Z", "comment_text": "\n \t\t\n Hi, @yeliang2258 , could you try add model = model.to(device) after line model = pruner.compress() and see if it works? It seems some buffers registered by pruner are not transfered into cuda, which caused the error. Thanks!\n \n Still not working, the error message is as follows\uff1a\n <denchmark-link:https://user-images.githubusercontent.com/30516196/74313508-c734dc80-4dae-11ea-9678-b9c7cd82dfec.png></denchmark-link>\n \n The function pruner.export_model ()) in the example has no effect. Thanks!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yeliang2258", "commentT": "2020-02-12T07:53:31Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n , could you change  into ?\n default device for export_model is cpu, which cause the error.\n If it works, you are welcome to submit a PR for this  outdated example. Thanks!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "yeliang2258", "commentT": "2020-02-12T08:01:40Z", "comment_text": "\n \t\t\n Hi @yeliang2258, could you change pruner.export_model('model.pth', 'mask.pth', 'model.onnx', [1, 1, 28, 28]) into pruner.export_model('model.pth', 'mask.pth', 'model.onnx', [1, 1, 28, 28], device)?\n default device for export_model is cpu, which cause the error.\n If it works, you are welcome to submit a PR for this outdated example. Thanks!\n \n I modified it and found two problems. First, the pruner.export_model () function did not generate the corresponding file. Second, cuda still couldn't be used, and the same error was reported. my torch is 1.2.0\uff0cand nni is V1.4\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "yeliang2258", "commentT": "2020-02-12T08:50:31Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n , after some debugging, it turns out there is a bug in code for transfering buffers between device. Since most examples set origin  buffers on cuda, the bug is not spotted. Anyway, I will fix this issue later and inform you after this issue is fixed and tested.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "yeliang2258", "commentT": "2020-02-12T09:10:08Z", "comment_text": "\n \t\t\n Hi @yeliang2258, after some debugging, it turns out there is a bug in code for transfering buffers between device. Since most examples set origin buffers on cuda, the bug is not spotted. Anyway, I will fix this issue later and inform you after this issue is fixed and tested.\n \n Ok! thank you very much! Also, the pruner.export_model () function in AGP does not seem to work, it does not generate the corresponding file.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "yeliang2258", "commentT": "2020-02-12T09:13:09Z", "comment_text": "\n \t\tHi, <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n  , the file is generated in the same directory as the directory you run the python command. example:  then file is in directory a. Files are generated as expected in my machine. could you check if files are in other directory? Thanks!\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "yeliang2258", "commentT": "2020-04-15T06:10:13Z", "comment_text": "\n \t\tClosing as the original problem is fixed. thanks <denchmark-link:https://github.com/yeliang2258>@yeliang2258</denchmark-link>\n  and <denchmark-link:https://github.com/Cjkkkk>@Cjkkkk</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "b7045b1938cb58506a6f8dc8274c971f630d9105", "commit_author": "Cjkkkk", "commitT": "2020-02-16 21:14:11+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "examples\\model_compress\\main_torch_pruner.py", "file_new_name": "examples\\model_compress\\main_torch_pruner.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "58,69,85,92", "deleted_lines": "58,69,85,92", "method_info": {"method_name": "main", "method_params": "", "method_startline": "56", "method_endline": "92"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "src\\sdk\\pynni\\nni\\compression\\torch\\compressor.py", "file_new_name": "src\\sdk\\pynni\\nni\\compression\\torch\\compressor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "244,245,246,247,248", "deleted_lines": "246", "method_info": {"method_name": "get_registered_buffers", "method_params": "self", "method_startline": "244", "method_endline": "248"}}, "hunk_1": {"Ismethod": 1, "added_lines": "251", "deleted_lines": null, "method_info": {"method_name": "forward", "method_params": "self,inputs", "method_startline": "250", "method_endline": "261"}}, "hunk_2": {"Ismethod": 1, "added_lines": "229,237,238,242", "deleted_lines": "229,237,238,239", "method_info": {"method_name": "__init__", "method_params": "self,module,module_name,module_type,config,pruner", "method_startline": "204", "method_endline": "242"}}, "hunk_3": {"Ismethod": 1, "added_lines": "407,424", "deleted_lines": "416,419", "method_info": {"method_name": "__init__", "method_params": "self,module,module_name,module_type,config,quantizer", "method_startline": "382", "method_endline": "424"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sdk\\pynni\\nni\\compression\\torch\\pruners.py", "file_new_name": "src\\sdk\\pynni\\nni\\compression\\torch\\pruners.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "173", "deleted_lines": "173", "method_info": {"method_name": "update_epoch", "method_params": "self,epoch", "method_startline": "161", "method_endline": "173"}}}}}}}