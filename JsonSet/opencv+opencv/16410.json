{"BR": {"BR_id": "16410", "BR_author": "arnaudbrejeon", "BRopenT": "2020-01-22T19:48:33Z", "BRcloseT": "2020-01-31T06:45:05Z", "BR_text": {"BRsummary": "Crash in connectedComponentsWithStats", "BRdescription": "\n OpenCV 4.1.1\n OS: OSX\n Compiler: clang\n I found a crash in connectedComponentsWithStats on very specific images. It is a bit difficult reproduce because it depends on the number of threads (16 on my machine).\n See the code below to reproduce systematically.\n From my understanding, the problem comes from the colliding labels.\n I will try to provide a fix this week.\n <denchmark-code>cv::Mat createCrashMat(int numThreads) {\n     const int h = numThreads * 4 * 2 + 8;\n     const double nParallelStripes = std::max(1, std::min(h / 2, numThreads * 4));\n     const int w = 4;\n \n     const int nstripes = cvRound(nParallelStripes <= 0 ? h : MIN(MAX(nParallelStripes, 1.), h));\n     const cv::Range stripeRange(0, nstripes);\n     const cv::Range wholeRange(0, h);\n \n     cv::Mat m(h, w, CV_8U);\n     m = 0;\n \n     // Look for a range that starts with odd value and ends with even value\n     cv::Range bugRange;\n     for (int s = stripeRange.start; s < stripeRange.end; s++) {\n         cv::Range sr(s, s + 1);\n         cv::Range r;\n         r.start = (int) (wholeRange.start +\n                          ((uint64) sr.start * (wholeRange.end - wholeRange.start) + nstripes / 2) / nstripes);\n         r.end = sr.end >= nstripes ?\n                     wholeRange.end :\n                     (int) (wholeRange.start +\n                            ((uint64) sr.end * (wholeRange.end - wholeRange.start) + nstripes / 2) / nstripes);\n \n         if (r.start > 0 && r.start % 2 == 1 && r.end % 2 == 0 && r.end >= r.start + 2) {\n             bugRange = r;\n             break;\n         }\n     }\n \n     if (bugRange.empty()) {\n         std::cout << \"Could not find a buggy range\\n\";\n         return m;\n     }\n \n     // Fill in bug Range\n     for (int x = 1; x < w; x++) {\n         m.at<char>(bugRange.start - 1, x) = 1;\n     }\n \n     m.at<char>(bugRange.start + 0, 0) = 1;\n     m.at<char>(bugRange.start + 0, 1) = 1;\n     m.at<char>(bugRange.start + 0, 3) = 1;\n     m.at<char>(bugRange.start + 1, 1) = 1;\n     m.at<char>(bugRange.start + 2, 1) = 1;\n     m.at<char>(bugRange.start + 2, 3) = 1;\n     m.at<char>(bugRange.start + 3, 0) = 1;\n     m.at<char>(bugRange.start + 3, 1) = 1;\n \n     return m;\n }\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "arnaudbrejeon", "commentT": "2020-01-23T00:02:40Z", "comment_text": "\n \t\tIt may not crash if the label buffer is set with zeros during allocation. The stats, will not be correct, though.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "arnaudbrejeon", "commentT": "2020-01-31T05:19:21Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  May I close the ticket?\n \t\t"}}}, "commit": {"commit_id": "ecbba852cff631d62f938c5bfeb5767d25220728", "commit_author": "Arnaud Brejeon", "commitT": "2020-01-29 23:55:43+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 17, "file_old_name": "modules\\imgproc\\src\\connectedcomponents.cpp", "file_new_name": "modules\\imgproc\\src\\connectedcomponents.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "276,277,278,279,280", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::stripeFirstLabel8Connectivity", "method_params": "y,w", "method_startline": "276", "method_endline": "280"}}, "hunk_1": {"Ismethod": 1, "added_lines": "484,486", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::SecondScan::operator ( )", "method_params": "range2", "method_startline": "484", "method_endline": "516"}}, "hunk_2": {"Ismethod": 1, "added_lines": "2562,2563,2566,2568,2570,2573,2574,2581,2582,2586,2590", "deleted_lines": "2545,2546,2549,2551,2553,2556,2557,2558,2565,2566,2570,2574", "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::operator ( )", "method_params": "img,imgLabels,connectivity,sop", "method_startline": "2542", "method_endline": "2596"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1905", "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::SecondScan::operator =", "method_params": "", "method_startline": "1905", "method_endline": "1905"}}, "hunk_4": {"Ismethod": 1, "added_lines": "269,270,271,272,273", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::stripeFirstLabel4Connectivity", "method_params": "y,w", "method_startline": "269", "method_endline": "273"}}, "hunk_5": {"Ismethod": 1, "added_lines": "857,859,862,864", "deleted_lines": "839,842,844,846", "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::FirstScan::operator ( )", "method_params": "range", "method_startline": "839", "method_endline": "1880"}}, "hunk_6": {"Ismethod": 1, "added_lines": "1923,1925,1927,1929", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::SecondScan::operator ( )", "method_params": "range2", "method_startline": "1923", "method_endline": "2482"}}, "hunk_7": {"Ismethod": 1, "added_lines": "301,303,305,308", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::FirstScan8Connectivity::operator ( )", "method_params": "range2", "method_startline": "301", "method_endline": "385"}}, "hunk_8": {"Ismethod": 1, "added_lines": "405,407,409,412", "deleted_lines": "465", "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::FirstScan4Connectivity::operator ( )", "method_params": "range2", "method_startline": "405", "method_endline": "466"}}, "hunk_9": {"Ismethod": 1, "added_lines": "618,621,622,624,626,633,636,639,644,647,650,655,659,660", "deleted_lines": "598,601,603,605,612,615,618,623,626,629,634,638,639,642,643,644", "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::operator ( )", "method_params": "img,imgLabels,connectivity,sop", "method_startline": "597", "method_endline": "664"}}, "hunk_10": {"Ismethod": 1, "added_lines": "405,407,409,412", "deleted_lines": "388,393", "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::FirstScan4Connectivity::operator ( )", "method_params": "range", "method_startline": "388", "method_endline": "447"}}, "hunk_11": {"Ismethod": 1, "added_lines": "301,303,305,308", "deleted_lines": "286,291", "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::FirstScan8Connectivity::operator ( )", "method_params": "range", "method_startline": "286", "method_endline": "368"}}, "hunk_12": {"Ismethod": 1, "added_lines": "692,693,695", "deleted_lines": "674,676,814", "method_info": {"method_name": "cv::connectedcomponents::LabelingWu::operator ( )", "method_params": "img,imgLabels,connectivity,sop", "method_startline": "673", "method_endline": "835"}}, "hunk_13": {"Ismethod": 1, "added_lines": "2621,2622,2623", "deleted_lines": "2605,2606,3914", "method_info": {"method_name": "cv::connectedcomponents::LabelingGrana::operator ( )", "method_params": "img,imgLabels,connectivity,sop", "method_startline": "2603", "method_endline": "3934"}}, "hunk_14": {"Ismethod": 1, "added_lines": "1923,1925,1927,1929", "deleted_lines": "1907,1910,1912", "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::SecondScan::operator ( )", "method_params": "range", "method_startline": "1907", "method_endline": "2465"}}, "hunk_15": {"Ismethod": 1, "added_lines": "857,859,862,864", "deleted_lines": null, "method_info": {"method_name": "cv::connectedcomponents::LabelingGranaParallel::FirstScan::operator ( )", "method_params": "range2", "method_startline": "857", "method_endline": "1898"}}, "hunk_16": {"Ismethod": 1, "added_lines": "484,486", "deleted_lines": "465", "method_info": {"method_name": "cv::connectedcomponents::LabelingWuParallel::SecondScan::operator ( )", "method_params": "range", "method_startline": "465", "method_endline": "496"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "modules\\imgproc\\test\\test_connectedcomponents.cpp", "file_new_name": "modules\\imgproc\\test\\test_connectedcomponents.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226", "deleted_lines": null, "method_info": {"method_name": "opencv_test::TEST", "method_params": "Imgproc_ConnectedComponents,parallel_wu_labels", "method_startline": "205", "method_endline": "226"}}, "hunk_1": {"Ismethod": 1, "added_lines": "154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203", "deleted_lines": null, "method_info": {"method_name": "opencv_test::createCrashMat", "method_params": "numThreads", "method_startline": "154", "method_endline": "203"}}}}}}}