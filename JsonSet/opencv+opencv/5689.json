{"BR": {"BR_id": "5689", "BR_author": "PkLab", "BRopenT": "2015-11-20T18:14:18Z", "BRcloseT": "2015-12-23T16:14:24Z", "BR_text": {"BRsummary": "Doc: Possible discrepancy for cvtColor RGB2Luv", "BRdescription": "\n The <denchmark-link:http://docs.opencv.org/3.0.0/de/d25/imgproc_color_conversions.html>doc</denchmark-link>\n  for cvtColor RGB ? CIE L_u_v*  doesn't look like the <denchmark-link:https://github.com/Itseez/opencv/blob/master/modules/imgproc/src/color.cpp#L5563>code</denchmark-link>\n \n The doc: L = 116Y ^(1/3)\n The code: L = 116Y''   -16\n may be should be clarified also:\n <denchmark-code>[R'G'B']<-[spline interpolation]\u00b7[RGB]\n [X'Y'Z']<-[CIED65 XYZ conversion matrix]\u00b7[R'G'B']\n Y''<-[spline interpolation]\u00b7Y'\n </denchmark-code>\n \n Spline interpolation operates some tricks on code but using the formula as is in the doc and comparing the 2 L you will have difference.\n Test code\n     cv::Mat_<cv::Vec3f> bgr(1, 1, cv::Vec3f(0.7, 0.7, 0.8));\n     cv::Mat_<cv::Vec3f> xyz(1, 1, cv::Vec3f(0.f, 0.f, 0.f));\n     cv::Mat_<cv::Vec3f> luv(1, 1, cv::Vec3f(0.f, 0.f, 0.f));\n     cv::Mat_<cv::Vec3f> lab(1, 1, cv::Vec3f(0.f, 0.f, 0.f));\n \n     cv::cvtColor(bgr, xyz, CV_BGR2XYZ);\n     cv::cvtColor(bgr, luv, CV_BGR2Luv);\n     cv::cvtColor(bgr, lab, CV_BGR2Lab);\n \n     clog << \"BGR:\\t\" << bgr << endl;\n     clog << \"XYZ:\\t\" << xyz << endl;\n     clog << \"Luv:\\t\" << luv << endl;\n     clog << \"Lab:\\t\" << lab << endl;\n     clog << endl;\n \n     float Y, L;\n     Y = xyz(0, 0)[1];\n     L = 116.0 * pow(Y, 1 / 3.0);\n \n     clog << \"      L(Y):\\t\" << L << endl;\n     clog << \" L(Y) - 16:\\t\" << L - 16 << endl;\n     L = luv(0, 0)[0];\n     clog << \"L from Luv:\\t\" << L << endl;\n     L = lab(0, 0)[0];\n     clog << \"L from Lab:\\t\" << L << endl;\n Output\n <denchmark-code>BGR:    [0.69999999, 0.69999999, 0.80000001]\n XYZ:    [0.70656455, 0.7212671, 0.76406127]\n Luv:    [74.896202, 15.300271, 3.3003368]\n Lab:    [74.896194, 9.1452894, 3.3699393]\n \n       L(Y): 104.03  << as the doc for RGB2Luv\n  L(Y) - 16: 88.0295 << as the doc for RGB2Lab\n L from Luv: 74.8962\n L from Lab: 74.8962\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "PkLab", "commentT": "2015-11-30T03:30:15Z", "comment_text": "\n \t\tWow,I met <denchmark-link:http://answers.opencv.org/question/76503/may-i-ask-why-i-get-the-wrong-answer-about-rgb2luv/?answer=76549#post-id-76549>the problem</denchmark-link>\n  a few days ago.\n I use cv2.  mytest is  [199,187,187] ,\n matlab:\n <denchmark-code>function luvim = rgb2luv_im(im)\n \n if size(im,3) ~= 3\n     error('im must have three color channels');\n end\n if ~isa(im,'float')\n     im = im2single(im);\n end\n if (max(im(:)) > 1)\n     im = im./255;\n end\n \n XYZ = [.4125 .3576 .1804; .2125 .7154 .0721; .0193 .1192 .9502];\n Yn = 1.0;\n Lt = .008856;\n Up = 0.19784977571475;\n Vp = 0.46834507665248;\n imsiz = size(im);\n im = permute(im,[3 1 2]);\n im = reshape(im,[3 prod(imsiz(1:2))]);\n xyz = reshape((XYZ*im)',imsiz);\n x = xyz(:,:,1);\n y = xyz(:,:,2);\n z = xyz(:,:,3);\n \n l0 = y./Yn;\n l = l0;\n l(l0>Lt) = 116.*(l0(l0>Lt).^(1/3)) - 16;\n l(l0<=Lt) = 903.3*l0(l0<=Lt);\n c = x + 15*y + 3 * z;\n u = 4*ones(imsiz(1:2),class(im));\n v = (9/15)*ones(imsiz(1:2),class(im));\n u(c~=0) = 4*x(c~=0)./c(c~=0);\n v(c~=0) = 9*y(c~=0)./c(c~=0);\n \n u = 13*l.*(u-Up);\n v = 13*l.*(v-Vp);\n \n luvim = cat(3,l,u,v);\n </denchmark-code>\n \n if use cv2 make rgb2xyz than xyz2luv by myself.\n <denchmark-code>    x=im_xyz[0]\n     y=im_xyz[1]\n     z=im_xyz[2]\n     L=116.0*y**(1./3)-16 if y > 0.008856 else 903.3*y\n     Un_prime = 0.19784977571475; \n     Vn_prime = 0.46834507665248;\n     u_prime=0\n     v_prime=0\n     constant=(x+15.0*y+3.0*z)\n     if constant!=0:\n         u_prime = 4.0*x/constant\n         v_prime = 9.0*y/constant\n     u=13.0*L*(u_prime-Un_prime)\n     v=13.0*L*(v_prime-Vn_prime)\n     return np.array([L,u,v]) \n </denchmark-code>\n \n the result of L is 89 , but if you use rgb2luv , the result is [76.84296417, 6.9851861 , 1.50677502],\n oh kill me!\n then i try a photo\n <denchmark-link:https://cloud.githubusercontent.com/assets/11959047/11462814/34cdb052-9754-11e5-8a39-1f9983623eb4.jpg></denchmark-link>\n \n compare to the photoshop\n <denchmark-link:https://cloud.githubusercontent.com/assets/11959047/11462803/0161e6b6-9754-11e5-8846-b8f39581bc47.jpg></denchmark-link>\n \n and the matlab\n <denchmark-link:https://cloud.githubusercontent.com/assets/11959047/11462810/1b43f092-9754-11e5-98c2-fc500799d76f.jpg></denchmark-link>\n \n and the opencv rgb2luv\n <denchmark-link:https://cloud.githubusercontent.com/assets/11959047/11462901/a186a126-9755-11e5-8055-8c24a098baaf.png></denchmark-link>\n \n why photoshop is similar to the result of opencv?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "PkLab", "commentT": "2015-11-30T08:32:08Z", "comment_text": "\n \t\tAlready answered! Becuase matlab code  is a simpification, maybe your conversion function is unofficial, just an user file from FileExcange (<denchmark-link:http://www.mathworks.com/matlabcentral/fileexchange/19406-3d-stereo-disparity/content/lankton_stereo/msseg/RGB2Luv.m>http://www.mathworks.com/matlabcentral/fileexchange/19406-3d-stereo-disparity/content/lankton_stereo/msseg/RGB2Luv.m</denchmark-link>\n )?\n It looks OpenCV, like photoshop, uses more accurate conversion to encode values based on human perception: L = splineinterpolation(Y,LabCbrtTab...\n I think issue is just related to the doc.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "PkLab", "commentT": "2015-11-30T17:25:57Z", "comment_text": "\n \t\ti know it.is not official.but it is the same with the doc. so i feel confuzed with the result when compared to the result of opencv. i agree with the doc problem, hope it can be more clear.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "PkLab", "commentT": "2016-01-08T17:18:25Z", "comment_text": "\n \t\tPleae note that the <denchmark-link:https://github.com/Itseez/opencv/blob/master/modules/imgproc/src/color.cpp#L5577>code</denchmark-link>\n  operates someting different from the doc\n //The (new) doc\n L = 116 * Y^(1/3) - 16 \n //The code: L = 116 * Yi -16\n L0 = splineInterpolate(Y*LabCbrtTabScale, LabCbrtTab, LAB_CBRT_TAB_SIZE);\n L = 116 * L0 - 16;\n //where L0 <> Y ^(1/3)\n You can see the difference using my test code and its previous output\n <denchmark-code>Y from BGR2XYZ = 0.7212671\n L = 116 * Y^(1/3) - 16 = 88.092\n L from  BGR2Luv = 74.8962\n </denchmark-code>\n \n This is the same for BGR2Lab\n \t\t"}}}, "commit": {"commit_id": "a7d3e3040472edf4f45661747540f79fb0ceb233", "commit_author": "Dikay900", "commitT": "2015-12-22 22:45:51+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "modules\\imgproc\\doc\\colors.markdown", "file_new_name": "modules\\imgproc\\doc\\colors.markdown", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "126", "deleted_lines": "126"}}}}}}