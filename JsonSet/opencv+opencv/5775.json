{"BR": {"BR_id": "5775", "BR_author": "rvogt", "BRopenT": "2015-12-09T12:45:13Z", "BRcloseT": "2016-07-20T13:42:39Z", "BR_text": {"BRsummary": "arithm_op: wrong data length for actualScalarDepth()", "BRdescription": "\n Hi,\n i sometimes got an exception when calling subtract(255, srcImage, destImage), where srcImage is of type CV_8UC3.\n I think i found the bug at a quite central position, so it would be great if someone responsible could verify and fix it:\n core/arithm.cpp in function arithm_op\n ...\n if( dims1 != dims2 || sz1 != sz2 || cn != cn2 ||\n         (kind1 == _InputArray::MATX && (sz1 == Size(1,4) || sz1 == Size(1,1))) ||\n         (kind2 == _InputArray::MATX && (sz2 == Size(1,4) || sz2 == Size(1,1))) )\n {\n     if( checkScalar(*psrc1, type2, kind1, kind2) )\n     {\n         // src1 is a scalar; swap it with src2\n         swap(psrc1, psrc2);\n         swap(sz1, sz2);\n         swap(type1, type2);\n         swap(depth1, depth2);\n         swap(cn, cn2);\n         swap(dims1, dims2);\n         swapped12 = true;\n         if( oclop == OCL_OP_SUB )\n             oclop = OCL_OP_RSUB;\n         if ( oclop == OCL_OP_DIV_SCALE )\n             oclop = OCL_OP_RDIV_SCALE;\n     }\n     else if( !checkScalar(*psrc2, type1, kind2, kind1) )\n         CV_Error( CV_StsUnmatchedSizes,\n                  \"The operation is neither 'array op array' \"\n                  \"(where arrays have the same size and the same number of channels), \"\n                  \"nor 'array op scalar', nor 'scalar op array'\" );\n     haveScalar = true;\n     CV_Assert(type2 == CV_64F && (sz2.height == 1 || sz2.height == 4));\n \n     if (!muldiv)\n     {\n         Mat sc = psrc2->getMat();\n         depth2 = actualScalarDepth(sc.ptr<double>(), cn);    // <== cn should be cn2\n         if( depth2 == CV_64F && (depth1 < CV_32S || depth1 == CV_32F) )\n             depth2 = CV_32F;\n     }\n     else\n         depth2 = CV_64F;\n }\n ...\n I think, the line\n depth2 = actualScalarDepth(sc.ptr<double>(), cn);\n should be changed to\n depth2 = actualScalarDepth(sc.ptr<double>(), cn2);\n In my case, initially cn = 1 and cn2 = 3, then after swapping cn = 3.\n This leads to an invalid memory access behind my scalar in the actualScalarDepth function:\n static int actualScalarDepth(const double* data, int len)\n {\n     int i = 0, minval = INT_MAX, maxval = INT_MIN;\n     for(; i < len; ++i)\n     {\n         int ival = cvRound(data[i]);\n         if( ival != data[i] )\n             break;\n         minval = MIN(minval, ival);\n         maxval = MAX(maxval, ival);\n     }\n     return i < len ? CV_64F :\n         minval >= 0 && maxval <= (int)UCHAR_MAX ? CV_8U :\n         minval >= (int)SCHAR_MIN && maxval <= (int)SCHAR_MAX ? CV_8S :\n         minval >= 0 && maxval <= (int)USHRT_MAX ? CV_16U :\n         minval >= (int)SHRT_MIN && maxval <= (int)SHRT_MAX ? CV_16S :\n         CV_32S;\n }\n If there is a NAN at data[1] or data[2], cvRound() throws an exception\n \t"}, "comments": {}}, "commit": {"commit_id": "71cbd6f02eb4480970d38ed08132e8b9e5503b05", "commit_author": "Ilya Lavrenov", "commitT": "2016-07-20 11:38:15+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\core\\src\\arithm.cpp", "file_new_name": "modules\\core\\src\\arithm.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "646", "deleted_lines": "646", "method_info": {"method_name": "cv::arithm_op", "method_params": "_src1,_src2,_dst,_mask,dtype,tab,muldiv,usrdata,oclop", "method_startline": "578", "method_endline": "855"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "modules\\core\\test\\test_arithm.cpp", "file_new_name": "modules\\core\\test\\test_arithm.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1914,1915,1916,1917,1918,1919,1920,1921", "deleted_lines": null, "method_info": {"method_name": "TEST", "method_params": "Subtract,scalarc1_matc3", "method_startline": "1914", "method_endline": "1921"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1923,1924,1925,1926,1927,1928,1929,1930", "deleted_lines": null, "method_info": {"method_name": "TEST", "method_params": "Subtract,scalarc4_matc4", "method_startline": "1923", "method_endline": "1930"}}}}}}}