{"BR": {"BR_id": "5730", "BR_author": "peters", "BRopenT": "2015-12-01T19:30:26Z", "BRcloseT": "2016-02-04T19:33:38Z", "BR_text": {"BRsummary": "Indefinite hang when connecting to a rtsp stream", "BRdescription": "\n Built latest version from HEAD with ffmpeg support enabled on Windows 10.\n When you connect to a rtsp stream and the resource (read: the streaming server) is unavailable an indefinite hang on Windows is observed.\n I've done some initial research and if you want to handle transient connection issues you need to specify a interrupt callback as per <denchmark-link:https://ffmpeg.org/doxygen/2.7/structAVFormatContext.html#a5b37acfe4024d92ee510064e80920b40>documentation</denchmark-link>\n  before  is called.\n Digging through their bug tracker i found a related <denchmark-link:https://trac.ffmpeg.org/ticket/2694>issue</denchmark-link>\n  submitted about two years ago.\n Repo:\n auto vc = new cv::VideoCapture();\n auto success = vc->open(\"rstp://192.168.1.200/media/video1\");\n // -- indefinite hang\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "peters", "commentT": "2015-12-01T21:05:20Z", "comment_text": "\n \t\tAttaching with a debugger shows that the hang is located at <denchmark-link:https://github.com/Itseez/opencv/blob/master/modules/videoio/src/cap_ffmpeg.cpp#L201>https://github.com/Itseez/opencv/blob/master/modules/videoio/src/cap_ffmpeg.cpp#L201</denchmark-link>\n  which again refers to <denchmark-link:https://github.com/Itseez/opencv/blob/master/modules/videoio/src/cap_ffmpeg_impl.hpp#L582>https://github.com/Itseez/opencv/blob/master/modules/videoio/src/cap_ffmpeg_impl.hpp#L582</denchmark-link>\n \n I built ffmpeg using this <denchmark-link:https://github.com/Itseez/opencv_3rdparty/tree/ffmpeg/master>docker container</denchmark-link>\n  but i'm unsure how to generate a pdb for the generated dll.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "peters", "commentT": "2015-12-01T21:53:37Z", "comment_text": "\n \t\tAccording to this <denchmark-link:http://plagatux.es/2012/08/skipping-blocking-libav-functions-with-interruption-callbacks/>article</denchmark-link>\n  you have to supply an interrupt callback, otherwise you'll be stuck since the socket will block indefinitely.\n I did a quick test by adding the callback (5 second timeout) where the timestamp value is updated everytime we are able to read a frame from the stream.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "peters", "commentT": "2016-01-12T10:07:41Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mshabunin>@mshabunin</denchmark-link>\n  Is it possible to hire a opencv developer (from the foundation) or make a donation in order to get a fix landed for this issue?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "peters", "commentT": "2016-01-12T13:18:30Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/peters>@peters</denchmark-link>\n , unfortunately, right now we do not have a working mechanism for handling individual bug reports on commercial basis. We either do more or less big projects (a few man-months at least), or let community fix the bug and accept the patches in the form of pull requests, or fix the bugs ourselves \"for free\" when we can reproduce it and when it's critical for our own projects. In this particular case I believe all we can do in the short term is to integrate a patch from community.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "peters", "commentT": "2016-01-12T20:52:08Z", "comment_text": "\n \t\tThat's understandable, thanks for letting me know :)\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "peters", "commentT": "2016-01-30T13:55:57Z", "comment_text": "\n \t\tThis also applies if the stream goes away (network interruption) when you are connected.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "peters", "commentT": "2016-01-30T14:05:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  <denchmark-link:https://github.com/vpisarev>@vpisarev</denchmark-link>\n  I just posted a 500$ bounty <denchmark-link:https://www.bountysource.com/issues/28757855-indefinite-hang-when-connecting-to-a-rtsp-stream>https://www.bountysource.com/issues/28757855-indefinite-hang-when-connecting-to-a-rtsp-stream</denchmark-link>\n . Would you be so kind to ask if anyone on your team would like to claim it on their spare time?\n If they don't have the time is it appropiate to advertise the bounty on your mailinglist?\n The fix  be fairly trivial according to this comment <denchmark-link:https://github.com/opencv/opencv/issues/5730#issuecomment-161107510>#5730 (comment)</denchmark-link>\n .\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "peters", "commentT": "2016-02-02T20:20:39Z", "comment_text": "\n \t\t\n I did a quick test by adding the callback (5 second timeout) where the timestamp value is updated everytime we are able to read a frame from the stream.\n \n What was the test patch you added!\n let me see if i can help on this if it will not toke time.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "peters", "commentT": "2016-02-03T00:05:06Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Maroc-OS>@Maroc-OS</denchmark-link>\n  Thanks for the interest in fixing this issue, but I just landed a PR.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "peters", "commentT": "2016-02-03T00:14:53Z", "comment_text": "\n \t\t:) anytime <denchmark-link:https://github.com/peters>@peters</denchmark-link>\n  and good work\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "peters", "commentT": "2016-02-03T00:28:46Z", "comment_text": "\n \t\tThanks \ud83d\udc6f\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "peters", "commentT": "2017-09-15T22:45:04Z", "comment_text": "\n \t\tHi Peter,\n is it possible to change timeout value without changing it inside the source?\n I am using opencv_ffmeg.dll.\n Can I access it as a property or via function?\n Otherwise I have to change the timeout value in source and build the dll again.\n Thanks\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "peters", "commentT": "2017-09-17T10:53:29Z", "comment_text": "\n \t\thi, i changed the timeout property inside the source but nothing changed.\n infact i was building opencv using cmake. afterthat i noticed that this building takes ffmeg prebuilt binaries hence my code change isnt compiled via this method.\n So how can i rebuild opencv_ffmeg.dll?\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "peters", "commentT": "2017-09-18T15:53:31Z", "comment_text": "\n \t\t\n So how can i rebuild opencv_ffmeg.dll?\n \n You need any Linux (Ubuntu is OK) with installed git/<denchmark-link:https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/>docker</denchmark-link>\n .\n Clone repository and run <denchmark-link:https://github.com/opencv/opencv_3rdparty/blob/ffmpeg/master/build_update.sh>build_update.sh script</denchmark-link>\n :\n <denchmark-code>git clone -b ffmpeg/master --depth=100 --recursive https://github.com/opencv/opencv_3rdparty.git\n cd opencv_3rdparty\n ./build_update.sh\n </denchmark-code>\n \n In case of custom OpenCV build (your case) you need to use BUILD_SKIP_OPENCV_UPDATE=1 environment variable (before you should commit your changes into \"opencv\" sub-directory):\n <denchmark-code>BUILD_SKIP_OPENCV_UPDATE=1 ./build_update.sh\n </denchmark-code>\n \n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "peters", "commentT": "2017-09-18T19:16:49Z", "comment_text": "\n \t\tThanks Alex,\n I am building on debian. I didnt clone the opencv but already copied the source package under the opencv folder of your structure.\n Infact, the things were going good but \"make\" arised\n \"Error: openh264 not found by pkg-config\" message.\n And docker isnt installed on my system. Is the docker compulsory and what about the message above?\n \t\t"}}}, "commit": {"commit_id": "da48061910db0ee78396237bc78d6f2e321ea5eb", "commit_author": "Peter Rekdal Sunde", "commitT": "2016-02-04 18:09:14+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 10, "file_old_name": "modules\\videoio\\src\\cap_ffmpeg_impl.hpp", "file_new_name": "modules\\videoio\\src\\cap_ffmpeg_impl.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "267,268,269,270,271,272,273,274,275,276,277,278,279,280", "deleted_lines": null, "method_info": {"method_name": "get_monotonic_time", "method_params": "time", "method_startline": "267", "method_endline": "280"}}, "hunk_1": {"Ismethod": 1, "added_lines": "203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221", "deleted_lines": null, "method_info": {"method_name": "get_filetime_offset", "method_params": "", "method_startline": "203", "method_endline": "221"}}, "hunk_2": {"Ismethod": 1, "added_lines": "371,372,373,374,375,376,377,378,379,380,381,382", "deleted_lines": null, "method_info": {"method_name": "_opencv_ffmpeg_interrupt_callback", "method_params": "ptr", "method_startline": "371", "method_endline": "382"}}, "hunk_3": {"Ismethod": 1, "added_lines": "738,739,740,741,742,743,744,745", "deleted_lines": null, "method_info": {"method_name": "CvCapture_FFMPEG::open", "method_params": "_filename", "method_startline": "731", "method_endline": "834"}}, "hunk_4": {"Ismethod": 1, "added_lines": "283,284,285,286,287,288,289,290,291,292,293,294,295,296,297", "deleted_lines": null, "method_info": {"method_name": "get_monotonic_time_diff", "method_params": "start,end", "method_startline": "283", "method_endline": "297"}}, "hunk_5": {"Ismethod": 1, "added_lines": "858,859,860,861,862,863,864,900,901,902", "deleted_lines": null, "method_info": {"method_name": "CvCapture_FFMPEG::grabFrame", "method_params": "", "method_startline": "837", "method_endline": "917"}}, "hunk_6": {"Ismethod": 1, "added_lines": "2624,2625,2626,2627,2628,2634,2635,2636", "deleted_lines": null, "method_info": {"method_name": "InputMediaStream_FFMPEG::read", "method_params": "data,size,endOfFile", "method_startline": "2615", "method_endline": "2658"}}, "hunk_7": {"Ismethod": 1, "added_lines": "299,300,301,302,303,304,305", "deleted_lines": null, "method_info": {"method_name": "get_monotonic_time_diff_ms", "method_params": "time1,time2", "method_startline": "299", "method_endline": "305"}}, "hunk_8": {"Ismethod": 1, "added_lines": "223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265", "deleted_lines": null, "method_info": {"method_name": "get_monotonic_time", "method_params": "tv", "method_startline": "223", "method_endline": "265"}}, "hunk_9": {"Ismethod": 1, "added_lines": "2500,2501,2502,2503,2504,2505,2506,2507", "deleted_lines": null, "method_info": {"method_name": "InputMediaStream_FFMPEG::open", "method_params": "fileName,codec,chroma_format,width,height", "method_startline": "2492", "method_endline": "2597"}}}}}}}