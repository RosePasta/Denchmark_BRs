{"BR": {"BR_id": "2673", "BR_author": "senarvi", "BRopenT": "2020-09-29T07:51:05Z", "BRcloseT": "2020-10-01T19:37:30Z", "BR_text": {"BRsummary": "Full-context alignment is broken in transformer_align model", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n transformer_align model, which implements the \"Jointly Learning to Align and Translate\" paper, supports full-context alignment, meaning that the auto-regressive mask is not applied to decoder self-attention. This feature is broken in the current master. When the --full-context-alignment flag is given to the model, it produces the error message\n <denchmark-code>TypeError: forward() got an unexpected keyword argument 'full_context_alignment'\n </denchmark-code>\n \n in the <denchmark-link:https://github.com/pytorch/fairseq/blob/master/fairseq/models/transformer_align.py#L69>forward_decoder() method of TransformerAlignModel</denchmark-link>\n . As far as I can see, this happens because the <denchmark-link:https://github.com/pytorch/fairseq/blob/master/fairseq/models/transformer.py#L638>forward() method of TransformerDecoder</denchmark-link>\n  doesn't have the  argument anymore, that was passed to the extract_features() method by the <denchmark-link:https://github.com/pytorch/fairseq/blob/1c6679294848f303a361cba7b306b760e299bd9c/fairseq/models/transformer.py#L514>version of the code at the time the transformer_align model was merged</denchmark-link>\n .\n Ideally the <denchmark-link:https://github.com/pytorch/fairseq/blob/master/tests/test_binaries.py#L428>test_alignment() unit test</denchmark-link>\n  would also be updated to test this feature.\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Follow the <denchmark-link:https://github.com/pytorch/fairseq/blob/master/examples/joint_alignment_translation/README.md>instructions</denchmark-link>\n , but additionally give the  flag to fairseq-train. It produces the following error message and stack trace:\n <denchmark-code>Traceback (most recent call last):\n   File \".../bin/fairseq-train\", line 11, in <module>\n     load_entry_point('fairseq', 'console_scripts', 'fairseq-train')()\n   File \".../fairseq_cli/train.py\", line 351, in cli_main\n     distributed_utils.call_main(args, main)\n   File \".../fairseq/distributed_utils.py\", line 254, in call_main\n     main(args, **kwargs)\n   File \".../fairseq_cli/train.py\", line 125, in main\n     valid_losses, should_stop = train(args, trainer, task, epoch_itr)\n   File \"/usr/lib64/python3.6/contextlib.py\", line 52, in inner\n     return func(*args, **kwds)\n   File \".../fairseq_cli/train.py\", line 207, in train\n     log_output = trainer.train_step(samples)\n   File \"/usr/lib64/python3.6/contextlib.py\", line 52, in inner\n     return func(*args, **kwds)\n   File \".../fairseq/trainer.py\", line 479, in train_step\n     ignore_grad=is_dummy_batch,\n   File \".../fairseq/tasks/fairseq_task.py\", line 408, in train_step\n     loss, sample_size, logging_output = criterion(model, sample)\n   File \".../lib64/python3.6/site-packages/torch/nn/modules/module.py\", line 722, in _call_impl\n     result = self.forward(*input, **kwargs)\n   File \".../fairseq/criterions/label_smoothed_cross_entropy_with_alignment.py\", line 36, in forward\n     net_output = model(**sample['net_input'])\n   File \".../lib64/python3.6/site-packages/torch/nn/modules/module.py\", line 722, in _call_impl\n     result = self.forward(*input, **kwargs)\n   File \".../fairseq/models/transformer_align.py\", line 51, in forward\n     return self.forward_decoder(prev_output_tokens, encoder_out)\n   File \".../fairseq/models/transformer_align.py\", line 75, in forward_decoder\n     **extra_args,\n   File \".../lib64/python3.6/site-packages/torch/nn/modules/module.py\", line 722, in _call_impl\n     result = self.forward(*input, **kwargs)\n TypeError: forward() got an unexpected keyword argument 'full_context_alignment'\n </denchmark-code>\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n I expect fairseq-train to start training the model, like it does when I don't give the --full-context-alignment flag, but alignment supervised conditioned on the full target context.\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n fairseq Version (e.g., 1.0 or master): master\n PyTorch Version (e.g., 1.0): 1.6.0\n OS (e.g., Linux): Linux\n How you installed fairseq (pip, source): pip\n Python version: 3.6.8\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "senarvi", "commentT": "2020-09-29T17:00:20Z", "comment_text": "\n \t\tI assume this is how to fix it: <denchmark-link:https://github.com/pytorch/fairseq/pull/2675>#2675</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "c049749c7a7c08cca9e4663c85bd3961f4b260f8", "commit_author": "Seppo Enarvi", "commitT": "2020-10-01 12:37:16-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "fairseq\\models\\transformer.py", "file_new_name": "fairseq\\models\\transformer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "644", "deleted_lines": null, "method_info": {"method_name": "forward", "method_params": "self,prev_output_tokens,None,str,str,None,bool,bool,None,None,None,bool", "method_startline": "638", "method_endline": "648"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "fairseq\\models\\transformer_align.py", "file_new_name": "fairseq\\models\\transformer_align.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "35", "deleted_lines": "35", "method_info": {"method_name": "add_args", "method_params": "parser", "method_startline": "28", "method_endline": "36"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "fairseq\\sequence_generator.py", "file_new_name": "fairseq\\sequence_generator.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "955", "deleted_lines": "955", "method_info": {"method_name": "forward_align", "method_params": "self,src_tokens,src_lengths,prev_output_tokens", "method_startline": "951", "method_endline": "962"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\test_binaries.py", "file_new_name": "tests\\test_binaries.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471", "deleted_lines": null, "method_info": {"method_name": "test_alignment_full_context", "method_params": "self", "method_startline": "455", "method_endline": "475"}}, "hunk_1": {"Ismethod": 1, "added_lines": "449,450,451,452,453", "deleted_lines": "449", "method_info": {"method_name": "test_alignment", "method_params": "self", "method_startline": "434", "method_endline": "453"}}}}}}}