{"BR": {"BR_id": "2695", "BR_author": "hlncrg", "BRopenT": "2020-10-05T17:10:02Z", "BRcloseT": "2020-10-17T16:40:06Z", "BR_text": {"BRsummary": "Error when running fairseq-generate with both 'score-reference' and 'print-alignment'", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n I am running the flag --print-alignment and --score-reference together and getting an error.\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n I am following the example 'Jointly Learning to Align and Translate with Transformer Models':\n <denchmark-link:https://github.com/pytorch/fairseq/tree/master/examples/joint_alignment_translation>https://github.com/pytorch/fairseq/tree/master/examples/joint_alignment_translation</denchmark-link>\n \n I am running the command to generate answers on a test set:\n fairseq-generate \n binarized --gen-subset test --print-alignment \n --source-lang en --target-lang de \n --path checkpoints/checkpoint_best.pt --beam 5 --nbest 1 \n --score-reference\n The error that I get is the following:\n raceback (most recent call last):\n File \"/usr/local/bin/fairseq-generate\", line 11, in\n load_entry_point('fairseq', 'console_scripts', 'fairseq-generate')()\n File \"/home/hecraig/fairseq/fairseq_cli/generate.py\", line 286, in cli_main\n main(args)\n File \"/home/hecraig/fairseq/fairseq_cli/generate.py\", line 38, in main\n return _main(args, sys.stdout)\n File \"/home/hecraig/fairseq/fairseq_cli/generate.py\", line 233, in _main\n ' '.join(['{}-{}'.format(src_idx, tgt_idx) for src_idx, tgt_idx in alignment])\n TypeError: 'NoneType' object is not iterable\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n If I understand correctly, I would expect the output to be the alignments given the source and target sentences.\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n fairseq Version (e.g., 1.0 or master): master\n PyTorch Version (e.g., 1.0): 1.6\n OS (e.g., Linux): Linux\n How you installed fairseq (pip, source): pip\n Python version: 3.6\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n The command works if either 'score-reference' or 'print-alignment' are not included.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hlncrg", "commentT": "2020-10-09T23:38:22Z", "comment_text": "\n \t\tThe issue seems to be with this line:\n \n \n \n fairseq/fairseq/sequence_scorer.py\n \n \n          Line 90\n       in\n       bf06ca7\n \n \n \n \n \n \n  if attn is not None and torch.is_tensor(attn): \n \n \n \n \n \n <denchmark-code>        if attn is not None and torch.is_tensor(attn):\n             attn = attn.data\n             if avg_attn is None:\n                 avg_attn = attn\n             else:\n                 avg_attn.add_(attn)\n </denchmark-code>\n \n Where avg_attn is not given a value since  torch.is_tensor(attn) is false.\n \t\t"}}}, "commit": {"commit_id": "f910ea9d4cf9c9964ec307dde3144622c4b61e62", "commit_author": "Helen Craig", "commitT": "2020-10-13 08:07:33-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "fairseq\\sequence_scorer.py", "file_new_name": "fairseq\\sequence_scorer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "90,91,92,93,94", "deleted_lines": "90,91", "method_info": {"method_name": "generate", "method_params": "self,models,sample,kwargs", "method_startline": "29", "method_endline": "136"}}}}}}}