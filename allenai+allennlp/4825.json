{"BR": {"BR_id": "4825", "BR_author": "aleSuglia", "BRopenT": "2020-11-30T15:18:25Z", "BRcloseT": "2020-12-04T17:27:21Z", "BR_text": {"BRsummary": "ShardedDatasetReader doesn't inherit lazy from base reader", "BRdescription": "\n <denchmark-h:h2>Checklist</denchmark-h>\n \n \n  I have verified that the issue exists against the master branch of AllenNLP.\n  I have read the relevant section in the contribution guide on reporting bugs.\n  I have checked the issues list for similar or identical bug reports.\n  I have checked the pull requests list for existing proposed fixes.\n  I have checked the CHANGELOG and the commit log to find out if the bug was already fixed in the master branch.\n  I have included in the \"Description\" section below a traceback from any exceptions related to this bug.\n  I have included in the \"Related issues or possible duplicates\" section beloew all related issues and possible duplicate issues (If there are none, check this box anyway).\n  I have included in the \"Environment\" section below the name of the operating system and Python version that I was using when I discovered this bug.\n  I have included in the \"Environment\" section below the output of pip freeze.\n  I have included in the \"Steps to reproduce\" section below a minimally reproducible example.\n \n <denchmark-h:h2>Description</denchmark-h>\n \n Currently the ShardedDatasetReader doesn't inherit the lazy property from the base_reader. Therefore, the dataset reader becomes not lazy anymore.\n \n Python traceback:\n \n Processed killed for insufficient RAM\n \n \n \n <denchmark-h:h2>Related issues or possible duplicates</denchmark-h>\n \n \n None\n \n <denchmark-h:h2>Environment</denchmark-h>\n \n OS: OS X\n Python version: Python 3.8.5\n \n Output of pip freeze:\n \n allennlp==1.2.2\n attrs==20.3.0\n beautifulsoup4 @ file:///tmp/build/80754af9/beautifulsoup4_1601924105527/work\n blis==0.7.3\n boto3==1.16.25\n botocore==1.19.25\n catalogue==1.0.0\n certifi==2020.11.8\n chardet==3.0.4\n click==7.1.2\n cymem==2.0.4\n en-core-web-sm @ https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-2.3.1/en_core_web_sm-2.3.1.tar.gz\n filelock==3.0.12\n future==0.18.2\n h5py==3.1.0\n idna==2.10\n importlib-metadata==3.1.0\n iniconfig==1.1.1\n jmespath==0.10.0\n joblib==0.17.0\n jsonlines==1.2.0\n jsonnet==0.17.0\n jsonpickle==1.4.1\n lxml==4.6.2\n murmurhash==1.0.4\n nltk==3.5\n numpy==1.19.4\n overrides==3.1.0\n packaging==20.4\n plac==1.1.3\n pluggy==0.13.1\n preshed==3.0.4\n protobuf==3.14.0\n py==1.9.0\n pyparsing==2.4.7\n pytest==6.1.2\n python-dateutil==2.8.1\n regex==2020.11.13\n requests==2.25.0\n s3transfer==0.3.3\n sacremoses==0.0.43\n scikit-learn==0.23.2\n scipy==1.5.4\n sentencepiece==0.1.91\n six==1.15.0\n soupsieve==2.0.1\n spacy==2.3.4\n srsly==1.0.4\n tensorboardX==2.1\n thinc==7.4.3\n threadpoolctl==2.1.0\n tokenizers==0.9.3\n toml==0.10.2\n torch==1.7.0\n tqdm==4.54.0\n transformers==3.5.1\n typing-extensions==3.7.4.3\n urllib3==1.26.2\n wasabi==0.8.0\n zipp==3.4.0\n \n \n \n <denchmark-h:h2>Steps to reproduce</denchmark-h>\n \n \n Example source:\n \n For any model training using a ShardedDatasetReader this configuration file will not set the lazy property for it:\n  \"dataset_reader\" : {\n         \"type\": \"sharded\",\n         \"base_reader\": {\n             \"type\": \"wiki_er\",\n             \"token_indexers\": {\n                 \"tokens\": {\n                     \"type\": \"pretrained_transformer_mismatched\",\n                     \"model_name\": model_name\n                 }\n             },\n             \"lazy\": true\n         }\n     }\n \n while this one will work:\n  \"dataset_reader\" : {\n         \"type\": \"sharded\",\n         \"base_reader\": {\n             \"type\": \"wiki_er\",\n             \"token_indexers\": {\n                 \"tokens\": {\n                     \"type\": \"pretrained_transformer_mismatched\",\n                     \"model_name\": model_name\n                 }\n             }\n         },\n         \"lazy\": true\n     }\n \n \n \n I believe that a fix for this issue can be implemented by following this rule: if the ShardedDatasetReader sets the lazy parameter, then use it. If it doesn't then inherit from base_reader.\n In general, looks like this is true also for other DatasetReader parameters like max_instances.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "aleSuglia", "commentT": "2020-11-30T17:07:54Z", "comment_text": "\n \t\t\n I believe that a fix for this issue can be implemented by following this rule: if the ShardedDatasetReader sets the lazy parameter, then use it. If it doesn't then inherit from base_reader.\n \n This seems like a good solution. Would you like to make a PR for this <denchmark-link:https://github.com/aleSuglia>@aleSuglia</denchmark-link>\n ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "aleSuglia", "commentT": "2020-11-30T17:10:06Z", "comment_text": "\n \t\tHappy to do it. I can work on it later today.\n \t\t"}}}, "commit": {"commit_id": "3e6236589bb18777ba966cad5d1c2d56f25b2aee", "commit_author": "Alessandro Suglia", "commitT": "2020-12-01 20:02:38-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "17,19", "deleted_lines": "17,19"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "allennlp\\data\\dataset_readers\\sharded_dataset_reader.py", "file_new_name": "allennlp\\data\\dataset_readers\\sharded_dataset_reader.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "44,45,46,47,48,49", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,DatasetReader,kwargs", "method_startline": "43", "method_endline": "70"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\data\\dataset_readers\\sharded_dataset_reader_test.py", "file_new_name": "tests\\data\\dataset_readers\\sharded_dataset_reader_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "104,105,106,107,108,109,110", "deleted_lines": null, "method_info": {"method_name": "test_set_attributes_main", "method_params": "self", "method_startline": "104", "method_endline": "110"}}, "hunk_1": {"Ismethod": 1, "added_lines": "95,96,97,98,99,100,101,102", "deleted_lines": null, "method_info": {"method_name": "test_attributes_inheritance", "method_params": "self", "method_startline": "95", "method_endline": "102"}}}}}}}