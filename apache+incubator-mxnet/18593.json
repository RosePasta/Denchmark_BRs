{"BR": {"BR_id": "18593", "BR_author": "xidulu", "BRopenT": "2020-06-19T04:32:38Z", "BRcloseT": "2020-11-04T19:53:21Z", "BR_text": {"BRsummary": "Deferred computation does not work in HybridSequential", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n import mxnet as mx\n from mxnet import np, npx\n from mxnet.gluon.nn import HybridBlock\n \n class normalBlock(HybridBlock):\n     def forward(self, x):\n         return (x + 1)\n \n shape = (4, 4)\n for hybridize in [True, False]:\n     initial_value = np.ones(shape)\n     net = mx.gluon.nn.HybridSequential()\n     net.add(normalBlock())\n     net.add(normalBlock())\n     if hybridize:\n         net.hybridize()\n     mx_out = net(initial_value).asnumpy()\n <denchmark-code>NotImplementedForSymbol                   Traceback (most recent call last)\n <ipython-input-321-a136cd061b1d> in <module>\n      15     if hybridize:\n      16         net.hybridize()\n ---> 17     mx_out = net(initial_value).asnumpy()\n      18 \n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in __call__(self, x, *args)\n    1322         if self.hybrid_forward.__func__ is not HybridBlock.hybrid_forward:\n    1323             # Gluon 1 based on F:  hybrid_forward is defined by user\n -> 1324             return super().__call__(x, *args)\n    1325         else:  # Gluon 2 based on deferred compute mode\n    1326             assert self.forward is not HybridBlock.forward, (\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in __call__(self, *args)\n     703             hook(self, args)\n     704 \n --> 705         out = self.forward(*args)\n     706 \n     707         for hook in self._forward_hooks.values():\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in forward(self, x, *args)\n    1367                                      'Find all contexts = {}'.format(ctx_set))\n    1368                 with ctx:\n -> 1369                     return self._call_cached_op(x, *args)\n    1370             with ctx:\n    1371                 try:\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _call_cached_op(self, *args)\n    1055     def _call_cached_op(self, *args):\n    1056         if self._cached_op is None:\n -> 1057             self._build_cache(*args)\n    1058         assert self._cached_op, \"Gluon failed to build the cache. \" \\\n    1059                                 \"This should never happen. \" \\\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _build_cache(self, *args)\n     984 \n     985     def _build_cache(self, *args):\n --> 986         data, out = self._get_graph(*args)\n     987         data_names = {data.name: i for i, data in enumerate(data)}\n     988         params = self.collect_params()\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _get_graph(self, *args)\n     978         if not self._cached_graph:\n     979             if self.hybrid_forward.__func__ is not HybridBlock.hybrid_forward:  # Gluon 1\n --> 980                 return self._get_graph_v1(*args)\n     981             else:  # Gluon 2 based on deferred compute mode\n     982                 return self._get_graph_v2(*args)\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _get_graph_v1(self, *args)\n     942             params = {i: j.var() for i, j in self._reg_params.items()}\n     943             with self.name_scope():\n --> 944                 out = self.hybrid_forward(symbol, *grouped_inputs, **params)  # pylint: disable=no-value-for-parameter\n     945             out, self._out_format = _flatten(out, \"output\")\n     946 \n \n ~/mxnet_master_develop/python/mxnet/gluon/nn/basic_layers.py in hybrid_forward(self, F, x, *args)\n     126     def hybrid_forward(self, F, x, *args):\n     127         for block in self._children.values():\n --> 128             x = block()(x, *args)\n     129             args = []\n     130             if isinstance(x, (tuple, list)):\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in __call__(self, x, *args)\n    1343                 return super().__call__(x, *args)\n    1344 \n -> 1345             return self._call_cached_op(x, *args)\n    1346 \n    1347     def forward(self, x, *args):\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _call_cached_op(self, *args)\n    1055     def _call_cached_op(self, *args):\n    1056         if self._cached_op is None:\n -> 1057             self._build_cache(*args)\n    1058         assert self._cached_op, \"Gluon failed to build the cache. \" \\\n    1059                                 \"This should never happen. \" \\\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _build_cache(self, *args)\n     984 \n     985     def _build_cache(self, *args):\n --> 986         data, out = self._get_graph(*args)\n     987         data_names = {data.name: i for i, data in enumerate(data)}\n     988         params = self.collect_params()\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _get_graph(self, *args)\n     980                 return self._get_graph_v1(*args)\n     981             else:  # Gluon 2 based on deferred compute mode\n --> 982                 return self._get_graph_v2(*args)\n     983         return self._cached_graph\n     984 \n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in _get_graph_v2(self, *args)\n     952         if not self._cached_graph:\n     953             flatten_args, self._in_format = _flatten(args, \"input\")\n --> 954             flatten_args = [ele.detach() if ele is not None else None for ele in flatten_args]\n     955             real_args = [ele for ele in flatten_args if ele is not None]\n     956             if len(real_args) == 0:\n \n ~/mxnet_master_develop/python/mxnet/gluon/block.py in <listcomp>(.0)\n     952         if not self._cached_graph:\n     953             flatten_args, self._in_format = _flatten(args, \"input\")\n --> 954             flatten_args = [ele.detach() if ele is not None else None for ele in flatten_args]\n     955             real_args = [ele for ele in flatten_args if ele is not None]\n     956             if len(real_args) == 0:\n \n ~/mxnet_master_develop/python/mxnet/symbol/symbol.py in detach(self)\n    2791 \n    2792     def detach(self):\n -> 2793         raise NotImplementedForSymbol(self.detach, None)\n    2794 \n    2795     def backward(self):\n \n NotImplementedForSymbol: Function detach is not implemented for Symbol and only available in NDArray.\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "xidulu", "commentT": "2020-06-19T04:54:01Z", "comment_text": "\n \t\tIt's \"by design\" as you can't call the new API from the old API: Calling a HybridBock.forward block from HybridBlock.hybrid_forward is not supported. Note that all the MXNet provided HybridBlocks currently implement hybrid_forward for compatibility.\n We can add temporary hack to HybridSequential to support this usecase if needed, as HybridSequential only passes through the arguments. In general HybridSequential will be switched to the new API together with all the other HybridBlocks in the near future.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "xidulu", "commentT": "2020-06-19T05:28:30Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/leezu>@leezu</denchmark-link>\n \n Thanks for your response, I am not in urgent need of this usecase.\n But I believe it's crucial to let HybridSequential support the new API.\n \t\t"}}}, "commit": {"commit_id": "3d1df4e035077b5d4de859e7bf464181388d47a0", "commit_author": "Leonard Lausen", "commitT": "2020-11-04 11:53:20-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "python\\mxnet\\gluon\\block.py", "file_new_name": "python\\mxnet\\gluon\\block.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1410", "deleted_lines": "1409", "method_info": {"method_name": "__call__", "method_params": "self,x,args", "method_startline": "1409", "method_endline": "1434"}}, "hunk_1": {"Ismethod": 1, "added_lines": "904", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "902", "method_endline": "915"}}, "hunk_2": {"Ismethod": 1, "added_lines": "1286", "deleted_lines": "1285", "method_info": {"method_name": "infer_shape", "method_params": "self,args", "method_startline": "1284", "method_endline": "1299"}}, "hunk_3": {"Ismethod": 1, "added_lines": "989", "deleted_lines": "988", "method_info": {"method_name": "_get_graph", "method_params": "self,args", "method_startline": "987", "method_endline": "993"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "python\\mxnet\\gluon\\nn\\basic_layers.py", "file_new_name": "python\\mxnet\\gluon\\nn\\basic_layers.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "138,139,140,141,142,143,144,145,146,147", "deleted_lines": null, "method_info": {"method_name": "_forward", "method_params": "self,x,args", "method_startline": "138", "method_endline": "147"}}, "hunk_1": {"Ismethod": 1, "added_lines": "125,126,127,128,129,130,131,132,133,134,135", "deleted_lines": null, "method_info": {"method_name": "__call__", "method_params": "self,args,kwargs", "method_startline": "125", "method_endline": "135"}}, "hunk_2": {"Ismethod": 1, "added_lines": "115,117", "deleted_lines": "114", "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "114", "method_endline": "117"}}, "hunk_3": {"Ismethod": 1, "added_lines": "1030,1031,1032,1033,1034,1035,1036,1037,1038", "deleted_lines": null, "method_info": {"method_name": "_forward", "method_params": "self,x", "method_startline": "1030", "method_endline": "1038"}}, "hunk_4": {"Ismethod": 1, "added_lines": "1027", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,axis", "method_startline": "1026", "method_endline": "1028"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 9, "file_old_name": "tests\\python\\unittest\\test_gluon.py", "file_new_name": "tests\\python\\unittest\\test_gluon.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "3078,3080,3081,3082,3084,3085,3086,3089,3090,3091", "method_info": {"method_name": "test_concatenate", "method_params": "", "method_startline": "3078", "method_endline": "3101"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1026,1027,1028,1029", "deleted_lines": null, "method_info": {"method_name": "check_sequential_dc.__init__", "method_params": "self", "method_startline": "1026", "method_endline": "1029"}}, "hunk_2": {"Ismethod": 1, "added_lines": "1054", "deleted_lines": null, "method_info": {"method_name": "test_sequential", "method_params": "", "method_startline": "1051", "method_endline": "1054"}}, "hunk_3": {"Ismethod": 1, "added_lines": "1024,1025,1026,1027,1028,1029,1030,1031,1032,1034,1035,1036,1037,1038,1039,1040,1041,1042,1043", "deleted_lines": null, "method_info": {"method_name": "check_sequential_dc", "method_params": "net", "method_startline": "1024", "method_endline": "1048"}}, "hunk_4": {"Ismethod": 1, "added_lines": "3113,3114,3115,3116,3117,3118,3119,3120,3121,3122,3123,3124,3126,3127,3128,3130,3131,3132,3135,3136,3137,3138,3143,3144,3145", "deleted_lines": null, "method_info": {"method_name": "test_concatenate", "method_params": "dc,hybridize", "method_startline": "3113", "method_endline": "3151"}}, "hunk_5": {"Ismethod": 1, "added_lines": "1031,1032", "deleted_lines": null, "method_info": {"method_name": "check_sequential_dc.forward", "method_params": "self,x", "method_startline": "1031", "method_endline": "1032"}}, "hunk_6": {"Ismethod": 1, "added_lines": "3120,3121", "deleted_lines": null, "method_info": {"method_name": "test_concatenate.forward", "method_params": "self,x", "method_startline": "3120", "method_endline": "3121"}}, "hunk_7": {"Ismethod": 1, "added_lines": "3116,3117,3118", "deleted_lines": null, "method_info": {"method_name": "test_concatenate.__init__", "method_params": "self,units,activation,in_units", "method_startline": "3116", "method_endline": "3118"}}, "hunk_8": {"Ismethod": 1, "added_lines": "1014,1015,1016,1017,1018,1019,1020,1021,1022", "deleted_lines": null, "method_info": {"method_name": "check_sequential", "method_params": "net", "method_startline": "1007", "method_endline": "1022"}}}}}}}