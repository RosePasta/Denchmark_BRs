{"BR": {"BR_id": "1495", "BR_author": "bjtho08", "BRopenT": "2020-03-30T13:02:42Z", "BRcloseT": "2020-04-06T17:50:44Z", "BR_text": {"BRsummary": "TQDMProgressBar not working in TF-2.2.0rc1", "BRdescription": "\n System information\n \n OS Platform and Distribution: Linux Ubuntu 18.04\n TensorFlow version and how it was installed (source or binary): TF-2.2.0rc1 (wheel compiled from source)\n TensorFlow-Addons version and how it was installed (source or binary): 0.8.3 installed via pip\n Python version: 3.7.6\n Is GPU used? (yes/no): Yes\n \n Describe the bug\n Executing model.fit() with the TQDMProgressBar() callback results in KeyError: 'metrics' because of a change in TF-2.2 that moves initialization of model.metrics (and model.metrics_names) from compile stage to train stage.\n Code to reproduce the issue\n import numpy as np\n import tensorflow as tf\n import tensorflow_addons as tfa\n \n x = np.random.random((5,1,5))\n y = np.random.random((5,1,5))\n \n inputs = tf.keras.layers.Input(shape=(3,))\n outputs = tf.keras.layers.Dense(2, name=\"out_1\")(inputs)\n model = tf.keras.models.Model(inputs=inputs, outputs=outputs)\n model.compile(optimizer=\"Adam\", loss=\"mse\", metrics=[\"acc\"])\n \n pg = tfa.callbacks.TQDMProgressBar()\n model_callbacks = [pg, ]\n VERBOSE=0\n history = model.fit(\n     x,\n     y,\n     epochs=100,\n     verbose=VERBOSE,\n     callbacks=model_callbacks\n )\n Other info / logs\n ---------------------------------------------------------------------------\n KeyError                                  Traceback (most recent call last)\n <ipython-input-23-fdbb03f574a1> in <module>\n      48 #   class_weight=class_weights,\n      49     verbose=VERBOSE,\n ---> 50     callbacks=model_callbacks,\n      51 )\n \n ~/.pyenv/versions/3.7.6/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py in _method_wrapper(self, *args, **kwargs)\n      63   def _method_wrapper(self, *args, **kwargs):\n      64     if not self._in_multi_worker_mode():  # pylint: disable=protected-access\n ---> 65       return method(self, *args, **kwargs)\n      66 \n      67     # Running inside `run_distribute_coordinator` already.\n \n ~/.pyenv/versions/3.7.6/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py in fit(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_batch_size, validation_freq, max_queue_size, workers, use_multiprocessing, **kwargs)\n     763       self.stop_training = False\n     764       train_function = self.make_train_function()\n --> 765       callbacks.on_train_begin()\n     766       # Handle fault-tolerance for multi-worker.\n     767       # TODO(omalleyt): Fix the ordering issues that mean this has to\n \n ~/.pyenv/versions/3.7.6/lib/python3.7/site-packages/tensorflow/python/keras/callbacks.py in on_train_begin(self, logs)\n     445     logs = self._process_logs(logs)\n     446     for callback in self.callbacks:\n --> 447       callback.on_train_begin(logs)\n     448 \n     449   def on_train_end(self, logs=None):\n \n ~/.pyenv/versions/3.7.6/lib/python3.7/site-packages/tensorflow_addons/callbacks/tqdm_progress_bar.py in on_train_begin(self, logs)\n     100     def on_train_begin(self, logs=None):\n     101         self.num_epochs = self.params[\"epochs\"]\n --> 102         self.metrics = self.params[\"metrics\"]\n     103 \n     104         if self.show_overall_progress:\n \n KeyError: 'metrics'\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "bjtho08", "commentT": "2020-03-30T13:10:19Z", "comment_text": "\n \t\tI believe that it's going to be fixed with <denchmark-link:https://github.com/tensorflow/addons/pull/1365>#1365</denchmark-link>\n  . We lack tests for those, which explains why they break unexpectedly.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "bjtho08", "commentT": "2020-03-30T13:29:43Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/gabrieldemarmiesse>@gabrieldemarmiesse</denchmark-link>\n  I can confirm that the patch you mentioned fixed my issue  It does introduce a new issue, however. Validation metrics are not printed at the end of an epoch anymore.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "bjtho08", "commentT": "2020-03-30T15:09:43Z", "comment_text": "\n \t\tYeah we definitly lack some proper testing for the callbacks in Addons.\n \t\t"}}}, "commit": {"commit_id": "4a07aa26dabc72e711924353884986caa6cce7d9", "commit_author": "Gabriel de Marmiesse", "commitT": "2020-04-06 19:50:43+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow_addons\\callbacks\\tests\\tqdm_progress_bar_test.py", "file_new_name": "tensorflow_addons\\callbacks\\tests\\tqdm_progress_bar_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "11,12", "deleted_lines": "11,12,13,14,15,16,18,19", "method_info": {"method_name": "get_data_and_model", "method_params": "", "method_startline": "10", "method_endline": "19"}}, "hunk_1": {"Ismethod": 1, "added_lines": "100,103,106,107,108,109,110,111", "deleted_lines": "107,110", "method_info": {"method_name": "test_tqdm_progress_bar_show", "method_params": "capsys,show_epoch_progress,show_overall_progress", "method_startline": "91", "method_endline": "111"}}, "hunk_2": {"Ismethod": 1, "added_lines": "70,72", "deleted_lines": null, "method_info": {"method_name": "test_tqdm_progress_bar_epoch_bar_format_missing_parameter", "method_params": "capsys", "method_startline": "62", "method_endline": "72"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow_addons\\callbacks\\tqdm_progress_bar.py", "file_new_name": "tensorflow_addons\\callbacks\\tqdm_progress_bar.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "114,115", "deleted_lines": "102,115", "method_info": {"method_name": "on_train_begin", "method_params": "self,logs", "method_startline": "100", "method_endline": "115"}}, "hunk_1": {"Ismethod": 1, "added_lines": "206,207,208,209,210", "deleted_lines": "211,212", "method_info": {"method_name": "format_metrics", "method_params": "self,logs,factor", "method_startline": "190", "method_endline": "212"}}}}}}}