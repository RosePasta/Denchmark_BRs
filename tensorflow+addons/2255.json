{"BR": {"BR_id": "2255", "BR_author": "fsx950223", "BRopenT": "2020-11-26T08:32:25Z", "BRcloseT": "2020-12-08T03:21:57Z", "BR_text": {"BRsummary": "AttributeError: 'TrackableWeightHandler' object has no attribute 'trainable'", "BRdescription": "\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): 18.04\n TensorFlow version and how it was installed (source or binary): 2.3.0\n TensorFlow-Addons version and how it was installed (source or binary): 0.11.2\n Python version: 3.6.8\n Is GPU used? (yes/no): yes\n \n Describe the bug\n TrackableWeightHandler doesn't have trainable and assign attributes but also to be appended to weights and trainable_weights. When I use AverageModelCheckpoint, I meet the bug. I'm not sure it's a bug of addons or tensorflow.\n TrackableWeightHandler is added in TextVectorization\n A clear and concise description of what the bug is.\n <denchmark-code>Traceback (most recent call last):\n   File \"/usr/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/usr/lib/python3.6/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/root/.vscode-server/extensions/ms-python.python-2020.11.371526539/pythonFiles/lib/python/debugpy/__main__.py\", line 45, in <module>\n     cli.main()\n   File \"/root/.vscode-server/extensions/ms-python.python-2020.11.371526539/pythonFiles/lib/python/debugpy/../debugpy/server/cli.py\", line 430, in main\n     run()\n   File \"/root/.vscode-server/extensions/ms-python.python-2020.11.371526539/pythonFiles/lib/python/debugpy/../debugpy/server/cli.py\", line 267, in run_file\n     runpy.run_path(options.target, run_name=compat.force_str(\"__main__\"))\n   File \"/usr/lib/python3.6/runpy.py\", line 263, in run_path\n     pkg_name=pkg_name, script_name=fname)\n   File \"/usr/lib/python3.6/runpy.py\", line 96, in _run_module_code\n     mod_name, mod_spec, pkg_name, script_name)\n   File \"/usr/lib/python3.6/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/usr/local/srv/automl/efficientdet/nlp.py\", line 65, in <module>\n     tfa.callbacks.AverageModelCheckpoint(update_weights=True, filepath=os.path.join(MODEL_DIR, 'ckpt_moving_average'))])\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow/python/keras/engine/training.py\", line 108, in _method_wrapper\n     return method(self, *args, **kwargs)\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow/python/keras/engine/training.py\", line 1137, in fit\n     callbacks.on_epoch_end(epoch, epoch_logs)\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow/python/keras/callbacks.py\", line 412, in on_epoch_end\n     callback.on_epoch_end(epoch, logs)\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow/python/keras/callbacks.py\", line 1249, in on_epoch_end\n     self._save_model(epoch=epoch, logs=logs)\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow_addons/callbacks/average_model_checkpoint.py\", line 76, in _save_model\n     self.model.optimizer.assign_average_vars(self.model.trainable_weights)\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow_addons/optimizers/average_wrapper.py\", line 125, in assign_average_vars\n     for var in var_list\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow_addons/optimizers/average_wrapper.py\", line 126, in <listcomp>\n     if var.trainable\n AttributeError: 'TrackableWeightHandler' object has no attribute 'trainable'\n </denchmark-code>\n \n \n <denchmark-link:https://colab.research.google.com/drive/1OM7kAA6aOcNSTTXpd74kUnw-EeeM2uH5?usp=sharing>https://colab.research.google.com/drive/1OM7kAA6aOcNSTTXpd74kUnw-EeeM2uH5?usp=sharing</denchmark-link>\n \n Provide a reproducible test case that is the bare minimum necessary to generate the problem.\n Other info / logs\n Change model.variables to model.trainable_weights could fix it temporarily.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "fsx950223", "commentT": "2020-11-28T05:24:37Z", "comment_text": "\n \t\tThanks for reporting! Per <denchmark-link:https://github.com/tensorflow/tensorflow/issues/43834#issuecomment-706607049>tensorflow/tensorflow#43834 (comment)</denchmark-link>\n , this should be our issue, though I think  API should return a list of . The solution that I can come up with is to replace\n \n \n \n addons/tensorflow_addons/optimizers/average_wrapper.py\n \n \n         Lines 106 to 113\n       in\n       8040bcf\n \n \n \n \n \n \n  assign_op = tf.group( \n \n \n \n      [ \n \n \n \n  var.assign(self.get_slot(var, \"average\"), use_locking=self._use_locking) \n \n \n \n  for var in var_list \n \n \n \n  if var.trainable \n \n \n \n      ] \n \n \n \n  ) \n \n \n \n  return assign_op \n \n \n \n \n \n with a try-catch\n ops = []\n \n try:\n     for var in var_list \n         ops.append(var.assign(self.get_slot(var, \"average\"), use_locking=self._use_locking))\n except:\n     logging.warning(\"some warning about there is no average slot for var.\")\n \n return tf.group(ops)\n because we can not guarantee variables in var_list have average slot either (in some use cases).\n What do you think <denchmark-link:https://github.com/fsx950223>@fsx950223</denchmark-link>\n  ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "fsx950223", "commentT": "2020-11-29T02:37:14Z", "comment_text": "\n \t\tagree\n \t\t"}}}, "commit": {"commit_id": "a21a32a1c6677de150d46c364983125d750f5826", "commit_author": "Tzu-Wei Sung", "commitT": "2020-12-07 19:21:56-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow_addons\\optimizers\\average_wrapper.py", "file_new_name": "tensorflow_addons\\optimizers\\average_wrapper.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "107,108,109,110,111,112,113,114,115,116,117", "deleted_lines": "106,107,108,109,110,111,112,113", "method_info": {"method_name": "assign_average_vars", "method_params": "self,var_list", "method_startline": "83", "method_endline": "117"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow_addons\\optimizers\\tests\\moving_average_test.py", "file_new_name": "tensorflow_addons\\optimizers\\tests\\moving_average_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337", "deleted_lines": null, "method_info": {"method_name": "test_no_average_slot", "method_params": "", "method_startline": "309", "method_endline": "337"}}}}}}}