{"BR": {"BR_id": "2526", "BR_author": "s920128", "BRopenT": "2020-09-28T08:00:16Z", "BRcloseT": "2020-09-29T21:15:57Z", "BR_text": {"BRsummary": "CTC Segmentation Questions", "BRdescription": "\n I try to modify tedlium2/align1  CTCsegment example to another example like egs/aishell\n but report error as following\n I have no idea to solve this index error.\n <denchmark-code>2020-09-28 01:38:09,148 (asr_align:245) INFO: (1/14326) Aligning BAC009S0724W0121\n 2020-09-28 01:38:10,293 (ctc_segmentation:66) INFO: CTC segmentation of 19 chars to 4.20s audio (105 indices).\n 2020-09-28 01:38:10,296 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-28 01:38:10,296 (ctc_segmentation:145) WARNING: Increasing the window size to: 16000\n 2020-09-28 01:38:10,298 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-28 01:38:10,299 (ctc_segmentation:145) WARNING: Increasing the window size to: 32000\n 2020-09-28 01:38:10,301 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-28 01:38:10,301 (ctc_segmentation:145) WARNING: Increasing the window size to: 64000\n 2020-09-28 01:38:10,303 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-28 01:38:10,303 (ctc_segmentation:148) ERROR: Maximum window size reached.\n 2020-09-28 01:38:10,304 (ctc_segmentation:149) ERROR: Check data and character list!\n Traceback (most recent call last):\n   File \"/mnt/nas2/*****/espnet/tools/venv/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/mnt/nas2/*****/espnet/tools/venv/lib/python3.7/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/mnt/nas2/*****/espnet/espnet/bin/asr_align.py\", line 277, in <module>\n     main(sys.argv[1:])\n   File \"/mnt/nas2/*****/espnet/espnet/bin/asr_align.py\", line 180, in main\n     ctc_align(args, device)\n   File \"/mnt/nas2/*****/espnet/espnet/bin/asr_align.py\", line 260, in ctc_align\n     config, lpz, ground_truth_mat\n   File \"/mnt/nas2/*****/espnet/tools/venv/lib/python3.7/site-packages/ctc_segmentation/ctc_segmentation.py\", line 119, in ctc_segmentation\n     est_stay_prob = table[t, c] - table[t - 1, c]\n IndexError: index -106 is out of bounds for axis 0 with size 105 \n </denchmark-code>\n \n I try to run original tedlium2/align1 CTCsegment example.\n Another question when stage 3: Alignments using CTC segmentation it cost a lot of memory. (run on  tedlium2/align1, align_set is test)\n It will out of memory when I use gpu(TITAN RTX)\n I try to use cpu run stage 3, it cost over 200G RAM, and out of memory too.\n If reduce test set to only 1 utt  stage 3 will success.\n How can I Alignments all align_set ?\n Thanks you!\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "s920128", "commentT": "2020-09-28T10:08:36Z", "comment_text": "\n \t\tIndexError for backtracking:\n this usually means that text and audio data are misaligned. More precisely, the optimal alignment of an utterance is not within the window size.\n This error happens if the blank character was not set correctly (or similar characters). Use the option --use-dict-blank of asr_align.py to automatically set this parameter from the model dictionary. Also,  check your character list - the same dictionary that you used to train your model should also be used for inputting the label sequence.\n Furthermore, in your case you also might adapt the window parameters. The parameters for min and max window size were set so that the length of each utterance (in terms of frames of CTC outputs) fits into that window. The default window is 8000, your audio file is much shorter. You may reduce this value to improve alignment speed.\n Regarding memory consumption:\n For aligning, an inference of the full audio file is done on the GPU. Here, the memory consumption depends on how much memory your model consumes to infer the audio file. Depends on model size, subsampling etc.\n The RAM memory consumption (CPU) depends on primarily (1) the size of the audio file times text length and (2) to what extent your model uses subsampling. That's because all of the CTC layer outputs are stored for CTC segmentation. If your audio file is very large, you will run into large RAM memory consumption. To reduce the memory consumption, e.g. use a model with subsampling in the encoder.\n In the CTC segmentation paper, we aligned audio files of up to several hours. The memory consumption of CTC activations alone is roughly ~8 GB for one hour audio, but only ~1.8 GB with 4x subsampling (assumed default settings).\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "s920128", "commentT": "2020-09-28T16:14:42Z", "comment_text": "\n \t\tOur default models in most recipes are based on transformer (self-attention), which requires N^2 memory and is not adequate for such purposes (where N is the subsampled length). I recommend you to try it with BLSTM models (usually espnet1 recipe also provides a BLSTM config file). We actually prepared a BLSTM model when we apply CTC segmentation to other recipes.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "s920128", "commentT": "2020-09-29T04:39:28Z", "comment_text": "\n \t\tThanks a lot.\n I use BLSTM model for tedlium2/align1 CTCsegment example success!\n I am training a BLSTM model for aishell try to avoid IndexError now.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "s920128", "commentT": "2020-09-29T10:04:18Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/s920128>@s920128</denchmark-link>\n , please let us know here if the BLSTM model works.\n <denchmark-link:https://github.com/lumaku>@lumaku</denchmark-link>\n , if the issue comes from self-attention, I think it would be better to add such a note in README.md, and add some warning when we use transformer or conformer models in utils/ctc_align_wav.sh.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "s920128", "commentT": "2020-09-30T06:55:45Z", "comment_text": "\n \t\tthanks for lumaku update.\n I train a BLSTM model for aishell dataset, and add --use-dict-blank 1 option\n but something error following\n I reduce min_window but have same problem.\n <denchmark-code>stage 3: Alignments using CTC segmentation\n 2020-09-30 14:12:21,844 (asr_align:173) INFO: python path = (None)\n 2020-09-30 14:12:21,844 (asr_align:175) INFO: backend = pytorch\n 2020-09-30 14:12:21,844 (asr_utils:656) INFO: reading a config file from /mnt/disk1/*****/espnet0.9.3/egs/aishell/asr1/exp/train_sp_pytorch_train/results/model.json\n 2020-09-30 14:12:21,845 (asr_init:169) WARNING: reading model parameters from /mnt/disk1/*****/espnet0.9.3/egs/aishell/asr1/exp/train_sp_pytorch_train/results/model.acc.best\n 2020-09-30 14:12:22,504 (nets_utils:423) WARNING: Subsampling is not performed for vgg*. It is performed in max pooling layers at CNN.\n 2020-09-30 14:12:22,505 (nets_utils:426) INFO: subsample: 1 1 1 1\n 2020-09-30 14:12:23,408 (encoders:288) INFO: Use CNN-VGG + BLSTM for encoder\n 2020-09-30 14:12:23,456 (ctc:36) WARNING: CTC was set to builtin due to PyTorch version.\n 2020-09-30 14:12:25,607 (asr_align:203) INFO: Decoding device=cuda\n 2020-09-30 14:12:25,607 (asr_align:211) INFO: Encoder module: espnet.nets.pytorch_backend.rnn.encoders\n 2020-09-30 14:12:25,607 (asr_align:212) INFO: CTC module:     espnet.nets.pytorch_backend.ctc\n 2020-09-30 14:12:29,915 (asr_align:246) INFO: Blank char was set to ><blank><\n 2020-09-30 14:12:29,916 (asr_align:253) INFO: Frame timings: 10ms * 4\n 2020-09-30 14:12:29,916 (asr_align:257) INFO: (1/14326) Aligning BAC009S0724W0121\n 2020-09-30 14:12:29,918 (encoders:198) DEBUG: VGG2L input lengths: [426]\n 2020-09-30 14:12:29,921 (encoders:141) DEBUG: RNN input lengths: [107]\n 2020-09-30 14:12:29,953 (ctc_segmentation:167) DEBUG: Blank character: <blank> == <blank>\n 2020-09-30 14:12:29,964 (ctc_segmentation:66) INFO: CTC segmentation of 20 chars to 4.28s audio (107 indices).\n 2020-09-30 14:12:29,965 (ctc_segmentation:84) DEBUG: Average character duration: 0.0 (indices)\n 2020-09-30 14:12:29,966 (ctc_segmentation:87) DEBUG: Max. joint probability to align text to audio: -1.0986804962158203 at time index 88\n 2020-09-30 14:12:29,966 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-30 14:12:29,966 (ctc_segmentation:145) WARNING: Increasing the window size to: 16000\n 2020-09-30 14:12:29,966 (ctc_segmentation:84) DEBUG: Average character duration: 0.0 (indices)\n 2020-09-30 14:12:29,967 (ctc_segmentation:87) DEBUG: Max. joint probability to align text to audio: -1.0986804962158203 at time index 88\n 2020-09-30 14:12:29,967 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-30 14:12:29,967 (ctc_segmentation:145) WARNING: Increasing the window size to: 32000\n 2020-09-30 14:12:29,968 (ctc_segmentation:84) DEBUG: Average character duration: 0.0 (indices)\n 2020-09-30 14:12:29,968 (ctc_segmentation:87) DEBUG: Max. joint probability to align text to audio: -1.0986804962158203 at time index 88\n 2020-09-30 14:12:29,968 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-30 14:12:29,968 (ctc_segmentation:145) WARNING: Increasing the window size to: 64000\n 2020-09-30 14:12:29,969 (ctc_segmentation:84) DEBUG: Average character duration: 0.0 (indices)\n 2020-09-30 14:12:29,969 (ctc_segmentation:87) DEBUG: Max. joint probability to align text to audio: -1.0986804962158203 at time index 88\n 2020-09-30 14:12:29,970 (ctc_segmentation:140) WARNING: IndexError: Backtracking was not successful, the window size might be too small.\n 2020-09-30 14:12:29,970 (ctc_segmentation:148) ERROR: Maximum window size reached.\n 2020-09-30 14:12:29,970 (ctc_segmentation:149) ERROR: Check data and character list!\n Traceback (most recent call last):\n   File \"/mnt/disk1/*****/espnet0.9.3/tools/espnet37/envs/espnet37/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/mnt/disk1/*****/espnet0.9.3/tools/espnet37/envs/espnet37/lib/python3.7/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/mnt/disk1/*****/espnet0.9.3/espnet/bin/asr_align.py\", line 289, in <module>\n     main(sys.argv[1:])\n   File \"/mnt/disk1/*****/espnet0.9.3/espnet/bin/asr_align.py\", line 177, in main\n     ctc_align(args, device)\n   File \"/mnt/disk1/*****/espnet0.9.3/espnet/bin/asr_align.py\", line 272, in ctc_align\n     config, lpz, ground_truth_mat\n   File \"/mnt/disk1/*****/espnet0.9.3/tools/espnet37/envs/espnet37/lib/python3.7/site-packages/ctc_segmentation/ctc_segmentation.py\", line 130, in ctc_segmentation\n     state_list[offsets[c] + t] = state_list[ground_truth[c, min_s]]\n IndexError: list index out of range\n </denchmark-code>\n \n A small question is the log show that BAC009S0724W0121 has 20 chars to align\n <denchmark-code>2020-09-30 14:12:29,916 (asr_align:257) INFO: (1/14326) Aligning BAC009S0724W0121\n ...\n INFO: CTC segmentation of 20 chars to 4.28s audio (107 indices).\n </denchmark-code>\n \n But I check corresponding data.json file, BAC009S0724W0121 output only 12 chars.\n If this causes the list index out of range error?\n <denchmark-code>{\n     \"utts\": {\n         \"BAC009S0724W0121\": {\n             \"input\": [\n                 {\n                     \"feat\": \"/mnt/disk1/*****/espnet0.9.3/egs/aishell/asr1/dump/dev/deltafalse/feats.1.ark:17\",\n                     \"name\": \"input1\",\n                     \"shape\": [\n                         426,\n                         83\n                     ]\n                 }\n             ],\n             \"output\": [\n                 {\n                     \"name\": \"target1\",\n                     \"shape\": [\n                         12,\n                         4233\n                     ],\n                     \"text\": \"\u5e7f\u5dde\u5e02\u623f\u5730\u4ea7\u4e2d\u4ecb\u534f\u4f1a\u5206\u6790\",\n                     \"token\": \"\u5e7f \u5dde \u5e02 \u623f \u5730 \u4ea7 \u4e2d \u4ecb \u534f \u4f1a \u5206 \u6790\",\n                     \"tokenid\": \"1156 1104 1121 1393 722 85 30 103 433 139 338 1789\"\n                 }\n             ],\n             \"utt2spk\": \"S0724\"\n         },\n </denchmark-code>\n \n Thanks a lot.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "s920128", "commentT": "2020-09-30T07:45:26Z", "comment_text": "\n \t\tThis error might be due to a different file encoding of the text file than your system default which is system-dependent. Try to  the text file in with  (or its corresponding encoding). I saw jnishi solve this problem in <denchmark-link:https://github.com/espnet/espnet/pull/2531>#2531</denchmark-link>\n .\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "s920128", "commentT": "2020-10-07T06:49:03Z", "comment_text": "\n \t\tI have still same error.\n I try to trace the index error at line 130  state_list[offsets[c] + t] = state_list[ground_truth[c, min_s]]\n when index error, len(state_list)=107 but ground_truth[c, min_s] is 1789, resulting in the index error.\n Do you have any ideas to help me solve this error?\n Thanks a lot!\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "s920128", "commentT": "2020-10-07T16:22:17Z", "comment_text": "\n \t\tMaybe the  array was not correctly generated. Can you check whether the inputs to  in <denchmark-link:https://github.com/espnet/espnet/blob/04f41cfebd10565ba966887104900682fb451908/espnet/bin/asr_align.py#L272>asr_align.py:272</denchmark-link>\n , dictionary and utterance text, are correct?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "s920128", "commentT": "2020-10-08T03:37:29Z", "comment_text": "\n \t\tAt the beginning, I want to split BAC009S0724W0121 to several part but have index error too.\n <denchmark-code>BAC009S0724W0121-A \u5e7f\u5dde\u5e02\n BAC009S0724W0121-B \u623f\u5730\u4ea7\n BAC009S0724W0121-C \u4e2d\u4ecb\u534f\u4f1a\n ...\n </denchmark-code>\n \n So, I try to align whole sentence now firstly.\n In utt_text,  I try to align whole sentence BAC009S0724W0121-A \u5e7f\u5dde\u5e02\u623f\u5730\u4ea7\u4e2d\u4ecb\u534f\u4f1a\u5206\u6790\n In text: BAC009S0724W0121 \u5e7f\u5dde\u5e02\u623f\u5730\u4ea7\u4e2d\u4ecb\u534f\u4f1a\u5206\u6790\n INFO: CTC segmentation of 15 chars to 4.28s audio (107 indices)\n I use --use-dict-blank 1 , in model.json model have char_list with index 0~4232\n char_list = [\"<blank>\", \"<unk>\", \"\u4e00\", \"\u4e01\", ... , \"<eos>\"]\n in asr_align.py:272\n <denchmark-code>ground_truth_mat=\n [[  -1   -1   -1   -1   -1   -1   -1]\n  [   0   -1   -1   -1   -1   -1   -1]\n  [1156   -1   -1   -1   -1   -1   -1]\n  [1104   -1   -1   -1   -1   -1   -1]\n  [1121   -1   -1   -1   -1   -1   -1]\n  [1393   -1   -1   -1   -1   -1   -1]\n  [ 722   -1   -1   -1   -1   -1   -1]\n  [  85   -1   -1   -1   -1   -1   -1]\n  [  30   -1   -1   -1   -1   -1   -1]\n  [ 103   -1   -1   -1   -1   -1   -1]\n  [ 433   -1   -1   -1   -1   -1   -1]\n  [ 139   -1   -1   -1   -1   -1   -1]\n  [ 338   -1   -1   -1   -1   -1   -1]\n  [1789   -1   -1   -1   -1   -1   -1]\n  [   0   -1   -1   -1   -1   -1   -1]]\n </denchmark-code>\n \n and utt_begin_indices is utt_begin_indices = [1, 14]\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "s920128", "commentT": "2020-10-08T12:11:27Z", "comment_text": "\n \t\tYour  and  are correct. However, this is actually a bug in . It only occurs in short audio files. Thank you for reporting this. Also, a thanks to <denchmark-link:https://github.com/cornerfarmer>@cornerfarmer</denchmark-link>\n  for spotting the bug.\n For a quick fix, you can put line 130 in ctc_segmentation/ctc_segmentation.pyinto a comment. The variable state_list is not important in any way, it's only used for debugging.\n <denchmark-link:https://github.com/sw005320>@sw005320</denchmark-link>\n  Fixing this bug requires a change to the interface in . I'll submit a pull request to ESPnet in a few days, together with an update of the python package.\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "s920128", "commentT": "2020-10-08T12:46:23Z", "comment_text": "\n \t\tOK, sounds good!\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "s920128", "commentT": "2020-10-12T11:51:15Z", "comment_text": "\n \t\tI can run segmentation successfully by put line 130 in a comment.\n thank you!\n \t\t"}}}, "commit": {"commit_id": "6d094e4ba2d5fedd0bfc7216a3a567984bc98b11", "commit_author": "Ludwig K\u00fcrzinger", "commitT": "2020-09-29 19:42:29+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "README.md", "file_new_name": "README.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "446,495,496", "deleted_lines": "446"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "espnet\\bin\\asr_align.py", "file_new_name": "espnet\\bin\\asr_align.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "209,210,211,212,213,214,215,216,217,218,219,220,252,253,254,255,256,257,258", "deleted_lines": "240", "method_info": {"method_name": "ctc_align", "method_params": "args,device", "method_startline": "186", "method_endline": "291"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "utils\\asr_align_wav.sh", "file_new_name": "utils\\asr_align_wav.sh", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "21,35,43", "deleted_lines": "21,35,43"}}}}}}