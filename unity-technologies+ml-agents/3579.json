{"BR": {"BR_id": "3579", "BR_author": "scscgit", "BRopenT": "2020-03-06T08:53:26Z", "BRcloseT": "2020-03-07T20:29:34Z", "BR_text": {"BRsummary": "Agent implements lifecycle methods like OnEnable and OnDisable as private, so they mustn't be used, yet are easy to disable by a mistake", "BRdescription": "\n The MLAgents.Agent is a MonoBehaviour, which includes private functions like OnEnable and OnDisable that always have be called, yet it's possible for the user to implement their own new private methods, which Unity calls using reflection instead. When the user does so, there's no visible error, yet the framework silently fails to initialize, and the Agents don't call any actions. My suggestions are as follows:\n \n Always implement Unity lifecycle methods as protected, so that it's possible to call them using base superclass reference.\n Use some boolean field to make sure that the methods have been called, and display a warning when they haven't.\n \n This is especially important when the user uses APIs like NavMeshQuery that use an Allocator, which strictly require to be disposed and re-allocated when using Play Mode Options. An example use-case is adding a simple observation vector of a NavMesh Raycast.\n There is currently a possible workaround to invoke those private functions using a reflection. Here is an example if anyone's interested:\n <denchmark-code>private NavMeshQuery _navMeshQuery;\n \n private void OnEnable()\n {\n     typeof(Agent)\n         .GetMethod(\"OnEnable\", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)\n         .Invoke(this, new object[] { });\n     // Due to Play Mode Options, this must get re-initialized under OnEnable after OnDisable (memory leak prevention)\n     _navMeshQuery = new NavMeshQuery(NavMeshWorld.GetDefaultWorld(), Allocator.Persistent);\n }\n \n private void OnDisable()\n {\n     typeof(Agent)\n         .GetMethod(\"OnDisable\", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)\n         .Invoke(this, new object[] { });\n     _navMeshQuery.Dispose();\n }\n </denchmark-code>\n \n Environment:\n \n ML-Agents version: v0.14.0\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "scscgit", "commentT": "2020-03-06T18:48:17Z", "comment_text": "\n \t\tHI <denchmark-link:https://github.com/scscgit>@scscgit</denchmark-link>\n ,\n This is great feedback.  We have discussed this internally and will address the issue ASAP.  We have logged the issue internally as  MLA-739, and will update this thread when a fix is merged into master.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "scscgit", "commentT": "2020-03-07T20:29:33Z", "comment_text": "\n \t\tHi,\n The fix for this was merged into master from <denchmark-link:https://github.com/Unity-Technologies/ml-agents/pull/3590>#3590</denchmark-link>\n . Please open this issue again if a problem persists.\n \t\t"}}}, "commit": {"commit_id": "6dc476365eadb8aef3dc1926f21b89363461d516", "commit_author": "Chris Goy", "commitT": "2020-03-07 12:15:25-08:00", "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "Project\\Project.sln.DotSettings"}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "com.unity.ml-agents\\CHANGELOG.md", "file_new_name": "com.unity.ml-agents\\CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "45", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "com.unity.ml-agents\\Runtime\\Agent.cs", "file_new_name": "com.unity.ml-agents\\Runtime\\Agent.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "225", "deleted_lines": null, "method_info": {"method_name": "MLAgents::Agent::OnEnable", "method_params": "", "method_startline": "225", "method_endline": "228"}}, "hunk_1": {"Ismethod": 1, "added_lines": "312", "deleted_lines": null, "method_info": {"method_name": "MLAgents::Agent::OnDisable", "method_params": "", "method_startline": "312", "method_endline": "329"}}, "hunk_2": {"Ismethod": 1, "added_lines": "582,583,584,585,586,587,588", "deleted_lines": null, "method_info": {"method_name": "MLAgents::Agent::SendInfoToBrain", "method_params": "", "method_startline": "580", "method_endline": "622"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "com.unity.ml-agents\\Tests\\Editor\\MLAgentsEditModeTest.cs", "file_new_name": "com.unity.ml-agents\\Tests\\Editor\\MLAgentsEditModeTest.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "652,653,654,655", "deleted_lines": null, "method_info": {"method_name": "MLAgents.Tests::TestOnEnableOverride::TestAgentCallBaseOnEnable", "method_params": "", "method_startline": "652", "method_endline": "655"}}, "hunk_1": {"Ismethod": 1, "added_lines": "614,615,616,617,618", "deleted_lines": null, "method_info": {"method_name": "MLAgents.Tests::TestOnEnableOverride::OnEnableAgent::OnEnable", "method_params": "", "method_startline": "614", "method_endline": "618"}}, "hunk_2": {"Ismethod": 1, "added_lines": "658,659,660,661", "deleted_lines": null, "method_info": {"method_name": "MLAgents.Tests::TestOnEnableOverride::TestAgentDontCallBaseOnEnable", "method_params": "", "method_startline": "658", "method_endline": "661"}}, "hunk_3": {"Ismethod": 1, "added_lines": "621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649", "deleted_lines": null, "method_info": {"method_name": "MLAgents.Tests::TestOnEnableOverride::_InnerAgentTestOnEnableOverride", "method_params": "callBase", "method_startline": "621", "method_endline": "649"}}}}}}}