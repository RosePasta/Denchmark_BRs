{"BR": {"BR_id": "28346", "BR_author": "olesalscheider", "BRopenT": "2019-05-02T22:11:23Z", "BRcloseT": "2019-07-29T17:19:53Z", "BR_text": {"BRsummary": "TrtGraphConverterV2 does not preserve output names in the signature_def", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\n TensorFlow installed from (source or binary): source\n TensorFlow version (use command below):  master from April 22nd\n Python version: 3.6.7\n Bazel version (if compiling from source): 0.24\n GCC/Compiler version (if compiling from source): 7.4\n CUDA/cuDNN version: 10.0 / 7.5.0\n GPU model and memory: GTX 1080 Ti\n \n Describe the current behavior\n If you use TrtGraphConverterV2 to convert a function in a saved_model to use TRT it does not preserve the output names in the signature_def of the saved model.\n If the saved function (decorated with tf.function) returned a dict {'output_a': a, 'output_b': b} the names 'output_a' and 'output_b' are in the saved_model. After conversion with TrtGraphConverterV2 they are changed to the default names 'output_0' and 'output_1'.\n Describe the expected behavior\n The names of the outputs should not change. This breaks all code that loads the model and relies on the correct names.\n Code to reproduce the issue\n Take any saved_model that contains a function returning a dict.\n Then run this:\n <denchmark-code>conversion_params = trt_convert.DEFAULT_TRT_CONVERSION_PARAMS._replace(precision_mode=trt_convert.TrtPrecisionMode.FP16, max_batch_size=1, max_workspace_size_bytes=8000000000)\n \n trt_converter = trt_convert.TrtGraphConverterV2(input_saved_model_dir='your_saved_model', input_saved_model_signature_key='your_key', conversion_params=conversion_params)\n trt_converter.convert()\n trt_converter.save('your_saved_model')\n </denchmark-code>\n \n Use saved_model_cli to inspect the saved_model.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "olesalscheider", "commentT": "2019-05-03T12:57:25Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/olesalscheider>@olesalscheider</denchmark-link>\n  In order to expedite the trouble-shooting process, please provide a code snippet to reproduce the issue reported here. Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "olesalscheider", "commentT": "2019-05-03T16:56:04Z", "comment_text": "\n \t\tYou can use this code to reproduce the issue:\n <denchmark-link:https://gist.githubusercontent.com/olesalscheider/366f33115016ac9d5f2976ec17124496/raw/f5b68bf571f325742c1bc24658f0de04b3d3b33c/wrong_outputs.py>https://gist.githubusercontent.com/olesalscheider/366f33115016ac9d5f2976ec17124496/raw/f5b68bf571f325742c1bc24658f0de04b3d3b33c/wrong_outputs.py</denchmark-link>\n \n The output names should be the same before and after conversion but they are not.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "olesalscheider", "commentT": "2019-05-06T14:36:57Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/olesalscheider>@olesalscheider</denchmark-link>\n  Able to reproduce the issue.\n Our saved model has the following structured outputs:\n {'output_a': TensorSpec(shape=(), dtype=tf.float32, name='output_a'), 'output_b': TensorSpec(shape=(), dtype=tf.float32, name='output_b')}\n Running TF-TRT conversion...\n Our converted model has the following structured outputs:\n {'output_0': TensorSpec(shape=(), dtype=tf.float32, name='output_0'), 'output_1': TensorSpec(shape=(), dtype=tf.float32, name='output_1')}\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "olesalscheider", "commentT": "2019-07-25T22:10:04Z", "comment_text": "\n \t\tThanks for reporting this. I can reproduce the problem, will make a fix soon.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "olesalscheider", "commentT": "2019-07-29T17:19:54Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=28346>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=28346>No</denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "olesalscheider", "commentT": "2020-11-09T08:31:02Z", "comment_text": "\n \t\tIs it actually fixed??????\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "olesalscheider", "commentT": "2020-11-09T16:37:22Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/bixia1>@bixia1</denchmark-link>\n  do you know if this is still a problem?\n \t\t"}}}, "commit": {"commit_id": "e03ab548c4696efcdbe1cca599da1289c25093b4", "commit_author": "Guangda Lai", "commitT": "2019-07-29 10:17:33-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\compiler\\tensorrt\\trt_convert.py", "file_new_name": "tensorflow\\python\\compiler\\tensorrt\\trt_convert.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "917,918,919,920", "deleted_lines": null, "method_info": {"method_name": "convert", "method_params": "self", "method_startline": "890", "method_endline": "930"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 21, "file_old_name": "tensorflow\\python\\compiler\\tensorrt\\trt_convert_test.py", "file_new_name": "tensorflow\\python\\compiler\\tensorrt\\trt_convert_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "600,601", "deleted_lines": null, "method_info": {"method_name": "testTrtGraphConverter_DynamicOp", "method_params": "self", "method_startline": "596", "method_endline": "632"}}, "hunk_1": {"Ismethod": 1, "added_lines": "523,524,525,526,527,528,529,530,531,532,533,534", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_TwoInputs", "method_params": "self", "method_startline": "523", "method_endline": "534"}}, "hunk_2": {"Ismethod": 1, "added_lines": "510,511,512,513,514,515,516,517,518,519,520", "deleted_lines": "520", "method_info": {"method_name": "testRetainSignatureInfo_OneInput", "method_params": "self", "method_startline": "510", "method_endline": "520"}}, "hunk_3": {"Ismethod": 1, "added_lines": "483,484,485", "deleted_lines": "483", "method_info": {"method_name": "_CompareSavedModel._GetStructuredOutputs", "method_params": "export_dir", "method_startline": "483", "method_endline": "485"}}, "hunk_4": {"Ismethod": 1, "added_lines": "542,543", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_OneOutputSignatureKey.run", "method_params": "self", "method_startline": "542", "method_endline": "543"}}, "hunk_5": {"Ismethod": 1, "added_lines": "72,73", "deleted_lines": null, "method_info": {"method_name": "mkdtemp", "method_params": "self", "method_startline": "72", "method_endline": "73"}}, "hunk_6": {"Ismethod": 1, "added_lines": "299,309", "deleted_lines": "294,295,303,304,307", "method_info": {"method_name": "testTrtGraphConverter_BasicConversion", "method_params": "self", "method_startline": "294", "method_endline": "310"}}, "hunk_7": {"Ismethod": 1, "added_lines": "517,518", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_OneInput.run", "method_params": "self,inp", "method_startline": "517", "method_endline": "518"}}, "hunk_8": {"Ismethod": 1, "added_lines": "447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496", "deleted_lines": "481,482,483", "method_info": {"method_name": "_CompareSavedModel", "method_params": "self,model_class", "method_startline": "447", "method_endline": "496"}}, "hunk_9": {"Ismethod": 1, "added_lines": "469,470,471,472,473,474,475,476,477,478,479,480,481", "deleted_lines": "481", "method_info": {"method_name": "_CompareSavedModel._CompareSignatureDef", "method_params": "original_def,converted_def,is_input", "method_startline": "469", "method_endline": "481"}}, "hunk_10": {"Ismethod": 1, "added_lines": "504,505", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_NoInputs.run", "method_params": "self", "method_startline": "504", "method_endline": "505"}}, "hunk_11": {"Ismethod": 1, "added_lines": "531,532", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_TwoInputs.run", "method_params": "self,inp1,inp2", "method_startline": "531", "method_endline": "532"}}, "hunk_12": {"Ismethod": 1, "added_lines": "638,639", "deleted_lines": null, "method_info": {"method_name": "_TestStaticOp", "method_params": "self,use_function_backup", "method_startline": "634", "method_endline": "683"}}, "hunk_13": {"Ismethod": 1, "added_lines": "555,556,557,558,559,560", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_TwoOutputSignatureKeys.run", "method_params": "self,inp", "method_startline": "555", "method_endline": "560"}}, "hunk_14": {"Ismethod": 1, "added_lines": "537,538,539,540,541,542,543,544,545", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_OneOutputSignatureKey", "method_params": "self", "method_startline": "537", "method_endline": "545"}}, "hunk_15": {"Ismethod": 1, "added_lines": "406,415", "deleted_lines": "404,413", "method_info": {"method_name": "testTrtGraphConverter_DestroyEngineCache", "method_params": "self", "method_startline": "398", "method_endline": "445"}}, "hunk_16": {"Ismethod": 1, "added_lines": "450,451,452,453,454,455,456,457,458,459,460", "deleted_lines": null, "method_info": {"method_name": "_CompareSavedModel._GetModelPaths", "method_params": "model_class", "method_startline": "450", "method_endline": "460"}}, "hunk_17": {"Ismethod": 1, "added_lines": "548,549,550,551,552,553,554,555,556,557,558,559,560,561,562", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_TwoOutputSignatureKeys", "method_params": "self", "method_startline": "548", "method_endline": "562"}}, "hunk_18": {"Ismethod": 1, "added_lines": "331,359,369,372,394", "deleted_lines": "329,357,367,370,392", "method_info": {"method_name": "testTrtGraphConverter_BasicConversion_v2", "method_params": "self", "method_startline": "323", "method_endline": "395"}}, "hunk_19": {"Ismethod": 1, "added_lines": "499,500,501,502,503,504,505,506,507", "deleted_lines": null, "method_info": {"method_name": "testRetainSignatureInfo_NoInputs", "method_params": "self", "method_startline": "499", "method_endline": "507"}}, "hunk_20": {"Ismethod": 1, "added_lines": "462,463,464,465,466,467", "deleted_lines": null, "method_info": {"method_name": "_CompareSavedModel._GetSignatureDef", "method_params": "export_dir", "method_startline": "462", "method_endline": "467"}}}}}}}