{"BR": {"BR_id": "35306", "BR_author": "gmrhub", "BRopenT": "2019-12-20T11:38:08Z", "BRcloseT": "2020-02-20T00:18:57Z", "BR_text": {"BRsummary": "A possible bug in ConvRNN2D __call__", "BRdescription": "\n Referring to\n <denchmark-link:https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/layers/convolutional_recurrent.py#L294-L341>ConvRNN2D.call</denchmark-link>\n \n L308  kwargs['initial_state'] = initial_state and L317 kwargs['constants'] = constants should be added in the else block at L340. The current situation contradicts with the use of full_input at L337.\n I am not sure if we can simply replicate the code from its parent <denchmark-link:https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/layers/recurrent.py#L640-L700>RNN.call</denchmark-link>\n .\n I went ahead and tried it, but after loading the saved model weights in a complete new python session the results on validation data doesn't match at all.\n I would appreciate a quick fix for local edit at least.\n Thanks\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "gmrhub", "commentT": "2019-12-23T09:57:32Z", "comment_text": "\n \t\tCan you please  help us with simple standalone code to reproduce the issue in our environment. It helps us in localizing the issue faster. Which TensorFlow version you are using?.Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "gmrhub", "commentT": "2019-12-23T10:18:31Z", "comment_text": "\n \t\tPlease refer the linked issue. That support is never resolved, people tried their own ways.\n So while I was skimming through the code I noticed the bug and suggested the line numbers.\n It seems that feature is never tested. After fixing the code it works but has another problem of non reproducible results when re loading the weights (in a new run). I think somehow it behaves like stateful model, which is not.\n I'm using tf 2.0, but the code in master branch is same.\n Since you asked, an example model:\n `\n from tensorflow.keras import layers\n import tensorflow.keras as keras\n encoder_inputs = layers.Input((None,32,32,3))\n encoder = layers.ConvLSTM2D(filters=32, kernel_size=(3, 3), padding=\"same\", return_sequences=False, return_state=True)\n encoder_outputs, state_h, state_c = encoder(encoder_inputs)\n encoder_states = [state_h, state_c]\n decoder_inputs = layers.Input((None,32,32,4))\n decoder_lstm = layers.ConvLSTM2D(filters=32, kernel_size=(3, 3), padding=\"same\", return_sequences=False, return_state=True)\n decoder_outputs, _, _ = decoder_lstm([decoder_inputs,state_h, state_c])\n output = layers.Conv2D(1, (3,3), padding=\"same\", activation=\"relu\")(decoder_outputs)\n model = keras.Model([encoder_inputs, decoder_inputs], output)\n `\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "gmrhub", "commentT": "2019-12-24T06:49:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/gmrhub>@gmrhub</denchmark-link>\n \n I have tried on colab with TF version 2.0,2.1.0-rc1 and i am seeing .Please, find the gist <denchmark-link:https://colab.sandbox.google.com/gist/ravikyram/47bd873e15b693985657da79121bc541/untitled498.ipynb>here</denchmark-link>\n .Is this the expected behavior?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "gmrhub", "commentT": "2019-12-24T07:56:23Z", "comment_text": "\n \t\tYes, that error is due to the lines I mentioned above.\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Tue, 24 Dec 2019 at 12:19 PM, ravikyram ***@***.***> wrote:\n  @gmrhub <https://github.com/gmrhub>\n  I have tried on colab with TF version 2.0,2.1.0-rc1 and i am seeing AssertionError:\n  .Please, find the gist here\n  <https://colab.sandbox.google.com/gist/ravikyram/47bd873e15b693985657da79121bc541/untitled498.ipynb>.Is\n  this the expected behavior?\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#35306?email_source=notifications&email_token=ACSHLKBXQLZHJZ7ZEJWO5DLQ2GWIPA5CNFSM4J54YP5KYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOEHSUCTI#issuecomment-568672589>,\n  or unsubscribe\n  <https://github.com/notifications/unsubscribe-auth/ACSHLKDD5JLODB467XTV62LQ2GWIPANCNFSM4J54YP5A>\n  .\n \n \n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "gmrhub", "commentT": "2020-01-15T18:26:18Z", "comment_text": "\n \t\tRelated stackoverflow with a workaround that allowed me to train successfully (tf 1.14): <denchmark-link:https://stackoverflow.com/questions/50253138/convlstm2d-initial-state-assertion-error>https://stackoverflow.com/questions/50253138/convlstm2d-initial-state-assertion-error</denchmark-link>\n \n In line 331 in  ConvRNN2D.__call__() : change\n    if K.is_keras_tensor(additional_inputs[0]):\n to\n   if False and K.is_keras_tensor(additional_inputs[0]):\n preventing the if statement from executing.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "gmrhub", "commentT": "2020-02-15T00:25:05Z", "comment_text": "\n \t\tSorry for the very late reply. I will take a look and fix the issue.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "gmrhub", "commentT": "2020-02-20T00:18:58Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/35306>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/35306>No</denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "gmrhub", "commentT": "2020-03-08T04:25:58Z", "comment_text": "\n \t\ttf.version=1.15.0\n tf.keras.version = 2.2.4-tf\n I encounter a similar problem when using tf.keras.layers.convLSTM2D with initial_state being input. The code raises the problem is\n <denchmark-code>de_convlstm = ConvLSTM2D(filters=64, kernel_size=(5, 5), name='de_convlstm',\n                              return_state=True, padding='same', return_sequences=True)\n decoder_convlstm, h, c = de_convlstm(inputs=[decoder_conv2d_2, h, c])\n </denchmark-code>\n \n Following a possible solution in <denchmark-link:https://github.com/keras-team/keras/issues/9761#issuecomment-381058540>keras-team/keras#9761 (comment)</denchmark-link>\n , I remove\n <denchmark-code>inputs, initial_state, constants = self._standardize_args(\n             inputs, initial_state, constants)\n </denchmark-code>\n \n from tensorflow_core/python/keras/layers/convolutional_recurrent.py. However, the following ValueError is reported\n ValueError: Variable <tf.Variable 'en3_trans/kernel:0' shape=(1, 1, 5, 8) dtype=float32> has None for gradient. Please make sure that all of your ops have a gradient defined (i.e. are differentiable). Common ops without gradient: K.argmax, K.round, K.eval\n BTW, I am really sure that my code runs well without initial_state being assigned, such as\n <denchmark-code>de_convlstm = ConvLSTM2D(filters=64, kernel_size=(5, 5), name='de_convlstm',\n                              return_state=True, padding='same', return_sequences=True)\n decoder_convlstm, h, c = de_convlstm(inputs=decoder_conv2d_2)\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "74c9e141067c804bb9a5f94df9342d270cc01f75", "commit_author": "Scott Zhu", "commitT": "2020-02-19 16:08:44-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\keras\\layers\\convolutional_recurrent.py", "file_new_name": "tensorflow\\python\\keras\\layers\\convolutional_recurrent.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "318,319,320", "deleted_lines": "317,318,319,320", "method_info": {"method_name": "step", "method_params": "inputs,states", "method_startline": "317", "method_endline": "320"}}, "hunk_1": {"Ismethod": 1, "added_lines": "302,303,318,319,320", "deleted_lines": "295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342", "method_info": {"method_name": "__call__", "method_params": "self,inputs,initial_state,constants,kwargs", "method_startline": "295", "method_endline": "342"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\layers\\convolutional_recurrent_test.py", "file_new_name": "tensorflow\\python\\keras\\layers\\convolutional_recurrent_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233", "deleted_lines": null, "method_info": {"method_name": "test_conv_lstm_with_initial_state", "method_params": "self", "method_startline": "205", "method_endline": "233"}}}}}}}