{"BR": {"BR_id": "40839", "BR_author": "mchanchee", "BRopenT": "2020-06-26T16:24:28Z", "BRcloseT": "2020-07-08T19:49:10Z", "BR_text": {"BRsummary": "tf.io.decode_image(img, channels=3) outputs 4 channels when reading 4-channel BMP", "BRdescription": "\n  attached a sample BMP file\n <denchmark-link:https://github.com/tensorflow/tensorflow/files/4845825/rgb32.zip>rgb32.zip</denchmark-link>\n \n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No\n OS Platform and Distribution: Windows 10\n TensorFlow installed from (source or binary): binary (pip)\n TensorFlow version: 2.2.0\n Python version: 3.7.7\n \n Describe the current behavior\n When reading in a 4-channel BMP:\n \n tf.io.decode_image(img, channels=3) gives shape (..., ..., 4) instead of (..., ..., 3)\n tf.io.decode_bmp(img, channels=3) gives the following error\n \n <denchmark-code>Traceback (most recent call last):\n   File \"channels.py\", line 44, in <module>\n     loop()\n   File \"channels.py\", line 14, in loop\n     img = tf.io.decode_bmp(img, channels=3)\n   File \"C:\\Users\\mattchee\\Miniconda3\\lib\\site-packages\\tensorflow\\python\\ops\\gen_image_ops.py\", line 899, in decode_bmp\n     _ops.raise_from_not_ok_status(e, name)\n   File \"C:\\Users\\mattchee\\Miniconda3\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py\", line 6653, in raise_from_not_ok_status     \n     six.raise_from(core._status_to_exception(e.code, message), None)\n   File \"<string>\", line 3, in raise_from\n tensorflow.python.framework.errors_impl.InvalidArgumentError: channels attribute 3 does not match bits per pixel from file 4 [Op:DecodeBmp]\n </denchmark-code>\n \n I'm following <denchmark-link:https://www.tensorflow.org/tutorials/load_data/images#load_using_tfdata>this guide</denchmark-link>\n  to load images efficiently so  is not an option.\n Describe the expected behavior\n This is inconsistent with tf.io.decode_image(img, channels=3) and tf.io.decode_png(img, channels=3) which give shape (..., ..., 3) when reading a 4-channel PNG.\n Both tf.io.decode_image(img, channels=3) and tf.io.decode_bmp(img, channels=3) would be expected to give shape (..., ..., 3) when reading in a 4-channel BMP.\n Standalone code to reproduce the issue\n img = tf.io.read_file(img_path)\n img = tf.io.decode_image(img, channels=3)\n print(img.shape) # This prints (64, 127, 4)\n Or\n img = tf.io.read_file(img_path)\n img = tf.io.decode_bmp(img, channels=3) # Error\n print(img.shape)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mchanchee", "commentT": "2020-06-27T16:54:25Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mchanchee>@mchanchee</denchmark-link>\n  Can you share a sample bmp file to reproduce the issue?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "mchanchee", "commentT": "2020-06-28T16:44:18Z", "comment_text": "\n \t\tCan you also test with tf-nightly. There has been a refactoring of tf.io.decode_image recently which I think covers this issue too.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "mchanchee", "commentT": "2020-06-29T03:36:32Z", "comment_text": "\n \t\tThank you for reporting the issue. It appears to be an inherent issue with decode_bmp op. I will look into it and loop back with updates. In the meantime, it would be helpful if you could please share the bmp file for reproducing the issue.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "mchanchee", "commentT": "2020-06-29T13:40:33Z", "comment_text": "\n \t\tThank you for looking into it\n <denchmark-link:https://github.com/yongtang>@yongtang</denchmark-link>\n  <denchmark-link:https://github.com/hyeygit>@hyeygit</denchmark-link>\n   I've added a sample BMP file to the issue description.\n <denchmark-link:https://github.com/mihaimaruseac>@mihaimaruseac</denchmark-link>\n  I've tried with  and got the same problem as described above.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "mchanchee", "commentT": "2020-07-08T19:49:10Z", "comment_text": "\n \t\tI've tried it with tf-nightly 2.4.0-dev20200708 and it's all good.\n Thank you very much for fixing the issue!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "mchanchee", "commentT": "2020-07-08T19:49:12Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/40839>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/40839>No</denchmark-link>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "mchanchee", "commentT": "2020-07-09T02:55:37Z", "comment_text": "\n \t\tAgain, thank you for reporting, also for confirming that the issue is fixed!\n \t\t"}}}, "commit": {"commit_id": "0859ec0386ffa55739cbe831f38942c53027c12f", "commit_author": "Hye Soo Yang", "commitT": "2020-07-06 10:50:42-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\BUILD", "file_new_name": "tensorflow\\core\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "3005,3006,3007,3008,3009,3010,3011", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\core\\kernels\\decode_image_op.cc", "file_new_name": "tensorflow\\core\\kernels\\decode_image_op.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "906,907,914,916,919,921,924,925,926,927,928,929,930,931,932,933,934", "deleted_lines": "898,899,906,908,911,913,928,931", "method_info": {"method_name": "tensorflow::DecodeImageV2Op::DecodeBMP", "method_params": "input,row_size,output,width,height,channels,top_down", "method_startline": "896", "method_endline": "936"}}, "hunk_1": {"Ismethod": 1, "added_lines": "906,907,914,916,919,921,924,925,926,927,928,929,930,931,932,933,934,941,942,943,944,945,952,953,954,955,956,959", "deleted_lines": "906,908,911,913,928,931", "method_info": {"method_name": "tensorflow::DecodeImageV2Op::DecodeBMP", "method_params": "input,row_size,output,width,height,output_channels,input_channels,top_down", "method_startline": "904", "method_endline": "964"}}, "hunk_2": {"Ismethod": 1, "added_lines": "790,791,792,793,794,795,796,797,798,819,820,821,822,823,824,825,826,827,828,829,833,836,851,852,853,859,861,862,864,866", "deleted_lines": "789,790,791,792,793,794,795,796,797,798,799,800,801,802,823,827,830,845,846,852,854,856,858,876,877,879", "method_info": {"method_name": "tensorflow::DecodeImageV2Op::DecodeBmpV2", "method_params": "context,input", "method_startline": "764", "method_endline": "881"}}}}, "file_2": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small.bmp"}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small_3channels.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small_3channels.bmp"}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small_4channels.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\grayscale_small_4channels.bmp"}, "file_5": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgb_small.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgb_small.bmp"}, "file_6": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgb_small_255.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgb_small_255.bmp"}, "file_7": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgba_small.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgba_small.bmp"}, "file_8": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgba_small_255.bmp", "file_new_name": "tensorflow\\core\\lib\\bmp\\testdata\\rgba_small_255.bmp"}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\ops\\image_ops_impl.py", "file_new_name": "tensorflow\\python\\ops\\image_ops_impl.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2667,2668,2671,2672", "deleted_lines": "2667,2670", "method_info": {"method_name": "_bmp", "method_params": "", "method_startline": "2658", "method_endline": "2672"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\ops\\image_ops_test.py", "file_new_name": "tensorflow\\python\\ops\\image_ops_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "5182,5183,5184,5185,5186,5187,5188,5189,5190,5191,5192,5193,5194,5195,5196,5197,5198,5199,5200,5201,5202,5203,5204,5205,5206,5207,5208,5209,5210,5211,5212,5213,5214,5215,5216,5217,5218,5219,5220,5221,5222,5223,5224,5225,5226,5227,5228,5229,5230,5231,5232,5233,5234", "deleted_lines": null, "method_info": {"method_name": "testBmpChannels", "method_params": "self", "method_startline": "5182", "method_endline": "5234"}}}}}}}