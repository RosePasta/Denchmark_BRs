{"BR": {"BR_id": "22438", "BR_author": "jilljenn", "BRopenT": "2018-09-21T07:00:58Z", "BRcloseT": "2019-08-08T18:03:58Z", "BR_text": {"BRsummary": "InvalidArgumentError when SparseTensorValue is not ordered by row then col", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac OS 10.13.6\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: no\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): v1.10.0-rc1-19-g656e7a2b34 1.10.0\n Python version: 3.6.5\n Bazel version (if compiling from source): no\n GCC/Compiler version (if compiling from source): no\n CUDA/cuDNN version: no\n GPU model and memory: no\n Exact command to reproduce: python bug.py\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n If we feed a SparseTensorValue to tf.data.Dataset.from_tensor_slices such that its indices are not lexicographically sorted by row then col, then we will get a InvalidArgumentError.\n Maybe it could be said in the docs, or the error should provide a clearer message. It was hard to guess that indices[2] = [1,0] is out of order meant the indices were not provided in lexicographic order.\n I finally saw that it was explained in the <denchmark-link:https://www.tensorflow.org/api_docs/python/tf/SparseTensor>SparseTensor docs</denchmark-link>\n , but I feel it should be said in the <denchmark-link:https://www.tensorflow.org/api_docs/python/tf/SparseTensorValue>SparseTensorValue docs</denchmark-link>\n  as well.\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n from scipy.sparse import csr_matrix\n import tensorflow as tf\n import numpy as np\n \n \n M = np.array([[0, 1, 1], [1, 0, 0], [1, 0, 2], [0, 1, 1]])\n \n # First observation: these two slicing operations provide different orderings\n S = csr_matrix(M)[1:3].tocoo()\n print('1:3', S.row, S.col)\n S = csr_matrix(M)[[1, 2]].tocoo()\n print('1,2', S.row, S.col)\n \n entries = np.column_stack((S.row, S.col, S.data))\n ordering = np.arange(len(S.data))\n \n # Uncomment the following line to fix the error\n # ordering = np.lexsort((S.col, S.row))  # Sort by row then col\n \n X_train = tf.SparseTensorValue(indices=entries[ordering, :2],\n                                values=entries[ordering, 2],\n                                dense_shape=S.shape)\n \n dataset = tf.data.Dataset.from_tensor_slices(X_train)\n iterator = dataset.make_initializable_iterator()\n X_sample = iterator.get_next()\n \n with tf.Session() as sess:\n     sess.run(iterator.initializer)\n     print(sess.run(X_sample))\n <denchmark-code>Traceback (most recent call last):\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1278, in _do_call\n     return fn(*args)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1263, in _run_fn\n     options, feed_dict, fetch_list, target_list, run_metadata)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1350, in _call_tf_sessionrun\n     run_metadata)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: indices[2] = [1,0] is out of order\n      [[Node: SerializeManySparse = SerializeManySparse[T=DT_INT64, out_type=DT_VARIANT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](tensors/SparseTensor/indices, tensors/SparseTensor/values, tensors/SparseTensor/dense_shape)]]\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"bug.py\", line 27, in <module>\n     sess.run(iterator.initializer)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 877, in run\n     run_metadata_ptr)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1100, in _run\n     feed_dict_tensor, options, run_metadata)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1272, in _do_run\n     run_metadata)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1291, in _do_call\n     raise type(e)(node_def, op, message)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: indices[2] = [1,0] is out of order\n      [[Node: SerializeManySparse = SerializeManySparse[T=DT_INT64, out_type=DT_VARIANT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](tensors/SparseTensor/indices, tensors/SparseTensor/values, tensors/SparseTensor/dense_shape)]]\n \n Caused by op 'SerializeManySparse', defined at:\n   File \"bug.py\", line 22, in <module>\n     dataset = tf.data.Dataset.from_tensor_slices(X_train)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 254, in from_tensor_slices\n     return TensorSliceDataset(tensors)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1173, in __init__\n     self._tensors = sparse.serialize_many_sparse_tensors(tensors)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/data/util/sparse.py\", line 132, in serialize_many_sparse_tensors\n     for tensor in nest.flatten(tensors)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/data/util/sparse.py\", line 132, in <listcomp>\n     for tensor in nest.flatten(tensors)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/ops/sparse_ops.py\", line 1469, in serialize_many_sparse\n     out_type=out_type)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/ops/gen_sparse_ops.py\", line 502, in serialize_many_sparse\n     out_type=out_type, name=name)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n     op_def=op_def)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 454, in new_func\n     return func(*args, **kwargs)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3155, in create_op\n     op_def=op_def)\n   File \"/Users/jilljenn/code/vae/venv/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1717, in __init__\n     self._traceback = tf_stack.extract_stack()\n \n InvalidArgumentError (see above for traceback): indices[2] = [1,0] is out of order\n      [[Node: SerializeManySparse = SerializeManySparse[T=DT_INT64, out_type=DT_VARIANT, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"](tensors/SparseTensor/indices, tensors/SparseTensor/values, tensors/SparseTensor/dense_shape)]]\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jilljenn", "commentT": "2018-09-21T23:18:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jilljenn>@jilljenn</denchmark-link>\n  Good catch and agreed that more clarity on SparseTensorValue would help.\n <denchmark-link:https://github.com/MarkDaoust>@MarkDaoust</denchmark-link>\n  Can you take a look at this?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jilljenn", "commentT": "2018-09-29T03:43:07Z", "comment_text": "\n \t\tClosing this issue, we will add this to the future release.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jilljenn", "commentT": "2019-08-08T12:16:29Z", "comment_text": "\n \t\tI've also met this error and been confused this message.\n I hope you to implement some sorting function to avoid this error as well as to update the error message.\n \n Environment:\n \n macOS: 10.14.4\n docker: 19.03.1\n docker image: tensorflow/tensorflow:latest-py3\n \n \n \n Sorry, I missed to find the description and the function.\n \n https://www.tensorflow.org/api_docs/python/tf/sparse/SparseTensor\n https://www.tensorflow.org/api_docs/python/tf/sparse/reorder\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jilljenn", "commentT": "2019-08-08T18:16:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hiro-o918>@hiro-o918</denchmark-link>\n  thanks for pinging this bug,\n I've improved the error message to point people in the right direction:\n <denchmark-code> InvalidArgumentError (see above for traceback): indices[2] = [1,0] is out of order. Many sparse ops require sorted indices.\n     Use `tf.sparse.reorder` to create a correctly ordered copy.\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "eb625fb51a302dc812c97879697642db9aa8cfc1", "commit_author": "Mark Daoust", "commitT": "2019-08-08 11:01:48-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\core\\util\\sparse\\sparse_tensor.h", "file_new_name": "tensorflow\\core\\util\\sparse\\sparse_tensor.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "315,316,317,318,319", "deleted_lines": "315", "method_info": {"method_name": "tensorflow::sparse::SparseTensor::IndexValid", "method_params": "ix_t,n", "method_startline": "286", "method_endline": "326"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\core\\util\\sparse\\sparse_tensor_test.cc", "file_new_name": "tensorflow\\core\\util\\sparse\\sparse_tensor_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "194,195,196,197,198,199", "deleted_lines": "194,195", "method_info": {"method_name": "tensorflow::sparse::TEST", "method_params": "SparseTensorTest,SparseTensorConstruction", "method_startline": "169", "method_endline": "225"}}}}}}}