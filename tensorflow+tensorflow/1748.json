{"BR": {"BR_id": "1748", "BR_author": "elanmart", "BRopenT": "2016-04-02T15:05:39Z", "BRcloseT": "2016-06-06T20:51:06Z", "BR_text": {"BRsummary": "Optimizers incompatible with sampling -- missing docs?", "BRdescription": "\n Hi,\n perhaps Tensorflow docs should mention that 5 out of 7 available optimizers will not work with sampling losses? For now, they fail with mysterious messages.\n The following script will fail for Momentum, AdaGrad, AdaDelta, RMSProp and FTRL.\n Also, where should I look if I'd like to implement my own optimizers for GPU?\n import tensorflow as tf\n import numpy.random as nr\n import numpy as np\n \n # config \n num_classes = 10000\n num_sampled = 512\n num_true = 32\n activation_dim = 512\n batch_sz = 16\n \n # \"model\" setup\n activations = tf.placeholder(tf.float32, shape=(None, activation_dim))\n labels = tf.placeholder(tf.int64, shape=(None, num_true))\n \n nce_W = tf.Variable(tf.truncated_normal((num_classes, activation_dim)))\n nce_b = tf.Variable(tf.truncated_normal((num_classes, )))\n \n nce_loss = tf.reduce_mean(\n                 tf.nn.nce_loss(nce_W, nce_b, \n                                activations, labels, \n                                num_sampled, num_classes, num_true))\n \n # optimizer setup\n global_step   = tf.Variable(1)\n initial_alpha = tf.Variable(0.1)\n alpha         = tf.Variable(0.01)\n \n optimizer = tf.train.FtrlOptimizer(alpha)\n \n # fetches\n step = optimizer.minimize(nce_loss, global_step=global_step, name='sgd_step') \n init = tf.initialize_all_variables()\n \n # synthetic data\n X = nr.randn(batch_sz, activation_dim).astype(np.float32)\n y = nr.randint(0, num_classes, (batch_sz, num_true)).astype(np.int64)\n \n with tf.Session() as sess:\n     sess.run(init)\n     sess.run(step, feed_dict={activations:X, labels:y})\n The error message is:\n <denchmark-code>---------------------------------------------------------------------------\n StatusNotOK                               Traceback (most recent call last)\n StatusNotOK: Invalid argument: Cannot assign a device to node 'Variable_1/read': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'\n      [[Node: Variable_1/read = Identity[T=DT_FLOAT, _class=[\"loc:@Variable_1\"]](Variable_1)]]\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "elanmart", "commentT": "2016-04-07T01:53:30Z", "comment_text": "\n \t\tDoes pinning the variables to CPU make this work? i.e.\n with tf.device(\"/cpu:0\"):\n   nce_W = \u2026\n   nce_b = \u2026\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "elanmart", "commentT": "2016-06-06T20:51:06Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  I assume this is fixed now, in that we don't do improper placement, but I'm not sure all sparse optimizers are supported on GPU, which is perhaps another bug which I believe we already have an issue for.\n \t\t"}}}, "commit": {"commit_id": "c34a0d7ea6b557588a7a0c9f9c4e60d59f593af7", "commit_author": "Vijay Vasudevan", "commitT": "2016-05-12 16:31:33-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\BUILD", "file_new_name": "tensorflow\\core\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1368", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "tensorflow\\core\\common_runtime\\direct_session.cc", "file_new_name": "tensorflow\\core\\common_runtime\\direct_session.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "656,657,658,659,660,664,668,703,704,705", "deleted_lines": "685,687,688,692,727,728,729", "method_info": {"method_name": "tensorflow::DirectSession::GetOrCreateExecutors", "method_params": "inputs,outputs,target_nodes,executors_and_keys,run_state_args", "method_startline": "618", "method_endline": "779"}}, "hunk_1": {"Ismethod": 1, "added_lines": "214,215,216,217,219,220,221", "deleted_lines": "213,214,215,216,217,218,219,220,221,222,223,224,225", "method_info": {"method_name": "tensorflow::DirectSession::ExtendLocked", "method_params": "graph", "method_startline": "213", "method_endline": "225"}}, "hunk_2": {"Ismethod": 1, "added_lines": "805,806,807,810,811,812", "deleted_lines": "805,806,807,808,809,812", "method_info": {"method_name": "tensorflow::DirectSession::SaveStatefulNodes", "method_params": "graph", "method_startline": "805", "method_endline": "812"}}, "hunk_3": {"Ismethod": 1, "added_lines": "814,815,816,817,818,819,820,821,822,823,824", "deleted_lines": "814,815,816,817,818,819,820,823,824", "method_info": {"method_name": "tensorflow::DirectSession::RestoreStatefulNodes", "method_params": "graph", "method_startline": "814", "method_endline": "824"}}, "hunk_4": {"Ismethod": 1, "added_lines": "826,827,831,833,837,838,856,857,858,898,903", "deleted_lines": "826,827,828,829,830,831,832,833,834,835,836,837,838,839,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,865,880,920,925,943", "method_info": {"method_name": "tensorflow::DirectSession::CreateGraphs", "method_params": "feeds,fetches,target_nodes,func_defs,outputs,run_state_args", "method_startline": "826", "method_endline": "945"}}, "hunk_5": {"Ismethod": 1, "added_lines": "781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,802,803,804,805,806,807,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,831,833,837,838,856,857,858,898,903", "deleted_lines": "805,806,807,808,809,812,814,815,816,817,818,819,820,823,824,826,827,828,829,830,831,832,833,834,835,836,837,838,839,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,865,880,920", "method_info": {"method_name": "tensorflow::DirectSession::CreateGraphs", "method_params": "options,outputs,run_state_args", "method_startline": "781", "method_endline": "922"}}, "hunk_6": {"Ismethod": 1, "added_lines": "180,181,182,183", "deleted_lines": null, "method_info": {"method_name": "tensorflow::DirectSession::~DirectSession", "method_params": "", "method_startline": "166", "method_endline": "183"}}, "hunk_7": {"Ismethod": 1, "added_lines": "185,186,187,188,189,190,191,192,193,194,195,196", "deleted_lines": null, "method_info": {"method_name": "tensorflow::DirectSession::MaybeInitializeExecutionState", "method_params": "graph", "method_startline": "185", "method_endline": "197"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\core\\common_runtime\\direct_session.h", "file_new_name": "tensorflow\\core\\common_runtime\\direct_session.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "122", "method_info": {"method_name": "tensorflow::DirectSession::ExecutorsAndKeys::~ExecutorsAndKeys", "method_params": "", "method_startline": "117", "method_endline": "125"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\core\\common_runtime\\direct_session_test.cc", "file_new_name": "tensorflow\\core\\common_runtime\\direct_session_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "243,244,245,259", "deleted_lines": "243,257", "method_info": {"method_name": "tensorflow::TEST_F", "method_params": "DirectSessionMinusAXTest,InvalidDevice", "method_startline": "225", "method_endline": "262"}}, "hunk_1": {"Ismethod": 1, "added_lines": "437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478", "deleted_lines": null, "method_info": {"method_name": "tensorflow::TEST", "method_params": "DirectSessionTest,PlacePrunedGraph", "method_startline": "437", "method_endline": "478"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tensorflow\\core\\common_runtime\\simple_graph_execution_state.cc", "file_new_name": "tensorflow\\core\\common_runtime\\simple_graph_execution_state.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "205,211,212,213,214,215,216,217,218", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::BuildGraph", "method_params": "options,out", "method_startline": "199", "method_endline": "234"}}, "hunk_1": {"Ismethod": 1, "added_lines": "154,155,156,157,158,159,160,161", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::SaveStatefulNodes", "method_params": "graph", "method_startline": "154", "method_endline": "161"}}, "hunk_2": {"Ismethod": 1, "added_lines": "113,114,115,116,117,118,119,120,122,123", "deleted_lines": "113", "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::InitBaseGraph", "method_params": "", "method_startline": "113", "method_endline": "123"}}, "hunk_3": {"Ismethod": 1, "added_lines": "175,176,181,182,183,184,185,186,187,188,189,190,194", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::InitBaseGraph", "method_params": "options", "method_startline": "175", "method_endline": "197"}}, "hunk_4": {"Ismethod": 1, "added_lines": "163,164,165,166,167,168,169,170,171,172,173", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::RestoreStatefulNodes", "method_params": "graph", "method_startline": "163", "method_endline": "173"}}, "hunk_5": {"Ismethod": 1, "added_lines": "91,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,122,123,124,125,126,127,128,129,130,131,132,133,136,145", "deleted_lines": "94,113,131,137,138,139,140,141", "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::Extend", "method_params": "extension_def,out", "method_startline": "68", "method_endline": "152"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tensorflow\\core\\common_runtime\\simple_graph_execution_state.h", "file_new_name": "tensorflow\\core\\common_runtime\\simple_graph_execution_state.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "119,120,121,122", "deleted_lines": "120", "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::full_graph", "method_params": "", "method_startline": "119", "method_endline": "122"}}, "hunk_1": {"Ismethod": 1, "added_lines": "126", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::original_graph_def", "method_params": "", "method_startline": "126", "method_endline": "126"}}, "hunk_2": {"Ismethod": 1, "added_lines": "137,138,139,140", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::SetStatefulPlacements", "method_params": "sp", "method_startline": "137", "method_endline": "140"}}, "hunk_3": {"Ismethod": 1, "added_lines": "130,131,132,133", "deleted_lines": null, "method_info": {"method_name": "tensorflow::SimpleGraphExecutionState::GetStatefulPlacements", "method_params": "", "method_startline": "130", "method_endline": "133"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\core\\common_runtime\\simple_placer.cc", "file_new_name": "tensorflow\\core\\common_runtime\\simple_placer.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "662", "method_info": {"method_name": "tensorflow::SimplePlacer::Run", "method_params": "", "method_startline": "548", "method_endline": "672"}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "472", "method_info": {"method_name": "tensorflow::ColocationGraph::InitializeMember", "method_params": "node,member", "method_startline": "413", "method_endline": "487"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\protobuf\\config.proto", "file_new_name": "tensorflow\\core\\protobuf\\config.proto", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "83,84,85,86,87,88,89,90,91", "deleted_lines": null}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\client\\session.py", "file_new_name": "tensorflow\\python\\client\\session.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "901,902,903,904,905", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,target,graph,config", "method_startline": "883", "method_endline": "912"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\client\\session_test.py", "file_new_name": "tensorflow\\python\\client\\session_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750", "deleted_lines": null, "method_info": {"method_name": "testDefaultSessionPlacePrunedGraph", "method_params": "self", "method_startline": "731", "method_endline": "750"}}, "hunk_1": {"Ismethod": 1, "added_lines": "710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729", "deleted_lines": null, "method_info": {"method_name": "testInteractivePlacePrunedGraph", "method_params": "self", "method_startline": "710", "method_endline": "729"}}}}}}}