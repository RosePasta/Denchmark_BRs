{"BR": {"BR_id": "32029", "BR_author": "roebel", "BRopenT": "2019-08-28T00:13:46Z", "BRcloseT": "2020-02-20T23:00:36Z", "BR_text": {"BRsummary": "tensorflow.keras.Model.compute_output_shape gives wrong results", "BRdescription": "\n System information\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n yes\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04):\n linux Ubuntu 18.04\n \n \n TensorFlow installed from (source or binary):\n conda\n \n \n TensorFlow version (use command below):\n tried with 1.12.0 and 1.14.0\n \n \n Python version:\n 3.6\n \n \n Describe the current behavior\n using a keras model (stored in a variable mm) in tensorflow.keras I would like to calculate the output_shape for a given input. This works correctly only the first time I call mm.compute_output_shape(), the subsequent results for calling the same function with different shapes are inconsistent.\n Using standard keras methods I get different and consistent results.\n An example for the problem is implemented in the tf_bug.py script that you find in the zip\n if you call it without parameters it loads a fully convolutional model\n from a json file (provided in the zip) and does\n <denchmark-code>import json\n import tensorflow.keras as keras\n with open(\"model_tf_bug.json\", \"r\") as fi:  \n     kk=json.load(fi)  \n     mm=keras.models.model_from_json(json.dumps(kk)) \n \n for n in range(999, 1020):  \n      ss=[(1,n,1,1)]\n      print(ss,mm.compute_output_shape(input_shape=ss)) \n </denchmark-code>\n \n the result displaying the input and corresponding output shape on each line is\n <denchmark-code>[(1, 999, 1, 1)] (1, 481, 1, 1)\n [(1, 1000, 1, 1)] (1, 481, 1, 1)\n [(1, 1001, 1, 1)] (1, 482, 1, 1)\n [(1, 1002, 1, 1)] (1, 482, 1, 1)\n [(1, 1003, 1, 1)] (1, 483, 1, 1)\n [(1, 1004, 1, 1)] (1, 483, 1, 1)\n [(1, 1005, 1, 1)] (1, 484, 1, 1)\n [(1, 1006, 1, 1)] (1, 484, 1, 1)\n [(1, 1007, 1, 1)] (1, 482, 1, 1)\n [(1, 1008, 1, 1)] (1, 485, 1, 1)\n ...\n </denchmark-code>\n \n I kept only the relevant lines. You see that after the first lines that are correct\n starting with input shape 1007 the output shape decreases and starts to produce erratic behavior, while for the fully convolutional model it should increase monotonously with the input size.\n Describe the expected behavior\n Running the same script with argument keras uses the vanilla keras version 2.2.4\n and in this case the output shape increases  as expected\n <denchmark-code>[(1, 999, 1, 1)] (1, 481, 1, 1)\n [(1, 1000, 1, 1)] (1, 481, 1, 1)\n [(1, 1001, 1, 1)] (1, 482, 1, 1)\n [(1, 1002, 1, 1)] (1, 482, 1, 1)\n [(1, 1003, 1, 1)] (1, 483, 1, 1)\n [(1, 1004, 1, 1)] (1, 483, 1, 1)\n [(1, 1005, 1, 1)] (1, 484, 1, 1)\n [(1, 1006, 1, 1)] (1, 484, 1, 1)\n [(1, 1007, 1, 1)] (1, 485, 1, 1)\n [(1, 1008, 1, 1)] (1, 485, 1, 1)\n ...\n </denchmark-code>\n \n Note that I can get a correct result with tf.keras as well if I clear the model._output_shape_cache before I compute the output_shape.\n Running the script with argument clear uses a modified loop as follows\n <denchmark-code>for n in range(999, 1020):  \n      ss=[(1,n,1,1)]\n      if len(sys.argv) > 1 and sys.argv[1] == \"clear\":\n          mm._output_shape_cache.clear()\n      print(ss,mm.compute_output_shape(input_shape=ss)) \n </denchmark-code>\n \n The results are correct as expected.\n Looking into the function mm.compute_output_shape\n I found that compared to keras you changed the cache_key generation\n where keras does\n <denchmark-code>cache_key = ', '.join([str(x) for x in input_shapes])\n </denchmark-code>\n \n tf.keras does\n <denchmark-code>    cache_key = generic_utils.object_list_uid(input_shape)\n </denchmark-code>\n \n It appears that the cache_key in tf.keras confuses different input shapes as the same and returns wrong results from the cache.\n Code to reproduce the issue\n You find the script, model and output files in the zip\n <denchmark-link:https://github.com/tensorflow/tensorflow/files/3548512/tf_compute_output_shape_bug.zip>tf_compute_output_shape_bug.zip</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "roebel", "commentT": "2019-09-05T17:27:28Z", "comment_text": "\n \t\tWas able to reproduce the issue. Please find the attachment of github gist <denchmark-link:https://colab.sandbox.google.com/gist/gowthamkpr/b4519fb3fb254cd7daaecc7095070456/untitled127.ipynb>here</denchmark-link>\n . Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "roebel", "commentT": "2019-11-04T15:16:00Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/gowthamkpr>@gowthamkpr</denchmark-link>\n  Did you find the solution for this?\n I have similar problem: <denchmark-link:https://github.com/tensorflow/tensorflow/issues/33785>#33785</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "roebel", "commentT": "2020-02-20T23:00:37Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/32029>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/32029>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "3ba8bd697faf4b831f78c3fa547d7956f1b1a0aa", "commit_author": "Scott Zhu", "commitT": "2020-02-20 14:53:02-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\engine\\network.py", "file_new_name": "tensorflow\\python\\keras\\engine\\network.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "723,724,725", "deleted_lines": "723", "method_info": {"method_name": "compute_output_shape", "method_params": "self,input_shape", "method_startline": "711", "method_endline": "783"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\engine\\network_test.py", "file_new_name": "tensorflow\\python\\keras\\engine\\network_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1872,1873,1874,1875,1876,1877,1878,1879,1880", "deleted_lines": null, "method_info": {"method_name": "test_compute_output_shape_cache", "method_params": "self", "method_startline": "1872", "method_endline": "1880"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\utils\\generic_utils.py", "file_new_name": "tensorflow\\python\\keras\\utils\\generic_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "759,760,761,762", "method_info": {"method_name": "object_list_uid", "method_params": "object_list", "method_startline": "759", "method_endline": "762"}}}}}}}