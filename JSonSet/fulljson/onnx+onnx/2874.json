{"BR": {"BR_id": "2874", "BR_author": "matteosal", "BRopenT": "2020-07-01T15:07:14Z", "BRcloseT": "2020-08-11T16:25:09Z", "BR_text": {"BRsummary": "Shape inference doesn't work unless initializer tensors are also listed as inputs", "BRdescription": "\n <denchmark-h:h1>Bug Report</denchmark-h>\n \n <denchmark-h:h3>Describe the bug</denchmark-h>\n \n As title says\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution: Ubuntu 18.04\n ONNX version: 1.7 release commit\n Python version: 3.6.9\n GCC/Compiler version: 7.5.0\n CMake version: 3.17.3\n Protobuf version: 3.12\n \n <denchmark-h:h3>Reproduction instructions</denchmark-h>\n \n <denchmark-code>import onnx\n from onnx import helper, shape_inference\n from onnx import TensorProto\n \n print(\"************************* Without weights as inputs ******************************\")\n model_path = \"without_weights_as_inputs.onnx\"\n original_model = original_model = onnx.load(model_path)\n onnx.checker.check_model(original_model)\n \n print('Model inputs\\n{}'.format(original_model.graph.input))\n print('\\nValue info before shape inference:\\n{}'.format(original_model.graph.value_info))\n \n # Apply shape inference on the model\n inferred_model = shape_inference.infer_shapes(original_model)\n \n # Check the model and print Y's shape information\n onnx.checker.check_model(inferred_model)\n print('\\nValue info after shape inference:\\n{}'.format(inferred_model.graph.value_info))\n \n print(\"************************* With weights as inputs ******************************\")\n model_path = \"with_weights_as_inputs.onnx\"\n original_model = original_model = onnx.load(model_path)\n onnx.checker.check_model(original_model)\n \n print('Model inputs\\n{}'.format(original_model.graph.input))\n print('\\nValue info before shape inference:\\n{}'.format(original_model.graph.value_info))\n \n # Apply shape inference on the model\n inferred_model = shape_inference.infer_shapes(original_model)\n \n # Check the model and print Y's shape information\n onnx.checker.check_model(inferred_model)\n print('\\nValue info after shape inference:\\n{}'.format(inferred_model.graph.value_info))\n </denchmark-code>\n \n Model  has tensors in the initializer list that are not listed as inputs. Model  has those tensors listed as inputs as well. The above script shows that only model  has a successful shape inference, while shapes are not inferred for the first one. The <denchmark-link:https://github.com/onnx/onnx/blob/master/docs/IR.md>IR documentation</denchmark-link>\n  allows initializer tensor not being listed as inputs, stating that\n \n When an initializer has the same name as a graph input, it specifies a default value for that input. When an initializer has a name different from all graph inputs, it specifies a constant value.\n \n So it seems that shape inference should work on \"without_weights_as_inputs.onnx\"\n \n ONNX models\n models.zip\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n Shape inference should work on both models\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "matteosal", "commentT": "2020-07-02T01:05:21Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/matteosal>@matteosal</denchmark-link>\n ,\n Thank you for the detailed explanation. I encountered the same problem by your code.\n I would say it's similar to <denchmark-link:https://github.com/onnx/onnx/issues/2655>#2655</denchmark-link>\n  and <denchmark-link:https://github.com/onnx/onnx/issues/2660>#2660</denchmark-link>\n .\n According to the latest IR.md, shape inference should work for those tensors in the initializer list that are not listed as inputs, but it doesn't now... This issue is waiting for a correction. Thank you for pointing out.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "matteosal", "commentT": "2020-08-11T16:25:09Z", "comment_text": "\n \t\tIt should be resolved by <denchmark-link:https://github.com/onnx/onnx/pull/2901>#2901</denchmark-link>\n . Please reopen it if you still encounter this issue. Thanks.\n \t\t"}}}, "commit": {"commit_id": "c4bc80090e7f39552fc57ff8fc21481161d819b6", "commit_author": "Chun-Wei Chen", "commitT": "2020-08-11 09:00:22-07:00", "commit_complexity": {"commit_NLOC": "0.6962025316455697", "commit_CCN": "0.7088607594936709", "commit_Nprams": "0.5189873417721519"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "onnx\\shape_inference\\implementation.cc", "file_new_name": "onnx\\shape_inference\\implementation.cc", "file_complexity": {"file_NLOC": "425", "file_CCN": "108", "file_NToken": "3073"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "313,317", "deleted_lines": "304,318", "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapes", "method_params": "m,check_type,schema_registry", "method_startline": "302", "method_endline": "319", "method_complexity": {"method_NLOC": "18", "method_CCN": "2", "method_NToken": "100", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "336,350,351", "deleted_lines": null, "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapes", "method_params": "m,check_type,schema_registry", "method_startline": "334", "method_endline": "352", "method_complexity": {"method_NLOC": "19", "method_CCN": "2", "method_NToken": "107", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "162,163,164,165,187,188,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,232,313,317", "deleted_lines": "162,163,164,202,291,304,318", "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapesImpl", "method_params": "g,outer_scope_value_types_by_name,opset_imports,check_type,schema_registry,ir_version", "method_startline": "158", "method_endline": "318", "method_complexity": {"method_NLOC": "130", "method_CCN": "36", "method_NToken": "994", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "323", "deleted_lines": null, "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapes", "method_params": "g,opset_imports,check_type,schema_registry", "method_startline": "320", "method_endline": "332", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "57", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": null, "deleted_lines": "291", "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapes", "method_params": "g,opset_imports,check_type,schema_registry", "method_startline": "288", "method_endline": "300", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "56", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "162,163,164,165,187,188,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,232", "deleted_lines": "162,163,164,202", "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::InferShapesImpl", "method_params": "g,outer_scope_value_types_by_name,opset_imports,check_type,schema_registry", "method_startline": "158", "method_endline": "286", "method_complexity": {"method_NLOC": "107", "method_CCN": "32", "method_NToken": "800", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "509,510,511,512,513", "deleted_lines": null, "method_info": {"method_name": "ONNX_NAMESPACE::shape_inference::deleteCreatedTypes", "method_params": "initializerTypeList", "method_startline": "509", "method_endline": "513", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "28", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnx\\shape_inference\\implementation.h", "file_new_name": "onnx\\shape_inference\\implementation.h", "file_complexity": {"file_NLOC": "164", "file_CCN": "22", "file_NToken": "1032"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "187,194,203,204,206", "deleted_lines": "187,194,204"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "onnx\\test\\shape_inference_test.py", "file_new_name": "onnx\\test\\shape_inference_test.py", "file_complexity": {"file_NLOC": "2882", "file_CCN": "337", "file_NToken": "36624"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "3286,3287,3288,3289,3290,3291", "deleted_lines": null, "method_info": {"method_name": "test_infer_initializer_input_consistency_all_none", "method_params": "self", "method_startline": "3286", "method_endline": "3291", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "37", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "3293,3294,3295,3296,3297,3298", "deleted_lines": null, "method_info": {"method_name": "test_infer_initializer_input_consistency_single_none", "method_params": "self", "method_startline": "3293", "method_endline": "3298", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "37", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "3263,3264,3265,3266,3267,3268,3269,3270,3271,3272,3273,3274,3275,3276", "deleted_lines": null, "method_info": {"method_name": "test_infer_with_initializer_without_input_below_ir4", "method_params": "self", "method_startline": "3263", "method_endline": "3276", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "96", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "3251,3252,3253,3254,3255,3256,3257,3258,3259,3260,3261", "deleted_lines": null, "method_info": {"method_name": "test_infer_with_initializer_without_input_above_ir4", "method_params": "self", "method_startline": "3251", "method_endline": "3261", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "80", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "3300,3301,3302,3303,3304,3305", "deleted_lines": null, "method_info": {"method_name": "test_infer_initializer_input_consistency_differnt_rank", "method_params": "self", "method_startline": "3300", "method_endline": "3305", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "45", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "3278,3279,3280,3281,3282,3283,3284", "deleted_lines": null, "method_info": {"method_name": "test_infer_initializer_input_mismatch", "method_params": "self", "method_startline": "3278", "method_endline": "3284", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "43", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "3235,3236,3237,3238,3239,3240,3241,3242,3243,3244,3245,3246,3247,3248,3249", "deleted_lines": null, "method_info": {"method_name": "prepare_input_initializer_tensors", "method_params": "self,initializer_shape,input_shape", "method_startline": "3235", "method_endline": "3249", "method_complexity": {"method_NLOC": "14", "method_CCN": "3", "method_NToken": "142", "method_nesting_level": "1"}}}}}}}}