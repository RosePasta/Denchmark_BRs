{"BR": {"BR_id": "1899", "BR_author": "binshengliu", "BRopenT": "2020-05-20T06:25:58Z", "BRcloseT": "2020-06-23T15:21:25Z", "BR_text": {"BRsummary": "Incorrect number of batches when multiple test loaders are used and test_percent_check is specified", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n When there are multiple test dataloaders and test_percent_check is specified. The estimated total batches are incorrect and progress bar doesn't show properly.\n For example, when I specify two dataloaders each of which has 100 batches and test_percent_check=0.1. The expected total batches are 200*0.1=20. But actually, 40 batches are run.\n At this line, num_batches is the global number of batches and will be assigned to self.num_test_batches. \n \n \n pytorch-lightning/pytorch_lightning/trainer/data_loading.py\n \n \n          Line 243\n       in\n       3459a54\n \n \n \n \n \n \n  num_batches = int(num_batches * percent_check) \n \n \n \n \n \n while in the evaluation loop, max_batches is regarded as the number of batches for one data loader.\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/evaluation_loop.py\n \n \n          Line 262\n       in\n       3459a54\n \n \n \n \n \n \n  if batch_idx >= max_batches: \n \n \n \n \n \n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior:\n \n Return multiple dataloaders from test_dataloaders()\n Specify test_percent_check.\n Run trainer.test()\n Observe expected_batches * num_loaders be run. The progress bar also fails to show progress after expected_batches as it exceeds its specified total steps.\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n Run correct number of batches.\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n CUDA:\n \n GPU:\n available:         False\n version:           10.2\n \n \n Packages:\n \n numpy:             1.18.4\n pyTorch_debug:     False\n pyTorch_version:   1.5.0\n pytorch-lightning: 0.7.6\n tensorboard:       2.2.0\n tqdm:              4.45.0\n \n \n System:\n \n OS:                Linux\n architecture:\n \n 64bit\n \n \n \n processor:\n python:            3.7.6\n version:           #1 SMP Debian 4.19.118-2 (2020-04-29)\n \n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "binshengliu", "commentT": "2020-05-20T12:33:46Z", "comment_text": "\n \t\tJust had a look at this. The problem is in the trainer as you say, not the progress bar.\n There are two loops, the outer runs through the number of dataloaders and the inner loop runs through each.\n so the max batches should be the number of batches to run in each dataloader, not totally.\n We can easily fix this.\n There should really be a test. There seems to be no test that checks that *_percent_check works with the correct amount of data. we should definitely have these tests.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "binshengliu", "commentT": "2020-05-20T22:19:23Z", "comment_text": "\n \t\tSame case might be hapenning with val_dataloaders. max_batches should be a list I suggest.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "binshengliu", "commentT": "2020-05-21T04:25:02Z", "comment_text": "\n \t\tThat's true yes, I agree, because they could have different length.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "binshengliu", "commentT": "2020-05-21T17:53:56Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/awaelchli>@awaelchli</denchmark-link>\n  Anyone working on this or should I submit a PR? Need this to be fixed for a personal project debugging and testing.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "binshengliu", "commentT": "2020-05-21T17:59:23Z", "comment_text": "\n \t\tif you like, that would help us a lot .)\n I could help with the tests if you need help :)\n \t\t"}}}, "commit": {"commit_id": "e085e93dd303e80af2e9a5fe4aa392055c831114", "commit_author": "Adrian W\u00e4lchli", "commitT": "2020-06-23 11:21:24-04:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "21,22", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\__init__.py", "file_new_name": "pytorch_lightning\\trainer\\__init__.py", "file_complexity": {"file_NLOC": "1040", "file_CCN": "0", "file_NToken": "24"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "459,460,478,479", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\data_loading.py", "file_new_name": "pytorch_lightning\\trainer\\data_loading.py", "file_complexity": {"file_NLOC": "286", "file_CCN": "62", "file_NToken": "1600"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "290,291"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_new_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_complexity": {"file_NLOC": "334", "file_CCN": "37", "file_NToken": "1223"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "225,226,227,228,229,230", "deleted_lines": "225,229,230", "method_info": {"method_name": "_evaluate", "method_params": "self,LightningModule,int,bool", "method_startline": "225", "method_endline": "230", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "225,226,227,228,229,230,231,235,236,237,238,254,255,256,257", "deleted_lines": "225,229,230,231", "method_info": {"method_name": "_evaluate", "method_params": "self,LightningModule,dataloaders,bool", "method_startline": "225", "method_endline": "338", "method_complexity": {"method_NLOC": "63", "method_CCN": "19", "method_NToken": "437", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\trainer.py", "file_new_name": "pytorch_lightning\\trainer\\trainer.py", "file_complexity": {"file_NLOC": "1005", "file_CCN": "103", "file_NToken": "4300"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "226", "deleted_lines": "226"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\training_loop.py", "file_new_name": "pytorch_lightning\\trainer\\training_loop.py", "file_complexity": {"file_NLOC": "594", "file_CCN": "134", "file_NToken": "2934"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "211"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\base\\model_test_dataloaders.py", "file_new_name": "tests\\base\\model_test_dataloaders.py", "file_complexity": {"file_NLOC": "20", "file_CCN": "8", "file_NToken": "165"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "22,23,24,25", "deleted_lines": null, "method_info": {"method_name": "test_dataloader__multiple_mixed_length", "method_params": "self", "method_startline": "22", "method_endline": "25", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "36", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "10", "deleted_lines": "10", "method_info": {"method_name": "dataloader", "method_params": "self,args,kwargs", "method_startline": "10", "method_endline": "11", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "10", "deleted_lines": "10", "method_info": {"method_name": "dataloader", "method_params": "self,bool", "method_startline": "10", "method_endline": "11", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\base\\model_test_epoch_ends.py", "file_new_name": "tests\\base\\model_test_epoch_ends.py", "file_complexity": {"file_NLOC": "40", "file_CCN": "9", "file_NToken": "233"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "10", "deleted_lines": "10", "method_info": {"method_name": "test_epoch_end", "method_params": "self,outputs", "method_startline": "8", "method_endline": "39", "method_complexity": {"method_NLOC": "17", "method_CCN": "4", "method_NToken": "113", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "43", "deleted_lines": "43", "method_info": {"method_name": "test_epoch_end__multiple_dataloaders", "method_params": "self,outputs", "method_startline": "41", "method_endline": "75", "method_complexity": {"method_NLOC": "20", "method_CCN": "5", "method_NToken": "106", "method_nesting_level": "1"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\base\\model_utilities.py", "file_new_name": "tests\\base\\model_utilities.py", "file_complexity": {"file_NLOC": "20", "file_CCN": "4", "file_NToken": "134"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "9,10", "deleted_lines": "9,10", "method_info": {"method_name": "dataloader", "method_params": "self,bool,int", "method_startline": "9", "method_endline": "18", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "62", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "9,10", "deleted_lines": "9,10", "method_info": {"method_name": "dataloader", "method_params": "self,train", "method_startline": "9", "method_endline": "18", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "50", "method_nesting_level": "1"}}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\base\\model_valid_dataloaders.py", "file_new_name": "tests\\base\\model_valid_dataloaders.py", "file_complexity": {"file_NLOC": "19", "file_CCN": "7", "file_NToken": "155"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "10", "deleted_lines": "10", "method_info": {"method_name": "dataloader", "method_params": "self,args,kwargs", "method_startline": "10", "method_endline": "11", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "16,17,18,19", "deleted_lines": null, "method_info": {"method_name": "val_dataloader__multiple_mixed_length", "method_params": "self", "method_startline": "16", "method_endline": "19", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "34", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "10", "deleted_lines": "10", "method_info": {"method_name": "dataloader", "method_params": "self,bool", "method_startline": "10", "method_endline": "11", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "1"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\base\\model_valid_epoch_ends.py", "file_new_name": "tests\\base\\model_valid_epoch_ends.py", "file_complexity": {"file_NLOC": "32", "file_CCN": "13", "file_NToken": "247"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "31", "deleted_lines": "31", "method_info": {"method_name": "validation_epoch_end_multiple_dataloaders", "method_params": "self,outputs", "method_startline": "31", "method_endline": "59", "method_complexity": {"method_NLOC": "17", "method_CCN": "7", "method_NToken": "116", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "31", "deleted_lines": "31", "method_info": {"method_name": "validation_epoch_end__multiple_dataloaders", "method_params": "self,outputs", "method_startline": "31", "method_endline": "59", "method_complexity": {"method_NLOC": "17", "method_CCN": "7", "method_NToken": "116", "method_nesting_level": "1"}}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_deprecated.py", "file_new_name": "tests\\test_deprecated.py", "file_complexity": {"file_NLOC": "112", "file_CCN": "16", "file_NToken": "925"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "143,156", "deleted_lines": "143,156", "method_info": {"method_name": "test_tbd_remove_in_v1_0_0_model_hooks", "method_params": "", "method_startline": "130", "method_endline": "157", "method_complexity": {"method_NLOC": "20", "method_CCN": "1", "method_NToken": "211", "method_nesting_level": "0"}}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tests\\trainer\\test_dataloaders.py", "file_new_name": "tests\\trainer\\test_dataloaders.py", "file_complexity": {"file_NLOC": "457", "file_CCN": "42", "file_NToken": "3289"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "92", "deleted_lines": "92", "method_info": {"method_name": "test_multiple_val_dataloader", "method_params": "tmpdir", "method_startline": "86", "method_endline": "112", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "98", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293", "deleted_lines": null, "method_info": {"method_name": "test_dataloaders_with_limit_percent_batches", "method_params": "tmpdir,limit_train_batches,limit_val_batches,limit_test_batches", "method_startline": "263", "method_endline": "293", "method_complexity": {"method_NLOC": "27", "method_CCN": "3", "method_NToken": "167", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326", "deleted_lines": null, "method_info": {"method_name": "test_dataloaders_with_limit_num_batches", "method_params": "tmpdir,limit_train_batches,limit_val_batches,limit_test_batches", "method_startline": "304", "method_endline": "326", "method_complexity": {"method_NLOC": "20", "method_CCN": "1", "method_NToken": "134", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "227", "deleted_lines": "227", "method_info": {"method_name": "test_multiple_dataloaders_passed_to_fit", "method_params": "tmpdir,ckpt_path", "method_startline": "222", "method_endline": "251", "method_complexity": {"method_NLOC": "25", "method_CCN": "2", "method_NToken": "179", "method_nesting_level": "0"}}}}}}}}