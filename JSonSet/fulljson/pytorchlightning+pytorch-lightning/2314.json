{"BR": {"BR_id": "2314", "BR_author": "digitalillusions", "BRopenT": "2020-06-22T12:59:13Z", "BRcloseT": "2020-06-24T03:41:03Z", "BR_text": {"BRsummary": "Breaking compatibility with custom datatypes implementing `.to`", "BRdescription": "\n <denchmark-h:h2>\ud83d\ude80 Feature</denchmark-h>\n \n Bring back compatibility for custom datatypes in collections implementing .to for transferring data.\n <denchmark-h:h3>Motivation</denchmark-h>\n \n I am using Pytorch Lightning together with Pytorch Geometric. Pytorch Geometric implements several custom datatypes and dataloaders which is really useful for geometric deep learning. Everything worked well with pytorch lightning 0.7.6, as the custom datatypes implement a .to method for transferring the data to different devices.\n However, with the recent 0.8.1 update, this is no longer possible and I had to scour the documentation to be able to implement a fix using transfer_batch_to_device(batch, device). This is in my opinion not very pretty, as my batch looks like this\n <denchmark-code>{\"data\": pytorch geometric batch object, \"id\": tensor, ...}\n </denchmark-code>\n \n i.e. it is just a dictionary of types that all implement the .to method.\n <denchmark-h:h3>Pitch</denchmark-h>\n \n \n Make it possible for classes implementing the .to method to be transferred automatically\n If part of the batch could not be transferred automatically output a warning letting the user know, that a custom transfer function for the batch might be required, or to implement the .to method for custom datatypes in the batch\n Add a note to the introduction guide about custom datatypes and handling for custom datatypes\n \n <denchmark-h:h3>Alternatives</denchmark-h>\n \n If this change was intentional and the behavior of trying to call the .to method is not desired, I think there should definitely be some more documentation about this, in a more obvious place.\n <denchmark-h:h3>Additional context</denchmark-h>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "digitalillusions", "commentT": "2020-06-22T12:59:55Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "digitalillusions", "commentT": "2020-06-23T16:14:37Z", "comment_text": "\n \t\tThis should definitely work. It was not my intention to break it and I thought I had even a test for it. I will look into this and also converting the issue to a bug report.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "digitalillusions", "commentT": "2020-06-23T16:55:49Z", "comment_text": "\n \t\tHave identified the problem and fix is in the works... Silly oversight on my part.\n Regarding the warning, not sure. Is it not enough to point out in the docs that anything not a tensor (or .to() movable) will be left untouched unless the hook is implemented?\n Otherwise, such a check would have to be done on every batch, because in theory the batch can (structurally) change every iteration, and that would cause a spam of warning messages.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "digitalillusions", "commentT": "2020-06-23T18:10:40Z", "comment_text": "\n \t\t\n Have identified the problem and fix is in the works... Silly oversight on my part.\n \n Awesome, thank you!\n \n Regarding the warning, not sure. Is it not enough to point out in the docs that anything not a tensor (or .to() movable) will be left untouched unless the hook is implemented?\n Otherwise, such a check would have to be done on every batch, because in theory the batch can (structurally) change every iteration, and that would cause a spam of warning messages.\n \n That's a good point, in that case I think the docs should suffice. Though maybe the compatible data types can be mentioned in the Introduction Guide? Reading through the Introduction Guide I found no mention of this anywhere, and I think it may fit well into the Data Section. Possibly after the Models defined by data section, there could be a section which talks briefly about custom data loaders, custom batches and what kind of custom data lightning can handle automatically. Maybe also just refer to the appropriate place in the documentation.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "digitalillusions", "commentT": "2020-06-23T22:18:23Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/digitalillusions>@digitalillusions</denchmark-link>\n  would you like to review/test the fix? <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/2335>#2335</denchmark-link>\n \n Also, since the docs were your idea, would you like to make a separate PR with your docs suggestion to the intro guide?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "digitalillusions", "commentT": "2020-06-23T22:25:22Z", "comment_text": "\n \t\tSure thing, I think I'll have time to review and to test it tomorrow.\n I can also try my hand at a pull request for the docs, though I'm still fairly new to lightning.\n \t\t"}}}, "commit": {"commit_id": "aab9e77d2d4ac601a08ca6365dd846a88b83517f", "commit_author": "Adrian W\u00e4lchli", "commitT": "2020-06-23 23:41:02-04:00", "commit_complexity": {"commit_NLOC": "0.6666666666666666", "commit_CCN": "0.6666666666666666", "commit_Nprams": "0.8"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "31,32", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\core\\hooks.py", "file_new_name": "pytorch_lightning\\core\\hooks.py", "file_complexity": {"file_NLOC": "162", "file_CCN": "19", "file_NToken": "293"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "207", "deleted_lines": "207", "method_info": {"method_name": "transfer_batch_to_device", "method_params": "self,Any,device", "method_startline": "200", "method_endline": "243", "method_complexity": {"method_NLOC": "44", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "pytorch_lightning\\utilities\\apply_func.py", "file_new_name": "pytorch_lightning\\utilities\\apply_func.py", "file_complexity": {"file_NLOC": "59", "file_CCN": "14", "file_NToken": "281"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57,58", "deleted_lines": "57,58", "method_info": {"method_name": "move_data_to_device.to", "method_params": "tensor", "method_startline": "57", "method_endline": "58", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "87,88", "deleted_lines": null, "method_info": {"method_name": "move_data_to_device.to", "method_params": "data", "method_startline": "87", "method_endline": "88", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "63,64,65,66,67", "deleted_lines": null, "method_info": {"method_name": "__subclasshook__", "method_params": "cls,subclass", "method_startline": "63", "method_endline": "67", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "29", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "72,73,76,77,78,87,88,89", "deleted_lines": null, "method_info": {"method_name": "move_data_to_device", "method_params": "Any,device", "method_startline": "70", "method_endline": "89", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "29", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\models\\test_gpu.py", "file_new_name": "tests\\models\\test_gpu.py", "file_complexity": {"file_NLOC": "226", "file_CCN": "33", "file_NToken": "2322"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "289,290,291,292,293,294,295,296,297,298,299,300", "deleted_lines": null, "method_info": {"method_name": "test_single_gpu_batch_parse", "method_params": "", "method_startline": "245", "method_endline": "300", "method_complexity": {"method_NLOC": "35", "method_CCN": "12", "method_NToken": "572", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "295,296,297", "deleted_lines": null, "method_info": {"method_name": "test_single_gpu_batch_parse.to", "method_params": "self,args,kwargs", "method_startline": "295", "method_endline": "297", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "29", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "292,293", "deleted_lines": null, "method_info": {"method_name": "test_single_gpu_batch_parse.__init__", "method_params": "self", "method_startline": "292", "method_endline": "293", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "2"}}}}}}}}