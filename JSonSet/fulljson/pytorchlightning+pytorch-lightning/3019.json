{"BR": {"BR_id": "3019", "BR_author": "awaelchli", "BRopenT": "2020-08-17T16:53:33Z", "BRcloseT": "2020-08-19T00:27:49Z", "BR_text": {"BRsummary": "Results gathering with varying tensor shapes (e.g. last batch)", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n Results object reduction when batch sizes are different won't work because torch.stack get's different input shapes. This can happen if your dataloader returns a smaller batch for the last iteration, for example.\n def recursive_stack(result: MutableMapping):\n     for k, v in result.items():\n         if isinstance(v, dict):\n             recursive_stack(v)\n         if isinstance(v, list) and len(v) > 0 and isinstance(v[0], torch.Tensor):\n             v = torch.stack(v)\n             result[k] = v\n Context\n From slack discussion by <denchmark-link:https://github.com/artgor>@artgor</denchmark-link>\n \n <denchmark-link:https://pytorch-lightning.slack.com/archives/CRBLFHY79/p1597604494424600>https://pytorch-lightning.slack.com/archives/CRBLFHY79/p1597604494424600</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "awaelchli", "commentT": "2020-08-17T16:53:45Z", "comment_text": "\n \t\twill submit a PR within the next hours\n \t\t"}}}, "commit": {"commit_id": "9031dc3b817d46dc9b36007cce1360cfcf99939f", "commit_author": "Adrian W\u00e4lchli", "commitT": "2020-08-18 20:27:48-04:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "149,150", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\core\\step_result.py", "file_new_name": "pytorch_lightning\\core\\step_result.py", "file_complexity": {"file_NLOC": "484", "file_CCN": "126", "file_NToken": "3232"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "425,426,427,428,429,430,431,432", "deleted_lines": "425,426,427,428,430,431,432", "method_info": {"method_name": "recursive_padded_stack", "method_params": "MutableMapping", "method_startline": "425", "method_endline": "432", "method_complexity": {"method_NLOC": "7", "method_CCN": "6", "method_NToken": "71", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "423,424,425,426,427,428,429,430,431,432,433,434,436", "deleted_lines": "425,426,427,428,430,431,432", "method_info": {"method_name": "collate_tensors", "method_params": "List", "method_startline": "423", "method_endline": "436", "method_complexity": {"method_NLOC": "8", "method_CCN": "10", "method_NToken": "117", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "420", "deleted_lines": "420", "method_info": {"method_name": "recursive_stack", "method_params": "MutableMapping", "method_startline": "415", "method_endline": "420", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "39", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tests\\core\\test_results.py", "file_new_name": "tests\\core\\test_results.py", "file_complexity": {"file_NLOC": "181", "file_CCN": "16", "file_NToken": "1341"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "179,180,181,182,183,184,185,186,187,188", "deleted_lines": null, "method_info": {"method_name": "test_result_gather_stack", "method_params": "", "method_startline": "179", "method_endline": "188", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "84", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "191,192,193,194,195,196,197,198,199,200", "deleted_lines": null, "method_info": {"method_name": "test_result_gather_concatenate", "method_params": "", "method_startline": "191", "method_endline": "200", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "84", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "228,229,230,231,232,233,234,235,236,237,238", "deleted_lines": null, "method_info": {"method_name": "test_result_gather_mixed_types", "method_params": "", "method_startline": "228", "method_endline": "238", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "83", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "203,204,205,206,207,208,209,210,211,212", "deleted_lines": null, "method_info": {"method_name": "test_result_gather_scalar", "method_params": "", "method_startline": "203", "method_endline": "212", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "76", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "215,216,217,218,219,220,221,222,223,224,225", "deleted_lines": null, "method_info": {"method_name": "test_result_gather_different_shapes", "method_params": "", "method_startline": "215", "method_endline": "225", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "126", "method_nesting_level": "0"}}}}}}}}