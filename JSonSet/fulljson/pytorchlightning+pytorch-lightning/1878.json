{"BR": {"BR_id": "1878", "BR_author": "tullie", "BRopenT": "2020-05-18T23:00:34Z", "BRcloseT": "2020-06-13T16:00:15Z", "BR_text": {"BRsummary": "prepare_data called multiple times per node for slurm and elastic training", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n Slurm and elastic training create the training processes per node outside of the lightning context. This means that when the fit function calls prepare_data, the assumption that it's only being called on proc 0 is broken and it gets called for each process.\n This is an issue computational reasons (e.g. downloading a whole dataset) and for training stability if the data preparation process isn't deterministic.\n See calling code here:\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/trainer.py\n \n \n          Line 825\n       in\n       7c7e50c\n \n \n \n \n \n \n  model.prepare_data() \n \n \n \n \n \n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior:\n \n Add print statements to prepare_data\n Train a lightning model with either slurm or elastic training\n See that it's being called multiple times.\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n Expected prepare_data to only be called once per node.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "tullie", "commentT": "2020-06-08T11:01:00Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n  any idea how to fix?\n \t\t"}}}, "commit": {"commit_id": "5fd01b0e68a6087908ac0bcefd4edaeddfb0e248", "commit_author": "William Falcon", "commitT": "2020-06-13 12:00:14-04:00", "commit_complexity": {"commit_NLOC": "0.6363636363636364", "commit_CCN": "0.7272727272727273", "commit_Nprams": "0.6818181818181818"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "file_new_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "file_complexity": {"file_NLOC": "245", "file_CCN": "37", "file_NToken": "1162"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "232", "deleted_lines": "232", "method_info": {"method_name": "on_validation_end", "method_params": "self,trainer,pl_module", "method_startline": "230", "method_endline": "278", "method_complexity": {"method_NLOC": "37", "method_CCN": "13", "method_NToken": "234", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\core\\lightning.py", "file_new_name": "pytorch_lightning\\core\\lightning.py", "file_complexity": {"file_NLOC": "1547", "file_CCN": "79", "file_NToken": "2195"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "102", "deleted_lines": "102", "method_info": {"method_name": "print", "method_params": "self,args,kwargs", "method_startline": "86", "method_endline": "103", "method_complexity": {"method_NLOC": "18", "method_CCN": "2", "method_NToken": "30", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "925", "deleted_lines": "925", "method_info": {"method_name": "init_ddp_connection", "method_params": "self,int,int,bool", "method_startline": "923", "method_endline": "927", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "925", "deleted_lines": "925", "method_info": {"method_name": "init_ddp_connection", "method_params": "self,int,int,bool", "method_startline": "923", "method_endline": "927", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\__init__.py", "file_new_name": "pytorch_lightning\\trainer\\__init__.py", "file_complexity": {"file_NLOC": "1012", "file_CCN": "0", "file_NToken": "24"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "588,589,590,591,592,593,594,595,596,597,598,599,600", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\data_loading.py", "file_new_name": "pytorch_lightning\\trainer\\data_loading.py", "file_complexity": {"file_NLOC": "255", "file_CCN": "70", "file_NToken": "1419"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "163", "deleted_lines": "163", "method_info": {"method_name": "_get_distributed_sampler", "method_params": "self,dataloader", "method_startline": "150", "method_endline": "165", "method_complexity": {"method_NLOC": "16", "method_CCN": "3", "method_NToken": "137", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "pytorch_lightning\\trainer\\distrib_data_parallel.py", "file_new_name": "pytorch_lightning\\trainer\\distrib_data_parallel.py", "file_complexity": {"file_NLOC": "414", "file_CCN": "95", "file_NToken": "1950"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "169,170", "deleted_lines": null, "method_info": {"method_name": "is_global_zero", "method_params": "self", "method_startline": "169", "method_endline": "170", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "510", "deleted_lines": "505", "method_info": {"method_name": "save_spawn_weights", "method_params": "self,model", "method_startline": "504", "method_endline": "512", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "33", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "524", "deleted_lines": null, "method_info": {"method_name": "load_spawn_weights", "method_params": "self,original_model", "method_startline": "514", "method_endline": "535", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "58", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "307,308,309,310,311,312", "deleted_lines": null, "method_info": {"method_name": "determine_local_rank", "method_params": "self", "method_startline": "307", "method_endline": "312", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "36", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "437,438,442,443,447,453,454,455,456,457,458,459,460,473", "deleted_lines": "426,430,434,440,453,454,491", "method_info": {"method_name": "ddp_train", "method_params": "self,process_idx,model,is_master,proc_offset", "method_startline": "420", "method_endline": "502", "method_complexity": {"method_NLOC": "42", "method_CCN": "14", "method_NToken": "353", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\trainer\\distrib_parts.py", "file_new_name": "pytorch_lightning\\trainer\\distrib_parts.py", "file_complexity": {"file_NLOC": "315", "file_CCN": "84", "file_NToken": "1865"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "186,187", "deleted_lines": "186,187", "method_info": {"method_name": "tpu_train", "method_params": "self,tpu_core_idx,model", "method_startline": "173", "method_endline": "205", "method_complexity": {"method_NLOC": "17", "method_CCN": "6", "method_NToken": "157", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "292,293", "deleted_lines": "292,293", "method_info": {"method_name": "horovod_train", "method_params": "self,model", "method_startline": "248", "method_endline": "303", "method_complexity": {"method_NLOC": "30", "method_CCN": "11", "method_NToken": "267", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_new_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_complexity": {"file_NLOC": "322", "file_CCN": "54", "file_NToken": "1165"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "378", "deleted_lines": "382", "method_info": {"method_name": "run_evaluation", "method_params": "self,bool", "method_startline": "337", "method_endline": "406", "method_complexity": {"method_NLOC": "41", "method_CCN": "12", "method_NToken": "225", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\logging.py", "file_new_name": "pytorch_lightning\\trainer\\logging.py", "file_complexity": {"file_NLOC": "116", "file_CCN": "46", "file_NToken": "770"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "72", "deleted_lines": "72", "method_info": {"method_name": "log_metrics", "method_params": "self,metrics,grad_norm_dic,step", "method_startline": "44", "method_endline": "74", "method_complexity": {"method_NLOC": "14", "method_CCN": "8", "method_NToken": "123", "method_nesting_level": "1"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "pytorch_lightning\\trainer\\trainer.py", "file_new_name": "pytorch_lightning\\trainer\\trainer.py", "file_complexity": {"file_NLOC": "888", "file_CCN": "94", "file_NToken": "3782"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "491,492", "deleted_lines": null, "method_info": {"method_name": "is_global_zero", "method_params": "self", "method_startline": "491", "method_endline": "492", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "949", "deleted_lines": "931", "method_info": {"method_name": "run_pretrain_routine", "method_params": "self,LightningModule", "method_startline": "905", "method_endline": "1005", "method_complexity": {"method_NLOC": "47", "method_CCN": "22", "method_NToken": "344", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "545", "deleted_lines": null, "method_info": {"method_name": "get_init_arguments_and_types", "method_params": "cls", "method_startline": "521", "method_endline": "567", "method_complexity": {"method_NLOC": "45", "method_CCN": "3", "method_NToken": "87", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "886,887,888,889,890,891", "deleted_lines": null, "method_info": {"method_name": "can_prepare_data", "method_params": "self", "method_startline": "886", "method_endline": "891", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "30", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "126", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,LightningLoggerBase,True,ModelCheckpoint,True,EarlyStopping,False,None,None,float,int,int,int,str,None,bool,None,None,int,float,int,float,1,int,bool,int,int,1,int,int,None,None,float,float,float,float,int,int,None,int,bool,None,int,None,None,BaseProfiler,None,bool,bool,bool,bool,False,bool,bool,str,False,bool,str,None,use_amp,show_progress_bar", "method_startline": "79", "method_endline": "130", "method_complexity": {"method_NLOC": "52", "method_CCN": "1", "method_NToken": "434", "method_nesting_level": "1"}}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\trainer\\training_io.py", "file_new_name": "pytorch_lightning\\trainer\\training_io.py", "file_complexity": {"file_NLOC": "340", "file_CCN": "75", "file_NToken": "1636"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "265", "deleted_lines": "265", "method_info": {"method_name": "save_checkpoint", "method_params": "self,filepath,bool", "method_startline": "262", "method_endline": "274", "method_complexity": {"method_NLOC": "11", "method_CCN": "4", "method_NToken": "69", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "216", "deleted_lines": "216", "method_info": {"method_name": "sig_handler", "method_params": "self,signum,frame", "method_startline": "215", "method_endline": "236", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "92", "method_nesting_level": "1"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\training_loop.py", "file_new_name": "pytorch_lightning\\trainer\\training_loop.py", "file_complexity": {"file_NLOC": "546", "file_CCN": "129", "file_NToken": "2685"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "483", "deleted_lines": "484", "method_info": {"method_name": "run_training_epoch", "method_params": "self", "method_startline": "404", "method_endline": "531", "method_complexity": {"method_NLOC": "66", "method_CCN": "34", "method_NToken": "547", "method_nesting_level": "1"}}}}}}}}