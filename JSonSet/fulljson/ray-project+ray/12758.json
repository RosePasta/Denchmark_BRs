{"BR": {"BR_id": "12758", "BR_author": "edoakes", "BRopenT": "2020-12-10T18:49:20Z", "BRcloseT": "2020-12-11T00:24:56Z", "BR_text": {"BRsummary": "max_task_retries not working for named actors", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n When setting max_restarts=-1 and max_task_retries=-1 for a named actor and killing it, the actor is successfully restarted but pending actor tasks are failed.\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Unnamed actor, working:\n import time\n \n import ray\n ray.init()\n \n @ray.remote\n class ActorToKill:\n     def __init__(self):\n         print(\"ActorToKill initialized\")\n \n     def run_forever(self):\n         print(\"run_forever called\")\n         import time;time.sleep(100000)\n \n @ray.remote\n class CallingActor:\n     def __init__(self, a):\n         self.actor = a\n \n     def call_other(self):\n         return ray.get(self.actor.run_forever.remote())\n \n a = ActorToKill.options(max_restarts=-1, max_task_retries=-1).remote()\n c = CallingActor.remote(a)\n oid = c.call_other.remote()\n time.sleep(5)\n ray.kill(a, no_restart=False)\n ray.get(oid)\n Output:\n <denchmark-code>(base) ray/serve % python normal.py \n File descriptor limit 256 is too low for production servers and may result in connection errors. At least 8192 is recommended. --- Fix with 'ulimit -n 8192'\n 2020-12-10 12:48:56,375 INFO services.py:1171 -- View the Ray dashboard at http://127.0.0.1:8265\n (pid=82516) ActorToKill initialized\n (pid=82516) run_forever called\n 2020-12-10 12:49:03,163 WARNING worker.py:1032 -- A worker died or was killed while executing task ffffffffffffffffdf5a1a8201000000.\n (pid=82511) ActorToKill initialized\n ... runs forever ...\n </denchmark-code>\n \n Named actor, not working:\n import time\n \n import ray\n ray.init()\n \n @ray.remote\n class ActorToKill:\n     def __init__(self):\n         print(\"ActorToKill initialized\")\n \n     def run_forever(self):\n         print(\"run_forever called\")\n         import time;time.sleep(100000)\n \n @ray.remote\n class CallingActor:\n     def __init__(self):\n         self.actor = ray.get_actor(\"a\")\n \n     def call_other(self):\n         return ray.get(self.actor.run_forever.remote())\n \n a = ActorToKill.options(name=\"a\", max_restarts=-1, max_task_retries=-1).remote()\n c = CallingActor.remote()\n oid = c.call_other.remote()\n time.sleep(5)\n ray.kill(a, no_restart=False)\n ray.get(oid)\n Output:\n <denchmark-code>(base) ray/serve % python named.py\n File descriptor limit 256 is too low for production servers and may result in connection errors. At least 8192 is recommended. --- Fix with 'ulimit -n 8192'\n 2020-12-10 12:48:09,156 INFO services.py:1171 -- View the Ray dashboard at http://127.0.0.1:8265\n (pid=82465) ActorToKill initialized\n (pid=82465) run_forever called\n 2020-12-10 12:48:15,850 WARNING worker.py:1032 -- A worker died or was killed while executing task ffffffffffffffffdf5a1a8201000000.\n Traceback (most recent call last):\n   File \"named.py\", line 28, in <module>\n     ray.get(oid)\n   File \"/Users/eoakes/code/ray/python/ray/worker.py\", line 1377, in get\n     raise value.as_instanceof_cause()\n ray.exceptions.RayTaskError: ray::CallingActor.call_other() (pid=82466, ip=192.168.0.124)\n   File \"python/ray/_raylet.pyx\", line 463, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 415, in ray._raylet.execute_task.function_executor\n   File \"named.py\", line 21, in call_other\n     return ray.get(self.actor.run_forever.remote())\n ray.exceptions.RayActorError: The actor died unexpectedly before finishing this task.\n (pid=82464) ActorToKill initialized\n </denchmark-code>\n \n If the code snippet cannot be run by itself, the issue will be closed with \"needs-repro-script\".\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "edoakes", "commentT": "2020-12-10T18:50:22Z", "comment_text": "\n \t\tcc <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  looks like another problem with the existing retries logic D: I think we should seriously consider moving to using failure callbacks instead (though it wouldn't directly address this problem -- this is probably something with how  constructs the actor handle).\n \t\t"}}}, "commit": {"commit_id": "62d6b0a5580b9cab8ded3e8600f8aefeacf65ff1", "commit_author": "Edward Oakes", "commitT": "2020-12-10 18:24:55-06:00", "commit_complexity": {"commit_NLOC": "0.3888888888888889", "commit_CCN": "0.9814814814814815", "commit_Nprams": "0.8518518518518519"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "python\\ray\\tests\\test_actor_failures.py", "file_new_name": "python\\ray\\tests\\test_actor_failures.py", "file_complexity": {"file_NLOC": "493", "file_CCN": "117", "file_NToken": "3464"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "222,223,224", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.increment", "method_params": "self", "method_startline": "222", "method_endline": "224", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "226,227,228,229,230,231", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.wait_for_count", "method_params": "self,count", "method_startline": "226", "method_endline": "231", "method_complexity": {"method_NLOC": "6", "method_CCN": "3", "method_NToken": "33", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "235,236", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.__init__", "method_params": "self,counter", "method_startline": "235", "method_endline": "236", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "238,239,240", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.run", "method_params": "self,counter,signal", "method_startline": "238", "method_endline": "240", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "28", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries", "method_params": "ray_init_with_task_retry_delay", "method_startline": "215", "method_endline": "272", "method_complexity": {"method_NLOC": "28", "method_CCN": "1", "method_NToken": "206", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "247,248", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.call_other", "method_params": "self,counter,signal", "method_startline": "247", "method_endline": "248", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "218,219,220", "deleted_lines": null, "method_info": {"method_name": "test_named_actor_max_task_retries.__init__", "method_params": "self", "method_startline": "218", "method_endline": "220", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\common\\task\\task_util.h", "file_new_name": "src\\ray\\common\\task\\task_util.h", "file_complexity": {"file_NLOC": "143", "file_CCN": "18", "file_NToken": "1105"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "151,159", "deleted_lines": "151", "method_info": {"method_name": "ray::TaskSpecBuilder::SetActorCreationTaskSpec", "method_params": "actor_id,max_restarts,dynamic_worker_options,max_concurrency,is_detached,name,is_asyncio,extension_data", "method_startline": "150", "method_endline": "168", "method_complexity": {"method_NLOC": "19", "method_CCN": "2", "method_NToken": "153", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "151,159", "deleted_lines": "151", "method_info": {"method_name": "ray::TaskSpecBuilder::SetActorCreationTaskSpec", "method_params": "actor_id,max_restarts,max_task_retries,dynamic_worker_options,max_concurrency,is_detached,name,is_asyncio,extension_data", "method_startline": "150", "method_endline": "169", "method_complexity": {"method_NLOC": "20", "method_CCN": "2", "method_NToken": "165", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\core_worker\\actor_handle.cc", "file_new_name": "src\\ray\\core_worker\\actor_handle.cc", "file_complexity": {"file_NLOC": "80", "file_CCN": "9", "file_NToken": "664"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "61,62", "deleted_lines": null, "method_info": {"method_name": "CreateInnerActorHandleFromActorTableData", "method_params": "actor_table_data", "method_startline": "47", "method_endline": "64", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "171", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\core_worker\\core_worker.cc", "file_new_name": "src\\ray\\core_worker\\core_worker.cc", "file_complexity": {"file_NLOC": "1986", "file_CCN": "338", "file_NToken": "15473"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1380", "deleted_lines": null, "method_info": {"method_name": "ray::CoreWorker::CreateActor", "method_params": "function,args,actor_creation_options,extension_data,return_actor_id", "method_startline": "1334", "method_endline": "1421", "method_complexity": {"method_NLOC": "79", "method_CCN": "7", "method_NToken": "562", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\test\\gcs_test_util.h", "file_new_name": "src\\ray\\gcs\\test\\gcs_test_util.h", "file_complexity": {"file_NLOC": "151", "file_CCN": "14", "file_NToken": "1238"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "45,46", "deleted_lines": "45", "method_info": {"method_name": "ray::Mocker::GenActorCreationTask", "method_params": "job_id,max_restarts,detached,name,owner_address", "method_startline": "31", "method_endline": "48", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "191", "method_nesting_level": "2"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\protobuf\\common.proto", "file_new_name": "src\\ray\\protobuf\\common.proto", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "261,265,266,267,268,269,273,275,277,279,281,283", "deleted_lines": "261,268,270,272,274,276,278"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\task_dependency_manager_test.cc", "file_new_name": "src\\ray\\raylet\\task_dependency_manager_test.cc", "file_complexity": {"file_NLOC": "384", "file_CCN": "53", "file_NToken": "3156"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "73", "deleted_lines": "73", "method_info": {"method_name": "ray::raylet::ExampleTask", "method_params": "arguments,num_returns", "method_startline": "64", "method_endline": "80", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "177", "method_nesting_level": "2"}}}}}}}}