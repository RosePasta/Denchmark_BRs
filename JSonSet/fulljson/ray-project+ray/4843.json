{"BR": {"BR_id": "4843", "BR_author": "robertnishihara", "BRopenT": "2019-05-23T17:43:54Z", "BRcloseT": "2019-05-24T20:44:40Z", "BR_text": {"BRsummary": "Actor class that is exported from driver will not be exported from workers in next Ray session.", "BRdescription": "\n The following script will hang.\n import ray\n \n @ray.remote\n class Actor(object):\n     def method(self):\n         pass\n \n @ray.remote\n def f(actor_class):\n     handle = actor_class.remote()\n     ray.get(handle.method.remote())\n \n ray.init(num_cpus=2)\n \n a = Actor.remote()\n ray.get(a.method.remote())\n \n ray.shutdown()\n \n ray.init(num_cpus=2)\n \n ray.get(f.remote(Actor))  # This line hangs.\n \n ray.shutdown()\n Right now, the Actor actor class has a field _last_export_session (which is a counter), which keeps track of when the actor class definition was last exported (to workers through the GCS). If it was exported in a given Ray session (that is, the span between a call to ray.init and ray.shutdown), then in a subsequent Ray session, the definition will still be exported again from the driver, but not from workers, so in situations where only the workers are in a position to export the definition (as in the example above), it won't get exported.\n The trouble with the counter is that the counter on the workers is not set correctly. This can be fixed by using a driver ID instead of a counter.\n \t"}, "comments": {}}, "commit": {"commit_id": "49fe894e2219e99dc836176dfe447afa7a0ab331", "commit_author": "Robert Nishihara", "commitT": "2019-05-24 13:44:39-07:00", "commit_complexity": {"commit_NLOC": "0.35", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "doc\\source\\internals-overview.rst", "file_new_name": "doc\\source\\internals-overview.rst", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\actor.py", "file_new_name": "python\\ray\\actor.py", "file_complexity": {"file_NLOC": "546", "file_CCN": "60", "file_NToken": "2527"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "189,190,191,192,193,194,215,348,349,350,354", "deleted_lines": "189,190,191,212,345,346,350"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\function_manager.py", "file_new_name": "python\\ray\\function_manager.py", "file_complexity": {"file_NLOC": "541", "file_CCN": "96", "file_NToken": "3064"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "345", "deleted_lines": "345", "method_info": {"method_name": "export", "method_params": "self,remote_function", "method_startline": "334", "method_endline": "348", "method_complexity": {"method_NLOC": "7", "method_CCN": "3", "method_NToken": "46", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\remote_function.py", "file_new_name": "python\\ray\\remote_function.py", "file_complexity": {"file_NLOC": "125", "file_CCN": "9", "file_NToken": "562"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "46,47,48,49,50,51,75,114,115,118", "deleted_lines": "46,47,48,72,73,74,75,114,117"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "python\\ray\\tests\\test_basic.py", "file_new_name": "python\\ray\\tests\\test_basic.py", "file_complexity": {"file_NLOC": "2139", "file_CCN": "499", "file_NToken": "17269"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "313,314", "deleted_lines": null, "method_info": {"method_name": "test_nested_functions.g", "method_params": "", "method_startline": "313", "method_endline": "314", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "6", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "310,311", "deleted_lines": null, "method_info": {"method_name": "test_nested_functions.f", "method_params": "", "method_startline": "310", "method_endline": "311", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "2988,2989,2990,2991,2992,2993,2994,2995,2996,2997,2998,2999,3000,3001", "deleted_lines": null, "method_info": {"method_name": "test_export_after_shutdown", "method_params": "ray_start_regular", "method_startline": "2964", "method_endline": "3001", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "126", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "306,307,308,309,310,311,312,313,314,315,316,317,318,319,320", "deleted_lines": null, "method_info": {"method_name": "test_nested_functions", "method_params": "ray_start_regular", "method_startline": "306", "method_endline": "320", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "36", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "317,318", "deleted_lines": null, "method_info": {"method_name": "test_nested_functions.h", "method_params": "", "method_startline": "317", "method_endline": "318", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "6", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "2996,2997,2998,2999", "deleted_lines": null, "method_info": {"method_name": "test_export_after_shutdown.export_definitions_from_worker", "method_params": "remote_function,actor_class", "method_startline": "2996", "method_endline": "2999", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "36", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "python\\ray\\tests\\test_failure.py", "file_new_name": "python\\ray\\tests\\test_failure.py", "file_complexity": {"file_NLOC": "460", "file_CCN": "78", "file_NToken": "3200"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "98,99,100,101,102,103,104,105,106", "deleted_lines": "98", "method_info": {"method_name": "test_fail_importing_remote_function", "method_params": "ray_start_2_cpus", "method_startline": "78", "method_endline": "123", "method_complexity": {"method_NLOC": "25", "method_CCN": "2", "method_NToken": "171", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "510,511,512", "deleted_lines": null, "method_info": {"method_name": "test_export_large_objects", "method_params": "ray_start_regular", "method_startline": "501", "method_endline": "524", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "67", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "98,99,100,101,102,103", "deleted_lines": "98", "method_info": {"method_name": "test_fail_importing_remote_function.g", "method_params": "", "method_startline": "97", "method_endline": "103", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "15", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "python\\ray\\tests\\test_monitors.py", "file_new_name": "python\\ray\\tests\\test_monitors.py", "file_complexity": {"file_NLOC": "83", "file_CCN": "16", "file_NToken": "544"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57", "deleted_lines": "49,50,51,52,53,54,55,64", "method_info": {"method_name": "_test_cleanup_on_driver_exit", "method_params": "num_redis_shards", "method_startline": "16", "method_endline": "94", "method_complexity": {"method_NLOC": "31", "method_CCN": "6", "method_NToken": "216", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "57", "deleted_lines": "49,50,51,52,53,54,55,64", "method_info": {"method_name": "_test_cleanup_on_driver_exit.Driver", "method_params": "success", "method_startline": "38", "method_endline": "73", "method_complexity": {"method_NLOC": "26", "method_CCN": "6", "method_NToken": "168", "method_nesting_level": "1"}}}}}}}}