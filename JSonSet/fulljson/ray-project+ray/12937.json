{"BR": {"BR_id": "12937", "BR_author": "rkooo567", "BRopenT": "2020-12-17T08:11:10Z", "BRcloseT": "2020-12-19T00:00:55Z", "BR_text": {"BRsummary": "[Core][New Scheduler] Actors borrowing CPUs infinitely.", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n     ray.init(\n         num_cpus=1,\n         _system_config={\n             \"debug_dump_period_milliseconds\": 500\n         })\n     @ray.remote(num_cpus=1)\n     class Foo:\n         def f(self):\n             return 0\n     @ray.remote\n     def f():\n         # Creating both actors is not possible.\n         actors = [Foo.remote() for _ in range(3)]\n         for a in actors:\n             ray.get(a.f.remote())\n     # Run in a task to check we handle the blocked task case correctly\n     f.remote()\n This job is supposed to be hanging because worker can borrow cpu to an actor once (and the subsequent actor creation cannot borrow a cpu anymore), but it seems like it succeeds when I ran this script.\n It fails (which is the expected behavior) when I run it with the old scheduler.\n But when we run it with only tasks, it works for both cases (which is the expected behavior)\n     ray.init(\n         num_cpus=1,\n         _system_config={\n             \"debug_dump_period_milliseconds\": 100000\n         })\n \n     @ray.remote(num_cpus=1)\n     def g():\n         time.sleep(2)\n         return 0\n \n     @ray.remote\n     def f():\n         for _ in range(2):\n             ray.get(g.remote())\n \n     ray.get(f.remote(), timeout=5)\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a short code snippet (less than 50 lines if possible) that can be copy-pasted to reproduce the issue. The snippet should have no external library dependencies (i.e., use fake or mock data / environments):\n If the code snippet cannot be run by itself, the issue will be closed with \"needs-repro-script\".\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {}}, "commit": {"commit_id": "6ece291f352e1531f29fa8573e21aa47f290b485", "commit_author": "Eric Liang", "commitT": "2020-12-18 16:00:54-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\tests\\test_failure.py", "file_new_name": "python\\ray\\tests\\test_failure.py", "file_complexity": {"file_NLOC": "952", "file_CCN": "163", "file_NToken": "6711"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "20", "deleted_lines": "20,21,636,637"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\tests\\test_gcs_fault_tolerance.py", "file_new_name": "python\\ray\\tests\\test_gcs_fault_tolerance.py", "file_complexity": {"file_NLOC": "115", "file_CCN": "15", "file_NToken": "730"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "9,24"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\tests\\test_global_state.py", "file_new_name": "python\\ray\\tests\\test_global_state.py", "file_complexity": {"file_NLOC": "249", "file_CCN": "48", "file_NToken": "1618"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "11,220,221"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\tests\\test_reference_counting.py", "file_new_name": "python\\ray\\tests\\test_reference_counting.py", "file_complexity": {"file_NLOC": "376", "file_CCN": "60", "file_NToken": "3069"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "170", "deleted_lines": "170"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "file_complexity": {"file_NLOC": "2418", "file_CCN": "432", "file_NToken": "18551"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2161,2163,2164,2165", "deleted_lines": "2161,2163", "method_info": {"method_name": "ray::raylet::NodeManager::HandleDirectCallTaskBlocked", "method_params": "worker", "method_startline": "2150", "method_endline": "2181", "method_complexity": {"method_NLOC": "30", "method_CCN": "10", "method_NToken": "213", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "2204,2205,2206,2207,2208", "deleted_lines": "2202,2203,2204", "method_info": {"method_name": "ray::raylet::NodeManager::HandleDirectCallTaskUnblocked", "method_params": "worker", "method_startline": "2183", "method_endline": "2239", "method_complexity": {"method_NLOC": "41", "method_CCN": "10", "method_NToken": "266", "method_nesting_level": "2"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.cc", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.cc", "file_complexity": {"file_NLOC": "794", "file_CCN": "190", "file_NToken": "5767"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "568,569,575,576,577,578,579,580,581,582,583,584,585,586", "deleted_lines": "568,573,575,576", "method_info": {"method_name": "ray::ClusterResourceScheduler::SubtractAvailableResourceInstances", "method_params": "available,resource_instances,allow_going_negative", "method_startline": "567", "method_endline": "590", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "190", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "790,800,801", "deleted_lines": "790", "method_info": {"method_name": "ray::ClusterResourceScheduler::SubtractCPUResourceInstances", "method_params": "cpu_instances,allow_going_negative", "method_startline": "789", "method_endline": "805", "method_complexity": {"method_NLOC": "14", "method_CCN": "2", "method_NToken": "90", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "790", "deleted_lines": "780,790", "method_info": {"method_name": "ray::ClusterResourceScheduler::SubtractCPUResourceInstances", "method_params": "cpu_instances", "method_startline": "779", "method_endline": "794", "method_complexity": {"method_NLOC": "13", "method_CCN": "2", "method_NToken": "85", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "568,569,575,576,577,578,579,580", "deleted_lines": "568,573,575,576", "method_info": {"method_name": "ray::ClusterResourceScheduler::SubtractAvailableResourceInstances", "method_params": "available,resource_instances", "method_startline": "567", "method_endline": "580", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "130", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "930,931,946,947,963,964,977,978", "deleted_lines": "919,934,950,963", "method_info": {"method_name": "ray::ClusterResourceScheduler::FillResourceUsage", "method_params": "light_report_resource_usage_enabled,resources_data", "method_startline": "899", "method_endline": "987", "method_complexity": {"method_NLOC": "76", "method_CCN": "20", "method_NToken": "626", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.h", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.h", "file_complexity": {"file_NLOC": "104", "file_CCN": "6", "file_NToken": "817"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "282,287,288,301,305,306", "deleted_lines": "286,302"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_task_manager.cc", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_task_manager.cc", "file_complexity": {"file_NLOC": "562", "file_CCN": "98", "file_NToken": "4263"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "246", "deleted_lines": "245,246,247,248", "method_info": {"method_name": "ray::raylet::ClusterTaskManager::TasksUnblocked", "method_params": "ready_ids", "method_startline": "237", "method_endline": "250", "method_complexity": {"method_NLOC": "14", "method_CCN": "3", "method_NToken": "121", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "508,509,510", "deleted_lines": "510,511,512", "method_info": {"method_name": "ray::raylet::ClusterTaskManager::AnyPendingTasks", "method_params": "exemplar,any_pending,num_pending_actor_creation,num_pending_tasks", "method_startline": "504", "method_endline": "528", "method_complexity": {"method_NLOC": "20", "method_CCN": "5", "method_NToken": "124", "method_nesting_level": "2"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_task_manager.h", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_task_manager.h", "file_complexity": {"file_NLOC": "66", "file_CCN": "0", "file_NToken": "528"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "160,164", "deleted_lines": "160,164"}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\test\\util.h", "file_new_name": "src\\ray\\raylet\\test\\util.h", "file_complexity": {"file_NLOC": "156", "file_CCN": "51", "file_NToken": "997"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "175", "method_info": {"method_name": "ray::raylet::MockWorker::GetBorrowedCPUInstances", "method_params": "", "method_startline": "175", "method_endline": "175", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "177", "method_info": {"method_name": "ray::raylet::MockWorker::ClearBorrowedCPUInstances", "method_params": "", "method_startline": "177", "method_endline": "177", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": null, "deleted_lines": "164,165,166", "method_info": {"method_name": "ray::raylet::MockWorker::SetBorrowedCPUInstances", "method_params": "cpu_instances", "method_startline": "164", "method_endline": "166", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "3"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\worker.h", "file_new_name": "src\\ray\\raylet\\worker.h", "file_complexity": {"file_NLOC": "164", "file_CCN": "12", "file_NToken": "1175"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "205", "method_info": {"method_name": "ray::raylet::Worker::ClearBorrowedCPUInstances", "method_params": "", "method_startline": "205", "method_endline": "205", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "203", "method_info": {"method_name": "ray::raylet::Worker::GetBorrowedCPUInstances", "method_params": "", "method_startline": "203", "method_endline": "203", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": null, "deleted_lines": "199,200,201", "method_info": {"method_name": "ray::raylet::Worker::SetBorrowedCPUInstances", "method_params": "cpu_instances", "method_startline": "199", "method_endline": "201", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "3"}}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\worker_pool.cc", "file_new_name": "src\\ray\\raylet\\worker_pool.cc", "file_complexity": {"file_NLOC": "850", "file_CCN": "194", "file_NToken": "6152"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "959,960", "deleted_lines": "959,960", "method_info": {"method_name": "ray::raylet::WorkerPool::WarnAboutSize", "method_params": "", "method_startline": "958", "method_endline": "985", "method_complexity": {"method_NLOC": "26", "method_CCN": "5", "method_NToken": "169", "method_nesting_level": "2"}}}}}}}}