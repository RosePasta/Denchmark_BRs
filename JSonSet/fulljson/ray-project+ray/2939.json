{"BR": {"BR_id": "2939", "BR_author": "stephanie-wang", "BRopenT": "2018-09-25T03:43:30Z", "BRcloseT": "2018-10-19T04:57:32Z", "BR_text": {"BRsummary": "[xray] All messages on main asio event loop should be written asynchronously", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): all\n Ray installed from (source or binary): source\n Ray version: Master\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n The backend writes messages to a socket synchronously, which can block the writer's event loop. There are a few places where we do this on the main event loop:\n \n When forwarding a task to a remote node manager: code\n When assigning a task to a worker: code\n When sending a Pull request to a remote object manager: code\n \n We should modify the  class to allow messages to be written asynchronously. boost::asio's doesn't guarantee correctness if we allow concurrent asynchronous writes on the same socket, so we must implement a queue per socket ourselves. Here is an <denchmark-link:https://github.com/stephanie-wang/ray/blob/xray-ysb-failure-test/src/ray/common/client_connection.cc#L166>example</denchmark-link>\n .\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "stephanie-wang", "commentT": "2018-09-27T16:08:28Z", "comment_text": "\n \t\tMaybe could use a strand when posting to a thread pool, which guarantees both correctness and order?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "stephanie-wang", "commentT": "2018-10-19T04:57:32Z", "comment_text": "\n \t\tFixed by <denchmark-link:https://github.com/ray-project/ray/pull/3023>#3023</denchmark-link>\n .\n \t\t"}}}, "commit": {"commit_id": "9d23fa03c98f2847271bef1551c736abf03d2204", "commit_author": "Eric Liang", "commitT": "2018-10-18 21:56:22-07:00", "commit_complexity": {"commit_NLOC": "0.06521739130434782", "commit_CCN": "0.75", "commit_Nprams": "0.6032608695652174"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": ".travis.yml", "file_new_name": ".travis.yml", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "57,188", "deleted_lines": "57"}}}, "file_1": {"file_change_type": "RENAME", "file_Nmethod": 0, "file_old_name": ".travis\\yapf.sh", "file_new_name": ".travis\\format.sh", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "src\\ray\\common\\client_connection.cc", "file_new_name": "src\\ray\\common\\client_connection.cc", "file_complexity": {"file_NLOC": "208", "file_CCN": "34", "file_NToken": "1753"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118", "deleted_lines": null, "method_info": {"method_name": "ray::ServerConnection<T>::WriteMessageAsync", "method_params": "type,length,message,handler", "method_startline": "96", "method_endline": "118", "method_complexity": {"method_NLOC": "20", "method_CCN": "4", "method_NToken": "178", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "81,82", "method_info": {"method_name": "ray::ServerConnection<T>::WriteMessage", "method_params": "type,length,message", "method_startline": "73", "method_endline": "84", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "127", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "23,24,25,26,27", "deleted_lines": "23", "method_info": {"method_name": "ray::ServerConnection<T>::Create", "method_params": "socket", "method_startline": "23", "method_endline": "27", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "226,227", "deleted_lines": null, "method_info": {"method_name": "ray::ClientConnection<T>::ProcessMessageHeader", "method_params": "error", "method_startline": "210", "method_endline": "228", "method_complexity": {"method_NLOC": "14", "method_CCN": "2", "method_NToken": "119", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "205,206", "deleted_lines": null, "method_info": {"method_name": "ray::ClientConnection<T>::ProcessMessages", "method_params": "", "method_startline": "196", "method_endline": "207", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "123", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "237", "deleted_lines": null, "method_info": {"method_name": "ray::ClientConnection<T>::ProcessMessage", "method_params": "error", "method_startline": "231", "method_endline": "243", "method_complexity": {"method_NLOC": "12", "method_CCN": "3", "method_NToken": "111", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164", "deleted_lines": "125,126,146,147,157", "method_info": {"method_name": "ray::ServerConnection<T>::DoAsyncWrites", "method_params": "", "method_startline": "121", "method_endline": "164", "method_complexity": {"method_NLOC": "38", "method_CCN": "6", "method_NToken": "299", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "31,32,33,34", "deleted_lines": null, "method_info": {"method_name": "ray::ServerConnection<T>::ServerConnection", "method_params": "socket", "method_startline": "30", "method_endline": "34", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "44", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\common\\client_connection.h", "file_new_name": "src\\ray\\common\\client_connection.h", "file_complexity": {"file_NLOC": "80", "file_CCN": "2", "file_NToken": "629"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "136,137,138", "deleted_lines": null, "method_info": {"method_name": "ray::ClientConnection::shared_ClientConnection_from_this", "method_params": "", "method_startline": "136", "method_endline": "138", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "70,71,72,73", "deleted_lines": null, "method_info": {"method_name": "ray::ServerConnection::Close", "method_params": "", "method_startline": "70", "method_endline": "73", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\object_manager\\object_manager.cc", "file_new_name": "src\\ray\\object_manager\\object_manager.cc", "file_complexity": {"file_NLOC": "640", "file_CCN": "113", "file_NToken": "5018"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "269,275", "deleted_lines": "269,270,271,272", "method_info": {"method_name": "ray::ObjectManager::PullEstablishConnection", "method_params": "object_id,client_id", "method_startline": "250", "method_endline": "277", "method_complexity": {"method_NLOC": "25", "method_CCN": "3", "method_NToken": "154", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "279,280,285,287,288,289,290,291,292,293", "deleted_lines": "279,280,281,285,286,291,293,294", "method_info": {"method_name": "ray::ObjectManager::PullSendRequest", "method_params": "object_id,conn", "method_startline": "279", "method_endline": "294", "method_complexity": {"method_NLOC": "16", "method_CCN": "2", "method_NToken": "141", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\object_manager\\object_manager.h", "file_new_name": "src\\ray\\object_manager\\object_manager.h", "file_complexity": {"file_NLOC": "148", "file_CCN": "3", "file_NToken": "1076"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "248,250,251", "deleted_lines": "248,250,251"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\object_manager\\object_manager_client_connection.cc", "file_new_name": "src\\ray\\object_manager\\object_manager_client_connection.cc", "file_complexity": {"file_NLOC": "23", "file_CCN": "3", "file_NToken": "163"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "14", "deleted_lines": "14", "method_info": {"method_name": "ray::SenderConnection::Create", "method_params": "io_service,client_id,ip,port", "method_startline": "7", "method_endline": "19", "method_complexity": {"method_NLOC": "13", "method_CCN": "2", "method_NToken": "109", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\object_manager\\object_manager_client_connection.h", "file_new_name": "src\\ray\\object_manager\\object_manager_client_connection.h", "file_complexity": {"file_NLOC": "42", "file_CCN": "6", "file_NToken": "278"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "54,55,56,57", "deleted_lines": null, "method_info": {"method_name": "ray::SenderConnection::WriteMessageAsync", "method_params": "type,length,message,handler", "method_startline": "54", "method_endline": "57", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "45", "method_nesting_level": "2"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\CMakeLists.txt", "file_new_name": "src\\ray\\raylet\\CMakeLists.txt", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "35", "deleted_lines": null}}}, "file_9": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "src\\ray\\raylet\\client_connection_test.cc", "file_complexity": {"file_NLOC": "121", "file_CCN": "9", "file_NToken": "1068"}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "file_complexity": {"file_NLOC": "1092", "file_CCN": "156", "file_NToken": "8771"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "362", "deleted_lines": "362", "method_info": {"method_name": "ray::raylet::NodeManager::ClientAdded", "method_params": "client_data", "method_startline": "317", "method_endline": "368", "method_complexity": {"method_NLOC": "36", "method_CCN": "4", "method_NToken": "287", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1529,1530,1531,1570", "deleted_lines": "1525,1526,1528,1567,1570", "method_info": {"method_name": "ray::raylet::NodeManager::ForwardTaskOrResubmit", "method_params": "task,node_manager_id", "method_startline": "1524", "method_endline": "1571", "method_complexity": {"method_NLOC": "27", "method_CCN": "2", "method_NToken": "219", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1570,1573,1574,1600,1601,1605,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,1634,1635,1636,1637,1638,1639", "deleted_lines": "1570,1596,1600,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1635,1636,1637,1638", "method_info": {"method_name": "ray::raylet::NodeManager::ForwardTask", "method_params": "task,node_id", "method_startline": "1570", "method_endline": "1639", "method_complexity": {"method_NLOC": "44", "method_CCN": "8", "method_NToken": "366", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1307,1309,1310,1311,1312,1313,1314,1315,1316,1317,1318,1319,1320,1321,1322,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,1353,1354,1355,1356,1357,1358,1359", "deleted_lines": "1307,1309,1310,1311,1312,1313,1314,1315,1316,1317,1318,1319,1320,1321,1322,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,1353,1354,1355,1356", "method_info": {"method_name": "ray::raylet::NodeManager::AssignTask", "method_params": "task", "method_startline": "1255", "method_endline": "1360", "method_complexity": {"method_NLOC": "65", "method_CCN": "9", "method_NToken": "556", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "1573,1574,1600,1601,1605,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,1634,1635,1636,1637,1638,1639,1640,1641,1643,1644,1646", "deleted_lines": "1596,1600,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1635,1636,1637,1638", "method_info": {"method_name": "ray::raylet::NodeManager::ForwardTask", "method_params": "task,node_id,on_error", "method_startline": "1573", "method_endline": "1647", "method_complexity": {"method_NLOC": "49", "method_CCN": "8", "method_NToken": "409", "method_nesting_level": "2"}}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\node_manager.h", "file_new_name": "src\\ray\\raylet\\node_manager.h", "file_complexity": {"file_NLOC": "105", "file_CCN": "0", "file_NToken": "732"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "177,178,179,180,355,356", "deleted_lines": "177,178,179,180,355"}}}}}}