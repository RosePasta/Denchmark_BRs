{"BR": {"BR_id": "12244", "BR_author": "ivallesp", "BRopenT": "2020-11-22T23:02:36Z", "BRcloseT": "2020-12-11T12:24:38Z", "BR_text": {"BRsummary": "[rllib] Unable to restore multiagent PPO policy models with tensorflow", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Ray version: 1.0.1\n Tensorflow version: 2.3.1\n Operative systems tested: Ubuntu 18.04 and MacOS Mojave\n Hi, I am trying to export a trained policy in a multiagent environment as a tensorflow model, but it is dropping me an UnliftableError. I tried to simplify the reproduction script as much as possible.\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n <denchmark-code>from gym.spaces import Discrete\n \n import ray\n from ray.rllib.examples.env.rock_paper_scissors import RockPaperScissors\n from ray.rllib.agents import ppo\n \n \n select_policy = lambda agent_id: \"policy_01\" if agent_id == \"player1\" else \"policy_02\"\n \n config = {\n     \"multiagent\": {\n         \"policies\": {\n             \"policy_01\": (None, Discrete(3), Discrete(3), {}),\n             \"policy_02\": (None, Discrete(3), Discrete(3), {}),\n         },\n         \"policy_mapping_fn\": select_policy,\n     },\n }\n \n ray.init()\n trainer = ppo.PPOTrainer(env=RockPaperScissors, config=config)\n trainer.train()  # Train one step\n trainer.export_policy_model(\"exported_model\", \"policy_01\")\n </denchmark-code>\n \n Once the model is saved, try to restore it in tensorflow with the following 2 lines.\n <denchmark-code>import tensorflow as tf\n tf.saved_model.load(\"exported_model\")\n </denchmark-code>\n \n This drops me the following error:\n <denchmark-code>WARNING:tensorflow:From /Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/ray/rllib/policy/tf_policy.py:653: build_tensor_info (from tensorflow.python.saved_model.utils_impl) is deprecated and will be removed in a future version.\n Instructions for updating:\n This function will only be available through the v1 compatibility library as tf.compat.v1.saved_model.utils.build_tensor_info or tf.compat.v1.saved_model.build_tensor_info.\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/timestep_1:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/kl_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/entropy_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/lr:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/global_step:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/timestep_1:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/kl_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/entropy_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/lr:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/global_step:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Some variables could not be lifted out of a loaded function. Run the tf.initializers.tables_initializer() operation to restore these variables.\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/timestep_1:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/kl_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/entropy_coeff:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/lr:0' shape=() dtype=float32_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n WARNING:tensorflow:Unable to create a python object for variable <tf.Variable 'policy_01/global_step:0' shape=() dtype=int64_ref> because it is a reference variable. It may not be visible to training APIs. If this is a problem, consider rebuilding the SavedModel after running tf.compat.v1.enable_resource_variables().\n Traceback (most recent call last):\n   File \"minimal.py\", line 27, in <module>\n     tf.saved_model.load(\"exported_model\")\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/saved_model/load.py\", line 603, in load\n     return load_internal(export_dir, tags, options)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/saved_model/load.py\", line 649, in load_internal\n     root = load_v1_in_v2.load(export_dir, tags)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/saved_model/load_v1_in_v2.py\", line 263, in load\n     return loader.load(tags=tags)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/saved_model/load_v1_in_v2.py\", line 246, in load\n     signature_functions = self._extract_signatures(wrapped, meta_graph_def)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/saved_model/load_v1_in_v2.py\", line 158, in _extract_signatures\n     signature_fn = wrapped.prune(feeds=feeds, fetches=fetches)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/eager/wrap_function.py\", line 338, in prune\n     base_graph=self._func_graph)\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/eager/lift_to_graph.py\", line 260, in lift_to_graph\n     add_sources=add_sources))\n   File \"/Users/ivallesp/projects/rockpaperscisors/.venv/lib/python3.7/site-packages/tensorflow/python/ops/op_selector.py\", line 413, in map_subgraph\n     % (repr(init_tensor), repr(op), _path_from(op, init_tensor, sources)))\n tensorflow.python.ops.op_selector.UnliftableError: A SavedModel signature needs an input for each placeholder the signature's outputs use. An output for signature 'serving_default' depends on a placeholder which is not an input (i.e. the placeholder is not fed a value).\n \n Unable to lift tensor <tf.Tensor 'policy_01/cond_2/Merge:0' shape=(?,) dtype=float32> because it depends transitively on placeholder <tf.Operation 'policy_01/timestep' type=Placeholder> via at least one path, e.g.: policy_01/cond_2/Merge (Merge) <- policy_01/cond_2/Switch_1 (Switch) <- policy_01/cond_2/pred_id (Identity) <- policy_01/LogicalAnd (LogicalAnd) <- policy_01/GreaterEqual (GreaterEqual) <- policy_01/timestep (Placeholder)\n </denchmark-code>\n \n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ivallesp", "commentT": "2020-11-23T09:47:25Z", "comment_text": "\n \t\tIn case somebody else faces this issue, the workaround is to downgrade to ray===1.0.0. In this version the same warnings are dropped but the UnliftableError disappears.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ivallesp", "commentT": "2020-11-23T10:06:45Z", "comment_text": "\n \t\tThanks work the issue and workaround <denchmark-link:https://github.com/ivallesp>@ivallesp</denchmark-link>\n . cc <denchmark-link:https://github.com/sven1977>@sven1977</denchmark-link>\n  have you seen this one?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ivallesp", "commentT": "2020-11-29T20:08:14Z", "comment_text": "\n \t\tThere is an extra problem here. When you call trainer.export_policy_model(\"exported_model\", \"policy_01\") in the example above, the weights of all the defined policies are stored in the exported_model folder, not only the ones of policy_01 as specified.\n I have been reviewing the code and I have seen that the  function <denchmark-link:https://github.com/ray-project/ray/blob/fb318addcb58548067f115b92e8e2265f8ff218c/rllib/policy/tf_policy.py#L464>here</denchmark-link>\n  adds the variables of all the policies defined in the tf session, although the  defined two lines above is correctly built. I don't find any workaround for now.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ivallesp", "commentT": "2020-12-11T10:32:48Z", "comment_text": "\n \t\tThanks for filing this <denchmark-link:https://github.com/ivallesp>@ivallesp</denchmark-link>\n ! Taking a look rn. I can reproduce the above error.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ivallesp", "commentT": "2020-12-11T12:23:10Z", "comment_text": "\n \t\tCould you try this fix here? It's working for me. The problem is apparently that for some reason, the timestep placeholder must be one with default value. I'm not understanding fully, why that's the case. The example is further reducable to non multi-agent (e.g. CartPole and no multiagent config), num_workers=0, simple_optimizer=True (I thought it may have had something to do with the multi-GPU optimizer's copying the policies, but it doesn't).\n <denchmark-link:https://github.com/ray-project/ray/pull/12786>#12786</denchmark-link>\n \n <denchmark-link:https://github.com/ivallesp>@ivallesp</denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ivallesp", "commentT": "2020-12-11T12:23:42Z", "comment_text": "\n \t\tCould simply be a tf1.x quirk.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ivallesp", "commentT": "2020-12-11T12:24:38Z", "comment_text": "\n \t\tClosing this issue. Feel free to re-open if the above solution does not fix the problem on your end.\n I was also able to make these Unable to create a python object for variable <tf.Variabl... warnings go away. But these were unrelated to the actual error/crash.\n \t\t"}}}, "commit": {"commit_id": "74c98ac38e24018da157be2a76ab63d930d2caf5", "commit_author": "Sven Mika", "commitT": "2020-12-11 16:13:38+01:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\policy\\dynamic_tf_policy.py", "file_new_name": "rllib\\policy\\dynamic_tf_policy.py", "file_complexity": {"file_NLOC": "467", "file_CCN": "11", "file_NToken": "3273"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "236,237", "deleted_lines": "236"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\policy\\tf_policy.py", "file_new_name": "rllib\\policy\\tf_policy.py", "file_complexity": {"file_NLOC": "691", "file_CCN": "78", "file_NToken": "4266"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "191,192", "deleted_lines": "191"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\utils\\framework.py", "file_new_name": "rllib\\utils\\framework.py", "file_complexity": {"file_NLOC": "157", "file_CCN": "43", "file_NToken": "876"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "91", "deleted_lines": null, "method_info": {"method_name": "try_import_tf", "method_params": "error", "method_startline": "45", "method_endline": "101", "method_complexity": {"method_NLOC": "29", "method_CCN": "10", "method_NToken": "152", "method_nesting_level": "0"}}}}}}}}