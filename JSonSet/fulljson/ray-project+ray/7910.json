{"BR": {"BR_id": "7910", "BR_author": "devinbarry", "BRopenT": "2020-04-06T11:58:28Z", "BRcloseT": "2020-07-27T16:25:31Z", "BR_text": {"BRsummary": "[rllib] IMPALA: FloatingPointError: invalid value encountered in double_scalars", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n IMPALA metrics makes assumption about  items not being empty in the <denchmark-link:https://github.com/ray-project/ray/blob/master/rllib/utils/window_stat.py>WindowStat</denchmark-link>\n  class. If it is in fact empty, we get an exception rather that \n <denchmark-code>/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/numpy/core/fromnumeric.py:3257: RuntimeWarning: Mean of empty slice.\n   out=out, **kwargs)\n Traceback (most recent call last):\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/home/axion/git/jengu/jengu/train/impala_train.py\", line 43, in <module>\n     result = agent.train()\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 505, in train\n     raise e\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 491, in train\n     result = Trainable.train(self)\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/tune/trainable.py\", line 261, in train\n     result = self._train()\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py\", line 161, in _train\n     res = self.collect_metrics()\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 899, in collect_metrics\n     selected_workers=selected_workers)\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/optimizers/policy_optimizer.py\", line 113, in collect_metrics\n     res.update(info=self.stats())\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/optimizers/async_samples_optimizer.py\", line 166, in stats\n     stats[\"learner_queue\"] = self.learner.learner_queue_size.stats()\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/ray/rllib/utils/window_stat.py\", line 25, in stats\n     self.name + \"_mean\": float(np.mean(self.items[:self.count])),\n   File \"<__array_function__ internals>\", line 6, in mean\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/numpy/core/fromnumeric.py\", line 3257, in mean\n     out=out, **kwargs)\n   File \"/home/axion/anaconda3/envs/trading/lib/python3.7/site-packages/numpy/core/_methods.py\", line 161, in _mean\n     ret = ret.dtype.type(ret / rcount)\n FloatingPointError: invalid value encountered in double_scalars\n </denchmark-code>\n \n Ray version and other system information (Python version, TensorFlow version, OS):\n Python 3.7\n All versions of Ray up to the latest nightlies\n Tensorflow 2.1.0\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n I don't have a reproduction for this because the environment that triggers it is custom. Its pretty obvious what is going on though. It just needs the same treatment as the other metrics bugs of this class had here <denchmark-link:https://github.com/ray-project/ray/commit/797e6cfc2afa7d7f503ad847b31c36a010c4513c>797e6cf</denchmark-link>\n \n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "devinbarry", "commentT": "2020-07-13T01:57:20Z", "comment_text": "\n \t\tThe commit <denchmark-link:https://github.com/ray-project/ray/pull/9213>#9213</denchmark-link>\n  should have fixed this! Let us know if you still have any issues.\n \t\t"}}}, "commit": {"commit_id": "15aa08a3d1c304fb7fddfffd225ef7902f668679", "commit_author": "Tanay Wakhare", "commitT": "2020-07-12 23:01:32+02:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\utils\\window_stat.py", "file_new_name": "rllib\\utils\\window_stat.py", "file_complexity": {"file_NLOC": "24", "file_CCN": "4", "file_NToken": "202"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "19,21,22,25,26,27", "deleted_lines": "19,21,22,25,26,27", "method_info": {"method_name": "stats", "method_params": "self", "method_startline": "17", "method_endline": "28", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "121", "method_nesting_level": "1"}}}}}}}}