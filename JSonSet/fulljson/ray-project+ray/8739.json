{"BR": {"BR_id": "8739", "BR_author": "Coac", "BRopenT": "2020-06-02T16:18:14Z", "BRcloseT": "2020-06-04T20:28:47Z", "BR_text": {"BRsummary": "[rllib] Crash when using hybrid action space env and eager mode.", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n RLlib crashes on environment with hybrid action space (discrete and continuous) and eager mode enabled\n It works well if eager mode is turned off.\n Python3.7\n tensorflow==2.2.0\n ray==0.9.0.dev0 (used the nightly version)\n Ubuntu 18.04\n <denchmark-h:h3>Script to reproduce</denchmark-h>\n \n Modified from ray/rllib/examples/custom_env.py adding Box to the action space to make it hybrid\n <denchmark-code>import gym\n import numpy as np\n import ray\n from gym.spaces import Discrete, Box\n from ray import tune\n from ray.rllib.utils.framework import try_import_tf\n \n tf = try_import_tf()\n \n \n class SimpleCorridor(gym.Env):\n     \"\"\"Example of a custom env in which you have to walk down a corridor.\n \n     You can configure the length of the corridor via the env config.\"\"\"\n \n     def __init__(self, config):\n         self.end_pos = config[\"corridor_length\"]\n         self.cur_pos = 0\n         self.action_space = gym.spaces.Tuple([Discrete(2), Box(0.0, 1.0, shape=(1,))])  # Hybrid action space\n         self.observation_space = Box(\n             0.0, self.end_pos, shape=(1,), dtype=np.float32)\n \n     def reset(self):\n         self.cur_pos = 0\n         return [self.cur_pos]\n \n     def step(self, action):\n         action = action[0]\n         assert action in [0, 1], action\n         if action == 0 and self.cur_pos > 0:\n             self.cur_pos -= 1\n         elif action == 1:\n             self.cur_pos += 1\n         done = self.cur_pos >= self.end_pos\n         return [self.cur_pos], 1.0 if done else -0.1, done, {}\n \n \n if __name__ == \"__main__\":\n     ray.init()\n \n     config = {\n         \"env\": SimpleCorridor,  # or \"corridor\" if registered above\n         \"env_config\": {\n             \"corridor_length\": 5,\n         },\n         \"model\": {\n         },\n         \"eager\": True,  # If True crashes\n         \"vf_share_layers\": True,\n         \"lr\": 1e-2,\n         \"num_workers\": 1,\n         \"framework\": \"tf\",\n     }\n \n     results = tune.run(\"PPO\", config=config)\n \n     ray.shutdown()\n </denchmark-code>\n \n Outputs following error\n <denchmark-code>  File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py\", line 90, in __init__\n     Trainer.__init__(self, config, env, logger_creator)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 444, in __init__\n     super().__init__(config, logger_creator)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/tune/trainable.py\", line 174, in __init__\n     self._setup(copy.deepcopy(self.config))\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 613, in _setup\n     self._init(self.config, self.env_creator)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py\", line 115, in _init\n     self.config[\"num_workers\"])\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 684, in _make_workers\n     logdir=self.logdir)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/evaluation/worker_set.py\", line 59, in __init__\n     RolloutWorker, env_creator, policy, 0, self._local_config)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/evaluation/worker_set.py\", line 282, in _make_worker\n     extra_python_environs=extra_python_environs)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/evaluation/rollout_worker.py\", line 393, in __init__\n     policy_dict, policy_config)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/evaluation/rollout_worker.py\", line 930, in _build_policy_map\n     policy_map[name] = cls(obs_space, act_space, merged_conf)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/policy/eager_tf_policy.py\", line 258, in __init__\n     self._initialize_loss_with_dummy_batch()\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/policy/eager_tf_policy.py\", line 626, in _initialize_loss_with_dummy_batch\n     explore=False)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/policy/eager_tf_policy.py\", line 60, in _func\n     return func(*args, **kwargs)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/policy/eager_tf_policy.py\", line 68, in _func\n     out = func(*args, **kwargs)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/ray/rllib/policy/eager_tf_policy.py\", line 335, in compute_actions\n     tf.convert_to_tensor(prev_action_batch)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/framework/ops.py\", line 1217, in convert_to_tensor_v1\n     return convert_to_tensor_v2(value, dtype, preferred_dtype, name)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/framework/ops.py\", line 1283, in convert_to_tensor_v2\n     as_ref=False)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/framework/ops.py\", line 1341, in convert_to_tensor\n     ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1455, in _autopacking_conversion_function\n     return _autopacking_helper(v, dtype, name or \"packed\")\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/ops/array_ops.py\", line 1361, in _autopacking_helper\n     return gen_array_ops.pack(list_or_tuple, name=name)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6337, in pack\n     _ops.raise_from_not_ok_status(e, name)\n   File \"/home/coac/anaconda3/envs/rllib/lib/python3.7/site-packages/tensorflow/python/framework/ops.py\", line 6653, in raise_from_not_ok_status\n     six.raise_from(core._status_to_exception(e.code, message), None)\n   File \"<string>\", line 3, in raise_from\n tensorflow.python.framework.errors_impl.InvalidArgumentError: cannot compute Pack as input #1(zero-based) was expected to be a int64 tensor but is a float tensor [Op:Pack] name: packed\n \n </denchmark-code>\n \n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Coac", "commentT": "2020-06-03T20:03:51Z", "comment_text": "\n \t\tI think this is a matter of missing tf.cast() to float32 somewhere. Unfortunately, eager mode has slightly different type conversions than graph mode. Can you try finding the right place to add this conversion?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Coac", "commentT": "2020-06-04T11:55:46Z", "comment_text": "\n \t\tSure, I will do a PR\n \t\t"}}}, "commit": {"commit_id": "aee01133cd4ad4f822994b5c1b8b5f415f27b887", "commit_author": "Victor Le", "commitT": "2020-06-04 13:28:46-07:00", "commit_complexity": {"commit_NLOC": "0.3333333333333333", "commit_CCN": "0.3333333333333333", "commit_Nprams": "0.6666666666666666"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\models\\tf\\tf_action_dist.py", "file_new_name": "rllib\\models\\tf\\tf_action_dist.py", "file_complexity": {"file_NLOC": "391", "file_CCN": "79", "file_NToken": "3052"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "233", "deleted_lines": "233", "method_info": {"method_name": "logp", "method_params": "self,x", "method_startline": "231", "method_endline": "235", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "90", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\policy\\eager_tf_policy.py", "file_new_name": "rllib\\policy\\eager_tf_policy.py", "file_complexity": {"file_NLOC": "509", "file_CCN": "97", "file_NToken": "3231"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "592,593,594,595,596,597,598,599,600", "deleted_lines": "589,590", "method_info": {"method_name": "_initialize_loss_with_dummy_batch", "method_params": "self", "method_startline": "582", "method_endline": "649", "method_complexity": {"method_NLOC": "49", "method_CCN": "8", "method_NToken": "403", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "rllib\\tests\\test_supported_spaces.py", "file_new_name": "rllib\\tests\\test_supported_spaces.py", "file_complexity": {"file_NLOC": "166", "file_CCN": "28", "file_NToken": "1300"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "169", "deleted_lines": "166", "method_info": {"method_name": "test_ppo", "method_params": "self", "method_startline": "161", "method_endline": "169", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "43", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "147", "deleted_lines": null, "method_info": {"method_name": "test_dqn", "method_params": "self", "method_startline": "145", "method_endline": "147", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "51,98,99,100,101", "deleted_lines": "51,98", "method_info": {"method_name": "check_support", "method_params": "alg,config,check_bounds,tfe", "method_startline": "51", "method_endline": "107", "method_complexity": {"method_NLOC": "11", "method_CCN": "5", "method_NToken": "93", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "51,98,99,100,101", "deleted_lines": "51,98", "method_info": {"method_name": "check_support", "method_params": "alg,config,check_bounds", "method_startline": "51", "method_endline": "104", "method_complexity": {"method_NLOC": "8", "method_CCN": "4", "method_NToken": "77", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "173", "deleted_lines": null, "method_info": {"method_name": "test_pg", "method_params": "self", "method_startline": "171", "method_endline": "173", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "31", "method_nesting_level": "1"}}}}}}}}