{"BR": {"BR_id": "11924", "BR_author": "danuo", "BRopenT": "2020-11-11T00:58:40Z", "BRcloseT": "2020-11-25T07:43:18Z", "BR_text": {"BRsummary": "[rllib] ES and ARC agents cannot utilized custom environment in rollout.py", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n When performing a rollout with rollout.py, one cannot pass a custom environment directly into the function. Instead, a custom environment needs to be registered with ray.tune.registry.register_env() which then can be called by it's name. This works fine with most of the agents, specifically those which use workers. This approach fails for the agents ES and ARC, as shown below.\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n # CREATE CHECKPOINT WITH CUSTOM ENVIRONMENT\n from ray import tune\n import gym, numpy\n from gym.spaces import Discrete, Box\n \n class SimpleCorridor(gym.Env):\n     def __init__(self, config):\n         self.end_pos = 10\n         self.cur_pos = 0\n         self.action_space = Discrete(2)\n         self.observation_space = Box(\n             0.0, self.end_pos, shape=(1, ), dtype=numpy.float32)\n     def reset(self):\n         self.cur_pos = 0\n         return numpy.array([self.cur_pos])\n     def step(self, action):\n         assert action in [0, 1], action\n         if action == 0 and self.cur_pos > 0:\n             self.cur_pos -= 1\n         elif action == 1:\n             self.cur_pos += 1\n         done = self.cur_pos >= self.end_pos\n         return numpy.array([self.cur_pos]), 1.0 if done else -0.1, done, {}\n \n tune.run(\n     \"ARS\", # or \"ARS\"\n     name = \"Bugreport\",\n     checkpoint_at_end = True,\n     config = {\"env\": SimpleCorridor,},\n     stop = {\"timesteps_total\": 300_000,}\n     )\n Now, let's try a rollout with the following code:\n # ROLLOUT CHECKPOINT WITH CUSTOM ENVIRONMENT\n import gym, json\n from gym.spaces import Discrete, Box\n import numpy as np\n from ray.rllib import rollout\n from ray.tune.registry import register_env\n \n class SimpleCorridor(gym.Env):\n     def __init__(self, config):\n         self.end_pos = 10\n         self.cur_pos = 0\n         self.action_space = Discrete(2)\n         self.observation_space = Box(\n             0.0, self.end_pos, shape=(1, ), dtype=np.float32)\n     def reset(self):\n         self.cur_pos = 0\n         return np.array([self.cur_pos])\n     def step(self, action):\n         assert action in [0, 1], action\n         if action == 0 and self.cur_pos > 0:\n             self.cur_pos -= 1\n         elif action == 1:\n             self.cur_pos += 1\n         done = self.cur_pos >= self.end_pos\n         return np.array([self.cur_pos]), 1.0 if done else -0.1, done, {}\n register_env(\"simplecorridor-v1\", lambda c: SimpleCorridor(c))\n \n checkpoint = # ! PATH TO CHECKPOINT\n string = ' '.join([\n     checkpoint,\n     '--run',\n     'ARS',\n     '--env',\n     'simplecorridor-v1',\n     '--episodes',\n     str(10),\n     '--no-render',\n ])\n \n config = {\"env_config\": {},}\n config_json = json.dumps(config)\n parser = rollout.create_parser()\n args = parser.parse_args(string.split() + ['--config', config_json])\n rollout.run(args, parser)\n Most agents use workers, so in rollout.py the environment gets loaded by (copied from def rollout()):\n env = agent.workers.local_worker().env\n As the agents ES and ARS don't feature workers, the environment is currently loaded with gym.make(env_name). This fails when a custom environment is used.\n env = gym.make(env_name)\n -> raise error.UnregisteredEnv('No registered env with id: {}'.format(id)) \n gym.error.UnregisteredEnv: No registered env with id: simplecorridor-v1\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {}}, "commit": {"commit_id": "c009c178f6b8adaff9bb8e9cca2d0797d3d14425", "commit_author": "danuo", "commitT": "2020-11-25 08:43:17+01:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\rollout.py", "file_new_name": "rllib\\rollout.py", "file_complexity": {"file_NLOC": "392", "file_CCN": "43", "file_NToken": "2139"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "17,23,369,370,371,372,373,374,375,376,377,378,379", "deleted_lines": "22,368"}}}}}}