{"BR": {"BR_id": "8784", "BR_author": "simon-mo", "BRopenT": "2020-06-04T19:10:23Z", "BRcloseT": "2020-07-02T18:40:15Z", "BR_text": {"BRsummary": "[Serve] Prometheus Metric Overrides", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Serve's prometheus exporter is stores a metric name -> default label mapping, this is a bug because there are can different metrics for the same name without different default labels.\n Ray version and other system information (Python version, TensorFlow version, OS):\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):\n Code\n import time\n import pprint\n \n import ray\n from ray import serve\n from ray.serve.constants import SERVE_MASTER_NAME\n from ray.serve.metric import MetricClient, PrometheusExporter\n \n serve.init(metric_exporter=PrometheusExporter)\n \n @ray.remote\n class AsyncActor:\n     async def run(self, key):\n         actor = ray.get_actor(SERVE_MASTER_NAME)\n         [metric_exporter] = ray.get(actor.get_metric_exporter.remote())\n         client = MetricClient(metric_exporter, default_labels={\"key\": key})\n         counter = client.new_counter(\"same_name\")\n         for _ in range(10):\n             counter.add()\n             await client._push_to_exporter_once()\n \n a = AsyncActor.remote()\n b = AsyncActor.remote()\n ray.get([a.run.remote(\"a\"), b.run.remote(\"b\")])\n \n print(serve.stat().decode())\n Output\n <denchmark-code>2020-06-04 12:07:19,281\tINFO resource_spec.py:212 -- Starting Ray with 21.97 GiB memory available for workers and up to 10.99 GiB for objects. You can adjust these settings with ray.init(memory=<bytes>, object_store_memory=<bytes>).\n 2020-06-04 12:07:19,500\tWARNING services.py:923 -- Redis failed to start, retrying now.\n 2020-06-04 12:07:19,740\tINFO services.py:1165 -- View the Ray dashboard at localhost:8265\n (pid=61255) 2020-06-04 12:07:21,622\tINFO master.py:182 -- Starting metric exporter with name 'SERVE_METRIC_SINK_ACTOR'\n (pid=61255) 2020-06-04 12:07:21,636\tINFO master.py:130 -- Starting router with name 'SERVE_ROUTER_ACTOR'\n (pid=61255) 2020-06-04 12:07:21,644\tINFO master.py:152 -- Starting HTTP proxy with name 'SERVE_PROXY_ACTOR' on node 'node:192.168.31.141'\n (pid=61267) INFO:     Started server process [61267]\n (pid=61267) INFO:     Waiting for application startup.\n (pid=61267) INFO:     Application startup complete.\n # HELP same_name_total\n # TYPE same_name_total counter\n same_name_total{key=\"a\"} 20.0\n # TYPE same_name_created gauge\n same_name_created{key=\"a\"} 1.591297642889063e+09\n </denchmark-code>\n \n Expected:\n <denchmark-code>same_name_total{key=\"a\"} 10.0\n ...\n same_name_total{key=\"b\"} 10.0\n </denchmark-code>\n \n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {}}, "commit": {"commit_id": "a25472c657d6e3338c396d4261c30a060d608274", "commit_author": "Simon Mo", "commitT": "2020-07-02 11:40:14-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.5882352941176471", "commit_Nprams": "0.5294117647058824"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\serve\\metric\\client.py", "file_new_name": "python\\ray\\serve\\metric\\client.py", "file_complexity": {"file_NLOC": "113", "file_CCN": "8", "file_NToken": "473"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "2,4,5,29,30,112,113,114,115,116,117,118,121", "deleted_lines": "2,4,5,6,7,8,32,33,104,105,106,107,121,123"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 10, "file_old_name": "python\\ray\\serve\\metric\\exporter.py", "file_new_name": "python\\ray\\serve\\metric\\exporter.py", "file_complexity": {"file_NLOC": "117", "file_CCN": "21", "file_NToken": "821"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "142,143,144,145,146,147,149", "deleted_lines": "142", "method_info": {"method_name": "_process_batch", "method_params": "self,metric_metadata,batch", "method_startline": "142", "method_endline": "157", "method_complexity": {"method_NLOC": "15", "method_CCN": "5", "method_NToken": "110", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "57", "deleted_lines": "57", "method_info": {"method_name": "ingest", "method_params": "self,str,MetricBatch", "method_startline": "57", "method_endline": "58", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "92,93", "deleted_lines": "91", "method_info": {"method_name": "inspect_metrics", "method_params": "self", "method_startline": "86", "method_endline": "94", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "71", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "73,74", "deleted_lines": "73", "method_info": {"method_name": "export", "method_params": "self,int,MetricBatch", "method_startline": "73", "method_endline": "74", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "49,52", "deleted_lines": "49,52", "method_info": {"method_name": "__init__", "method_params": "self,ExporterInterface", "method_startline": "45", "method_endline": "55", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "140,141,142,143,144,145,146,147,149", "deleted_lines": "137,138,139,140,142", "method_info": {"method_name": "_process_batch", "method_params": "self,batch", "method_startline": "137", "method_endline": "150", "method_complexity": {"method_NLOC": "14", "method_CCN": "4", "method_NToken": "108", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "120,121,122,131,140", "deleted_lines": "127,135,137,138,139,140", "method_info": {"method_name": "_process_metric_metadata", "method_params": "self,metric_metadata", "method_startline": "119", "method_endline": "140", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "105", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "108", "deleted_lines": "106", "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "98", "method_endline": "110", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "74", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "117", "deleted_lines": "115", "method_info": {"method_name": "export", "method_params": "self,metric_metadata,metric_batch", "method_startline": "115", "method_endline": "117", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "23", "method_nesting_level": "1"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "57", "deleted_lines": "57", "method_info": {"method_name": "ingest", "method_params": "self,int,MetricBatch", "method_startline": "57", "method_endline": "58", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "python\\ray\\serve\\metric\\types.py", "file_new_name": "python\\ray\\serve\\metric\\types.py", "file_complexity": {"file_NLOC": "68", "file_CCN": "19", "file_NToken": "522"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32,33,34", "deleted_lines": "33", "method_info": {"method_name": "__hash__", "method_params": "self", "method_startline": "32", "method_endline": "34", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "37", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "16,17,18,19,20", "deleted_lines": "18", "method_info": {"method_name": "__init__", "method_params": "self,client,str,str,None", "method_startline": "16", "method_endline": "20", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "96", "deleted_lines": null, "method_info": {"method_name": "add", "method_params": "self,increment", "method_startline": "92", "method_endline": "96", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "36", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "15,16", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,str,MetricType,str,str", "method_startline": "15", "method_endline": "16", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "33", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "44", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,client,int,str,None", "method_startline": "42", "method_endline": "46", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "104", "deleted_lines": null, "method_info": {"method_name": "record", "method_params": "self,value", "method_startline": "100", "method_endline": "104", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "23,24,25,26,27,28,29,30", "deleted_lines": "25", "method_info": {"method_name": "__eq__", "method_params": "self", "method_startline": "23", "method_endline": "30", "method_complexity": {"method_NLOC": "7", "method_CCN": "6", "method_NToken": "62", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "85", "deleted_lines": "70,78,79,80,81,82,83", "method_info": {"method_name": "labels", "method_params": "self,kwargs", "method_startline": "69", "method_endline": "86", "method_complexity": {"method_NLOC": "11", "method_CCN": "3", "method_NToken": "81", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "python\\ray\\serve\\tests\\test_metric.py", "file_new_name": "python\\ray\\serve\\tests\\test_metric.py", "file_complexity": {"file_NLOC": "172", "file_CCN": "20", "file_NToken": "1119"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160", "deleted_lines": null, "method_info": {"method_name": "test_prometheus_conflicting_labels", "method_params": "serve_instance", "method_startline": "143", "method_endline": "160", "method_complexity": {"method_NLOC": "14", "method_CCN": "3", "method_NToken": "109", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71", "deleted_lines": "49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71", "method_info": {"method_name": "test_client", "method_params": "", "method_startline": "29", "method_endline": "71", "method_complexity": {"method_NLOC": "35", "method_CCN": "3", "method_NToken": "284", "method_nesting_level": "0"}}}}}}}}