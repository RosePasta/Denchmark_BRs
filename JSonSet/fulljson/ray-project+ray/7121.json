{"BR": {"BR_id": "7121", "BR_author": "yongjun823", "BRopenT": "2020-02-11T13:16:33Z", "BRcloseT": "2020-02-27T11:02:20Z", "BR_text": {"BRsummary": "[rllib] How can I record the full episode results of  rllib?", "BRdescription": "\n <denchmark-h:h3>What is your question?</denchmark-h>\n \n Ray version and other system information (Python version, TensorFlow version, OS):\n <denchmark-code>Python version: Python 3.6.10 :: Anaconda, Inc.\n Anaconda version: 4.7.12\n TensorFlow version: 1.15.0\n OS: Ubuntu 16.04\n ray version: 0.8.1\n </denchmark-code>\n \n Hello\n I've trained an RL model using rllib\n I have tested the breakout environment and the agent is running successfully.\n Here is the python code I used. I used Rllib's python API\n If you test at openai gym after learning, it works successfully.\n I want to record the results of the agent.\n Agent test was executed using the rollout command of rllib.\n My result photo is below.\n This is the command I executed\n <denchmark-code>rllib rollout checkpoint_4301/checkpoint-4301 \\\n     --run PPO --env BreakoutNoFrameskip-v4 --monitor --config '{\"monitor\": true}'\n </denchmark-code>\n \n <denchmark-link:https://user-images.githubusercontent.com/19910566/74238350-f6990a00-4d18-11ea-97b5-681da6163a18.png></denchmark-link>\n \n When testing with rollout, on average 8 games run.\n Many episodes ran, but only the results of one game (four lives in the case of breakout) were saved as videos.\n And I think it's a mix of different game parts.\n I additionally tested ms pacman.\n Pacman's recording showed the same problem.\n I have attached my rllib model and the recorded results file.\n I would be grateful if you could tell me a document or a way to help me record the video.\n <denchmark-link:https://github.com/ray-project/ray/files/4185820/PPO_BreakoutNoFrameskip-v4_2020-02-11_21-32-52m48o1b48.zip>PPO_BreakoutNoFrameskip-v4_2020-02-11_21-32-52m48o1b48.zip</denchmark-link>\n \n <denchmark-link:https://github.com/ray-project/ray/files/4185821/BreakoutModel.zip>BreakoutModel.zip</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yongjun823", "commentT": "2020-02-12T14:09:44Z", "comment_text": "\n \t\tThanks for this issue. This sounds almost like a bug. <denchmark-link:https://github.com/ericl>@ericl</denchmark-link>\n  could you comment? If yes, I'll take a look to get this fixed.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yongjun823", "commentT": "2020-02-12T21:42:09Z", "comment_text": "\n \t\tHm, all rollout.py does is adding env = gym.wrappers.Monitor(...). Is it possible this is an issue with the env wrapper configuration from gym?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yongjun823", "commentT": "2020-02-13T06:16:57Z", "comment_text": "\n \t\tThank you for the answer.\n This is the Python code I used to run rllib.\n I tested the result using rollout.py.\n The gym env environment uses BreakoutNoFrameskip-v4 and didn't fix it.\n Can num_workers or num_envs_per_worker be a problem?\n import ray\n import ray.rllib.agents.ppo as ppo\n from ray.tune.logger import pretty_print\n \n ray.init()\n \n config = ppo.DEFAULT_CONFIG.copy()\n \n config[\"num_gpus\"] = 4\n config[\"num_workers\"] = 10 \n config[\"num_envs_per_worker\"] = 5\n config[\"train_batch_size\"] = 50000\n config[\"sample_batch_size\"] = 1000\n config[\"sgd_minibatch_size\"] = 5000\n config[\"eager\"] = False\n \n trainer = ppo.PPOTrainer(config=config, env=\"BreakoutNoFrameskip-v4\")\n \n for i in range(100000):\n \n    if i % 100 == 0:\n \n        checkpoint = trainer.save()\n        print(\"checkpoint saved at\", checkpoint)\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yongjun823", "commentT": "2020-02-26T20:18:46Z", "comment_text": "\n \t\tI can reproduce the issue with CartPole as well. It's only recording a very short sequence of the rolled out episode, and only a few of these as well (4 out of 50 rolled out episodes have mpeg snippet files). Taking a look. ...\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yongjun823", "commentT": "2020-02-27T11:02:20Z", "comment_text": "\n \t\tOk, checkout this PR and let me know, whether this fixes your problems:\n <denchmark-link:https://github.com/ray-project/ray/pull/7347>#7347</denchmark-link>\n \n I separated the --monitor option from the --out option (which used to be silently(!) required to record any videos into the --out + \"monitor\" directory).\n The new command line would be (tested on CartPole with episodes of 1000 ts):\n rllib rollout [your checkpoint file] --run PPO --env BreakoutNoFrameskip-v4 --video-dir [some dir where all(!) episode videos will be stored in full length]\n \t\t"}}}, "commit": {"commit_id": "44ac0ead34ba50be37fac9ecc65bc78551150971", "commit_author": "Sven Mika", "commitT": "2020-02-27 10:39:02-08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.5333333333333333", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "rllib\\rollout.py", "file_new_name": "rllib\\rollout.py", "file_complexity": {"file_NLOC": "366", "file_CCN": "43", "file_NToken": "1956"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "186,190,191,192,193,194,195,196,197,198,200,201,202,203,204,205,206,213", "deleted_lines": "185,189,190,191,193,200,201,202,203,204,229", "method_info": {"method_name": "create_parser", "method_params": "parser_creator", "method_startline": "160", "method_endline": "233", "method_complexity": {"method_NLOC": "73", "method_CCN": "2", "method_NToken": "273", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "238,241,244,245,250,251,252,256,257,260,261,270,273,277,278,279,280,281,282,283,284,285,286,287,288,289,298", "deleted_lines": "238,265,298", "method_info": {"method_name": "run", "method_params": "args,parser", "method_startline": "236", "method_endline": "298", "method_complexity": {"method_NLOC": "43", "method_CCN": "11", "method_NToken": "323", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "331", "deleted_lines": "325,326,328,329", "method_info": {"method_name": "rollout", "method_params": "agent,env_name,num_steps,num_episodes,saver,no_render,video_dir", "method_startline": "325", "method_endline": "331", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "298", "deleted_lines": "298", "method_info": {"method_name": "rollout", "method_params": "agent,env_name,num_steps,num_episodes,saver,no_render,monitor", "method_startline": "292", "method_endline": "298", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "0"}}}}}}}}