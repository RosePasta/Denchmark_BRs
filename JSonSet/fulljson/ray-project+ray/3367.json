{"BR": {"BR_id": "3367", "BR_author": "dwilson1988", "BRopenT": "2018-11-20T22:41:44Z", "BRcloseT": "2018-11-24T06:51:09Z", "BR_text": {"BRsummary": "Using LSTM model raises ValueError with custom model", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n Ubuntu 16.04\n Ray installed from source\n Ray version 0.5.3\n Python version 3.6.6\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n Hello,\n I'm running into an issue. I have an environment that has a Dict observation_space with multiple components that get processes by a custom model (built with tensorflow). I wanted to stack this model with an LSTM afterwards, but I'm getting an error. The last two layers of my custom model look like:\n def _build_layers_v2(self,inputs, num_outputs, options):\n         ...\n         last_layer = slim.fully_connected(concatenated,256)\n         output = slim.linear(last_layer,num_outputs)\n         return output, last_layer\n So you can see my last layer has a size of [?,256]. This seems to be causing trouble when the LSTM is added:\n <denchmark-code>~/miniconda3/envs/rl/lib/python3.6/site-packages/ray/rllib/agents/ppo/ppo_policy_graph.py in __init__(self, observation_space, action_space, config, existing_inputs)\n     165             self.config[\"model\"],\n     166             state_in=existing_state_in,\n --> 167             seq_lens=existing_seq_lens)\n     168 \n     169         # KL Coefficient\n \n ~/miniconda3/envs/rl/lib/python3.6/site-packages/ray/rllib/models/catalog.py in get_model(input_dict, obs_space, num_outputs, options, state_in, seq_lens)\n     202             copy[\"obs\"] = model.last_layer\n     203             model = LSTM(copy, obs_space, num_outputs, options, state_in,\n --> 204                          seq_lens)\n     205 \n     206         logger.debug(\"Created model {}: ({} of {}, {}, {}) -> {}, {}\".format(\n \n ~/miniconda3/envs/rl/lib/python3.6/site-packages/ray/rllib/models/model.py in __init__(self, input_dict, obs_space, num_outputs, options, state_in, seq_lens)\n      69         try:\n      70             self.outputs, self.last_layer = self._build_layers_v2(\n ---> 71                 _restore_original_dimensions(input_dict, obs_space),\n      72                 num_outputs, options)\n      73         except NotImplementedError:\n \n ~/miniconda3/envs/rl/lib/python3.6/site-packages/ray/rllib/models/model.py in _restore_original_dimensions(input_dict, obs_space)\n     164         return dict(\n     165             input_dict,\n --> 166             obs=_unpack_obs(input_dict[\"obs\"], obs_space.original_space))\n     167     return input_dict\n     168 \n \n ~/miniconda3/envs/rl/lib/python3.6/site-packages/ray/rllib/models/model.py in _unpack_obs(obs, space)\n     175             raise ValueError(\n     176                 \"Expected flattened obs shape of [None, {}], got {}\".format(\n --> 177                     prep.shape[0], obs.shape))\n     178         assert len(prep.preprocessors) == len(space.spaces), \\\n     179             (len(prep.preprocessors) == len(space.spaces))\n \n ValueError: Expected flattened obs shape of [None, 589], got (?, 256)\n </denchmark-code>\n \n I believe this is happening because it's trying to flatten the observation tensor, but obviously since this is the last layer of my custom model, it's not of the dimensions of the observation space. The dimensionality of my observation space is 589, so I'm guessing that's why it's expecting that shape.\n <denchmark-code>config = {\n     'model': {\n         'custom_model': 'my_model',\n         'use_lstm': True,\n         'lstm_cell_size': 256    \n     },\n }\n </denchmark-code>\n \n Am I doing something wrong or is a bug? I'm using the latest from the repo at the moment. Should I be using the latest wheel instead? I need support for Dict spaces and not sure when that was added.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "dwilson1988", "commentT": "2018-11-20T23:06:56Z", "comment_text": "\n \t\tThanks for reporting this. <denchmark-link:https://github.com/dwilson1988>@dwilson1988</denchmark-link>\n  could you see if this fixes it? <denchmark-link:https://github.com/ray-project/ray/pull/3368>#3368</denchmark-link>\n \n Btw, the latest wheels are usually up-to-date with master.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "dwilson1988", "commentT": "2018-11-20T23:24:59Z", "comment_text": "\n \t\tThanks for the fast turn around! Tested and it appears to be working. I don't have everything fully functioning on my end, so I can't do an end to end test just yet, but that fixed my bug and I was able to create my agent.\n Also looked at the code and the implementation definitely makes sense to me. Thanks!\n \t\t"}}}, "commit": {"commit_id": "55fca828ce421b2c11014937a5e2b7d59828a53d", "commit_author": "Eric Liang", "commitT": "2018-11-23 22:51:08-08:00", "commit_complexity": {"commit_NLOC": "0.6666666666666666", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\rllib\\agents\\agent.py", "file_new_name": "python\\ray\\rllib\\agents\\agent.py", "file_complexity": {"file_NLOC": "334", "file_CCN": "67", "file_NToken": "1980"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "334", "deleted_lines": "334", "method_info": {"method_name": "_setup", "method_params": "self,config", "method_startline": "321", "method_endline": "344", "method_complexity": {"method_NLOC": "20", "method_CCN": "4", "method_NToken": "143", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\rllib\\models\\catalog.py", "file_new_name": "python\\ray\\rllib\\models\\catalog.py", "file_complexity": {"file_NLOC": "232", "file_CCN": "44", "file_NToken": "1501"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "203,204,205", "deleted_lines": "203"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "python\\ray\\rllib\\test\\test_nested_spaces.py", "file_new_name": "python\\ray\\rllib\\test\\test_nested_spaces.py", "file_complexity": {"file_NLOC": "214", "file_CCN": "28", "file_NToken": "1710"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "234,235", "deleted_lines": null, "method_info": {"method_name": "testNestedDictGymLSTM", "method_params": "self", "method_startline": "234", "method_endline": "235", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "20", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "177,187", "deleted_lines": "177", "method_info": {"method_name": "doTestNestedDict", "method_params": "self,make_env", "method_startline": "177", "method_endline": "202", "method_complexity": {"method_NLOC": "24", "method_CCN": "2", "method_NToken": "195", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "177,187", "deleted_lines": "177", "method_info": {"method_name": "doTestNestedDict", "method_params": "self,make_env,test_lstm", "method_startline": "177", "method_endline": "203", "method_complexity": {"method_NLOC": "25", "method_CCN": "2", "method_NToken": "203", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "test\\jenkins_tests\\multi_node_tests\\test_rllib_eval.sh", "file_new_name": "None", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\jenkins_tests\\run_multi_node_tests.sh", "file_new_name": "test\\jenkins_tests\\run_multi_node_tests.sh", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "237,238,239"}}}}}}