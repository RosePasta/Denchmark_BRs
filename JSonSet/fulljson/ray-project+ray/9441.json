{"BR": {"BR_id": "9441", "BR_author": "dsuess", "BRopenT": "2020-07-13T12:25:59Z", "BRcloseT": "2020-07-16T22:44:11Z", "BR_text": {"BRsummary": "[serve] Composed models with numpy arguments", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n I tried modifying the <denchmark-link:https://docs.ray.io/en/master/serve/advanced.html?highlight=pipeline#composing-multiple-models>composing multiple models</denchmark-link>\n  examples to pass a numpy array to another endpoint. However, I get the following error:\n <denchmark-code>2020-07-13 22:21:37,329 ERROR worker.py:987 -- Possible unhandled error from worker: ray::RayServeWorker_sum_model.handle_request() (pid=22037, ip=192.168.1.31)\n   File \"python/ray/_raylet.pyx\", line 410, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 424, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 1212, in ray._raylet.CoreWorker.run_async_func_in_event_loop\n   File \"/home/users/daniel/.local/conda/lib/python3.7/concurrent/futures/_base.py\", line 428, in result\n     return self.__get_result()\n   File \"/home/users/daniel/.local/conda/lib/python3.7/concurrent/futures/_base.py\", line 384, in __get_result\n     raise self._exception\n   File \"python/ray/_raylet.pyx\", line 422, in deserialize_args\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/serialization.py\", line 312, in deserialize_objects\n     self._deserialize_object(data, metadata, object_id))\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/serialization.py\", line 252, in _deserialize_object\n     return self._deserialize_msgpack_data(data, metadata)\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/serialization.py\", line 233, in _deserialize_msgpack_data\n     python_objects = self._deserialize_pickle5_data(pickle5_data)\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/serialization.py\", line 221, in _deserialize_pickle5_data\n     obj = pickle.loads(in_band)\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/serve/router.py\", line 53, in ray_deserialize\n     kwargs = pickle.loads(value)\n   File \"/home/users/daniel/.cache/pypoetry/virtualenvs/ray-test-mjIDN_hR-py3.7/lib/python3.7/site-packages/ray/cloudpickle/cloudpickle_fast.py\", line 448, in _numpy_frombuffer\n     array.setflags(write=isinstance(buffer, bytearray) or not buffer.readonly)\n AttributeError: 'bytes' object has no attribute 'readonly'\n </denchmark-code>\n \n Ray version: 0.8.6\n Python version: 3.7.7\n Numpy version: 1.19.0\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n <denchmark-code>import time\n from ray import serve\n import requests\n import numpy as np\n \n serve.init()\n \n \n def sum_model(_request, data=None):\n     return np.sum(data)\n \n \n class ComposedModel:\n     def __init__(self):\n         self.model = serve.get_handle(\"sum_model\")\n \n     async def __call__(self, _request):\n         data = np.ones((10, 10))\n         result = await self.model.remote(data=data)\n         return result\n \n \n \n serve.create_backend(\"sum_model\", sum_model)\n serve.create_endpoint(\"sum_model\", backend=\"sum_model\")\n serve.create_backend(\"model\", ComposedModel)\n serve.create_endpoint(\"model\", backend=\"model\", route=\"/model\", methods=['GET'])\n \n while True:\n     result = requests.get('http://127.0.0.1:8000/model')\n     print(result)\n     time.sleep(1)\n </denchmark-code>\n \n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "dsuess", "commentT": "2020-07-16T22:45:35Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/dsuess>@dsuess</denchmark-link>\n , this fix should be included nightly wheel tonight. Thanks for finding it. If you have any other concerns or suggestions about Serve, feel free to reach out to me on ray slack.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "dsuess", "commentT": "2020-07-16T23:25:57Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/simon-mo>@simon-mo</denchmark-link>\n . I'll give it a try\n \t\t"}}}, "commit": {"commit_id": "60a838f0f012af4f73ec3e59e5f55adffe4f8178", "commit_author": "Simon Mo", "commitT": "2020-07-16 15:44:10-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\serve\\BUILD", "file_new_name": "python\\ray\\serve\\BUILD", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "93,94,95,96,97,98,99,100", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\serve\\request_params.py", "file_new_name": "python\\ray\\serve\\request_params.py", "file_complexity": {"file_NLOC": "43", "file_CCN": "5", "file_NToken": "148"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "45", "deleted_lines": "45", "method_info": {"method_name": "ray_serialize", "method_params": "self", "method_startline": "44", "method_endline": "45", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\serve\\router.py", "file_new_name": "python\\ray\\serve\\router.py", "file_complexity": {"file_NLOC": "247", "file_CCN": "50", "file_NToken": "1634"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "53", "deleted_lines": "53", "method_info": {"method_name": "ray_serialize", "method_params": "self", "method_startline": "45", "method_endline": "53", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "28", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "python\\ray\\serve\\tests\\test_regression.py", "file_complexity": {"file_NLOC": "25", "file_CCN": "4", "file_NToken": "184"}}}}}