{"BR": {"BR_id": "2027", "BR_author": "pschafhalter", "BRopenT": "2018-05-10T01:45:24Z", "BRcloseT": "2018-05-18T19:23:33Z", "BR_text": {"BRsummary": "[DataFrame] calling __delitem__ on the last column errors", "BRdescription": "\n This bug affects calling __setitem__ on the last column as well.\n Code that causes the bug:\n df = rdf.DataFrame({\"col1\": lrange(3), \"col2\": lrange(3)})\n del df[\"col2\"]\n Output:\n <denchmark-code>Remote function ray.dataframe.utils._deploy_func failed with:\n \n Traceback (most recent call last):\n   File \"/home/peter/workspace/ray/python/ray/dataframe/utils.py\", line 132, in _deploy_func\n     return func(dataframe, *args)\n   File \"/home/peter/workspace/ray/python/ray/dataframe/dataframe.py\", line 4728, in del_helper\n     cols = df.columns[to_delete]  # either int or an array of ints\n   File \"/home/peter/workspace/ray_env/lib/python3.6/site-packages/pandas/core/indexes/range.py\", line 544, in __getitem__\n     return super_getitem(key)\n   File \"/home/peter/workspace/ray_env/lib/python3.6/site-packages/pandas/core/indexes/base.py\", line 1754, in __getitem__\n     result = getitem(key)\n IndexError: index 0 is out of bounds for axis 1 with size 0\n \n \n   You can inspect errors by running\n \n       ray.error_info()\n \n   If this driver is hanging, start a new one with\n \n       ray.init(redis_address=\"192.168.0.114:49682\")\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "pschafhalter", "commentT": "2018-05-15T21:05:59Z", "comment_text": "\n \t\t<denchmark-h:h2>Issue</denchmark-h>\n \n The issue is we had redundancy in calls, inside `delitem, we called:\n         self._row_partitions = _map_partitions(\n             del_helper, self._row_partitions, to_delete)\n and then we called:\n             self._col_partitions[i] = _deploy_func.remote(\n                 del_helper, self._col_partitions[i], to_delete_in_partition)\n because we already deleted the data, the column deletion won't succeed.\n The implementation note in docstring states:\n <denchmark-code>Notes: This operation happen on row and column partition\n                   simultaneously. No rebuild.\n </denchmark-code>\n \n but setting row_partitions and col_partitions automatically \"rebuild\" the block paritions via _create_block_partitions.\n <denchmark-h:h2>Fix</denchmark-h>\n \n The fix is simply\n \n Just perform the __delitem__ in one of the row/col partition scheme\n Leave the col_metadata reset computation as-is.\n \n <denchmark-h:h2>Question</denchmark-h>\n \n I would go with fixing it by removing the row_parititions schemes because:\n \n col_paritions should be generally faster and memory efficient than row_parititions because\n - row_partitions create intermediate \"copy\" of each row\n - col_partitions, with some tweaks, need only touch the part of columns that need to be deleted without memory overhead\n \n <denchmark-link:https://github.com/devin-petersohn>@devin-petersohn</denchmark-link>\n  <denchmark-link:https://github.com/pschafhalter>@pschafhalter</denchmark-link>\n  comments?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "pschafhalter", "commentT": "2018-05-15T23:02:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/simon-mo>@simon-mo</denchmark-link>\n  Using  makes sense to me in terms of correctness. I think we might be able to improve performance even more if   modifies  directly, using  to find the blocks that we need to modify.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "pschafhalter", "commentT": "2018-05-16T07:52:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/pschafhalter>@pschafhalter</denchmark-link>\n  Good point. I'll go head and refactor  to use block partitions.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "pschafhalter", "commentT": "2018-05-16T19:40:50Z", "comment_text": "\n \t\tThanks for looking into this <denchmark-link:https://github.com/simon-mo>@simon-mo</denchmark-link>\n ! Modifying  is the most efficient. Additionally, is it possible to remove empty ? It may not be worth it considering we don't expose the partitioning to the user, and managing everything ourselves we can get away without some of this cleanup.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "pschafhalter", "commentT": "2018-05-16T21:11:52Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/devin-petersohn>@devin-petersohn</denchmark-link>\n \n Yes we can do that. The logic will simply be: if removing this column will create empty block, just pop this column in the  array, and modify .\n One caveat is that I might need to make a copy of our block partition ObjectID array, given that delete the item in original won't affect \"view\":\n <denchmark-code>In [4]: df_view = df.iloc[1:,:]\n \n In [5]: df\n Out[5]:\n    a  b\n 0  1  2\n 1  1  2\n 2  1  2\n 3  1  2\n \n In [6]: del df['b']\n \n In [7]: df_view\n Out[7]:\n    a  b\n 1  1  2\n 2  1  2\n 3  1  2\n \n In [8]: df\n Out[8]:\n    a\n 0  1\n 1  1\n 2  1\n 3  1\n </denchmark-code>\n \n basically, I need to think about how to decouple the view and the original in this situation. But it's doable.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "pschafhalter", "commentT": "2018-05-16T21:24:55Z", "comment_text": "\n \t\tFor this pass, let's just focus on fixing the bug. There are other methods that will be affected by this, and we should probably do this with all of them at the same time.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "pschafhalter", "commentT": "2018-05-18T19:23:33Z", "comment_text": "\n \t\tResolved with <denchmark-link:https://github.com/ray-project/ray/pull/2080>#2080</denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "pschafhalter", "commentT": "2018-05-19T07:56:01Z", "comment_text": "\n \t\tI'm encountering the same issue on __getitem__\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "pschafhalter", "commentT": "2018-05-19T08:08:02Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kunalgosar>@kunalgosar</denchmark-link>\n  can you post a code snippet that can reproduce your issue? I can't reproduce it right now\n \t\t"}}}, "commit": {"commit_id": "0b07602c89cdf89b5a7ba423e8fc7ab1ba74f172", "commit_author": "Simon Mo", "commitT": "2018-05-18 08:58:20-10:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.3333333333333333"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\dataframe\\dataframe.py", "file_new_name": "python\\ray\\dataframe\\dataframe.py", "file_complexity": {"file_NLOC": "3103", "file_CCN": "599", "file_NToken": "24052"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "4919,4921,4927,4928,4929,4930", "deleted_lines": "4907,4908,4909,4910,4923,4930,4931", "method_info": {"method_name": "__delitem__", "method_params": "self,key", "method_startline": "4884", "method_endline": "4932", "method_complexity": {"method_NLOC": "16", "method_CCN": "4", "method_NToken": "135", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "python\\ray\\dataframe\\index_metadata.py", "file_new_name": "python\\ray\\dataframe\\index_metadata.py", "file_complexity": {"file_NLOC": "201", "file_CCN": "46", "file_NToken": "1472"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "360,361,362,363,364,365,366,367", "deleted_lines": "360", "method_info": {"method_name": "drop", "method_params": "self,labels,errors", "method_startline": "344", "method_endline": "378", "method_complexity": {"method_NLOC": "20", "method_CCN": "4", "method_NToken": "177", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "206,207,213,214", "deleted_lines": "206,207,213,214", "method_info": {"method_name": "reset_partition_coords", "method_params": "self,partitions", "method_startline": "196", "method_endline": "214", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "100", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\dataframe\\test\\test_dataframe.py", "file_new_name": "python\\ray\\dataframe\\test\\test_dataframe.py", "file_complexity": {"file_NLOC": "2357", "file_CCN": "333", "file_NToken": "20211"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "3277,3278,3279,3280,3281", "deleted_lines": null, "method_info": {"method_name": "test___delitem__", "method_params": "ray_df,pd_df", "method_startline": "3270", "method_endline": "3281", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "70", "method_nesting_level": "0"}}}}}}}}