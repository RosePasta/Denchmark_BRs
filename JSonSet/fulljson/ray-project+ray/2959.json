{"BR": {"BR_id": "2959", "BR_author": "stephanie-wang", "BRopenT": "2018-09-25T19:30:11Z", "BRcloseT": "2018-11-07T05:25:21Z", "BR_text": {"BRsummary": "[xray] `ObjectDirectory` fires callbacks in the same function", "BRdescription": "\n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n Many of the  methods (<denchmark-link:https://github.com/ray-project/ray/blob/master/src/ray/object_manager/object_directory.cc#L158>example</denchmark-link>\n ) take in a callback as an argument. This is natural since the operation to the GCS is asynchronous. However, the callback often gets called , which makes it easy to do bad things like invalidate an iterator in the caller. This happens even when the operation is synchronous (<denchmark-link:https://github.com/ray-project/ray/blob/master/src/ray/object_manager/object_directory.cc#L115>example</denchmark-link>\n ).\n We should modify this to make sure that callbacks are always fired as a separate handler. We should also make sure that callbacks are only passed in where necessary.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "stephanie-wang", "commentT": "2018-11-07T05:25:21Z", "comment_text": "\n \t\tClosed by <denchmark-link:https://github.com/ray-project/ray/pull/3227>#3227</denchmark-link>\n .\n \t\t"}}}, "commit": {"commit_id": "ca585703b260e678de187c47e863ed1822b92e46", "commit_author": "Stephanie Wang", "commitT": "2018-11-06 20:33:10-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.5882352941176471", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\client_test.cc", "file_new_name": "src\\ray\\gcs\\client_test.cc", "file_complexity": {"file_NLOC": "526", "file_CCN": "64", "file_NToken": "4590"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "651,652", "deleted_lines": "651", "method_info": {"method_name": "ray::gcs::ClientTableNotification", "method_params": "client,client_id,data,is_insertion", "method_startline": "643", "method_endline": "655", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "119", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\gcs\\tables.cc", "file_new_name": "src\\ray\\gcs\\tables.cc", "file_complexity": {"file_NLOC": "380", "file_CCN": "64", "file_NToken": "3095"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "424,425,429,431", "deleted_lines": "424,428,430,431,432", "method_info": {"method_name": "ray::gcs::ClientTable::GetClient", "method_params": "client_id", "method_startline": "424", "method_endline": "434", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "64", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "424,425,429,431", "deleted_lines": "424,428,430,431,432", "method_info": {"method_name": "ray::gcs::ClientTable::GetClient", "method_params": "client_id,client_info", "method_startline": "424", "method_endline": "433", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "71", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\tables.h", "file_new_name": "src\\ray\\gcs\\tables.h", "file_complexity": {"file_NLOC": "286", "file_CCN": "23", "file_NToken": "2212"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "520,521,522,523,524,525", "method_info": {"method_name": "ray::gcs::ClientTable::ClientTable", "method_params": "contexts,client,client_id", "method_startline": "506", "method_endline": "526", "method_complexity": {"method_NLOC": "14", "method_CCN": "1", "method_NToken": "108", "method_nesting_level": "3"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 9, "file_old_name": "src\\ray\\object_manager\\object_directory.cc", "file_new_name": "src\\ray\\object_manager\\object_directory.cc", "file_complexity": {"file_NLOC": "149", "file_CCN": "25", "file_NToken": "1171"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "5,6,7", "deleted_lines": "5,6", "method_info": {"method_name": "ray::ObjectDirectory::ObjectDirectory", "method_params": "io_service,gcs_client", "method_startline": "5", "method_endline": "7", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "35", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "188,189", "deleted_lines": null, "method_info": {"method_name": "ray::ObjectDirectory::LookupLocations", "method_params": "object_id,callback", "method_startline": "177", "method_endline": "193", "method_complexity": {"method_NLOC": "14", "method_CCN": "1", "method_NToken": "112", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "65,66", "deleted_lines": null, "method_info": {"method_name": "ray::ObjectDirectory::RegisterBackend", "method_params": "", "method_startline": "43", "method_endline": "73", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "148", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "122,123,126,127,128,129,130,133", "deleted_lines": "121,122,125,126,127,128,129,130,131,132,133,134", "method_info": {"method_name": "ray::ObjectDirectory::RunFunctionForEachClient", "method_params": "client_function", "method_startline": "121", "method_endline": "137", "method_complexity": {"method_NLOC": "17", "method_CCN": "5", "method_NToken": "115", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "108,109,110,111,112,113,114,115,116,117,118", "deleted_lines": "105,106,107,108,109,110,111,112,113,114,115,116,118", "method_info": {"method_name": "ray::ObjectDirectory::GetInformation", "method_params": "client_id,success_callback,fail_callback", "method_startline": "105", "method_endline": "119", "method_complexity": {"method_NLOC": "15", "method_CCN": "3", "method_NToken": "111", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "122,123,126,127,128,129,130,133", "deleted_lines": "122,125,126,127,128,129,130,131,132,133,134", "method_info": {"method_name": "ray::ObjectDirectory::LookupAllRemoteConnections", "method_params": "", "method_startline": "122", "method_endline": "134", "method_complexity": {"method_NLOC": "13", "method_CCN": "4", "method_NToken": "89", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "156,157", "deleted_lines": "159", "method_info": {"method_name": "ray::ObjectDirectory::SubscribeObjectLocations", "method_params": "callback_id,object_id,callback", "method_startline": "136", "method_endline": "159", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "191", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "5,6", "deleted_lines": "5,6", "method_info": {"method_name": "ray::ObjectDirectory::ObjectDirectory", "method_params": "gcs_client", "method_startline": "5", "method_endline": "6", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "108,109,110,111,112,113,114,115,116,117,118", "deleted_lines": "108,109,110,111,112,113,114,115,116,118", "method_info": {"method_name": "ray::ObjectDirectory::LookupRemoteConnectionInfo", "method_params": "connection_info", "method_startline": "108", "method_endline": "120", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "91", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "src\\ray\\object_manager\\object_directory.h", "file_new_name": "src\\ray\\object_manager\\object_directory.h", "file_complexity": {"file_NLOC": "71", "file_CCN": "4", "file_NToken": "485"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "20,21,22", "deleted_lines": "20,21,22", "method_info": {"method_name": "ray::RemoteConnectionInfo::RemoteConnectionInfo", "method_params": "id,ip_address,port_num", "method_startline": "20", "method_endline": "22", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "19", "deleted_lines": "19", "method_info": {"method_name": "ray::RemoteConnectionInfo::RemoteConnectionInfo", "method_params": "id", "method_startline": "19", "method_endline": "19", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "32", "deleted_lines": "32", "method_info": {"method_name": "ray::ObjectDirectoryInterface::~ObjectDirectoryInterface", "method_params": "", "method_startline": "32", "method_endline": "32", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "5", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "23", "deleted_lines": null, "method_info": {"method_name": "ray::RemoteConnectionInfo::Connected", "method_params": "", "method_startline": "23", "method_endline": "23", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "120", "deleted_lines": null, "method_info": {"method_name": "ray::ObjectDirectory::~ObjectDirectory", "method_params": "", "method_startline": "120", "method_endline": "120", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "5", "method_nesting_level": "2"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "src\\ray\\object_manager\\object_manager.cc", "file_new_name": "src\\ray\\object_manager\\object_manager.cc", "file_complexity": {"file_NLOC": "637", "file_CCN": "116", "file_NToken": "4987"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "386,387,388,389,390,391", "deleted_lines": "373,374,375,376,377,392,393", "method_info": {"method_name": "ray::ObjectManager::ExecuteSendObject", "method_params": "client_id,object_id,data_size,metadata_size,chunk_index,connection_info", "method_startline": "373", "method_endline": "393", "method_complexity": {"method_NLOC": "20", "method_CCN": "4", "method_NToken": "144", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "266,267,269,270,271,272,273,274,275,276,277,278,279", "deleted_lines": "267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282", "method_info": {"method_name": "ray::ObjectManager::PullEstablishConnection", "method_params": "object_id,client_id", "method_startline": "258", "method_endline": "282", "method_complexity": {"method_NLOC": "19", "method_CCN": "4", "method_NToken": "115", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646", "deleted_lines": "646,648,649", "method_info": {"method_name": "ray::ObjectManager::CreateSenderConnection", "method_params": "type,info", "method_startline": "625", "method_endline": "649", "method_complexity": {"method_NLOC": "19", "method_CCN": "2", "method_NToken": "153", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "800,801,802,810,811,812,813,814,815,816,817,818,820", "deleted_lines": "811,818,819,821", "method_info": {"method_name": "ray::ObjectManager::SpreadFreeObjectRequest", "method_params": "object_ids", "method_startline": "794", "method_endline": "821", "method_complexity": {"method_NLOC": "24", "method_CCN": "5", "method_NToken": "185", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "539,540,541,542,543,544,545,568,569,570,571", "deleted_lines": "548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564", "method_info": {"method_name": "ray::ObjectManager::SubscribeRemainingWaitObjects", "method_params": "wait_id", "method_startline": "533", "method_endline": "591", "method_complexity": {"method_NLOC": "44", "method_CCN": "10", "method_NToken": "326", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "26", "deleted_lines": "26", "method_info": {"method_name": "ray::ObjectManager::ObjectManager", "method_params": "main_service,config,gcs_client", "method_startline": "20", "method_endline": "45", "method_complexity": {"method_NLOC": "23", "method_CCN": "1", "method_NToken": "171", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370", "deleted_lines": "350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371", "method_info": {"method_name": "ray::ObjectManager::Push", "method_params": "object_id,client_id", "method_startline": "314", "method_endline": "371", "method_complexity": {"method_NLOC": "45", "method_CCN": "9", "method_NToken": "348", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\object_manager\\test\\object_manager_stress_test.cc", "file_new_name": "src\\ray\\object_manager\\test\\object_manager_stress_test.cc", "file_complexity": {"file_NLOC": "393", "file_CCN": "58", "file_NToken": "3077"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "436,437,441,442", "deleted_lines": "436,440", "method_info": {"method_name": "ray::StressTestObjectManager::TestConnections", "method_params": "", "method_startline": "424", "method_endline": "446", "method_complexity": {"method_NLOC": "22", "method_CCN": "1", "method_NToken": "191", "method_nesting_level": "2"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\object_manager\\test\\object_manager_test.cc", "file_new_name": "src\\ray\\object_manager\\test\\object_manager_test.cc", "file_complexity": {"file_NLOC": "383", "file_CCN": "54", "file_NToken": "2996"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "450,451,457,458", "deleted_lines": "450,456", "method_info": {"method_name": "ray::TestObjectManager::TestConnections", "method_params": "", "method_startline": "446", "method_endline": "463", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "190", "method_nesting_level": "2"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "file_complexity": {"file_NLOC": "1061", "file_CCN": "156", "file_NToken": "8508"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1559,1560", "method_info": {"method_name": "ray::raylet::NodeManager::ForwardTask", "method_params": "task,node_id,on_error", "method_startline": "1539", "method_endline": "1613", "method_complexity": {"method_NLOC": "49", "method_CCN": "8", "method_NToken": "409", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "308,309,313", "deleted_lines": "307,309,310,314", "method_info": {"method_name": "ray::raylet::NodeManager::ClientAdded", "method_params": "client_data", "method_startline": "283", "method_endline": "333", "method_complexity": {"method_NLOC": "35", "method_CCN": "4", "method_NToken": "273", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "64", "deleted_lines": "64", "method_info": {"method_name": "ray::raylet::NodeManager::NodeManager", "method_params": "io_service,config,object_manager,gcs_client", "method_startline": "45", "method_endline": "92", "method_complexity": {"method_NLOC": "45", "method_CCN": "1", "method_NToken": "378", "method_nesting_level": "2"}}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\object_manager_integration_test.cc", "file_new_name": "src\\ray\\raylet\\object_manager_integration_test.cc", "file_complexity": {"file_NLOC": "195", "file_CCN": "23", "file_NToken": "1593"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "207,208,213,214", "deleted_lines": "207,212", "method_info": {"method_name": "ray::raylet::TestObjectManagerIntegration::TestConnections", "method_params": "", "method_startline": "195", "method_endline": "218", "method_complexity": {"method_NLOC": "23", "method_CCN": "1", "method_NToken": "224", "method_nesting_level": "3"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\reconstruction_policy_test.cc", "file_new_name": "src\\ray\\raylet\\reconstruction_policy_test.cc", "file_complexity": {"file_NLOC": "286", "file_CCN": "31", "file_NToken": "2205"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "40,41", "deleted_lines": "40,41,51"}}}}}}