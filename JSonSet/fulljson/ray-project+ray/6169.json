{"BR": {"BR_id": "6169", "BR_author": "virtualluke", "BRopenT": "2019-11-15T19:29:20Z", "BRcloseT": "2019-11-25T16:11:57Z", "BR_text": {"BRsummary": "workers dying in redis_context.cc", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Redhat 7.6\n Ray installed from (source or binary): binary\n Ray version: 0.8.0dev6 (last commit 8ff393a)\n Python version: 3.7.5\n Exact command to reproduce:\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n I am seeing workers dying (infrequently but often enough) with logs like the below.\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n <denchmark-code>2019-11-15 13:44:10,711 WARNING worker.py:1037 -- A worker died or was killed while executing task e36ba8830369ffffffff01000000.\n 2019-11-15 13:44:13,899 WARNING worker.py:1037 -- A worker died or was killed while executing task 003e8a4c5672ffffffff01000000.\n 2019-11-15 13:44:15,736 WARNING worker.py:1037 -- A worker died or was killed while executing task 55310ff8d7c0ffffffff01000000.\n 2019-11-15 13:44:17,359 WARNING worker.py:1037 -- A worker died or was killed while executing task 2fd423cb8a75ffffffff01000000.\n 2019-11-15 13:44:17,741 WARNING worker.py:1037 -- A worker died or was killed while executing task 361d66d76ed7ffffffff01000000.\n (pid=194534, ip=10.10.10.123) F1115 13:44:10.645040 201070 redis_context.cc:147]  Check failed: callback_items_.find(callback_index) != callback_items_.end()\n (pid=194534, ip=10.10.10.123) *** Check failure stack trace: ***\n (pid=194534, ip=10.10.10.123)     @     0x7fbed39f148d  google::LogMessage::Fail()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed39f31ac  google::LogMessage::SendToLog()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed39f0fe9  google::LogMessage::Flush()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed39f1201  google::LogMessage::~LogMessage()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed37383b9  ray::RayLog::~RayLog()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed36e5591  ray::gcs::RedisCallbackManager::get()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed36e56bd  ray::gcs::GlobalRedisCallback()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed36eb3da  redisProcessCallbacks\n (pid=194534, ip=10.10.10.123)     @     0x7fbed36e9f88  RedisAsioClient::handle_read()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed36e8967  boost::asio::detail::reactive_null_buffers_op<>::do_complete()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed3647345  boost::asio::detail::scheduler::run()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed364ae53  ray::CoreWorker::RunIOService()\n (pid=194534, ip=10.10.10.123)     @     0x7fbed3218678  execute_native_thread_routine_compat\n (pid=194534, ip=10.10.10.123)     @     0x7fbedb05eea5  start_thread\n (pid=194534, ip=10.10.10.123)     @     0x7fbedad878cd  __clone\n ...\n </denchmark-code>\n \n ...\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "virtualluke", "commentT": "2019-11-20T18:22:16Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/virtualluke>@virtualluke</denchmark-link>\n  <denchmark-link:https://github.com/ray-project/ray/pull/5946>#5946</denchmark-link>\n  merged above should hopefully address your issue. Please let me know once you've have a chance to test it out.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "virtualluke", "commentT": "2019-11-20T18:28:17Z", "comment_text": "\n \t\tWill pull it down in a few hours (if whl has dropped)  and do some testing after that.  thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "virtualluke", "commentT": "2019-11-21T05:32:33Z", "comment_text": "\n \t\tIssue still there\n \t\t"}}}, "commit": {"commit_id": "ae5abc48a96a849b1b9acec665bd0aa74fe49591", "commit_author": "Edward Oakes", "commitT": "2019-11-22 15:51:40-08:00", "commit_complexity": {"commit_NLOC": "0.06666666666666667", "commit_CCN": "0.0", "commit_Nprams": "0.2"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\redis_async_context.cc", "file_new_name": "src\\ray\\gcs\\redis_async_context.cc", "file_complexity": {"file_NLOC": "64", "file_CCN": "11", "file_NToken": "351"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "34,35,36,37,38,39", "deleted_lines": "34", "method_info": {"method_name": "ray::gcs::RedisAsyncContext::RedisAsyncHandleRead", "method_params": "", "method_startline": "33", "method_endline": "41", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 14, "file_old_name": "src\\ray\\gcs\\redis_context.cc", "file_new_name": "src\\ray\\gcs\\redis_context.cc", "file_complexity": {"file_NLOC": "240", "file_CCN": "43", "file_NToken": "1727"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "100", "deleted_lines": "100", "method_info": {"method_name": "ray::gcs::CallbackReply::IsNil", "method_params": "", "method_startline": "100", "method_endline": "100", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "108,109", "deleted_lines": "107,108,109,110", "method_info": {"method_name": "ray::gcs::CallbackReply::ReadAsStatus", "method_params": "", "method_startline": "107", "method_endline": "110", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "134,135,139,140,141", "deleted_lines": "136,140,141", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::add", "method_params": "function,is_subscription,io_service", "method_startline": "134", "method_endline": "143", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "73", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97", "deleted_lines": "49,51,52,53,56,59,60,61,62,63,64,65,66,67,71,72,73,74,75,76,77,78,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98", "method_info": {"method_name": "ray::gcs::CallbackReply::CallbackReply", "method_params": "redis_reply", "method_startline": "49", "method_endline": "98", "method_complexity": {"method_NLOC": "44", "method_CCN": "10", "method_NToken": "271", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "112,113,114", "deleted_lines": "112,113,114,115", "method_info": {"method_name": "ray::gcs::CallbackReply::ReadAsString", "method_params": "", "method_startline": "112", "method_endline": "115", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "139,140,141", "deleted_lines": "136,140,141", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::add", "method_params": "function,is_subscription", "method_startline": "136", "method_endline": "143", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "58", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "145,146", "deleted_lines": "145", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::get", "method_params": "callback_index", "method_startline": "145", "method_endline": "150", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "44", "method_nesting_level": "2"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "24,28,31,33,34,35,36,37", "deleted_lines": "24,28,31,33,34,35,36,37", "method_info": {"method_name": "ProcessCallback", "method_params": "callback_index,callback_reply", "method_startline": "23", "method_endline": "41", "method_complexity": {"method_NLOC": "14", "method_CCN": "3", "method_NToken": "121", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "104,108,109,112,113,114,117,118,119", "deleted_lines": "104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121", "method_info": {"method_name": "ray::gcs::CallbackReply::ReadAsStringArray", "method_params": "array", "method_startline": "104", "method_endline": "122", "method_complexity": {"method_NLOC": "17", "method_CCN": "4", "method_NToken": "174", "method_nesting_level": "2"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "24,28,31,33,34,35,36,37", "deleted_lines": "24,28,31,33,34,35,36,37", "method_info": {"method_name": "ProcessCallback", "method_params": "callback_index,callback_reply", "method_startline": "23", "method_endline": "41", "method_complexity": {"method_NLOC": "16", "method_CCN": "4", "method_NToken": "128", "method_nesting_level": "1"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "131", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::GlobalRedisCallback", "method_params": "c,r,privdata", "method_startline": "125", "method_endline": "132", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "65", "method_nesting_level": "2"}}}, "hunk_11": {"Ismethod": 1, "added_lines": "284,285", "deleted_lines": "283", "method_info": {"method_name": "ray::gcs::RedisContext::SubscribeAsync", "method_params": "client_id,pubsub_channel,redisCallback,out_callback_index", "method_startline": "276", "method_endline": "305", "method_complexity": {"method_NLOC": "26", "method_CCN": "2", "method_NToken": "190", "method_nesting_level": "2"}}}, "hunk_12": {"Ismethod": 1, "added_lines": "103,104", "deleted_lines": "104,105", "method_info": {"method_name": "ray::gcs::CallbackReply::ReadAsInteger", "method_params": "", "method_startline": "102", "method_endline": "105", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "2"}}}, "hunk_13": {"Ismethod": 1, "added_lines": "117,118,119", "deleted_lines": "117,118,119,120", "method_info": {"method_name": "ray::gcs::CallbackReply::ReadAsPubsubData", "method_params": "", "method_startline": "117", "method_endline": "120", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "src\\ray\\gcs\\redis_context.h", "file_new_name": "src\\ray\\gcs\\redis_context.h", "file_complexity": {"file_NLOC": "143", "file_CCN": "13", "file_NToken": "912"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "86", "deleted_lines": "82,83,84,85,86", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::CallbackItem::CallbackItem", "method_params": "callback,is_subscription,start_time", "method_startline": "82", "method_endline": "87", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "33", "method_nesting_level": "4"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "114", "method_info": {"method_name": "ray::gcs::RedisContext::RedisContext", "method_params": "", "method_startline": "114", "method_endline": "114", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "130,131", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::RedisContext::RedisContext", "method_params": "io_service", "method_startline": "130", "method_endline": "131", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "3"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "96,97,98,99,100", "deleted_lines": "96", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::CallbackItem::Dispatch", "method_params": "reply", "method_startline": "96", "method_endline": "101", "method_complexity": {"method_NLOC": "6", "method_CCN": "2", "method_NToken": "60", "method_nesting_level": "4"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "89,90,91,92,93,94", "deleted_lines": "89,90,91,94", "method_info": {"method_name": "ray::gcs::RedisCallbackManager::CallbackItem::CallbackItem", "method_params": "callback,is_subscription,start_time,io_service", "method_startline": "89", "method_endline": "94", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "43", "method_nesting_level": "4"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "202,203", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::RedisContext::RunAsync", "method_params": "command,id,data,length,prefix,pubsub_channel,redisCallback,log_length", "method_startline": "197", "method_endline": "228", "method_complexity": {"method_NLOC": "32", "method_CCN": "3", "method_NToken": "286", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\redis_gcs_client.cc", "file_new_name": "src\\ray\\gcs\\redis_gcs_client.cc", "file_complexity": {"file_NLOC": "163", "file_CCN": "30", "file_NToken": "1377"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "86,106,111", "deleted_lines": "86,106,111", "method_info": {"method_name": "ray::gcs::RedisGcsClient::Connect", "method_params": "io_service", "method_startline": "78", "method_endline": "149", "method_complexity": {"method_NLOC": "51", "method_CCN": "5", "method_NToken": "512", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 13, "file_old_name": "src\\ray\\gcs\\tables.cc", "file_new_name": "src\\ray\\gcs\\tables.cc", "file_complexity": {"file_NLOC": "656", "file_CCN": "109", "file_NToken": "5543"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "379,380", "deleted_lines": "379", "method_info": {"method_name": "ray::gcs::Hash<ID,Data>::RemoveEntries", "method_params": "job_id,id,keys,remove_callback", "method_startline": "375", "method_endline": "394", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "172", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "68,69", "deleted_lines": "68,69", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::AppendAt", "method_params": "job_id,id,data,done,failure,log_length", "method_startline": "63", "method_endline": "84", "method_complexity": {"method_NLOC": "22", "method_CCN": "4", "method_NToken": "188", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "438,439", "deleted_lines": "437,438", "method_info": {"method_name": "ray::gcs::Hash<ID,Data>::Subscribe", "method_params": "job_id,client_id,subscribe,done", "method_startline": "433", "method_endline": "478", "method_complexity": {"method_NLOC": "41", "method_CCN": "8", "method_NToken": "323", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "195,196", "deleted_lines": "195,196", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::CancelNotifications", "method_params": "job_id,id,client_id,done", "method_startline": "187", "method_endline": "204", "method_complexity": {"method_NLOC": "16", "method_CCN": "2", "method_NToken": "117", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "89,92,94", "deleted_lines": "89,92,94", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::Lookup", "method_params": "job_id,id,lookup", "method_startline": "87", "method_endline": "108", "method_complexity": {"method_NLOC": "22", "method_CCN": "4", "method_NToken": "208", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "129,130", "deleted_lines": "129,130", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::Subscribe", "method_params": "job_id,client_id,subscribe,done", "method_startline": "124", "method_endline": "162", "method_complexity": {"method_NLOC": "33", "method_CCN": "6", "method_NToken": "240", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "257", "deleted_lines": "257", "method_info": {"method_name": "ray::gcs::Table<ID,Data>::Add", "method_params": "job_id,id,data,done", "method_startline": "253", "method_endline": "266", "method_complexity": {"method_NLOC": "14", "method_CCN": "2", "method_NToken": "133", "method_nesting_level": "2"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "173,174", "deleted_lines": "173,174", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::RequestNotifications", "method_params": "job_id,id,client_id,done", "method_startline": "165", "method_endline": "184", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "130", "method_nesting_level": "2"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "320", "deleted_lines": "320", "method_info": {"method_name": "ray::gcs::Set<ID,Data>::Add", "method_params": "job_id,id,data,done", "method_startline": "317", "method_endline": "328", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "130", "method_nesting_level": "2"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "335", "deleted_lines": "335", "method_info": {"method_name": "ray::gcs::Set<ID,Data>::Remove", "method_params": "job_id,id,data,done", "method_startline": "331", "method_endline": "343", "method_complexity": {"method_NLOC": "13", "method_CCN": "2", "method_NToken": "130", "method_nesting_level": "2"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "408,411,412,414", "deleted_lines": "407,410,411,413", "method_info": {"method_name": "ray::gcs::Hash<ID,Data>::Lookup", "method_params": "job_id,id,lookup", "method_startline": "405", "method_endline": "430", "method_complexity": {"method_NLOC": "26", "method_CCN": "4", "method_NToken": "253", "method_nesting_level": "2"}}}, "hunk_11": {"Ismethod": 1, "added_lines": "47,48", "deleted_lines": "47,48", "method_info": {"method_name": "ray::gcs::Log<ID,Data>::Append", "method_params": "job_id,id,data,done", "method_startline": "43", "method_endline": "60", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "162", "method_nesting_level": "2"}}}, "hunk_12": {"Ismethod": 1, "added_lines": "357", "deleted_lines": "357", "method_info": {"method_name": "ray::gcs::Hash<ID,Data>::Update", "method_params": "job_id,id,data_map,done", "method_startline": "354", "method_endline": "372", "method_complexity": {"method_NLOC": "19", "method_CCN": "3", "method_NToken": "180", "method_nesting_level": "2"}}}}}}}}