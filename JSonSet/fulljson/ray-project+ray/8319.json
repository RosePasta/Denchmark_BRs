{"BR": {"BR_id": "8319", "BR_author": "ericl", "BRopenT": "2020-05-05T00:09:39Z", "BRcloseT": "2020-05-08T06:26:32Z", "BR_text": {"BRsummary": "[rllib] Vectorization & multi-agent are broken in DDPG (both TF and Torch)", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n ./train.py --run=DDPG --env=MountainCarContinuous-v0 --config='{\"num_envs_per_worker\": 2}'\n and\n ./train.py --run=DDPG --env=MountainCarContinuous-v0 --config='{\"num_envs_per_worker\": 2}' --torch\n both currently crash. The issue seems to be that while the input to compute_actions() is a batch of N observations, only 1 action is returned as output. I ran into this while debugging a hang in a multi-agent test case (hung due to a bug in the env triggered by vectorization returning 1 action instead of N actions).\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ericl", "commentT": "2020-05-05T00:48:34Z", "comment_text": "\n \t\tgit bisect run script.sh\n script:\n <denchmark-code>cd python\n sudo SKIP_THIRDPARTY_INSTALL=1 SKIP_PYARROW_INSTALL=1 python setup.py develop\n cd -\n cd rllib\n ./train.py --run=DDPG --env=MountainCarContinuous-v0 --config='{\"num_envs_per_worker\": 2}' --stop='{\"timesteps_total\": 1}'\n </denchmark-code>\n \n <denchmark-code>83e06cd30a45245c2cb0e9f4bd924224b1581554 is the first bad commit\n commit 83e06cd30a45245c2cb0e9f4bd924224b1581554\n Author: Sven Mika <sven@anyscale.io>\n Date:   Sun Mar 1 20:53:35 2020 +0100\n \n     [RLlib] DDPG refactor and Exploration API action noise classes. (#7314)\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ericl", "commentT": "2020-05-05T00:48:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/sven1977>@sven1977</denchmark-link>\n  probably some trivial bug in the new ddpg pol that breaks batching\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ericl", "commentT": "2020-05-05T06:14:34Z", "comment_text": "\n \t\tTaking a look ...\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ericl", "commentT": "2020-05-05T09:30:04Z", "comment_text": "\n \t\tGot it, will PR today ...\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ericl", "commentT": "2020-05-05T13:11:04Z", "comment_text": "\n \t\tHere is the PR that fixes this issue: <denchmark-link:https://github.com/ray-project/ray/pull/8324>#8324</denchmark-link>\n \n Problem was that Random did not batch  properly (only single item batches produced).\n I also removed the  dependency from the Random exploration class and fixed the torch side as well.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ericl", "commentT": "2020-05-05T13:12:31Z", "comment_text": "\n \t\tLeaving this open until merged.\n \t\t"}}}, "commit": {"commit_id": "d7eaacb5fe4188f680c19ae26fa5d0074241ebc4", "commit_author": "Sven Mika", "commitT": "2020-05-08 08:26:32+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.2727272727272727", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "rllib\\agents\\ddpg\\tests\\test_ddpg.py", "file_new_name": "rllib\\agents\\ddpg\\tests\\test_ddpg.py", "file_complexity": {"file_NLOC": "395", "file_CCN": "57", "file_NToken": "2856"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25,30", "deleted_lines": "29", "method_info": {"method_name": "test_ddpg_compilation", "method_params": "self", "method_startline": "21", "method_endline": "34", "method_complexity": {"method_NLOC": "10", "method_CCN": "3", "method_NToken": "77", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "370", "deleted_lines": null, "method_info": {"method_name": "test_ddpg_loss_function", "method_params": "self", "method_startline": "87", "method_endline": "370", "method_complexity": {"method_NLOC": "225", "method_CCN": "41", "method_NToken": "1429", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "rllib\\examples\\env\\simple_corridor.py", "file_new_name": "rllib\\examples\\env\\simple_corridor.py", "file_complexity": {"file_NLOC": "26", "file_CCN": "8", "file_NToken": "194"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "28,30", "deleted_lines": "25,31", "method_info": {"method_name": "step", "method_params": "self,action", "method_startline": "25", "method_endline": "32", "method_complexity": {"method_NLOC": "8", "method_CCN": "5", "method_NToken": "73", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "22", "deleted_lines": "20,21", "method_info": {"method_name": "set_corridor_length", "method_params": "self,length", "method_startline": "18", "method_endline": "22", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "48", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "22", "deleted_lines": "21", "method_info": {"method_name": "reset", "method_params": "self", "method_startline": "21", "method_endline": "23", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "15", "deleted_lines": "15", "method_info": {"method_name": "__init__", "method_params": "self,config", "method_startline": "11", "method_endline": "15", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "55", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\models\\tf\\tf_action_dist.py", "file_new_name": "rllib\\models\\tf\\tf_action_dist.py", "file_complexity": {"file_NLOC": "391", "file_CCN": "79", "file_NToken": "3045"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "331,332", "deleted_lines": null, "method_info": {"method_name": "required_model_output_shape", "method_params": "action_space,model_config", "method_startline": "331", "method_endline": "332", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\tests\\test_multi_agent_pendulum.py", "file_new_name": "rllib\\tests\\test_multi_agent_pendulum.py", "file_complexity": {"file_NLOC": "49", "file_CCN": "5", "file_NToken": "270"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,48,49,50,51,52", "deleted_lines": "20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,41,42,43,44,45,46,47", "method_info": {"method_name": "test_multi_agent_pendulum", "method_params": "self", "method_startline": "18", "method_endline": "52", "method_complexity": {"method_NLOC": "33", "method_CCN": "3", "method_NToken": "170", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "rllib\\utils\\exploration\\random.py", "file_new_name": "rllib\\utils\\exploration\\random.py", "file_complexity": {"file_NLOC": "101", "file_CCN": "17", "file_NToken": "705"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "39,40", "deleted_lines": "38,39,40", "method_info": {"method_name": "__init__", "method_params": "self,action_space,model,framework,kwargs", "method_startline": "26", "method_endline": "40", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "48", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94", "deleted_lines": "62,63,64,65,68,69,84,85,86,90,92", "method_info": {"method_name": "get_tf_exploration_action_op.true_fn", "method_params": "", "method_startline": "57", "method_endline": "94", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "72", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "97", "deleted_lines": null, "method_info": {"method_name": "get_tf_exploration_action_op.false_fn", "method_params": "", "method_startline": "96", "method_endline": "97", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "115,117,118,119,120,121,122", "deleted_lines": null, "method_info": {"method_name": "get_torch_exploration_action", "method_params": "self,action_dist,explore", "method_startline": "110", "method_endline": "128", "method_complexity": {"method_NLOC": "17", "method_CCN": "4", "method_NToken": "150", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90", "deleted_lines": "68,69,84,85,86,90", "method_info": {"method_name": "get_tf_exploration_action_op.get_tf_exploration_action_op.true_fn.random_component", "method_params": "component", "method_startline": "68", "method_endline": "90", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "169", "method_nesting_level": "3"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,97", "deleted_lines": "62,63,64,65,68,69,84,85,86,90,92", "method_info": {"method_name": "get_tf_exploration_action_op", "method_params": "self,action_dist,explore", "method_startline": "56", "method_endline": "108", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "93", "method_nesting_level": "1"}}}}}}}}