{"BR": {"BR_id": "12378", "BR_author": "wuisawesome", "BRopenT": "2020-11-25T02:58:13Z", "BRcloseT": "2020-12-20T22:54:47Z", "BR_text": {"BRsummary": "[Autoscaler] Autoscaler not launching min_workers nodes", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n When min workers and max workers are specified, the autoscaler is currently not launching any nodes.\n Example config:\n <denchmark-code>cluster_name: batch_inference_cluster\n \n min_workers: 4\n max_workers: 4\n initial_workers: 4\n idle_timeout_minutes: 1000\n \n docker: {}\n \n provider:\n     type: aws\n     region: us-west-2\n     availability_zone: us-west-2a, us-west-2b, us-west-2c\n \n available_node_types:\n     gpu_1_ondemand:\n         node_config:\n             InstanceType: g4dn.16xlarge\n             TagSpecifications:\n               - ResourceType: \"instance\"\n                 Tags:\n                   - Key: anyscale-user\n                     Value: xmo@anyscale.com\n                   - Key: anyscale-expiration\n                     Value: \"2020-11-30\"\n \n # Specify the node type of the head node (as configured above).\n head_node_type: gpu_1_ondemand\n \n # Specify the default type of the worker node (as configured above).\n worker_default_node_type: gpu_1_ondemand\n \n # The default settings for the head node. This will be merged with the per-node\n # type configs given above.\n head_node:\n     ImageId: latest_dlami\n \n # The default settings for worker nodes. This will be merged with the per-node\n # type configs given above.\n worker_nodes:\n     ImageId: latest_dlami\n \n file_mounts: {\n   \"/home/ubuntu/workspace\": \".\"\n }\n \n rsync_filter:\n     - .gitignore\n \n # How Ray will authenticate with newly launched nodes.\n auth:\n     ssh_user: ubuntu\n \n setup_commands:\n   - pip install torch torchvision ray[all] pillow\n   - pip install -U boto3 botocore\n   # Download the pretrained model\n   - python -c \"from torchvision.models import resnet50; resnet50(pretrained=True)\"\n   - pip install -U https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-1.1.0.dev0-cp37-cp37m-manylinux2014_x86_64.whl\n </denchmark-code>\n \n Ray version and other system information (Python version, TensorFlow version, OS):\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):\n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "wuisawesome", "commentT": "2020-12-08T22:41:32Z", "comment_text": "\n \t\tIs the reason that max_workers defaults to zero for the node type if not available? Should we just make it a required field?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "wuisawesome", "commentT": "2020-12-08T22:42:56Z", "comment_text": "\n \t\tAh, in hindsight I think that might've been the issue. I didn't spend much time debugging this because it occurred during some higher level ML work.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "wuisawesome", "commentT": "2020-12-17T16:30:27Z", "comment_text": "\n \t\tThere are basically three issues here:\n \n Even if you specified min and max workers we still count the head node in min workers.\n We default to max_workers:0 when it is absent. This is safer than assuming it is infinity. But I think the best solution here is to make this a required field.\n Why @wuisawesome is using the global initial_workers and min_workers when they are deprecated? I will raise a warning for that.\n \n \t\t"}}}, "commit": {"commit_id": "11f34f72d832af418de01d92fc7559971ee574c0", "commit_author": "Ameer Haj Ali", "commitT": "2020-12-20 14:54:46-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "python\\ray\\autoscaler\\_private\\autoscaler.py", "file_new_name": "python\\ray\\autoscaler\\_private\\autoscaler.py", "file_complexity": {"file_NLOC": "600", "file_CCN": "94", "file_NToken": "3555"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "152", "method_info": {"method_name": "_update", "method_params": "self", "method_startline": "150", "method_endline": "283", "method_complexity": {"method_NLOC": "98", "method_CCN": "28", "method_NToken": "683", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "484,485,489,490", "deleted_lines": "485,489", "method_info": {"method_name": "reset", "method_params": "self,errors_fatal", "method_startline": "418", "method_endline": "497", "method_complexity": {"method_NLOC": "73", "method_CCN": "11", "method_NToken": "356", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "python\\ray\\autoscaler\\_private\\resource_demand_scheduler.py", "file_new_name": "python\\ray\\autoscaler\\_private\\resource_demand_scheduler.py", "file_complexity": {"file_NLOC": "590", "file_CCN": "30", "file_NToken": "2996"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62", "deleted_lines": null, "method_info": {"method_name": "reset_config", "method_params": "self,NodeProvider,NodeType,int,NodeType,float", "method_startline": "58", "method_endline": "63", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "50", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,NodeProvider,NodeType,int,NodeType,float", "method_startline": "46", "method_endline": "51", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "497", "deleted_lines": "493", "method_info": {"method_name": "_add_min_workers_nodes", "method_params": "NodeType,NodeType,int,NodeType", "method_startline": "493", "method_endline": "497", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "41", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "493", "method_info": {"method_name": "_add_min_workers_nodes", "method_params": "NodeType,NodeType,int", "method_startline": "489", "method_endline": "493", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "37", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "python\\ray\\tests\\test_autoscaler.py", "file_new_name": "python\\ray\\tests\\test_autoscaler.py", "file_complexity": {"file_NLOC": "1451", "file_CCN": "151", "file_NToken": "9355"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "561,563,564,565,566,567,576,578,585,594,599,600", "deleted_lines": "562,572,574,581,590,595", "method_info": {"method_name": "testDynamicScaling", "method_params": "self", "method_startline": "557", "method_endline": "600", "method_complexity": {"method_NLOC": "38", "method_CCN": "2", "method_NToken": "285", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "768,769,770,771", "deleted_lines": "763", "method_info": {"method_name": "testUnmanagedNodes", "method_params": "self", "method_startline": "757", "method_endline": "807", "method_complexity": {"method_NLOC": "43", "method_CCN": "1", "method_NToken": "292", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "975,976,977,978,979,981,991,999,1000,1001,1002,1015,1016", "deleted_lines": "978,986,999", "method_info": {"method_name": "testIgnoresCorruptedConfig", "method_params": "self", "method_startline": "971", "method_endline": "1016", "method_complexity": {"method_NLOC": "40", "method_CCN": "3", "method_NToken": "278", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1133,1134,1135,1136,1137,1138,1145,1146,1147,1148,1150,1153,1154,1155,1156,1160,1165,1167,1172,1176,1179,1180,1181,1182,1186,1194,1195,1196,1197,1199,1204,1206,1208", "deleted_lines": "1125,1128,1130,1131,1132,1133,1134,1135,1136,1139,1144,1146,1151,1154,1158,1161,1170,1171,1177,1179,1181", "method_info": {"method_name": "testScaleUpBasedOnLoad", "method_params": "self", "method_startline": "1124", "method_endline": "1208", "method_complexity": {"method_NLOC": "72", "method_CCN": "2", "method_NToken": "503", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 28, "file_old_name": "python\\ray\\tests\\test_resource_demand_scheduler.py", "file_new_name": "python\\ray\\tests\\test_resource_demand_scheduler.py", "file_complexity": {"file_NLOC": "1688", "file_CCN": "85", "file_NToken": "11609"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "332,333,334,335,336,337,347,353,354,355,357,358", "deleted_lines": "328,329,339,345,346,347,349,358", "method_info": {"method_name": "test_get_nodes_to_launch_with_min_workers_and_bin_packing", "method_params": "", "method_startline": "328", "method_endline": "362", "method_complexity": {"method_NLOC": "25", "method_CCN": "2", "method_NToken": "219", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "367,368", "deleted_lines": "375", "method_info": {"method_name": "test_get_nodes_to_launch_limits", "method_params": "", "method_startline": "365", "method_endline": "380", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "108", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1900,1901,1902,1903,1904,1914", "deleted_lines": null, "method_info": {"method_name": "testRequestResourcesRaceConditionWithMinWorker", "method_params": "self", "method_startline": "1870", "method_endline": "1914", "method_complexity": {"method_NLOC": "39", "method_CCN": "2", "method_NToken": "197", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "385,386", "deleted_lines": null, "method_info": {"method_name": "test_calculate_node_resources", "method_params": "", "method_startline": "383", "method_endline": "402", "method_complexity": {"method_NLOC": "13", "method_CCN": "2", "method_NToken": "124", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "660,661", "deleted_lines": "671", "method_info": {"method_name": "test_packing", "method_params": "self", "method_startline": "658", "method_endline": "679", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "121", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "1358,1359,1360,1361,1364,1368,1370,1373,1374,1377,1378,1381,1383", "deleted_lines": "1356,1357,1359,1360,1369,1376,1378", "method_info": {"method_name": "testRequestBundles", "method_params": "self", "method_startline": "1351", "method_endline": "1383", "method_complexity": {"method_NLOC": "33", "method_CCN": "1", "method_NToken": "237", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "1616,1617,1618,1619,1622,1626,1628,1634", "deleted_lines": "1611,1614,1616,1617,1618,1632", "method_info": {"method_name": "testUpdateConfig", "method_params": "self", "method_startline": "1609", "method_endline": "1634", "method_complexity": {"method_NLOC": "26", "method_CCN": "1", "method_NToken": "181", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "870,871,872,873", "deleted_lines": null, "method_info": {"method_name": "test_handle_legacy_cluster_config_yaml", "method_params": "", "method_startline": "862", "method_endline": "968", "method_complexity": {"method_NLOC": "92", "method_CCN": "4", "method_NToken": "696", "method_nesting_level": "0"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "1692,1693,1694,1695,1696,1697,1705,1708,1710,1711,1712,1726,1729,1739,1750,1756,1766", "deleted_lines": "1672,1707,1717,1719,1720,1721,1736,1741,1751,1754,1758,1766", "method_info": {"method_name": "testRequestResourcesIdleTimeout", "method_params": "self", "method_startline": "1666", "method_endline": "1766", "method_complexity": {"method_NLOC": "92", "method_CCN": "2", "method_NToken": "612", "method_nesting_level": "1"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "1542,1543,1544,1545,1546,1549,1553,1555,1558,1559,1562,1563,1566,1567,1580,1581,1584,1586,1588,1590,1593,1595,1597,1600,1602,1604,1606", "deleted_lines": "1524,1536,1540,1542,1548,1560,1564,1566,1569,1570,1573,1574,1602,1603", "method_info": {"method_name": "testDockerWorkers", "method_params": "self", "method_startline": "1524", "method_endline": "1607", "method_complexity": {"method_NLOC": "80", "method_CCN": "2", "method_NToken": "565", "method_nesting_level": "1"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "1393,1394,1395,1396,1399,1403,1405,1408,1409,1412,1413,1425,1426,1427,1428", "deleted_lines": "1389,1391,1392,1410,1413,1417,1419,1422,1423,1426,1427", "method_info": {"method_name": "testResourcePassing", "method_params": "self", "method_startline": "1385", "method_endline": "1428", "method_complexity": {"method_NLOC": "36", "method_CCN": "2", "method_NToken": "278", "method_nesting_level": "1"}}}, "hunk_11": {"Ismethod": 1, "added_lines": "1437,1438,1439,1440,1441,1448,1450,1461,1463,1464", "deleted_lines": "1430,1431,1434,1437,1439,1441,1443,1464", "method_info": {"method_name": "testScaleUpLoadMetrics", "method_params": "self", "method_startline": "1430", "method_endline": "1466", "method_complexity": {"method_NLOC": "37", "method_CCN": "1", "method_NToken": "217", "method_nesting_level": "1"}}}, "hunk_12": {"Ismethod": 1, "added_lines": "1482,1483,1484,1485,1486,1487,1488,1491,1495,1497,1500,1501,1504,1505,1508,1509,1512,1515,1517,1519,1521", "deleted_lines": "1471,1473,1476,1477,1480,1481,1484,1485,1498,1499,1502,1504,1506,1508,1511,1513,1515,1518,1520,1522", "method_info": {"method_name": "testCommandPassing", "method_params": "self", "method_startline": "1468", "method_endline": "1522", "method_complexity": {"method_NLOC": "53", "method_CCN": "2", "method_NToken": "407", "method_nesting_level": "1"}}}, "hunk_13": {"Ismethod": 1, "added_lines": "592,593", "deleted_lines": "619", "method_info": {"method_name": "test_strategies", "method_params": "self", "method_startline": "590", "method_endline": "631", "method_complexity": {"method_NLOC": "32", "method_CCN": "1", "method_NToken": "246", "method_nesting_level": "1"}}}, "hunk_14": {"Ismethod": 1, "added_lines": "1280", "deleted_lines": "1300,1304,1306,1309,1310", "method_info": {"method_name": "testScaleUpIgnoreUsed", "method_params": "self", "method_startline": "1275", "method_endline": "1312", "method_complexity": {"method_NLOC": "36", "method_CCN": "1", "method_NToken": "220", "method_nesting_level": "1"}}}, "hunk_15": {"Ismethod": 1, "added_lines": "689,690", "deleted_lines": "779", "method_info": {"method_name": "test_get_concurrent_resource_demand_to_launch", "method_params": "", "method_startline": "682", "method_endline": "789", "method_complexity": {"method_NLOC": "76", "method_CCN": "4", "method_NToken": "479", "method_nesting_level": "0"}}}, "hunk_16": {"Ismethod": 1, "added_lines": "417,418", "deleted_lines": "406,478", "method_info": {"method_name": "test_request_resources_existing_usage", "method_params": "", "method_startline": "405", "method_endline": "478", "method_complexity": {"method_NLOC": "57", "method_CCN": "9", "method_NToken": "525", "method_nesting_level": "0"}}}, "hunk_17": {"Ismethod": 1, "added_lines": "490,491,492,493", "deleted_lines": "577", "method_info": {"method_name": "test_backlog_queue_impact_on_binpacking_time", "method_params": "", "method_startline": "481", "method_endline": "586", "method_complexity": {"method_NLOC": "79", "method_CCN": "4", "method_NToken": "396", "method_nesting_level": "0"}}}, "hunk_18": {"Ismethod": 1, "added_lines": "635,636", "deleted_lines": "643", "method_info": {"method_name": "test_many_strict_spreads", "method_params": "self", "method_startline": "633", "method_endline": "656", "method_complexity": {"method_NLOC": "17", "method_CCN": "1", "method_NToken": "129", "method_nesting_level": "1"}}}, "hunk_19": {"Ismethod": 1, "added_lines": "1157,1161,1162,1163,1164,1165,1166,1173", "deleted_lines": "1175,1182,1184,1185,1187,1188,1198,1204,1207", "method_info": {"method_name": "testPlacementGroup", "method_params": "self", "method_startline": "1151", "method_endline": "1218", "method_complexity": {"method_NLOC": "58", "method_CCN": "2", "method_NToken": "370", "method_nesting_level": "1"}}}, "hunk_20": {"Ismethod": 1, "added_lines": "1229,1230,1231,1232,1233,1240,1242,1243,1245,1246,1256,1262,1265,1266", "deleted_lines": null, "method_info": {"method_name": "testScaleUpMinWorkers", "method_params": "self", "method_startline": "1220", "method_endline": "1273", "method_complexity": {"method_NLOC": "50", "method_CCN": "5", "method_NToken": "355", "method_nesting_level": "1"}}}, "hunk_21": {"Ismethod": 1, "added_lines": "309,310,312,313,314,315,325", "deleted_lines": "309,311,321", "method_info": {"method_name": "test_get_nodes_to_launch_with_min_workers", "method_params": "", "method_startline": "305", "method_endline": "325", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "127", "method_nesting_level": "0"}}}, "hunk_22": {"Ismethod": 1, "added_lines": "1110,1111,1112,1113,1116,1120,1122,1124", "deleted_lines": "1108,1115,1116,1117,1118,1119", "method_info": {"method_name": "testScaleUpMinSanity", "method_params": "self", "method_startline": "1103", "method_endline": "1124", "method_complexity": {"method_NLOC": "22", "method_CCN": "1", "method_NToken": "130", "method_nesting_level": "1"}}}, "hunk_23": {"Ismethod": 1, "added_lines": "1644,1645,1646,1647,1650,1654,1656,1659,1660,1663,1664", "deleted_lines": "1645,1656,1662", "method_info": {"method_name": "testEmptyDocker", "method_params": "self", "method_startline": "1636", "method_endline": "1664", "method_complexity": {"method_NLOC": "29", "method_CCN": "1", "method_NToken": "191", "method_nesting_level": "1"}}}, "hunk_24": {"Ismethod": 1, "added_lines": "798,799", "deleted_lines": null, "method_info": {"method_name": "test_get_nodes_to_launch_max_launch_concurrency", "method_params": "", "method_startline": "792", "method_endline": "840", "method_complexity": {"method_NLOC": "37", "method_CCN": "3", "method_NToken": "297", "method_nesting_level": "0"}}}, "hunk_25": {"Ismethod": 1, "added_lines": "1126,1127,1128,1129,1130,1131,1132,1133,1134,1135,1136,1137,1138,1139,1140,1141,1142,1143,1144,1145,1146,1147,1148,1149", "deleted_lines": null, "method_info": {"method_name": "testScaleUpMinSanityWithHeadNode", "method_params": "self", "method_startline": "1126", "method_endline": "1149", "method_complexity": {"method_NLOC": "22", "method_CCN": "1", "method_NToken": "139", "method_nesting_level": "1"}}}, "hunk_26": {"Ismethod": 1, "added_lines": "259,265,271,282,292,296", "deleted_lines": "259,265,271,282,292,296", "method_info": {"method_name": "test_add_min_workers_nodes", "method_params": "", "method_startline": "226", "method_endline": "302", "method_complexity": {"method_NLOC": "72", "method_CCN": "1", "method_NToken": "456", "method_nesting_level": "0"}}}, "hunk_27": {"Ismethod": 1, "added_lines": "1801,1802,1803,1804,1805,1815,1817,1818,1819,1834,1839,1849,1852,1856,1864", "deleted_lines": "1802,1812", "method_info": {"method_name": "testRequestResourcesRaceConditionsLong", "method_params": "self", "method_startline": "1768", "method_endline": "1868", "method_complexity": {"method_NLOC": "86", "method_CCN": "2", "method_NToken": "596", "method_nesting_level": "1"}}}}}}}}