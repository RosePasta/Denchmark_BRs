{"BR": {"BR_id": "12443", "BR_author": "PidgeyBE", "BRopenT": "2020-11-26T10:42:11Z", "BRcloseT": "2020-12-01T00:03:31Z", "BR_text": {"BRsummary": "[autoscaler] Request resources behaves inconsistently", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n \n Ray nightly\n \n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n \n set up k8s autoscaling cluster\n Run this (I did it in ipython on ray head):\n \n <denchmark-code>import os\n import ray\n from ray.autoscaler.sdk import request_resources\n \n ray.init(address=\"auto\")\n \n @ray.remote(num_cpus=0.2)\n class ActorA:\n     def __init__(self):\n         pass\n \n a = ActorA.remote()\n \n request_resources(bundles=[{\"CPU\": 0.1}, {\"CPU\": 0.1}])\n </denchmark-code>\n \n -> Output of autoscaling monitor is\n <denchmark-code>2020-11-26 10:37:16,419 INFO resource_demand_scheduler.py:193 -- Resource demands: [{'CPU': 0.2}]\n ...\n 2020-11-26 10:37:16,425 INFO autoscaler.py:612 -- StandardAutoscaler: resource_requests=[{'CPU': 0.1}, {'CPU': 0.1}]\n ...\n 2020-11-26 10:37:26,588 INFO resource_demand_scheduler.py:193 -- Resource demands: [{'CPU': 0.2}, {'CPU': 0.1}]\n </denchmark-code>\n \n -> The expected output is [{'CPU': 0.2}, {'CPU': 0.1}, {'CPU': 0.1}]\n In other tests I did, the requested resources where totally ignored.\n \n If I do ray.kill(a) now, the output shows:\n Resource demands: [{'CPU': 0.2}, {'CPU': 0.1}, {'CPU': 0.1}]\n So the missing request shows up, but the the request related to the actor is not cleaned up (#12441)\n \n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "PidgeyBE", "commentT": "2020-11-27T09:59:42Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/PidgeyBE>@PidgeyBE</denchmark-link>\n ,\n when you call  you get these resources \"immediately\", but they do not add on top of what you already have.\n So if you resource demands are {\"CPU\": 0.2} the available resources become:\n  the  becomes available immediately but the remaining  might take more time to become available.\n Checkout how  works <denchmark-link:https://docs.ray.io/en/master/cluster/autoscaling.html?highlight=request_resources#ray.autoscaler.sdk.request_resources>here</denchmark-link>\n .\n Does it make sense?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "PidgeyBE", "commentT": "2020-11-27T14:14:52Z", "comment_text": "\n \t\tSo if I do:\n <denchmark-code>ray.remote(num_cpus=0.2)(ActorA).remote()\n request_resources(bundles=[{\"CPU\": 0.1}, {\"CPU\": 0.1}])\n </denchmark-code>\n \n the total Resource Demands become [{'CPU': 0.2}, {'CPU': 0.1}], because one requested bundle {'CPU': 0.1} fits into the currently deployed task with{'CPU': 0.2}.\n But if I do\n <denchmark-code>request_resources(bundles=[{\"CPU\": 0.2}, {\"CPU\": 0.2}])\n ray.remote(num_cpus=0.1)(ActorA).remote()\n </denchmark-code>\n \n the total Resource Demand becomes [{'CPU': 0.1}, {'CPU': 0.2}, {'CPU': 0.2}], because non of the requested bundles fits into one of the already deployed tasks?\n So the Resource Demands are basically the requested resources, minus the bundles that are smaller or equal to running tasks?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "PidgeyBE", "commentT": "2020-11-28T00:02:18Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/PidgeyBE>@PidgeyBE</denchmark-link>\n  that's right. Note that you're seeing here an artifact of the implementation of request_resources() (the internal bin packing algorithm). If only  were used instead of different shapes, this artifact were disappear. We could in the future improve the algorithm to fix this edge case.\n The intended use of request_resources() is as a hint to scale the cluster to accommodate the requests, ignoring any existing utilization of the cluster; the result cluster size might be slightly larger than necessary due to sub-optimal packing.\n \t\t"}}}, "commit": {"commit_id": "234df9091e57f2a4d7574e2ae53635bb5c862b9e", "commit_author": "Eric Liang", "commitT": "2020-11-30 16:03:30-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\autoscaler\\sdk.py", "file_new_name": "python\\ray\\autoscaler\\sdk.py", "file_complexity": {"file_NLOC": "226", "file_CCN": "15", "file_NToken": "816"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "186,188,189,190,191,192,193,194,195,196,197,198,199,204,207", "deleted_lines": "186,188,189,194,197"}}}}}}