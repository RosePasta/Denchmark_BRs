{"BR": {"BR_id": "8076", "BR_author": "ericl", "BRopenT": "2020-04-18T01:12:33Z", "BRcloseT": "2020-04-19T16:53:03Z", "BR_text": {"BRsummary": "GCS actor management introduces reference counting bug", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n RLlib A3C tests are failing with eviction errors in master since <denchmark-link:https://github.com/ray-project/ray/pull/6763>#6763</denchmark-link>\n . An object required for an actor construction task seems to have been evicted in error. This probably got overlooked since travis skips RLlib tests on core changes.\n cc <denchmark-link:https://github.com/wumuzi520>@wumuzi520</denchmark-link>\n  <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  can you guys look into this? <denchmark-link:https://github.com/ray-project/ray/pull/6763>#6763</denchmark-link>\n  seems slightly tricky to revert, so it seems better to try to fix forward if possible, but if this is hard I can make a revert PR.\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n You can run pytest -v -s test_supported_spaces.py to reproduce. To speed up the test, you can comment out all other tests except for test_a3c, which is the failing one:\n <denchmark-code>=== Testing A3C (torch=False) A=Discrete(5) S=Box(210, 160, 3) ===\n 2020-04-17 18:11:43,721\tINFO trainable.py:217 -- Getting current IP.\n 2020-04-17 18:11:43,721\tWARNING util.py:37 -- Install gputil for GPU system monitoring.\n 2020-04-17 18:11:54,200\tWARNING worker.py:1065 -- The task with ID ffffffffffffffffffffffff0100 is a driver task and so the object created by ray.put could not be reconstructed.\n (pid=27937) unable to import 'smart_open.gcs', disabling that module\n ray::RolloutWorker.par_iter_init() (pid=27937, ip=192.168.5.121)\n   File \"python/ray/_raylet.pyx\", line 421, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 421, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 424, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 446, in ray._raylet.execute_task\n ray.exceptions.UnreconstructableError: Object ffffffffffffffffffffffff0100008809000000 is lost (either LRU evicted or deleted by user) and cannot be reconstructed. Try increasing the object store memory available with ray.init(object_store_memory=<bytes>) or setting object store limits with ray.remote(object_store_memory=<bytes>). See also: https://ray.readthedocs.io/en/latest/memory-management.html\n Traceback (most recent call last):\n   File \"/tmp/x.py\", line 112, in check_support\n     a.train()\n   File \"/home/eric/Desktop/ray/python/ray/rllib/agents/trainer.py\", line 502, in train\n     raise e\n   File \"/home/eric/Desktop/ray/python/ray/rllib/agents/trainer.py\", line 491, in train\n     result = Trainable.train(self)\n   File \"/home/eric/Desktop/ray/python/ray/tune/trainable.py\", line 261, in train\n     result = self._train()\n   File \"/home/eric/Desktop/ray/python/ray/rllib/agents/trainer_template.py\", line 142, in _train\n     return self._train_exec_impl()\n   File \"/home/eric/Desktop/ray/python/ray/rllib/agents/trainer_template.py\", line 174, in _train_exec_impl\n     res = next(self.train_exec_impl)\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 634, in __next__\n     return next(self.built_iterator)\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 644, in apply_foreach\n     for item in it:\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 685, in apply_filter\n     for item in it:\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 644, in apply_foreach\n     for item in it:\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 670, in add_wait_hooks\n     item = next(it)\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 644, in apply_foreach\n     for item in it:\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 448, in base_iterator\n     actor_set.init_actors()\n   File \"/home/eric/Desktop/ray/python/ray/util/iter.py\", line 1002, in init_actors\n     ray.get([a.par_iter_init.remote(self.transforms) for a in self.actors])\n   File \"/home/eric/Desktop/ray/python/ray/worker.py\", line 1488, in get\n     raise value.as_instanceof_cause()\n ray.exceptions.RayTaskError: ray::RolloutWorker.par_iter_init() (pid=27937, ip=192.168.5.121)\n   File \"python/ray/_raylet.pyx\", line 421, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 421, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 424, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 446, in ray._raylet.execute_task\n ray.exceptions.UnreconstructableError: Object ffffffffffffffffffffffff0100008809000000 is lost (either LRU evicted or deleted by user) and cannot be reconstructed. Try increasing the object store memory available with ray.init(object_store_memory=<bytes>) or setting object store limits with ray.remote(object_store_memory=<bytes>). See also: https://ray.readthedocs.io/en/latest/memory-management.html\n \n ERROR\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ericl", "commentT": "2020-04-18T02:18:23Z", "comment_text": "\n \t\tLooks like it's probably because the GCS Service responds immediately to the caller of the actor creation task instead of waiting until the actor creation task has finished.\n \t\t"}}}, "commit": {"commit_id": "3f28a8a2297e9019364104bf6c957f8879e8d40d", "commit_author": "ZhuSenlin", "commitT": "2020-04-19 09:53:02-07:00", "commit_complexity": {"commit_NLOC": "0.375", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "python\\ray\\tests\\test_reference_counting.py", "file_new_name": "python\\ray\\tests\\test_reference_counting.py", "file_complexity": {"file_NLOC": "346", "file_CCN": "55", "file_NToken": "2885"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185", "deleted_lines": null, "method_info": {"method_name": "test_actor_creation_task", "method_params": "ray_start_regular", "method_startline": "165", "method_endline": "185", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "87", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "173,174", "deleted_lines": null, "method_info": {"method_name": "test_actor_creation_task.__init__", "method_params": "self,dependency", "method_startline": "173", "method_endline": "174", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "167,168,169", "deleted_lines": null, "method_info": {"method_name": "test_actor_creation_task.large_object", "method_params": "", "method_startline": "167", "method_endline": "169", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "176,177", "deleted_lines": null, "method_info": {"method_name": "test_actor_creation_task.ping", "method_params": "self", "method_startline": "176", "method_endline": "177", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "6", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.cc", "file_complexity": {"file_NLOC": "194", "file_CCN": "36", "file_NToken": "1521"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "114,115,118,119,127,132,133,137,138", "deleted_lines": "114,117,118,119,120,121,129,134,138,139", "method_info": {"method_name": "ray::gcs::GcsActorManager::RegisterActor", "method_params": "request,callback", "method_startline": "106", "method_endline": "139", "method_complexity": {"method_NLOC": "22", "method_CCN": "4", "method_NToken": "201", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "251,252,253,254,255,256,257,258,259,260", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::GcsActorManager::OnActorCreateSuccess", "method_params": "actor", "method_startline": "236", "method_endline": "261", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "186", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.h", "file_new_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.h", "file_complexity": {"file_NLOC": "77", "file_CCN": "2", "file_NToken": "599"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "128,129,130", "deleted_lines": "128,129"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_manager_test.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_manager_test.cc", "file_complexity": {"file_NLOC": "124", "file_CCN": "8", "file_NToken": "1108"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "111,113,114,117,121,128", "deleted_lines": "111,113,114,117,121", "method_info": {"method_name": "ray::TEST_F", "method_params": "GcsActorManagerTest,TestNormalFlow", "method_startline": "98", "method_endline": "167", "method_complexity": {"method_NLOC": "55", "method_CCN": "1", "method_NToken": "608", "method_nesting_level": "1"}}}}}}}}