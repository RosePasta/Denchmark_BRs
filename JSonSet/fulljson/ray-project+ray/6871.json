{"BR": {"BR_id": "6871", "BR_author": "simon-mo", "BRopenT": "2020-01-20T23:56:04Z", "BRcloseT": "2020-01-23T00:07:09Z", "BR_text": {"BRsummary": "Async actor uses 100% cpu", "BRdescription": "\n Script:\n <denchmark-code>import ray\n import asyncio\n \n ray.init()\n \n @ray.remote\n class AsyncActor:\n     async def run(self):\n         print(\"started\")\n         await asyncio.sleep(1000)\n         print(\"done\")\n \n a = AsyncActor.options(is_direct_call=True,is_asyncio=True).remote()\n ray.get([a.run.remote() for _ in range(10)])\n </denchmark-code>\n \n Observe:\n the worker process use 100% cpu.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "simon-mo", "commentT": "2020-01-20T23:57:44Z", "comment_text": "\n \t\tCan reproduce before <denchmark-link:https://github.com/ray-project/ray/commit/8f246c17b5f6bc8aeb62a8286252097873304c6b>8f246c1</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "simon-mo", "commentT": "2020-01-21T00:03:46Z", "comment_text": "\n \t\tCan reproduce before <denchmark-link:https://github.com/ray-project/ray/commit/9fe90cdafce3d2bcfbefa6a4d009db290f6186a7>9fe90cd</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "simon-mo", "commentT": "2020-01-21T00:05:18Z", "comment_text": "\n \t\tProbably due to thread contention, somehow fibers use spinlock??\n <denchmark-link:https://www.boost.org/doc/libs/1_72_0/libs/fiber/doc/html/fiber/tuning.html#ftn.fiber.tuning.f0>https://www.boost.org/doc/libs/1_72_0/libs/fiber/doc/html/fiber/tuning.html#ftn.fiber.tuning.f0</denchmark-link>\n \n <denchmark-link:https://github.com/boostorg/fiber/blob/develop/include/boost/fiber/detail/spinlock.hpp>https://github.com/boostorg/fiber/blob/develop/include/boost/fiber/detail/spinlock.hpp</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "5f527816fe92d6ae3fe066985d788364fd2a64af", "commit_author": "Simon Mo", "commitT": "2020-01-22 16:07:08-08:00", "commit_complexity": {"commit_NLOC": "0.19047619047619047", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\ray\\includes\\libcoreworker.pxd", "file_new_name": "python\\ray\\includes\\libcoreworker.pxd", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "56", "deleted_lines": "56"}}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "src\\ray\\core_worker\\fiber.h", "file_complexity": {"file_NLOC": "88", "file_CCN": "12", "file_NToken": "499"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\core_worker\\transport\\direct_actor_transport.cc", "file_new_name": "src\\ray\\core_worker\\transport\\direct_actor_transport.cc", "file_complexity": {"file_NLOC": "259", "file_CCN": "48", "file_NToken": "2130"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "192", "deleted_lines": "192,193,194,195,196", "method_info": {"method_name": "ray::CoreWorkerDirectTaskReceiver::SetActorAsAsync", "method_params": "max_concurrency", "method_startline": "189", "method_endline": "196", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "43", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "337", "deleted_lines": "198,199,200,201,202,203,204,205,206,207", "method_info": {"method_name": "ray::CoreWorkerDirectTaskReceiver::HandlePushTask", "method_params": "request,reply,send_reply_callback", "method_startline": "198", "method_endline": "342", "method_complexity": {"method_NLOC": "111", "method_CCN": "24", "method_NToken": "923", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 9, "file_old_name": "src\\ray\\core_worker\\transport\\direct_actor_transport.h", "file_new_name": "src\\ray\\core_worker\\transport\\direct_actor_transport.h", "file_complexity": {"file_NLOC": "268", "file_CCN": "33", "file_NToken": "1861"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "244", "deleted_lines": "244,245,246,247", "method_info": {"method_name": "ray::FiberEvent::Wait", "method_params": "", "method_startline": "244", "method_endline": "247", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "38", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "302", "deleted_lines": "303,311", "method_info": {"method_name": "ray::SchedulingQueue::SchedulingQueue", "method_params": "main_io_service,waiter,pool,use_asyncio,fiber_rate_limiter,reorder_wait_seconds", "method_startline": "300", "method_endline": "311", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "87", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "252", "deleted_lines": "250,251,252,253,254,255,256", "method_info": {"method_name": "ray::FiberEvent::Notify", "method_params": "", "method_startline": "250", "method_endline": "256", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "449,450,451,452,453,454,455", "method_info": {"method_name": "ray::CoreWorkerDirectTaskReceiver::~CoreWorkerDirectTaskReceiver", "method_params": "", "method_startline": "449", "method_endline": "455", "method_complexity": {"method_NLOC": "6", "method_CCN": "2", "method_NToken": "27", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "244,252", "deleted_lines": "241,242,243,244,245,246,247,248,249,250,251,252", "method_info": {"method_name": "ray::SchedulingQueue::SchedulingQueue", "method_params": "main_io_service,waiter,pool,use_asyncio,fiber_state,reorder_wait_seconds", "method_startline": "241", "method_endline": "252", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "87", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": null, "deleted_lines": "279,280,281,282,283,284,285,286,287,288", "method_info": {"method_name": "ray::FiberRateLimiter::Release", "method_params": "", "method_startline": "279", "method_endline": "288", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "302", "deleted_lines": "285,286,287,288,289,290,291,292,293,294,295,303,311", "method_info": {"method_name": "ray::SchedulingQueue::ScheduleRequests", "method_params": "", "method_startline": "285", "method_endline": "327", "method_complexity": {"method_NLOC": "36", "method_CCN": "11", "method_NToken": "304", "method_nesting_level": "2"}}}, "hunk_7": {"Ismethod": 1, "added_lines": null, "deleted_lines": "272,273,274,275,276", "method_info": {"method_name": "ray::FiberRateLimiter::Acquire", "method_params": "", "method_startline": "272", "method_endline": "276", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "44", "method_nesting_level": "2"}}}, "hunk_8": {"Ismethod": 1, "added_lines": null, "deleted_lines": "269", "method_info": {"method_name": "ray::FiberRateLimiter::FiberRateLimiter", "method_params": "num", "method_startline": "269", "method_endline": "269", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "2"}}}}}}}}