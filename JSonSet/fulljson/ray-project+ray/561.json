{"BR": {"BR_id": "561", "BR_author": "robertnishihara", "BRopenT": "2017-05-17T19:25:10Z", "BRcloseT": "2017-06-09T22:55:58Z", "BR_text": {"BRsummary": "Launching more tasks causes failure with retry messages.", "BRdescription": "\n The following script fails.\n @ray.remote\n def f(x):\n   return 1\n \n def g(n):\n   x = 1\n   for i in range(n):\n     x = f.remote(x)\n   return x\n \n ray.get([g(1000) for _ in range(100)])\n It will indefinitely print a message like the following.\n <denchmark-code>[WARN] (/Users/rkn/Workspace/ray/src/common/state/table.cc:85) retrying operation task_table_test_and_update, retry_count = -1\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "robertnishihara", "commentT": "2017-05-19T04:11:25Z", "comment_text": "\n \t\tI just tried this with 10 Redis shards, and the same problem occurs.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "robertnishihara", "commentT": "2017-05-19T20:18:33Z", "comment_text": "\n \t\tI also tried removing the event log and removing retries (in addition to 10 Redis shards). A local scheduler still gets marked as dead.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "robertnishihara", "commentT": "2017-05-26T19:31:05Z", "comment_text": "\n \t\tWhen I say \"removing the event log\", I mean using the change in <denchmark-link:https://github.com/ray-project/ray/pull/572>#572</denchmark-link>\n . Similarly, when I say \"removing retries\", I mean using the change in <denchmark-link:https://github.com/ray-project/ray/pull/574>#574</denchmark-link>\n .\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "robertnishihara", "commentT": "2017-06-08T04:41:56Z", "comment_text": "\n \t\tWhen this happens, the local_scheduler process is stuck at 100% cpu, and appears to be spending most of its time in common/thirdparty/ae/ae.c:aeDeleteTimeEvent(). It looks like each call to aeDeleteTimeEvent() scans the entire event queue, so assuming you eventually want to delete each event, the overall CPU used for event processing is going to grow O(n^2) wrt the size of the queue.\n Because of this n^2 thing, I think that launching enough tasks is making timer processing slow enough that the queue grows unboundedly. Indeed it seems that once the queue size hits >6k events, it does start growing unboundedly and you get the retry messages.\n TLDR: I think event processing is O(n^2) and can't keep up if there are too many tasks. Thoughts on angle of attack?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "robertnishihara", "commentT": "2017-06-09T22:55:58Z", "comment_text": "\n \t\tAddressed by <denchmark-link:https://github.com/ray-project/ray/pull/649>#649</denchmark-link>\n .\n \t\t"}}}, "commit": {"commit_id": "d4d2c03ac55cbd1a2674bdb33f0426c5bc5c4c48", "commit_author": "Eric Liang", "commitT": "2017-06-09 15:55:36-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "src\\common\\state\\redis.cc", "file_new_name": "src\\common\\state\\redis.cc", "file_complexity": {"file_NLOC": "1200", "file_CCN": "199", "file_NToken": "8837"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1249", "deleted_lines": "1250", "method_info": {"method_name": "redis_db_client_table_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1228", "method_endline": "1289", "method_complexity": {"method_NLOC": "43", "method_CCN": "7", "method_NToken": "313", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "735", "deleted_lines": "735,736", "method_info": {"method_name": "object_table_redis_subscribe_to_notifications_callback", "method_params": "c,r,privdata", "method_startline": "674", "method_endline": "740", "method_complexity": {"method_NLOC": "42", "method_CCN": "6", "method_NToken": "319", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1543", "deleted_lines": "1544", "method_info": {"method_name": "redis_actor_notification_table_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1505", "method_endline": "1548", "method_complexity": {"method_NLOC": "35", "method_CCN": "4", "method_NToken": "267", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1433", "deleted_lines": "1434", "method_info": {"method_name": "redis_driver_table_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1403", "method_endline": "1438", "method_complexity": {"method_NLOC": "25", "method_CCN": "4", "method_NToken": "193", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "1345", "deleted_lines": "1346", "method_info": {"method_name": "redis_local_scheduler_table_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1302", "method_endline": "1350", "method_complexity": {"method_NLOC": "36", "method_CCN": "6", "method_NToken": "296", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "1584", "deleted_lines": "1585", "method_info": {"method_name": "redis_object_info_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1562", "method_endline": "1599", "method_complexity": {"method_NLOC": "28", "method_CCN": "4", "method_NToken": "199", "method_nesting_level": "0"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "1108", "deleted_lines": "1109", "method_info": {"method_name": "redis_task_table_subscribe_callback", "method_params": "c,r,privdata", "method_startline": "1058", "method_endline": "1114", "method_complexity": {"method_NLOC": "39", "method_CCN": "8", "method_NToken": "328", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\common\\state\\table.cc", "file_new_name": "src\\common\\state\\table.cc", "file_complexity": {"file_NLOC": "101", "file_CCN": "16", "file_NToken": "587"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62,63,64,65,66", "deleted_lines": null, "method_info": {"method_name": "remove_timer_callback", "method_params": "loop,callback_data", "method_startline": "62", "method_endline": "66", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "56,57,58", "deleted_lines": "54", "method_info": {"method_name": "destroy_timer_callback", "method_params": "loop,callback_data", "method_startline": "54", "method_endline": "60", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "41,42,43,44", "deleted_lines": "39,40,41,42", "method_info": {"method_name": "init_table_callback", "method_params": "db_handle,id,label,data,retry,done_callback,retry_callback,user_context", "method_startline": "13", "method_endline": "52", "method_complexity": {"method_NLOC": "33", "method_CCN": "2", "method_NToken": "184", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\common\\state\\table.h", "file_new_name": "src\\common\\state\\table.h", "file_complexity": {"file_NLOC": "46", "file_CCN": "0", "file_NToken": "223"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "131,138,139,140,141,142,143,144,145,146", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\test\\object_table_tests.cc", "file_new_name": "src\\common\\test\\object_table_tests.cc", "file_complexity": {"file_NLOC": "726", "file_CCN": "54", "file_NToken": "4337"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "893,894,895,898,899,900", "deleted_lines": "893,894,895,898,899,900", "method_info": {"method_name": "SUITE", "method_params": "object_table_tests", "method_startline": "890", "method_endline": "905", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\test\\task_table_tests.cc", "file_new_name": "src\\common\\test\\task_table_tests.cc", "file_complexity": {"file_NLOC": "353", "file_CCN": "34", "file_NToken": "2229"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "437,438,439,440,441,442", "deleted_lines": "437,438,439,440,441,442", "method_info": {"method_name": "SUITE", "method_params": "task_table_tests", "method_startline": "434", "method_endline": "443", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "test\\stress_tests.py", "file_new_name": "test\\stress_tests.py", "file_complexity": {"file_NLOC": "359", "file_CCN": "105", "file_NToken": "2774"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "74,75", "deleted_lines": null, "method_info": {"method_name": "testSubmittingManyTasks.f", "method_params": "x", "method_startline": "74", "method_endline": "75", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "77,78,79,80,81", "deleted_lines": null, "method_info": {"method_name": "testSubmittingManyTasks.g", "method_params": "n", "method_startline": "77", "method_endline": "81", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "26", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85", "deleted_lines": null, "method_info": {"method_name": "testSubmittingManyTasks", "method_params": "self", "method_startline": "70", "method_endline": "85", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "55", "method_nesting_level": "1"}}}}}}}}