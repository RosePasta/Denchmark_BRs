{"BR": {"BR_id": "190", "BR_author": "JesseYang", "BRopenT": "2017-03-16T15:23:01Z", "BRcloseT": "2017-03-16T20:12:28Z", "BR_text": {"BRsummary": "cudnn does not support NCHW batch_norm during inference?", "BRdescription": "\n I got the following error:\n <denchmark-code>tensorflow.python.framework.errors_impl.InternalError: cuDNN launch failure : input shape ([1032,660,1,1])\n \t [[Node: towerp0/rnn/bn.0/FusedBatchNorm = FusedBatchNorm[T=DT_FLOAT, data_format=\"NCHW\", epsilon=1.0000001e-05, is_training=false, _device=\"/job:localhost/replica:0/task:0/gpu:0\"](towerp0/rnn/bn.0/Reshape, rnn/bn.0/gamma/read, rnn/bn.0/beta/read, rnn/bn.0/mean/EMA/read, rnn/bn.0/variance/EMA/read)]]\n \t [[Node: towerp0/rnn/bi_rnn.1/bidirectional_rnn/bw/bw/stack/_1425 = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/cpu:0\", send_device=\"/job:localhost/replica:0/task:0/gpu:0\", send_device_incarnation=1, tensor_name=\"edge_568_towerp0/rnn/bi_rnn.1/bidirectional_rnn/bw/bw/stack\", tensor_type=DT_INT32, _device=\"/job:localhost/replica:0/task:0/cpu:0\"]()]]\n \n </denchmark-code>\n \n The tensor to be batch normalized has dimension of 2. In the source code batch_norm.py, tensors with dimension of 2 are extended to dimension of 4 with NCHW format. I switched the format to NHWC in batch_norm.py as follows:\n <denchmark-code>    shape = x.get_shape().as_list()\n     assert len(shape) in [2, 4]\n     if len(shape) == 2:\n         # data_format = 'NCHW'\n         data_format = 'NHWC'\n     if data_format == 'NCHW':\n         n_out = shape[1]\n     else:\n         n_out = shape[-1]  # channel\n     if len(shape) == 2:\n         # x = tf.reshape(x, [-1, n_out, 1, 1])\n         x = tf.reshape(x, [-1, 1, 1, n_out])\n </denchmark-code>\n \n It works fine.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "JesseYang", "commentT": "2017-03-16T15:39:29Z", "comment_text": "\n \t\tThat's very strange. I will make a change to adopt your fix.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "JesseYang", "commentT": "2017-03-16T20:11:59Z", "comment_text": "\n \t\tDid you mean you have this error only in inference (not training)?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "JesseYang", "commentT": "2017-03-17T13:00:04Z", "comment_text": "\n \t\tYes, this error only occurs during inference\n \t\t"}}}, "commit": {"commit_id": "13e0ec397338985dfba03f0d759316cb5e3c680a", "commit_author": "Yuxin Wu", "commitT": "2017-03-16 13:11:48-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorpack\\models\\batch_norm.py", "file_new_name": "tensorpack\\models\\batch_norm.py", "file_complexity": {"file_NLOC": "158", "file_CCN": "16", "file_NToken": "1451"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "170,176,216", "deleted_lines": "170,176"}}}}}}