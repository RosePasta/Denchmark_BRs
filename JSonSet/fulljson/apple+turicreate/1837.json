{"BR": {"BR_id": "1837", "BR_author": "fbomb111", "BRopenT": "2019-05-06T16:52:38Z", "BRcloseT": "2019-05-08T08:30:00Z", "BR_text": {"BRsummary": "Bounding box errors and troubleshooting when using 'explore'", "BRdescription": "\n In using the following with my own dataset:\n <denchmark-code>data['image_with_ground_truth'] = \\\n     tc.object_detector.util.draw_bounding_boxes(data['image'], data['annotations'])\n data.explore()\n </denchmark-code>\n \n I often get the following error:\n <denchmark-code>/anaconda3/lib/python3.6/site-packages/turicreate/data_structures/sframe.py in <listcomp>(.0)\n    2477         assert callable(fn), \"Input must be callable\"\n    2478         test_sf = self[:10]\n -> 2479         dryrun = [fn(row) for row in test_sf]\n    2480         if dtype is None:\n    2481             dtype = SArray(dryrun).dtype\n \n /anaconda3/lib/python3.6/site-packages/turicreate/toolkits/object_detector/util/_visualization.py in draw_single_image(row)\n     140                                     _width=image.shape[1],\n     141                                     _height=image.shape[0],\n --> 142                                     _channels=image.shape[2],\n     143                                     _format_enum=FORMAT_RAW,\n     144                                     _image_data_size=image.size)\n \n IndexError: tuple index out of range\n </denchmark-code>\n \n There is no indication of which image it failed on, or why (at least to me) it failed which is difficult to troubleshoot.  I ran explore() half-splitting my images until I finally found a culprit.\n Here is the image:\n <denchmark-link:https://user-images.githubusercontent.com/482183/57240833-86c55880-6ffd-11e9-9f09-a3f7cd13fc79.jpg></denchmark-link>\n \n And the data in my SFrame for this image:\n <denchmark-code>{'image': Height: 768px\n  Width: 1024px\n  Channels: 3,\n  'name': '5290f4027491d09b',\n  'annotations': [{'label': 'Window',\n    'coordinates': {'x': 344.514048,\n     'y': 252.271488,\n     'width': 101.89312000000001,\n     'height': 93.66297600000001}},\n   {'label': 'Window',\n    'coordinates': {'x': 674.277376,\n     'y': 240.79296,\n     'width': 59.78316799999993,\n     'height': 163.097856}},\n   {'label': 'Window',\n    'coordinates': {'x': 702.357504,\n     'y': 203.64288,\n     'width': 77.89977599999997,\n     'height': 103.29599999999999}}]}\n </denchmark-code>\n \n Actually data.explore() runs fine unless I run data['image_with_ground_truth'] = \\ tc.object_detector.util.draw_bounding_boxes(data['image'], data['annotations']) (taken from the Readme) before it.\n Any assistance would be greatly appreciated.  Also please consider my suggestion of providing a little more feedback about which image failed in this process so they are easier to isolate.  Thank you kindly!\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "fbomb111", "commentT": "2019-05-06T18:06:53Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/fbomb111>@fbomb111</denchmark-link>\n  ,\n Thanks for using and providing great feedback on the Turi Create Object Detector. We created an issue tracking making  provide more helpful debugging information (<denchmark-link:https://github.com/apple/turicreate/issues/1838>#1838</denchmark-link>\n  ).\n Regarding the error you get, let's confirm that this is the image that draw_bounding_boxes failed on. I downloaded the image and ran draw_bounding_boxes on just that image and the annotation you provided and I saw bounding boxes (see attachment). There could be a few possibilities:\n \n There is a bad image in your SFrame (probably the one you attached).\n There is no bad image in your SFrame and there's a bad codepath that gets triggered either on a particular image or on the SFrame as a whole.\n \n Could you run the following code snippet (replace sf, image_column_name, and annotation_column_name) to see if this still points to the same image you attached?\n <denchmark-code>for row in sf.num_rows():\n     image = sf[image_column_name][row]\n     annotation = sf[annotation_column_name][row]\n     try:\n         tc.object_detector.util.draw_bounding_boxes(image, annotation)\n     except:\n         print(\"Bad image row number:\")\n         print(row)\n         print(\"Bad image\")\n         image.show()\n </denchmark-code>\n \n Let us know what you get when you run this!\n <denchmark-link:https://user-images.githubusercontent.com/14062641/57244400-20d0d500-6fed-11e9-81cf-6ad9d0cdf7d7.png></denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "fbomb111", "commentT": "2019-05-06T19:41:17Z", "comment_text": "\n \t\tFirst off, thank you so much for the idea on how to capture the image names and row!  That helped and led me to find that I was looking at one index after the error index.  So here is the actual image I believe is causing the issue.\n <denchmark-link:https://user-images.githubusercontent.com/482183/57249692-9a7bb980-7013-11e9-98ec-23aa4290404d.jpg></denchmark-link>\n \n And it's associated data for that row in the SFrame\n <denchmark-code>{'image': Height: 1024px\n  Width: 680px\n  Channels: 1,\n  'name': '9971996f732fce6e',\n  'annotations': [{'label': 'Window',\n    'coordinates': {'x': 340.00374,\n     'y': 688.01792,\n     'width': 679.99252,\n     'height': 571.1370239999999}}]}\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "fbomb111", "commentT": "2019-05-07T06:33:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fbomb111>@fbomb111</denchmark-link>\n  After some investigation, it seems like the  utility cannot support grayscale images. When we try to convert a grayscale image to a Pillow Image and then get the pixel data out, the shape gets registered as (height, width) and we lose the channel dimension, hence the \"tuple index out of range\" error. I'm working on a fix right now and will update this issue thread with more details. In the meantime, could you try converting all the grayscale images in your SFrame to RGB to visualize the bounding boxes on them?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "fbomb111", "commentT": "2019-05-07T19:44:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fbomb111>@fbomb111</denchmark-link>\n  Fix is up in <denchmark-link:https://github.com/apple/turicreate/pull/1845>#1845</denchmark-link>\n  !\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "fbomb111", "commentT": "2019-05-07T20:00:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/shantanuchhabra>@shantanuchhabra</denchmark-link>\n  Thanks for the fast fix!  I will update and try it out tonight and report back.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "fbomb111", "commentT": "2019-05-08T19:45:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/shantanuchhabra>@shantanuchhabra</denchmark-link>\n  Sorry to bother you, but I am having trouble checking out the latest changes.  Would you suggest:\n  to get the latest from master?\n I'm getting some errors I think related to a missing setup.py ?  Still newish to python, just enough to be dangerous.\n <denchmark-code>ERROR: Complete output from command python setup.py egg_info:\n  ERROR: Traceback (most recent call last):\n    File \"<string>\", line 1, in <module>\n    File \"/anaconda3/lib/python3.6/tokenize.py\", line 452, in open\n      buffer = _builtin_open(filename, 'rb')\n  FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/1c/whcs34_s7xjc5k2rmthb1v2c0000gq/T/pip-req-build-novgch0f/setup.py'\n  ----------------------------------------\n ERROR: Command \"python setup.py egg_info\" failed with error code 1 in /private/var/folders/1c/whcs34_s7xjc5k2rmthb1v2c0000gq/T/pip-req-build-novgch0f/\n </denchmark-code>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "fbomb111", "commentT": "2019-05-08T22:27:55Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/fbomb111>@fbomb111</denchmark-link>\n  ,\n I don't think it's possible to pip install a git repository. You could, however, clone from master, build from source, and then work with Turi Create built from source. <denchmark-link:https://github.com/apple/turicreate/blob/master/BUILD.md>Here</denchmark-link>\n  are the steps to make that happen.\n This fix will become available in our next release, which will be in a few weeks. If you don't want to wait for the next release, here is a workaround code snippet to help you convert all the grayscale images in your SFrame to RGB so you can then visualize bounding boxes on them:\n import turicreate as tc\n import numpy as np\n \n def gray2rgb(image):\n     # grayscale tc.Image -> RGB tc.Image\n     if image.channels == 1:\n         rgb_pixel_data = image.pixel_data[..., np.newaxis]\n         image_rgb =  np.concatenate(3 * (rgb_pixel_data,), axis=-1)\n         FORMAT_RAW = 2\n         return tc.Image(_image_data=image_rgb.tobytes(),\n                         _width=image_rgb.shape[1],\n                         _height=image_rgb.shape[0],\n                         _channels=image_rgb.shape[2],\n                         _format_enum=FORMAT_RAW,\n                         _image_data_size=image_rgb.size)\n     return image\n \n # Note: replace sf, \"image\", and \"annotation\"\n sf[\"converted_image\"] = sf[\"image\"].apply(gray2rgb)\n \n sf[\"bbox\"] = tc.object_detector.util.draw_bounding_boxes(sf[\"converted_image\"], sf[\"annotation\"])\n Feel free to follow up with more questions!\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "fbomb111", "commentT": "2019-05-11T03:25:47Z", "comment_text": "\n \t\tThanks for providing such a great work around!  I was finally able to draw all my bounding boxes.\n \t\t"}}}, "commit": {"commit_id": "20705de59e1552a46b9e275f27a75fdb8ff4e232", "commit_author": "Shantanu Chhabra", "commitT": "2019-05-08 01:29:59-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\unity\\python\\turicreate\\toolkits\\object_detector\\util\\_visualization.py", "file_new_name": "src\\unity\\python\\turicreate\\toolkits\\object_detector\\util\\_visualization.py", "file_complexity": {"file_NLOC": "107", "file_CCN": "18", "file_NToken": "947"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "141,142,143", "deleted_lines": null, "method_info": {"method_name": "draw_bounding_boxes", "method_params": "images,annotations,confidence_threshold", "method_startline": "95", "method_endline": "164", "method_complexity": {"method_NLOC": "11", "method_CCN": "3", "method_NToken": "102", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "141,142,143", "deleted_lines": null, "method_info": {"method_name": "draw_bounding_boxes.draw_single_image", "method_params": "row", "method_startline": "129", "method_endline": "156", "method_complexity": {"method_NLOC": "26", "method_CCN": "6", "method_NToken": "193", "method_nesting_level": "1"}}}}}}}}