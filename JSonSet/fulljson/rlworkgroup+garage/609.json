{"BR": {"BR_id": "609", "BR_author": "zhanpenghe", "BRopenT": "2019-03-29T04:27:09Z", "BRcloseT": "2019-05-06T02:49:17Z", "BR_text": {"BRsummary": "Use tf.variable_scope instead of tf.VariableScope for policies using models", "BRdescription": "\n Using tf.VariableScope will not add a new scope to the graph. This introduces bugs to model.parameters.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "zhanpenghe", "commentT": "2019-03-29T05:09:50Z", "comment_text": "\n \t\tWhen the first time model.build() is called, it creates a new tf.variable_scope by doing\n     ...\n     if not self._networks:\n             with tf.variable_scope(\n                     self._name, reuse=False) as self._variable_scope:\n    ...\n and store the tf.VariableScope for reentering.\n Which part are you referring to?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "zhanpenghe", "commentT": "2019-03-29T06:01:37Z", "comment_text": "\n \t\tSorry I think I am referring to policies with models.\n \n \n \n garage/garage/tf/policies/base2.py\n \n \n          Line 17\n       in\n       d8c279e\n \n \n \n \n \n \n  self._variable_scope = tf.VariableScope(name) \n \n \n \n \n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "zhanpenghe", "commentT": "2019-04-17T17:19:31Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ahtsan>@ahtsan</denchmark-link>\n  can you please take a look?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "zhanpenghe", "commentT": "2019-04-17T19:17:48Z", "comment_text": "\n \t\tIt's resolved by <denchmark-link:https://github.com/rlworkgroup/garage/pull/606>#606</denchmark-link>\n  by\n \n \n The issue is not that we used , but we missed the  constructor argument. We should do  but we did .\n (Reference: <denchmark-link:https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/ops/variable_scope.py#L1044>https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/ops/variable_scope.py#L1044</denchmark-link>\n )\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "zhanpenghe", "commentT": "2019-04-17T19:33:16Z", "comment_text": "\n \t\tOh sorry for not elaborating on this. In order to reproduce this problem, you can try to retrieve the model (actually policy) parameters. If this is returning parameters from other models (e.g baseline) then this flaw is still present.\n The real flaw is that is doesn't actually create a variable scope so I don't think adding reuse will resolve it.\n <denchmark-link:https://github.com/ahtsan>@ahtsan</denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "zhanpenghe", "commentT": "2019-04-29T19:03:40Z", "comment_text": "\n \t\tTensorFlow suggested this for variable_scope reentering:\n with tf.variable(name=name) as self._variable_scope:\n     ....\n \n #reenter\n with tf.variable_scope(self._variable_scope):\n     ...\n <denchmark-link:https://github.com/tensorflow/tensorflow/blob/r1.13/tensorflow/python/ops/variable_scope.py#L1985>https://github.com/tensorflow/tensorflow/blob/r1.13/tensorflow/python/ops/variable_scope.py#L1985</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "8e24d281b3f299663528034191f8f54934d5c6e7", "commit_author": "Anson Wong", "commitT": "2019-05-05 19:49:15-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "garage\\tf\\policies\\base2.py", "file_new_name": "garage\\tf\\policies\\base2.py", "file_complexity": {"file_NLOC": "62", "file_CCN": "20", "file_NToken": "277"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "17", "deleted_lines": "18", "method_info": {"method_name": "__init__", "method_params": "self,name,env_spec", "method_startline": "14", "method_endline": "18", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "30", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "garage\\tf\\policies\\categorical_conv_policy_with_model.py", "file_new_name": "garage\\tf\\policies\\categorical_conv_policy_with_model.py", "file_complexity": {"file_NLOC": "137", "file_CCN": "10", "file_NToken": "586"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "110,111", "deleted_lines": "110", "method_info": {"method_name": "_initialize", "method_params": "self", "method_startline": "107", "method_endline": "115", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "79", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "garage\\tf\\policies\\categorical_mlp_policy_with_model.py", "file_new_name": "garage\\tf\\policies\\categorical_mlp_policy_with_model.py", "file_complexity": {"file_NLOC": "114", "file_CCN": "10", "file_NToken": "564"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "84,85", "deleted_lines": "84", "method_info": {"method_name": "_initialize", "method_params": "self", "method_startline": "81", "method_endline": "90", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "88", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "garage\\tf\\policies\\deterministic_mlp_policy_with_model.py", "file_new_name": "garage\\tf\\policies\\deterministic_mlp_policy_with_model.py", "file_complexity": {"file_NLOC": "111", "file_CCN": "8", "file_NToken": "505"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "87,88", "deleted_lines": "87", "method_info": {"method_name": "_initialize", "method_params": "self", "method_startline": "84", "method_endline": "93", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "88", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "garage\\tf\\policies\\gaussian_mlp_policy_with_model.py", "file_new_name": "garage\\tf\\policies\\gaussian_mlp_policy_with_model.py", "file_complexity": {"file_NLOC": "155", "file_CCN": "10", "file_NToken": "711"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "120,121", "deleted_lines": "120", "method_info": {"method_name": "_initialize", "method_params": "self", "method_startline": "117", "method_endline": "130", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "112", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "garage\\tf\\q_functions\\discrete_mlp_q_function.py", "file_new_name": "garage\\tf\\q_functions\\discrete_mlp_q_function.py", "file_complexity": {"file_NLOC": "73", "file_CCN": "4", "file_NToken": "271"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "68,69", "deleted_lines": "54,69"}}}}}}