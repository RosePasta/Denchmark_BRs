{"BR": {"BR_id": "4810", "BR_author": "IINemo", "BRopenT": "2020-11-22T15:15:12Z", "BRcloseT": "2020-11-23T02:34:52Z", "BR_text": {"BRsummary": "GradientDescentTrainer breaks when constructed with validation_data_loader==None and learning_rate_scheduler!=None", "BRdescription": "\n <denchmark-h:h2>Checklist</denchmark-h>\n \n \n  I have verified that the issue exists against the master branch of AllenNLP.\n  I have read the relevant section in the contribution guide on reporting bugs.\n  I have checked the issues list for similar or identical bug reports.\n  I have checked the pull requests list for existing proposed fixes.\n  I have checked the CHANGELOG and the commit log to find out if the bug was already fixed in the master branch.\n  I have included in the \"Description\" section below a traceback from any exceptions related to this bug.\n  I have included in the \"Related issues or possible duplicates\" section beloew all related issues and possible duplicate issues (If there are none, check this box anyway).\n  I have included in the \"Environment\" section below the name of the operating system and Python version that I was using when I discovered this bug.\n  I have included in the \"Environment\" section below the output of pip freeze.\n  I have included in the \"Steps to reproduce\" section below a minimally reproducible example.\n \n <denchmark-h:h2>Description</denchmark-h>\n \n When you construct GradientDescentTrainer with validation_data_loader==None and learning_rate_scheduler!=None, the code\n breaks when an update step is performed for learning_rate_scheduler.  This is a typical case for training a Transformer model.\n This issue appeared since version 1.2.0 and is present now in the master branch.\n \n Python traceback:\n \n UnboundLocalErrorTraceback (most recent call last)\n <ipython-input-9-513339770b41> in <module>\n      46 \n      47 try:\n ---> 48     metrics = trainer.train()\n      49 except KeyboardInterrupt:\n      50     pass\n \n /opt/.pyenv/versions/3.7.4/lib/python3.7/site-packages/allennlp/training/trainer.py in train(self)\n     964         \"\"\"\n     965         try:\n --> 966             return self._try_train()\n     967         finally:\n     968             # make sure pending events are flushed to disk and files are closed properly\n \n /opt/.pyenv/versions/3.7.4/lib/python3.7/site-packages/allennlp/training/trainer.py in _try_train(self)\n    1080             # if it doesn't, the validation metric passed here is ignored.\n    1081             if self._learning_rate_scheduler:\n -> 1082                 self._learning_rate_scheduler.step(this_epoch_val_metric)\n    1083             if self._momentum_scheduler:\n    1084                 self._momentum_scheduler.step(this_epoch_val_metric)\n \n UnboundLocalError: local variable 'this_epoch_val_metric' referenced before assignment\n \n The problem happens because the this_epoch_val_metric on the line 987 is not initialized.\n \n \n <denchmark-h:h2>Related issues or possible duplicates</denchmark-h>\n \n \n None\n \n <denchmark-h:h2>Environment</denchmark-h>\n \n OS: Ubuntu 18.04.3 LTS\n Python version: 3.7.4\n \n Output of pip freeze:\n \n absl-py==0.8.1\n actleto==0.1.0\n alabaster==0.7.12\n allennlp==1.2.2\n allennlp-models==1.1.0\n annoy==1.16.2\n astor==0.8.0\n astroid==2.3.3\n astropy==3.2.3\n atomicwrites==1.3.0\n attrs==19.3.0\n Babel==2.7.0\n backcall==0.1.0\n bleach==3.1.0\n blis==0.2.4\n bokeh==1.4.0\n boto==2.49.0\n boto3==1.16.6\n botocore==1.19.6\n bpemb==0.3.2\n category-encoders==2.1.0\n certifi==2019.9.11\n chardet==3.0.4\n Click==7.0\n cloudpickle==1.2.2\n colorama==0.4.1\n confuse==1.0.0\n conllu==4.1\n cycler==0.10.0\n cymem==2.0.3\n Cython==0.29.14\n dask==2.8.0\n decorator==4.4.1\n deeppavlov==0.6.1\n defusedxml==0.6.0\n Deprecated==1.2.10\n distributed==2.8.0\n docopt==0.6.2\n docutils==0.15.2\n editdistance==0.5.3\n eli5==0.10.1\n en-core-web-sm==2.1.0\n entrypoints==0.3\n fastcluster==1.1.25\n fasttext==0.9.1\n fb-re2==1.0.7\n filelock==3.0.12\n fitter==1.1.11\n flair==0.6.1\n flaky==3.6.1\n Flask==1.1.1\n Flask-Cors==3.0.8\n forestci==0.3\n fsspec==0.6.0\n ftfy==5.6\n future==0.18.2\n gast==0.3.2\n gdown==3.12.2\n gensim==3.8.1\n gevent==1.4.0\n gitdb2==2.0.6\n GitPython==3.0.5\n google-pasta==0.1.8\n graphviz==0.13.2\n greenlet==0.4.15\n grpcio==1.25.0\n gym==0.15.4\n h5py==2.10.0\n hdbscan==0.8.23\n HeapDict==1.0.1\n htmlmin==0.1.12\n hydra-core==0.11.3\n hyperopt==0.2.5\n idna==2.8\n imageio==2.6.1\n imagesize==1.1.0\n imbalanced-learn==0.5.0\n imgaug==0.3.0\n importlib-metadata==0.23\n ipykernel==5.1.3\n ipython==7.9.0\n ipython-genutils==0.2.0\n ipywidgets==7.5.1\n isanlp==0.0.6\n isort==4.3.21\n itsdangerous==1.1.0\n Janome==0.4.1\n jedi==0.15.1\n Jinja2==2.10.3\n jmespath==0.9.4\n joblib==0.14.0\n json5==0.8.5\n jsonnet==0.14.0\n jsonpickle==0.9.6\n jsonschema==3.2.0\n jupyter==1.0.0\n jupyter-client==5.3.4\n jupyter-console==6.0.0\n jupyter-contrib-core==0.3.3\n jupyter-contrib-nbextensions==0.5.1\n jupyter-core==4.6.1\n jupyter-highlight-selected-word==0.2.0\n jupyter-latex-envs==1.4.6\n jupyter-nbextensions-configurator==0.4.1\n jupyterlab==1.2.3\n jupyterlab-server==1.0.6\n Keras==2.3.1\n Keras-Applications==1.0.8\n Keras-Preprocessing==1.1.0\n keras-vis==0.4.1\n kiwisolver==1.1.0\n konoha==4.6.2\n langdetect==1.0.8\n lazy-object-proxy==1.4.3\n libact==0.1.3b0\n lightgbm==2.3.1\n lime==0.1.1.36\n line-profiler==2.1.1\n llvmlite==0.30.0\n locket==0.2.0\n lxml==4.4.1\n Markdown==3.1.1\n MarkupSafe==1.1.1\n matplotlib==3.1.1\n mccabe==0.6.1\n missingno==0.4.2\n mistune==0.8.4\n mlxtend==0.17.0\n more-itertools==7.2.0\n mpld3==0.3\n msgpack==0.6.2\n munch==2.5.0\n murmurhash==1.0.2\n nbconvert==5.6.1\n nbformat==4.4.0\n networkx==2.4\n nltk==3.4.5\n nmslib==2.0.5\n nose==1.3.7\n notebook==6.0.2\n numba==0.46.0\n numexpr==2.7.0\n numpy==1.17.4\n numpydoc==0.9.1\n omegaconf==1.4.1\n opencv-python==4.1.1.26\n opencv-python-headless==4.1.1.26\n overrides==3.1.0\n packaging==19.2\n pandas==0.25.3\n pandas-profiling==2.3.0\n pandocfilters==1.4.2\n parsimonious==0.8.1\n parso==0.5.1\n partd==1.0.0\n patool==1.12\n patsy==0.5.1\n pexpect==4.7.0\n phik==0.9.8\n pickleshare==0.7.5\n Pillow==6.2.1\n plac==0.9.6\n plotly==4.3.0\n pluggy==0.13.0\n pprofile==2.0.2\n preshed==2.0.1\n progressbar==2.5\n prometheus-client==0.7.1\n prompt-toolkit==2.0.10\n protobuf==3.10.0\n psutil==5.6.5\n ptyprocess==0.6.0\n py==1.8.0\n py-cpuinfo==5.0.0\n py-rouge==1.1\n pybind11==2.4.dev4\n pydot==1.4.1\n pyglet==1.3.2\n Pygments==2.4.2\n pylint==2.4.4\n pymystem3==0.2.0\n pyparsing==2.4.5\n pyrsistent==0.15.5\n pytest==5.2.4\n pytest-pylint==0.14.1\n python-crfsuite==0.9.7\n python-dateutil==2.8.0\n pytorch-pretrained-bert==0.6.2\n pytorch-transformers==1.1.0\n pytz==2019.3\n PyWavelets==1.1.1\n PyYAML==5.1.2\n pyzmq==18.1.1\n qtconsole==4.6.0\n regex==2019.11.1\n requests==2.22.0\n responses==0.10.6\n retrying==1.3.3\n s3transfer==0.3.3\n sacred==0.8.0\n sacremoses==0.0.35\n scikit-image==0.16.2\n scikit-learn==0.21.3\n scipy==1.3.2\n seaborn==0.9.0\n segtok==1.5.10\n Send2Trash==1.5.0\n sentence-transformers==0.3.8\n sentencepiece==0.1.91\n seqeval==1.2.2\n Shapely==1.6.4.post2\n sharedmem==0.3.7\n six==1.13.0\n sklearn==0.0\n sklearn-crfsuite==0.3.6\n skorch==0.6.0\n smart-open==1.9.0\n smmap2==2.0.5\n snowballstemmer==2.0.0\n sortedcontainers==2.1.0\n spacy==2.1.9\n Sphinx==2.2.1\n sphinxcontrib-applehelp==1.0.1\n sphinxcontrib-devhelp==1.0.1\n sphinxcontrib-htmlhelp==1.0.2\n sphinxcontrib-jsmath==1.0.1\n sphinxcontrib-qthelp==1.0.2\n sphinxcontrib-serializinghtml==1.1.3\n sqlitedict==1.7.0\n sqlparse==0.3.0\n srsly==0.2.0\n statsmodels==0.10.1\n tables==3.6.1\n tabulate==0.8.6\n tblib==1.5.0\n tensorboard==1.14.0\n tensorboardX==1.9\n tensorflow-estimator==1.14.0\n tensorflow-gpu==1.14.0\n termcolor==1.1.0\n terminado==0.8.3\n testpath==0.4.4\n thinc==7.0.8\n tokenizers==0.9.3\n toolz==0.10.0\n torch==1.6.0\n torchvision==0.4.2\n tornado==6.0.3\n tqdm==4.38.0\n traitlets==4.3.3\n transformers==3.5.1\n typed-ast==1.4.0\n ujson==1.35\n Unidecode==1.1.1\n urllib3==1.25.7\n wasabi==0.4.0\n wcwidth==0.1.7\n webencodings==0.5.1\n Werkzeug==0.16.0\n widgetsnbextension==3.5.1\n word2number==1.1\n wrapt==1.11.2\n xgboost==0.90\n zict==1.0.0\n zipp==0.6.0\n \n \n \n <denchmark-h:h2>Steps to reproduce</denchmark-h>\n \n \n Example source:\n \n Can be replicated in Colab: https://colab.research.google.com/drive/1w3lhUG1zvvx8XHFcEP_921KGdZc_Ie8Y?usp=sharing\n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "IINemo", "commentT": "2020-11-22T15:45:42Z", "comment_text": "\n \t\tI prepared a pull request to fix this issue: <denchmark-link:https://github.com/allenai/allennlp/pull/4811>#4811</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "5b30658514a00e11000e648fec23be11a998bd92", "commit_author": "IINemo", "commitT": "2020-11-22 18:34:51-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "14", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "allennlp\\training\\trainer.py", "file_new_name": "allennlp\\training\\trainer.py", "file_complexity": {"file_NLOC": "1059", "file_CCN": "133", "file_NToken": "5047"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "987", "deleted_lines": "987", "method_info": {"method_name": "_try_train", "method_params": "self", "method_startline": "971", "method_endline": "1121", "method_complexity": {"method_NLOC": "108", "method_CCN": "33", "method_NToken": "835", "method_nesting_level": "1"}}}}}}}}