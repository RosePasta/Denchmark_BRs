{"BR": {"BR_id": "116", "BR_author": "Corea", "BRopenT": "2017-08-29T02:24:02Z", "BRcloseT": "2017-08-29T09:45:18Z", "BR_text": {"BRsummary": "convolution and pooling layers crashed with kernel &lt; stride", "BRdescription": "\n Sometimes we need to build convolution or pooling layer with kernel=1, stride=2 and  padding=-233(SAME). But now ncnn is crashed with this settings, it should be fixed.\n I guessed checking arguments of copy_make_border would fix this issue, but size is not appropriate after then.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Corea", "commentT": "2017-08-29T04:52:14Z", "comment_text": "\n \t\tcan not reproduce this crash with the following sample on both pc and android platform\n using the latest code on git\n <denchmark-code>int main(int argc, char *argv[])\n {\n     using namespace ncnn;\n \n     int inw = 210;\n     int inh = 133;\n     int inc = 3;\n     int outc = 8;\n \n     int ksize = 1;\n     int stride = 2;\n     int pad = -233;\n \n #if __ARM_NEON\n     Convolution_arm conv;\n #else\n     Convolution conv;\n #endif\n     conv.num_output = outc;\n     conv.kernel_size = ksize;\n     conv.dilation = 1;\n     conv.stride = stride;\n     conv.pad = pad;\n     conv.bias_term = 0;\n     conv.weight_data_size = outc*inc*ksize*ksize;\n \n     Mat bottom(inw, inh, inc);\n     Mat kernel(conv.weight_data_size);\n \n     conv.weight_data = kernel;\n \n     Mat top;\n     conv.forward(bottom, top);\n \n     int outw = top.w;\n     int outh = top.h;\n     printf(\"outw is %d, outh is %d\\n\", outw, outh);\n }\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Corea", "commentT": "2017-08-29T06:48:37Z", "comment_text": "\n \t\tBecause this problem is related to memory violation, so you can check this problem with Valgrind. Precisely, the crash will be raised in function copy_make_border_image due to src.w > dst.w or src.h > dst.h.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Corea", "commentT": "2017-08-29T07:17:54Z", "comment_text": "\n \t\tplease provide the shape( w h c ) of the bottom blob which raises this problem\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "Corea", "commentT": "2017-08-29T08:15:03Z", "comment_text": "\n \t\tMy settings were w=160, h=160 and c=20. I'm not sure about convolution layer now, but you can check on pooling layer with option -fsanitize=address for gcc. I can reproduce the crash with this code.\n #include \"mat.h\"\n #include \"layer/pooling.h\"\n \n int main(int argc, char *argv[])\n {\n     using namespace ncnn;\n \n     int inw = 160;\n     int inh = 160;\n     int inc = 40;\n     int outc = 40;\n \n     int ksize = 1;\n     int stride = 2;\n     int pad = -233;\n \n     Pooling pool;\n     pool.pooling_type = 0;\n     pool.kernel_size = ksize;\n     pool.global_pooling = 0;\n     pool.stride = stride;\n     pool.pad = pad;\n \n     Mat bottom(inw, inh, inc);\n \n     Mat top;\n     pool.forward(bottom, top);\n \n     int outw = top.w;\n     int outh = top.h;\n     printf(\"outw is %d, outh is %d\\n\", outw, outh);\n \n     return 0;\n }\n \t\t"}}}, "commit": {"commit_id": "47218db6e54884fb9cb35673a875c4e5478c5239", "commit_author": "nihuini", "commitT": "2017-08-29 17:43:43+08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\arm\\convolution_arm.cpp", "file_new_name": "src\\layer\\arm\\convolution_arm.cpp", "file_complexity": {"file_NLOC": "100", "file_CCN": "12", "file_NToken": "456"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "111,112,113,114,115,116", "deleted_lines": "111,112,113,114", "method_info": {"method_name": "ncnn::Convolution_arm::forward", "method_params": "bottom_blob,top_blob", "method_startline": "28", "method_endline": "132", "method_complexity": {"method_NLOC": "90", "method_CCN": "12", "method_NToken": "430", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\arm\\convolutiondepthwise_arm.cpp", "file_new_name": "src\\layer\\arm\\convolutiondepthwise_arm.cpp", "file_complexity": {"file_NLOC": "130", "file_CCN": "20", "file_NToken": "709"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "115,116,117,118,119,120", "deleted_lines": "115,116,117,118", "method_info": {"method_name": "ncnn::ConvolutionDepthWise_arm::forward", "method_params": "bottom_blob,top_blob", "method_startline": "32", "method_endline": "178", "method_complexity": {"method_NLOC": "119", "method_CCN": "20", "method_NToken": "681", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\arm\\pooling_arm.cpp", "file_new_name": "src\\layer\\arm\\pooling_arm.cpp", "file_complexity": {"file_NLOC": "74", "file_CCN": "23", "file_NToken": "496"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57,58,59,60,61,62,73", "deleted_lines": "57,58,59,60,71", "method_info": {"method_name": "ncnn::Pooling_arm::forward", "method_params": "bottom_blob,top_blob", "method_startline": "24", "method_endline": "108", "method_complexity": {"method_NLOC": "68", "method_CCN": "23", "method_NToken": "478", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\convolution.cpp", "file_new_name": "src\\layer\\convolution.cpp", "file_complexity": {"file_NLOC": "271", "file_CCN": "45", "file_NToken": "1735"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "281,282,283,284,285,286", "deleted_lines": "281,282,283,284", "method_info": {"method_name": "ncnn::Convolution::forward", "method_params": "bottom_blob,top_blob", "method_startline": "254", "method_endline": "362", "method_complexity": {"method_NLOC": "82", "method_CCN": "16", "method_NToken": "579", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\convolutiondepthwise.cpp", "file_new_name": "src\\layer\\convolutiondepthwise.cpp", "file_complexity": {"file_NLOC": "163", "file_CCN": "35", "file_NToken": "1045"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "110,111,112,113,114,115", "deleted_lines": "110,111,112,113", "method_info": {"method_name": "ncnn::ConvolutionDepthWise::forward", "method_params": "bottom_blob,top_blob", "method_startline": "72", "method_endline": "234", "method_complexity": {"method_NLOC": "123", "method_CCN": "27", "method_NToken": "858", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\pooling.cpp", "file_new_name": "src\\layer\\pooling.cpp", "file_complexity": {"file_NLOC": "226", "file_CCN": "49", "file_NToken": "1471"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "149,150,151,152,153,154,165,280,291", "deleted_lines": "149,150,151,152,163,278,289", "method_info": {"method_name": "ncnn::Pooling::forward", "method_params": "bottom_blob,top_blob", "method_startline": "79", "method_endline": "305", "method_complexity": {"method_NLOC": "182", "method_CCN": "44", "method_NToken": "1202", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\layer\\x86\\convolution_x86.cpp", "file_new_name": "src\\layer\\x86\\convolution_x86.cpp", "file_complexity": {"file_NLOC": "88", "file_CCN": "11", "file_NToken": "427"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "99,100,101,102,103,104", "deleted_lines": "99,100,101,102", "method_info": {"method_name": "ncnn::Convolution_x86::forward", "method_params": "bottom_blob,top_blob", "method_startline": "24", "method_endline": "120", "method_complexity": {"method_NLOC": "82", "method_CCN": "11", "method_NToken": "409", "method_nesting_level": "1"}}}}}}}}