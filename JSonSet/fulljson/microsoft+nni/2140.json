{"BR": {"BR_id": "2140", "BR_author": "arvoelke", "BRopenT": "2020-03-09T20:00:12Z", "BRcloseT": "2020-03-17T09:53:06Z", "BR_text": {"BRsummary": "Reporting multiple metrics and then resuming crashes SMAC tuner", "BRdescription": "\n Short summary about the issue/question:\n Reporting a dictionary of metrics, stopping the experiment, and then resuming it, will crash the SMAC tuner.\n How to reproduce it:\n Run an experiment that uses the SMAC tuner and contains calls of the form: nni.report_intermediate_result({'default': loss, 'other_metric': some_other_value}). Let it run for at least one trial. Run nnictl stop <experiment> and then nnictl resume <experiment>.\n Contents of dispatcher.log:\n <denchmark-code>[03/09/2020, 03:51:05 PM] INFO (nni.msg_dispatcher_base/MainThread) Start dispatcher\n [03/09/2020, 03:51:05 PM] INFO (nni.tuner/MainThread) Load checkpoint ignored by tuner, checkpoint path: /home/arvoelke/nni/experiments/NdfeH2R1/checkpoint\n [03/09/2020, 03:51:05 PM] INFO (nni.assessor/MainThread) Load checkpoint ignored by assessor, checkpoint path: /home/arvoelke/nni/experiments/NdfeH2R1/checkpoint\n [03/09/2020, 03:51:06 PM] INFO (smac_AutoML/Thread-1) update search space in SMAC.\n [03/09/2020, 03:51:06 PM] INFO (smac_AutoML/Thread-1) SMAC call: /home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/nni/__main__.py --exp_params eyJhdXRob3JOYW1lIjoiYXJ2b2Vsa2UiLCJleHBlcmltZW50TmFtZSI6IkxNVSIsInRyaWFsQ29uY3VycmVuY3kiOjEsIm1heEV4ZWNEdXJhdGlvbiI6ODYzMTM2MDAsIm1heFRyaWFsTnVtIjo5OTk5OSwidHJhaW5pbmdTZXJ2aWNlUGxhdGZvcm0iOiJsb2NhbCIsInR1bmVyIjp7ImJ1aWx0aW5UdW5lck5hbWUiOiJTTUFDIiwiY2xhc3NBcmdzIjp7Im9wdGltaXplX21vZGUiOiJtaW5pbWl6ZSJ9LCJjaGVja3BvaW50RGlyIjoiL2hvbWUvYXJ2b2Vsa2Uvbm5pL2V4cGVyaW1lbnRzL05kZmVIMlIxL2NoZWNrcG9pbnQifSwiYXNzZXNzb3IiOnsiY29kZURpciI6Ii9ob21lL2Fydm9lbGtlL2dpdC9ubmktcHl0b3JjaC1rYWxkaS9jb25maWcvLi4iLCJjbGFzc0ZpbGVOYW1lIjoiYXNzZXNzb3IucHkiLCJjbGFzc05hbWUiOiJGaXhlZE1lZGlhbnN0b3BBc3Nlc3NvciIsImNsYXNzQXJncyI6eyJvcHRpbWl6ZV9tb2RlIjoibWluaW1pemUiLCJzdGFydF9zdGVwIjoyfSwiY2hlY2twb2ludERpciI6Ii9ob21lL2Fydm9lbGtlL25uaS9leHBlcmltZW50cy9OZGZlSDJSMS9jaGVja3BvaW50In0sInZlcnNpb25DaGVjayI6dHJ1ZSwiY2x1c3Rlck1ldGFEYXRhIjpbeyJrZXkiOiJjb2RlRGlyIiwidmFsdWUiOiIvaG9tZS9hcnZvZWxrZS9naXQvbm5pLXB5dG9yY2gta2FsZGkvY29uZmlnLy4uIn0seyJrZXkiOiJjb21tYW5kIiwidmFsdWUiOiJweXRob24gcnVuX25uaS5weSBMTVUifV19\n [03/09/2020, 03:51:06 PM] PRINT INFO:   Reading scenario file: scenario.txt\n \n [03/09/2020, 03:51:06 PM] PRINT INFO:   Output to smac3-output_2020-03-09_15:51:06_571519\n \n [03/09/2020, 03:51:06 PM] PRINT INFO:   Importing data, current processing progress 0 / 109\n \n [03/09/2020, 03:51:06 PM] PRINT ERROR:  unsupported operand type(s) for +: 'float' and 'collections.OrderedDict'\n Traceback (most recent call last):\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/nni/msg_dispatcher_base.py\", line 90, in command_queue_worker\n     self.process_command(command, data)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/nni/msg_dispatcher_base.py\", line 149, in process_command\n     command_handlers[command](data)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/nni/msg_dispatcher.py\", line 118, in handle_import_data\n     self.tuner.import_data(data)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/nni/smac_tuner/smac_tuner.py\", line 332, in import_data\n     self.smbo_solver.nni_smac_receive_first_run(config, _value)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/smac/optimizer/smbo.py\", line 175, in nni_smac_receive_first_run\n     cost=reward, time=-1, status=StatusType.SUCCESS)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/smac/runhistory/runhistory.py\", line 168, in add\n     self._add(k, v, status, origin)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/smac/runhistory/runhistory.py\", line 197, in _add\n     self.incremental_update_cost(self.ids_config[k.config_id], v.cost)\n   File \"/home/arvoelke/anaconda3/envs/*/lib/python3.7/site-packages/smac/runhistory/runhistory.py\", line 256, in incremental_update_cost\n     (old_cost * n_runs) + cost) / (n_runs + 1)\n TypeError: unsupported operand type(s) for +: 'float' and 'collections.OrderedDict'\n \n [03/09/2020, 03:51:11 PM] PRINT INFO:   Dispatcher exiting...\n \n [03/09/2020, 03:51:14 PM] PRINT INFO:   Terminated by NNI manager\n </denchmark-code>\n \n nni Environment:\n \n nni version: master\n nni mode(local|pai|remote): local\n OS: Ubuntu 18.04\n python version Python 3.7.6:\n is conda or virtualenv used?: conda\n is running in docker?: no\n \n need to update document(yes/no): no\n Anything else we need to know:\n Location of call that triggers the error:\n \n \n \n nni/src/sdk/pynni/nni/smac_tuner/smac_tuner.py\n \n \n          Line 332\n       in\n       2a81b08\n \n \n \n \n \n \n  self.smbo_solver.nni_smac_receive_first_run(config, _value) \n \n \n \n \n \n Related to <denchmark-link:https://github.com/microsoft/nni/issues/2117>#2117</denchmark-link>\n  / <denchmark-link:https://github.com/microsoft/nni/pull/2121>#2121</denchmark-link>\n .\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "arvoelke", "commentT": "2020-03-11T01:26:27Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/arvoelke>@arvoelke</denchmark-link>\n  thanks for reporting this bug. This is because smac tuner does not correctly deal with final metric in dict. I will fix it soon.\n \t\t"}}}, "commit": {"commit_id": "e16c4019fbcbc5ff91bc587971212cd5303cd98c", "commit_author": "QuanluZhang", "commitT": "2020-03-17 17:53:05+08:00", "commit_complexity": {"commit_NLOC": "0.2857142857142857", "commit_CCN": "0.2857142857142857", "commit_Nprams": "0.31746031746031744"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sdk\\pynni\\nni\\bohb_advisor\\bohb_advisor.py", "file_new_name": "src\\sdk\\pynni\\nni\\bohb_advisor\\bohb_advisor.py", "file_complexity": {"file_NLOC": "416", "file_CCN": "70", "file_NToken": "2840"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "644", "deleted_lines": null, "method_info": {"method_name": "handle_import_data", "method_params": "self,data", "method_startline": "618", "method_endline": "661", "method_complexity": {"method_NLOC": "32", "method_CCN": "8", "method_NToken": "193", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sdk\\pynni\\nni\\smac_tuner\\smac_tuner.py", "file_new_name": "src\\sdk\\pynni\\nni\\smac_tuner\\smac_tuner.py", "file_complexity": {"file_NLOC": "197", "file_CCN": "47", "file_NToken": "1290"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "312", "deleted_lines": null, "method_info": {"method_name": "import_data", "method_params": "self,data", "method_startline": "292", "method_endline": "337", "method_complexity": {"method_NLOC": "35", "method_CCN": "10", "method_NToken": "238", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 10, "file_old_name": "src\\sdk\\pynni\\tests\\test_builtin_tuners.py", "file_new_name": "src\\sdk\\pynni\\tests\\test_builtin_tuners.py", "file_complexity": {"file_NLOC": "227", "file_CCN": "60", "file_NToken": "1801"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "206,207,209", "deleted_lines": null, "method_info": {"method_name": "test_grid_search", "method_params": "self", "method_startline": "204", "method_endline": "209", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "39", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "261,262,265", "deleted_lines": null, "method_info": {"method_name": "test_metis", "method_params": "self", "method_startline": "259", "method_endline": "265", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "51", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "238,239,241", "deleted_lines": null, "method_info": {"method_name": "test_batch", "method_params": "self", "method_startline": "236", "method_endline": "241", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "35", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "231,232,234", "deleted_lines": null, "method_info": {"method_name": "test_smac", "method_params": "self", "method_startline": "228", "method_endline": "234", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "219,220,221", "deleted_lines": null, "method_info": {"method_name": "test_random_search", "method_params": "self", "method_startline": "218", "method_endline": "221", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "212,213,216", "deleted_lines": null, "method_info": {"method_name": "test_tpe", "method_params": "self", "method_startline": "211", "method_endline": "216", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "37", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202", "deleted_lines": "146,150,155,158,163,168,173,177,185", "method_info": {"method_name": "import_data_test", "method_params": "self,tuner_factory,stype", "method_startline": "144", "method_endline": "202", "method_complexity": {"method_NLOC": "43", "method_CCN": "6", "method_NToken": "418", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "224,225,226", "deleted_lines": null, "method_info": {"method_name": "test_anneal", "method_params": "self", "method_startline": "223", "method_endline": "226", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "251,252,257", "deleted_lines": null, "method_info": {"method_name": "test_gp", "method_params": "self", "method_startline": "249", "method_endline": "257", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "67", "method_nesting_level": "1"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "245,246,247", "deleted_lines": null, "method_info": {"method_name": "test_evolution", "method_params": "self", "method_startline": "243", "method_endline": "247", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "1"}}}}}}}}