{"BR": {"BR_id": "4751", "BR_author": "claeyzre", "BRopenT": "2018-03-02T10:55:02Z", "BRcloseT": "2018-04-17T14:59:00Z", "BR_text": {"BRsummary": "Failed Keras Import using a Multi Inputs/Outputs model from the Keras Functional API.", "BRdescription": "\n <denchmark-h:h4>Issue Description</denchmark-h>\n \n I built a Keras Model using the Keras Functional API. This is a multi Input/Output model inspired from this <denchmark-link:https://arxiv.org/pdf/1704.05146.pdf>publication</denchmark-link>\n . Basically 8 different Inputs which consist in 4 categorical inputs and 4 textual inputs (indexed sequences).\n The textual inputs which consists of sequences of indices, are then fed into 4 different trainable Embeddings layers. the outputs of those layers are fed into convolutions and then flattened.\n When it's done the results of the 4 convolutions and the 4 categorical variables are concatenated and fed into a Dense layer with 60 hidden dims.  The results go through two different outputs (city and country) which consists in two Dense layer with Softmax activation used for prediction.\n The keras model train and predict fine in Keras(even after exporting the h5 and json and reloading it from those files), but I got this stacktrace when importing the network in DL4J:\n Exception in thread \"main\" java.lang.IllegalStateException: Mis matched lengths: [56160] != [163680] - Array 1 shape: [936, 60], array 2 shape: [2728, 60] at org.nd4j.linalg.util.LinAlgExceptions.assertSameLength(LinAlgExceptions.java:41) at org.nd4j.linalg.api.ops.BaseTransformOp.<init>(BaseTransformOp.java:174) at org.nd4j.linalg.api.ops.impl.transforms.Set.<init>(Set.java:41) at org.nd4j.linalg.api.ndarray.BaseNDArray.assign(BaseNDArray.java:1270) at org.deeplearning4j.nn.layers.BaseLayer.setParam(BaseLayer.java:204) at org.deeplearning4j.nn.modelimport.keras.KerasLayer.copyWeightsToLayer(KerasLayer.java:295) at org.deeplearning4j.nn.modelimport.keras.utils.KerasModelUtils.copyWeightsToModel(KerasModelUtils.java:76) at org.deeplearning4j.nn.modelimport.keras.KerasModel.getComputationGraph(KerasModel.java:376) at org.deeplearning4j.nn.modelimport.keras.KerasModel.getComputationGraph(KerasModel.java:362) at org.deeplearning4j.nn.modelimport.keras.KerasModelImport.importKerasModelAndWeights(KerasModelImport.java:180) \n when calling\n ComputationGraph network = KerasModelImport .importKerasModelAndWeights(\"model-v3.json\", \"model-v3.h5\", false);\n I set enforceTraining to false because I wish to do Inference only.\n I know that this is a problem of dimension but I don't know where DL4J got the value 936, as the results of the concatenation leads to a shape of 2728.\n I Used Input, Embedding, Conv1D MaxPooling1D, Concatenate and Dense as Layers. I also built a version without the Embedding, feeding them directly in Input but DL4J throws the same exception\n I used the 0.9.2 Snapshot version of DLF4.\n Thanks\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "claeyzre", "commentT": "2018-03-02T11:11:46Z", "comment_text": "\n \t\tAfter digging a bit more, the Flatten doesn't seem to work:\n 4 Convolutions yield me this kind of shape (16, 64), after the MaxPooling with pool size 2the shapes are now (8, 64). Then I use a Flatten to get a vector of dimension 512 for each of the four convolutions. Concatenating those dimensions with the 4 categorical variables yields the correct 2728. Here the Flatten doesn't seem to work, so the Concatenate take the length of the results of the max pooling (64) and 64 * 4 + the dimensions of the 4 categorical variables yield 936.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "claeyzre", "commentT": "2018-03-06T01:25:19Z", "comment_text": "\n \t\thi, which keras version do you use? 1.x.x or 2.x.x\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "claeyzre", "commentT": "2018-03-06T12:29:03Z", "comment_text": "\n \t\t2.x.x\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "claeyzre", "commentT": "2018-04-17T00:31:23Z", "comment_text": "\n \t\tCan you please post some code that reproduces this problem?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "claeyzre", "commentT": "2018-04-17T07:21:21Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/raver119>@raver119</denchmark-link>\n   I gave a dummy model <denchmark-link:https://github.com/maxpumperla>@maxpumperla</denchmark-link>\n   that fails when loading. Hopefully he will give it to you and it can serve as a Unit Test later.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "claeyzre", "commentT": "2018-04-17T11:04:22Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/claeyzre>@claeyzre</denchmark-link>\n  the flatten failure has been fixed in <denchmark-link:https://github.com/eclipse/deeplearning4j/pull/4935>#4935</denchmark-link>\n , but to make sure everything works well with your embeddings, can you please provide me with\n a) your keras script generating the model or\n b) a smaller version of your h5 model. the current one is larger than 250mb and github prevents me from checking it into our test resources. shouldn't be difficult to scale the whole thing down a little.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "claeyzre", "commentT": "2018-04-17T11:05:52Z", "comment_text": "\n \t\tp.s. see this for tests related to your case:\n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/blob/8d9bfa3129f528486e5a595f2a76d1a872e7af5b/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L37-L41>https://github.com/deeplearning4j/deeplearning4j/blob/8d9bfa3129f528486e5a595f2a76d1a872e7af5b/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L37-L41</denchmark-link>\n \n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/blob/8d9bfa3129f528486e5a595f2a76d1a872e7af5b/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/e2e/KerasModelEndToEndTest.java#L263-L266>https://github.com/deeplearning4j/deeplearning4j/blob/8d9bfa3129f528486e5a595f2a76d1a872e7af5b/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/e2e/KerasModelEndToEndTest.java#L263-L266</denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "claeyzre", "commentT": "2018-04-17T14:59:00Z", "comment_text": "\n \t\tok, with the addition of <denchmark-link:https://github.com/eclipse/deeplearning4j/pull/4936>#4936</denchmark-link>\n  this should be closed. let me know if you still have issues.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "claeyzre", "commentT": "2018-09-22T22:28:11Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "8d9bfa3129f528486e5a595f2a76d1a872e7af5b", "commit_author": "maxpumperla", "commitT": "2018-04-17 12:55:02+02:00", "commit_complexity": {"commit_NLOC": "0.75", "commit_CCN": "0.75", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-modelimport\\src\\main\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\layers\\core\\KerasFlatten.java", "file_new_name": "deeplearning4j-modelimport\\src\\main\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\layers\\core\\KerasFlatten.java", "file_complexity": {"file_NLOC": "70", "file_CCN": "14", "file_NToken": "578"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "90,91", "deleted_lines": "90", "method_info": {"method_name": "KerasFlatten::getInputPreprocessor", "method_params": "inputType", "method_startline": "70", "method_endline": "101", "method_complexity": {"method_NLOC": "29", "method_CCN": "8", "method_NToken": "250", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\e2e\\KerasModelEndToEndTest.java", "file_new_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\e2e\\KerasModelEndToEndTest.java", "file_complexity": {"file_NLOC": "365", "file_CCN": "64", "file_NToken": "3006"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "264,265,266", "deleted_lines": null, "method_info": {"method_name": "KerasModelEndToEndTest::importCnn1d", "method_params": "", "method_startline": "264", "method_endline": "266", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}}}}}}