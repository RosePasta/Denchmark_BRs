{"BR": {"BR_id": "5955", "BR_author": "AlexDBlack", "BRopenT": "2018-07-24T13:13:20Z", "BRcloseT": "2018-08-07T00:20:26Z", "BR_text": {"BRsummary": "DL4J SameDiff layers execution failing on CUDA", "BRdescription": "\n 2 failures on CUDA - passing on CPU:\n CNN1DGradientCheckTest.testCnn1DWithLocallyConnected1D and testCnnLocallyConnected2D\n <denchmark-code>o.d.g.GradientCheckUtil - Setting softmax clipping epsilon to 0.0 for class org.nd4j.linalg.lossfunctions.impl.LossMCXENT loss function to avoid spurious gradient check failures\n Error at [/repos/deeplearning4j/libnd4j/include/ops/declarable/generic/transforms/concat.cpp:121:0]:\n CONCAT op: at least one input array must be non-empty!\n \n java.lang.RuntimeException: Op validation failed\n \n \tat org.nd4j.nativeblas.Nd4jCuda$NativeOps.calculateOutputShapesDouble(Native Method)\n \tat org.nd4j.nativeblas.Nd4jCuda$NativeOps.calculateOutputShapesDouble(Nd4jCuda.java:402)\n \tat org.nd4j.linalg.jcublas.ops.executioner.CudaExecutioner.calculateOutputShape(CudaExecutioner.java:2552)\n \tat org.nd4j.linalg.api.ops.DynamicCustomOp.calculateOutputShape(DynamicCustomOp.java:555)\n \tat org.nd4j.autodiff.samediff.SameDiff.generateOutputVariableForOp(SameDiff.java:8684)\n \tat org.nd4j.linalg.api.ops.DynamicCustomOp.outputVariables(DynamicCustomOp.java:193)\n \tat org.nd4j.linalg.api.ops.DynamicCustomOp.outputVariables(DynamicCustomOp.java:175)\n \tat org.nd4j.autodiff.functions.DifferentialFunction.outputVariable(DifferentialFunction.java:401)\n \tat org.nd4j.autodiff.functions.DifferentialFunctionFactory.concat(DifferentialFunctionFactory.java:1250)\n \tat org.nd4j.autodiff.samediff.SameDiff.concat(SameDiff.java:7149)\n \tat org.nd4j.autodiff.samediff.SameDiff.concat(SameDiff.java:7134)\n \tat org.deeplearning4j.nn.conf.layers.LocallyConnected1D.defineLayer(LocallyConnected1D.java:189)\n \tat org.deeplearning4j.nn.layers.samediff.SameDiffLayer.doInit(SameDiffLayer.java:221)\n \tat org.deeplearning4j.nn.layers.samediff.SameDiffLayer.activate(SameDiffLayer.java:79)\n \tat org.deeplearning4j.nn.layers.AbstractLayer.activate(AbstractLayer.java:267)\n \tat org.deeplearning4j.nn.multilayer.MultiLayerNetwork.ffToLayerActivationsInWs(MultiLayerNetwork.java:1045)\n \tat org.deeplearning4j.nn.multilayer.MultiLayerNetwork.computeGradientAndScore(MultiLayerNetwork.java:2592)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:245)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:152)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:144)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:136)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:130)\n \tat org.deeplearning4j.gradientcheck.CNN1DGradientCheckTest.testCnn1DWithLocallyConnected1D(CNN1DGradientCheckTest.java:117)\n </denchmark-code>\n \n Edit: looks like most (all?) of the SameDiff layers are failing on CUDA, all passing on native.\n <denchmark-link:https://user-images.githubusercontent.com/2360237/43181525-00ea8a9e-9021-11e8-8f0e-17bbcf070c0b.png></denchmark-link>\n \n The other main type of failure:\n <denchmark-code>java.lang.RuntimeException: vector::_M_range_check: __n (which is 0) >= this->size() (which is 0)\n \n \tat org.nd4j.nativeblas.Nd4jCuda$NativeOps.calculateOutputShapesDouble(Native Method)\n \tat org.nd4j.nativeblas.Nd4jCuda$NativeOps.calculateOutputShapesDouble(Nd4jCuda.java:402)\n \tat org.nd4j.linalg.jcublas.ops.executioner.CudaExecutioner.calculateOutputShape(CudaExecutioner.java:2552)\n \tat org.nd4j.linalg.api.ops.impl.transforms.arithmetic.bp.BaseArithmeticBackpropOp.calculateOutputShape(BaseArithmeticBackpropOp.java:46)\n \tat org.nd4j.autodiff.samediff.SameDiff.generateOutputVariableForOp(SameDiff.java:8684)\n \tat org.nd4j.linalg.api.ops.DynamicCustomOp.outputVariables(DynamicCustomOp.java:193)\n \tat org.nd4j.linalg.api.ops.DynamicCustomOp.outputVariables(DynamicCustomOp.java:175)\n \tat org.nd4j.autodiff.functions.DifferentialFunctionFactory.addBp(DifferentialFunctionFactory.java:1641)\n \tat org.nd4j.linalg.api.ops.impl.transforms.arithmetic.AddOp.doDiff(AddOp.java:62)\n \tat org.nd4j.autodiff.functions.DifferentialFunction.diff(DifferentialFunction.java:554)\n \tat org.nd4j.autodiff.samediff.SameDiff$3.define(SameDiff.java:9291)\n \tat org.nd4j.autodiff.samediff.SameDiff.defineFunction(SameDiff.java:9108)\n \tat org.nd4j.autodiff.samediff.SameDiff.defineFunction(SameDiff.java:9092)\n \tat org.nd4j.autodiff.samediff.SameDiff.createGradFunction(SameDiff.java:9203)\n \tat org.nd4j.autodiff.samediff.SameDiff.execBackwards(SameDiff.java:9170)\n \tat org.deeplearning4j.nn.layers.samediff.SameDiffLayer.backpropGradient(SameDiffLayer.java:113)\n \tat org.deeplearning4j.nn.multilayer.MultiLayerNetwork.calcBackpropGradients(MultiLayerNetwork.java:1773)\n \tat org.deeplearning4j.nn.multilayer.MultiLayerNetwork.computeGradientAndScore(MultiLayerNetwork.java:2526)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:245)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:152)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:144)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:136)\n \tat org.deeplearning4j.gradientcheck.GradientCheckUtil.checkGradients(GradientCheckUtil.java:130)\n \tat org.deeplearning4j.nn.layers.samediff.TestSameDiffDense.gradientCheck(TestSameDiffDense.java:424)\n </denchmark-code>\n \n <denchmark-code></denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AlexDBlack", "commentT": "2018-08-06T13:42:57Z", "comment_text": "\n \t\tFixes were merged to master. Please confirm problem solved.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "AlexDBlack", "commentT": "2018-08-07T00:20:26Z", "comment_text": "\n \t\tAll samediff tests confirmed passing on CUDA - with one exception: SameDiffOutput (JVM crash - issue incoming)\n CNN1DGradientCheckTest and LocallyConnectedLayerTest also confirmed passing.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "AlexDBlack", "commentT": "2018-09-21T10:21:29Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "14d0c3fb0d2c5580132da267f03ad87294dab272", "commit_author": "raver119", "commitT": "2018-08-06 06:42:24-07:00", "commit_complexity": {"commit_NLOC": "0.625", "commit_CCN": "0.625", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "libnd4j\\blas\\cuda\\NativeOps.cu", "file_new_name": "libnd4j\\blas\\cuda\\NativeOps.cu", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "6304,6305,6307,6308,6310,6311,6312,6313,6314,6315,6316,6317,6318,6359,6399,6410", "deleted_lines": "6304,6305,6306,6307,6308,6310,6311,6312,6314,6315,6356,6395,6405,6406"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\autodiff\\samediff\\SameDiffOpExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\autodiff\\samediff\\SameDiffOpExecutioner.java", "file_complexity": {"file_NLOC": "264", "file_CCN": "62", "file_NToken": "1556"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "580,581,582", "deleted_lines": null, "method_info": {"method_name": "SameDiffOpExecutioner::isVerbose", "method_params": "", "method_startline": "580", "method_endline": "582", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "585,586,587", "deleted_lines": null, "method_info": {"method_name": "SameDiffOpExecutioner::isDebug", "method_params": "", "method_startline": "585", "method_endline": "587", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\linalg\\api\\ops\\executioner\\DefaultOpExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\linalg\\api\\ops\\executioner\\DefaultOpExecutioner.java", "file_complexity": {"file_NLOC": "572", "file_CCN": "170", "file_NToken": "4009"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "589,590,591,592,593,594,595,596,597", "deleted_lines": "563", "method_info": {"method_name": "DefaultOpExecutioner::validateDataType", "method_params": "expectedType,op", "method_startline": "561", "method_endline": "597", "method_complexity": {"method_NLOC": "29", "method_CCN": "18", "method_NToken": "455", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "780,781,782", "deleted_lines": null, "method_info": {"method_name": "DefaultOpExecutioner::isDebug", "method_params": "", "method_startline": "780", "method_endline": "782", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "599,600,601,602,603,604,605,606,607,608,609,610", "deleted_lines": null, "method_info": {"method_name": "DefaultOpExecutioner::firstX", "method_params": "array,x", "method_startline": "599", "method_endline": "611", "method_complexity": {"method_NLOC": "11", "method_CCN": "3", "method_NToken": "95", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "516,517,518,519,520,521,522", "deleted_lines": null, "method_info": {"method_name": "DefaultOpExecutioner::profilingHookOut", "method_params": "op,timeStart", "method_startline": "490", "method_endline": "523", "method_complexity": {"method_NLOC": "32", "method_CCN": "10", "method_NToken": "193", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "775,776,777", "deleted_lines": null, "method_info": {"method_name": "DefaultOpExecutioner::isVerbose", "method_params": "", "method_startline": "775", "method_endline": "777", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\linalg\\api\\ops\\executioner\\OpExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-api-parent\\nd4j-api\\src\\main\\java\\org\\nd4j\\linalg\\api\\ops\\executioner\\OpExecutioner.java", "file_complexity": {"file_NLOC": "85", "file_CCN": "0", "file_NToken": "626"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "62,63,64,65,66,67,68,69,70,71,72,73", "deleted_lines": null}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-cuda\\src\\main\\java\\org\\nd4j\\linalg\\jcublas\\ops\\executioner\\CudaExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-cuda\\src\\main\\java\\org\\nd4j\\linalg\\jcublas\\ops\\executioner\\CudaExecutioner.java", "file_complexity": {"file_NLOC": "2207", "file_CCN": "491", "file_NToken": "28406"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2896", "deleted_lines": null, "method_info": {"method_name": "CudaExecutioner::enableDebugMode", "method_params": "reallyEnable", "method_startline": "2895", "method_endline": "2898", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "2902", "deleted_lines": null, "method_info": {"method_name": "CudaExecutioner::enableVerboseMode", "method_params": "reallyEnable", "method_startline": "2901", "method_endline": "2904", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "2522,2523,2524,2525,2526,2527,2528", "deleted_lines": null, "method_info": {"method_name": "CudaExecutioner::calculateOutputShape", "method_params": "op", "method_startline": "2514", "method_endline": "2599", "method_complexity": {"method_NLOC": "59", "method_CCN": "22", "method_NToken": "802", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "812,813,814", "deleted_lines": "812", "method_info": {"method_name": "CudaExecutioner::exec", "method_params": "op", "method_startline": "794", "method_endline": "831", "method_complexity": {"method_NLOC": "32", "method_CCN": "12", "method_NToken": "244", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-cuda\\src\\main\\java\\org\\nd4j\\linalg\\jcublas\\ops\\executioner\\CudaGridExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-cuda\\src\\main\\java\\org\\nd4j\\linalg\\jcublas\\ops\\executioner\\CudaGridExecutioner.java", "file_complexity": {"file_NLOC": "628", "file_CCN": "190", "file_NToken": "5956"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "123,124,125,126", "deleted_lines": "123", "method_info": {"method_name": "CudaGridExecutioner::exec", "method_params": "op", "method_startline": "114", "method_endline": "141", "method_complexity": {"method_NLOC": "19", "method_CCN": "7", "method_NToken": "139", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-native\\src\\main\\java\\org\\nd4j\\linalg\\cpu\\nativecpu\\ops\\NativeOpExecutioner.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-backend-impls\\nd4j-native\\src\\main\\java\\org\\nd4j\\linalg\\cpu\\nativecpu\\ops\\NativeOpExecutioner.java", "file_complexity": {"file_NLOC": "1486", "file_CCN": "356", "file_NToken": "17951"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1887", "deleted_lines": null, "method_info": {"method_name": "NativeOpExecutioner::enableVerboseMode", "method_params": "reallyEnable", "method_startline": "1886", "method_endline": "1889", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1881", "deleted_lines": null, "method_info": {"method_name": "NativeOpExecutioner::enableDebugMode", "method_params": "reallyEnable", "method_startline": "1880", "method_endline": "1883", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "21", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "nd4j\\nd4j-backends\\nd4j-tests\\src\\test\\java\\org\\nd4j\\linalg\\shape\\EmptyTests.java", "file_new_name": "nd4j\\nd4j-backends\\nd4j-tests\\src\\test\\java\\org\\nd4j\\linalg\\shape\\EmptyTests.java", "file_complexity": {"file_NLOC": "67", "file_CCN": "6", "file_NToken": "616"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100", "deleted_lines": null, "method_info": {"method_name": "EmptyTests::testConcat_1", "method_params": "", "method_startline": "83", "method_endline": "100", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "205", "method_nesting_level": "1"}}}}}}}}