{"BR": {"BR_id": "5981", "BR_author": "AlexDBlack", "BRopenT": "2018-07-26T23:35:35Z", "BRcloseT": "2018-07-27T05:47:03Z", "BR_text": {"BRsummary": "DL4J: Output workspace issue with one layer", "BRdescription": "\n \n @tristandupont\n Hello, I did some tests of the new enhancement deeplearning4j/deeplearning4j#5932. I found an issue with a very simple computation graph. When an output layer is connected to an input, I got the following exception: java.lang.IllegalStateException: Expected output workspace to still be openat end of outputOfLayerDetached, but. When we had an intermediate layer there is no more exception.\n Here is a piece of code to reproduce the issue:\n \n <denchmark-code>    @Test\n     public void testSimpleOutputWorkspace() {\n         final MemoryWorkspace workspace = Nd4j.getWorkspaceManager().getWorkspaceForCurrentThread(\"ExternalTestWorkspace\");\n \n         final INDArray input = Nd4j.rand(1, 30);\n \n         final ComputationGraphConfiguration computationGraphConfiguration = new NeuralNetConfiguration.Builder()\n                 .graphBuilder()\n                 .addInputs(\"state\")\n                 .addLayer(\"value_output\", new OutputLayer.Builder().nIn(30).nOut(1).build(), \"state\")\n                 .setOutputs(\"value_output\")\n                 .build();\n \n         final ComputationGraph computationGraph = new ComputationGraph(computationGraphConfiguration);\n         computationGraph.init();\n \n         try (final MemoryWorkspace ws = workspace.notifyScopeEntered()) {\n             computationGraph.output(false, ws, input);\n         }\n     }\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AlexDBlack", "commentT": "2018-09-21T12:59:02Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "57806be34ed0d4fed3b8312d6db265386728ca38", "commit_author": "Alex Black", "commitT": "2018-07-27 15:47:03+10:00", "commit_complexity": {"commit_NLOC": "0.8484848484848485", "commit_CCN": "0.8181818181818182", "commit_Nprams": "0.8181818181818182"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "deeplearning4j\\deeplearning4j-core\\src\\test\\java\\org\\deeplearning4j\\nn\\misc\\WorkspaceTests.java", "file_new_name": "deeplearning4j\\deeplearning4j-core\\src\\test\\java\\org\\deeplearning4j\\nn\\misc\\WorkspaceTests.java", "file_complexity": {"file_NLOC": "452", "file_CCN": "46", "file_NToken": "4560"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587", "deleted_lines": null, "method_info": {"method_name": "WorkspaceTests::testSimpleOutputWorkspaceMLN", "method_params": "", "method_startline": "571", "method_endline": "587", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "112", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "548", "deleted_lines": "540", "method_info": {"method_name": "WorkspaceTests::testOutputWorkspace", "method_params": "", "method_startline": "485", "method_endline": "548", "method_complexity": {"method_NLOC": "51", "method_CCN": "5", "method_NToken": "490", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568", "deleted_lines": null, "method_info": {"method_name": "WorkspaceTests::testSimpleOutputWorkspace", "method_params": "", "method_startline": "550", "method_endline": "568", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "131", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j\\deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\ComputationGraph.java", "file_new_name": "deeplearning4j\\deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\ComputationGraph.java", "file_complexity": {"file_NLOC": "2722", "file_CCN": "682", "file_NToken": "21636"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2251,2252,2253,2254,2255,2260,2261,2264,2265,2266,2267,2268", "deleted_lines": "2251,2252,2257,2260,2261,2263", "method_info": {"method_name": "ComputationGraph::outputOfLayersDetached", "method_params": "train,fwdPassType,layerIndexes,features,fMask,lMasks,clearLayerInputs,detachedInputs,outputWorkspace", "method_startline": "2113", "method_endline": "2363", "method_complexity": {"method_NLOC": "185", "method_CCN": "44", "method_NToken": "1451", "method_nesting_level": "1"}}}}}}}}