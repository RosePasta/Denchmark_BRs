{"BR": {"BR_id": "4899", "BR_author": "fincken", "BRopenT": "2018-04-06T18:22:44Z", "BRcloseT": "2018-04-17T14:53:48Z", "BR_text": {"BRsummary": "Keras import: shape issue with Embedding layer", "BRdescription": "\n Hi.\n I've got a model trained in keras that I'd like to use in DL4J, but I'm getting this error message when trying to import:\n Exception in thread \"main\" java.lang.IllegalStateException: Mis matched lengths: [4096] != [385024] - Array 1 shape: [32, 128], array 2 shape: [3008, 128] at org.nd4j.linalg.util.LinAlgExceptions.assertSameLength(LinAlgExceptions.java:42) at org.nd4j.linalg.api.ops.BaseTransformOp.<init>(BaseTransformOp.java:174) at org.nd4j.linalg.api.ops.impl.transforms.Set.<init>(Set.java:43) at org.nd4j.linalg.api.ndarray.BaseNDArray.assign(BaseNDArray.java:1274) at org.deeplearning4j.nn.layers.BaseLayer.setParam(BaseLayer.java:204) at org.deeplearning4j.nn.modelimport.keras.KerasLayer.copyWeightsToLayer(KerasLayer.java:296) at org.deeplearning4j.nn.modelimport.keras.utils.KerasModelUtils.copyWeightsToModel(KerasModelUtils.java:76) at org.deeplearning4j.nn.modelimport.keras.KerasSequentialModel.getMultiLayerNetwork(KerasSequentialModel.java:228) at org.deeplearning4j.nn.modelimport.keras.KerasSequentialModel.getMultiLayerNetwork(KerasSequentialModel.java:215) at org.deeplearning4j.nn.modelimport.keras.KerasModelImport.importKerasSequentialModelAndWeights(KerasModelImport.java:142) at test.KerasImportTestClass.main(KerasImportTestClass.java:12)\n <denchmark-link:https://gist.github.com/fincken/b1dbae489bed2e6fbf5d90aedbfc3cf8>Here's the model</denchmark-link>\n \n The code running is just the import statement:\n <denchmark-link:https://gist.github.com/fincken/76cfc73d0edc3cb9f58fc7189840fa7c>GIST</denchmark-link>\n \n I'm running the most recent 1.0.0-alpha build of dl4j.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "fincken", "commentT": "2018-04-06T19:16:16Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fincken>@fincken</denchmark-link>\n  thanks for reporting this. that is due to improper handling of the  argument for keras embedding layers upon import. this causes the shape mismatch\n 4096 != 4096 * 94 and 32 != 32 * 94 when setting weights for the imported layer.\n Thanks for providing the model as well, should make for a good unit test. I'll let you know about progress on this.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "fincken", "commentT": "2018-04-13T10:17:19Z", "comment_text": "\n \t\tI tried doing the embedding beforehand, turning the input into (20,100) shapes. It still failes to load even without the Embedding layer, so there might be an improper handling on several layertypes.\n Exception in thread \"main\" java.lang.IllegalStateException: Mis matched lengths: [4096] != [57344] - Array 1 shape: [32, 128], array 2 shape: [448, 128] at org.nd4j.linalg.util.LinAlgExceptions.assertSameLength(LinAlgExceptions.java:42) at org.nd4j.linalg.api.ops.BaseTransformOp.<init>(BaseTransformOp.java:174) at org.nd4j.linalg.api.ops.impl.transforms.Set.<init>(Set.java:43) at org.nd4j.linalg.api.ndarray.BaseNDArray.assign(BaseNDArray.java:1274) at org.deeplearning4j.nn.layers.BaseLayer.setParam(BaseLayer.java:204) at org.deeplearning4j.nn.modelimport.keras.KerasLayer.copyWeightsToLayer(KerasLayer.java:296) at org.deeplearning4j.nn.modelimport.keras.utils.KerasModelUtils.copyWeightsToModel(KerasModelUtils.java:76) at org.deeplearning4j.nn.modelimport.keras.KerasSequentialModel.getMultiLayerNetwork(KerasSequentialModel.java:228) at org.deeplearning4j.nn.modelimport.keras.KerasSequentialModel.getMultiLayerNetwork(KerasSequentialModel.java:215) at org.deeplearning4j.nn.modelimport.keras.KerasModelImport.importKerasSequentialModelAndWeights(KerasModelImport.java:142) at test.KerasImportTestClass.main(KerasImportTestClass.java:12)\n current model that fails supplied here:\n <denchmark-link:https://gist.github.com/fincken/28116f33f37ac630848774bcaf8a12ab>GIST</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "fincken", "commentT": "2018-04-16T15:02:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fincken>@fincken</denchmark-link>\n  yes, handling reshaping properly is a bit tricky. If you don't mind I open another ticket for the non-embedding case and rename this slightly. I don't want to mix too many things in one issue, otherwise we risk forgetting about a case. thanks.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "fincken", "commentT": "2018-04-17T14:55:00Z", "comment_text": "\n \t\tI've addressed this on master. There's a unit test that uses the exact same model you provided:\n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L52-L56>https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L52-L56</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "fincken", "commentT": "2018-09-22T22:28:13Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "4f2079cfcc86dd5b74a9cfcf0ea022691969a471", "commit_author": "maxpumperla", "commitT": "2018-04-17 16:52:51+02:00", "commit_complexity": {"commit_NLOC": "0.375", "commit_CCN": "0.375", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\KerasWeightSettingTests.java", "file_new_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\KerasWeightSettingTests.java", "file_complexity": {"file_NLOC": "181", "file_CCN": "24", "file_NToken": "1714"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "51,52,53,54,55,56,57", "deleted_lines": null, "method_info": {"method_name": "KerasWeightSettingTests::testSimpleLayersWithWeights", "method_params": "", "method_startline": "23", "method_endline": "89", "method_complexity": {"method_NLOC": "51", "method_CCN": "10", "method_NToken": "406", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "181,182,183", "deleted_lines": null, "method_info": {"method_name": "KerasWeightSettingTests::importEmbeddingConv1DExtended", "method_params": "modelPath", "method_startline": "181", "method_endline": "183", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\scripts\\embedding_conv1d_extended.py", "file_complexity": {"file_NLOC": "35", "file_CCN": "0", "file_NToken": "291"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\scripts\\generate_files.sh", "file_new_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\scripts\\generate_files.sh", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "25,26,39,49,50,51", "deleted_lines": "37,47"}}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "deeplearning4j-modelimport\\src\\test\\resources\\weights\\embedding_conv1d_extended_tensorflow_2.h5", "file_new_name": "deeplearning4j-modelimport\\src\\test\\resources\\weights\\embedding_conv1d_extended_tensorflow_2.h5", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "deeplearning4j-modelimport\\src\\test\\resources\\weights\\embedding_conv1d_extended_theano_2.h5", "file_new_name": "deeplearning4j-modelimport\\src\\test\\resources\\weights\\embedding_conv1d_extended_theano_2.h5", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}}}}