{"BR": {"BR_id": "1833", "BR_author": "prihoda", "BRopenT": "2020-03-12T19:42:38Z", "BRcloseT": "2020-03-17T17:08:31Z", "BR_text": {"BRsummary": "Calculating perplexity throws OverflowError for high loss values", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n OverflowError is thrown when calculating perplexity for high losses\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior (always include the command you ran):\n \n Run any task with high-enough loss (e.g. sentence_prediction task with --regression-target with very high values)\n Get an OverflowError after first training epoch:\n \n <denchmark-code>Traceback (most recent call last):\n   File \"/SFS/user/wp/prihodad/git/oas-training/data/examples/biophysical_properties/condaenv/bin/fairseq-train\", line 11, in <module>\n     load_entry_point('fairseq', 'console_scripts', 'fairseq-train')()\n   File \"/SFS/user/wp/prihodad/git/fairseq/fairseq_cli/train.py\", line 321, in cli_main\n     main(args)\n   File \"/SFS/user/wp/prihodad/git/fairseq/fairseq_cli/train.py\", line 96, in main\n     train(args, trainer, task, epoch_itr)\n   File \"/SFS/user/wp/prihodad/git/oas-training/condaenv/lib/python3.7/contextlib.py\", line 74, in inner\n     return func(*args, **kwds)\n   File \"/SFS/user/wp/prihodad/git/fairseq/fairseq_cli/train.py\", line 203, in train\n     stats = get_training_stats(metrics.get_smoothed_values('train'))\n   File \"/SFS/user/wp/prihodad/git/fairseq/fairseq_cli/train.py\", line 212, in get_training_stats\n     stats['ppl'] = utils.get_perplexity(stats['nll_loss'])\n   File \"/SFS/user/wp/prihodad/git/fairseq/fairseq/utils.py\", line 349, in get_perplexity\n     return safe_round(base**loss, round)\n OverflowError: (34, 'Numerical result out of range')\n </denchmark-code>\n \n <denchmark-h:h4>Code sample</denchmark-h>\n \n \n \n \n fairseq/fairseq/utils.py\n \n \n         Lines 346 to 349\n       in\n       5028ed1\n \n \n \n \n \n \n  def get_perplexity(loss, round=2, base=2): \n \n \n \n  if loss is None: \n \n \n \n  return 0. \n \n \n \n  return safe_round(base**loss, round) \n \n \n \n \n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n Show 'inf' in case ppl causes an overflow error\n \t"}, "comments": {}}, "commit": {"commit_id": "d865218d52ba8984c66c7af2c4d54e44cfb26615", "commit_author": "David P\u0159\u00edhoda", "commitT": "2020-03-17 10:08:33-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "fairseq\\utils.py", "file_new_name": "fairseq\\utils.py", "file_complexity": {"file_NLOC": "340", "file_CCN": "109", "file_NToken": "2527"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "349,350,351,352", "deleted_lines": "349", "method_info": {"method_name": "get_perplexity", "method_params": "loss,round,base", "method_startline": "346", "method_endline": "352", "method_complexity": {"method_NLOC": "7", "method_CCN": "3", "method_NToken": "40", "method_nesting_level": "0"}}}}}}}}