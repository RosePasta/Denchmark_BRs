{"BR": {"BR_id": "1880", "BR_author": "tonylekhtman", "BRopenT": "2020-03-22T14:24:39Z", "BRcloseT": "2020-06-22T22:29:08Z", "BR_text": {"BRsummary": "Print Alignment in hub_utils not working", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n I can't use the print_alignment option when using the TransformerModel translate option.\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior (always include the command you ran):\n <denchmark-code>from fairseq.models.transformer import TransformerModel\n zh2en = TransformerModel.from_pretrained(\n   '/path/to/checkpoints',\n   checkpoint_file='checkpoint_best.pt',\n   data_name_or_path='data-bin/wmt17_zh_en_full',\n   bpe='subword_nmt',\n   bpe_codes='data-bin/wmt17_zh_en_full/zh.code'\n )\n zh2en.translate('\u4f60\u597d \u4e16\u754c', verbose=True,print_alignment=True)\n </denchmark-code>\n \n <denchmark-h:h4>Code sample</denchmark-h>\n \n <denchmark-code>from fairseq.models.transformer import TransformerModel\n zh2en = TransformerModel.from_pretrained(\n   '/path/to/checkpoints',\n   checkpoint_file='checkpoint_best.pt',\n   data_name_or_path='data-bin/wmt17_zh_en_full',\n   bpe='subword_nmt',\n   bpe_codes='data-bin/wmt17_zh_en_full/zh.code'\n )\n zh2en.translate('\u4f60\u597d \u4e16\u754c', verbose=True,print_alignment=True)\n </denchmark-code>\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n I want it to print the alignment row to console just as the fairseq-generate script does.\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n fairseq 0.9\n PyTorch 1.4\n OS (e.g., Linux): Linux\n How you installed fairseq (pip, source): pip\n Python version: 3.6.8\n CUDA/cuDNN version: cuda 10.1\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "tonylekhtman", "commentT": "2020-03-22T16:04:48Z", "comment_text": "\n \t\thuh, I've just stumbled upon the exact same problem.\n I would like to use alignments and searched in the codebase on how to get them.\n I found this:\n \n \n \n fairseq/fairseq/hub_utils.py\n \n \n          Line 186\n       in\n       42f65d6\n \n \n \n \n \n \n  if hypo['alignment'] is not None and getarg('print_alignment', False): \n \n \n \n \n \n It looks like alignments should be printed if both verbose and print_alignment are set to True.\n So I tried the following sample code:\n <denchmark-code>import torch\n \n en2fr = torch.hub.load('pytorch/fairseq', 'transformer.wmt14.en-fr', tokenizer='moses', bpe='subword_nmt')\n fr = en2fr.translate('Hello world!', beam=5, verbose=True, print_alignment=True)\n </denchmark-code>\n \n and it produces the error message:\n AttributeError: 'list' object has no attribute 'int'\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "tonylekhtman", "commentT": "2020-03-22T16:06:50Z", "comment_text": "\n \t\tAfter some more browsing of the codebase, I made a workaround. Rewrite the last line of the sample method like this:\n <denchmark-code>    def sample(self, sentences: List[str], beam: int = 1, verbose: bool = False, **kwargs) -> List[str]:\n         if isinstance(sentences, str):\n             return self.sample([sentences], beam=beam, verbose=verbose, **kwargs)[0]\n         tokenized_sentences = [self.encode(sentence) for sentence in sentences]\n         batched_hypos = self.generate(tokenized_sentences, beam, verbose, **kwargs)\n         return list(zip([self.decode(hypos[0]['tokens']) for hypos in batched_hypos], [hypos[0]['alignment'] for hypos in batched_hypos]))\n </denchmark-code>\n \n and it will return both the translation and the alignment.\n Here is the line of code to be edited as a permalink:\n \n \n \n fairseq/fairseq/hub_utils.py\n \n \n          Line 133\n       in\n       42f65d6\n \n \n \n \n \n \n  return [self.decode(hypos[0]['tokens']) for hypos in batched_hypos] \n \n \n \n \n \n Please note though that this will still only work if you pass in print_alignment=True as one of the kwargs.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "tonylekhtman", "commentT": "2020-03-23T10:21:55Z", "comment_text": "\n \t\tFrom what i see the problematic line is:\n \n \n \n fairseq/fairseq/hub_utils.py\n \n \n          Line 188\n       in\n       42f65d6\n \n \n \n \n \n \n  ' '.join(map(lambda x: str(utils.item(x)), hypo['alignment'].int().cpu())) \n \n \n \n \n \n it should instead be:\n  ' '.join(['{}-{}'.format(src_idx, tgt_idx) for src_idx, tgt_idx in hypo['alignment'])\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "tonylekhtman", "commentT": "2020-06-09T17:52:59Z", "comment_text": "\n \t\tAny updates? Can I help?\n \t\t"}}}, "commit": {"commit_id": "a9cb84df689d4e9343085d2434087c1b308a68a7", "commit_author": "Tony Lekhtman", "commitT": "2020-06-22 15:28:57-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "fairseq\\hub_utils.py", "file_new_name": "fairseq\\hub_utils.py", "file_complexity": {"file_NLOC": "207", "file_CCN": "36", "file_NToken": "1770"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "192", "deleted_lines": "192"}}}}}}