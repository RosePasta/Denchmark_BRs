{"BR": {"BR_id": "989", "BR_author": "co42", "BRopenT": "2020-08-13T10:16:12Z", "BRcloseT": "2020-08-14T18:25:32Z", "BR_text": {"BRsummary": "cli throw RecursionError when using --enable-microbatch", "BRdescription": "\n Describe the bug\n When I use the cli with serve-gunicorn --enable-microbatch I got:\n <denchmark-code>Traceback (most recent call last):\n   File \"<string>\", line 1, in <module>\n   File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/lib/python3.8/multiprocessing/spawn.py\", line 116, in spawn_main\n     exitcode = _main(fd, parent_sentinel)\n   File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/lib/python3.8/multiprocessing/spawn.py\", line 126, in _main\n     self = reduction.pickle.load(from_parent)\n   File \"/Users/cregal/ovh/serving-backends/venv/lib/python3.8/site-packages/gunicorn/config.py\", line 55, in __getattr__\n     if name not in self.settings:\n   File \"/Users/cregal/ovh/serving-backends/venv/lib/python3.8/site-packages/gunicorn/config.py\", line 55, in __getattr__\n     if name not in self.settings:\n   File \"/Users/cregal/ovh/serving-backends/venv/lib/python3.8/site-packages/gunicorn/config.py\", line 55, in __getattr__\n     if name not in self.settings:\n   [Previous line repeated 993 more times]\n RecursionError: maximum recursion depth exceeded\n </denchmark-code>\n \n To Reproduce\n use the option --enable-microbatch with the cli:\n bentoml serve-gunicorn --enable-microbatch myservice\n Environment:\n \n MacOS 10.15.6\n Python 3.8.2, BentoML-0.8.5, gunicorn 20.0.4\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "co42", "commentT": "2020-08-13T22:35:42Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/co42>@co42</denchmark-link>\n  Thank you for reporting.  I can reproduce it locally and I am looking into this.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "co42", "commentT": "2020-08-14T11:20:22Z", "comment_text": "\n \t\tThis is a bug under extreme conditions, which needs to be met at the same time:\n \n Use multiprocessing to start the gunicorn application.\n Python >= 3.8\n The platform is MacOS\n \n Reference:\n \n https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods\n https://github.com/benoitc/gunicorn/blob/20.0.4/gunicorn/config.py#L54 (which actually caused the RecursionError)\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "co42", "commentT": "2020-08-14T13:10:53Z", "comment_text": "\n \t\tMore details:\n For MacOS, before Python3.8, the multiprocessing module starts new processes in fork mode by default, and starts new processes in spawn mode by default since 3.8.\n The latter will use pickle to pass objects between processes.\n And because of the use of  in <denchmark-link:https://github.com/benoitc/gunicorn/blob/20.0.4/gunicorn/config.py#L54>https://github.com/benoitc/gunicorn/blob/20.0.4/gunicorn/config.py#L54</denchmark-link>\n , the magic methods  and  required by pickle to reconstruct the Config object was covered, Which in turn caused the RecursionError.\n \t\t"}}}, "commit": {"commit_id": "2cba20cfc5256470bc486b9cf9f65175eb64aa03", "commit_author": "bojiang", "commitT": "2020-08-14 11:25:31-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "bentoml\\cli\\bento_service.py", "file_new_name": "bentoml\\cli\\bento_service.py", "file_complexity": {"file_NLOC": "348", "file_CCN": "36", "file_NToken": "1633"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "288", "deleted_lines": "288", "method_info": {"method_name": "create_bento_service_cli", "method_params": "pip_installed_bundle_path", "method_startline": "153", "method_endline": "434", "method_complexity": {"method_NLOC": "143", "method_CCN": "2", "method_NToken": "634", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bentoml\\server\\marshal_server.py", "file_new_name": "bentoml\\server\\marshal_server.py", "file_complexity": {"file_NLOC": "64", "file_CCN": "9", "file_NToken": "377"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "18,25,26,27,28,29,30,31,32,33,34,35", "deleted_lines": null}}}}}}