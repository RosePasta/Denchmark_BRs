{"BR": {"BR_id": "1403", "BR_author": "lucascott", "BRopenT": "2021-01-13T09:43:29Z", "BRcloseT": "2021-01-14T04:19:33Z", "BR_text": {"BRsummary": "Failure to containerize model if build-arg value contains multiple `=` characters", "BRdescription": "\n Describe the bug\n Containerization fails due to unpacking issue when passing the --build-arg argument with value including multiple = characters.\n In particular, the string split operation in <denchmark-link:https://github.com/bentoml/BentoML/blob/d8ae9490a834e1aab371a2b69e937acb5c86f19d/bentoml/cli/bento_service.py#L384>bento_service.containerize()</denchmark-link>\n  fails to assign the resulting values to variables for cases when the input is split into >2 tokens.\n To Reproduce\n The BentoML fails to containerize the model when one wants to set the EXTRA_PIP_INSTALL_ARGS environment variable with argument-value pairs to be passed to pip install.\n A scenario is the following:\n One wants to specify an additional --extra-index-url pip argument to specify an internal PyPI server.\n A simple example can be extracted from the bentoml-quick-start-guide.ipynb.\n \n Register a new bento service. i.e. IrisClassifier for this scenario\n Run bentoml containerize IrisClassifier:latest -t iris-classifier --build-arg EXTRA_PIP_INSTALL_ARGS=--extra-index-url=https://myorgpypi.org/\n \n The failure occurs (see logs below) due to the splitting of the string EXTRA_PIP_INSTALL_ARGS=--extra-index-url=https://myorgpypi.org/ as\n [\n   \"EXTRA_PIP_INSTALL_ARGS\",\n   \"--extra-index-url\",\n   \"https://myorgpypi.org/\"\n ]\n instead of\n [\n   \"EXTRA_PIP_INSTALL_ARGS\",\n   \"--extra-index-url=https://myorgpypi.org/\"\n ]\n \n With respect to the string split operation in <denchmark-link:https://github.com/bentoml/BentoML/blob/d8ae9490a834e1aab371a2b69e937acb5c86f19d/bentoml/cli/bento_service.py#L384>bento_service.containerize()</denchmark-link>\n , the solution would be to force the split function to split only once: \n Screenshots/Logs\n When running: bentoml containerize IrisClassifier:latest -t iris-classifier --build-arg EXTRA_PIP_INSTALL_ARGS=--extra-index-url=https://myorgpypi.org/:\n <denchmark-code>[2021-01-13 10:26:00,840] DEBUG - Setting debug mode: ON for current session\n [2021-01-13 10:26:00,840] DEBUG - Creating local YataiService instance\n [2021-01-13 10:26:01,087] DEBUG - Upgrading tables to the latest revision\n [2021-01-13 10:26:02,595] INFO - Getting latest version IrisClassifier:20210108154220_FD6FEA\n Found Bento: /home/luca/bentoml/repository/IrisClassifier/20210108154220_FD6FEA\n Image version not specified, using version parsed from BentoService: '20210108154220_FD6FEA'\n Traceback (most recent call last):\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/bin/bentoml\", line 8, in <module>\n     sys.exit(cli())\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/click/core.py\", line 829, in __call__\n     return self.main(*args, **kwargs)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/click/core.py\", line 782, in main\n     rv = self.invoke(ctx)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/click/core.py\", line 1259, in invoke\n     return _process_result(sub_ctx.command.invoke(sub_ctx))\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/click/core.py\", line 1066, in invoke\n     return ctx.invoke(self.callback, **ctx.params)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/click/core.py\", line 610, in invoke\n     return callback(*args, **kwargs)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/bentoml/cli/click_utils.py\", line 138, in wrapper\n     return func(*args, **kwargs)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/bentoml/cli/click_utils.py\", line 115, in wrapper\n     return_value = func(*args, **kwargs)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/bentoml/cli/click_utils.py\", line 99, in wrapper\n     return func(*args, **kwargs)\n   File \"/home/luca/PycharmProjects/bentoProject/.venv/lib/python3.7/site-packages/bentoml/cli/bento_service.py\", line 409, in containerize\n     key, value = arg.split(\"=\")\n ValueError: too many values to unpack (expected 2)\n </denchmark-code>\n \n Environment:\n \n OS: Ubuntu 18.04.4\n Python Version: Python 3.7.9\n BentoML Version: BentoML-0.10.1\n \n Additional context\n No additional context\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lucascott", "commentT": "2021-01-14T02:50:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/lucascott>@lucascott</denchmark-link>\n  Thank you for reporting.  I will work on fixing it\n \t\t"}}}, "commit": {"commit_id": "e5a6e6a0bf7440b425c55248f156e7f525cc9f32", "commit_author": "Bozhao", "commitT": "2021-01-13 20:19:32-08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.9130434782608695", "commit_Nprams": "0.9130434782608695"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "bentoml\\cli\\bento_service.py", "file_new_name": "bentoml\\cli\\bento_service.py", "file_complexity": {"file_NLOC": "333", "file_CCN": "18", "file_NToken": "1486"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "384", "deleted_lines": "384", "method_info": {"method_name": "create_bento_service_cli", "method_params": "pip_installed_bundle_path", "method_startline": "83", "method_endline": "400", "method_complexity": {"method_NLOC": "193", "method_CCN": "2", "method_NToken": "758", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "384", "deleted_lines": "384", "method_info": {"method_name": "create_bento_service_cli.containerize", "method_params": "bento,push,tag,build_arg,yatai_url", "method_startline": "349", "method_endline": "397", "method_complexity": {"method_NLOC": "25", "method_CCN": "4", "method_NToken": "133", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "bentoml\\yatai\\yatai_service_impl.py", "file_new_name": "bentoml\\yatai\\yatai_service_impl.py", "file_complexity": {"file_NLOC": "441", "file_CCN": "79", "file_NToken": "2571"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "503,504,505", "deleted_lines": "503", "method_info": {"method_name": "get_yatai_service_impl", "method_params": "base", "method_startline": "76", "method_endline": "528", "method_complexity": {"method_NLOC": "28", "method_CCN": "6", "method_NToken": "136", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "503,504,505", "deleted_lines": "503", "method_info": {"method_name": "get_yatai_service_impl.ContainerizeBento", "method_params": "self,request,context", "method_startline": "466", "method_endline": "524", "method_complexity": {"method_NLOC": "56", "method_CCN": "12", "method_NToken": "340", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\integration\\yatai_server\\test_containerize.py", "file_new_name": "tests\\integration\\yatai_server\\test_containerize.py", "file_complexity": {"file_NLOC": "35", "file_CCN": "2", "file_NToken": "194"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43", "deleted_lines": null, "method_info": {"method_name": "test_yatai_server_containerize_from_cli", "method_params": "", "method_startline": "22", "method_endline": "43", "method_complexity": {"method_NLOC": "21", "method_CCN": "1", "method_NToken": "100", "method_nesting_level": "0"}}}}}}}}