{"BR": {"BR_id": "336", "BR_author": "ghunkins", "BRopenT": "2019-10-12T01:15:20Z", "BRcloseT": "2019-10-15T02:48:53Z", "BR_text": {"BRsummary": "KerasModelArtifact#pack expects type: keras.engine.training.Model", "BRdescription": "\n Describe the bug\n KerasModelArtifact fails on Service.pack due to isinstance check on the passed model. Root cause seems to be conflicting definitions between keras.engine.training.Model and tensorflow.python.keras.engine.training.Model.\n Expected behavior is the allowance of both Keras trained and tf.keras trained models. Additionally, import keras may fail for those only working with tensorflow.\n Root Cause\n import keras\n from tensorflow.python import keras as tf_keras\n \n # create dummy Keras model\n a = keras.layers.Input(shape=(32,))\n b = keras.layers.Dense(32)(a)\n model = keras.models.Model(inputs=a, outputs=b)\n \n # this passes\n assert isinstance(model, keras.engine.training.Model)\n # this fails\n assert isinstance(model, tf_keras.engine.training.Model)\n To Reproduce\n Using bentoml==0.4.3, keras==2.2.5, and tensorflow==1.13.1.\n import keras\n import bentoml\n \n @bentoml.artifacts([bentoml.artifacts.KerasModelArtifact('keras_model')])\n class TestService(bentoml.BentoService):\n     pass\n \n # create model\n a = keras.layers.Input(shape=(32,))\n b = keras.layers.Dense(32)(a)\n keras_model = keras.models.Model(inputs=a, outputs=b)\n \n # attempt service creation\n service = TestService.pack(keras_model=keras_model)\n This produces:\n Traceback (most recent call last):\n   File \"test.py\", line 14, in <module>\n     service = TestService.pack(keras_model=keras_model)\n   File \"/Users/ghunk/miniconda3/envs/test/lib/python3.7/site-packages/bentoml/service.py\", line 505, in pack\n     artifact_instance = artifact_spec.pack(kwargs[artifact_spec.name])\n   File \"/Users/ghunk/miniconda3/envs/test/lib/python3.7/site-packages/bentoml/artifact/keras_model_artifact.py\", line 92, in pack\n     \"KerasModelArtifact#pack expects type: keras.engine.training.Model\"\n ValueError: KerasModelArtifact#pack expects type: keras.engine.training.Model\n Expected behavior\n The above test to pass.\n Screenshots/Logs\n Logs above.\n Environment:\n \n OS: MacOS 10.13.6\n Python/BentoML Version: Python 3.7.3, BentoML-0.4.3\n \n Additional context\n See comments on <denchmark-link:https://github.com/bentoml/BentoML/pull/334/files/7a23943b17a3888ed309490d122e9d4bf59c3c2a#r334210378>this PR</denchmark-link>\n  for more context.\n Similar open tensorflow <denchmark-link:https://github.com/tensorflow/tensorflow/issues/23216>issue</denchmark-link>\n .\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ghunkins", "commentT": "2019-10-14T23:26:08Z", "comment_text": "\n \t\tThanks for the detailed notes <denchmark-link:https://github.com/ghunkins>@ghunkins</denchmark-link>\n , just created a PR addressing this issue, feel free to check it out here: <denchmark-link:https://github.com/bentoml/BentoML/pull/341>#341</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "3635e8d17c2bc51009f994815a8595797be72b23", "commit_author": "Chaoyu", "commitT": "2019-10-14 16:35:40-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "bentoml\\artifact\\keras_model_artifact.py", "file_new_name": "bentoml\\artifact\\keras_model_artifact.py", "file_complexity": {"file_NLOC": "174", "file_CCN": "30", "file_NToken": "1066"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "148,149,150,151,152,153,154,155,156,157,174,180", "deleted_lines": "151,153,154,155,156,157,158,159,160,161,162,163,164,171", "method_info": {"method_name": "load", "method_params": "self,path", "method_startline": "147", "method_endline": "183", "method_complexity": {"method_NLOC": "32", "method_CCN": "6", "method_NToken": "221", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "198,199,200,201", "deleted_lines": null, "method_info": {"method_name": "save", "method_params": "self,dst", "method_startline": "197", "method_endline": "215", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "129", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "107,108,109,111,112,115,123,124,125,126,127,128,129,130,131,133,134,135,136,137,138,139,140,141,145", "deleted_lines": "110,111,116,119,120,121,122,139,145", "method_info": {"method_name": "pack", "method_params": "self,data", "method_startline": "106", "method_endline": "145", "method_complexity": {"method_NLOC": "36", "method_CCN": "7", "method_NToken": "153", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "65,66,67", "deleted_lines": null, "method_info": {"method_name": "_keras_module_name_path", "method_params": "self,base_path", "method_startline": "65", "method_endline": "67", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "82,83,84,86,87", "deleted_lines": "82,86,87,90", "method_info": {"method_name": "bind_keras_backend_session", "method_params": "self", "method_startline": "81", "method_endline": "91", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "94,95,96,98,99,103,104", "deleted_lines": "95,96,97,98,99,100,101,102", "method_info": {"method_name": "creat_session", "method_params": "self", "method_startline": "93", "method_endline": "104", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "67", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "188,195", "deleted_lines": "193", "method_info": {"method_name": "__init__", "method_params": "self,spec,model,custom_objects", "method_startline": "187", "method_endline": "195", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "71", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "bentoml\\cli\\__init__.py", "file_new_name": "bentoml\\cli\\__init__.py", "file_complexity": {"file_NLOC": "236", "file_CCN": "14", "file_NToken": "1174"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "277", "deleted_lines": null, "method_info": {"method_name": "create_bento_service_cli", "method_params": "archive_path", "method_startline": "50", "method_endline": "282", "method_complexity": {"method_NLOC": "121", "method_CCN": "2", "method_NToken": "550", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bentoml\\exceptions.py", "file_new_name": "bentoml\\exceptions.py", "file_complexity": {"file_NLOC": "21", "file_CCN": "0", "file_NToken": "64"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29,30,31,32", "deleted_lines": null}}}}}}