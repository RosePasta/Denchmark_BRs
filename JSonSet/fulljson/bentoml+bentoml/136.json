{"BR": {"BR_id": "136", "BR_author": "SuperCD", "BRopenT": "2019-05-08T15:03:05Z", "BRcloseT": "2019-05-13T23:07:50Z", "BR_text": {"BRsummary": "Problem accessing gunicorn server from kubernets ingress", "BRdescription": "\n Describe the bug\n I created a deployment, service and ingress following the example in BentoML/examples/deploy-with-kubernetes/\n (by the way the service-with-ingress.yaml contains an error. the service type is ClusterPort but should be ClusterIP)\n The problem is that connections to the ingress are refused.\n Even when tying to make requests directly to the pod on the 5000 port they get refused.\n If I do a kubectl port-forward it works from localhost\n I suppose that the problem is with the gunicorn bindings\n this is the gunicorn log:\n [2019-05-08 14:46:18 +0000] [1] [INFO] Starting gunicorn 19.9.0\n [2019-05-08 14:46:18 +0000] [1] [INFO] Listening at: <denchmark-link:http://127.0.0.1:5000>http://127.0.0.1:5000</denchmark-link>\n  (1)\n and in the BentoML/bentoml/server/gunicorn_server.py file i see this:\n def init(self, app, port, workers):\n self.options = {'workers': workers, 'bind': '%s:%s' % ('127.0.0.1', port)}\n self.application = app\n super(GunicornApplication, self).init()\n with 127.0.0.1 hardcoded in the code.\n But I'm not completely sure that changing it to 0.0.0.0 would solve the problem.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "SuperCD", "commentT": "2019-05-08T23:48:09Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/SuperCD>@SuperCD</denchmark-link>\n  Thanks for point it out!\n We need to update the kubernetes example that works correctly with the Gunicorn deployment.  We will hopefully get that fixed very soon.\n Is this issue something very urgent with you? If it is, we will try our best to get it done sooner.\n Feel free to ping me on this or any other questions!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "SuperCD", "commentT": "2019-05-09T08:00:50Z", "comment_text": "\n \t\tthanks for the fast reply. I've tested it and in fact i was able to make it run if the binding is done on 0.0.0.0\n I'm not even sure that changing the binding is the only way of solving this, but is the only one I've found...\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "SuperCD", "commentT": "2019-05-09T18:43:08Z", "comment_text": "\n \t\tThanks for investigating <denchmark-link:https://github.com/SuperCD>@SuperCD</denchmark-link>\n !\n I think you found the issue. Which is right now, the docker container right now is only listening localhost.\n We will address this issue and also improve the experience for deploying with Docker.  Those changes should solve the problem you are encountering now.\n Just some idea in my head right now,  I am thinking about using Nginx/gunicorn setup inside the docker container.\n I will link the PR to this issue, hopefully I can get to it sometime close to next week or so.  Feel free to ping me, if you need it before that.  I will pump it up and work on it sooner\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "SuperCD", "commentT": "2019-05-09T22:45:33Z", "comment_text": "\n \t\thi <denchmark-link:https://github.com/SuperCD>@SuperCD</denchmark-link>\n , I did a little bit more digging on this topic and We think your solution right now is the best one moving forward.\n We did think about having an Nginx in the docker container as well. However, we realized that right now, most deployment solution probably already have an Nginx component that sits in front of the apps already (kubernetes' ingress controller for example).  The Nginx won't bring too much value inside the container.\n I think it is more fitting that you submit the PR to fix this problem since you provide the solution as well.  What do you think?  Otherwise, I will merge in the PR 138 that I linked above\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "SuperCD", "commentT": "2019-05-13T23:07:50Z", "comment_text": "\n \t\tclosing this issue now, since we merged in PR138.  Feel free to open again, if there is additional issue relate to this.\n \t\t"}}}, "commit": {"commit_id": "342b08afb0058b513eac2b95e06d037ec179d154", "commit_author": "Bozhao", "commitT": "2019-05-13 11:08:41-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "bentoml\\server\\gunicorn_server.py", "file_new_name": "bentoml\\server\\gunicorn_server.py", "file_complexity": {"file_NLOC": "31", "file_CCN": "8", "file_NToken": "163"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "36", "deleted_lines": "36", "method_info": {"method_name": "__init__", "method_params": "self,app,port,workers", "method_startline": "35", "method_endline": "38", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "45", "method_nesting_level": "1"}}}}}}}}