{"BR": {"BR_id": "2500", "BR_author": "leodestiny", "BRopenT": "2021-01-06T14:18:15Z", "BRcloseT": "2021-01-14T07:00:50Z", "BR_text": {"BRsummary": "Memory leak when deleting shared memory ndarray at runtime", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n We are using shared memory ndarray in DGL. We found when dynamical allocating and freeing ndarray, they cannot correctly be deleted correctly on real physical memory, which lead to memory leak on shared memory at runtime.\n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n Steps to reproduce the behavior:\n \n run below codes\n \n Python 3.8.2 (default, May 20 2020, 12:05:48)\n [GCC 6.3.0 20170516] on linux\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n >>> import dgl\n Using backend: pytorch\n /home/tiger/github/dgl/python/dgl/base.py:45: DGLWarning: Detected an old version of PyTorch. Suggest using torch>=1.5.0 for the best experience.\n   return warnings.warn(message, category=category, stacklevel=1)\n >>> from dgl._ffi.ndarray import empty_shared_mem\n >>> for i in range(10):\n ...     s = empty_shared_mem(\"test{:d}\".format(i), True, (10000,100))\n ...     print(s)\n ...     del s\n ...\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test0 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test1 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test2 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test3 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test4 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test5 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test6 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test7 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test8 for shared memory\n [[0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  ...\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]\n  [0. 0. 0. ... 0. 0. 0.]]\n [21:46:41] /home/tiger/github/dgl/src/runtime/shared_mem.cc:58: remove test9 for shared memory\n >>>\n <denchmark-h:h2>Expected behavior</denchmark-h>\n \n We expect these ndarray should be deleted both on the directory /dev/shm and real psychical memory.\n Shared memory objects on /dev/shm have been deleted as expected.\n $ ls /dev/shm\n $\n However, these ndarray still using psychical memory.\n $ df -h\n Filesystem      Size  Used Avail Use% Mounted on\n shm             178G   39M  178G   1% /dev/shm\n If we dive into the /proc/PID/maps, we can find these ndarray are only labeled by \"deleted\" but still in psychical memory.\n These shared memory will be freed only when this process is terminated.\n $ cd /proc/2774772\n $ cat maps | grep test\n 7f0e3b81c000-7f0e3bbed000 rw-s 00000000 00:3e 1635644643                 /dev/shm/test9 (deleted)\n 7f0e3bbed000-7f0e3bfbe000 rw-s 00000000 00:3e 1635644642                 /dev/shm/test8 (deleted)\n 7f0e3bfbe000-7f0e3c38f000 rw-s 00000000 00:3e 1635644641                 /dev/shm/test7 (deleted)\n 7f0e3c38f000-7f0e3c760000 rw-s 00000000 00:3e 1635644640                 /dev/shm/test6 (deleted)\n 7f0e3c760000-7f0e3cb31000 rw-s 00000000 00:3e 1635644639                 /dev/shm/test5 (deleted)\n 7f0e3cb31000-7f0e3cf02000 rw-s 00000000 00:3e 1635644638                 /dev/shm/test4 (deleted)\n 7f0e3cf02000-7f0e3d2d3000 rw-s 00000000 00:3e 1635644637                 /dev/shm/test3 (deleted)\n 7f0e3d2d3000-7f0e3d6a4000 rw-s 00000000 00:3e 1635644636                 /dev/shm/test2 (deleted)\n 7f0e3d6a4000-7f0e3da75000 rw-s 00000000 00:3e 1635644635                 /dev/shm/test1 (deleted)\n 7f0e3da75000-7f0e3de46000 rw-s 00000000 00:3e 1635644634                 /dev/shm/test0 (deleted)\n \n <denchmark-h:h2>Environment</denchmark-h>\n \n \n DGL Version (e.g., 1.0): 0.6\n Backend Library & Version (e.g., PyTorch 0.4.1, MXNet/Gluon 1.3): PyTorch 1.4.0\n OS (e.g., Linux): Linux\n How you installed DGL (conda, pip, source): source\n Build command you used (if compiling from source): same as the official command\n Python version: 3.8.2\n CUDA/cuDNN version (if applicable):\n GPU models and configuration (e.g. V100):\n Any other relevant information:\n \n <denchmark-h:h2>Additional context</denchmark-h>\n \n If using shared memory provided by <denchmark-link:https://docs.python.org/3/library/multiprocessing.shared_memory.html>python offical</denchmark-link>\n , it can delete shared memory both on /dev/shm and real physical memory correctly.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leodestiny", "commentT": "2021-01-07T12:42:11Z", "comment_text": "\n \t\tSeems that during  the size argument passed in is always 0 in the above case.  <denchmark-link:https://github.com/zheng-da>@zheng-da</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "4d89b54efa229528ce2a7d1413514124e392ac06", "commit_author": "Quan (Andy) Gan", "commitT": "2021-01-14 15:00:49+08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "include\\dgl\\runtime\\shared_mem.h", "file_new_name": "include\\dgl\\runtime\\shared_mem.h", "file_complexity": {"file_NLOC": "19", "file_CCN": "1", "file_NToken": "90"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "28,31,33,35,63,66,69,72", "deleted_lines": "28,31,33,35,63,66,69,72"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "src\\runtime\\shared_mem.cc", "file_new_name": "src\\runtime\\shared_mem.cc", "file_complexity": {"file_NLOC": "78", "file_CCN": "9", "file_NToken": "555"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "55,56,57,59", "deleted_lines": "55,56,57,59", "method_info": {"method_name": "dgl::runtime::SharedMemory::~SharedMemory", "method_params": "", "method_startline": "53", "method_endline": "66", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "85", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "92,95,96,97,98,100,101", "deleted_lines": "94,95,96,97,99", "method_info": {"method_name": "dgl::runtime::SharedMemory::Open", "method_params": "sz", "method_startline": "92", "method_endline": "105", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "106", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "68,70,75,76,79,82,83,85,86", "deleted_lines": "68,70,75,76,79,82,83,85", "method_info": {"method_name": "dgl::runtime::SharedMemory::CreateNew", "method_params": "size", "method_startline": "68", "method_endline": "89", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "154", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "109,110,111", "deleted_lines": "107,108,109", "method_info": {"method_name": "dgl::runtime::SharedMemory::Exist", "method_params": "name", "method_startline": "107", "method_endline": "119", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "61", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "68,70,75,76,79,82,83,85,86", "deleted_lines": "68,70,75,76,79,82,83,85", "method_info": {"method_name": "dgl::runtime::SharedMemory::CreateNew", "method_params": "sz", "method_startline": "68", "method_endline": "90", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "160", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "44,45,46,47", "deleted_lines": "44,45,46,47", "method_info": {"method_name": "dgl::runtime::SharedMemory::SharedMemory", "method_params": "name", "method_startline": "41", "method_endline": "51", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "52", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "92,95,96,97,98,100,101", "deleted_lines": "91,94,95,96,97,99", "method_info": {"method_name": "dgl::runtime::SharedMemory::Open", "method_params": "size", "method_startline": "91", "method_endline": "103", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "100", "method_nesting_level": "2"}}}}}}}}