{"BR": {"BR_id": "4705", "BR_author": "jtfogarty", "BRopenT": "2020-01-30T20:27:49Z", "BRcloseT": "2020-02-05T22:35:58Z", "BR_text": {"BRsummary": "Jupyter UI shows error while waiting for pod to bind PVC", "BRdescription": "\n /kind bug\n What steps did you take and what happened:\n Created a Notebook Server using Rook/Ceph as the storage layer.\n Pod created but the UI shows a red X in the status.\n <denchmark-link:https://user-images.githubusercontent.com/6708730/73487270-43213480-436c-11ea-8bf9-a91892cfa9d6.png></denchmark-link>\n \n What did you expect to happen:\n Pod to start without issue\n Environment:\n \n Kubeflow version: (version number can be found at the bottom left corner of the Kubeflow dashboard):\n kfctl version:  v1.0-rc.1-0-g963c787\n Kubernetes platform: v1.15.7\n Kubernetes version: v1.15.7\n OS (e.g. from /etc/os-release): NAME=\"CentOS Linux\"\n VERSION=\"7 (Core)\"\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jtfogarty", "commentT": "2020-01-30T20:27:59Z", "comment_text": "\n \t\tIssue-Label Bot is automatically applying the labels:\n \n \n \n Label\n Probability\n \n \n \n \n kind/bug\n 0.98\n \n \n \n Please mark this comment with  or  to give our bot feedback!\n Links: <denchmark-link:https://github.com/marketplace/issue-label-bot>app homepage</denchmark-link>\n , <denchmark-link:https://github.com/marketplace/issue-label-botdata/kubeflow/kubeflow>dashboard</denchmark-link>\n  and <denchmark-link:https://github.com/hamelsmu/MLapp>code</denchmark-link>\n  for this bot.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jtfogarty", "commentT": "2020-01-30T20:29:09Z", "comment_text": "\n \t\t/area front-end\n /priority p0\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jtfogarty", "commentT": "2020-01-30T20:29:52Z", "comment_text": "\n \t\tThe pod eventually starts and the status turns green\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jtfogarty", "commentT": "2020-02-01T17:47:22Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jtfogarty>@jtfogarty</denchmark-link>\n  is this still an issue?\n I suspect this is because the Rook (Ceph) provisioner is taking some time to provision the Persistent Volume, so in the meantime you get this message.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jtfogarty", "commentT": "2020-02-03T17:28:50Z", "comment_text": "\n \t\tDowngrading to P1 because this doesn't seem like its release blocking.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jtfogarty", "commentT": "2020-02-03T19:53:27Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/yanniszark>@yanniszark</denchmark-link>\n  Yes, this is still an issue\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jtfogarty", "commentT": "2020-02-04T06:14:49Z", "comment_text": "\n \t\tI observed the same behavior on GCP using the default storage class (not ROK).\n Bump back to P0; I think this is going to confuse a lot of people.\n <denchmark-link:https://github.com/fediazgon>@fediazgon</denchmark-link>\n  <denchmark-link:https://github.com/kimwnasptd>@kimwnasptd</denchmark-link>\n  Is this related to the changes in the UI to surface events? Is there an easy way to show something less confusing to users?\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "jtfogarty", "commentT": "2020-02-04T07:42:03Z", "comment_text": "\n \t\tYes, it is related to <denchmark-link:https://github.com/kubeflow/kubeflow/pull/4214/files#diff-d575d8cda5f10ed63f52ac8e7a65b733R328>this change</denchmark-link>\n . Right now the UI shows that status when the event matches the following predicate .\n One solution would be to limit the events that are shown by looking at the event's description. <denchmark-link:https://github.com/kimwnasptd>@kimwnasptd</denchmark-link>\n  WDYT?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "jtfogarty", "commentT": "2020-02-05T03:17:44Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fediazgon>@fediazgon</denchmark-link>\n  thanks. What if we just returned STATUS_WAITING rather than STATUS_ERROR\n <denchmark-link:https://github.com/kubeflow/kubeflow/pull/4214/files#diff-d575d8cda5f10ed63f52ac8e7a65b733R329>https://github.com/kubeflow/kubeflow/pull/4214/files#diff-d575d8cda5f10ed63f52ac8e7a65b733R329</denchmark-link>\n \n I guess the downside is that we might get stuck in waiting mode even for permanent errors. But that seems preferable to always showing an error.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "jtfogarty", "commentT": "2020-02-05T12:15:43Z", "comment_text": "\n \t\tI'm also in favor of <denchmark-link:https://github.com/fediazgon>@fediazgon</denchmark-link>\n  's proposal. I think returning STATUS_WAITING will take us back from where we started when we would show the spinner even if the underlying Pod would fail to be created.\n Looking at the description of the events seems a little dirty and in the future we might bump into another event that we hadn't anticipated and need to extend the description pattern matching.\n But given the current API I think its our only option if we want to be able to treat specific Warning Type Events as non warning/error ones.\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "jtfogarty", "commentT": "2020-02-05T12:58:42Z", "comment_text": "\n \t\tI think we can do both. We can be explicit about the error events that we are expecting and, if we find any unknown error event we just return STATUS_WAITING but we still show the message in the UI.\n I tried to replicate the behaviour in GCP using the default storage class, with the changes in <denchmark-link:https://github.com/kubeflow/kubeflow/pull/4729>#4729</denchmark-link>\n , now it shows like this:\n <denchmark-link:https://user-images.githubusercontent.com/12219405/73843649-4fe7d180-481f-11ea-9e38-ce248549cdbb.png></denchmark-link>\n \n But it will still display \"Insufficient X\" or \"error looking up service account\" as STATUS_ERROR.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "jtfogarty", "commentT": "2020-02-05T13:01:13Z", "comment_text": "\n \t\t\n Will we be able to do a good job distinguishing permanent from temporary errors?\n Don't we ultimately need to surface events to the user so they can remedy the situation? So rather than trying to classify events as warnings or errors; shouldn't we focus on them?\n \n If Kubernetes is classifying it as a warning and not an error, should we be treating it as an error?\n Here's my failed pod\n <denchmark-link:https://github.com/kubeflow/kubeflow/files/4159468/jlewi-0.pod.txt>jlewi-0.pod.txt</denchmark-link>\n \n In this case the event is\n <denchmark-code>  Warning  FailedScheduling        18m (x2 over 18m)  default-scheduler                                             pod has unbound \n immediate PersistentVolumeClaims (repeated 2 times)\n </denchmark-code>\n \n I'm using a default storage class so this will get provisioned automatically. However, if a user attaches an existing PVC or deletes a PVC wouldn't they get similar events? How would you distinguish between a PVC that will eventually get bound and a PVC that will never get bound?\n Similarly, in the case of FailedScheduling if a POD doesn't get scheduled because of CPU that might be permanent or if a user has autoscaling enabled they might just need to wait for autoscaling to kick in.\n Trying to correctly classify errors based on the message seems like we could end up playing wack a mole.\n Would a better medium (i.e. post 1.0) solution be to provide an improved UI to see all events for a notebook?\n Going back to the original issue <denchmark-link:https://github.com/kubeflow/kubeflow/pull/3673>#3673</denchmark-link>\n  the goal was to surface errors to the user so they could figure out to fix it. So I think we need to surface the events to the user.\n I think right now we accomplish that because if they hover over the spinner they see the message as <denchmark-link:https://github.com/jtfogarty>@jtfogarty</denchmark-link>\n  shows in his screenshot.\n So I think if we showed the waiting icon with the same pop instead of an error we achieve the same goal without confusing users.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "jtfogarty", "commentT": "2020-02-05T13:26:52Z", "comment_text": "\n \t\t\n Trying to correctly classify errors based on the message seems like we could end up playing wack a mole.\n Would a better medium (i.e. post 1.0) solution be to provide an improved UI to see all events for a notebook?\n \n Sounds fine to me. Let's keep it simple then.\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "jtfogarty", "commentT": "2020-02-05T21:00:07Z", "comment_text": "\n \t\tConfirmed this is working on master now\n <denchmark-link:https://github.com/kubeflow/manifests/tree/830e1a0>https://github.com/kubeflow/manifests/tree/830e1a0</denchmark-link>\n \n <denchmark-link:https://user-images.githubusercontent.com/777219/73882705-62f6a380-4817-11ea-9f8e-6d4a3a20ca06.png></denchmark-link>\n \n Will LGTM the cherry pick into the 1.0 branch.\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "jtfogarty", "commentT": "2020-02-05T21:01:07Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kubeflow/manifests/pull/868>kubeflow/manifests#868</denchmark-link>\n \n Just need to wait for it land in auto-deployed cluster so I can verify on 1.0.\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "jtfogarty", "commentT": "2020-02-05T22:34:48Z", "comment_text": "\n \t\tv1\n <denchmark-link:https://github.com/kubeflow/manifests/tree/7abafe2>https://github.com/kubeflow/manifests/tree/7abafe2</denchmark-link>\n \n Looks good\n <denchmark-link:https://user-images.githubusercontent.com/777219/73889480-a4da1680-4824-11ea-998f-30ea1a0bb596.png></denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "0c496710150553784f7ebbbd3070cc9c26bfb39c", "commit_author": "Fernando Diaz", "commitT": "2020-02-05 10:33:55-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "components\\jupyter-web-app\\backend\\kubeflow_jupyter\\common\\utils.py", "file_new_name": "components\\jupyter-web-app\\backend\\kubeflow_jupyter\\common\\utils.py", "file_complexity": {"file_NLOC": "383", "file_CCN": "86", "file_NToken": "2586"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "532", "deleted_lines": "532", "method_info": {"method_name": "add_notebook_volume_secret", "method_params": "nb,secret,secret_name,mnt_path,mode", "method_startline": "525", "method_endline": "541", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "94", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "323,324,328,329", "deleted_lines": "323,324,328,329", "method_info": {"method_name": "find_error_event", "method_params": "rsrc_events", "method_startline": "317", "method_endline": "330", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "39", "method_nesting_level": "0"}}}}}}}}