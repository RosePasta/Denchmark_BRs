{"BR": {"BR_id": "3759", "BR_author": "Kyrremann", "BRopenT": "2019-07-26T12:47:19Z", "BRcloseT": "2019-10-19T12:17:38Z", "BR_text": {"BRsummary": "kfctl apply failes with No Auth Provider found for name \"azure\"", "BRdescription": "\n I'm trying to apply Kubeflow v.0.6.0 in our cluster, and it failes with the following error:\n <denchmark-code>$ kfctl apply all -V\n INFO[0000] Downloading /home/user/workspace/kubeflow/app.yaml to /tmp/455975017/app.yaml  filename=\"v1alpha1/application_types.go:334\"\n INFO[0000] Writing stripped KfDef to /home/user/workspace/kubeflow/app.yaml  filename=\"v1alpha1/application_types.go:626\"\n INFO[0000] Downloading /home/user/workspace/kubeflow/app.yaml to /tmp/812831412/app.yaml  filename=\"v1alpha1/application_types.go:334\"\n INFO[0000] Initializing a default restConfig for Kubernetes  filename=\"kustomize/kustomize.go:248\"\n FATA[0000] Can not get kubernetes kfdef: No Auth Provider found for name \"azure\"  filename=\"apps/group.go:262\"\n </denchmark-code>\n \n We use Azure/AD to connect/login to the cluster, and if I create a user that authenticates with a token instead (of my regular user) it all works.\n I assume the problem is that kfctl is missing support for azure as an oidc flow.\n There has been a short disuccion on <denchmark-link:https://kubeflow.slack.com/archives/C7REE0EHK/p1564132253111500>slack</denchmark-link>\n .\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Kyrremann", "commentT": "2019-07-26T12:47:21Z", "comment_text": "\n \t\tIssue-Label Bot is automatically applying the label kind/bug to this issue, with a confidence of 0.63. Please mark this comment with \ud83d\udc4d or \ud83d\udc4e to give our bot feedback!\n Links: <denchmark-link:https://github.com/marketplace/issue-label-bot>app homepage</denchmark-link>\n , <denchmark-link:https://mlbot.net/data/kubeflow/kubeflow>dashboard</denchmark-link>\n  and <denchmark-link:https://github.com/hamelsmu/MLapp>code</denchmark-link>\n  for this bot.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Kyrremann", "commentT": "2019-07-26T13:11:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jlewi>@jlewi</denchmark-link>\n  <denchmark-link:https://github.com/kkasravi>@kkasravi</denchmark-link>\n \n I suspect the issue is that the client we use for kfctl doesn't support the OIDC flow.\n How do we want to handle situations like this?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Kyrremann", "commentT": "2019-07-26T13:51:08Z", "comment_text": "\n \t\t/assign <denchmark-link:https://github.com/kkasravi>@kkasravi</denchmark-link>\n \n /assign <denchmark-link:https://github.com/gabrielwen>@gabrielwen</denchmark-link>\n \n Could one of you take a look please?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "Kyrremann", "commentT": "2019-07-26T15:16:54Z", "comment_text": "\n \t\tDocumentation says to use k8s not all\n \u2018kfctl apply k8s\u2019\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "Kyrremann", "commentT": "2019-07-27T00:01:44Z", "comment_text": "\n \t\tIt looks like this is coming from here:\n \n \n \n kubeflow/bootstrap/v2/pkg/apis/apps/group.go\n \n \n          Line 262\n       in\n       32b7443\n \n \n \n \n \n \n  clientset, err := kubernetes.NewForConfig(config) \n \n \n \n \n \n If I understand <denchmark-link:https://github.com/Kyrremann>@Kyrremann</denchmark-link>\n 's comment the various auth modules in the K8s go client are plugins\n and need to be explicitly importing.\n I think its this module\n <denchmark-link:https://github.com/kubernetes/client-go/tree/master/plugin/pkg/client/auth>https://github.com/kubernetes/client-go/tree/master/plugin/pkg/client/auth</denchmark-link>\n \n <denchmark-link:https://github.com/Kyrremann>@Kyrremann</denchmark-link>\n  Any interest in trying to add a PR to do that?\n <denchmark-link:https://github.com/aronchick>@aronchick</denchmark-link>\n  Anyone on the Azure side who could pick this up and test it out?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "Kyrremann", "commentT": "2019-07-29T08:45:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kkasravi>@kkasravi</denchmark-link>\n  isn't that for what type of resources your supposed to generate? Also, maybe the example in the documentation should be updated if your not supposed to use  when applying to vanilla kubernetes cluster?\n <denchmark-link:https://github.com/jlewi>@jlewi</denchmark-link>\n  I can try to take a look, and see if I'll manage to fix the problem!\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "Kyrremann", "commentT": "2019-07-29T13:00:41Z", "comment_text": "\n \t\tOkay, after a bit of googling, and looking at some other code we have, the solution should be pretty straightforward.\n <denchmark-link:https://github.com/liggitt/kubernetes/blob/master/staging/src/k8s.io/client-go/examples/README.md#auth-plugins>https://github.com/liggitt/kubernetes/blob/master/staging/src/k8s.io/client-go/examples/README.md#auth-plugins</denchmark-link>\n \n But, I can't get it to work with kfctl, and I'm wondering if I'm building the tool wrong.\n This is what I've done:\n \n Added the import-line to kubeflow/bootstrap/pkg/apis/apps/group.go\n make build-kfctl\n ./kfctl init/generate/apply\n No success\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "Kyrremann", "commentT": "2019-07-30T03:29:03Z", "comment_text": "\n \t\tThat is the right way to build it. Not sure why it didn't work.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "Kyrremann", "commentT": "2019-08-13T08:51:50Z", "comment_text": "\n \t\tI think I can help with this.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "Kyrremann", "commentT": "2019-09-09T05:45:09Z", "comment_text": "\n \t\tShould we get <denchmark-link:https://github.com/kubeflow/kubeflow/pull/3881>#3881</denchmark-link>\n  merged?\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "Kyrremann", "commentT": "2019-09-09T10:55:10Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kkasravi>@kkasravi</denchmark-link>\n  does the new apply logic (which uses kubectl) also fix this problem?\n Or do we need to add blank imports at certain locations in the code?\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "Kyrremann", "commentT": "2019-09-09T11:02:12Z", "comment_text": "\n \t\tIf a new version of kfctl rely on the users kubectl I think the problem will be solved by it self.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "Kyrremann", "commentT": "2019-09-20T11:02:40Z", "comment_text": "\n \t\tHi, <denchmark-link:https://github.com/yeya24>@yeya24</denchmark-link>\n  After modifying the code which you suggested, I'm getting the issue during\n \n <denchmark-code># k8s.io/client-go/plugin/pkg/client/auth/azure\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:247:4: cannot use json.Number(expiresIn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:248:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:249:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:301:25: cannot call non-function spt.Token (type adal.Token)\n </denchmark-code>\n \n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "Kyrremann", "commentT": "2019-09-20T14:12:19Z", "comment_text": "\n \t\t\n Hi, @yeya24 After modifying the code which you suggested, I'm getting the issue during\n make build-kfctl\n # k8s.io/client-go/plugin/pkg/client/auth/azure\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:247:4: cannot use json.Number(expiresIn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:248:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:249:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:301:25: cannot call non-function spt.Token (type adal.Token)\n \n \n Sorry, I have encountered this issue once. This is because your client-go version is too old. Ref:  <denchmark-link:https://github.com/pingcap/tidb-operator/pull/756#issuecomment-520759888>pingcap/tidb-operator#756 (comment)</denchmark-link>\n \n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "Kyrremann", "commentT": "2019-09-20T16:09:18Z", "comment_text": "\n \t\t\n \n Hi, @yeya24 After modifying the code which you suggested, I'm getting the issue during\n make build-kfctl\n # k8s.io/client-go/plugin/pkg/client/auth/azure\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:247:4: cannot use json.Number(expiresIn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:248:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:249:4: cannot use json.Number(expiresOn) (type json.Number) as type string in field value\n ../../.go/pkg/mod/k8s.io/client-go@v0.0.0-20190228174230-b40b2a5939e4/plugin/pkg/client/auth/azure/azure.go:301:25: cannot call non-function spt.Token (type adal.Token)\n \n \n Sorry, I have encountered this issue once. This is because your client-go version is too old. Ref: pingcap/tidb-operator#756 (comment)\n \n Oh thanks, <denchmark-link:https://github.com/yeya24>@yeya24</denchmark-link>\n  but how should I update the client-go as the client-go@v0.0.0-20190228174230-b40b2a5939e4 is automatically being generated. Sorry, I'm pretty new here.\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "Kyrremann", "commentT": "2019-09-23T07:20:06Z", "comment_text": "\n \t\tAlso <denchmark-link:https://github.com/yeya24>@yeya24</denchmark-link>\n  I don't think its the same issue because the last line of the error is not same\n \n ../../../../pkg/mod/k8s.io/client-go@v2.0.0-alpha.0.0.20190115164855-701b91367003+incompatible/plugin/pkg/client/auth/azure/azure.go:266:23: cannot use token.token.ExpiresOn (type json.Number) as type string in assignment\n \t\t"}}}, "commit": {"commit_id": "ad0893ee39b676afbfce15e9537bb845c67c9028", "commit_author": "Ben Ye", "commitT": "2019-10-19 05:17:37-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\go.mod", "file_new_name": "bootstrap\\go.mod", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "6,7", "deleted_lines": "54"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\go.sum", "file_new_name": "bootstrap\\go.sum", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,85", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "file_new_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "file_complexity": {"file_NLOC": "851", "file_CCN": "6", "file_NToken": "5763"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "59", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\pkg\\utils\\k8utils.go", "file_new_name": "bootstrap\\pkg\\utils\\k8utils.go", "file_complexity": {"file_NLOC": "437", "file_CCN": "74", "file_NToken": "2540"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "52", "deleted_lines": null}}}}}}