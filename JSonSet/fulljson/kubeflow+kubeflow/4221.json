{"BR": {"BR_id": "4221", "BR_author": "richardsliu", "BRopenT": "2019-10-02T20:02:50Z", "BRcloseT": "2019-10-11T06:45:39Z", "BR_text": {"BRsummary": "Presubmit for notebook-test is failing", "BRdescription": "\n Error:\n <denchmark-code>usage: pytest [options] [file_or_dir] [file_or_dir] [...]\n pytest: error: unrecognized arguments: --namespace=kubeflow\n  inifile: None\n  rootdir: /\n </denchmark-code>\n \n The namespace is passed here:\n <denchmark-link:https://github.com/kubeflow/kubeflow/blob/master/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py#L407>https://github.com/kubeflow/kubeflow/blob/master/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py#L407</denchmark-link>\n \n This codepath hasn't changed in a long time, not sure why it is breaking now.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "richardsliu", "commentT": "2019-10-02T20:02:57Z", "comment_text": "\n \t\tIssue Label Bot is not confident enough to auto-label this issue.\n See <denchmark-link:https://mlbot.net/data/kubeflow/kubeflow>dashboard</denchmark-link>\n  for more details.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "richardsliu", "commentT": "2019-10-02T23:33:38Z", "comment_text": "\n \t\tI think <denchmark-link:https://github.com/scottilee>@scottilee</denchmark-link>\n  is updating that test in <denchmark-link:https://github.com/kubeflow/kubeflow/pull/4171>#4171</denchmark-link>\n  but it hasn't been merged yet.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "richardsliu", "commentT": "2019-10-02T23:36:32Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/richardsliu>@richardsliu</denchmark-link>\n  if this is in a presubmit could the problem be in the PR itself?\n postsubmits look green but I'm not sure I see that particular test.\n <denchmark-link:https://k8s-testgrid.appspot.com/sig-big-data#kubeflow-postsubmit>https://k8s-testgrid.appspot.com/sig-big-data#kubeflow-postsubmit</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "richardsliu", "commentT": "2019-10-02T23:48:13Z", "comment_text": "\n \t\tkubeflow/kubeflow periodic master\n <denchmark-link:https://k8s-testgrid.appspot.com/sig-big-data#kubeflow-periodic-master>https://k8s-testgrid.appspot.com/sig-big-data#kubeflow-periodic-master</denchmark-link>\n \n here's a periodic run\n <denchmark-link:https://prow.k8s.io/view/gcs/kubernetes-jenkins/logs/kubeflow-periodic-master/1179501557733920774>https://prow.k8s.io/view/gcs/kubernetes-jenkins/logs/kubeflow-periodic-master/1179501557733920774</denchmark-link>\n \n 63/64 tests passed and 1 was skipped.\n But some of the argo workflows are failing\n <denchmark-link:http://testing-argo.kubeflow.org/workflows/kubeflow-test-infra/kubeflow-periodic-master-kfctl-go-iap-endpoint-0774-baaa?tab=workflow>http://testing-argo.kubeflow.org/workflows/kubeflow-test-infra/kubeflow-periodic-master-kfctl-go-iap-endpoint-0774-baaa?tab=workflow</denchmark-link>\n \n The notebook_test step failed.\n   Logs show the error reported by <denchmark-link:https://github.com/richardsliu>@richardsliu</denchmark-link>\n \n The events show the pod for that step started just fine.\n Since the test doesn't start we don't report a junit file.\n Since the workflow failed the prow job is correctly reported as failed.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "richardsliu", "commentT": "2019-10-02T23:54:57Z", "comment_text": "\n \t\tnamespace is listed in conftest.py\n <denchmark-link:https://github.com/kubeflow/kubeflow/blob/master/kubeflow/jupyter/tests/conftest.py>https://github.com/kubeflow/kubeflow/blob/master/kubeflow/jupyter/tests/conftest.py</denchmark-link>\n \n It doesn't look like the working directory is set for that step.\n <denchmark-code>- activeDeadlineSeconds: 3000\n     container:\n       command:\n       - pytest\n       - jupyter_test.py\n       - -s\n       - --namespace=kubeflow\n       - --timeout=500\n       - --junitxml=/mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/output/artifacts/junit_kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/junit_jupyter-test.xml\n       env:\n       - name: GOOGLE_APPLICATION_CREDENTIALS\n         value: /secret/gcp-credentials/key.json\n       - name: PYTHONPATH\n         value: /mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/src/kubeflow/kubeflow:/mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/src/kubeflow/testing/py:/mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/src/kubeflow/tf-operator/py\n       - name: GOPATH\n         value: /mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177\n       - name: KUBECONFIG\n         value: /mnt/test-data-volume/kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177/kfctl_test/.kube/kubeconfig\n       - name: BUILD_ID\n         value: '1179440908370710535'\n       - name: JOB_SPEC\n         value: '{\"type\":\"periodic\",\"job\":\"kubeflow-periodic-master\",\"buildid\":\"1179440908370710535\",\"prowjobid\":\"f81b70fc-e535-11e9-8742-32d4b56136c3\"}'\n       - name: REPO_OWNER\n         value: kubeflow\n       - name: PROW_JOB_ID\n         value: f81b70fc-e535-11e9-8742-32d4b56136c3\n       - name: JOB_TYPE\n         value: periodic\n       - name: JOB_NAME\n         value: kubeflow-periodic-master\n       - name: REPO_NAME\n         value: kubeflow\n       image: gcr.io/kubeflow-ci/test-worker:latest\n       imagePullPolicy: Always\n       name: ''\n       resources:\n         limits:\n           cpu: '4'\n           memory: 4Gi\n         requests:\n           cpu: '1'\n           memory: 1536Mi\n       volumeMounts:\n       - mountPath: /mnt/test-data-volume\n         name: kubeflow-test-volume\n       - mountPath: /secret/gcp-credentials\n         name: gcp-credentials\n     inputs: {}\n     metadata:\n       annotations:\n         kubeflow.org/logs: https://console.cloud.google.com/logs/viewer?project=kubeflow-ci&advancedFilter=resource.type%3D%22k8s_container%22%0Ametadata.userLabels.step_name%3D%22notebook-test%22%0Ametadata.userLabels.%22workflows.argoproj.io%2Fworkflow%22%3D%22kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177%22%0Aresource.labels.container_name%3D%22main%22%0A&interval=P7D\n       labels:\n         BUILD_ID: '1179440908370710535'\n         JOB_NAME: kubeflow-periodic-master\n         JOB_TYPE: periodic\n         PROW_JOB_ID: f81b70fc-e535-11e9-8742-32d4b56136c3\n         REPO_NAME: kubeflow\n         REPO_OWNER: kubeflow\n         step_name: notebook-test\n         workflow: kubeflow-periodic-master-kfctl-go-iap-endpoint-0535-1177\n         workflow_template: kfctl_e2e\n     name: notebook-test\n     outputs: {}\n </denchmark-code>\n \n That seems problematic.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "richardsliu", "commentT": "2019-10-03T00:07:14Z", "comment_text": "\n \t\tworkingDir should be set here\n \n \n \n kubeflow/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py\n \n \n          Line 417\n       in\n       3abc11e\n \n \n \n \n \n \n  notebook_test[\"container\"][\"workingDir\"] = os.path.join( \n \n \n \n \n \n I don't think that's having any effect. I think there is a bug here in _build_step\n \n \n \n kubeflow/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py\n \n \n          Line 284\n       in\n       3abc11e\n \n \n \n \n \n \n  \n \n \n \n \n \n We are returning the step and then modifying it but  argo_build_util.add_task_to_dag is making a copy of the step so we aren't actually modifying the dictionary added as a template.\n and add_task_to_dag doesn't return the step\n <denchmark-link:https://github.com/kubeflow/testing/blob/master/py/kubeflow/testing/argo_build_util.py#L151>https://github.com/kubeflow/testing/blob/master/py/kubeflow/testing/argo_build_util.py#L151</denchmark-link>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "richardsliu", "commentT": "2019-10-03T00:11:46Z", "comment_text": "\n \t\tpotential fix in <denchmark-link:https://github.com/kubeflow/kubeflow/pull/4224>#4224</denchmark-link>\n ; I'm still not sure why this didn't show up before now.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "richardsliu", "commentT": "2019-10-03T00:23:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kubeflow/kubeflow/pull/4201>#4201</denchmark-link>\n  is a recent PR that modified kfctl_e2e_test_workflow.py\n <denchmark-link:https://prow.k8s.io/view/gcs/kubernetes-jenkins/pr-logs/pull/kubeflow_kubeflow/4201/kubeflow-presubmit/1178021440037851136/>https://prow.k8s.io/view/gcs/kubernetes-jenkins/pr-logs/pull/kubeflow_kubeflow/4201/kubeflow-presubmit/1178021440037851136/</denchmark-link>\n \n That PR correctly invoked jupyter_test.py and if we look at the Argo Spec; workingDir is set on the container.\n One possibility is that run_e2e_workflow.py isn't correctly checking out the modified kfctl_e2e_workflow.py script in presubmits and using that to generate the graph.\n But if that was the case I'd be hard pressed to explain why we haven't seen more problems before now due to that.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "richardsliu", "commentT": "2019-10-03T01:04:48Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jlewi>@jlewi</denchmark-link>\n  Do these paths have any effect? <denchmark-link:https://github.com/kubeflow/kubeflow/blob/master/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py#L260>https://github.com/kubeflow/kubeflow/blob/master/py/kubeflow/kubeflow/ci/kfctl_e2e_workflow.py#L260</denchmark-link>\n \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "richardsliu", "commentT": "2019-10-03T01:06:42Z", "comment_text": "\n \t\tHere's why this wasn't caught by presubmits.\n <denchmark-link:https://github.com/kubeflow/testing/pull/474>kubeflow/testing#474</denchmark-link>\n  changed argo_built_util.py to make a copy of the task template. That would explain why kfctl_e2e_workflow.py suddenly stopped setting workingDir correctly on various steps.\n Since that change is in the kubeflow/testing workflow it didn't trigger the E2E tests. But on the next run of the E2E tests in kubeflow/kubeflow those changes would be picked up.\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "richardsliu", "commentT": "2019-10-03T01:15:34Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/richardsliu>@richardsliu</denchmark-link>\n  the python path matters in order to be able to import kubeflow code inside the tests. But the way we invoke the test e.g.  doesn't depend on the python path but does depend on the working directory to find conftest.py which defines the command line arguments for pytest. Since we weren't running in the right directory it wasn't finding the conftest path that defines the arguments like namespace.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "richardsliu", "commentT": "2019-10-07T23:11:59Z", "comment_text": "\n \t\tI think this one can be closed now?\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "richardsliu", "commentT": "2019-10-10T23:03:40Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/richardsliu>@richardsliu</denchmark-link>\n  I added triage, can we close ?\n \t\t"}}}, "commit": {"commit_id": "10d9477c8227c89539695dbcaac8f0776be274cf", "commit_author": "Jeremy Lewi", "commitT": "2019-10-02 18:58:08-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "py\\kubeflow\\kubeflow\\ci\\kfctl_e2e_workflow.py", "file_new_name": "py\\kubeflow\\kubeflow\\ci\\kfctl_e2e_workflow.py", "file_complexity": {"file_NLOC": "427", "file_CCN": "12", "file_NToken": "2000"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "586", "deleted_lines": "580", "method_info": {"method_name": "build", "method_params": "self", "method_startline": "485", "method_endline": "629", "method_complexity": {"method_NLOC": "84", "method_CCN": "3", "method_NToken": "490", "method_nesting_level": "1"}}}}}}}}