{"BR": {"BR_id": "4136", "BR_author": "hemantha-kumara", "BRopenT": "2019-09-17T14:14:43Z", "BRcloseT": "2019-10-07T03:55:09Z", "BR_text": {"BRsummary": "Issue while merging PatchesJson6902 in MergeKustomizations", "BRdescription": "\n /kind bug\n What steps did you take and what happened:\n Added one more overlay for argo componet to update ClusterRoles using PatchesJson6902\n content of argo kustomization(argo/overlays/csf/kustomization.yaml) as below\n <denchmark-code>apiVersion: kustomize.config.k8s.io/v1beta1\n kind: Kustomization\n bases:\n - ../../base\n patchesJson6902:\n - target:\n     group: rbac.authorization.k8s.io\n     version: v1beta1\n     kind: ClusterRole\n     name: argo\n   path: patch.yaml\n - target:\n     group: rbac.authorization.k8s.io\n     version: v1beta1\n     kind: ClusterRole\n     name: argo-ui\n   path: patch2.yaml\n </denchmark-code>\n \n patch.yaml &  patch2.yaml contents are as below\n \n op: add\n path: /rules/0\n value:\n apiGroups:\n - extensions\n resourceNames:\n - privileged\n resources:\n - podsecuritypolicies\n verbs:\n - use\n \n What did you expect to happen:\n After kfctl generate I was expecting two patch files argo-ClusterRole.yaml &  argo-ui-ClusterRole.yaml will get created with proper patch link in  new kustomization.yaml\n <denchmark-code>apiVersion: kustomize.config.k8s.io/v1beta1\n bases:\n - base\n configurations:\n - overlays/istio/params.yaml\n kind: Kustomization\n namespace: kubeflow\n patchesJson6902:\n - path: argo-ClusterRole.yaml\n   target:\n     group: rbac.authorization.k8s.io\n     kind: ClusterRole\n     name: argo\n     version: v1beta1\n - path: argo-ui-ClusterRole.yaml\n   target:\n     group: rbac.authorization.k8s.io\n     kind: ClusterRole\n     name: argo-ui\n     version: v1beta1\n resources:\n - overlays/istio/virtual-service.yaml\n </denchmark-code>\n \n Instead i see only argo-ui-ClusterRole.yaml file is created with both patches added which is wrong\n <denchmark-code>ls kustomize/argo/\n argo-ui-ClusterRole.yaml  base  kustomization.yaml  overlays\n </denchmark-code>\n \n Anything else you would like to add:\n I could see problem in this line \n \n \n kubeflow/bootstrap/pkg/kfapp/kustomize/kustomize.go\n \n \n          Line 972\n       in\n       0d52bb5\n \n \n \n \n \n \n  aggregatedPatch.Path = key + \".yaml\" \n \n \n \n \n  where differnt path is added  for each PatchesJson6902 key(name) patch but while creating new patch files only one file is created \n \n \n kubeflow/bootstrap/pkg/kfapp/kustomize/kustomize.go\n \n \n          Line 993\n       in\n       0d52bb5\n \n \n \n \n \n \n  patchErr := ioutil.WriteFile(patchFile, aggregatedPatchOps, 0644) \n \n \n \n \n \n Environment:\n \n Kubeflow version: build version v0.6.2\n kfctl version: kfctl v0.6.2-0-g47a0e4c7\n Kubernetes platform: k8s cluster\n Kubernetes version:\n \n <denchmark-code>Client Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.3\", GitCommit:\"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T01:44:30Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n Server Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.3\", GitCommit:\"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T01:36:19Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n </denchmark-code>\n \n \n OS :\n \n <denchmark-code>NAME=\"CentOS Linux\"\n VERSION=\"7 (Core)\"\n ID=\"centos\"\n ID_LIKE=\"rhel fedora\"\n VERSION_ID=\"7\"\n PRETTY_NAME=\"CentOS Linux 7 (Core)\"\n ANSI_COLOR=\"0;31\"\n CPE_NAME=\"cpe:/o:centos:centos:7\"\n HOME_URL=\"https://www.centos.org/\"\n BUG_REPORT_URL=\"https://bugs.centos.org/\"\n \n CENTOS_MANTISBT_PROJECT=\"CentOS-7\"\n CENTOS_MANTISBT_PROJECT_VERSION=\"7\"\n REDHAT_SUPPORT_PRODUCT=\"centos\"\n REDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hemantha-kumara", "commentT": "2019-09-17T14:14:59Z", "comment_text": "\n \t\tIssue Label Bot is not confident enough to auto-label this issue.\n See <denchmark-link:https://mlbot.net/data/kubeflow/kubeflow>dashboard</denchmark-link>\n  for more details.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "hemantha-kumara", "commentT": "2019-10-02T14:27:57Z", "comment_text": "\n \t\t/priority p0\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "hemantha-kumara", "commentT": "2019-10-02T14:28:03Z", "comment_text": "\n \t\t/area kfctl\n \t\t"}}}, "commit": {"commit_id": "2395c5fc0d384cf6dd4d7167bbe9010cd1315b54", "commit_author": "Hemantha kumara M S", "commitT": "2019-10-06 20:55:08-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "file_new_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "file_complexity": {"file_NLOC": "927", "file_CCN": "53", "file_NToken": "6414"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "961,962,963,964", "deleted_lines": "942,962,967,968,969,970"}}}}}}