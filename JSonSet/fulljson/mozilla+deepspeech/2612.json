{"BR": {"BR_id": "2612", "BR_author": "lissyx", "BRopenT": "2019-12-19T15:24:38Z", "BRcloseT": "2019-12-20T13:54:55Z", "BR_text": {"BRsummary": "v0.6.0 TFLite regresses in quality?", "BRdescription": "\n Not sure exactly why, but it seems reported by people. <denchmark-link:https://discourse.mozilla.org/t/android-project-with-pb-files-instead-of-tflite/50550/17>https://discourse.mozilla.org/t/android-project-with-pb-files-instead-of-tflite/50550/17</denchmark-link>\n \n Checking myself for IoT demo:\n There's definitively something going on here ...\n <denchmark-code>$ ~/tmp/deepspeech/0.6.0/tfpb/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/deepspeech-0.6.0-models/output_graph.pbmm --lm limited_lm.binary --trie limited_lm.trie --audio deepspeech_dump_all.wav -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n 2019-12-19 16:08:41.433573: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n turn the bedroom lamp light on\n cpu_time_overall=7.25584\n $ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/deepspeech-0.6.0-models/output_graph.tflite --lm limited_lm.binary --trie limited_lm.trie --audio deepspeech_dump_all.wav -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n on the bedroom light on\n cpu_time_overall=12.07772\n </denchmark-code>\n \n And without LM:\n <denchmark-code>$ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/deepspeech-0.6.0-models/output_graph.tflite --audio deepspeech_dump_all.wav -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n no the bederorond lighte pon\n cpu_time_overall=12.68055\n $ ~/tmp/deepspeech/0.6.0/tfpb/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/deepspeech-0.6.0-models/output_graph.pbmm --audio deepspeech_dump_all.wav -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n 2019-12-19 16:11:19.134152: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n  ter de bedroom along light on\n cpu_time_overall=8.49712\n </denchmark-code>\n \n And re-using v0.6.0-alpha.15, which is 0.5.1 re-exported:\n <denchmark-code>alex@portable-alex:~/codaz/Mozilla/DeepSpeech/moziot-deepspeech$ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0a15/en-us/output_graph.tflite --lm limited_lm.binary --trie limited_lm.trie --audio deepspeech_dump_all.wav  -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n the the bedroom lamp light on\n cpu_time_overall=12.38057\n alex@portable-alex:~/codaz/Mozilla/DeepSpeech/moziot-deepspeech$ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0a15/en-us/output_graph.tflite --audio deepspeech_dump_all.wav  -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n derm the bed room lont light on\n cpu_time_overall=12.50523\n </denchmark-code>\n \n Audio was recorded from Firefox Nightly, on RPi4 via WebSocket.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lissyx", "commentT": "2019-12-19T15:49:50Z", "comment_text": "\n \t\tRe-exporting the model with different TFLite conversion parameters does not change.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "lissyx", "commentT": "2019-12-19T16:07:11Z", "comment_text": "\n \t\tRunning 0.6.0a15 model with 0.6.0 binaries yields \"\"good\"\" results, as exposed above. Running 0.6.0 model with 0.6.0a15 yields \"\"bad\"\" results. I think this advocates that something in the model changed and TFLite export impacts it :/.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "lissyx", "commentT": "2019-12-20T11:04:25Z", "comment_text": "\n \t\tI'm wondering if (and if, why) we would need adjustements on the LM weights for TFLite:\n <denchmark-code>$ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/en-us/output_graph.tflite --lm limited_lm.binary --trie limited_lm.trie --audio deepspeech_dump_all.wav --lm_alpha 2.0 --lm_beta 1.0 -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n turn the bedroom light on\n cpu_time_overall=11.44250\n $ ~/tmp/deepspeech/0.6.0/tflite/deepspeech --model ~/tmp/deepspeech/0.6.0/eng/en-us/output_graph.tflite --lm limited_lm.binary --trie limited_lm.trie --audio deepspeech_dump_all.wav -t\n TensorFlow: v1.14.0-21-ge77504a\n DeepSpeech: v0.6.0-0-g6d43e21\n INFO: Initialized TensorFlow Lite runtime.\n on the bedroom light on\n cpu_time_overall=11.42704\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "lissyx", "commentT": "2019-12-20T12:27:06Z", "comment_text": "\n \t\tAs <denchmark-link:https://github.com/reuben>@reuben</denchmark-link>\n  suggested on IRC, this might be a side-effect of CUDNN and incomplete testing on my side for TFLite model.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "lissyx", "commentT": "2019-12-20T12:34:06Z", "comment_text": "\n \t\tIn the meantime of a new release, re-exporting the model from checkpoint with patch from <denchmark-link:https://github.com/mozilla/DeepSpeech/pull/2613>#2613</denchmark-link>\n  should work.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "lissyx", "commentT": "2020-01-19T16:01:41Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "5f003cfbd614d6cb2f576a284b68c2e8d37b7866", "commit_author": "Alexandre Lissy", "commitT": "2019-12-20 13:28:46+01:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "DeepSpeech.py", "file_new_name": "DeepSpeech.py", "file_complexity": {"file_NLOC": "617", "file_CCN": "127", "file_NToken": "5102"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "129", "deleted_lines": null, "method_info": {"method_name": "rnn_impl_static_rnn", "method_params": "x,seq_length,previous_state,reuse", "method_startline": "125", "method_endline": "145", "method_complexity": {"method_NLOC": "15", "method_CCN": "2", "method_NToken": "115", "method_nesting_level": "0"}}}}}}}}