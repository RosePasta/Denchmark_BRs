{"BR": {"BR_id": "2384", "BR_author": "lissyx", "BRopenT": "2019-09-26T12:23:00Z", "BRcloseT": "2019-09-26T21:13:50Z", "BR_text": {"BRsummary": "Investigate long loading time of LM", "BRdescription": "\n On some arch (RPi, Android) we can feel that there's a several-seconds delay when enabling the language model. This is only on first run. LM should already be mmap()'d, so we should investigate what happens, this cripples user experience.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lissyx", "commentT": "2019-09-26T14:27:54Z", "comment_text": "\n \t\t<denchmark-code>pi@raspberrypi:~/ds $ echo \"1\" | sudo tee /proc/sys/vm/drop_caches \n 1\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t\n TensorFlow: v1.14.0-16-g3b4ce37\n DeepSpeech: v0.6.0-alpha.7-0-gf67818e\n INFO: Initialized TensorFlow Lite runtime.\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=2.32796 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.60453 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.15120 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m49.527s\n user    0m5.887s\n sys     0m7.327s\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t\n TensorFlow: v1.14.0-16-g3b4ce37\n DeepSpeech: v0.6.0-alpha.7-0-gf67818e\n INFO: Initialized TensorFlow Lite runtime.\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=2.14526 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.60353 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.15414 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m6.823s\n user    0m5.893s\n sys     0m0.931s\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "lissyx", "commentT": "2019-09-26T14:35:19Z", "comment_text": "\n \t\tWe have 6 seconds of difference on just loading the LM on cold caches:\n <denchmark-code>pi@raspberrypi:~/ds $ echo \"1\" | sudo tee /proc/sys/vm/drop_caches                                                                                                                                                                                                                                                                                                                                               \n 1\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t                                                                                                                                                                                                                                              \n TensorFlow: v1.14.0-16-g3b4ce374f5\n DeepSpeech: v0.6.0-alpha.7-8-g513c8e9\n INFO: Initialized TensorFlow Lite runtime.\n setup_time=6.82576\n lm_time=6.8248\n trie_time=0.000511\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=2.29800 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.58624 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.12006 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m49.456s\n user    0m5.859s\n sys     0m7.298s\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t\n TensorFlow: v1.14.0-16-g3b4ce374f5\n DeepSpeech: v0.6.0-alpha.7-8-g513c8e9\n INFO: Initialized TensorFlow Lite runtime.\n setup_time=0.784094\n lm_time=0.783789\n trie_time=0.000177\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=2.11127 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.57743 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.12058 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m6.734s\n user    0m5.812s\n sys     0m0.922s\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "lissyx", "commentT": "2019-09-26T14:48:20Z", "comment_text": "\n \t\tUsing LoadMethod::LAZY:\n <denchmark-code>pi@raspberrypi:~/ds $ echo \"1\" | sudo tee /proc/sys/vm/drop_caches \n 1\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t\n TensorFlow: v1.14.0-16-g3b4ce374f5\n DeepSpeech: v0.6.0-alpha.7-8-g513c8e9\n INFO: Initialized TensorFlow Lite runtime.\n create_model_time=0.00818\n setup_time=0.002471\n lm_time=0.001803\n trie_time=0.000473\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=3.43854 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.63052 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.31658 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m18.207s\n user    0m6.506s\n sys     0m0.968s\n pi@raspberrypi:~/ds $ time ./deepspeech --model models/output_graph.tflite --alphabet models/alphabet.txt --lm models/lm.binary --trie models/trie --audio audio -t\n TensorFlow: v1.14.0-16-g3b4ce374f5\n DeepSpeech: v0.6.0-alpha.7-8-g513c8e9\n INFO: Initialized TensorFlow Lite runtime.\n create_model_time=0.004335\n setup_time=0.000772\n lm_time=0.000382\n trie_time=0.000247\n Running on directory audio\n > audio/4507-16021-0012.wav\n why should one halt on the way\n cpu_time_overall=2.17790 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/2830-3980-0043.wav\n experienced proof less\n cpu_time_overall=1.58182 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n > audio/8455-210777-0068.wav\n your power is sufficient i said\n cpu_time_overall=2.13153 cpu_time_decoding=0.00000 cpu_time_decodeall=0.00000\n \n real    0m5.988s\n user    0m5.857s\n sys     0m0.130s\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "lissyx", "commentT": "2019-09-26T16:18:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/reuben>@reuben</denchmark-link>\n  Tested on Pixel 2, after rebooting, using SpeechModule (part of androidspeech): no more huge seconds blocking of the UI when starting inference.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "lissyx", "commentT": "2019-09-27T08:41:13Z", "comment_text": "\n \t\tFTR, also checking with htop on RPi4 with 4GB of RAM:\n \n prior to the change, memory usage reported by htop would be ~45%\n after the change, it would only report ~8%.\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "lissyx", "commentT": "2019-10-27T09:16:45Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "86b44a7cb7638cae0b4512e94ae1337ac3244580", "commit_author": "Alexandre Lissy", "commitT": "2019-09-26 21:08:27+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "native_client\\ctcdecode\\scorer.cpp", "file_new_name": "native_client\\ctcdecode\\scorer.cpp", "file_complexity": {"file_NLOC": "212", "file_CCN": "39", "file_NToken": "1548"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "100", "deleted_lines": null, "method_info": {"method_name": "Scorer::setup", "method_params": "lm_path,trie_path", "method_startline": "61", "method_endline": "135", "method_complexity": {"method_NLOC": "56", "method_CCN": "14", "method_NToken": "459", "method_nesting_level": "0"}}}}}}}}