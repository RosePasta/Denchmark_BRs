{"BR": {"BR_id": "1155", "BR_author": "treuille", "BRopenT": "2020-02-27T19:20:47Z", "BRcloseT": "2020-03-25T05:08:30Z", "BR_text": {"BRsummary": "`hash_funcs` should properly handle classes defined in the running app script", "BRdescription": "\n <denchmark-h:h1>Summary</denchmark-h>\n \n A class defined in the running app script is redefined every time the script is run, breaking hash_funcs. This is clearer if you look at the example below.\n <denchmark-h:h2>Steps to reproduce</denchmark-h>\n \n \n Run this:\n \n import streamlit as st\n \n class X:\n   def __init__(self):\n     self.number = 0\n \n @st.cache(allow_output_mutation=True)\n def get_x():\n   return X()\n \n @st.cache(hash_funcs={X : id})\n def should_only_be_run_once(x):\n   x.number += 1\n   return x.number\n \n \"# Test app 1 for `hash_funcs` issue\"\n \n x = get_x()\n \n number = should_only_be_run_once(x)\n \n \"x:\", id(x), '(singleton, should stay constant)'\n 'number:', number, '(should not increment on rerun)'\n \n st.button(\"Rerun\")\n \n \n Click on Rerun\n \n \n Note that the number keeps incrementing. This is because:\n \n \n \n The class X is redefined every time the script is rerun.\n The second time we run should_only_be_run_once, x will have a different type from the redefined X.\n Therefore x won't be in the cache and should_only_be_run_once will not only be done once.\n \n <denchmark-h:h1>Behavior</denchmark-h>\n \n <denchmark-h:h2>Actual behavior</denchmark-h>\n \n Number keeps increasing every time you hit rerun:\n <denchmark-link:https://user-images.githubusercontent.com/1673013/75478620-21a76e80-5953-11ea-8dd9-4fca84cff414.png></denchmark-link>\n \n <denchmark-h:h2>Expected behavior</denchmark-h>\n \n Number should always be 1 because should_only_be_run_once should only run once.\n <denchmark-h:h2>Is this a regression?</denchmark-h>\n \n No\n <denchmark-h:h1>Debug info</denchmark-h>\n \n <denchmark-code>$ streamlit version && python --version && pyenv --version && sw_vers && \"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome\" --version\n \n Streamlit, version 0.52.2.post20200225\n Python 3.6.3\n pyenv 1.2.15\n ProductName:    Mac OS X\n ProductVersion: 10.15.3\n BuildVersion:   19D76\n Google Chrome 80.0.3987.122 \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "treuille", "commentT": "2020-02-27T19:21:23Z", "comment_text": "\n \t\tOne solution would be to do lookups by fully qualified type name, rather than by the type object itself.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "treuille", "commentT": "2020-03-25T05:08:27Z", "comment_text": "\n \t\tClosing this as it was merged in <denchmark-link:https://github.com/streamlit/streamlit/pull/1223>1223</denchmark-link>\n .\n \t\t"}}}, "commit": {"commit_id": "a0ac11b70a426c248dae1596b2e10c42ebed334a", "commit_author": "Jonathan Rhone", "commitT": "2020-03-24 22:43:18-03:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "lib\\streamlit\\caching.py", "file_new_name": "lib\\streamlit\\caching.py", "file_complexity": {"file_NLOC": "540", "file_CCN": "73", "file_NToken": "2611"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "390,391,392,393,394,442,443,449,450,451,452,453,454,455", "deleted_lines": "390,391,392,393,441"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "lib\\streamlit\\hashing.py", "file_new_name": "lib\\streamlit\\hashing.py", "file_complexity": {"file_NLOC": "542", "file_CCN": "139", "file_NToken": "2965"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "330,335,337,431,432", "deleted_lines": "322,324,418,419,420", "method_info": {"method_name": "_to_bytes", "method_params": "self,obj,context", "method_startline": "320", "method_endline": "499", "method_complexity": {"method_NLOC": "108", "method_CCN": "40", "method_NToken": "884", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "237,238,239,240,241,242,243,244,245,246,247,248,249,250", "deleted_lines": "237", "method_info": {"method_name": "__init__", "method_params": "self,hash_funcs", "method_startline": "236", "method_endline": "258", "method_complexity": {"method_NLOC": "11", "method_CCN": "4", "method_NToken": "69", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "280", "deleted_lines": "267", "method_info": {"method_name": "to_bytes", "method_params": "self,obj,context", "method_startline": "260", "method_endline": "303", "method_complexity": {"method_NLOC": "23", "method_CCN": "8", "method_NToken": "164", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "lib\\streamlit\\type_util.py", "file_new_name": "lib\\streamlit\\type_util.py", "file_complexity": {"file_NLOC": "123", "file_CCN": "50", "file_NToken": "693"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "58,59,60", "deleted_lines": null, "method_info": {"method_name": "get_fqn_type", "method_params": "obj", "method_startline": "58", "method_endline": "60", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "51,52,54", "deleted_lines": "51,52,53,55", "method_info": {"method_name": "get_fqn", "method_params": "the_type", "method_startline": "51", "method_endline": "55", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "lib\\tests\\streamlit\\caching_test.py", "file_new_name": "lib\\tests\\streamlit\\caching_test.py", "file_complexity": {"file_NLOC": "422", "file_CCN": "64", "file_NToken": "2298"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "579,580,581,584", "deleted_lines": "559,560,561,564", "method_info": {"method_name": "test_user_hash_error", "method_params": "self", "method_startline": "548", "method_endline": "594", "method_complexity": {"method_NLOC": "36", "method_CCN": "1", "method_NToken": "114", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys", "method_params": "self", "method_startline": "530", "method_endline": "546", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "76", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "536,537", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys.hf_key_as_type", "method_params": "", "method_startline": "536", "method_endline": "537", "method_complexity": {"method_NLOC": "2", "method_CCN": "2", "method_NToken": "15", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "532,533", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys.unhashable_type_func", "method_params": "", "method_startline": "532", "method_endline": "533", "method_complexity": {"method_NLOC": "2", "method_CCN": "2", "method_NToken": "15", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "452", "deleted_lines": null, "method_info": {"method_name": "test_mutation_warning_text", "method_params": "self", "method_startline": "441", "method_endline": "479", "method_complexity": {"method_NLOC": "35", "method_CCN": "1", "method_NToken": "106", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "540,541", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys.hf_key_as_str", "method_params": "", "method_startline": "540", "method_endline": "541", "method_complexity": {"method_NLOC": "2", "method_CCN": "2", "method_NToken": "15", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "lib\\tests\\streamlit\\hashing_test.py", "file_new_name": "lib\\tests\\streamlit\\hashing_test.py", "file_complexity": {"file_NLOC": "522", "file_CCN": "148", "file_NToken": "4057"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "169,170,171,172,173,174,175,176,177,178,179,180", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys", "method_params": "self", "method_startline": "169", "method_endline": "180", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "64", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "171,172", "deleted_lines": null, "method_info": {"method_name": "test_hash_funcs_acceptable_keys.__init__", "method_params": "self", "method_startline": "171", "method_endline": "172", "method_complexity": {"method_NLOC": "2", "method_CCN": "2", "method_NToken": "19", "method_nesting_level": "3"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "lib\\tests\\streamlit\\scriptrunner\\ScriptRunner_test.py", "file_new_name": "lib\\tests\\streamlit\\scriptrunner\\ScriptRunner_test.py", "file_complexity": {"file_NLOC": "339", "file_CCN": "44", "file_NToken": "1914"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "261,262", "deleted_lines": "261", "method_info": {"method_name": "test_multiple_scriptrunners", "method_params": "self", "method_startline": "261", "method_endline": "315", "method_complexity": {"method_NLOC": "37", "method_CCN": "6", "method_NToken": "201", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "262", "deleted_lines": null, "method_info": {"method_name": "off_test_multiple_scriptrunners", "method_params": "self", "method_startline": "262", "method_endline": "316", "method_complexity": {"method_NLOC": "37", "method_CCN": "6", "method_NToken": "201", "method_nesting_level": "1"}}}}}}}}