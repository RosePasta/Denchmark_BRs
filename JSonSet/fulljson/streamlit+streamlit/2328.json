{"BR": {"BR_id": "2328", "BR_author": "tconkling", "BRopenT": "2020-11-09T18:48:48Z", "BRcloseT": "2020-11-10T23:42:10Z", "BR_text": {"BRsummary": "caching: multiple functions can unexpectedly share a MemCache key", "BRdescription": "\n There are two parts to cache retrieval for @st.cache:\n \n \n Retrieve the decorated function's MemCache instance. We use a (func.__module__, func.__qualname__, func) tuple to get the cache_key that uniquely identifies the function. No two functions (even if they have the same name and body) will share the same MemCache.\n \n \n Retrieve the cached value from the function's MemCache. This is where we hash the function's arguments to produce the value_key for looking up the value within the MemCache.\n \n \n We currently pass hash_funcs when computing both cache_key and value_key. This is generally innocuous, since cache_key uses two strings and a function's AST as hash values. However, if you supply a hash_func that operates on string values, you run the risk of having two different functions resolve the same cache_key, and end up unexpectedly sharing a MemCache instance.\n See <denchmark-link:https://discuss.streamlit.io/t/caching-with-hash-funcs-fails-for-similar-methods/6941>this forum issue</denchmark-link>\n  for an example of this bug in action.\n In short, we should not pass hash_funcs to the cache_key hasher. We never want different functions to share the same MemCache instance. (Passing hash_funcs here was an oversight - the solution is to just pass hash_funcs=None!)\n \t"}, "comments": {}}, "commit": {"commit_id": "b7ccd70b7788bae93b74ac1f1c04ef917971b0a5", "commit_author": "Tim Conkling", "commitT": "2020-11-10 15:42:09-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "lib\\streamlit\\caching.py", "file_new_name": "lib\\streamlit\\caching.py", "file_complexity": {"file_NLOC": "540", "file_CCN": "72", "file_NToken": "2596"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "483,487,488,490,491,492,493,494,495,496,497,498,499,500,501", "deleted_lines": "483,488"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "lib\\tests\\streamlit\\caching_test.py", "file_new_name": "lib\\tests\\streamlit\\caching_test.py", "file_complexity": {"file_NLOC": "445", "file_CCN": "72", "file_NToken": "2476"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "354,355", "deleted_lines": null, "method_info": {"method_name": "test_unique_function_caches.foo", "method_params": "", "method_startline": "354", "method_endline": "355", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398", "deleted_lines": null, "method_info": {"method_name": "test_function_name_does_not_use_hashfuncs", "method_params": "self", "method_startline": "383", "method_endline": "398", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "39", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "391,392", "deleted_lines": null, "method_info": {"method_name": "test_function_name_does_not_use_hashfuncs.foo", "method_params": "string_arg", "method_startline": "391", "method_endline": "392", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381", "deleted_lines": null, "method_info": {"method_name": "test_function_body_uses_hashfuncs", "method_params": "self", "method_startline": "365", "method_endline": "381", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "57", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "358,359", "deleted_lines": null, "method_info": {"method_name": "test_unique_function_caches.bar", "method_params": "", "method_startline": "358", "method_endline": "359", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363", "deleted_lines": null, "method_info": {"method_name": "test_unique_function_caches", "method_params": "self", "method_startline": "348", "method_endline": "363", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "42", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "373,374,375,376,377", "deleted_lines": null, "method_info": {"method_name": "test_function_body_uses_hashfuncs.foo", "method_params": "arg", "method_startline": "373", "method_endline": "377", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "2"}}}}}}}}