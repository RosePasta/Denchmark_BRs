{"BR": {"BR_id": "2226", "BR_author": "tconkling", "BRopenT": "2020-10-19T21:17:30Z", "BRcloseT": "2020-11-10T17:39:30Z", "BR_text": {"BRsummary": "Script rerun event can cause `SessionInfo not initialized` error on the frontend", "BRdescription": "\n If a script is rerun very quickly after being started, it's possible to trigger an error on the frontend (\"Tried to use SessionInfo before it was initialized\").\n An easy repro is our streamlit run e2e/scripts/st_experimental_rerun.py test script.\n It seems like what is happening is:\n \n ReportSession._on_scriptrunner_eventreceives a SCRIPT_STARTED event\n It enqueues two messages on its self._report object: \"initialize\" and \"new_report\"\n Before those messages are processed by the Report, the rerun request is handled, ReportSession gets a second SCRIPT_STARTED event, it clears the Report queue, and does not re-enqueue the \"initialize\" event (because it's already been enqueued once for the session).\n \n Should we possibly always enqueue the initialize message whenever a run starts? It's a bit of extra overhead, but it's probably the right thing to do. Right now we're mistakenly assuming state on the client that doesn't always exist.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "tconkling", "commentT": "2020-10-19T21:40:20Z", "comment_text": "\n \t\tI don't know if we can send two Initialize messages in a row. I think a lot of our code expects Initialize to only be sent once per session. But if we can change this, that would be great!\n Another option: don't set the boolean self._sent_initialize_message = True until the message is actually sent. But this would take a little refactoring too...\n \t\t"}}}, "commit": {"commit_id": "ece41b7a4b14f397cb5b50ecec8ad6d8dc822d22", "commit_author": "Tim Conkling", "commitT": "2020-11-10 09:39:29-08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "frontend\\src\\App.test.tsx", "file_new_name": "frontend\\src\\App.test.tsx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "20,31,80,81,90,98,99,100,101,102,103,104,105,106,116,134,144,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244", "deleted_lines": "20,34,35,36,37,38,39,40,41,87,96,104,105,106,108,109,110,111,120,138,148"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "frontend\\src\\App.tsx", "file_new_name": "frontend\\src\\App.tsx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "57,291,292,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,491,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544", "deleted_lines": "290,291,296,297,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,535"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "frontend\\src\\lib\\SessionEventDispatcher.ts", "file_new_name": "frontend\\src\\lib\\SessionEventDispatcher.ts", "file_complexity": {"file_NLOC": "8", "file_CCN": "0", "file_NToken": "53"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19", "deleted_lines": "19"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "frontend\\src\\lib\\SessionInfo.test.ts", "file_new_name": "frontend\\src\\lib\\SessionInfo.test.ts", "file_complexity": {"file_NLOC": "42", "file_CCN": "3", "file_NToken": "242"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "25", "method_endline": "62", "method_complexity": {"method_NLOC": "37", "method_CCN": "1", "method_NToken": "199", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "frontend\\src\\lib\\SessionInfo.ts", "file_new_name": "frontend\\src\\lib\\SessionInfo.ts", "file_complexity": {"file_NLOC": "95", "file_CCN": "12", "file_NToken": "418"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "108", "deleted_lines": null, "method_info": {"method_name": "constructor", "method_params": "sessionId,streamlitVersion,pythonVersion,installationId,installationIdV1,installationIdV2,authorEmail,maxCachedMessageAge,commandLine,userMapboxToken,Args", "method_startline": "108", "method_endline": "145", "method_complexity": {"method_NLOC": "37", "method_CCN": "11", "method_NToken": "128", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "lib\\streamlit\\report_session.py", "file_new_name": "lib\\streamlit\\report_session.py", "file_complexity": {"file_NLOC": "303", "file_CCN": "66", "file_NToken": "1959"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "349,350,351,353,354,355,356,357,358,359,360", "deleted_lines": "351,352,353,355,358", "method_info": {"method_name": "get_deploy_params", "method_params": "self", "method_startline": "349", "method_endline": "360", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "37", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "362,363,365,366,367,369,370,371,372,373,374,375,376,377,378,379,380,381", "deleted_lines": "372,373,374,375,376,377,378,379,380,381,403,404,405,406,407,408,409,410,411,412,413", "method_info": {"method_name": "_enqueue_new_report_message", "method_params": "self", "method_startline": "362", "method_endline": "413", "method_complexity": {"method_NLOC": "36", "method_CCN": "3", "method_NToken": "310", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "351,353,354,355,356,357,358,359,360,362,363,365,366,367,369,370,371,372,373,374,375,376,377,378,379,380,381", "deleted_lines": "351,352,353,355,358,372,373,374,375,376,377,378,379,380,381", "method_info": {"method_name": "_maybe_enqueue_initialize_message", "method_params": "self", "method_startline": "351", "method_endline": "401", "method_complexity": {"method_NLOC": "38", "method_CCN": "3", "method_NToken": "260", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "267", "method_info": {"method_name": "_on_scriptrunner_event", "method_params": "self,event,exception,client_state", "method_startline": "235", "method_endline": "335", "method_complexity": {"method_NLOC": "45", "method_CCN": "13", "method_NToken": "261", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": null, "deleted_lines": "99", "method_info": {"method_name": "__init__", "method_params": "self,ioloop,script_path,command_line,uploaded_file_manager", "method_startline": "65", "method_endline": "110", "method_complexity": {"method_NLOC": "17", "method_CCN": "1", "method_NToken": "121", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "lib\\tests\\streamlit\\report_queue_test.py", "file_new_name": "lib\\tests\\streamlit\\report_queue_test.py", "file_complexity": {"file_NLOC": "186", "file_CCN": "10", "file_NToken": "1852"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "120,134", "deleted_lines": "120,134", "method_info": {"method_name": "test_replace_element", "method_params": "self", "method_startline": "116", "method_endline": "138", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "157", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "60,66,67", "deleted_lines": "60,66,67", "method_info": {"method_name": "test_simple_enqueue", "method_params": "self", "method_startline": "56", "method_endline": "67", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "98", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "92,106", "deleted_lines": "92,106", "method_info": {"method_name": "test_enqueue_three", "method_params": "self", "method_startline": "88", "method_endline": "114", "method_complexity": {"method_NLOC": "23", "method_CCN": "1", "method_NToken": "201", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "73,82", "deleted_lines": "73,82", "method_info": {"method_name": "test_enqueue_two", "method_params": "self", "method_startline": "69", "method_endline": "86", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "131", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "144,159", "deleted_lines": "144,159", "method_info": {"method_name": "test_simple_add_rows", "method_params": "self", "method_startline": "140", "method_endline": "170", "method_complexity": {"method_NLOC": "26", "method_CCN": "1", "method_NToken": "294", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "176,197", "deleted_lines": "176,197", "method_info": {"method_name": "test_add_rows_rerun", "method_params": "self", "method_startline": "172", "method_endline": "208", "method_complexity": {"method_NLOC": "31", "method_CCN": "2", "method_NToken": "302", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "215,251", "deleted_lines": "215,251", "method_info": {"method_name": "test_multiple_containers", "method_params": "self", "method_startline": "210", "method_endline": "254", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "116", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "lib\\tests\\streamlit\\report_test.py", "file_new_name": "lib\\tests\\streamlit\\report_test.py", "file_complexity": {"file_NLOC": "97", "file_CCN": "8", "file_NToken": "755"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "85", "deleted_lines": "85", "method_info": {"method_name": "test_serialize_running_report", "method_params": "self", "method_startline": "83", "method_endline": "115", "method_complexity": {"method_NLOC": "28", "method_CCN": "1", "method_NToken": "183", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "59,68", "deleted_lines": "59,68", "method_info": {"method_name": "test_serialize_final_report", "method_params": "self", "method_startline": "57", "method_endline": "81", "method_complexity": {"method_NLOC": "20", "method_CCN": "2", "method_NToken": "205", "method_nesting_level": "1"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "proto\\streamlit\\proto\\ForwardMsg.proto", "file_new_name": "proto\\streamlit\\proto\\ForwardMsg.proto", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "20,48"}}}, "file_9": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "proto\\streamlit\\proto\\Initialize.proto", "file_new_name": "None", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "proto\\streamlit\\proto\\NewReport.proto", "file_new_name": "proto\\streamlit\\proto\\NewReport.proto", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19,20,21,23,24,25,26,27,28,30,33,37,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97", "deleted_lines": "19,22,25,29"}}}}}}