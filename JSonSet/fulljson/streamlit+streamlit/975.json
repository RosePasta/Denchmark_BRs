{"BR": {"BR_id": "975", "BR_author": "fonnesbeck", "BRopenT": "2020-01-15T19:58:45Z", "BRcloseT": "2020-02-19T20:02:13Z", "BR_text": {"BRsummary": "TypeError with no line reference", "BRdescription": "\n I am getting a TypeError that has no associated line number reference in my Streamlit app code. This makes it impossible to track down. Here is the error:\n <denchmark-code>TypeError: keys must be str, int, float, bool or None, not numpy.int64\n Traceback:\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/__init__.py\", line 442, in write\n     json(arg)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/__init__.py\", line 152, in wrapped_method\n     return method.__get__(dg)(*args, **kwargs)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/DeltaGenerator.py\", line 135, in wrapped_method\n     return dg._enqueue_new_element_delta(marshall_element, delta_type, last_index)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/DeltaGenerator.py\", line 392, in _enqueue_new_element_delta\n     rv = marshall_element(msg.delta.new_element)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/DeltaGenerator.py\", line 133, in marshall_element\n     return method(dg, element, *args, **kwargs)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/site-packages/streamlit/DeltaGenerator.py\", line 645, in json\n     else json.dumps(body, default=lambda o: str(type(o)))\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/json/__init__.py\", line 238, in dumps\n     **kw).encode(obj)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/json/encoder.py\", line 199, in encode\n     chunks = self.iterencode(o, _one_shot=True)\n   File \"/home/fonnesbeck/anaconda3/envs/heat_maps/lib/python3.7/json/encoder.py\", line 257, in iterencode\n     return _iterencode(o, 0)\n </denchmark-code>\n \n Notice that all of the traceback info is for library code, and no application code.\n <denchmark-h:h1>Debug info</denchmark-h>\n \n \n Streamlit version: 0.52.2\n Python version: 3.7.4\n Using Conda\n OS version: Debian 9\n Browser version: Chrome 80\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "fonnesbeck", "commentT": "2020-01-15T20:07:46Z", "comment_text": "\n \t\tAdditional information: I tracked this down to an attempt to write (via st.write) a dict of dicts. When I instead tried to write one of the sub-dictionaries, it ran without error.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "fonnesbeck", "commentT": "2020-01-17T12:16:13Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/fonnesbeck>@fonnesbeck</denchmark-link>\n ,\n Can you please send a code snippet?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "fonnesbeck", "commentT": "2020-02-12T23:52:11Z", "comment_text": "\n \t\tFrom what I can gather, if you have a number generated by numpy embedded in one of the dictionaries, it breaks the JSON encoder Streamlit uses to send code blocks.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "fonnesbeck", "commentT": "2020-02-13T21:20:44Z", "comment_text": "\n \t\tCan reproduce this bug with the following code:\n <denchmark-code>import streamlit as st\n import numpy as np\n n = np.array([1, 2, 3, 4, 5])\n dict1 = {'dict1': ['normal', 'list'] }\n dict2 = {n[0]: dict1}\n st.write(dict2)\n </denchmark-code>\n \n The trouble doesn't arise when trying to display a full nparray, only just an element out of the array which would have a special numpy type like int64.  So this code works fine, with the following display as a result:\n <denchmark-code>import streamlit as st\n import numpy as np\n n = np.array([1, 2, 3, 4, 5])\n dict3 = {'array': n}\n st.write(dict3)\n </denchmark-code>\n \n <denchmark-link:https://user-images.githubusercontent.com/98836/74479485-11c46080-4e64-11ea-84df-f783e83bb284.png></denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "fonnesbeck", "commentT": "2020-02-18T21:43:34Z", "comment_text": "\n \t\tProposed change: catch TypeError and its error message.  Run json.dumps on the body with skipkeys=True, which will strip out the problematic keys.  Show the following warning to the user when this happens:\n <denchmark-link:https://user-images.githubusercontent.com/98836/74780540-a5c36d00-5254-11ea-901d-75d6662088a7.png></denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "fonnesbeck", "commentT": "2020-02-19T20:02:12Z", "comment_text": "\n \t\tClosing since fix was just merged.  Will probably go into the next release.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "fonnesbeck", "commentT": "2020-02-19T20:06:08Z", "comment_text": "\n \t\tFor anyone who sees the above warning: what you need to do is change the contents of your data structure so that they don't contain keys that come straight from Numpy, but rather plain python ints, floats or strings.\n We considered doing a custom JSON encoder, but it gets complicated to accommodate the keys, since json.dumps only provides easy methods of changing how the values are processed.\n \t\t"}}}, "commit": {"commit_id": "c8f8a19ffdc797a27ee7098b7b584ed5e99f9488", "commit_author": "Naomi Most", "commitT": "2020-02-19 12:00:54-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.45454545454545453"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "lib\\streamlit\\DeltaGenerator.py", "file_new_name": "lib\\streamlit\\DeltaGenerator.py", "file_complexity": {"file_NLOC": "1011", "file_CCN": "159", "file_NToken": "5648"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "607,608,609,610,611,612,613,614,615,616,617,618,619", "deleted_lines": "607,608,609,610,611", "method_info": {"method_name": "json", "method_params": "self,element,body", "method_startline": "579", "method_endline": "619", "method_complexity": {"method_NLOC": "12", "method_CCN": "3", "method_NToken": "92", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "lib\\tests\\streamlit\\streamlit_test.py", "file_new_name": "lib\\tests\\streamlit\\streamlit_test.py", "file_complexity": {"file_NLOC": "443", "file_CCN": "63", "file_NToken": "4087"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "392,393,394,395,396,397,398,399,400", "deleted_lines": null, "method_info": {"method_name": "test_st_json", "method_params": "self", "method_startline": "385", "method_endline": "400", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "92", "method_nesting_level": "1"}}}}}}}}