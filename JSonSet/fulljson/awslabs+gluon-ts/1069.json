{"BR": {"BR_id": "1069", "BR_author": "lostella", "BRopenT": "2020-10-01T16:08:46Z", "BRcloseT": "2020-10-03T13:18:45Z", "BR_text": {"BRsummary": "MQCNNEstimator behaves strangely results when constructed with distr_output", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n I'm getting NaN loss, or inconsistent shapes in the forecast object, when training a MQCNNEstimator with the distr_output option instead of quantiles.\n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n (Please provide minimal example of code snippet that reproduces the error. For existing examples, please provide link.)\n from gluonts.dataset.repository.datasets import get_dataset\n from gluonts.distribution import StudentTOutput\n from gluonts.model.seq2seq import MQCNNEstimator\n from gluonts.trainer import Trainer\n \n dataset = get_dataset(\"m4_hourly\")\n estimator = MQCNNEstimator(freq=\"H\", prediction_length=1, distr_output=StudentTOutput(), trainer=Trainer(epochs=1, learning_rate=1e-4))\n predictor = estimator.train(dataset.train)\n \n for forecast in predictor.predict(dataset.test):\n     print(forecast.distribution)\n     break\n <denchmark-h:h2>Error message or code output</denchmark-h>\n \n Often times the above results in NaN loss at the first training iteration (this often happens when putting e.g. prediction_length=24, if not always). Otherwise I get the following prediction\n <denchmark-code>gluonts.mx.distribution.transformed_distribution.TransformedDistribution(base_distribution=gluonts.mx.distribution.student_t.StudentT(F=None, mu=mxnet.nd.array([52.238128662109375], dtype=numpy.float32), nu=mxnet.nd.array([2.0], dtype=numpy.float32), sigma=mxnet.nd.array([302.1168518066406], dtype=numpy.float32)), transforms=[gluonts.mx.distribution.bijection.AffineTransformation(loc=mxnet.nd.array([[0.0]], dtype=numpy.float32), scale=mxnet.nd.array([[1.0]], dtype=numpy.float32))])\n </denchmark-code>\n \n Note that the loc and scale of the AffineTransformation have one additional axis which shouldn't be there. (They should have the same shape as mu, nu, sigma.)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lostella", "commentT": "2020-10-01T18:49:37Z", "comment_text": "\n \t\tThe occurrence of nans is probably due to scaling being disabled by default; the shape issue is likely due to the scaler being initialized with keepdims=True\n \t\t"}}}, "commit": {"commit_id": "48a8b04478a4bfcbc6aed39f9886aa49f5d5d4d4", "commit_author": "Danielle Robinson", "commitT": "2020-10-02 11:11:47+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\gluonts\\model\\seq2seq\\_forking_estimator.py", "file_new_name": "src\\gluonts\\model\\seq2seq\\_forking_estimator.py", "file_complexity": {"file_NLOC": "397", "file_CCN": "23", "file_NToken": "1550"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "415", "deleted_lines": null, "method_info": {"method_name": "create_training_network", "method_params": "self", "method_startline": "403", "method_endline": "417", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "83", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "158", "deleted_lines": "157", "method_info": {"method_name": "__init__", "method_params": "self,Seq2SeqEncoder,Seq2SeqDecoder,str,int,None,None,None,bool,bool,bool,None,None,bool,bool,bool,bool,Trainer", "method_startline": "139", "method_endline": "162", "method_complexity": {"method_NLOC": "24", "method_CCN": "1", "method_NToken": "156", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\gluonts\\model\\seq2seq\\_forking_network.py", "file_new_name": "src\\gluonts\\model\\seq2seq\\_forking_network.py", "file_complexity": {"file_NLOC": "292", "file_CCN": "5", "file_NToken": "976"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "80", "deleted_lines": "80", "method_info": {"method_name": "__init__", "method_params": "self,Seq2SeqEncoder,Seq2SeqEnc2Dec,Seq2SeqDecoder,int,None,None,bool,bool,DType,None,kwargs", "method_startline": "70", "method_endline": "84", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "84", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "80", "deleted_lines": "80", "method_info": {"method_name": "__init__", "method_params": "self,Seq2SeqEncoder,Seq2SeqEnc2Dec,Seq2SeqDecoder,int,None,None,bool,bool,DType,None,kwargs", "method_startline": "70", "method_endline": "84", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "84", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\gluonts\\model\\seq2seq\\_mq_dnn_estimator.py", "file_new_name": "src\\gluonts\\model\\seq2seq\\_mq_dnn_estimator.py", "file_complexity": {"file_NLOC": "329", "file_CCN": "14", "file_NToken": "1388"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "320,324", "deleted_lines": "318,322", "method_info": {"method_name": "__init__", "method_params": "self,int,str,None,None,Trainer", "method_startline": "315", "method_endline": "326", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "86", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "143", "deleted_lines": "141", "method_info": {"method_name": "__init__", "method_params": "self,str,int,None,bool,bool,bool,None,None,bool,bool,bool,bool,None,None,None,None,None,bool,None,None,Trainer", "method_startline": "120", "method_endline": "146", "method_complexity": {"method_NLOC": "27", "method_CCN": "1", "method_NToken": "206", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "320,324", "deleted_lines": "318,322", "method_info": {"method_name": "__init__", "method_params": "self,int,str,None,None,Trainer", "method_startline": "313", "method_endline": "324", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "80", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\model\\seq2seq\\test_model.py", "file_new_name": "test\\model\\seq2seq\\test_model.py", "file_complexity": {"file_NLOC": "181", "file_CCN": "11", "file_NToken": "1105"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "67", "deleted_lines": "67"}}}}}}