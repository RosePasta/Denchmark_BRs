{"BR": {"BR_id": "535", "BR_author": "rshyamsundar", "BRopenT": "2019-12-17T23:12:41Z", "BRcloseT": "2019-12-19T10:26:57Z", "BR_text": {"BRsummary": "Binned distribution gives wrong quantiles if the probability of first bin is nonzero", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n While expanding bin centers, <denchmark-link:https://github.com/awslabs/gluon-ts/blob/a9cde7bf92178b4cf8010a4c8600940b595f2ae3/src/gluonts/distribution/binned.py#L154>the code</denchmark-link>\n  incorrectly adds the probabilities of the first bin to the bin centers (<denchmark-link:https://github.com/awslabs/gluon-ts/blob/a9cde7bf92178b4cf8010a4c8600940b595f2ae3/src/gluonts/distribution/binned.py#L138>zeros_cdf has the probabilities of the initial bin for all batch elements/time points</denchmark-link>\n ).\n Also the <denchmark-link:https://github.com/awslabs/gluon-ts/blob/a9cde7bf92178b4cf8010a4c8600940b595f2ae3/src/gluonts/distribution/binned.py#L146>index</denchmark-link>\n  returned is always zero and hence the quantile returned is the first bin + probability of the first bin, unless the initial bin probability is zero which is always the case in <denchmark-link:https://github.com/awslabs/gluon-ts/blob/a9cde7bf92178b4cf8010a4c8600940b595f2ae3/test/distribution/test_distribution_sampling.py#L84>tests</denchmark-link>\n .\n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n <denchmark-code>In [1]: import mxnet as mx                                                                                                                                                                     \n from\n In [2]: from gluonts.distribution import Binned                                                                                                                                                \n \n In [3]: binned = Binned(bin_probs=mx.nd.array([[0.5, 0.2, 0.15, 0.15]]), bin_centers=mx.nd.array([[1e-4, 1e-3, 1e-2, 1e-1]]))                                                                  \n \n In [4]: binned.quantile(mx.nd.array([0.1, 0.5, 0.7, 0.9, 0.999]))                                                                                                                              \n Out[4]: \n \n [[0.5001]\n  [0.5001]\n  [0.5001]\n  [0.5001]\n  [0.5001]]\n <NDArray 5x1 @cpu(0)>\n \n </denchmark-code>\n \n <denchmark-h:h2>Fix</denchmark-h>\n \n Replacing  by  <denchmark-link:https://github.com/awslabs/gluon-ts/blob/a9cde7bf92178b4cf8010a4c8600940b595f2ae3/src/gluonts/distribution/binned.py#L138>here</denchmark-link>\n  seems to solve both  problems. I think  was meant to be zeros not the probabilities of the first bin.\n After fix:\n <denchmark-code>In [4]: binned.quantile(mx.nd.array([0.1, 0.5, 0.7, 0.9, 0.999]))                                                                                                                              \n Out[4]: \n \n [[1.e-04]\n  [1.e-03]\n  [1.e-02]\n  [1.e-01]\n  [1.e-01]]\n <NDArray 5x1 @cpu(0)>\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "rshyamsundar", "commentT": "2019-12-17T23:30:13Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/rshyamsundar>@rshyamsundar</denchmark-link>\n  the bin centers appear not to be sorted in your example: does the distribution assume that they are?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "rshyamsundar", "commentT": "2019-12-17T23:34:13Z", "comment_text": "\n \t\tRight, it assumes it is sorted but the result would still be wrong. Let me update the example.\n \t\t"}}}, "commit": {"commit_id": "a6d09a1bf1080a3dda68195a96e7c313e95223b0", "commit_author": "Syama Sundar Rangapuram", "commitT": "2019-12-19 11:26:54+01:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\gluonts\\distribution\\binned.py", "file_new_name": "src\\gluonts\\distribution\\binned.py", "file_complexity": {"file_NLOC": "179", "file_CCN": "23", "file_NToken": "1293"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "132,133,134,135", "deleted_lines": "132,133,134", "method_info": {"method_name": "quantile", "method_params": "self,Tensor", "method_startline": "128", "method_endline": "160", "method_complexity": {"method_NLOC": "20", "method_CCN": "1", "method_NToken": "176", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\distribution\\test_distribution_sampling.py", "file_new_name": "test\\distribution\\test_distribution_sampling.py", "file_complexity": {"file_NLOC": "165", "file_CCN": "5", "file_NToken": "1413"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "84", "deleted_lines": "84"}}}}}}