{"BR": {"BR_id": "629", "BR_author": "ksawiprotocol", "BRopenT": "2020-02-12T16:16:14Z", "BRcloseT": "2020-02-20T13:07:15Z", "BR_text": {"BRsummary": "NBeats network shares wrong parameters between blocks in sharing mode.", "BRdescription": "\n Setting NBeats estimator to generic mode with default parameters except for:\n num_blocks=[4] and sharing=True\n Getting model to train produces such error:\n  AssertionError: Cannot retrieve Parameter 'nbeatstrainingnetwork8_nbeatsgenericblock58_dense5_weight' because desired attribute does not match with stored for attribute 'shape': desired '(7, 0)' vs stored '(28, 0)'.\n I can provide whole error if needed but it was quite long and I think described issue clearly below.\n My forcast horizon is set to 7 timesteps as you can see and backcast is set to 4 * forecast.\n I've tracked the problem and it is simply because of naming convention for layers while copying them.\n It is produced by lines <denchmark-link:https://github.com/awslabs/gluon-ts/blob/167772820d87f7481a2305691678741d67d9326e/src/gluonts/model/n_beats/_network.py#L445>445-449</denchmark-link>\n  from _network.py and following creation of NBEATSBlocks.\n With the current naming convention of layers wrong parameters are trying to be shared with the last block.\n With default parameters each block has 1 input layer, 3 hidden layers, theta_backcast layer, backcast layer, theta_forecast layer and forecast layer resulting in this example in 8 layers. Layers are named \"dense[0:7]\". But the last block has only 6 layers because there are no theta_backcast layer and backcast layer .\n While copying parameters gluon is looking at the name of the parameter so in the case of 5th layer from last block (theta_forecast layer) it is trying to copy parameter from 5th layer from previous block which is in this case a theta_backcast layer.\n Copying parameters by name happens in <denchmark-link:https://github.com/apache/incubator-mxnet/blob/bdd34e97bab787597dafaa349d05ea7e96deda8a/python/mxnet/gluon/block.py#L55>_BlockScope</denchmark-link>\n  class create method from block.py file in gluon package.\n <denchmark-link:https://github.com/AaronSpieler>@AaronSpieler</denchmark-link>\n  <denchmark-link:https://github.com/lostella>@lostella</denchmark-link>\n   can you take a look?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ksawiprotocol", "commentT": "2020-02-20T12:29:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ksawiprotocol>@ksawiprotocol</denchmark-link>\n  Thanks for your bug report and insight, you caught a major bug!\n \t\t"}}}, "commit": {"commit_id": "53976b5b7a2ba0d212ed22e7d8ec63c288ddcdf9", "commit_author": "Aaron Spieler", "commitT": "2020-02-20 13:52:28+01:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\gluonts\\model\\n_beats\\_network.py", "file_new_name": "src\\gluonts\\model\\n_beats\\_network.py", "file_complexity": {"file_NLOC": "573", "file_CCN": "30", "file_NToken": "2307"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "211,212,215,216,219,220,223,224", "deleted_lines": "207,210,213,216", "method_info": {"method_name": "__init__", "method_params": "self,kwargs", "method_startline": "205", "method_endline": "225", "method_complexity": {"method_NLOC": "20", "method_CCN": "2", "method_NToken": "127", "method_nesting_level": "1"}}}}}}}}