{"BR": {"BR_id": "91", "BR_author": "houchangtao", "BRopenT": "2019-06-07T17:09:34Z", "BRcloseT": "2019-06-09T12:48:44Z", "BR_text": {"BRsummary": "Quick Start Example with \"NegativeBinomialOutput\" throw exception", "BRdescription": "\n System: Ubuntu 16.04\n Python: 3.6.4\n mxnet: 1.4.1\n Code to reproduce:\n <denchmark-code>import pandas as pd\n url = \"https://raw.githubusercontent.com/numenta/NAB/master/data/realTweets/Twitter_volume_AMZN.csv\"\n df = pd.read_csv(url, header=0, index_col=0)\n from gluonts.dataset.common import ListDataset\n training_data = ListDataset(\n     [{\"start\": df.index[0], \"target\": df.value[:\"2015-04-05 00:00:00\"]}],\n     freq = \"5min\"\n )\n from gluonts.model.deepar import DeepAREstimator\n from gluonts.trainer import Trainer\n from gluonts.distribution import NegativeBinomialOutput, StudentTOutput\n estimator = DeepAREstimator(freq=\"5min\", prediction_length=12, distr_output=NegativeBinomialOutput(),\n                             trainer=Trainer(epochs=10))\n predictor = estimator.train(training_data=training_data)\n </denchmark-code>\n \n <denchmark-code>Exception:\n DeferredInitializationError               Traceback (most recent call last)\n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in _call_cached_op(self, *args)\n     802             cargs = [args[i] if is_arg else i.data()\n --> 803                      for is_arg, i in self._cached_op_args]\n     804         except DeferredInitializationError:\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in <listcomp>(.0)\n     802             cargs = [args[i] if is_arg else i.data()\n --> 803                      for is_arg, i in self._cached_op_args]\n     804         except DeferredInitializationError:\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/parameter.py in data(self, ctx)\n     493                                \"instead.\" % (self.name, str(ctx), self._stype))\n --> 494         return self._check_and_get(self._data, ctx)\n     495 \n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/parameter.py in _check_and_get(self, arr_list, ctx)\n     207                 \"You can also avoid deferred initialization by specifying in_units, \" \\\n --> 208                 \"num_features, etc., for network layers.\"%(self.name))\n     209         raise RuntimeError(\n \n DeferredInitializationError: Parameter 'deepartrainingnetwork0_lstm0_i2h_weight' has not been initialized yet because initialization was deferred. Actual initialization happens during the first forward pass. Please pass one batch of data through the network before accessing Parameters. You can also avoid deferred initialization by specifying in_units, num_features, etc., for network layers.\n \n During handling of the above exception, another exception occurred:\n \n MXNetError                                Traceback (most recent call last)\n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in _deferred_infer_shape(self, *args)\n     788         try:\n --> 789             self.infer_shape(*args)\n     790         except Exception as e:\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in infer_shape(self, *args)\n     861         \"\"\"Infers shape of Parameters from inputs.\"\"\"\n --> 862         self._infer_attrs('infer_shape', 'shape', *args)\n     863 \n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in _infer_attrs(self, infer_fn, attr, *args)\n     850             arg_attrs, _, aux_attrs = getattr(out, infer_fn)(\n --> 851                 **{i.name: getattr(j, attr) for i, j in zip(inputs, args)})\n     852             if arg_attrs is None:\n \n /usr/local/lib/python3.6/site-packages/mxnet/symbol/symbol.py in infer_shape(self, *args, **kwargs)\n     995         try:\n --> 996             res = self._infer_shape_impl(False, *args, **kwargs)\n     997             if res[1] is None:\n \n /usr/local/lib/python3.6/site-packages/mxnet/symbol/symbol.py in _infer_shape_impl(self, partial, *args, **kwargs)\n    1125             ctypes.byref(aux_shape_data),\n -> 1126             ctypes.byref(complete)))\n    1127         if complete.value != 0:\n \n /usr/local/lib/python3.6/site-packages/mxnet/base.py in check_call(ret)\n     251     if ret != 0:\n --> 252         raise MXNetError(py_str(_LIB.MXGetLastError()))\n     253 \n \n MXNetError: Error in operator deepartrainingnetwork0__mul1: [10:04:54] /home/travis/build/dmlc/mxnet-distro/mxnet-build/3rdparty/mshadow/../../src/operator/tensor/../elemwise_op_common.h:135: Check failed: assign(&dattr, vec.at(i)) Incompatible attr in node deepartrainingnetwork0__mul1 at 1-th input: expected [32,24], got [32,32,24]\n \n Stack trace returned 10 entries:\n [bt] (0) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x23d55a) [0x7f44332ff55a]\n [bt] (1) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x23dbc1) [0x7f44332ffbc1]\n [bt] (2) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x4ee78d) [0x7f44335b078d]\n [bt] (3) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x5587d6) [0x7f443361a7d6]\n [bt] (4) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x762338) [0x7f4433824338]\n [bt] (5) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2be2cea) [0x7f4435ca4cea]\n [bt] (6) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2be5658) [0x7f4435ca7658]\n [bt] (7) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(MXSymbolInferShape+0x15ba) [0x7f4435c140ca]\n [bt] (8) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call_unix64+0x4c) [0x7f44791201da]\n [bt] (9) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call+0x26b) [0x7f447911c5cb]\n \n \n \n During handling of the above exception, another exception occurred:\n \n ValueError                                Traceback (most recent call last)\n <ipython-input-6-7512b68a283e> in <module>()\n       1 estimator = DeepAREstimator(freq=\"5min\", prediction_length=12, distr_output=NegativeBinomialOutput(),\n       2                             trainer=Trainer(epochs=10))\n ----> 3 predictor = estimator.train(training_data=training_data)\n \n /usr/local/lib/python3.6/site-packages/gluonts-0.1.1-py3.6.egg/gluonts/model/estimator.py in train(self, training_data)\n     187     def train(self, training_data: Dataset) -> Predictor:\n     188 \n --> 189         training_transformation, trained_net = self.train_model(training_data)\n     190 \n     191         # ensure that the prediction network is created within the same MXNet\n \n /usr/local/lib/python3.6/site-packages/gluonts-0.1.1-py3.6.egg/gluonts/model/estimator.py in train_model(self, training_data)\n     180             net=trained_net,\n     181             input_names=get_hybrid_forward_input_names(trained_net),\n --> 182             train_iter=training_data_loader,\n     183         )\n     184 \n \n /usr/local/lib/python3.6/site-packages/gluonts-0.1.1-py3.6.egg/gluonts/trainer/_base.py in __call__(self, net, input_names, train_iter)\n     256 \n     257                             with mx.autograd.record():\n --> 258                                 output = net(*inputs)\n     259 \n     260                                 # network can returns several outputs, the first being always the loss\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in __call__(self, *args)\n     538             hook(self, args)\n     539 \n --> 540         out = self.forward(*args)\n     541 \n     542         for hook in self._forward_hooks.values():\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in forward(self, x, *args)\n     905             with x.context as ctx:\n     906                 if self._active:\n --> 907                     return self._call_cached_op(x, *args)\n     908 \n     909                 try:\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in _call_cached_op(self, *args)\n     803                      for is_arg, i in self._cached_op_args]\n     804         except DeferredInitializationError:\n --> 805             self._deferred_infer_shape(*args)\n     806             cargs = []\n     807             for is_arg, i in self._cached_op_args:\n \n /usr/local/lib/python3.6/site-packages/mxnet/gluon/block.py in _deferred_infer_shape(self, *args)\n     791             error_msg = \"Deferred initialization failed because shape\"\\\n     792                         \" cannot be inferred. {}\".format(e)\n --> 793             raise ValueError(error_msg)\n     794 \n     795     def _call_cached_op(self, *args):\n \n ValueError: Deferred initialization failed because shape cannot be inferred. Error in operator deepartrainingnetwork0__mul1: [10:04:54] /home/travis/build/dmlc/mxnet-distro/mxnet-build/3rdparty/mshadow/../../src/operator/tensor/../elemwise_op_common.h:135: Check failed: assign(&dattr, vec.at(i)) Incompatible attr in node deepartrainingnetwork0__mul1 at 1-th input: expected [32,24], got [32,32,24]\n \n Stack trace returned 10 entries:\n [bt] (0) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x23d55a) [0x7f44332ff55a]\n [bt] (1) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x23dbc1) [0x7f44332ffbc1]\n [bt] (2) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x4ee78d) [0x7f44335b078d]\n [bt] (3) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x5587d6) [0x7f443361a7d6]\n [bt] (4) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x762338) [0x7f4433824338]\n [bt] (5) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2be2cea) [0x7f4435ca4cea]\n [bt] (6) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(+0x2be5658) [0x7f4435ca7658]\n [bt] (7) /usr/local/lib/python3.6/site-packages/mxnet/libmxnet.so(MXSymbolInferShape+0x15ba) [0x7f4435c140ca]\n [bt] (8) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call_unix64+0x4c) [0x7f44791201da]\n [bt] (9) /usr/local/lib/python3.6/lib-dynload/_ctypes.cpython-36m-x86_64-linux-gnu.so(ffi_call+0x26b) [0x7f447911c5cb]\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "houchangtao", "commentT": "2019-06-08T07:35:41Z", "comment_text": "\n \t\tThe bug is in the  <denchmark-link:https://github.com/awslabs/gluon-ts/blob/master/src/gluonts/distribution/neg_binomial.py#L115-L118>here</denchmark-link>\n , which should just be omitted.\n I'll open a PR as soon as I have tests in place for this.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "houchangtao", "commentT": "2019-06-09T12:48:44Z", "comment_text": "\n \t\tThanks for reporting this! The fix will be included in the next release\n \t\t"}}}, "commit": {"commit_id": "3c6d1106c28143a78def634f23c43e46b5fd047d", "commit_author": "Lorenzo Stella", "commitT": "2019-06-09 14:30:28+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.3333333333333333"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\gluonts\\distribution\\neg_binomial.py", "file_new_name": "src\\gluonts\\distribution\\neg_binomial.py", "file_complexity": {"file_NLOC": "83", "file_CCN": "14", "file_NToken": "575"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "115,116", "deleted_lines": "115,116,117", "method_info": {"method_name": "distribution", "method_params": "self,distr_args,scale", "method_startline": "109", "method_endline": "117", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "76", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\gluonts\\distribution\\piecewise_linear.py", "file_new_name": "src\\gluonts\\distribution\\piecewise_linear.py", "file_complexity": {"file_NLOC": "260", "file_CCN": "23", "file_NToken": "1240"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "300,301", "deleted_lines": null, "method_info": {"method_name": "event_dim", "method_params": "self", "method_startline": "300", "method_endline": "301", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\gluonts\\distribution\\uniform.py", "file_new_name": "src\\gluonts\\distribution\\uniform.py", "file_complexity": {"file_NLOC": "67", "file_CCN": "13", "file_NToken": "450"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "92", "deleted_lines": "92"}}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "test\\distribution\\test_distribution_output_shapes.py", "file_complexity": {"file_NLOC": "111", "file_CCN": "1", "file_NToken": "802"}}}}}