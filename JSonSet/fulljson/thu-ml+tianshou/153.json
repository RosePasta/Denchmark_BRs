{"BR": {"BR_id": "153", "BR_author": "ChenDRAG", "BRopenT": "2020-07-20T11:15:35Z", "BRcloseT": "2020-07-20T14:14:25Z", "BR_text": {"BRsummary": "buffer update fails when stack_num is not 0", "BRdescription": "\n >>> from tianshou.data.buffer import ReplayBuffer\n >>> import numpy as np\n >>> buf1 = ReplayBuffer(4, stack_num=2)\n >>> for i in range(5):\n ...     buf1.add(**{'obs':np.array([i]), 'act':float(i), 'rew':i*i, 'done': False})\n ... \n >>> buf2 = ReplayBuffer(4, stack_num=2)\n >>> buf2.update(buf1)\n >>> print(buf1)\n ReplayBuffer(\n     obs: array([[4],\n                 [1],\n                 [2],\n                 [3]]),\n     act: array([4., 1., 2., 3.]),\n     rew: array([16,  1,  4,  9]),\n     done: array([False, False, False, False]),\n     obs_next: Batch(),\n     info: Batch(),\n     policy: Batch(),\n )\n >>> print(buf2)\n ReplayBuffer(\n     obs: array([[[1],\n                  [1]],\n          \n                 [[1],\n                  [2]],\n          \n                 [[2],\n                  [3]],\n          \n                 [[3],\n                  [4]]]),\n     act: array([1., 2., 3., 4.]),\n     rew: array([ 1,  4,  9, 16]),\n     done: array([False, False, False, False]),\n     obs_next: Batch(),\n     info: Batch(),\n     policy: Batch(),\n )\n I think this is due to the reason that update() uses advanced slice and calls get() in getitem function, which returns stacked results. I will open a PR to fix this if necessary.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ChenDRAG", "commentT": "2020-07-20T11:17:37Z", "comment_text": "\n \t\tin the previous edition, Buffer:update() is never called when stack_num is not 0(even in the unitest), so this was not discovered.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ChenDRAG", "commentT": "2020-07-20T14:14:24Z", "comment_text": "\n \t\tClose as resolved.\n \t\t"}}}, "commit": {"commit_id": "d09b69e594c2bd1d463322d95a448b9df76ef17c", "commit_author": "ChenDRAG", "commitT": "2020-07-20 22:12:57+08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "test\\base\\test_buffer.py", "file_new_name": "test\\base\\test_buffer.py", "file_complexity": {"file_NLOC": "105", "file_CCN": "15", "file_NToken": "1215"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "13,25,26,27,28,29", "method_info": {"method_name": "test_replaybuffer", "method_params": "size,bufsize", "method_startline": "10", "method_endline": "39", "method_complexity": {"method_NLOC": "30", "method_CCN": "5", "method_NToken": "409", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "102,103,104,105,106,107,108,109,110,111,112", "deleted_lines": null, "method_info": {"method_name": "test_update", "method_params": "", "method_startline": "102", "method_endline": "112", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "139", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tianshou\\data\\buffer.py", "file_new_name": "tianshou\\data\\buffer.py", "file_complexity": {"file_NLOC": "420", "file_CCN": "41", "file_NToken": "2350"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "420", "deleted_lines": "411", "method_info": {"method_name": "sample", "method_params": "self,int", "method_startline": "404", "method_endline": "431", "method_complexity": {"method_NLOC": "27", "method_CCN": "5", "method_NToken": "195", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "160,161", "deleted_lines": null, "method_info": {"method_name": "_get_stack_num", "method_params": "self", "method_startline": "160", "method_endline": "161", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "163,164", "deleted_lines": null, "method_info": {"method_name": "_set_stack_num", "method_params": "self,num", "method_startline": "163", "method_endline": "164", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "171,172,178", "deleted_lines": null, "method_info": {"method_name": "update", "method_params": "self", "method_startline": "166", "method_endline": "178", "method_complexity": {"method_NLOC": "13", "method_CCN": "4", "method_NToken": "83", "method_nesting_level": "1"}}}}}}}}