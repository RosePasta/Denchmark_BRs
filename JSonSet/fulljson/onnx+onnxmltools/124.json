{"BR": {"BR_id": "124", "BR_author": "eraoul", "BRopenT": "2018-08-02T00:38:44Z", "BRcloseT": "2018-08-17T19:51:22Z", "BR_text": {"BRsummary": "Unsupported shape calculation for operator Dropout", "BRdescription": "\n I made a new model using keras, and saved it to an .hdf file using a callback during training.\n I reloaded the model and tried to convert to an ONNX model:\n <denchmark-code>model = keras.models.load_model(filename)\n winml_onnx_model = onnxmltools.convert_keras(model)\n </denchmark-code>\n \n convert_keras throws an error here. Any idea what I might be doing wrong? I'm on Windows 10, python 3.6.2, Tensorflow 1.8, Keras 2.1.5, onnxmltools 1.2.0.0116, winmltools 1.2.0.0725\n The model uses the following operators (but the error seems to be due to the Dropout layer):\n Activation, Dropout, BatchNormalization, Convolution2D, MaxPooling2D, GlobalAveragePooling2D\n If I do model.summary() everything seems fine with my model. Batch size is always specified as \"None\" in the model summary, so I wonder if there's some issue with how to deal with batch size in the ONNx conversion (this is my first time making an ONNX model)\n Thanks!\n UPDATE: This simple model gives the same error. I also tried specifying the batch_input_shape explicitly to just allow 1 item in the batch, and it didn't change anything:\n <denchmark-code>model2 = Sequential()\n model2.add(Dense(50, batch_input_shape=[1, 5]))\n model2.add(Dropout(0.5))\n winml_onnx_model2 = onnxmltools.convert_keras(model2)\n \n </denchmark-code>\n \n Error below:\n <denchmark-code>---------------------------------------------------------------------------\n ValueError                                Traceback (most recent call last)\n <ipython-input-15-da007af6c51d> in <module>()\n ----> 1 winml_onnx_model = onnxmltools.convert_keras(model)\n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\main.py in convert_keras(model, name, initial_types, doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\n      36     from .keras.convert import convert\n      37     return convert(model, name, initial_types,\n ---> 38                    doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\keras\\convert.py in convert(model, name, initial_types, doc_string, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\n      40     topology = parse_keras(model, initial_types, targeted_onnx, custom_conversion_functions, custom_shape_calculators)\n      41 \n ---> 42     topology.compile()\n      43 \n      44     if name is None:\n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in compile(self)\n     607         self._resolve_duplicates()\n     608         self._fix_shapes()\n --> 609         self._infer_all_types()\n     610         self._check_structure()\n     611 \n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in _infer_all_types(self)\n     493                 pass  # in Keras converter, the shape calculator can be optional.\n     494             else:\n --> 495                 operator.infer_types()\n     496 \n     497     def _resolve_duplicates(self):\n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_topology.py in infer_types(self)\n      95     def infer_types(self):\n      96         # Invoke a core inference function\n ---> 97         _registration.get_shape_calculator(self.type)(self)\n      98 \n      99 \n \n C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\Anaconda3_64\\lib\\site-packages\\onnxmltools\\convert\\common\\_registration.py in get_shape_calculator(operator_name)\n      66     '''\n      67     if operator_name not in _shape_calculator_pool:\n ---> 68         raise ValueError('Unsupported shape calculation for operator %s' % operator_name)\n      69     return _shape_calculator_pool[operator_name]\n \n ValueError: Unsupported shape calculation for operator <class 'keras.layers.core.Dropout'>\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "eraoul", "commentT": "2018-08-02T04:33:06Z", "comment_text": "\n \t\tI can this is a bug in the converter. You can have a PR for that, or we will fix it soon.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "eraoul", "commentT": "2018-08-02T05:01:27Z", "comment_text": "\n \t\tI think it's a bug caused by a missing converter/shape calculator for Dropout layer. To fix this problem, we need to add a converter (example is <denchmark-link:https://github.com/onnx/onnxmltools/blob/master/onnxmltools/convert/keras/operator_converters/Dense.py>here</denchmark-link>\n ) and a shape calculator (example is <denchmark-link:https://github.com/onnx/onnxmltools/blob/708d3091084da1acf42cf058161017e1152fa337/onnxmltools/convert/keras/shape_calculators/Lazy.py#L54>here</denchmark-link>\n ).\n <denchmark-link:https://github.com/wenbingl>@wenbingl</denchmark-link>\n  , <denchmark-link:https://github.com/duli2012>@duli2012</denchmark-link>\n  , could you find someone to fix this problem? It's quite simple because Dropout is basically an identity operator in prediction phase.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "eraoul", "commentT": "2018-08-02T05:04:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/eraoul>@eraoul</denchmark-link>\n  , using  for batch size is fine for runtime. It's officially supported by ONNX standard. Note that  means a variable-length dimension (think about speed recognition, the length of a sentence is always not deterministic)\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "eraoul", "commentT": "2018-08-02T15:39:34Z", "comment_text": "\n \t\tThanks for the quick feedback. I'll be looking forward to the fix!\n BTW is there a list of supported operations somewhere to track this sort of thing? I expected Dropout to be supported; perhaps there are other ops that should be checked on as well to avoid similar errors?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "eraoul", "commentT": "2018-08-02T15:47:46Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/eraoul>@eraoul</denchmark-link>\n  , good point! We should document the list down. <denchmark-link:https://github.com/wenbingl>@wenbingl</denchmark-link>\n  , <denchmark-link:https://github.com/duli2012>@duli2012</denchmark-link>\n  , could you add a doc string into <denchmark-link:https://github.com/onnx/onnxmltools/blob/708d3091084da1acf42cf058161017e1152fa337/onnxmltools/convert/keras/convert.py#L19>convert of Keras</denchmark-link>\n  (like what we did for <denchmark-link:https://github.com/onnx/onnxmltools/blob/708d3091084da1acf42cf058161017e1152fa337/onnxmltools/convert/sklearn/convert.py#L23>sklearn</denchmark-link>\n )?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "eraoul", "commentT": "2018-08-02T20:06:37Z", "comment_text": "\n \t\tJust for my planning, can you give me an estimate of when your team might be able to fix this Dropout bug? (e.g., days or weeks?) Also, will I need to re-build onnxmltools from source when this goes in or do you update the pip repo frequently?\n Thanks in advance for the help!\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "eraoul", "commentT": "2018-08-03T18:22:27Z", "comment_text": "\n \t\tWe will fix it in the next week.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "eraoul", "commentT": "2018-08-03T18:26:07Z", "comment_text": "\n \t\tThanks Wenbing, that's great news.  Does this mean I'll need to build from\n source after the fix, or will it be fixed in the pip package on pypi?\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Fri, Aug 3, 2018 at 11:22 AM, Wenbing Li ***@***.***> wrote:\n  We will fix it in the next week.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#124 (comment)>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/ABBIPj7BdROHZEjAf7d3Pamh0N6JbfkTks5uNJTpgaJpZM4Vrc7v>\n  .\n \n \n \n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "eraoul", "commentT": "2018-08-03T23:21:30Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/eraoul>@eraoul</denchmark-link>\n  , you can build from source via  once the code is merged. If you have already installed Onnxmltools and want to overwrite it you can do . Releasing may take a while. Thanks.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "eraoul", "commentT": "2018-08-03T23:26:51Z", "comment_text": "\n \t\tPerfect -- thanks!  Will be looking for the update next week.\n \n Cheers,\n Eric\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Fri, Aug 3, 2018 at 4:21 PM, Wei-Sheng Chin ***@***.***> wrote:\n  @eraoul <https://github.com/eraoul> , you can build from source via pip\n  install git+https://github.com/onnx/onnxmltools once the code is merged.\n  If you have already installed Onnxmltools and want to overwrite it you can\n  do pip install -I git+https://github.com/onnx/onnxmltools. Releasing may\n  take a while. Thanks.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#124 (comment)>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/ABBIPpEUzaPEepY29iNapFnfOOgO_F7sks5uNNr7gaJpZM4Vrc7v>\n  .\n \n \n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "eraoul", "commentT": "2018-08-07T23:17:07Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/eraoul>@eraoul</denchmark-link>\n , <denchmark-link:https://github.com/wenbingl>@wenbingl</denchmark-link>\n  just merge a fix for supporting Dropout. Would you mind to try it again? Thanks.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "eraoul", "commentT": "2018-08-15T01:37:27Z", "comment_text": "\n \t\tThanks so much Wei-Sheng and Wenbing -- the converter works for me now.\n Really appreciate the quick fix!\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Tue, Aug 7, 2018 at 4:17 PM, Wei-Sheng Chin ***@***.***> wrote:\n  Hi @eraoul <https://github.com/eraoul>, @wenbingl\n  <https://github.com/wenbingl> just merge a fix for supporting Dropout.\n  Would you mind to try it again? Thanks.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#124 (comment)>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/ABBIPkjwHlontmiFnEZzdEkPqBNapkY_ks5uOh_zgaJpZM4Vrc7v>\n  .\n \n \n \n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "eraoul", "commentT": "2018-08-17T19:51:21Z", "comment_text": "\n \t\tThanks. Let me close this issue.\n \t\t"}}}, "commit": {"commit_id": "727cc8fadfbc17790978bb6c66db461ff62c764d", "commit_author": "Wenbing Li", "commitT": "2018-08-07 16:11:27-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.8181818181818182"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxmltools\\convert\\keras\\__init__.py", "file_new_name": "onnxmltools\\convert\\keras\\__init__.py", "file_complexity": {"file_NLOC": "1", "file_CCN": "0", "file_NToken": "5"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "7", "deleted_lines": "7"}}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "onnxmltools\\convert\\keras\\operator_converters\\Dropout.py", "file_complexity": {"file_NLOC": "9", "file_CCN": "1", "file_NToken": "84"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxmltools\\convert\\keras\\operator_converters\\__init__.py", "file_new_name": "onnxmltools\\convert\\keras\\operator_converters\\__init__.py", "file_complexity": {"file_NLOC": "22", "file_CCN": "0", "file_NToken": "88"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "17", "deleted_lines": "29"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxmltools\\convert\\keras\\shape_calculators\\Lazy.py", "file_new_name": "onnxmltools\\convert\\keras\\shape_calculators\\Lazy.py", "file_complexity": {"file_NLOC": "47", "file_CCN": "1", "file_NToken": "456"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "87,88,89,90,91,92", "deleted_lines": null}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\end2end\\test_single_operator_with_cntk_backend.py", "file_new_name": "tests\\end2end\\test_single_operator_with_cntk_backend.py", "file_complexity": {"file_NLOC": "312", "file_CCN": "54", "file_NToken": "3142"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "177,178,179,180,181,182,183,184,185,186,187,188", "deleted_lines": null, "method_info": {"method_name": "test_dense_with_dropout", "method_params": "self", "method_startline": "177", "method_endline": "188", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "91", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "166", "deleted_lines": "166", "method_info": {"method_name": "test_dense", "method_params": "self", "method_startline": "160", "method_endline": "175", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "124", "method_nesting_level": "1"}}}}}}}}