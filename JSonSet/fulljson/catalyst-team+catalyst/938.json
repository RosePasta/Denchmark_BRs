{"BR": {"BR_id": "938", "BR_author": "zakajd", "BRopenT": "2020-09-12T18:19:38Z", "BRcloseT": "2020-09-26T11:48:34Z", "BR_text": {"BRsummary": "Wrong order of embeddings in CMC score callback", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug Report</denchmark-h>\n \n Order of elements in <denchmark-link:https://github.com/catalyst-team/catalyst/blob/34a69e568c69ab1eb364fc1646623f75756c82d2/catalyst/utils/metrics/cmc_score.py>cmc_score</denchmark-link>\n  function:\n \n query_embeddings: torch.Tensor,\n gallery_embeddings: torch.Tensor,\n conformity_matrix: torch.Tensor,\n topk: int = 1\n \n But in <denchmark-link:https://github.com/catalyst-team/catalyst/blob/34a69e568c69ab1eb364fc1646623f75756c82d2/catalyst/utils/metrics/cmc_score.py>CMCScoreCallback</denchmark-link>\n  you call it with another order of arguments:\n <denchmark-code>            metric = self._metric_fn(\n                 self._gallery_embeddings,!!!\n                 self._query_embeddings,\n                 conformity_matrix,\n                 key,\n             )\n </denchmark-code>\n \n But bug never comes alone, so this works, because conformity_matrix in CMCScoreCallback also has wrong shape (gallery_size, query_size) instead of (query_size, gallery_size).\n <denchmark-h:h2>Solution</denchmark-h>\n \n In CMCScoreCallback:\n <denchmark-code>            metric = self._metric_fn(\n                 self._query_embeddings,\n                 self._gallery_embeddings,\n                 conformity_matrix,\n                 key,\n             )\n </denchmark-code>\n \n And\n <denchmark-code>conformity_matrix = self._query_labels.reshape(-1, 1) == self._gallery_labels\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "zakajd", "commentT": "2020-09-12T18:20:18Z", "comment_text": "\n \t\tHi! Thank you for your contribution! Great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "zakajd", "commentT": "2020-09-12T18:50:11Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/AlekseySh>@AlekseySh</denchmark-link>\n  and <denchmark-link:https://github.com/elephantmipt>@elephantmipt</denchmark-link>\n  fyi :)\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "zakajd", "commentT": "2020-09-19T17:02:06Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/zakajd>@zakajd</denchmark-link>\n ! Thank you for noticing this problem! Can you please review PR with a fix before we merge it?\n \t\t"}}}, "commit": {"commit_id": "19ae8640b3ef084be57dbab26f796011c3cb1121", "commit_author": "Nikita Balagansky", "commitT": "2020-09-25 20:26:03+03:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bin\\tests\\check_dl_core_callbacks.sh", "file_new_name": "bin\\tests\\check_dl_core_callbacks.sh", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "801", "deleted_lines": "801"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "catalyst\\dl\\callbacks\\metrics\\cmc_score.py", "file_new_name": "catalyst\\dl\\callbacks\\metrics\\cmc_score.py", "file_complexity": {"file_NLOC": "113", "file_CCN": "7", "file_NToken": "704"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "141,146,147,148,149", "deleted_lines": "141,146,147,148,149", "method_info": {"method_name": "on_loader_end", "method_params": "self", "method_startline": "131", "method_endline": "153", "method_complexity": {"method_NLOC": "20", "method_CCN": "2", "method_NToken": "104", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\_tests_scripts\\dl_z_mvp_mnist_metric_learning.py", "file_new_name": "tests\\_tests_scripts\\dl_z_mvp_mnist_metric_learning.py", "file_complexity": {"file_NLOC": "75", "file_CCN": "2", "file_NToken": "446"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "82", "deleted_lines": "82", "method_info": {"method_name": "main", "method_params": "", "method_startline": "77", "method_endline": "94", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "60", "method_nesting_level": "0"}}}}}}}}