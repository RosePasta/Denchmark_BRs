{"BR": {"BR_id": "9136", "BR_author": "jdonier", "BRopenT": "2017-04-11T12:47:39Z", "BRcloseT": "2017-04-20T20:42:34Z", "BR_text": {"BRsummary": "Issues when using Queues + tf.train.Server", "BRdescription": "\n NOTE: Issues that are not bugs or feature requests will be closed. Please ask usage questions on StackOverflow.\n <denchmark-h:h3>You must complete this information or else your issue will be closed</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow)?: Yes\n TensorFlow installed from (source or binary)?: binary\n TensorFlow version: 1.0.0 CPU / 1.0.1 (CPU and GPU enabled) / 1.1.0rc1 (CPU)\n Bazel version (if compiling from source):\n CUDA/cuDNN version: N/A\n GPU Model and Memory: N/A\n Exact command to reproduce: cf below.\n \n This problem has been reproduced on both Linux and various Mac OS machines.\n <denchmark-h:h3>Describe the problem clearly</denchmark-h>\n \n We seem to experience issues when using both queues + tf.train.Server. When executed in a simple python 3.5.3 console, the following script hangs:\n <denchmark-code>import tensorflow as tf\n import time\n \n cluster = tf.train.ClusterSpec({\"cpu1\" : ['localhost:2222']})\n server = tf.train.Server(cluster, job_name=\"cpu1\", task_index=0)\n \n with tf.Graph().as_default() as graph:\n     # Queue\n     input_queue = tf.train.input_producer(tf.constant([0.], dtype=tf.float32))\n \n     # Useless variable\n     variable = tf.Variable(1., dtype=tf.float32, trainable=False, name=\"variable\")\n \n     # Session and queue runners\n     session = tf.Session(target=server.target)\n     session.run(tf.global_variables_initializer())\n     tf.train.start_queue_runners(session)\n \n print(session.run(variable))  # this works\n print(session.run(tf.assign(variable, 2)))  # this also works, but only if called directly\n \n # any pause between creating and running the session breaks it\n time.sleep(1)\n \n print(session.run(variable))  # retrieving a variable still works, but...\n print(session.run(tf.assign(variable, 3)))  # ... assigning a variable will make the program hang.\n </denchmark-code>\n \n It outputs:\n <denchmark-code>1\n 2\n 2\n </denchmark-code>\n \n and then hangs forever. The problem vanishes when either commenting the input_queue=... line, or when writing session = tf.Session() instead of passing the server.target.\n The problems seems to happen not only with variable assignments, but also saving the model using tf.train.Saver().save(session, 'my_model') for instance (and possibly other operations). Note that reading a variable works fine.\n In the example script, the time.sleepcommand simulates a pause between creating the session and running it to set a variable. The same effect is achieved, for example, when splitting session creation and running code across two Jupyter notebook cells. When executing the whole code in one cell, it works fine.\n <denchmark-h:h3>Source Code / Logs</denchmark-h>\n \n The source code to reproduce the problem is displayed above. I have attached a traceback using gdb, which shows that the program is hanging while trying to acquire a lock.\n <denchmark-link:https://github.com/tensorflow/tensorflow/files/913097/tf-issue-gdb-bt.txt>tf-issue-gdb-bt.txt</denchmark-link>\n \n <denchmark-link:https://github.com/tensorflow/tensorflow/files/913102/tf-issue-gdb-stack-threads.txt>tf-issue-gdb-stack-threads.txt</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jdonier", "commentT": "2017-04-14T18:09:20Z", "comment_text": "\n \t\tThanks for the detailed report and stacktraces, this helps a lot and is much appreciated.\n <denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  pointed out that we might have a bug when graphs are extended in a distributed session while some operations (in this case the enqueue operation) are in progress (See <denchmark-link:https://github.com/tensorflow/tensorflow/blob/87cdfafd44ff5e332fd820608783432fea83a4c9/tensorflow/core/distributed_runtime/master_session.cc#L1038>master_session.cc:1038</denchmark-link>\n  - that code predates the queue runners).\n <denchmark-link:https://github.com/suharshs>@suharshs</denchmark-link>\n  : Would you have the bandwidth to look into that TODO?\n <denchmark-link:https://github.com/jdonier>@jdonier</denchmark-link>\n  : In the mean time, a workaround for you would be to ensure that the graph isn't modified after the queue runners are started. For example, your snippet above could be rewritten as:\n import tensorflow as tf\n import time\n \n cluster = tf.train.ClusterSpec({\"cpu1\" : ['localhost:2222']})\n server = tf.train.Server(cluster, job_name=\"cpu1\", task_index=0)\n \n with tf.Graph().as_default() as graph:\n     # Queue\n     input_queue = tf.train.input_producer(tf.constant([0.], dtype=tf.float32))\n \n     # Useless variable\n     variable = tf.Variable(1., dtype=tf.float32, trainable=False, name=\"variable\")\n \n     # Session and queue runners\n     session = tf.Session(target=server.target)\n     session.run(tf.global_variables_initializer())\n \n     # CHANGE FROM PREVIOUS SNIPPET: Assign operations\n     assign2 = tf.assign(variable, 2)\n     assign3 = tf.assign(variable, 3)\n \n     tf.train.start_queue_runners(session)\n \n print(session.run(variable))\n print(session.run(assign2))\n \n # Freely sleep\n time.sleep(1)\n \n print(session.run(variable))\n print(session.run(assign3))\n FYI <denchmark-link:https://github.com/jhseu>@jhseu</denchmark-link>\n  <denchmark-link:https://github.com/saeta>@saeta</denchmark-link>\n  who might like to know about this too.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jdonier", "commentT": "2017-04-14T18:44:28Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/asimshankar>@asimshankar</denchmark-link>\n  the reason why I want to modify the graph after the queue runners are started is to change some parameters during / after training (e.g. the training rate during training, or dropout rates between training and inference) so this needs to be done after the queue runners have been started. I guess I could define them as placeholders but it's a bit weird to have to feed these values for every computation...\n About the problem with model saving: I was creating a tf.train.Saver() at saving time, which was causing the problem, consistent with your explanation. It all works fine if I define it when I create the graph -- so thanks a lot!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jdonier", "commentT": "2017-04-18T23:59:21Z", "comment_text": "\n \t\tI have a change coming soon that should fix this. (Thanks <denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n  and <denchmark-link:https://github.com/asimshankar>@asimshankar</denchmark-link>\n  for flagging!)\n \t\t"}}}, "commit": {"commit_id": "1f210ad7c2a81fe27196dd1a85c9bb92f19bc94a", "commit_author": "Brennan Saeta", "commitT": "2017-04-19 10:31:38-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 12, "file_old_name": "tensorflow\\core\\distributed_runtime\\master_session.cc", "file_new_name": "tensorflow\\core\\distributed_runtime\\master_session.cc", "file_complexity": {"file_NLOC": "1132", "file_CCN": "204", "file_NToken": "8274"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1005,1006,1007,1008,1009", "deleted_lines": null, "method_info": {"method_name": "tensorflow::MasterSession::Create", "method_params": "graph_def", "method_startline": "994", "method_endline": "1011", "method_complexity": {"method_NLOC": "16", "method_CCN": "2", "method_NToken": "95", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "798,799", "deleted_lines": "771,772,783", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::ProcessDeviceStats", "method_params": "ph,execution_state,ds,is_rpc", "method_startline": "770", "method_endline": "812", "method_complexity": {"method_NLOC": "36", "method_CCN": "9", "method_NToken": "277", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "482", "deleted_lines": "501,502", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::RunPartitions", "method_params": "env,step_id,execution_count,pss,call_opts,req,resp,cm,is_last_partial_run", "method_startline": "480", "method_endline": "637", "method_complexity": {"method_NLOC": "135", "method_CCN": "31", "method_NToken": "1163", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1268,1269,1270,1271,1272,1285,1286,1294", "deleted_lines": "1292,1293,1306,1307", "method_info": {"method_name": "tensorflow::MasterSession::DoPartialRun", "method_params": "opts,req,resp", "method_startline": "1201", "method_endline": "1307", "method_complexity": {"method_NLOC": "87", "method_CCN": "15", "method_NToken": "690", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "76,77,78", "deleted_lines": "76,77,78,79,80", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::ReffedClientGraph", "method_params": "handle,bopts,cg,session_opts,stats_publisher_factory,execution_state,is_partial,worker_cache", "method_startline": "60", "method_endline": "80", "method_complexity": {"method_NLOC": "18", "method_CCN": "2", "method_NToken": "132", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "706,707,708,709,710,722,728", "deleted_lines": "726,727,728,729,741,747", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::ProcessStats", "method_params": "step_id,pss,ph,options,resp", "method_startline": "706", "method_endline": "749", "method_complexity": {"method_NLOC": "39", "method_CCN": "12", "method_NToken": "274", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "1353,1354,1359,1360", "deleted_lines": "1316,1317,1376,1377,1378", "method_info": {"method_name": "tensorflow::MasterSession::DoRunWithLocalExecution", "method_params": "opts,req,resp", "method_startline": "1309", "method_endline": "1382", "method_complexity": {"method_NLOC": "58", "method_CCN": "8", "method_NToken": "450", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": null, "deleted_lines": "501,502", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::RunPartitions", "method_params": "env,step_id,execution_count,execution_state,pss,call_opts,req,resp,cm,is_last_partial_run", "method_startline": "499", "method_endline": "657", "method_complexity": {"method_NLOC": "136", "method_CCN": "31", "method_NToken": "1167", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1038,1039,1040,1041,1042,1043,1044,1045,1046", "method_info": {"method_name": "tensorflow::MasterSession::Extend", "method_params": "req,resp", "method_startline": "1028", "method_endline": "1064", "method_complexity": {"method_NLOC": "27", "method_CCN": "4", "method_NToken": "147", "method_nesting_level": "1"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "728,752,763", "deleted_lines": "726,727,728,729,741,747", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::ProcessStats", "method_params": "step_id,pss,execution_state,ph,options,resp", "method_startline": "726", "method_endline": "768", "method_complexity": {"method_NLOC": "38", "method_CCN": "12", "method_NToken": "282", "method_nesting_level": "1"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "752,763", "deleted_lines": "771,772,783", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::ProcessDeviceStats", "method_params": "ph,ds,is_rpc", "method_startline": "751", "method_endline": "792", "method_complexity": {"method_NLOC": "35", "method_CCN": "9", "method_NToken": "270", "method_nesting_level": "1"}}}, "hunk_11": {"Ismethod": 1, "added_lines": "133,134,135", "deleted_lines": "149,150", "method_info": {"method_name": "tensorflow::MasterSession::ReffedClientGraph::RetrieveLogs", "method_params": "step_id,ss", "method_startline": "119", "method_endline": "156", "method_complexity": {"method_NLOC": "33", "method_CCN": "6", "method_NToken": "190", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\distributed_runtime\\master_session.h", "file_new_name": "tensorflow\\core\\distributed_runtime\\master_session.h", "file_complexity": {"file_NLOC": "95", "file_CCN": "2", "file_NToken": "583"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "119", "deleted_lines": "119"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\training\\server_lib_test.py", "file_new_name": "tensorflow\\python\\training\\server_lib_test.py", "file_complexity": {"file_NLOC": "339", "file_CCN": "26", "file_NToken": "2555"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "230,231,232,233,234,235,236,237,238,239,240,241,242", "deleted_lines": null, "method_info": {"method_name": "testExtendAfterQueueRunners", "method_params": "self", "method_startline": "230", "method_endline": "242", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "102", "method_nesting_level": "1"}}}}}}}}