{"BR": {"BR_id": "40895", "BR_author": "aroig", "BRopenT": "2020-06-28T17:24:03Z", "BRcloseT": "2020-10-31T00:18:38Z", "BR_text": {"BRsummary": "nested gradients for convolution layer fail under tf.function", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: no\n TensorFlow installed from (source or binary): pip tf_nightly\n TensorFlow version (use command below): v1.12.1-35353-gcbb94efa58 2.5.0-dev20200628\n Python version:3.6.9\n Bazel version (if compiling from source): -\n GCC/Compiler version (if compiling from source): -\n CUDA/cuDNN version: 10.1\n GPU model and memory: GeForce GTX 1050 Ti with Max-Q 4 Gb\n \n Describe the current behavior\n The code below works in eager mode, but fails with the following error if using tf.function\n <denchmark-code>Traceback (most recent call last):\n   File \"bugreport.py\", line 55, in <module>\n     value = func(x)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 780, in __call__\n     result = self._call(*args, **kwds)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 823, in _call\n     self._initialize(args, kwds, add_initializers_to=initializers)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 697, in _initialize\n     *args, **kwds))\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 2870, in _get_concrete_function_internal_garbage_collected\n     graph_function, _, _ = self._maybe_define_function(args, kwargs)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 3227, in _maybe_define_function\n     graph_function = self._create_graph_function(args, kwargs)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 3089, in _create_graph_function\n     capture_by_value=self._capture_by_value),\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/framework/func_graph.py\", line 986, in func_graph_from_py_func\n     func_outputs = python_func(*func_args, **func_kwargs)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 600, in wrapped_fn\n     return weak_wrapped_fn().__wrapped__(*args, **kwds)\n   File \"bugreport.py\", line 48, in func\n     grads = tape.gradient(loss, variables)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/backprop.py\", line 1073, in gradient\n     unconnected_gradients=unconnected_gradients)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/imperative_grad.py\", line 77, in imperative_grad\n     compat.as_str(unconnected_gradients.value))\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/backprop.py\", line 162, in _gradient_function\n     return grad_fn(mock_op, *out_grads)\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/ops/nn_grad.py\", line 50, in _Conv2DBackpropInputGrad\n     strides=op.get_attr(\"strides\"),\n   File \"/home/abdo/tmp/venv/lib/python3.6/site-packages/tensorflow/python/eager/backprop.py\", line 121, in get_attr\n     raise KeyError(attr)\n KeyError: 'strides'\n </denchmark-code>\n \n Describe the expected behavior\n I would expect this code to work the same under eager mode or wrapped with tf.function.\n Standalone code to reproduce the issue\n import tensorflow as tf\n \n shape = (2, 3, 3, 5, 7)\n init = tf.random.normal(shape=shape, dtype=tf.float32)\n weights = tf.Variable(initial_value=init, trainable=True, shape=shape, dtype=tf.float32)\n \n def conv(x):\n     kernel = tf.reshape(tf.eye(3 * 3, dtype=x.dtype), shape=(3, 3, 1, 3 * 3))\n \n     x = tf.reshape(x, shape=(2 * 5, 1, 4, 4))\n     x = tf.nn.conv2d(x, kernel, strides=(1,1), padding='SAME', data_format='NCHW')\n     x = tf.reshape(x, shape=(2, 5 * 3 * 3, 4 * 4))\n \n     W = tf.reshape(weights, shape=(2, 3 * 3, 5, 7))\n     W = tf.transpose(W, perm=[0, 2, 1, 3])\n     W = tf.reshape(W, shape=(2, 5 * 3 * 3, 7))\n     \n     y = tf.linalg.matmul(W, x, transpose_a=True)\n     y = tf.reshape(y, shape=(2, 7, 4, 4))\n     y = tf.square(y)\n \n     return y\n \n def func_flat(x_flat):\n     x_unflat = tf.reshape(x_flat, shape=(2, 5, 4, 4))\n \n     with tf.GradientTape() as tape:\n         tape.watch(x_unflat)\n         y = conv(x_unflat)\n         u = tf.reduce_sum(y, axis=[-3, -2, -1])\n         u = tf.reshape(u, shape=(2, 1))\n \n     jac = tape.batch_jacobian(u, x_unflat)\n     return jac\n \n variables = [weights]\n \n @tf.function(autograph=False)\n def func(x):\n     with tf.GradientTape() as tape:\n         tape.watch(weights)\n \n         y_flat = func_flat(x)\n         loss = tf.reduce_sum(tf.square(y_flat))\n \n     grads = tape.gradient(loss, variables)\n \n     return tf.reduce_sum(grads)\n \n \n x = tf.random.normal(shape=(2, 5 * 4 * 4), dtype=tf.float32)\n \n value = func(x)\n print(value)\n Other info / logs Include any logs or source code that would be helpful to\n diagnose the problem. If including tracebacks, please include the full\n traceback. Large logs and files should be attached.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "aroig", "commentT": "2020-06-29T17:09:17Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Saduf2019>@Saduf2019</denchmark-link>\n   yes, I forgot to mention it in the report, there is some amount of non-determinism. sometimes it reports KeyError on strides, sometimes on the explicit_paddings, but the cause of the error seems to be the same I reported.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "aroig", "commentT": "2020-06-29T17:48:23Z", "comment_text": "\n \t\tAlso, let me clarify that this requires a notebook with GPU. If we remove the @tf.function(autograph=False) line, it works as expected on gpu, but would complain about an unrelated thing on cpu: no Conv2D kernel in the NCHW order.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "aroig", "commentT": "2020-06-30T15:47:46Z", "comment_text": "\n \t\tI ran the code on different versions of tf and the error is different as reported, please find the gist here <denchmark-link:https://colab.research.google.com/gist/Saduf2019/3ba4a2f8f9f8f220fcee89398adfc6cf/untitled246.ipynb>for nightly</denchmark-link>\n , <denchmark-link:https://colab.research.google.com/gist/Saduf2019/135221a048088eedc9ab3d638e2f934e/untitled246.ipynb>1.12</denchmark-link>\n ,\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "aroig", "commentT": "2020-06-30T16:05:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Saduf2019>@Saduf2019</denchmark-link>\n  As I mentioned before, the error on the nightly gist above is almost the same. If you repeat the execution several times it changed back and forth between KeyError on strides, explicit_paddings or dilations.\n The stack trace is identical. See an other execution on this <denchmark-link:https://colab.research.google.com/drive/1v9ge0nrS8hpe5EChn251TNUeOXRcEKvw#scrollTo=SRWRfyFm8Zy9>gist</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "aroig", "commentT": "2020-10-31T00:18:39Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/40895>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/40895>No</denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "aroig", "commentT": "2020-11-23T23:53:01Z", "comment_text": "\n \t\tHi,\n Any update on this?\n <denchmark-link:https://github.com/aroig>@aroig</denchmark-link>\n  did you find a solution?\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "aroig", "commentT": "2020-12-01T22:07:08Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tensorflow/tensorflow/issues/45063>#45063</denchmark-link>\n  might be a duplicate, <denchmark-link:https://github.com/Saduf2019>@Saduf2019</denchmark-link>\n  <denchmark-link:https://github.com/gowthamkpr>@gowthamkpr</denchmark-link>\n  you could consider that reproduction too.\n \t\t"}}}, "commit": {"commit_id": "3d1f1b062dafc5cea4561d0a48538c60aef5aa5e", "commit_author": "Allen Lavoie", "commitT": "2020-10-30 17:17:09-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.8846153846153846"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\eager\\backprop_test.py", "file_new_name": "tensorflow\\python\\eager\\backprop_test.py", "file_complexity": {"file_NLOC": "1564", "file_CCN": "267", "file_NToken": "14675"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1790,1791,1792,1793,1794,1795", "deleted_lines": null, "method_info": {"method_name": "test_grad_jacobian_conv._outer", "method_params": "", "method_startline": "1790", "method_endline": "1795", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "50", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1776,1777,1778,1779,1780,1781,1782,1783", "deleted_lines": null, "method_info": {"method_name": "test_grad_jacobian_conv._inner", "method_params": "x", "method_startline": "1776", "method_endline": "1783", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "95", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798", "deleted_lines": null, "method_info": {"method_name": "test_grad_jacobian_conv", "method_params": "self", "method_startline": "1775", "method_endline": "1798", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "95", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\ops\\parallel_for\\pfor.py", "file_new_name": "tensorflow\\python\\ops\\parallel_for\\pfor.py", "file_complexity": {"file_NLOC": "3179", "file_CCN": "598", "file_NToken": "23891"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1004,1005,1006,1007,1008", "deleted_lines": "1004", "method_info": {"method_name": "_create_op", "method_params": "op_type,inputs,op_dtypes,attrs", "method_startline": "1000", "method_endline": "1010", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "94", "method_nesting_level": "0"}}}}}}}}