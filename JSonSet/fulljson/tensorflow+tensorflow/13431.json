{"BR": {"BR_id": "13431", "BR_author": "Utumno", "BRopenT": "2017-10-01T13:44:27Z", "BRcloseT": "2017-10-04T00:03:08Z", "BR_text": {"BRsummary": "Windows nightly build Dataset.from_generator fails with pyfunc error", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): windows-7\n TensorFlow installed from (source or binary):pip\n TensorFlow version:1.4.0-dev20170929\n Python version: 3.5.2\n Bazel version (if compiling from source):-\n CUDA/cuDNN version:-\n GPU model and memory:-\n Exact command to reproduce:see below\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n As described in the SO question <denchmark-link:https://stackoverflow.com/q/46511328/281545>https://stackoverflow.com/q/46511328/281545</denchmark-link>\n  the code:\n import tensorflow as tf\n \n Dataset = tf.contrib.data.Dataset\n it2 = Dataset.range(5).make_one_shot_iterator()\n \n # Dataset.from_generator need tensorflow > 1.3 !\n with tf.Session() as sess:\n     print(tf.__version__)\n     def _dataset_generator():\n         while True:\n             try:\n                 yield sess.run(it2.get_next())\n             except tf.errors.OutOfRangeError:\n                 return\n     das_dataset = Dataset.from_generator(_dataset_generator, tf.int64)\n     das_dataset_it = das_dataset.make_one_shot_iterator()\n     while True:\n         try:\n             print(sess.run(das_dataset_it.get_next()))\n         except tf.errors.OutOfRangeError:\n             break\n fails with:\n <denchmark-code>C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\Scripts\\python.exe C:/Dropbox/eclipse_workspaces/python/zebra/so_46511328_from_generator.py\n 1.4.0-dev20170929\n 2017-10-01 16:41:41.978576: W C:\\tf_jenkins\\home\\workspace\\tf-nightly-windows\\M\\windows\\PY\\35\\tensorflow\\core\\framework\\op_kernel.cc:1192] Invalid argument: 0-th value returned by pyfunc_0 is int32, but expects int64\n \t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_INT64], token=\"pyfunc_0\"]()]]\n Traceback (most recent call last):\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1323, in _do_call\n     return fn(*args)\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1302, in _run_fn\n     status, run_metadata)\n   File \"C:\\_\\Python35\\lib\\contextlib.py\", line 66, in __exit__\n     next(self.gen)\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\framework\\errors_impl.py\", line 467, in raise_exception_on_not_ok_status\n     c_api.TF_GetCode(status.status))\n tensorflow.python.framework.errors_impl.InvalidArgumentError: 0-th value returned by pyfunc_0 is int32, but expects int64\n \t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_INT64], token=\"pyfunc_0\"]()]]\n \t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[<unknown>], output_types=[DT_INT64], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator_1)]]\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"C:/Dropbox/eclipse_workspaces/python/zebra/so_46511328_from_generator.py\", line 19, in <module>\n     print(sess.run(das_dataset_it.get_next()))\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 889, in run\n     run_metadata_ptr)\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1120, in _run\n     feed_dict_tensor, options, run_metadata)\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1317, in _do_run\n     options, run_metadata)\n   File \"C:\\Dropbox\\_\\PyCharmVirtual\\TF-Nigthly-2\\lib\\site-packages\\tensorflow\\python\\client\\session.py\", line 1336, in _do_call\n     raise type(e)(node_def, op, message)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: 0-th value returned by pyfunc_0 is int32, but expects int64\n \t [[Node: PyFunc = PyFunc[Tin=[], Tout=[DT_INT64], token=\"pyfunc_0\"]()]]\n \t [[Node: IteratorGetNext = IteratorGetNext[output_shapes=[<unknown>], output_types=[DT_INT64], _device=\"/job:localhost/replica:0/task:0/cpu:0\"](OneShotIterator_1)]]\n \n Process finished with exit code 1\n </denchmark-code>\n \n That's a problem in windows nightly - installing the nightly on an Ubuntu machine works:\n <denchmark-code>$ pipenv run python3 so_46511328_from_generator.py\n 2017-10-01 13:34:21.840423: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA\n 1.4.0-dev20170929\n 0\n 1\n 2\n 3\n 4\n 2017-10-01 13:34:21.903201: W tensorflow/core/framework/op_kernel.cc:1192] Out of range: StopIteration: Iteration finished.\n </denchmark-code>\n \n  Maybe related to <denchmark-link:https://github.com/tensorflow/tensorflow/issues/8196>#8196</denchmark-link>\n  ?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Utumno", "commentT": "2017-10-02T19:55:56Z", "comment_text": "\n \t\tYes, I think is a result of  returning a different array type (when  is a Python ) on Windows and Linux. If I remember correctly, on Windows the array will have type  and on Linux the array will have type . This behavior in  is inherited from , which performs the NumPy conversion automatically (as discussed in <denchmark-link:https://github.com/tensorflow/tensorflow/issues/8196>#8196</denchmark-link>\n ). To write platform independent code that handles this case, you should explicitly wrap the return value in a NumPy array.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Utumno", "commentT": "2017-10-02T20:15:54Z", "comment_text": "\n \t\tOn second thoughts... I think this is really easy to fix. I'm working on a patch.\n \t\t"}}}, "commit": {"commit_id": "9b027db459ff771c246a266ac3ec40cfbb4a63ce", "commit_author": "Derek Murray", "commitT": "2017-10-02 16:30:57-07:00", "commit_complexity": {"commit_NLOC": "0.18181818181818182", "commit_CCN": "0.9545454545454546", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\contrib\\data\\python\\kernel_tests\\dataset_constructor_op_test.py", "file_new_name": "tensorflow\\contrib\\data\\python\\kernel_tests\\dataset_constructor_op_test.py", "file_complexity": {"file_NLOC": "431", "file_CCN": "66", "file_NToken": "4696"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "438,439,440,441", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorImplicitConversion.generator", "method_params": "", "method_startline": "438", "method_endline": "441", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "478", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorTypeError", "method_params": "self", "method_startline": "461", "method_endline": "482", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "150", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459", "deleted_lines": "454", "method_info": {"method_name": "testFromGeneratorImplicitConversion", "method_params": "self", "method_startline": "437", "method_endline": "459", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "148", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\contrib\\data\\python\\ops\\dataset_ops.py", "file_new_name": "tensorflow\\contrib\\data\\python\\ops\\dataset_ops.py", "file_complexity": {"file_NLOC": "170", "file_CCN": "46", "file_NToken": "1279"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "194,195,196", "deleted_lines": "194,195", "method_info": {"method_name": "from_generator", "method_params": "generator,output_types,output_shapes", "method_startline": "100", "method_endline": "254", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "118", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "194,195,196", "deleted_lines": "194,195", "method_info": {"method_name": "from_generator.generator_map_fn", "method_params": "iterator_id_t", "method_startline": "167", "method_endline": "226", "method_complexity": {"method_NLOC": "8", "method_CCN": "3", "method_NToken": "59", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "194,195,196", "deleted_lines": "194,195", "method_info": {"method_name": "from_generator.from_generator.generator_map_fn.generator_py_func", "method_params": "iterator_id", "method_startline": "181", "method_endline": "215", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "139", "method_nesting_level": "3"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_new_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_complexity": {"file_NLOC": "769", "file_CCN": "195", "file_NToken": "5545"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "309,310,311", "deleted_lines": "309,310", "method_info": {"method_name": "from_generator.from_generator.generator_map_fn.generator_py_func", "method_params": "iterator_id", "method_startline": "296", "method_endline": "330", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "139", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "309,310,311", "deleted_lines": "309,310", "method_info": {"method_name": "from_generator", "method_params": "generator,output_types,output_shapes", "method_startline": "215", "method_endline": "369", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "116", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "309,310,311", "deleted_lines": "309,310", "method_info": {"method_name": "from_generator.generator_map_fn", "method_params": "iterator_id_t", "method_startline": "282", "method_endline": "341", "method_complexity": {"method_NLOC": "8", "method_CCN": "3", "method_NToken": "59", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\kernel_tests\\dataset_constructor_op_test.py", "file_new_name": "tensorflow\\python\\kernel_tests\\dataset_constructor_op_test.py", "file_complexity": {"file_NLOC": "402", "file_CCN": "60", "file_NToken": "4332"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "437,438,439,440", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorImplicitConversion.generator", "method_params": "", "method_startline": "437", "method_endline": "440", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "477", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorTypeError", "method_params": "self", "method_startline": "460", "method_endline": "481", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "150", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458", "deleted_lines": "453", "method_info": {"method_name": "testFromGeneratorImplicitConversion", "method_params": "self", "method_startline": "436", "method_endline": "458", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "148", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\ops\\script_ops.py", "file_new_name": "tensorflow\\python\\ops\\script_ops.py", "file_complexity": {"file_NLOC": "91", "file_CCN": "24", "file_NToken": "601"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "60,72,77", "deleted_lines": "60,76", "method_info": {"method_name": "_convert", "method_params": "value,dtype", "method_startline": "60", "method_endline": "86", "method_complexity": {"method_NLOC": "11", "method_CCN": "6", "method_NToken": "124", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "60,72,77", "deleted_lines": "60,76", "method_info": {"method_name": "_convert", "method_params": "value", "method_startline": "60", "method_endline": "85", "method_complexity": {"method_NLOC": "11", "method_CCN": "6", "method_NToken": "116", "method_nesting_level": "1"}}}}}}}}