{"BR": {"BR_id": "45054", "BR_author": "edend10", "BRopenT": "2020-11-21T02:00:20Z", "BRcloseT": "2021-01-07T20:18:36Z", "BR_text": {"BRsummary": "Concatenating sparse keras input layers results in None shape, preventing use in Dense layer", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Colab\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: No\n TensorFlow installed from (source or binary): Colab\n TensorFlow version (use command below): 2.3\n Python version: 3.6.9\n Bazel version (if compiling from source): None\n GCC/Compiler version (if compiling from source): None\n CUDA/cuDNN version: None\n GPU model and memory: None\n \n Describe the current behavior\n Using the Keras functional API, when concatenating together multiple instances of tensorflow.keras.layers.Input with sparse=True, the resulting SparseTensor has a None shape (even when batch_size is specified). Feeding the merged layer with shape None into a dense layer results in an error:\n <denchmark-code>ValueError: The last dimension of the inputs to `Dense` should be defined. Found `None`.\n </denchmark-code>\n \n Describe the expected behavior\n Concatenating non-sparse instances of tensorflow.keras.layers.Input (i.e. sparse=False) results in a tensor which has a defined shape (if batch_size is specified) and can be fed into a dense layer successfully. Additionally a single sparse input layer has a shape and can be fed into a dense layer. I would expect concatenated sparse input layers to act similarly.\n The dense shape of the merged sparse tensor should already be known as we set the shapes of the individual input layers.\n Standalone code to reproduce the issue\n <denchmark-code>sp_a = tf.keras.layers.Input(shape=(1,), batch_size=2, sparse=True)\n sp_b = tf.keras.layers.Input(shape=(2,), batch_size=2, sparse=True)\n \n sp_merged = tf.keras.layers.concatenate(inputs=[sp_a, sp_b], axis=1)\n \n print(sp_merged.shape) # prints \"(None, None)\"\n \n sp_result = tf.keras.layers.Dense(4, activation='relu', name='dense1')(sp_merged) # fails with above ValueError\n </denchmark-code>\n \n Also tried concatenating with tf.keras.layers.Concatenate and tf.sparse.concat instead. Same result.\n Reproduced success (non-sparse input) and failure (sparse input) cases in Colab:\n <denchmark-link:https://colab.research.google.com/drive/1g9a9lzpw28NqIPI1Z3-fYLJke1fa10Af?usp=sharing>https://colab.research.google.com/drive/1g9a9lzpw28NqIPI1Z3-fYLJke1fa10Af?usp=sharing</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "edend10", "commentT": "2020-11-23T07:41:48Z", "comment_text": "\n \t\tI have tried in colab with TF version 2.3, nightly version() and was able to reproduce the issue.Please, find the gist <denchmark-link:https://colab.research.google.com/gist/ravikyram/d735c0ed788454efba238a30af594edb/untitled532.ipynb>here.</denchmark-link>\n  Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "edend10", "commentT": "2020-12-03T18:27:24Z", "comment_text": "\n \t\tThanks for the report; looks like a bug.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "edend10", "commentT": "2021-01-07T20:18:37Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/45054>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/45054>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "8438d59abbd7a2c3d1c48bfd91b118aae53bbb14", "commit_author": "Scott Zhu", "commitT": "2021-01-07 12:17:29-08:00", "commit_complexity": {"commit_NLOC": "0.5294117647058824", "commit_CCN": "0.5294117647058824", "commit_Nprams": "0.5294117647058824"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\keras\\layers\\BUILD", "file_new_name": "tensorflow\\python\\keras\\layers\\BUILD", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "687", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\layers\\merge_test.py", "file_new_name": "tensorflow\\python\\keras\\layers\\merge_test.py", "file_complexity": {"file_NLOC": "324", "file_CCN": "20", "file_NToken": "4112"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "376,377,378,379,380,381,382,383,384,385,386,387,388", "deleted_lines": null, "method_info": {"method_name": "test_merge_concatenate_sparse_shape", "method_params": "self", "method_startline": "376", "method_endline": "388", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "169", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\ops\\sparse_ops.py", "file_new_name": "tensorflow\\python\\ops\\sparse_ops.py", "file_complexity": {"file_NLOC": "1010", "file_CCN": "141", "file_NToken": "7262"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447", "deleted_lines": "422,423,424,425,426,427,428", "method_info": {"method_name": "sparse_concat_v2", "method_params": "axis,sp_inputs,expand_nonconcat_dims,name", "method_startline": "397", "method_endline": "447", "method_complexity": {"method_NLOC": "43", "method_CCN": "19", "method_NToken": "360", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\ops\\sparse_ops_test.py", "file_new_name": "tensorflow\\python\\ops\\sparse_ops_test.py", "file_complexity": {"file_NLOC": "223", "file_CCN": "28", "file_NToken": "2316"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "290,291,292,293,294,295,296,297", "deleted_lines": null, "method_info": {"method_name": "testSparseConcatStaticShape", "method_params": "self", "method_startline": "290", "method_endline": "297", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "86", "method_nesting_level": "1"}}}}}}}}