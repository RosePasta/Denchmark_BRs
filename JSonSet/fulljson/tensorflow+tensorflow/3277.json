{"BR": {"BR_id": "3277", "BR_author": "rueberger", "BRopenT": "2016-07-11T22:00:32Z", "BRcloseT": "2016-07-13T21:04:06Z", "BR_text": {"BRsummary": "Broadcast 0-rank tensors when computing gradients for tf.nn.relu", "BRdescription": "\n <denchmark-h:h3>Environment info</denchmark-h>\n \n Operating System: OSX (macOS....?), CPU only, version 0.9.0\n Perhaps this is desired behavior, but I would have much appreciated a more descriptive warning at least, which would have saved much debugging.\n I haven't found a small reproducible case for this: but in the code I originally found this bug, no error is raised as the other variables are trained, leaving me scratching my head as to why the linear rectified variable was not being trained.\n The same issue also occurs for tf.nn.softplus, and perhaps other methods as well.\n <denchmark-h:h3>Steps to reproduce</denchmark-h>\n \n <denchmark-code>import tensorflow as tf\n sess = tf.Session()\n \n x = tf.Variable(100.)\n y = tf.nn.relu(x)\n loss = y ** 2\n optimizer = tf.train.AdamOptimizer(learning_rate=0.1)\n train_op = optimizer.minimize(loss)\n sess.run(tf.initialize_all_variables())\n \n sess.run(train_op)\n \n ---------------------------------------------------------------------------\n InvalidArgumentError                      Traceback (most recent call last)\n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n     729     try:\n --> 730       return fn(*args)\n     731     except errors.OpError as e:\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in _run_fn(session, feed_dict, fetch_list, target_list, options, run_metadata)\n     711                                  feed_dict, fetch_list, target_list,\n --> 712                                  status, run_metadata)\n     713 \n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/contextlib.py in __exit__(self, type, value, traceback)\n      65             try:\n ---> 66                 next(self.gen)\n      67             except StopIteration:\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/errors.py in raise_exception_on_not_ok_status()\n     449           compat.as_text(pywrap_tensorflow.TF_Message(status)),\n --> 450           pywrap_tensorflow.TF_GetCode(status))\n     451   finally:\n \n InvalidArgumentError: We only handle up to Tensor::dims() up to 8, not 0\n      [[Node: gradients_29/Relu_5_grad/ReluGrad = ReluGrad[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients_29/pow_9_grad/tuple/control_dependency, Relu_5)]]\n \n During handling of the above exception, another exception occurred:\n \n InvalidArgumentError                      Traceback (most recent call last)\n <ipython-input-51-ea082b2869a4> in <module>()\n ----> 1 sess.run(train_op)\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in run(self, fetches, feed_dict, options, run_metadata)\n     380     try:\n     381       result = self._run(None, fetches, feed_dict, options_ptr,\n --> 382                          run_metadata_ptr)\n     383       if run_metadata:\n     384         proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in _run(self, handle, fetches, feed_dict, options, run_metadata)\n     653     movers = self._update_with_movers(feed_dict_string, feed_map)\n     654     results = self._do_run(handle, target_list, unique_fetches,\n --> 655                            feed_dict_string, options, run_metadata)\n     656 \n     657     # User may have fetched the same tensor multiple times, but we\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in _do_run(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)\n     721     if handle is None:\n     722       return self._do_call(_run_fn, self._session, feed_dict, fetch_list,\n --> 723                            target_list, options, run_metadata)\n     724     else:\n     725       return self._do_call(_prun_fn, self._session, handle, feed_dict,\n \n /Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/client/session.py in _do_call(self, fn, *args)\n     741         except KeyError:\n     742           pass\n --> 743       raise type(e)(node_def, op, message)\n     744 \n     745   def _extend_graph(self):\n \n InvalidArgumentError: We only handle up to Tensor::dims() up to 8, not 0\n      [[Node: gradients_29/Relu_5_grad/ReluGrad = ReluGrad[T=DT_FLOAT, _device=\"/job:localhost/replica:0/task:0/cpu:0\"](gradients_29/pow_9_grad/tuple/control_dependency, Relu_5)]]\n Caused by op 'gradients_29/Relu_5_grad/ReluGrad', defined at:\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/runpy.py\", line 170, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/__main__.py\", line 3, in <module>\n     app.launch_new_instance()\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/traitlets/config/application.py\", line 596, in launch_instance\n     app.start()\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/kernelapp.py\", line 442, in start\n     ioloop.IOLoop.instance().start()\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/zmq/eventloop/ioloop.py\", line 162, in start\n     super(ZMQIOLoop, self).start()\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tornado/ioloop.py\", line 883, in start\n     handler_func(fd_obj, events)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n     return fn(*args, **kwargs)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/zmq/eventloop/zmqstream.py\", line 440, in _handle_events\n     self._handle_recv()\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/zmq/eventloop/zmqstream.py\", line 472, in _handle_recv\n     self._run_callback(callback, msg)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/zmq/eventloop/zmqstream.py\", line 414, in _run_callback\n     callback(*args, **kwargs)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tornado/stack_context.py\", line 275, in null_wrapper\n     return fn(*args, **kwargs)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/kernelbase.py\", line 276, in dispatcher\n     return self.dispatch_shell(stream, msg)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/kernelbase.py\", line 228, in dispatch_shell\n     handler(stream, idents, msg)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/kernelbase.py\", line 391, in execute_request\n     user_expressions, allow_stdin)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/ipykernel/ipkernel.py\", line 199, in do_execute\n     shell.run_cell(code, store_history=store_history, silent=silent)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/IPython/core/interactiveshell.py\", line 2723, in run_cell\n     interactivity=interactivity, compiler=compiler, result=result)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/IPython/core/interactiveshell.py\", line 2825, in run_ast_nodes\n     if self.run_code(code, result):\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\n     exec(code_obj, self.user_global_ns, self.user_ns)\n   File \"<ipython-input-49-21a2f038fac9>\", line 5, in <module>\n     train_op = optimizer.minimize(loss)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/training/optimizer.py\", line 193, in minimize\n     grad_loss=grad_loss)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/training/optimizer.py\", line 250, in compute_gradients\n     colocate_gradients_with_ops=colocate_gradients_with_ops)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/ops/gradients.py\", line 482, in gradients\n     in_grads = _AsList(grad_fn(op, *out_grads))\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/ops/nn_grad.py\", line 233, in _ReluGrad\n     return gen_nn_ops._relu_grad(grad, op.outputs[0])\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1374, in _relu_grad\n     features=features, name=name)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/op_def_library.py\", line 703, in apply_op\n     op_def=op_def)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/ops.py\", line 2297, in create_op\n     original_op=self._default_original_op, op_def=op_def)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/ops.py\", line 1231, in __init__\n     self._traceback = _extract_stack()\n \n ...which was originally created as op 'Relu_5', defined at:\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/runpy.py\", line 170, in _run_module_as_main\n     \"__main__\", mod_spec)\n [elided 17 identical lines from previous traceback]\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/IPython/core/interactiveshell.py\", line 2885, in run_code\n     exec(code_obj, self.user_global_ns, self.user_ns)\n   File \"<ipython-input-49-21a2f038fac9>\", line 2, in <module>\n     y = tf.nn.relu(x)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/ops/gen_nn_ops.py\", line 1312, in relu\n     result = _op_def_lib.apply_op(\"Relu\", features=features, name=name)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/op_def_library.py\", line 703, in apply_op\n     op_def=op_def)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/ops.py\", line 2297, in create_op\n     original_op=self._default_original_op, op_def=op_def)\n   File \"/Users/andrew/anaconda/envs/tf_dev/lib/python3.4/site-packages/tensorflow/python/framework/ops.py\", line 1231, in __init__\n     self._traceback = _extract_stack()\n </denchmark-code>\n \n <denchmark-h:h3>What have you tried?</denchmark-h>\n \n The problem is resolved by expanding the dimensions of x:\n <denchmark-code>import tensorflow as tf\n sess = tf.Session()\n \n x = tf.Variable(100.)\n y = tf.nn.relu(tf.expand_dims(x, 0))\n loss = y ** 2\n optimizer = tf.train.AdamOptimizer(learning_rate=0.1)\n train_op = optimizer.minimize(loss)\n sess.run(tf.initialize_all_variables())\n \n sess.run(train_op)\n # runs fine\n </denchmark-code>\n \n I wonder if it would be possible to do this automatically?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "rueberger", "commentT": "2016-07-12T00:50:51Z", "comment_text": "\n \t\tSo I checked this out, does seem to be a bug. The good news is it looks like it might be really easy to fix.\n <denchmark-link:https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/framework/numeric_op.h#L90>https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/framework/numeric_op.h#L90</denchmark-link>\n \n Just add NDIM_CASE(0); on line 90 and the template magic should take care of the rest.\n I'll work on getting this submitted.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "rueberger", "commentT": "2016-07-13T15:49:32Z", "comment_text": "\n \t\tLooks like the fix got pushed. Could you check whether this solves the issue with your more complicated example?\n Thank you for the awesome bug report!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "rueberger", "commentT": "2016-07-14T14:29:16Z", "comment_text": "\n \t\tYup! All is well. Thanks for quickly dispatching this one!\n \t\t"}}}, "commit": {"commit_id": "5d5db35ed2e9e90b95ab27f8b37898fd4543457f", "commit_author": "A. Unique TensorFlower", "commitT": "2016-07-12 16:17:59-07:00", "commit_complexity": {"commit_NLOC": "0.9090909090909091", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\core\\framework\\numeric_op.h", "file_new_name": "tensorflow\\core\\framework\\numeric_op.h", "file_complexity": {"file_NLOC": "65", "file_CCN": "5", "file_NToken": "411"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "91", "deleted_lines": null, "method_info": {"method_name": "tensorflow::BinaryElementWiseOp::Compute", "method_params": "context", "method_startline": "72", "method_endline": "107", "method_complexity": {"method_NLOC": "24", "method_CCN": "2", "method_NToken": "149", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\kernel_tests\\relu_op_test.py", "file_new_name": "tensorflow\\python\\kernel_tests\\relu_op_test.py", "file_complexity": {"file_NLOC": "219", "file_CCN": "26", "file_NToken": "2779"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "127,128,129,130,131,132,133,134,135,136", "deleted_lines": null, "method_info": {"method_name": "testGradientScalar", "method_params": "self", "method_startline": "127", "method_endline": "136", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "90", "method_nesting_level": "1"}}}}}}}}