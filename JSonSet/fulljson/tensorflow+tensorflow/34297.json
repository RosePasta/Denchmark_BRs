{"BR": {"BR_id": "34297", "BR_author": "MikeOfZen", "BRopenT": "2019-11-15T01:59:48Z", "BRcloseT": "2019-11-21T23:39:00Z", "BR_text": {"BRsummary": "tf.function hangs on ragged tensor input", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04):No\n TensorFlow installed from (source or binary):Colab\n TensorFlow version (use command below):2.0.0\n Python version:3.6\n GPU model and memory:None\n \n Describe the current behavior\n When using tf.function with a number of for loops on a RaggedTensor, the function call hangs (I stopped waiting after half hour).\n -when running the function directly (no tf.function decorator), the function executes immediately\n -when converting the ragged tensor to dense tensor, the function executes immediately.\n I couldn't pinpoint the exact combination of operations that causes this Autograph behavior, but I tried to reduce my code to the simplest combination that still causes this behavior.\n I struggled for hours with my own code, trying to get tf.function to work, until I figured it was due to the ragged tensor + for loops + tf.function hanging the kernel\n I observed similar behavior on my machine and a colab machine as well.\n Describe the expected behavior\n Should execute in a comparable time to a dense tensor.\n Code to reproduce the issue\n <denchmark-code>%tensorflow_version 2.x\n import tensorflow as tf\n import numpy as np\n \n inp=tf.ragged.constant(np.arange(1000,dtype=np.float32).reshape(10,10,10))\n \n @tf.function    #if not using tf.function it runs well\n def ragged_example(r_tensor):\n   s=tf.constant(0.0)\n   for i in tf.range(10):\n     inner=r_tensor[i]\n     for x in inner:\n       b=tf.reduce_sum(x)\n       s=s+b\n   return s\n \n #inp=inp.to_tensor() #if this is uncommented, it runs well\n \n ragged_example(inp) #this hangs\n </denchmark-code>\n \n Other observations\n Also noted very large memory footprint as a result (9gb and growing)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "MikeOfZen", "commentT": "2019-11-18T11:22:31Z", "comment_text": "\n \t\tCould reproduce the issue with TF Version 2.0. Here is the <denchmark-link:https://colab.sandbox.google.com/gist/rmothukuru/3a286f4b25e62d041d0030e80a4e1cb2/34297.ipynb>Gist</denchmark-link>\n . Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "MikeOfZen", "commentT": "2019-11-18T21:05:00Z", "comment_text": "\n \t\tThis bug is a combination of several problems that we'll need to resolve, fopefully in 2.2. In the mean time, a workaround is to avoid writing for loops over ragged tensors (e.g. for x in ragged_tensor). This means rewriting your code like so:\n <denchmark-code>def ragged_example(r_tensor):\n   s = tf.constant(0.0)\n   for i in tf.range(10):\n     inner = r_tensor[i]\n     for j in tf.range(inner.row_lengths()[0]):  #  `for x in inner` doesn't work yet.\n       x = inner[j]\n       b = tf.reduce_sum(x)\n       s = s + b\n   return s\n </denchmark-code>\n \n A few more details on the cause of the bug --\n Autograph doesn't currently support iterating over , and it thinks they are normal Python objects. We'll fix that in autograph, hopefully by TF 2.2.\n Now, this should have normally generated an error (something in the lines of \"cannot directly iterate over RaggedTensor in graph mode\"). But it seems that the  class is iterable and the iterator it returns hangs when consumed in graph mode. <denchmark-link:https://github.com/edloper>@edloper</denchmark-link>\n  I think this iterator should error out in  instead?\n Edit: fixed the index in the example\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "MikeOfZen", "commentT": "2019-11-18T21:19:38Z", "comment_text": "\n \t\tThank you for the update and the details.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "MikeOfZen", "commentT": "2019-11-21T23:39:01Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/34297>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/34297>No</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "MikeOfZen", "commentT": "2019-11-22T14:11:17Z", "comment_text": "\n \t\tThe PR that just got merged should fix the issue in tf.function.\n As a side note, we should still disallow RaggedTensor.iter in graph code (or make it return a proper graph-based iterator).\n \t\t"}}}, "commit": {"commit_id": "75af7b4750cd757cd82b32896eb98414e1b38898", "commit_author": "Dan Moldovan", "commitT": "2019-11-21 15:38:00-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.9473684210526315"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\autograph\\operators\\control_flow.py", "file_new_name": "tensorflow\\python\\autograph\\operators\\control_flow.py", "file_complexity": {"file_NLOC": "666", "file_CCN": "121", "file_NToken": "3746"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "425,426,427", "deleted_lines": null, "method_info": {"method_name": "_tf_ragged_for_stmt", "method_params": "iter_,extra_test,body,get_state,set_state,init_vars,basic_symbol_names,composite_symbol_names", "method_startline": "425", "method_endline": "427", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "450,451,452,453,454", "deleted_lines": null, "method_info": {"method_name": "while_cond", "method_params": "iterate_index,loop_vars", "method_startline": "450", "method_endline": "454", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "39", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "437,438,439,440,441,442,443,444,445,446,447,448", "deleted_lines": null, "method_info": {"method_name": "while_body", "method_params": "iterate_index,loop_vars", "method_startline": "437", "method_endline": "448", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "50", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tensorflow\\python\\autograph\\operators\\control_flow_test.py", "file_new_name": "tensorflow\\python\\autograph\\operators\\control_flow_test.py", "file_complexity": {"file_NLOC": "384", "file_CCN": "54", "file_NToken": "3327"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305", "deleted_lines": null, "method_info": {"method_name": "test_tf_ragged_tensor_no_loop_vars", "method_params": "self", "method_startline": "285", "method_endline": "305", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "65", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "294,295,296,297,298,299,300,301", "deleted_lines": null, "method_info": {"method_name": "test_tf_ragged_tensor_no_loop_vars.test_fn", "method_params": "", "method_startline": "294", "method_endline": "301", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "56", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "261,262,263,264,265,266,267,268,269", "deleted_lines": null, "method_info": {"method_name": "test_tf_ragged_tensor", "method_params": "self", "method_startline": "261", "method_endline": "269", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "95", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "289,290", "deleted_lines": null, "method_info": {"method_name": "test_tf_ragged_tensor_no_loop_vars.stateless_with_side_effects", "method_params": "i", "method_startline": "289", "method_endline": "290", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "271,272,273,274,275,276,277,278,279,280,281,282,283", "deleted_lines": null, "method_info": {"method_name": "test_tf_ragged_tensor_higher_dimensional", "method_params": "self", "method_startline": "271", "method_endline": "283", "method_complexity": {"method_NLOC": "13", "method_CCN": "1", "method_NToken": "114", "method_nesting_level": "1"}}}}}}}}