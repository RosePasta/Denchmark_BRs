{"BR": {"BR_id": "33888", "BR_author": "sonu1-p", "BRopenT": "2019-10-31T16:23:59Z", "BRcloseT": "2020-01-29T00:03:54Z", "BR_text": {"BRsummary": "Bug in saving model in hdf5 format", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): MacOs Mojave version 10.14.6\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): 2.0.0\n Python version:\n Bazel version (if compiling from source): N/A\n GCC/Compiler version (if compiling from source): N/A\n CUDA/cuDNN version: N/A\n GPU model and memory: N/A\n \n Describe the current behavior\n When try to save the below model in keras format, we get the following error:\n ValueError: Unable to create group (name already exists)\n This happens as this model has three layers with name as below:\n tf_op_layer_Pad/paddings/0\n tf_op_layer_Pad/paddings\n tf_op_layer_Pad\n Such name causes error in keras as described here - <denchmark-link:https://github.com/keras-team/keras/issues/12195>keras-team/keras#12195</denchmark-link>\n \n Describe the expected behavior\n Model saving should not fail.\n Code to reproduce the issue\n <denchmark-code>import tensorflow as tf\n from tensorflow import keras\n \n x = keras.Input(shape=(None,10), dtype=\"int32\", name=\"input\")\n T = tf.shape(x)[0]\n to_pad = -T % 2\n y = tf.pad(x, [[0, to_pad], [0, 0], [0, 0]])\n model = keras.Model(inputs=[x,], outputs=[y,])\n model.save(\"model.h5\")\n </denchmark-code>\n \n \n This fix for this has been checked into keras few days ago it seems - <denchmark-link:https://github.com/keras-team/keras/commit/7dee298ebec503c6b0e1727dfd49b89a3fb002d7>keras-team/keras@7dee298</denchmark-link>\n \n But it seems TF has its own copy of this hdf5 saving, so it seems this fix will also have to be made there -\n <denchmark-link:https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/saving/hdf5_format.py#L624>https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/keras/saving/hdf5_format.py#L624</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "sonu1-p", "commentT": "2019-11-01T19:59:36Z", "comment_text": "\n \t\tSaving the model to TensorFlow format (tf) works where as hdf5 saving fails with TF nightly version '2.1.0-dev20191101'\n import tensorflow as tf\n from tensorflow import keras\n \n x = keras.Input(shape=(None,10), dtype=\"int32\", name=\"input\")\n T = tf.shape(x)[0]\n to_pad = -T % 2\n y = tf.pad(x, [[0, to_pad], [0, 0], [0, 0]])\n model = keras.Model(inputs=[x,], outputs=[y,])\n model.save(\"models.tf\")\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "sonu1-p", "commentT": "2019-11-04T09:37:45Z", "comment_text": "\n \t\tWe need to backport <denchmark-link:https://github.com/keras-team/keras/pull/13477>keras-team/keras#13477</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "sonu1-p", "commentT": "2019-11-04T09:38:43Z", "comment_text": "\n \t\tI believe this is a duplicate of <denchmark-link:https://github.com/tensorflow/tensorflow/issues/33565>#33565</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "sonu1-p", "commentT": "2020-01-22T02:57:09Z", "comment_text": "\n \t\tI have the same problem using TF 2.1.0. Calling keras from tensorflow will lead to the same error. As mentioned by <denchmark-link:https://github.com/sonu1-p>@sonu1-p</denchmark-link>\n  , TF hasn't updated its own copy of this hdf5 saving.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "sonu1-p", "commentT": "2020-01-29T00:03:55Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/33888>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/33888>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "0e884391beabe2fadb6398b1fc5f48a9662c333c", "commit_author": "A. Unique TensorFlower", "commitT": "2020-01-28 15:53:05-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\saving\\hdf5_format.py", "file_new_name": "tensorflow\\python\\keras\\saving\\hdf5_format.py", "file_complexity": {"file_NLOC": "440", "file_CCN": "97", "file_NToken": "3550"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "624,625,626", "deleted_lines": "624", "method_info": {"method_name": "save_weights_to_hdf5_group", "method_params": "f,layers", "method_startline": "610", "method_endline": "638", "method_complexity": {"method_NLOC": "18", "method_CCN": "6", "method_NToken": "188", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\saving\\hdf5_format_test.py", "file_new_name": "tensorflow\\python\\keras\\saving\\hdf5_format_test.py", "file_complexity": {"file_NLOC": "1002", "file_CCN": "87", "file_NToken": "9237"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "755,756,757,758,759,760,761,762,763,764,765,766,767,768,769", "deleted_lines": null, "method_info": {"method_name": "test_saving_group_naming_h5py", "method_params": "self", "method_startline": "755", "method_endline": "769", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "118", "method_nesting_level": "1"}}}}}}}}