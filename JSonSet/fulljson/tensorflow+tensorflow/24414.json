{"BR": {"BR_id": "24414", "BR_author": "jayfurmanek", "BRopenT": "2018-12-18T06:06:14Z", "BRcloseT": "2019-04-01T21:41:13Z", "BR_text": {"BRsummary": "ppc64le: no_mkl_dnn_contraction_kernel define causes build failure", "BRdescription": "\n Please make sure that this is a build/installation issue. As per our GitHub Policy, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:build_template\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04 ppc64le\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\n TensorFlow installed from (source or binary): source\n TensorFlow version: master\n Python version: 3.6\n Installed using virtualenv? pip? conda?:  source\n Bazel version (if compiling from source): 0.19.2\n GCC/Compiler version (if compiling from source):  4.8\n CUDA/cuDNN version:  10.0/7.3\n GPU model and memory: V100\n \n \n A recent commit (<denchmark-link:https://github.com/tensorflow/tensorflow/commit/10ef7edc881ee715eaae48656fcb431fe128441f>10ef7ed</denchmark-link>\n ) changed the default contraction kernel to be MKL based. Code was added for non-intel platforms to avoid MKL, but it has an error.\n Provide the exact sequence of commands / steps that you executed before running into the problem\n Basic build: bazel build //tensorflow/tools/pip_package:build_pip_package\n Any other info / logs\n Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\n <denchmark-code>ERROR: /home/jenkins/workspace/TensorFlow_PPC64LE_GPU_Build/tensorflow/core/kernels/BUILD:610:12: Illegal ambiguous match on configurable attribute \"deps\" in //tensorflow/core/kernels:eigen_contraction_kernel:\n //tensorflow:linux_ppc64le\n //tensorflow/core/kernels:no_mkldnn_contraction_kernel\n Multiple matches are not allowed unless one is unambiguously more specialized.\n ERROR: Analysis of target '//tensorflow/tools/pip_package:build_pip_package' failed; build aborted: \n \n /home/jenkins/workspace/TensorFlow_PPC64LE_GPU_Build/tensorflow/core/kernels/BUILD:610:12: Illegal ambiguous match on configurable attribute \"deps\" in //tensorflow/core/kernels:eigen_contraction_kernel:\n //tensorflow:linux_ppc64le\n //tensorflow/core/kernels:no_mkldnn_contraction_kernel\n Multiple matches are not allowed unless one is unambiguously more specialized.\n </denchmark-code>\n \n There ends up being multiple matches in the select call:\n <denchmark-code>defines = select({\n         \"//tensorflow:android\": [],\n         \"//tensorflow:arm\": [],\n         \"//tensorflow:ios\": [],\n         \"//tensorflow:linux_ppc64le\": [],\n         \":no_mkldnn_contraction_kernel\": [],\n         \"//conditions:default\": [\n             \"TENSORFLOW_USE_CUSTOM_CONTRACTION_KERNEL\",\n             \"TENSORFLOW_USE_MKLDNN_CONTRACTION_KERNEL\",\n         ],\n     }),\n </denchmark-code>\n \n Either the arch-specific entries in the select call should be removed, or the no_mkldnn_contraction_kernel entry should be removed for this to work.\n I'll follow up with a proposed patch set.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jayfurmanek", "commentT": "2018-12-18T22:33:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ezhulenev>@ezhulenev</denchmark-link>\n  is already working on it. See <denchmark-link:https://github.com/tensorflow/tensorflow/pull/24416>#24416</denchmark-link>\n .\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jayfurmanek", "commentT": "2019-01-04T19:18:35Z", "comment_text": "\n \t\taddressed with <denchmark-link:https://github.com/tensorflow/tensorflow/commit/7c9323bedc48c98be3c07b72ec1d6f4dccdefb35>7c9323b</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jayfurmanek", "commentT": "2019-03-28T16:08:16Z", "comment_text": "\n \t\tThe fix for this issue was reverted with:\n [Temporarily disable MKL-DNN contraction kernels by default] <denchmark-link:https://github.com/tensorflow/tensorflow/commit/ca8791fc6db991c6c7406f3274ca742d867e0c6b>ca8791f</denchmark-link>\n \n Temporarily, but its been almost a month.\n I had suggested a fix that made sense to me: <denchmark-link:https://github.com/tensorflow/tensorflow/pull/24416>#24416</denchmark-link>\n \n But it wasn't accepted.\n <denchmark-link:https://github.com/penpornk>@penpornk</denchmark-link>\n  What is the plan for this setting in the .bazelrc ?  If the idea is to switch it on and off regularly, please know that it breaks all non Intel builds.\n Please advise.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jayfurmanek", "commentT": "2019-03-28T16:19:32Z", "comment_text": "\n \t\tThe problem is  is only ever defined if on x86_64. So setting it at all (on or off) is a problem for other arches. My attempted fix in <denchmark-link:https://github.com/tensorflow/tensorflow/pull/24416>#24416</denchmark-link>\n  was to let that be defined for other arches too, so that disabling it will have an effect.\n If I could get clarity on what was unacceptable in <denchmark-link:https://github.com/tensorflow/tensorflow/pull/24416>#24416</denchmark-link>\n  perhaps I could change it so this setting would work for everyone. Any feedback?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jayfurmanek", "commentT": "2019-03-28T19:01:32Z", "comment_text": "\n \t\tI'm so sorry for the inconvenience! I forgot that disabling the feature would reintroduce this issue.\n \n @penpornk What is the plan for this setting in the .bazelrc ? If the idea is to switch it on and off regularly, please know that it breaks all non Intel builds.\n \n We planned to leave it on indefinitely. I switched it off to debug an issue.\n \n If I could get clarity on what was unacceptable in #24416 perhaps I could change it so this setting would work for everyone. Any feedback?\n \n I apologize that we didn't explain properly. Back then, we were about to turn the feature on (i.e., not matching with no_mkldnn_contraction_kernel). The following targets don't support the feature so we had to keep them to prevent matching with //conditions:default\n <denchmark-code>        \"//tensorflow:android\": [],\n         \"//tensorflow:arm\": [],\n         \"//tensorflow:ios\": [],\n         \"//tensorflow:linux_ppc64le\": [],\n </denchmark-code>\n \n I'll delete these targets for now and add them back when I re-enable the feature.\n If you'd like to contribute to a permanent fix, the conditions are\n \n Never match with //conditions:default for //tensorflow:android, //tensorflow:arm, //tensorflow:ios, and //tensorflow:linux_ppc64le, regardless of the no_mkldnn_contraction_kernel target.\n If none of the above four target matches, match with no_mkldnn_contraction_kernel iff --define=tensorflow_mkldnn_contraction_kernel=0 is set.\n \n Thank you again for raising this issue!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jayfurmanek", "commentT": "2019-04-01T10:23:09Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jayfurmanek>@jayfurmanek</denchmark-link>\n  Please let me know whether <denchmark-link:https://github.com/tensorflow/tensorflow/commit/1a26797203e62390623756fd67e69e7665b69389>1a26797</denchmark-link>\n  has solved the problem. Thank you!\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jayfurmanek", "commentT": "2019-04-01T18:32:53Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/penpornk>@penpornk</denchmark-link>\n  ! What you did in <denchmark-link:https://github.com/tensorflow/tensorflow/commit/1a26797203e62390623756fd67e69e7665b69389>1a26797</denchmark-link>\n  makes sense to me. I'll give it a shot on ppc64le to confirm.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "jayfurmanek", "commentT": "2019-04-01T21:41:13Z", "comment_text": "\n \t\tConfirmed. No dual match on ppc64le when  is set.\n Thanks <denchmark-link:https://github.com/penpornk>@penpornk</denchmark-link>\n .\n Closing this issue.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "jayfurmanek", "commentT": "2019-04-01T21:41:15Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=24414>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=24414>No</denchmark-link>\n \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "jayfurmanek", "commentT": "2019-04-02T02:06:04Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jayfurmanek>@jayfurmanek</denchmark-link>\n  Great. Thank you again for bringing this up and sorry it took us this long!\n \t\t"}}}, "commit": {"commit_id": "1a26797203e62390623756fd67e69e7665b69389", "commit_author": "Penporn Koanantakool", "commitT": "2019-03-31 09:52:41-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\kernels\\BUILD", "file_new_name": "tensorflow\\core\\kernels\\BUILD", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "717,718,719,720,721,722,723,724,727,728,729,730,731,732,733,734,735,759,760,761,762,763,764,765", "deleted_lines": "726,739"}}}}}}