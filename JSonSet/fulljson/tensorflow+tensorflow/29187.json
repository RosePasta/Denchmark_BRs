{"BR": {"BR_id": "29187", "BR_author": "sbagroy986", "BRopenT": "2019-05-30T20:57:03Z", "BRcloseT": "2019-06-04T15:41:33Z", "BR_text": {"BRsummary": "TF 2.0: Cannot use recurrent_dropout with LSTMs/GRUs", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No (one line modification to stock example)\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 14.04\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): tensorflow-gpu==2.0.0-alpha0 (also fails with every other tf 2.0 build I have explored)\n Python version: 3.6\n Bazel version (if compiling from source): N/A\n GCC/Compiler version (if compiling from source): N/A\n CUDA/cuDNN version: Tried multiple\n GPU model and memory: Tried multiple\n \n Describe the current behavior\n The program crashes with a TypeError as below:\n TypeError: An op outside of the function building code is being passed a \"Graph\" tensor. It is possible to have Graph tensors leak out of the function building context by including a tf.init_scope in your function building code. For example, the following function will fail: @tf.function def has_init_scope(): my_constant = tf.constant(1.) with tf.init_scope(): added = my_constant * 2 The graph tensor has name: encoder/unified_gru/ones_like:0\n This occurs when trying to backprop the gradients through the LSTM/GRU with recurrent_dropout enabled.\n Describe the expected behavior\n No error\n \n Since this problem shows up at the time of training, one needs to have the entire training pipeline (dataset, model etc.) setup to demonstrate this bug. As a result, I used the <denchmark-link:https://www.tensorflow.org/alpha/tutorials/text/nmt_with_attention>Neural Machine Translation tutorial</denchmark-link>\n  from TensorFlow and modified their model to include . The entire code can be found in <denchmark-link:https://colab.research.google.com/drive/1dLE58i2tttY6J_Yr8dX8f57Ai0_54kTE>this Colab notebook</denchmark-link>\n ; run the code blocks all the way till the block where we're training the model to see the bug.\n Other info.logs\n x---------------------------------------------------------------------------\n TypeError                                 Traceback (most recent call last)\n  in ()\n       8 \n       9   for (batch, (inp, targ)) in enumerate(dataset.take(steps_per_epoch)):\n ---> 10     batch_loss = train_step(inp, targ, enc_hidden)\n      11     total_loss += batch_loss\n      12 \n \n 6 frames\n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/def_function.py in __call__(self, *args, **kwds)\n     436         # Lifting succeeded, so variables are initialized and we can run the\n     437         # stateless function.\n --> 438         return self._stateless_fn(*args, **kwds)\n     439     else:\n     440       canon_args, canon_kwds = self._canonicalize_function_inputs(args, kwds)\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/function.py in __call__(self, *args, **kwargs)\n    1286     \"\"\"Calls a graph function specialized to the inputs.\"\"\"\n    1287     graph_function, args, kwargs = self._maybe_define_function(args, kwargs)\n -> 1288     return graph_function._filtered_call(args, kwargs)  # pylint: disable=protected-access\n    1289 \n    1290   @property\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/function.py in _filtered_call(self, args, kwargs)\n     572     \"\"\"\n     573     return self._call_flat(\n --> 574         (t for t in nest.flatten((args, kwargs))\n     575          if isinstance(t, (ops.Tensor,\n     576                            resource_variable_ops.ResourceVariable))))\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/function.py in _call_flat(self, args)\n     625     # Only need to override the gradient in graph mode and when we have outputs.\n     626     if context.executing_eagerly() or not self.outputs:\n --> 627       outputs = self._inference_function.call(ctx, args)\n     628     else:\n     629       self._register_gradient()\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/function.py in call(self, ctx, args)\n     413             attrs=(\"executor_type\", executor_type,\n     414                    \"config_proto\", config),\n --> 415             ctx=ctx)\n     416       # Replace empty list with None\n     417       outputs = outputs or None\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/execute.py in quick_execute(op_name, num_outputs, inputs, attrs, ctx, name)\n      68     if any(ops._is_keras_symbolic_tensor(x) for x in inputs):\n      69       raise core._SymbolicException\n ---> 70     raise e\n      71   # pylint: enable=protected-access\n      72   return tensors\n \n /usr/local/lib/python3.6/dist-packages/tensorflow/python/eager/execute.py in quick_execute(op_name, num_outputs, inputs, attrs, ctx, name)\n      58     tensors = pywrap_tensorflow.TFE_Py_Execute(ctx._handle, device_name,\n      59                                                op_name, inputs, attrs,\n ---> 60                                                num_outputs)\n      61   except core._NotOkStatusException as e:\n      62     if name is not None:\n \n TypeError: An op outside of the function building code is being passed\n a \"Graph\" tensor. It is possible to have Graph tensors\n leak out of the function building context by including a\n tf.init_scope in your function building code.\n For example, the following function will fail:\n   @tf.function\n   def has_init_scope():\n     my_constant = tf.constant(1.)\n     with tf.init_scope():\n       added = my_constant * 2\n The graph tensor has name: encoder/unified_gru/ones_like:0\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "sbagroy986", "commentT": "2019-05-31T09:46:08Z", "comment_text": "\n \t\tHave tried with TensorFlow version 2.0.0-alpha and was able to reproduce the issue.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "sbagroy986", "commentT": "2019-06-03T18:19:34Z", "comment_text": "\n \t\tThanks for reporting the issue, let me take a look.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "sbagroy986", "commentT": "2019-06-04T15:41:33Z", "comment_text": "\n \t\tThanks for reporting the issue, it should now be fixed by <denchmark-link:https://github.com/tensorflow/tensorflow/commit/180f28a26660ca2e1ba27477f4f9592db5f9c4e8>180f28a</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "sbagroy986", "commentT": "2019-06-04T15:41:35Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=29187>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=29187>No</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "sbagroy986", "commentT": "2019-06-04T15:55:52Z", "comment_text": "\n \t\tBtw, the current colab might not apply the dropout correctly if you only enable the dropout/recurrent_dropout on the GRU layer. Under the hood, the keras layer will check whether the current context is in training or inference, and only apply the dropout during training. If the GRU layer was using by a keras model together with model.fit/eval/predict, then the training context will be applied correctly. However, if the user is writing their own custom training loop, then the training context need to be set manually, eg by\n tf.keras.backend.set_learning_phase(1)  # training\n run_train_step()\n \n tf.keras.backend.set_learning_phase(0)\n run_eval_step()\n The other alternative is that make sure the encoder/decoder's call() method is training state aware. eg, the method could take a new kwarg training=None, and set to different value during training and inference. The training value need to be popagated to GRU's call() method as well.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "sbagroy986", "commentT": "2019-06-06T21:14:32Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/qlzh727>@qlzh727</denchmark-link>\n : Thanks a ton for your help on this!\n Quick follow-up: has this been fixed in the GPU version as well? I tried the (nightly) version from yesterday and it didn't seem to work.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "sbagroy986", "commentT": "2019-07-31T17:18:57Z", "comment_text": "\n \t\tThe issue still persists in the beta release\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "sbagroy986", "commentT": "2019-08-12T05:52:03Z", "comment_text": "\n \t\tI still have this issue in beta 2.0.0b1\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "sbagroy986", "commentT": "2019-08-12T14:47:54Z", "comment_text": "\n \t\tFor any of you that still facing the issue, could u provide a snippet to reproduce the issue?\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "sbagroy986", "commentT": "2019-08-31T11:13:19Z", "comment_text": "\n \t\t\n could u provide a snippet to reproduce the issue?\n \n Similar error even without GRU.\n <denchmark-code>cp_callback = ModelCheckpoint(filepath=\"checkpoints/\", save_weights_only=False, verbose=0, save_best_only=True)\n \n feature_layer = tf.keras.layers.DenseFeatures(feature_columns)\n \n model = tf.keras.Sequential([\n   feature_layer,\n   layers.Dense(128, activation='relu'),\n   layers.Dense(128, activation='relu'),\n   layers.Dense(1, activation='sigmoid')\n ])\n \n model.compile(optimizer='adam', loss='binary_crossentropy', metrics=['accuracy'], run_eagerly=True)\n model.fit(train_ds, validation_data=val_ds, epochs=5, callbacks=[cp_callback])\n </denchmark-code>\n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "sbagroy986", "commentT": "2019-09-09T17:32:00Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/knobel-dk>@knobel-dk</denchmark-link>\n , I am bit confused about your message, this issue was about the recurrent_dropout for the LSTM/GRU layer, but your code doesn't have any LSTM/GRU layer within it.\n Could you be more specific about the error you are facing?\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "sbagroy986", "commentT": "2019-09-10T09:22:24Z", "comment_text": "\n \t\t\n @knobel-dk, I am bit confused about your message, this issue was about the recurrent_dropout for the LSTM/GRU layer, but your code doesn't have any LSTM/GRU layer within it.\n Could you be more specific about the error you are facing?\n \n Thanks. Yes I have confused myself too. Those stateful Jupyter notebooks.. I fixed my problem by updating the TF2 version. Thanks.\n \t\t"}}}, "commit": {"commit_id": "180f28a26660ca2e1ba27477f4f9592db5f9c4e8", "commit_author": "Scott Zhu", "commitT": "2019-06-04 08:31:21-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.8461538461538461", "commit_Nprams": "0.8461538461538461"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\layers\\recurrent_v2.py", "file_new_name": "tensorflow\\python\\keras\\layers\\recurrent_v2.py", "file_complexity": {"file_NLOC": "855", "file_CCN": "61", "file_NToken": "3751"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "323,324", "deleted_lines": "322", "method_info": {"method_name": "call", "method_params": "self,inputs,mask,training,initial_state", "method_startline": "311", "method_endline": "360", "method_complexity": {"method_NLOC": "39", "method_CCN": "8", "method_NToken": "252", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\keras\\layers\\recurrent_v2_test.py", "file_new_name": "tensorflow\\python\\keras\\layers\\recurrent_v2_test.py", "file_complexity": {"file_NLOC": "64", "file_CCN": "6", "file_NToken": "463"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90", "deleted_lines": null, "method_info": {"method_name": "test_reset_dropout_mask_between_batch", "method_params": "self,layer", "method_startline": "66", "method_endline": "90", "method_complexity": {"method_NLOC": "22", "method_CCN": "4", "method_NToken": "165", "method_nesting_level": "1"}}}}}}}}