{"BR": {"BR_id": "31596", "BR_author": "michaelbenayoun", "BRopenT": "2019-08-13T22:26:37Z", "BRcloseT": "2020-05-28T17:10:49Z", "BR_text": {"BRsummary": "TFLiteConverter fails with tf.gather when the params argument is a layer attribute", "BRdescription": "\n Please make sure that this is a bug. As per our GitHub Policy, we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04.5 LTS\n TensorFlow installed from (source or binary): conda\n TensorFlow version (use command below): 2.0.0-dev20190807\n Python version: 3.6.8\n CUDA/cuDNN version: 10.0\n GPU model and memory: 8 x Tesla P100-PCIE-16GB\n \n Describe the current behavior\n I am not able to convert a SavedModel to a FlatBuffer using TFLiteConverter when the corresponding tf.keras.Model contains a layer with a tf.gather op for which the params argument comes from a variable that was initialized in the build method of that said layer.\n When the params argument is from a locally defined variable, or when using tf.nn.embedding_lookup instead of tf.gather, everything works perfectly fine.\n It also applies to tf.gather_nd.\n Describe the expected behavior\n I expect tf.gather to work for the case in which the params argument is an attribute of the tf.keras.layers.Layer, just as it does for the other cases mentioned.\n Code to reproduce the issue\n I wrote a toy example to reproduce the issue, it might be clearer than the description above.\n <denchmark-code>import numpy as np\n import tensorflow as tf\n print(tf.__version__)\n \n class Embedding(tf.keras.layers.Layer):\n     def __init__(self, vocab_size, hidden_size):\n         super(Embedding, self).__init__()\n         self.vocab_size = vocab_size\n         self.hidden_size = hidden_size\n     \n     def build(self, input_shape):\n         self.shared_weights = self.add_weight(\n             \"weights\",\n             shape=(self.vocab_size, self.hidden_size),\n             dtype=tf.float32,\n             initializer=tf.random_normal_initializer(\n                 mean=0.0, \n                 stddev=self.hidden_size ** (-0.5)\n             )\n         )\n     \n     def call(self, input_):\n         # return tf.nn.embedding_lookup(self.shared_weights, input_)\n         # return tf.gather(tf.zeros(shape=(self.vocab_size, self.hidden_size)), input_)\n         return tf.gather(self.shared_weights, input_)\n \n \n class SimpleModel(tf.keras.Model):\n     def __init__(self, vocab_size, hidden_size):\n         super(SimpleModel, self).__init__()\n         self.embedding_layer = Embedding(vocab_size, hidden_size)\n     \n     @tf.function(input_signature=[tf.TensorSpec(shape=(None, ), dtype=tf.int64, name='input')])\n     def call(self, input_):\n         return self.embedding_layer(input_)\n \n vocab_size = 20000\n hidden_size = 300\n \n # Building the model.\n model = SimpleModel(vocab_size, hidden_size)\n input_ = tf.random.uniform(shape=(20, ), dtype=tf.int64, maxval=100)\n model(input_)\n \n # Exporting to SavedModel.\n saved_model_dir = 'simple_model/'\n tf.saved_model.save(model, saved_model_dir)\n \n # TFLite conversion.\n converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir)\n tflite_model = converter.convert()\n </denchmark-code>\n \n Other info / logs\n <denchmark-code>Traceback (most recent call last):\n   File \"/home/michael/.conda/envs/tf20/bin/toco_from_protos\", line 10, in <module>\n     sys.exit(main())\n   File \"/home/michael/.conda/envs/tf20/lib/python3.6/site-packages/tensorflow_core/lite/toco/python/toco_from_protos.py\", line 89, in main\n     app.run(main=execute, argv=[sys.argv[0]] + unparsed)\n   File \"/home/michael/.conda/envs/tf20/lib/python3.6/site-packages/tensorflow_core/python/platform/app.py\", line 40, in run\n     _run(main=main, argv=argv, flags_parser=_parse_flags_tolerate_undef)\n   File \"/home/michael/.conda/envs/tf20/lib/python3.6/site-packages/absl/app.py\", line 300, in run\n     _run_main(main, args)\n   File \"/home/michael/.conda/envs/tf20/lib/python3.6/site-packages/absl/app.py\", line 251, in _run_main\n     sys.exit(main(argv))\n   File \"/home/michael/.conda/envs/tf20/lib/python3.6/site-packages/tensorflow_core/lite/toco/python/toco_from_protos.py\", line 52, in execute\n     enable_mlir_converter)\n Exception: Placeholder statefulpartitionedcall_args_1 should be specied by input_arrays.\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "michaelbenayoun", "commentT": "2019-08-14T03:29:16Z", "comment_text": "\n \t\tIssue replicating with TF nightly-2.0-preview.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "michaelbenayoun", "commentT": "2019-08-19T14:56:42Z", "comment_text": "\n \t\tFollow-up: another (temporary) solution I found is to use tf.identity,  return tf.gather(tf.identity(self.shared_weights), input_) works fine.\n It might not be the most efficient way of fixing the issue (especially for large tensors) but it works.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "michaelbenayoun", "commentT": "2019-08-26T20:26:57Z", "comment_text": "\n \t\tThis should be fixed by <denchmark-link:https://github.com/tensorflow/tensorflow/commit/b42547e3bca7ab796f40f20726f4b09bf552e833>b42547e</denchmark-link>\n . Please reopen if the original code doesn't work in the nightly.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "michaelbenayoun", "commentT": "2019-08-26T20:26:59Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=31596>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=31596>No</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "michaelbenayoun", "commentT": "2019-09-04T14:51:57Z", "comment_text": "\n \t\tUpdated tensorflow 2.0 preview to the 20190903 nightly and still facing an issue.\n <denchmark-h:h4>Code to reproduce</denchmark-h>\n \n The code is basically the same as before: it runs when using tf.nn.embedding_lookup or wrapping the shared weights with a tf.identity op, but fails in the regular case with a tf.gather.\n <denchmark-code>import numpy as np\n import tensorflow as tf\n print(tf.__version__)\n \n import os\n \n class Embedding(tf.keras.layers.Layer):\n     def __init__(self, vocab_size, hidden_size):\n         super(Embedding, self).__init__()\n         self.vocab_size = vocab_size\n         self.hidden_size = hidden_size\n     \n     def build(self, input_shape):\n         self.shared_weights = self.add_weight(\n             \"weights\",\n             shape=(self.vocab_size, self.hidden_size),\n             dtype=tf.float32,\n             initializer=tf.random_normal_initializer(\n                 mean=0.0, \n                 stddev=self.hidden_size ** (-0.5)\n             )\n         )\n     \n     def call(self, input_, mode=\"embedding\"):\n         # return tf.gather(tf.identity(self.shared_weights), input_)\n         # return tf.nn.embedding_lookup(self.shared_weights, input_)\n         return tf.gather(self.shared_weights, input_)\n \n \n class SimpleModel(tf.keras.Model):\n     def __init__(self, vocab_size, hidden_size):\n         super(SimpleModel, self).__init__()\n         self.embedding_layer = Embedding(vocab_size, hidden_size)\n     \n     @tf.function(input_signature=[tf.TensorSpec(shape=(None, 25), dtype=tf.int64, name='input')])\n     def call(self, input_):\n         return self.embedding_layer(input_)\n \n vocab_size = 20000\n hidden_size = 300\n \n # Building the model.\n model = SimpleModel(vocab_size, hidden_size)\n input_ = tf.random.uniform(shape=(10, 25), dtype=tf.int64, maxval=100)\n model(input_)\n \n # Exporting to SavedModel.\n saved_model_dir = 'simple_model/'\n tf.saved_model.save(model, saved_model_dir)\n \n # TFLite conversion.\n converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir)\n tflite_model = converter.convert()\n </denchmark-code>\n \n <denchmark-h:h4>Other info / logs</denchmark-h>\n \n Although it is not the same error message as before (ResourceGather related), I think it might be related to the initial issue.\n <denchmark-code>2019-09-04 10:49:32.751617: I tensorflow/lite/toco/graph_transformations/graph_transformations.cc:39] Before Removing unused ops: 6 operators, 9 arrays (0 quantized)\n 2019-09-04 10:49:32.751814: I tensorflow/lite/toco/graph_transformations/graph_transformations.cc:39] Before general graph transformations: 6 operators, 9 arrays (0 quantized)\n 2019-09-04 10:49:32.751891: F tensorflow/lite/toco/graph_transformations/resolve_gather_attributes.cc:47] Check failed: axis_data.size() == 1 (2 vs. 1)Multidimensional gather not supported on {Gather operator with output StatefulPartitionedCall/embedding_4/Gather}\n Fatal Python error: Aborted\n </denchmark-code>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "michaelbenayoun", "commentT": "2020-05-14T16:01:07Z", "comment_text": "\n \t\t\n Updated tensorflow 2.0 preview to the 20190903 nightly and still facing an issue.\n \n <denchmark-link:https://github.com/michaelbenayoun>@michaelbenayoun</denchmark-link>\n ,\n I was able to run the code without any issues with the latest TF-nightly i.e. 2.3.0-dev20200514. Please find the gist of it <denchmark-link:https://colab.research.google.com/gist/amahendrakar/dfb9e315b72999f54e8e6f258d155195/31596-tf-nightly.ipynb>here</denchmark-link>\n . Thanks!\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "michaelbenayoun", "commentT": "2020-05-21T16:26:15Z", "comment_text": "\n \t\tThis issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "michaelbenayoun", "commentT": "2020-05-28T17:10:45Z", "comment_text": "\n \t\tClosing as stale. Please reopen if you'd like to work on this further.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "michaelbenayoun", "commentT": "2020-05-28T17:10:50Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/31596>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/31596>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "252e6183523d226e50137c06a101df0aa5d4d5d9", "commit_author": "Reed Wanderman-Milne", "commitT": "2019-12-23 15:48:33-08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\keras\\saving\\metrics_serialization_test.py", "file_new_name": "tensorflow\\python\\keras\\saving\\metrics_serialization_test.py", "file_complexity": {"file_NLOC": "217", "file_CCN": "16", "file_NToken": "1618"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "223", "deleted_lines": "223", "method_info": {"method_name": "test_serializing_model_with_metric_with_custom_objects", "method_params": "self,value", "method_startline": "218", "method_endline": "264", "method_complexity": {"method_NLOC": "34", "method_CCN": "2", "method_NToken": "296", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "223", "deleted_lines": "223", "method_info": {"method_name": "test_serializing_model_with_metric_with_custom_objects.get_instance", "method_params": "x", "method_startline": "220", "method_endline": "225", "method_complexity": {"method_NLOC": "6", "method_CCN": "4", "method_NToken": "38", "method_nesting_level": "2"}}}}}}}}