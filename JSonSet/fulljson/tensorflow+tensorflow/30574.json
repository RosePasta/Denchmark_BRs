{"BR": {"BR_id": "30574", "BR_author": "jbgh2", "BRopenT": "2019-07-10T18:05:41Z", "BRcloseT": "2019-09-19T16:07:57Z", "BR_text": {"BRsummary": "Decode_wav sample rate output cannot be passed to tf.signal.linear_to_mel_weight_matrix", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Combined output of decode_wav with the sample in signal/mfccs_from_log_mel_spectrograms\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: No\n TensorFlow installed from (source or binary): Conda binary\n TensorFlow version (use command below): 2.0.0-dev20190702 (git version unknown)\n Python version: 3.6.7\n Bazel version (if compiling from source): No\n GCC/Compiler version (if compiling from source): No\n CUDA/cuDNN version:\n GPU model and memory: Surface Book Nvidia GPU\n \n Describe the current behavior\n The output of decode_wav is tuple of (wav_data, sample_rate)\n Sample_rate is int32 but linear_to_mel_weight_matrix expects a float32 sample_rate.\n If the sample rate is cast using tf.cast(sample_rate, float32) and then a TypeError is thrown with the message:\n TypeError: Using a tf.Tensor as a Python bool is not allowed. Use if t is not None: instead of if t: to test if a tensor is defined, and use TensorFlow ops such as tf.cond to execute subgraphs conditioned on the value of a tensor.\n Describe the expected behavior\n Sample rate output of decode_wav can be used as input to linear_to_mel_weight_matrix.\n Code to reproduce the issue\n Provide a reproducible test case that is the bare minimum necessary to generate the problem.\n <denchmark-code>import tensorflow as tf\n \n def load_and_mel_file(path_tensor):\n     #From: https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/signal/mfccs_from_log_mel_spectrograms\n     pcm, sample_rate = tf.audio.decode_wav(path_tensor)\n     sr_f = tf.cast(sample_rate, tf.float32) #Mismatch in types between output of decode_wav and input to linear_to_mel_weight_matrix\n     print(pcm, sample_rate, sr_f)\n \n     # A 1024-point STFT with frames of 64 ms and 75% overlap.\n     stfts = tf.signal.stft(pcm, frame_length=1024, frame_step=256,\n                            fft_length=1024)\n     spectrograms = tf.abs(stfts)\n \n     # Warp the linear scale spectrograms into the mel-scale.\n     num_spectrogram_bins = stfts.shape[-1]\n     lower_edge_hertz, upper_edge_hertz, num_mel_bins = 80.0, 7600.0, 80\n     linear_to_mel_weight_matrix = tf.signal.linear_to_mel_weight_matrix(\n       num_mel_bins, num_spectrogram_bins, sr_f, lower_edge_hertz,\n       upper_edge_hertz)\n     mel_spectrograms = tf.tensordot(\n       spectrograms, linear_to_mel_weight_matrix, 1)\n     mel_spectrograms.set_shape(spectrograms.shape[:-1].concatenate(\n       linear_to_mel_weight_matrix.shape[-1:]))\n \n     # Compute a stabilized log to get log-magnitude mel-scale spectrograms.\n     log_mel_spectrograms = tf.math.log(mel_spectrograms + 1e-6)\n     print(log_mel_spectrograms)\n     \n     return log_mel_spectrograms\n \n path_ds = tf.data.Dataset.list_files(\"*.wav\")\n mel_ds = path_ds.map(load_and_mel_file)\n </denchmark-code>\n \n Other info / logs\n Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\n \n \n TypeError                                 Traceback (most recent call last)\n  in \n 1 #Build datasets\n ----> 2 train_ds = build_data_pairs_from_dir(train_dir)\n 3 test_ds = build_data_pairs_from_dir(test_dir)\n \n  in build_data_pairs_from_dir(source_dir)\n 54\n 55     #Convert to MEL\n ---> 56     clean_mel_ds = clean_path_ds.map(load_and_mel_file, num_parallel_calls=AUTOTUNE)\n 57     noisy_mel_ds = noisy_path_ds.map(load_and_mel_file, num_parallel_calls=AUTOTUNE)\n 58\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\data\\ops\\dataset_ops.py in map(self, map_func, num_parallel_calls)\n 1887       return DatasetV1Adapter(\n 1888           ParallelMapDataset(\n -> 1889               self, map_func, num_parallel_calls, preserve_cardinality=False))\n 1890\n 1891   @deprecation.deprecated(None, \"Use `tf.data.Dataset.map()\")\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\data\\ops\\dataset_ops.py in init(self, input_dataset, map_func, num_parallel_calls, use_inter_op_parallelism, preserve_cardinality, use_legacy_function)\n 3333         self._transformation_name(),\n 3334         dataset=input_dataset,\n -> 3335         use_legacy_function=use_legacy_function)\n 3336     self._num_parallel_calls = ops.convert_to_tensor(\n 3337         num_parallel_calls, dtype=dtypes.int32, name=\"num_parallel_calls\")\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\data\\ops\\dataset_ops.py in init(self, func, transformation_name, dataset, input_classes, input_shapes, input_types, input_structure, add_to_graph, use_legacy_function, defun_kwargs)\n 2677       resource_tracker = tracking.ResourceTracker()\n 2678       with tracking.resource_tracker_scope(resource_tracker):\n -> 2679         self._function = wrapper_fn._get_concrete_function_internal()\n 2680         if add_to_graph:\n 2681           self._function.add_to_graph(ops.get_default_graph())\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\eager\\function.py in _get_concrete_function_internal(self, *args, **kwargs)\n 1418     \"\"\"Bypasses error checking when getting a graph function.\"\"\"\n 1419     graph_function = self._get_concrete_function_internal_garbage_collected(\n -> 1420         *args, **kwargs)\n 1421     # We're returning this concrete function to someone, and they may keep a\n 1422     # reference to the FuncGraph without keeping a reference to the\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\eager\\function.py in _get_concrete_function_internal_garbage_collected(self, *args, **kwargs)\n 1412     if self.input_signature:\n 1413       args, kwargs = None, None\n -> 1414     graph_function, _, _ = self._maybe_define_function(args, kwargs)\n 1415     return graph_function\n 1416\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\eager\\function.py in _maybe_define_function(self, args, kwargs)\n 1716         graph_function = self._function_cache.primary.get(cache_key, None)\n 1717         if graph_function is None:\n -> 1718           graph_function = self._create_graph_function(args, kwargs)\n 1719           self._function_cache.primary[cache_key] = graph_function\n 1720         return graph_function, args, kwargs\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\eager\\function.py in _create_graph_function(self, args, kwargs, override_flat_arg_shapes)\n 1602             arg_names=arg_names,\n 1603             override_flat_arg_shapes=override_flat_arg_shapes,\n -> 1604             capture_by_value=self._capture_by_value),\n 1605         self._function_attributes)\n 1606\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\framework\\func_graph.py in func_graph_from_py_func(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes)\n 784                                           converted_func)\n 785\n --> 786       func_outputs = python_func(*func_args, **func_kwargs)\n 787\n 788       # invariant: func_outputs contains only Tensors, CompositeTensors,\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\data\\ops\\dataset_ops.py in wrapper_fn(*args)\n 2671           attributes=defun_kwargs)\n 2672       def wrapper_fn(*args):  # pylint: disable=missing-docstring\n -> 2673         ret = _wrapper_helper(*args)\n 2674         ret = structure.to_tensor_list(self._output_structure, ret)\n 2675         return [ops.convert_to_tensor(t) for t in ret]\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\data\\ops\\dataset_ops.py in _wrapper_helper(*args)\n 2616         nested_args = (nested_args,)\n 2617\n -> 2618       ret = autograph.tf_convert(func, ag_ctx)(*nested_args)\n 2619       # If func returns a list of tensors, nest.flatten() and\n 2620       # ops.convert_to_tensor() would conspire to attempt to stack\n c:\\users\\benhe.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\autograph\\impl\\api.py in wrapper(*args, **kwargs)\n 220         except Exception as e:  # pylint:disable=broad-except\n 221           if hasattr(e, 'ag_error_metadata'):\n --> 222             raise e.ag_error_metadata.to_exception(type(e))\n 223           else:\n 224             raise\n TypeError: in converted code:\n <ipython-input-60-92023d8b5863>:27 load_and_mel_file  *\n     linear_to_mel_weight_matrix = tf.signal.linear_to_mel_weight_matrix(\n c:\\users\\benhe\\.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\ops\\signal\\mel_ops.py:155 linear_to_mel_weight_matrix\n     lower_edge_hertz, upper_edge_hertz, dtype)\n c:\\users\\benhe\\.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\ops\\signal\\mel_ops.py:74 _validate_arguments\n     if sample_rate <= 0.0:\n c:\\users\\benhe\\.conda\\envs\\homl2\\lib\\site-packages\\tensorflow_core\\python\\framework\\ops.py:692 __bool__\n     raise TypeError(\"Using a `tf.Tensor` as a Python `bool` is not allowed. \"\n \n TypeError: Using a `tf.Tensor` as a Python `bool` is not allowed. Use `if t is not None:` instead of `if t:` to test if a tensor is defined, and use TensorFlow ops such as tf.cond to execute subgraphs conditioned on the value of a tensor.\n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jbgh2", "commentT": "2019-07-11T06:40:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jbgh2>@jbgh2</denchmark-link>\n  I tried reproducing the issue on Colab with Tensorflow 2.0.0-dev20190709 but i got the below error  . Please help us to reproduce the issue. Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jbgh2", "commentT": "2019-07-11T08:15:12Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/gadagashwini>@gadagashwini</denchmark-link>\n  You need to have at least one .wav file in your working directory, otherwise it will obviously not run.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jbgh2", "commentT": "2019-07-12T06:39:07Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jbgh2>@jbgh2</denchmark-link>\n  I tried executing the .wav file but I am getting the following error\n `\n \n ValueError: sample_rate was a non-constant Tensor. Must be a Python float or a constant Tensor.\n \n `. Thanks!\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jbgh2", "commentT": "2019-07-12T14:00:23Z", "comment_text": "\n \t\tBug repro in Colab using TF Versions: 2.0.0-beta1\n <denchmark-link:https://colab.research.google.com/drive/139qvpTBQH079_z-RFfeTcbJqixV2oL_G>https://colab.research.google.com/drive/139qvpTBQH079_z-RFfeTcbJqixV2oL_G</denchmark-link>\n \n As far as I can tell the bug is because _validate_arguments expects Python types not Tensors and decode_wav returns sample_rate as a Tensor.\n I've included code to repro both problems:\n \n Sample_Rate from decode_wav is an int32 tensor that is compared to a Python 0.0\n Cast sample_rate to float32 tensor causes bool comparison error\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jbgh2", "commentT": "2019-09-15T06:21:10Z", "comment_text": "\n \t\tThanks for the report! I have a fix for this out for review.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jbgh2", "commentT": "2019-09-19T16:07:57Z", "comment_text": "\n \t\tFixed in <denchmark-link:https://github.com/tensorflow/tensorflow/commit/03ff87bfdeec43b9d3a208746ae19ebf9c139c14>03ff87b</denchmark-link>\n .\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jbgh2", "commentT": "2019-09-19T16:07:58Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=30574>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=30574>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "03ff87bfdeec43b9d3a208746ae19ebf9c139c14", "commit_author": "RJ Skerry-Ryan", "commitT": "2019-09-16 14:07:30-07:00", "commit_complexity": {"commit_NLOC": "0.3", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "tensorflow\\python\\kernel_tests\\signal\\mel_ops_test.py", "file_new_name": "tensorflow\\python\\kernel_tests\\signal\\mel_ops_test.py", "file_complexity": {"file_NLOC": "111", "file_CCN": "9", "file_NToken": "928"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "137,138,139,140,141,142,143,144,145,146,147,148,149,150,151", "deleted_lines": "137,138,139,140,141,142,143,144,145,146,147,148,149,150,151", "method_info": {"method_name": "test_matches_reference_implementation", "method_params": "self", "method_startline": "137", "method_endline": "151", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "115", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "153,154,155,156,157", "deleted_lines": "153,155,156,157", "method_info": {"method_name": "test_dtypes", "method_params": "self", "method_startline": "153", "method_endline": "157", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "35", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "187,188,193", "deleted_lines": "183,188,189,190,191,192,193", "method_info": {"method_name": "test_constant_folding", "method_params": "self", "method_startline": "183", "method_endline": "193", "method_complexity": {"method_NLOC": "9", "method_CCN": "3", "method_NToken": "76", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "188,193,194,195,196,197,198,199", "deleted_lines": "188,189,190,191,192,193", "method_info": {"method_name": "test_constant_folding", "method_params": "self,dtype", "method_startline": "188", "method_endline": "199", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "79", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "159,160,161,163,164", "deleted_lines": "169,170,171", "method_info": {"method_name": "test_error", "method_params": "self", "method_startline": "159", "method_endline": "181", "method_complexity": {"method_NLOC": "22", "method_CCN": "2", "method_NToken": "161", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "147,148,149", "deleted_lines": "147,148,149", "method_info": {"method_name": "test_matches_reference_implementation", "method_params": "self,num_mel_bins,num_spectrogram_bins,sample_rate,use_tensor_sample_rate,lower_edge_hertz,upper_edge_hertz,dtype", "method_startline": "147", "method_endline": "149", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "161,163,164", "deleted_lines": null, "method_info": {"method_name": "test_dtypes", "method_params": "self,dtype", "method_startline": "161", "method_endline": "164", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\ops\\signal\\mel_ops.py", "file_new_name": "tensorflow\\python\\ops\\signal\\mel_ops.py", "file_complexity": {"file_NLOC": "86", "file_CCN": "4", "file_NToken": "622"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "81,82,83,84,85,86,87,130,131,132,133,148,167", "deleted_lines": "75,76,83,84,85,86,129,130,131,132,147,148,158,159,160,170"}}}}}}