{"BR": {"BR_id": "34020", "BR_author": "kaisuke", "BRopenT": "2019-11-05T21:51:18Z", "BRcloseT": "2019-11-08T01:28:31Z", "BR_text": {"BRsummary": "Checkpoint.restore doesn't restore Dataset iterator state when Dataset contains shuffle()", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): v2.0.0-rc2-26-g64c3d38 2.0.0\n Python version: 3.5.2\n Bazel version (if compiling from source): n/a\n GCC/Compiler version (if compiling from source): n/a\n CUDA/cuDNN version: not installed\n GPU model and memory: no GPU\n \n Describe the current behavior\n The code at the end results in the following output.\n <denchmark-code>2019-11-05 13:54:16.140994: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n 2019-11-05 13:54:16.149389: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2397225000 Hz\n 2019-11-05 13:54:16.151608: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x50ebc70 executing computations on platform Host. Devices:\n 2019-11-05 13:54:16.151636: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version\n tf.Tensor(72, shape=(), dtype=int64)\n tf.Tensor(83, shape=(), dtype=int64)\n tf.Tensor(19, shape=(), dtype=int64)\n Saved to /tmp/x/ckpt-1\n tf.Tensor(74, shape=(), dtype=int64)\n tf.Tensor(33, shape=(), dtype=int64)\n tf.Tensor(93, shape=(), dtype=int64)\n Restored from /tmp/x/ckpt-1\n tf.Tensor(21, shape=(), dtype=int64)\n tf.Tensor(0, shape=(), dtype=int64)\n tf.Tensor(8, shape=(), dtype=int64)\n </denchmark-code>\n \n Describe the expected behavior\n After restoring from the checkpoint, I expect the iterator to return the same elements as it did after saving the checkpoint.  I.e.\n <denchmark-code>2019-11-05 13:54:16.140994: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n 2019-11-05 13:54:16.149389: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2397225000 Hz\n 2019-11-05 13:54:16.151608: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x50ebc70 executing computations on platform Host. Devices:\n 2019-11-05 13:54:16.151636: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version\n tf.Tensor(72, shape=(), dtype=int64)\n tf.Tensor(83, shape=(), dtype=int64)\n tf.Tensor(19, shape=(), dtype=int64)\n Saved to /tmp/x/ckpt-1\n tf.Tensor(74, shape=(), dtype=int64)\n tf.Tensor(33, shape=(), dtype=int64)\n tf.Tensor(93, shape=(), dtype=int64)\n Restored from /tmp/x/ckpt-1\n tf.Tensor(74, shape=(), dtype=int64)\n tf.Tensor(33, shape=(), dtype=int64)\n tf.Tensor(93, shape=(), dtype=int64)\n </denchmark-code>\n \n Code to reproduce the issue\n import tensorflow as tf\n ds = tf.data.Dataset.range(100).shuffle(100, seed=42, reshuffle_each_iteration=False)\n it = iter(ds)\n ckpt = tf.train.Checkpoint(foo=it)\n mgr = tf.train.CheckpointManager(ckpt, '/tmp/x', max_to_keep=3)\n for _ in range(3): print(next(it))\n mgr.save()\n print(\"Saved to {}\".format(mgr.latest_checkpoint))\n for _ in range(3): print(next(it))\n ckpt.restore(mgr.latest_checkpoint)\n print(\"Restored from {}\".format(mgr.latest_checkpoint))\n for _ in range(3): print(next(it))\n FWIW, I get the expected result if I remove .shuffle(...).\n Other info / logs\n Include any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "kaisuke", "commentT": "2019-11-06T10:48:02Z", "comment_text": "\n \t\tIssue replicating for TF-2.0, kindly find the <denchmark-link:https://colab.sandbox.google.com/gist/oanush/571af19a2605e0b63938207f55803361/untitled26.ipynb>gist</denchmark-link>\n  of colab.Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "kaisuke", "commentT": "2019-11-06T18:54:40Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kaisuke>@kaisuke</denchmark-link>\n  Checkpoint.save and Checkpoint.restore write and read object-based checkpoints, in contrast to TensorFlow 1.x's tf.compat.v1.train.Saver which writes and reads variable.name based checkpoints. Object-based checkpointing saves a graph of dependencies between Python objects (Layers, Optimizers, Variables, etc.) with named edges, and this graph is used to match variables when restoring a checkpoint. It can be more robust to changes in the Python program, and helps to support restore-on-create for variables.\n This is the reason why you are observing changes when you are using .shuffle() method. For more information, you can go through the following <denchmark-link:https://www.tensorflow.org/api_docs/python/tf/train/Checkpoint>link</denchmark-link>\n . Thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "kaisuke", "commentT": "2019-11-06T19:59:34Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/gowthamkpr>@gowthamkpr</denchmark-link>\n  for the explanation, but I couldn't see the logical connection between your paragraph 1 & 2...\n In the TensorFlow C++ codebase, I see support for saving/restoring iterators for a shuffling Dataset ( &  etc. in <denchmark-link:https://github.com/tensorflow/tensorflow/blob/4fae137/tensorflow/core/kernels/data/shuffle_dataset_op.cc>https://github.com/tensorflow/tensorflow/blob/4fae137/tensorflow/core/kernels/data/shuffle_dataset_op.cc</denchmark-link>\n ).  So I thought that iterators qualify as  as mentioned in the <denchmark-link:https://www.tensorflow.org/api_docs/python/tf/train/Checkpoint>tf.train.Checkpoint documentation</denchmark-link>\n .\n <denchmark-link:https://github.com/jsimsa>@jsimsa</denchmark-link>\n : It looks like you've been working on tf.data, including .  May I ask what your view on this is?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "kaisuke", "commentT": "2019-11-07T17:37:31Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/aaudiber>@aaudiber</denchmark-link>\n  could you please take a look? thanks\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "kaisuke", "commentT": "2019-11-07T22:43:22Z", "comment_text": "\n \t\tI was able to reproduce the issue. It appears that some state is not properly reset when restoring an active shuffle iterator from a checkpoint. I have a fix in-flight.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "kaisuke", "commentT": "2019-11-08T01:28:32Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/34020>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/34020>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "53d244502fe0de438c939438d00e86f0409b2cb5", "commit_author": "Andrew Audibert", "commitT": "2019-11-07 17:27:38-08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\core\\kernels\\data\\shuffle_dataset_op.cc", "file_new_name": "tensorflow\\core\\kernels\\data\\shuffle_dataset_op.cc", "file_complexity": {"file_NLOC": "676", "file_CCN": "85", "file_NToken": "4852"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "328", "deleted_lines": null, "method_info": {"method_name": "tensorflow::data::ShuffleDatasetOpBase::ShuffleDatasetBase::Iterator::RestoreInternal", "method_params": "ctx,reader", "method_startline": "296", "method_endline": "358", "method_complexity": {"method_NLOC": "57", "method_CCN": "5", "method_NToken": "492", "method_nesting_level": "4"}}}}}}}}