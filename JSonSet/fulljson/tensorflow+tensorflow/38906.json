{"BR": {"BR_id": "38906", "BR_author": "jakublipinski", "BRopenT": "2020-04-26T08:42:01Z", "BRcloseT": "2020-06-05T15:53:21Z", "BR_text": {"BRsummary": "MemoryOptimizer produces broken graph with AlreadyExistsError exception while running GRU layer on Tensorflow 2.2.0rc_3", "BRdescription": "\n System information\n \n Custom model built using keras\n MacBook Pro, 8-Core Intel Core i9, macOS Catalina 10.15.4\n TensorFlow installed from pip in virtual environment\n TensorFlow v2.2.0-rc2-77-gaad398b5e9 2.2.0-rc3\n Python 3.7.5\n Running on CPU\n \n Describe the current behavior\n The code snippet listed below outputs multiple tensorflow/core/framework/op_kernel.cc:1753] OP_REQUIRES failed at variable_ops.cc:104 : Already exists: Resource warnings and finally exists with tensorflow.python.framework.errors_impl.AlreadyExistsError exception.\n Note: the code works correctly if the GRU layer size is decreased from 320 to 80. It also works if TensorFlow is downgraded to version 2.0.1.\n The issue is related to <denchmark-link:https://github.com/tensorflow/tensorflow/issues/23780>#23780</denchmark-link>\n  issue reported in 2018. This issue offers code to reproduce it and occurs on the latest version of TensorFlow.\n Describe the expected behavior\n The code should work without exception.\n Standalone code to reproduce the issue\n import numpy as np\n \n from tensorflow.keras.models import Sequential\n from tensorflow.keras.layers import Dense, Flatten, Bidirectional, GRU\n from tensorflow.keras.layers import Conv1D, MaxPooling1D\n \n x = np.random.rand(1000, 401, 17)\n y = np.random.choice([0, 1], size=(1000, 301))\n \n model = Sequential()\n model.add(Conv1D(filters=320, kernel_size=26, activation='relu', input_shape=(401, x.shape[2])))\n model.add(MaxPooling1D(pool_size=13, strides=13))\n model.add(Bidirectional(GRU(320, dropout=0.2, recurrent_dropout=0.2, return_sequences=True)))\n model.add(Flatten())\n model.add(Dense(2000, activation=\"relu\"))\n model.add(Dense(301, activation=\"sigmoid\"))\n model.compile(loss=\"binary_crossentropy\", optimizer=\"rmsprop\", metrics=[\"accuracy\"])\n \n model.summary()\n \n model.fit(x=x, y=y, epochs=1, verbose=1)\n The Google Colab notebook is available <denchmark-link:https://colab.research.google.com/drive/1YohTA6Hxi3H6aOQgFj34C0tKErW2V_rL>here</denchmark-link>\n . The error is reproducible.\n Other info / logs\n The code above generates following output:\n <denchmark-code>Model: \"sequential\"\n _________________________________________________________________\n Layer (type)                 Output Shape              Param #   \n =================================================================\n conv1d (Conv1D)              (None, 376, 320)          141760    \n _________________________________________________________________\n max_pooling1d (MaxPooling1D) (None, 28, 320)           0         \n _________________________________________________________________\n bidirectional (Bidirectional (None, 28, 640)           1232640   \n _________________________________________________________________\n flatten (Flatten)            (None, 17920)             0         \n _________________________________________________________________\n dense (Dense)                (None, 2000)              35842000  \n _________________________________________________________________\n dense_1 (Dense)              (None, 301)               602301    \n =================================================================\n Total params: 37,818,701\n Trainable params: 37,818,701\n Non-trainable params: 0\n _________________________________________________________________\n 2020-04-26 10:19:57.349570: W tensorflow/core/framework/op_kernel.cc:1753] OP_REQUIRES failed at variable_ops.cc:104 : Already exists: Resource __per_step_0/gradient_tape/sequential/bidirectional/backward_gru/while/sequential/bidirectional/backward_gru/while_grad/body/_877/gradients/AddN_8/tmp_var/N10tensorflow19TemporaryVariableOp6TmpVarE\n 2020-04-26 10:19:57.363399: W tensorflow/core/framework/op_kernel.cc:1753] OP_REQUIRES failed at variable_ops.cc:104 : Already exists: Resource __per_step_0/gradient_tape/sequential/bidirectional/backward_gru/while/sequential/bidirectional/backward_gru/while_grad/body/_877/gradients/AddN_7/tmp_var/N10tensorflow19TemporaryVariableOp6TmpVarE\n 2020-04-26 10:19:57.377361: W tensorflow/core/framework/op_kernel.cc:1753] OP_REQUIRES failed at variable_ops.cc:104 : Already exists: Resource __per_step_0/gradient_tape/sequential/bidirectional/backward_gru/while/sequential/bidirectional/backward_gru/while_grad/body/_877/gradients/AddN_8/tmp_var/N10tensorflow19TemporaryVariableOp6TmpVarE\n ... (repeated multiple times) ...\n 2020-04-26 10:19:57.677304: W tensorflow/core/framework/op_kernel.cc:1753] OP_REQUIRES failed at variable_ops.cc:104 : Already exists: Resource __per_step_0/gradient_tape/sequential/bidirectional/forward_gru/while/sequential/bidirectional/forward_gru/while_grad/body/_577/gradients/AddN_7/tmp_var/N10tensorflow19TemporaryVariableOp6TmpVarE\n Traceback (most recent call last):\n   File \"alreadyexists_err.py\", line 21, in <module>\n     model.fit(x=x, y=y, epochs=1, verbose=1)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 66, in _method_wrapper\n     return method(self, *args, **kwargs)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/keras/engine/training.py\", line 851, in fit\n     tmp_logs = train_function(iterator)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 580, in __call__\n     result = self._call(*args, **kwds)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py\", line 644, in _call\n     return self._stateless_fn(*args, **kwds)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 2420, in __call__\n     return graph_function._filtered_call(args, kwargs)  # pylint: disable=protected-access\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 1665, in _filtered_call\n     self.captured_inputs)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 1746, in _call_flat\n     ctx, args, cancellation_manager=cancellation_manager))\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/function.py\", line 598, in call\n     ctx=ctx)\n   File \"venv/lib/python3.7/site-packages/tensorflow/python/eager/execute.py\", line 60, in quick_execute\n     inputs, attrs, num_outputs)\n tensorflow.python.framework.errors_impl.AlreadyExistsError:  Resource __per_step_0/gradient_tape/sequential/bidirectional/backward_gru/while/sequential/bidirectional/backward_gru/while_grad/body/_877/gradients/AddN_8/tmp_var/N10tensorflow19TemporaryVariableOp6TmpVarE\n \t [[{{node gradient_tape/sequential/bidirectional/backward_gru/while/sequential/bidirectional/backward_gru/while_grad/body/_877/gradients/AddN_8/tmp_var}}]] [Op:__inference_train_function_7551]\n \n Function call stack:\n train_function\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jakublipinski", "commentT": "2020-04-27T09:46:15Z", "comment_text": "\n \t\tI have tried on colab with TF version 2.2.0-rc3 and was able to reproduce the issue.Please, find the gist <denchmark-link:https://colab.sandbox.google.com/gist/ravikyram/8652e1dae44721b792b47b6e9e45052c/untitled828.ipynb>here</denchmark-link>\n .Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jakublipinski", "commentT": "2020-04-27T16:11:55Z", "comment_text": "\n \t\tAdding <denchmark-link:https://github.com/saxenasaurabh>@saxenasaurabh</denchmark-link>\n  who works on core ops to provide more information about while loop.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jakublipinski", "commentT": "2020-04-27T16:26:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/rmlarsen>@rmlarsen</denchmark-link>\n  mentioned <denchmark-link:https://github.com/tensorflow/tensorflow/issues/23780#issuecomment-498334346>here</denchmark-link>\n  that this may be due to a bug in grappler generating non-unique names. <denchmark-link:https://github.com/rmlarsen>@rmlarsen</denchmark-link>\n  <denchmark-link:https://github.com/ezhulenev>@ezhulenev</denchmark-link>\n  do you know if this was fixed?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jakublipinski", "commentT": "2020-04-28T11:05:30Z", "comment_text": "\n \t\tI dug a bit further into this issue. This is what I found:\n It's indeed an optimizer issue, namely the ScopedAllocatorOptimizer optimizer.\n Interestingly, you cannot turn this optimizer off using tf.config.optimizer.set_experimental_options(). The scoped_allocator_optimization key is treated as Bool at:\n \n \n \n tensorflow/tensorflow/python/eager/context.py\n \n \n          Line 958\n       in\n       109fd38\n \n \n \n \n \n \n  rewriter_toggle(\"scoped_allocator_optimization\") \n \n \n \n \n \n while it's interpreted as int at:\n \n \n \n tensorflow/tensorflow/core/grappler/optimizers/meta_optimizer.cc\n \n \n          Line 292\n       in\n       8e0eecc\n \n \n \n \n \n \n  if (cfg_.scoped_allocator_optimization()) { \n \n \n \n \n \n Should I file another issue for that?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jakublipinski", "commentT": "2020-04-29T16:08:15Z", "comment_text": "\n \t\tLet me rename this bug to pointing to ScopedAllocatorOptimizer.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jakublipinski", "commentT": "2020-06-05T15:53:21Z", "comment_text": "\n \t\tVerified this is fixed with latest tf-nightly.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jakublipinski", "commentT": "2020-06-05T15:53:23Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/38906>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/38906>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "80a93674eafc224a45cbe96c65e993e9735634a3", "commit_author": "Eugene Zhulenev", "commitT": "2020-06-04 09:42:10-07:00", "commit_complexity": {"commit_NLOC": "0.9090909090909091", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\core\\kernels\\variable_ops.cc", "file_new_name": "tensorflow\\core\\kernels\\variable_ops.cc", "file_complexity": {"file_NLOC": "155", "file_CCN": "24", "file_NToken": "1156"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32,33,34,35,36,37,38,39,40", "deleted_lines": null, "method_info": {"method_name": "tensorflow::TemporaryVariableName", "method_params": "var_name,control_frame", "method_startline": "32", "method_endline": "40", "method_complexity": {"method_NLOC": "9", "method_CCN": "3", "method_NToken": "53", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "110,114,119", "deleted_lines": null, "method_info": {"method_name": "tensorflow::TemporaryVariableOp::Compute", "method_params": "context", "method_startline": "106", "method_endline": "125", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "175", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "163,166", "deleted_lines": null, "method_info": {"method_name": "tensorflow::DestroyTemporaryVariableOp::Compute", "method_params": "context", "method_startline": "154", "method_endline": "171", "method_complexity": {"method_NLOC": "15", "method_CCN": "2", "method_NToken": "132", "method_nesting_level": "2"}}}}}}}}