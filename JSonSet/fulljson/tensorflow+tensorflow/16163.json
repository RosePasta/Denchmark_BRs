{"BR": {"BR_id": "16163", "BR_author": "velikodniy", "BRopenT": "2018-01-16T16:55:16Z", "BRcloseT": "2018-02-23T05:43:34Z", "BR_text": {"BRsummary": "Dataset.from_generator doesn't release memory after recreating the session", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 17.10\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): 1.5.0-rc0\n Python version: Python 3.6\n Bazel version (if compiling from source): -\n GCC/Compiler version (if compiling from source): -\n CUDA/cuDNN version: -\n GPU model and memory: -\n Exact command to reproduce: see below\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n After closing the session and creating new one an iterator creates the generator instance but doesn't free the memory of the previous one.\n Every calling of the line session.run(x) (see below) increases memory consumption of the script:\n \n 519 MiB after the first,\n 600 MiB after the second,\n 681 MiB after the third and so on.\n \n As you can see the delta is equal to 80 MiB = N * sizeof(data.dtype). (data.dtype is float64 here)\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n import numpy as np\n import tensorflow as tf\n \n N = 10 * 1024 * 1024\n \n def generate():\n   data = np.random.rand(N)\n   for k in range(N):\n     yield data[k].copy()\n \n graph = tf.Graph()\n with graph.as_default():\n   x = tf.data.Dataset\\\n     .from_generator(generate, tf.float32)\\\n     .make_one_shot_iterator()\\\n     .get_next()\n \n while True:\n   session = tf.Session(graph=graph)\n   session.run(x) # <--- PUT A BREAKPOINT HERE!\n                  #  Be careful running the code without it!\n   session.close()\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "velikodniy", "commentT": "2018-01-16T17:28:40Z", "comment_text": "\n \t\tOf course, if session.run consumes all the elements produced by the generator, it will be removed.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "velikodniy", "commentT": "2018-01-16T22:49:27Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mrry>@mrry</denchmark-link>\n , could you comment on this please?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "velikodniy", "commentT": "2018-02-06T07:36:15Z", "comment_text": "\n \t\tNagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "velikodniy", "commentT": "2018-02-07T22:46:27Z", "comment_text": "\n \t\tYes, this is a bug. I have a fix in preparation.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "velikodniy", "commentT": "2018-02-22T13:07:34Z", "comment_text": "\n \t\tNagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "velikodniy", "commentT": "2018-02-22T15:34:37Z", "comment_text": "\n \t\tThe fix has been submitted internally, but not yet merged into the Git master branch. It should be coming in the next push!\n \t\t"}}}, "commit": {"commit_id": "be862d5b91e9b9044f4e028dcdae0b6ad283e8b4", "commit_author": "Derek Murray", "commitT": "2018-02-20 14:18:09-08:00", "commit_complexity": {"commit_NLOC": "0.3536231884057971", "commit_CCN": "0.9043478260869565", "commit_Nprams": "0.8"}, "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_GeneratorDataset.pbtxt", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\kernels\\data\\BUILD", "file_new_name": "tensorflow\\core\\kernels\\data\\BUILD", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "212,213,214,215,216,217,218,219,220,221,222,223,224,535", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\core\\kernels\\data\\captured_function.cc", "file_new_name": "tensorflow\\core\\kernels\\data\\captured_function.cc", "file_complexity": {"file_NLOC": "285", "file_CCN": "44", "file_NToken": "2101"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "259,260,261,262,263,264,265,266,267", "deleted_lines": null, "method_info": {"method_name": "tensorflow::CapturedFunction::Instantiate", "method_params": "ctx", "method_startline": "259", "method_endline": "267", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "56", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313", "deleted_lines": null, "method_info": {"method_name": "tensorflow::CapturedFunction::RunInstantiated", "method_params": "args,rets", "method_startline": "269", "method_endline": "313", "method_complexity": {"method_NLOC": "36", "method_CCN": "2", "method_NToken": "243", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\kernels\\data\\captured_function.h", "file_new_name": "tensorflow\\core\\kernels\\data\\captured_function.h", "file_complexity": {"file_NLOC": "49", "file_CCN": "2", "file_NToken": "319"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,117", "deleted_lines": null}}}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\kernels\\data\\generator_dataset_op.cc", "file_complexity": {"file_NLOC": "153", "file_CCN": "19", "file_NToken": "996"}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\ops\\dataset_ops.cc", "file_new_name": "tensorflow\\core\\ops\\dataset_ops.cc", "file_complexity": {"file_NLOC": "411", "file_CCN": "3", "file_NToken": "2173"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85", "deleted_lines": null}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 10, "file_old_name": "tensorflow\\python\\data\\kernel_tests\\dataset_from_generator_op_test.py", "file_new_name": "tensorflow\\python\\data\\kernel_tests\\dataset_from_generator_op_test.py", "file_complexity": {"file_NLOC": "282", "file_CCN": "51", "file_NToken": "2264"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "338,339", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorDestructorCalled.__next__", "method_params": "self", "method_startline": "338", "method_endline": "339", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "310,311,312,313", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorStopShort.generator", "method_params": "", "method_startline": "310", "method_endline": "313", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "332,333", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorDestructorCalled.__iter__", "method_params": "self", "method_startline": "332", "method_endline": "333", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "3"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "369,370,371", "deleted_lines": null, "method_info": {"method_name": "testGeneratorDatasetFinalizeFunctionCalled.testGeneratorDatasetFinalizeFunctionCalled.finalize_fn.finalize_py_func", "method_params": "", "method_startline": "369", "method_endline": "371", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "3"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "341,342", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorDestructorCalled.__del__", "method_params": "self", "method_startline": "341", "method_endline": "342", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "3"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorDestructorCalled", "method_params": "self", "method_startline": "326", "method_endline": "358", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "130", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "368,369,370,371,372,373", "deleted_lines": null, "method_info": {"method_name": "testGeneratorDatasetFinalizeFunctionCalled.finalize_fn", "method_params": "_", "method_startline": "368", "method_endline": "373", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "2"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorStopShort", "method_params": "self", "method_startline": "308", "method_endline": "324", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "82", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "335,336", "deleted_lines": null, "method_info": {"method_name": "testFromGeneratorDestructorCalled.next", "method_params": "self", "method_startline": "335", "method_endline": "336", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "3"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389", "deleted_lines": null, "method_info": {"method_name": "testGeneratorDatasetFinalizeFunctionCalled", "method_params": "self", "method_startline": "360", "method_endline": "389", "method_complexity": {"method_NLOC": "17", "method_CCN": "1", "method_NToken": "132", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 19, "file_old_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_new_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_complexity": {"file_NLOC": "1072", "file_CCN": "254", "file_NToken": "7692"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1051,1052,1053,1054,1055,1056,1057,1058,1059,1060,1061,1062,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,1117,1118,1119,1120,1121,1122,1123,1124,1125,1126,1127,1128,1129,1130,1131,1132,1133,1134,1135,1136,1137,1138,1139,1140,1141,1142,1143,1144,1145,1146,1147,1148,1149,1150,1151,1152,1153,1154,1155,1156,1157,1158,1159,1160,1161,1162,1163,1164,1165,1166,1167,1168,1169,1170,1171,1172,1173,1174,1175,1176,1177,1178,1179,1180,1181,1182,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192,1193,1194,1195,1196,1197,1198,1199,1200,1201,1202,1203,1204,1205,1206,1207,1208,1209,1210", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,init_args,init_func,next_func,finalize_func", "method_startline": "1051", "method_endline": "1210", "method_complexity": {"method_NLOC": "29", "method_CCN": "3", "method_NToken": "240", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1192,1193,1194,1195,1196,1197,1198,1199,1200,1201,1202,1203,1204,1205,1206,1207", "deleted_lines": null, "method_info": {"method_name": "__init__.tf_finalize_func", "method_params": "args", "method_startline": "1192", "method_endline": "1207", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "95", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "409,410,411,412,413,414,415,416,417,418,419,420,421,422", "deleted_lines": "413,414,415,416,417,418,419,421", "method_info": {"method_name": "from_generator.finalize_fn", "method_params": "iterator_id_t", "method_startline": "409", "method_endline": "422", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1230,1231", "deleted_lines": null, "method_info": {"method_name": "output_shapes", "method_params": "self", "method_startline": "1230", "method_endline": "1231", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "366,367,368", "deleted_lines": "366,367,368,369,370", "method_info": {"method_name": "from_generator.from_generator.generator_next_fn.generator_py_func", "method_params": "iterator_id", "method_startline": "364", "method_endline": "396", "method_complexity": {"method_NLOC": "19", "method_CCN": "5", "method_NToken": "123", "method_nesting_level": "3"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "334,337", "deleted_lines": "334,337", "method_info": {"method_name": "from_generator.get_iterator_id_map_fn", "method_params": "unused_dummy", "method_startline": "334", "method_endline": "348", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "26", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "350,366,367,368", "deleted_lines": "350,366,367,368,369,370", "method_info": {"method_name": "from_generator.generator_next_fn", "method_params": "iterator_id_t", "method_startline": "350", "method_endline": "407", "method_complexity": {"method_NLOC": "8", "method_CCN": "3", "method_NToken": "59", "method_nesting_level": "2"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "426,427,428,429,430,432,433", "deleted_lines": "429", "method_info": {"method_name": "from_generator.flat_map_fn", "method_params": "dummy_arg", "method_startline": "426", "method_endline": "433", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "16", "method_nesting_level": "2"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "1138,1139,1140,1141,1142,1143,1144,1145,1146,1147,1148,1149,1150,1151,1152,1153,1154,1155,1156,1157,1158,1159,1160,1161,1162,1163,1164,1165,1166,1167,1168,1169,1170,1171,1172,1173,1174,1175,1176,1177,1178,1179,1180,1181,1182,1183,1184,1185", "deleted_lines": null, "method_info": {"method_name": "__init__.tf_next_func", "method_params": "args", "method_startline": "1138", "method_endline": "1185", "method_complexity": {"method_NLOC": "29", "method_CCN": "9", "method_NToken": "248", "method_nesting_level": "2"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "1212,1213,1214,1215,1216,1217,1218,1219,1220,1221,1222,1223", "deleted_lines": null, "method_info": {"method_name": "_as_variant_tensor", "method_params": "self", "method_startline": "1212", "method_endline": "1223", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "95", "method_nesting_level": "1"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "366,367,368", "deleted_lines": "366,367,368,369,370", "method_info": {"method_name": "from_generator.from_generator.generator_map_fn.generator_py_func", "method_params": "iterator_id", "method_startline": "364", "method_endline": "398", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "139", "method_nesting_level": "3"}}}, "hunk_11": {"Ismethod": 1, "added_lines": "1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,1117,1118,1119,1120,1121,1122,1123,1124,1125,1126", "deleted_lines": null, "method_info": {"method_name": "__init__.tf_init_func", "method_params": "args", "method_startline": "1082", "method_endline": "1126", "method_complexity": {"method_NLOC": "27", "method_CCN": "9", "method_NToken": "236", "method_nesting_level": "2"}}}, "hunk_12": {"Ismethod": 1, "added_lines": "334,337,350,366,367,368,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,426,427,428,429,430,432,433,441", "deleted_lines": "334,337,350,366,367,368,369,370,413,414,415,416,417,418,419,421,429", "method_info": {"method_name": "from_generator", "method_params": "generator,output_types,output_shapes", "method_startline": "266", "method_endline": "449", "method_complexity": {"method_NLOC": "19", "method_CCN": "3", "method_NToken": "113", "method_nesting_level": "1"}}}, "hunk_13": {"Ismethod": 1, "added_lines": "1234,1235", "deleted_lines": null, "method_info": {"method_name": "output_types", "method_params": "self", "method_startline": "1234", "method_endline": "1235", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}, "hunk_14": {"Ismethod": 1, "added_lines": "334,337", "deleted_lines": "334,337", "method_info": {"method_name": "from_generator.get_iterator_id_fn", "method_params": "unused_dummy", "method_startline": "334", "method_endline": "348", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "26", "method_nesting_level": "2"}}}, "hunk_15": {"Ismethod": 1, "added_lines": "350,366,367,368,409", "deleted_lines": "350,366,367,368,369,370", "method_info": {"method_name": "from_generator.generator_map_fn", "method_params": "iterator_id_t", "method_startline": "350", "method_endline": "409", "method_complexity": {"method_NLOC": "8", "method_CCN": "3", "method_NToken": "59", "method_nesting_level": "2"}}}, "hunk_16": {"Ismethod": 1, "added_lines": "412,413,414,415,416,417,418,419", "deleted_lines": "413,414,415,416,417,418,419", "method_info": {"method_name": "from_generator.from_generator.finalize_fn.finalize_py_func", "method_params": "iterator_id", "method_startline": "412", "method_endline": "419", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "24", "method_nesting_level": "3"}}}, "hunk_17": {"Ismethod": 1, "added_lines": "413,414,415,416,417,418,419,420,421", "deleted_lines": "413,414,415,416,417,418,419,421", "method_info": {"method_name": "from_generator.flat_map_fn", "method_params": "iterator_id_t", "method_startline": "413", "method_endline": "421", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "2"}}}, "hunk_18": {"Ismethod": 1, "added_lines": "1226,1227", "deleted_lines": null, "method_info": {"method_name": "output_classes", "method_params": "self", "method_startline": "1226", "method_endline": "1227", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}}}}}}