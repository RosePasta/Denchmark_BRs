{"BR": {"BR_id": "30165", "BR_author": "movinghoon", "BRopenT": "2019-06-26T08:01:16Z", "BRcloseT": "2019-07-08T09:55:02Z", "BR_text": {"BRsummary": "TF 2.0 - Put Tensor into some Numpy functions continuously increases memory usage", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 18.04\n TensorFlow installed from (source or binary): pip package tensorflow==2.0.0-beta1\n TensorFlow version (use command below): v2.0.0-beta0-17-g8e423e3 2.0.0-beta1\n Python version: 3.7.3\n CUDA/cuDNN version: 10.0.0/7.3.1\n GPU model and memory: Titan Xp 11Gb\n \n Describe the current behavior\n Memory leak when we put Tensor into some Numpy functions (ex - np.array(), np.zeros_like()). Following attached code continuously increases memory usage.\n Describe the expected behavior\n No memory usage explosion.\n Code to reproduce the issue\n <denchmark-code>import tensorflow as tf\n import numpy as np\n import time\n \n x = tf.random.normal((1024, 1024))\n for i in range(int(1e7)):\n     y = np.array(x)\n     time.sleep(0.01)\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "movinghoon", "commentT": "2019-06-27T12:22:18Z", "comment_text": "\n \t\tI have tried on Colab with TF GPU version 2.0beta1 and was able to reproduce the issue. The code snippet caused crashed in Colab after using all available RAM.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "movinghoon", "commentT": "2019-06-27T22:50:44Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/superbobry>@superbobry</denchmark-link>\n  is this related to the recent  changes?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "movinghoon", "commentT": "2019-06-28T13:50:56Z", "comment_text": "\n \t\tI couldn't reproduce the issue using the nightly when running on CPU. Will be able to try on GPU on Monday.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "movinghoon", "commentT": "2019-07-01T09:10:05Z", "comment_text": "\n \t\tI've reproduced the leak on GPU, fix is on the way.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "movinghoon", "commentT": "2019-07-08T09:55:03Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=30165>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=30165>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "d5b287d6c93332ba73b99b375bd21f81266e3112", "commit_author": "Sergei Lebedev", "commitT": "2019-07-08 02:52:53-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\c\\eager\\c_api.cc", "file_new_name": "tensorflow\\c\\eager\\c_api.cc", "file_complexity": {"file_NLOC": "908", "file_CCN": "188", "file_NToken": "6979"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "592", "deleted_lines": null, "method_info": {"method_name": "TFE_TensorHandleResolve", "method_params": "h,status", "method_startline": "558", "method_endline": "598", "method_complexity": {"method_NLOC": "39", "method_CCN": "9", "method_NToken": "311", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\c\\eager\\c_api_internal.h", "file_new_name": "tensorflow\\c\\eager\\c_api_internal.h", "file_complexity": {"file_NLOC": "230", "file_CCN": "17", "file_NToken": "1295"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "95,96,97,98,99,100,101,102,103", "method_info": {"method_name": "TFE_TensorHandle::CreateLocalHandle", "method_params": "t,d,h", "method_startline": "95", "method_endline": "103", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "65", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "tensorflow\\python\\eager\\pywrap_tensor.cc", "file_new_name": "tensorflow\\python\\eager\\pywrap_tensor.cc", "file_complexity": {"file_NLOC": "819", "file_CCN": "152", "file_NToken": "5092"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "654,655,656,657,658,659,660,661", "deleted_lines": null, "method_info": {"method_name": "EagerTensor_numpy", "method_params": "self", "method_startline": "653", "method_endline": "662", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "76", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "275", "deleted_lines": null, "method_info": {"method_name": "tensorflow::ConvertToEagerTensor", "method_params": "value,dtype", "method_startline": "235", "method_endline": "291", "method_complexity": {"method_NLOC": "52", "method_CCN": "13", "method_NToken": "344", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "80,81,82,87,88,89,90,94,95", "deleted_lines": "79,80,81,82,83,84,88,89,90,91,92,93,94,95,96,97,98,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,121,122", "method_info": {"method_name": "TensorHandleToNumpy", "method_params": "handle", "method_startline": "79", "method_endline": "124", "method_complexity": {"method_NLOC": "31", "method_CCN": "7", "method_NToken": "258", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "80,81,82,87,88,89,90,94,95", "deleted_lines": "80,81,82,83,84,88,89,90,91,92,93,94,95,96", "method_info": {"method_name": "TFE_TensorHandleToNumpy", "method_params": "handle,status", "method_startline": "80", "method_endline": "96", "method_complexity": {"method_NLOC": "16", "method_CCN": "3", "method_NToken": "103", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "746,747,748,751,754", "deleted_lines": null, "method_info": {"method_name": "EagerTensor_getbuffer", "method_params": "self,view,flags", "method_startline": "735", "method_endline": "756", "method_complexity": {"method_NLOC": "18", "method_CCN": "4", "method_NToken": "122", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "59", "deleted_lines": "58", "method_info": {"method_name": "NumpyToTensorHandle", "method_params": "obj", "method_startline": "58", "method_endline": "74", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "103", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "59", "deleted_lines": null, "method_info": {"method_name": "NumpyToTFE_TensorHandle", "method_params": "obj", "method_startline": "59", "method_endline": "75", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "103", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\framework\\ops.py", "file_new_name": "tensorflow\\python\\framework\\ops.py", "file_complexity": {"file_NLOC": "2931", "file_CCN": "750", "file_NToken": "16308"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "763", "deleted_lines": "763", "method_info": {"method_name": "numpy", "method_params": "self", "method_startline": "746", "method_endline": "764", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "44", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\lib\\core\\ndarray_tensor.cc", "file_new_name": "tensorflow\\python\\lib\\core\\ndarray_tensor.cc", "file_complexity": {"file_NLOC": "442", "file_CCN": "94", "file_NToken": "3192"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417", "deleted_lines": null, "method_info": {"method_name": "tensorflow::TF_TensorToMaybeAliasedPyArray", "method_params": "tensor,out_ndarray", "method_startline": "402", "method_endline": "417", "method_complexity": {"method_NLOC": "15", "method_CCN": "3", "method_NToken": "124", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\lib\\core\\ndarray_tensor.h", "file_new_name": "tensorflow\\python\\lib\\core\\ndarray_tensor.h", "file_complexity": {"file_NLOC": "13", "file_CCN": "0", "file_NToken": "73"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29,30,31", "deleted_lines": null}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\lib\\core\\py_func.cc", "file_new_name": "tensorflow\\python\\lib\\core\\py_func.cc", "file_complexity": {"file_NLOC": "264", "file_CCN": "52", "file_NToken": "1757"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "173,176,177,178,179,180,181,182,183,184", "deleted_lines": "175", "method_info": {"method_name": "tensorflow::DoCallPyFunc", "method_params": "call,out_log_on_error", "method_startline": "166", "method_endline": "266", "method_complexity": {"method_NLOC": "86", "method_CCN": "23", "method_NToken": "597", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "75,85,87,88", "deleted_lines": "75,85,87,88", "method_info": {"method_name": "tensorflow::MakeArgTuple", "method_params": "call,tuple", "method_startline": "75", "method_endline": "108", "method_complexity": {"method_NLOC": "33", "method_CCN": "7", "method_NToken": "258", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "75,85,87,88", "deleted_lines": "75,85,87,88", "method_info": {"method_name": "tensorflow::MakeArgTuple", "method_params": "call,ctx,tuple", "method_startline": "75", "method_endline": "108", "method_complexity": {"method_NLOC": "33", "method_CCN": "7", "method_NToken": "268", "method_nesting_level": "2"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\ops\\script_ops.py", "file_new_name": "tensorflow\\python\\ops\\script_ops.py", "file_complexity": {"file_NLOC": "197", "file_CCN": "43", "file_NToken": "1385"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "67", "method_info": {"method_name": "__init__", "method_params": "self,func,Tout,is_grad_func", "method_startline": "53", "method_endline": "67", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "142,143,144,145,146", "deleted_lines": null, "method_info": {"method_name": "_ctx", "method_params": "self", "method_startline": "142", "method_endline": "146", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}}}}}}