{"BR": {"BR_id": "13536", "BR_author": "bdaskalov", "BRopenT": "2017-10-06T20:53:52Z", "BRcloseT": "2017-10-18T05:45:06Z", "BR_text": {"BRsummary": "BeamSearchDecoder incorrectly truncates results when used with dynamic_decode", "BRdescription": "\n <denchmark-h:h3>System information (irrelevant for this bug)</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04/Any\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): v1.3.0-rc2-20-g0787eee 1.3.0\n Python version: Python 3.5.2 :: Continuum Analytics, Inc.\n Bazel version (if compiling from source): N/A\n CUDA/cuDNN version: irrelevant\n GPU model and memory: irrelevant\n Exact command to reproduce: irrelevant\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n tf.contrib.seq2seq.BeamSearchDecoder incorrectly truncates some of the results because the same index was previously used for a beam member that ended at a earlier step.\n The root of the problem is that the while_loop body in dynamic_decode assumes that sequences are independent and will finish only once. In the same time BeamSearchDecoder creates a tree-like structure where a beam index can be reused in a later step for a state that originates from a different parent index.  This causes the decoding loop to sometimes record the wrong sequence length for a beam member. Then this wrong sequence length is passed to BeamSearchDecoder.finalize which returns a truncated sequence.\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n I use the following code to workaround the problem. This causes the right sequence to be returned but still the length returned by dynamic_decode is wrong.\n class FixedBeamSearchDecoder(seq2seq.BeamSearchDecoder):\n     def finalize(self, outputs, final_state, sequence_lengths):\n         # BeamSearchDecoder does not follow the correct semantics of the the finished flag\n         # which results in taking wrong length here and getting wrong decoded string.\n         # We substitute the sequence length recorded by dynamic_decoder (which is wrong because\n         # of the wrong finished flag returned by BeamSearchDecoder.step) with the length\n         # recorded in BeamSearchState which is correct.\n         return super().finalize(outputs, final_state, final_state.lengths)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "bdaskalov", "commentT": "2017-10-06T20:55:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ebrevdo>@ebrevdo</denchmark-link>\n  Can you take a look? I see that you wrote the seq2seq library. I wanted to submit a fix but I don't see how to correct this problem without changing some of the library's public inteface.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "bdaskalov", "commentT": "2017-10-06T21:47:37Z", "comment_text": "\n \t\tSeems ok to update the BeamSearchDecoder.finalize to use final_state.lengths instead of sequence_lengths -- looks like this fixes a couple of other open issues.\n We could consider having finalize return new updated sequence lengths to decode_dynamic as well.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "bdaskalov", "commentT": "2017-10-06T21:48:02Z", "comment_text": "\n \t\tThanks for catching this!  Could you send a PR with the fix and a unit test that catches it?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "bdaskalov", "commentT": "2017-10-13T17:14:14Z", "comment_text": "\n \t\tWill look into submitting a fix.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "bdaskalov", "commentT": "2017-10-15T02:17:02Z", "comment_text": "\n \t\tSorry, I've been meaning to make a PR last week but never got to it.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "bdaskalov", "commentT": "2017-10-15T02:19:07Z", "comment_text": "\n \t\tNo problem. We're evaluating your change internally.\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Sat, Oct 14, 2017, 7:17 PM bdaskalov ***@***.***> wrote:\n  Sorry, I've been meaning to make a PR last week but never got to it.\n \n  \u2014\n  You are receiving this because you were assigned.\n  Reply to this email directly, view it on GitHub\n  <#13536 (comment)>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/ABtimxRoy93pElky6ZtzF-ctLOu6Khocks5ssWs8gaJpZM4PxBUM>\n  .\n \n \n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "bdaskalov", "commentT": "2017-10-16T19:26:44Z", "comment_text": "\n \t\tThe problem is deeper and the solution requires some additional changes.  I'll try to submit something in the next couple days.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "bdaskalov", "commentT": "2018-04-30T03:37:35Z", "comment_text": "\n \t\tCould anyone tell me when this bug was fixed. I couldn't find it in the release notes. Thank you! <denchmark-link:https://github.com/ebrevdo>@ebrevdo</denchmark-link>\n \n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "bdaskalov", "commentT": "2018-04-30T15:21:24Z", "comment_text": "\n \t\tIt was first released in TensorFlow 1.5.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "bdaskalov", "commentT": "2018-04-30T17:16:08Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/guillaumekln>@guillaumekln</denchmark-link>\n  Thank you for the info!\n \t\t"}}}, "commit": {"commit_id": "18f89c81d288f191abd56501ec6f86fe29265bdd", "commit_author": "Eugene Brevdo", "commitT": "2017-10-17 08:56:25-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops.cc", "file_new_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops.cc", "file_complexity": {"file_NLOC": "128", "file_CCN": "11", "file_NToken": "975"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "108,109,110,111,112,113,114,117,118,122,123,124,127,128,129,130,141,142,143,144", "deleted_lines": "102,103,104,105,106,107,108,111,115,116,119,120,121,122,140", "method_info": {"method_name": "tensorflow::functor::GatherTree<CPUDevice,int32>::operator ( )", "method_params": "ctx,d,step_ids,parent_ids,sequence_length,beams", "method_startline": "101", "method_endline": "144", "method_complexity": {"method_NLOC": "41", "method_CCN": "6", "method_NToken": "373", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "108,109,110,111,112,113,114,117,118,122,123,124,127,128,129,130,141,142,143,144,145,146,147,148,156", "deleted_lines": "107,108,111,115,116,119,120,121,122,140,151,152,153,154,155,156,157,158", "method_info": {"method_name": "tensorflow::functor::GatherTree<CPUDevice,int32>::operator ( )", "method_params": "ctx,d,step_ids,parent_ids,max_sequence_lengths,end_token,beams", "method_startline": "107", "method_endline": "160", "method_complexity": {"method_NLOC": "51", "method_CCN": "9", "method_NToken": "444", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "52,53,59,61,62,63,64,65,66,73,74,75,76,77,78,79,80,85,86,87,89,91", "deleted_lines": "52,58,59,60,61,62,63,64,65,66,67,69,70,71,82,85", "method_info": {"method_name": "tensorflow::GatherTreeOp::Compute", "method_params": "ctx", "method_startline": "48", "method_endline": "92", "method_complexity": {"method_NLOC": "45", "method_CCN": "1", "method_NToken": "419", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops.h", "file_new_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops.h", "file_complexity": {"file_NLOC": "17", "file_CCN": "0", "file_NToken": "92"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "34,35", "deleted_lines": "34,35"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops_gpu.cu.cc", "file_new_name": "tensorflow\\contrib\\seq2seq\\kernels\\beam_search_ops_gpu.cu.cc", "file_complexity": {"file_NLOC": "69", "file_CCN": "9", "file_NToken": "509"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32,33,38,39,40,41,42,46,49", "deleted_lines": "32,37,38,42,45", "method_info": {"method_name": "tensorflow::functor::GatherTreeOpKernel", "method_params": "batch_size,max_time,beam_width,step_ids,parent_ids,sequence_length,beams", "method_startline": "29", "method_endline": "58", "method_complexity": {"method_NLOC": "25", "method_CCN": "5", "method_NToken": "208", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "62,63,64,65,66,67,68,78,79", "deleted_lines": "65,66,78", "method_info": {"method_name": "tensorflow::functor::GatherTree<GPUDevice,T>::operator ( )", "method_params": "ctx,d,step_ids,parent_ids,sequence_length,beams", "method_startline": "62", "method_endline": "81", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "177", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "78,79,91,92,93,94", "deleted_lines": "78", "method_info": {"method_name": "tensorflow::functor::GatherTree<GPUDevice,T>::operator ( )", "method_params": "ctx,d,step_ids,parent_ids,max_sequence_length,end_token,beams", "method_startline": "75", "method_endline": "97", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "182", "method_nesting_level": "3"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "32,33,38,39,40,41,42,46,49,60,61,62,63,64,65,66,67,68", "deleted_lines": "32,37,38,42,45,65,66", "method_info": {"method_name": "tensorflow::functor::GatherTreeOpKernel", "method_params": "batch_size,max_time,beam_width,step_ids,parent_ids,max_sequence_lengths,end_token,beams", "method_startline": "29", "method_endline": "71", "method_complexity": {"method_NLOC": "38", "method_CCN": "8", "method_NToken": "281", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\contrib\\seq2seq\\ops\\beam_search_ops.cc", "file_new_name": "tensorflow\\contrib\\seq2seq\\ops\\beam_search_ops.cc", "file_complexity": {"file_NLOC": "45", "file_CCN": "0", "file_NToken": "270"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "28,29,33,37,40,41,43,45,46,47,48,64,65", "deleted_lines": "28,32,36,39,40,41,42,43,46,47,48,64"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\contrib\\seq2seq\\python\\kernel_tests\\beam_search_decoder_test.py", "file_new_name": "tensorflow\\contrib\\seq2seq\\python\\kernel_tests\\beam_search_decoder_test.py", "file_complexity": {"file_NLOC": "263", "file_CCN": "13", "file_NToken": "2660"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57,58,65,66,67,68", "deleted_lines": "57,58,65", "method_info": {"method_name": "test_gather_tree", "method_params": "self", "method_startline": "44", "method_endline": "73", "method_complexity": {"method_NLOC": "21", "method_CCN": "1", "method_NToken": "280", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tensorflow\\contrib\\seq2seq\\python\\kernel_tests\\beam_search_ops_test.py", "file_new_name": "tensorflow\\contrib\\seq2seq\\python\\kernel_tests\\beam_search_ops_test.py", "file_complexity": {"file_NLOC": "96", "file_CCN": "10", "file_NToken": "969"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "43,47,48,49,50", "deleted_lines": "41,45,46", "method_info": {"method_name": "testGatherTreeOne", "method_params": "self", "method_startline": "37", "method_endline": "52", "method_complexity": {"method_NLOC": "15", "method_CCN": "1", "method_NToken": "183", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "84,89,90,91,92", "deleted_lines": "78,83,84,89,90,93,94", "method_info": {"method_name": "testBadParentValuesOnGPU", "method_params": "self", "method_startline": "73", "method_endline": "94", "method_complexity": {"method_NLOC": "18", "method_CCN": "2", "method_NToken": "205", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "61,64,65,66,67", "deleted_lines": "57,60,61", "method_info": {"method_name": "testBadParentValuesOnCPU", "method_params": "self", "method_startline": "54", "method_endline": "71", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "150", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "97,98,99,100,101,104,105,106,107,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135", "deleted_lines": "96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135", "method_info": {"method_name": "testGatherTreeBatch", "method_params": "self", "method_startline": "96", "method_endline": "135", "method_complexity": {"method_NLOC": "33", "method_CCN": "5", "method_NToken": "334", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\contrib\\seq2seq\\python\\ops\\beam_search_decoder.py", "file_new_name": "tensorflow\\contrib\\seq2seq\\python\\ops\\beam_search_decoder.py", "file_complexity": {"file_NLOC": "426", "file_CCN": "37", "file_NToken": "2816"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "320,321,324,326,328,329,330,331,333,334,335,336", "deleted_lines": "313,314", "method_info": {"method_name": "finalize", "method_params": "self,outputs,final_state,sequence_lengths", "method_startline": "311", "method_endline": "339", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "73", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "257,258,259,260,261,262,263,264,265,266,267,268", "deleted_lines": null, "method_info": {"method_name": "tracks_own_finished", "method_params": "self", "method_startline": "257", "method_endline": "268", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\contrib\\seq2seq\\python\\ops\\decoder.py", "file_new_name": "tensorflow\\contrib\\seq2seq\\python\\ops\\decoder.py", "file_complexity": {"file_NLOC": "173", "file_CCN": "24", "file_NToken": "1075"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "255,256,257,258", "deleted_lines": null, "method_info": {"method_name": "body", "method_params": "time,outputs_ta,state,inputs,finished,sequence_lengths", "method_startline": "237", "method_endline": "299", "method_complexity": {"method_NLOC": "34", "method_CCN": "5", "method_NToken": "234", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "103,104,105,106", "deleted_lines": "103,104,105,106", "method_info": {"method_name": "step", "method_params": "self,time,inputs,state,name", "method_startline": "90", "method_endline": "108", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131", "deleted_lines": null, "method_info": {"method_name": "tracks_own_finished", "method_params": "self", "method_startline": "114", "method_endline": "131", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "8", "method_nesting_level": "1"}}}}}}}}