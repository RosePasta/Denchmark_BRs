{"BR": {"BR_id": "35335", "BR_author": "leandro-gracia-gil", "BRopenT": "2019-12-22T01:32:27Z", "BRcloseT": "2020-01-23T18:37:13Z", "BR_text": {"BRsummary": "Dataset scan loses variable modifications", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes, providing source.\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Mac OS 10.15.2, most likely irrelevant.\n TensorFlow installed from (source or binary): binary from pip\n TensorFlow version (use command below): v1.12.1-21171-g9798f84fa9 2.1.0-dev20191221 (installed via pip install tf-nightly==2.1.0dev20191221)\n Python version: 3.7.2\n CUDA/cuDNN version: using CPU only.\n \n Describe the current behavior\n While writing a unit test I created a function that iterates a tf.data.Dataset and accumulates the values in a local variable. This worked fine using eager mode, but then I noticed that the returned result was zero when using tf.function.\n I've produced a small simple code that reproduces the problem. In particular, returning the accumulator variable produces a result of 0, but accessing the variable directly works fine. Also, using tf.print on the accumulator while iterating the dataset shows the correct value, but printing it after the iteration still within the method shows 0, suggesting perhaps some kind of scoping problem.\n Please see the attached source to understand better what I mean.\n Describe the expected behavior\n The result should be the same when using eager mode and tf.function. Also, when using tf.function the result should be the same when returning the variable and when accessing it directly.\n \n <denchmark-link:https://github.com/tensorflow/tensorflow/files/3992032/tf_function_variable.py.txt>tf_function_variable.py.txt</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leandro-gracia-gil", "commentT": "2019-12-23T07:08:39Z", "comment_text": "\n \t\tI could replicate the issue with Tf 2.1.\n Please find the gist <denchmark-link:https://colab.sandbox.google.com/gist/gadagashwini/70fca4acb63107bfdb216b4024f57373/untitled319.ipynb>here</denchmark-link>\n . Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "leandro-gracia-gil", "commentT": "2019-12-24T13:29:27Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/leandro-gracia-gil>@leandro-gracia-gil</denchmark-link>\n  Please use the following workaround until we get this fixed: .\n <denchmark-link:https://github.com/jsimsa>@jsimsa</denchmark-link>\n  it looks like  loses variable updates. Repro below. Note that  alone works, but we need the  addition due to <denchmark-link:https://github.com/tensorflow/tensorflow/issues/32138>#32138</denchmark-link>\n . I'm tempted to drop the use of  altogether and use iterators throughout, since they seem to be more stable.\n <denchmark-code>acc = tf.Variable(0.0, dtype=tf.float32, trainable=False)\n \n @tf.function(autograph=False)\n def sum_dataset(dataset):\n   def body(dummy, t):\n     acc.assign_add(t)\n \n     # Prints the actual value in all cases.\n     tf.print('in loop', acc)\n \n     return (dummy, dummy)\n \n   def reduce_body(_, scan_outputs):\n     return scan_outputs\n \n   tr = tf.data.experimental.scan((tf.constant(0),), body)\n   dataset = dataset.apply(tr)\n   dataset.reduce((tf.constant(0),), reduce_body)\n \n   # Prints 0.0 when tf.function is used, but the actual value in eager mode.\n   tf.print('after loop', acc)\n \n   return acc\n \n records = np.random.uniform(size=(10,)).astype(np.float32)\n dataset = tf.data.Dataset.from_tensor_slices(records)\n result = sum_dataset(dataset)\n \n # Fails when tf.function is used in sum_dataset because result is 0.0.\n assert result.numpy() == acc.numpy()\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "leandro-gracia-gil", "commentT": "2019-12-30T21:44:27Z", "comment_text": "\n \t\tI believe that this is another instance of the \"datasets do not propagate\" control dependencies bug (b/142341957) that and I plan to fix as soon as possible.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "leandro-gracia-gil", "commentT": "2020-01-23T18:37:15Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/35335>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/35335>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "c4ec9389364cb8d1bff451ab8baf55d25cabdd1f", "commit_author": "Jiri Simsa", "commitT": "2020-01-23 10:35:51-08:00", "commit_complexity": {"commit_NLOC": "0.6962025316455697", "commit_CCN": "0.6962025316455697", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tensorflow\\python\\data\\kernel_tests\\iterator_test.py", "file_new_name": "tensorflow\\python\\data\\kernel_tests\\iterator_test.py", "file_complexity": {"file_NLOC": "823", "file_CCN": "99", "file_NToken": "6595"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1002,1003,1004", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.map_fn", "method_params": "x", "method_startline": "1002", "method_endline": "1004", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1006,1007", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.dataset_fn", "method_params": "", "method_startline": "1006", "method_endline": "1007", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "999,1000,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1017", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies", "method_params": "self", "method_startline": "999", "method_endline": "1017", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1010,1011,1012,1013,1014", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.fn", "method_params": "", "method_startline": "1010", "method_endline": "1014", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "28", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "tensorflow\\python\\data\\kernel_tests\\reduce_test.py", "file_new_name": "tensorflow\\python\\data\\kernel_tests\\reduce_test.py", "file_complexity": {"file_NLOC": "197", "file_CCN": "46", "file_NToken": "1828"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "170", "deleted_lines": "170", "method_info": {"method_name": "testSideEffect", "method_params": "self", "method_startline": "160", "method_endline": "177", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "60", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "208,209,210", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.map_fn", "method_params": "x", "method_startline": "208", "method_endline": "210", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "150", "deleted_lines": "150", "method_info": {"method_name": "testDatasetSideEffect", "method_params": "self", "method_startline": "137", "method_endline": "157", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "62", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies", "method_params": "self", "method_startline": "205", "method_endline": "222", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "194", "deleted_lines": "194", "method_info": {"method_name": "testAutomaticControlDependencies", "method_params": "self", "method_startline": "180", "method_endline": "202", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "62", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "212,213", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.dataset_fn", "method_params": "", "method_startline": "212", "method_endline": "213", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "2"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "216,217,218,219", "deleted_lines": null, "method_info": {"method_name": "testNestedAutomaticControlDependencies.fn", "method_params": "", "method_startline": "216", "method_endline": "219", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "14", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_new_name": "tensorflow\\python\\data\\ops\\dataset_ops.py", "file_complexity": {"file_NLOC": "2156", "file_CCN": "402", "file_NToken": "13220"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "4325,4326,4327,4328,4329,4330,4331,4332,4333,4334,4335,4336,4337,4338,4339", "deleted_lines": null, "method_info": {"method_name": "_collect_resource_inputs._process", "method_params": "op_queue,seen_ops", "method_startline": "4325", "method_endline": "4339", "method_complexity": {"method_NLOC": "12", "method_CCN": "5", "method_NToken": "73", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "4351,4352,4353,4354,4355,4356,4357,4358,4359,4360,4361,4362,4363,4364,4365,4366,4367,4368,4369,4370,4371,4372,4373,4374,4375,4376,4377,4378,4379", "deleted_lines": null, "method_info": {"method_name": "_resource_resolver", "method_params": "op,resource_inputs", "method_startline": "4351", "method_endline": "4379", "method_complexity": {"method_NLOC": "24", "method_CCN": "10", "method_NToken": "129", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "4322,4323,4324,4325,4326,4327,4328,4329,4330,4331,4332,4333,4334,4335,4336,4337,4338,4339,4340,4341,4342,4343,4344,4345,4346,4347", "deleted_lines": null, "method_info": {"method_name": "_collect_resource_inputs", "method_params": "op", "method_startline": "4322", "method_endline": "4347", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "38", "method_nesting_level": "0"}}}}}}}}