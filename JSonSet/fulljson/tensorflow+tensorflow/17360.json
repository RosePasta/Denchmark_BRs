{"BR": {"BR_id": "17360", "BR_author": "kbsriram", "BRopenT": "2018-03-01T16:26:37Z", "BRcloseT": "2018-03-07T01:17:02Z", "BR_text": {"BRsummary": "C++ api: use of op::Attrs methods in gradients", "BRdescription": "\n The generated op::Attrs struct returns new instances on its chainable methods, and doesn't change the original object.\n \n \n \n tensorflow/tensorflow/cc/framework/cc_op_gen.cc\n \n \n          Line 701\n       in\n       d7d7f4e\n \n \n \n \n \n \n  strings::StrAppend(&setters, \"      Attrs ret = *this;\\n\"); \n \n \n \n \n \n There are a few related issues e.g. \n \n \n tensorflow/tensorflow/cc/gradients/nn_grad.cc\n \n \n          Line 164\n       in\n       6fdb9ad\n \n \n \n \n \n \n  grad_attrs.DataFormat(data_format); \n \n \n \n \n  where the code assumes the underlying object is being mutated and the parameters don't actually pass through.\n I guess there might be a couple of ways forward, depending on how Tensorflow prefers the C++ API:\n \n Decide the Attrs chaining methods mutate the underlying object and fix the code generation.\n Decide the Attrs chaining methods return new instances, and fix the uses.\n \n Suggestions?\n Fwiw if option 2, it might be nice to add TF_MUST_USE_RESULT to the generated API. (Unfortunately a <denchmark-link:https://gcc.gnu.org/bugzilla/show_bug.cgi?id=38172>long-standing bug in gcc</denchmark-link>\n  means this may be unreliable as an actual error across versions of gcc that contributors may use.)\n /cc <denchmark-link:https://github.com/suharshs>@suharshs</denchmark-link>\n  <denchmark-link:https://github.com/keveman>@keveman</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "kbsriram", "commentT": "2018-03-01T16:44:30Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kbsriram>@kbsriram</denchmark-link>\n  thanks for pointing out the bug. I am not a fan of mutable state, so my natural inclination is towards option 2. Adding  to the generated API would simply point out the existing erroneous uses as compiler errors.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "kbsriram", "commentT": "2018-03-01T20:25:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/keveman>@keveman</denchmark-link>\n  thanks for the note! Sgtm - don't have a strong opinion on this. But would like to make progress on fixes and (for option 2 as you note) add a bit of a compile-time safety net for new code.\n Tentatively predicated on option 2, suggestions on next steps? If someone is already on it, awesome - otherwise, I can sign up for a pull request on this.\n \t\t"}}}, "commit": {"commit_id": "5279cf29cea96b3ec50df506bb51d8ffabdabac9", "commit_author": "A. Unique TensorFlower", "commitT": "2018-03-05 14:49:23-08:00", "commit_complexity": {"commit_NLOC": "0.8", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\cc\\framework\\cc_op_gen.cc", "file_new_name": "tensorflow\\cc\\framework\\cc_op_gen.cc", "file_complexity": {"file_NLOC": "952", "file_CCN": "198", "file_NToken": "7084"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "700,701", "deleted_lines": "700", "method_info": {"method_name": "tensorflow::OpInfo::GetOpAttrStruct", "method_params": "", "method_startline": "667", "method_endline": "726", "method_complexity": {"method_NLOC": "51", "method_CCN": "10", "method_NToken": "418", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tensorflow\\cc\\gradients\\nn_grad.cc", "file_new_name": "tensorflow\\cc\\gradients\\nn_grad.cc", "file_complexity": {"file_NLOC": "156", "file_CCN": "12", "file_NToken": "1465"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "112,113", "deleted_lines": "110,113,114", "method_info": {"method_name": "tensorflow::ops::BiasAddGradHelper", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "106", "method_endline": "117", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "111", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "187,188", "deleted_lines": "185,186,187,188,189,190,191", "method_info": {"method_name": "tensorflow::ops::LRNGradHelper", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "185", "method_endline": "191", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "76", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "51,52", "deleted_lines": "51,52", "method_info": {"method_name": "tensorflow::ops::LogSoftmaxGrad", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "50", "method_endline": "59", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "113", "method_nesting_level": "3"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "175,176,177", "deleted_lines": "167,168,169", "method_info": {"method_name": "tensorflow::ops::MaxPoolGradV2Helper", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "167", "method_endline": "182", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "165", "method_nesting_level": "3"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "132,133,134,135,137,138,139,140,141", "deleted_lines": "133,134,135,136,137,138,140,141,142,143,144", "method_info": {"method_name": "tensorflow::ops::Conv2DGrad", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "120", "method_endline": "144", "method_complexity": {"method_NLOC": "25", "method_CCN": "1", "method_NToken": "237", "method_nesting_level": "3"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "159,160,161", "deleted_lines": "163,164", "method_info": {"method_name": "tensorflow::ops::MaxPoolGradHelper", "method_params": "scope,op,grad_inputs,grad_outputs", "method_startline": "147", "method_endline": "164", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "183", "method_nesting_level": "3"}}}}}}}}