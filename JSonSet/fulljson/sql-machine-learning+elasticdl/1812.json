{"BR": {"BR_id": "1812", "BR_author": "skydoorkai", "BRopenT": "2020-03-10T10:47:04Z", "BRcloseT": "2020-03-11T03:32:27Z", "BR_text": {"BRsummary": "GO PS crashes when saving checkpoint", "BRdescription": "\n <denchmark-code>2020/03/10 10:10:13 PS service started at  11.235.160.158:2222\n fatal error: concurrent map iteration and map write\n \n goroutine 67282 [running]:\n runtime.throw(0x95dd2d, 0x26)\n     /usr/local/go/src/runtime/panic.go:774 +0x72 fp=0xc00064d5e0 sp=0xc00064d5b0 pc=0x42f6e2\n runtime.mapiternext(0xc00064d6f0)\n     /usr/local/go/src/runtime/map.go:858 +0x579 fp=0xc00064d668 sp=0xc00064d5e0 pc=0x410c69\n elasticdl.org/elasticdl/common.(*EmbeddingTable).ToIndexedSlices(0xc000130fc0, 0xc00018e4b0)\n     /root/elasticdl/common/embedding_table.go:69 +0xfc fp=0xc00064d760 sp=0xc00064d668 pc=0x82166c\n elasticdl.org/elasticdl/ps.(*Model).SaveToModelPB(0xc000104ca0, 0x17)\n     /root/elasticdl/ps/model.go:86 +0x235 fp=0xc00064d908 sp=0xc00064d760 pc=0x8289d5\n elasticdl.org/elasticdl/ps.SaveModelToCheckpoint(0xc0002910c0, 0x3a, 0xc000104ca0, 0x1, 0x3)\n     /root/elasticdl/ps/checkpoint.go:125 +0x119 fp=0xc00064d9b0 sp=0xc00064d908 pc=0x827e99\n elasticdl.org/elasticdl/ps.(*Server).saveCheckpointIfNeeded(0xc0000f7b80, 0x55f0)\n     /root/elasticdl/ps/server.go:118 +0x1ca fp=0xc00064da48 sp=0xc00064d9b0 pc=0x82bcaa\n elasticdl.org/elasticdl/ps.(*Server).PushGradients(0xc0000f7b80, 0x9fda40, 0xc001532a80, 0xc000116eb0, 0xc0000f7b80, 0xc001532a80, 0xc000381b30)\n     /root/elasticdl/ps/server.go:174 +0x10c fp=0xc00064dad0 sp=0xc00064da48 pc=0x82c34c\n elasticdl.org/elasticdl/proto._Pserver_PushGradients_Handler(0x901780, 0xc0000f7b80, 0x9fda40, 0xc001532a80, 0xc0014e11a0, 0x0, 0x9fda40, 0xc001532a80, 0xc0028f8000, 0x775fa)\n     /root/elasticdl/proto/elasticdl.pb.go:1253 +0x217 fp=0xc00064db40 sp=0xc00064dad0 pc=0x820367\n google.golang.org/grpc.(*Server).processUnaryRPC(0xc0000df080, 0xa01dc0, 0xc00025e480, 0xc00022e500, 0xc00018eb10, 0xeea280, 0x0, 0x0, 0x0)\n     /root/go/pkg/mod/google.golang.org/grpc@v1.27.1/server.go:1024 +0x4f4 fp=0xc00064de18 sp=0xc00064db40 pc=0x804b34\n google.golang.org/grpc.(*Server).handleStream(0xc0000df080, 0xa01dc0, 0xc00025e480, 0xc00022e500, 0x0)\n     /root/go/pkg/mod/google.golang.org/grpc@v1.27.1/server.go:1313 +0xd97 fp=0xc00064df48 sp=0xc00064de18 pc=0x808857\n google.golang.org/grpc.(*Server).serveStreams.func1.1(0xc00002c1e4, 0xc0000df080, 0xa01dc0, 0xc00025e480, 0xc00022e500)\n     /root/go/pkg/mod/google.golang.org/grpc@v1.27.1/server.go:722 +0xbb fp=0xc00064dfb8 sp=0xc00064df48 pc=0x81590b\n runtime.goexit()\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "skydoorkai", "commentT": "2020-03-10T11:45:00Z", "comment_text": "\n \t\tNeed an RWLock for EmbeddingTables iteration in SaveToModelPB.\n \t\t"}}}, "commit": {"commit_id": "dad85b110a6914ae74b44eea4bf72d79050bf409", "commit_author": "QI JUN", "commitT": "2020-03-11 11:32:26+08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "elasticdl\\pkg\\common\\embedding_table.go", "file_new_name": "elasticdl\\pkg\\common\\embedding_table.go", "file_complexity": {"file_NLOC": "61", "file_CCN": "10", "file_NToken": "403"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "68,73", "deleted_lines": null, "method_info": {"method_name": "ToIndexedSlices", "method_params": "", "method_startline": "67", "method_endline": "75", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "73", "method_nesting_level": "0"}}}}}}}}