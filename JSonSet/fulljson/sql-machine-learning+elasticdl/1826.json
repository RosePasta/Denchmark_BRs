{"BR": {"BR_id": "1826", "BR_author": "skydoorkai", "BRopenT": "2020-03-12T14:07:07Z", "BRcloseT": "2020-03-13T05:39:37Z", "BR_text": {"BRsummary": "Worker pod crashes when Go PS is used", "BRdescription": "\n <denchmark-code>[2020-03-12 08:55:32,559] [INFO] [model_handler.py:312:_clone_function] Replace embedding layer with elasticdl.layers.Embedding\n Traceback (most recent call last):\n   File \"/usr/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"/usr/lib/python3.6/runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"/elasticdl/elasticdl/python/worker/main.py\", line 44, in <module>\n     main()\n   File \"/elasticdl/elasticdl/python/worker/main.py\", line 40, in main\n     worker.run()\n   File \"/elasticdl/elasticdl/python/worker/worker.py\", line 1143, in run\n     self._train_and_evaluate()\n   File \"/elasticdl/elasticdl/python/worker/worker.py\", line 1085, in _train_and_evaluate\n     self._process_train_end_callback_task_if_needed()\n   File \"/elasticdl/elasticdl/python/worker/worker.py\", line 968, in _process_train_end_callback_task_if_needed\n     self._callbacks_list.on_train_end()\n   File \"/usr/local/lib/python3.6/dist-packages/tensorflow_core/python/keras/callbacks.py\", line 379, in on_train_end\n     callback.on_train_end(logs)\n   File \"/elasticdl/elasticdl/python/elasticdl/callbacks.py\", line 46, in on_train_end\n     self.model, dataset\n   File \"/elasticdl/elasticdl/python/common/model_handler.py\", line 227, in get_model_to_export\n     trained_params = _get_trained_params_from_checkpoint(checkpoint_dir)\n   File \"/elasticdl/elasticdl/python/common/model_handler.py\", line 21, in _get_trained_params_from_checkpoint\n     checkpoint_dir, 0, 1\n   File \"/elasticdl/elasticdl/python/common/save_utils.py\", line 240, in restore_params_from_checkpoint\n     \"The versions in model shards are not consistency\"\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "skydoorkai", "commentT": "2020-03-13T02:57:25Z", "comment_text": "\n \t\tI find the root cause:\n In python PS:\n \n \n \n elasticdl/elasticdl/python/ps/servicer.py\n \n \n         Lines 142 to 145\n       in\n       be22bb5\n \n \n \n \n \n \n  with self._version_lock: \n \n \n \n  self._parameters.version += 1 \n \n \n \n  self._save_params_to_checkpoint_if_needed() \n \n \n \n  version = self._parameters.version \n \n \n \n \n \n save checkpoint is protected by the verson lock.\n In Go PS:\n \n \n \n elasticdl/elasticdl/pkg/ps/server.go\n \n \n         Lines 182 to 186\n       in\n       be22bb5\n \n \n \n \n \n \n  s.versionLock.Lock() \n \n \n \n  s.Model.Version += int32(1) \n \n \n \n  s.versionLock.Unlock() \n \n \n \n  s.reportModelVersionIfNeeded(int(s.Model.Version)) \n \n \n \n  s.saveCheckpointIfNeeded(int(s.Model.Version)) \n \n \n \n \n \n save checkpoint is not protected by the version lock.\n So the checkpoint version saved by Go PS is not consistent strictly.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "skydoorkai", "commentT": "2020-03-13T03:30:56Z", "comment_text": "\n \t\t\n I find the root cause:\n In python PS:\n \n \n \n elasticdl/elasticdl/python/ps/servicer.py\n \n \n         Lines 142 to 145\n       in\n       be22bb5\n \n \n \n \n \n \n  with self._version_lock: \n \n \n \n  self._parameters.version += 1 \n \n \n \n  self._save_params_to_checkpoint_if_needed() \n \n \n \n  version = self._parameters.version \n \n \n \n \n \n save checkpoint is protected by the verson lock.\n In Go PS:\n \n \n \n elasticdl/elasticdl/pkg/ps/server.go\n \n \n         Lines 182 to 186\n       in\n       be22bb5\n \n \n \n \n \n \n  s.versionLock.Lock() \n \n \n \n  s.Model.Version += int32(1) \n \n \n \n  s.versionLock.Unlock() \n \n \n \n  s.reportModelVersionIfNeeded(int(s.Model.Version)) \n \n \n \n  s.saveCheckpointIfNeeded(int(s.Model.Version)) \n \n \n \n \n \n save checkpoint is not protected by the version lock.\n So the checkpoint version saved by Go PS is not consistent strictly.\n \n It may be reasonable that the model versions for shards in checkpoint keep consistency\n \t\t"}}}, "commit": {"commit_id": "3044deb42c718fde2428f85d5f670fe5781471de", "commit_author": "QI JUN", "commitT": "2020-03-13 13:39:36+08:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "elasticdl\\pkg\\ps\\server.go", "file_new_name": "elasticdl\\pkg\\ps\\server.go", "file_complexity": {"file_NLOC": "211", "file_CCN": "39", "file_NToken": "1366"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "184", "deleted_lines": "186", "method_info": {"method_name": "PushGradients", "method_params": "Context,PushGradientsRequest", "method_startline": "162", "method_endline": "192", "method_complexity": {"method_NLOC": "30", "method_CCN": "5", "method_NToken": "232", "method_nesting_level": "0"}}}}}}}}