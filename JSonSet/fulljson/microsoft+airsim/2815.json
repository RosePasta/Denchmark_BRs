{"BR": {"BR_id": "2815", "BR_author": "LSBOSS", "BRopenT": "2020-06-30T11:23:08Z", "BRcloseT": "2020-07-24T06:07:44Z", "BR_text": {"BRsummary": "Surface normals having a weird bias applied when requesting via AirSim", "BRdescription": "\n I'm working with surface normals requested via AirSim and observed a strange behavior. There seems to be a small non-linear biased applied to the surface normals' color values when requesting via airsim.ImageRequest and type airsim.ImageType.SurfaceNormals.\n I created a test scene with 9 axis aligned cubes and a camera looking down the positive x-axis. I then request a surface normal image via AirSim and let Unreal Engine 4 produce one be utilizing the highres screen shot function with \"Include Buffer Visualization Targets\" enabled. Here's the result:\n \n <denchmark-link:https://user-images.githubusercontent.com/7292257/86118769-a22cd600-bad1-11ea-87c1-6cac490ee388.png></denchmark-link>\n \n \n <denchmark-link:https://user-images.githubusercontent.com/7292257/86118823-af49c500-bad1-11ea-8b8c-d24ca54027c3.png></denchmark-link>\n \n The camera facing side of a the cube (the cyan one) should have a world normal of (-1, 0, 0) which according to the responsible material in the UE4 AirSim plugin (Plugins\\AirSim\\Content\\HUDAssets\\NormalsMaterial.uasset) should result in a color of (0, 0.5, 0.5) in float space or (0, 127, 127) in RGB space:\n <denchmark-link:https://user-images.githubusercontent.com/7292257/86119317-8413a580-bad2-11ea-8314-04dca4b68a2f.png></denchmark-link>\n \n But as you can clearly see, the color of said cube side on the AirSim export is (0, 187, 187) which results in a normal of (-0.87, 0.39, 0.39) after normalization. There's clearly a bias applied and I didn't found a workaround yet.\n settings.json:\n {\n     \"SettingsVersion\": 1.2,\n     \"SimMode\": \"ComputerVision\",\n     \"Vehicles\": {\n         \"MyVehicle\": {\n             \"VehicleType\": \"ComputerVision\",\n             \"Cameras\": {\n                 \"my_camera\": {\n                     \"CaptureSettings\": [\n                         {\n                             \"ImageType\": 6,\n                             \"FOV_Degrees\": 60,\n                             \"Width\": 1024,\n                             \"Height\": 1024\n                         }\n                     ],\n                     \"X\": 0.0,\n                     \"Y\": 0.0,\n                     \"Z\": 0.0,\n                     \"Pitch\": 0.0,\n                     \"Roll\": 0.0,\n                     \"Yaw\": 0.0\n                 }\n             }\n         }\n     }\n }\n Minimal working Python code:\n import setup_path\n import airsim\n \n client = airsim.VehicleClient(timeout_value = 7200)\n client.confirmConnection()\n \n responses = client.simGetImages([airsim.ImageRequest(\"my_camera\", airsim.ImageType.SurfaceNormals)])\n airsim.write_file(\"normal.png\", responses[0].image_data_uint8)\n \n <denchmark-link:https://github.com/microsoft/AirSim/files/4851396/BrokenSurfaceNormalsUE4Map.zip>BrokenSurfaceNormalsUE4Map.zip</denchmark-link>\n \n Version infos\n \n Unreal Engine: 4.24.2\n AirSim Plugin build from commit: Mon Jun 1 10:30:23 2020 +0530\n AirSim Python library: 1.2.8\n Python: 3.7.2 32bit\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "LSBOSS", "commentT": "2020-06-30T11:57:04Z", "comment_text": "\n \t\tI confirm the issue,\n \n UE4.18\n AirSim 1.2\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "LSBOSS", "commentT": "2020-06-30T15:07:24Z", "comment_text": "\n \t\tI also confirm the issue to exist,\n my env:\n \n UE4.18\n AirSim 1.2\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "LSBOSS", "commentT": "2020-07-10T10:53:46Z", "comment_text": "\n \t\tHA! I knew it has something to do with gamma because of the non-linear nature of the bias.\n I spent the last two days deep down in AirSim and Unreal rendering code and finally found the line which is responsible for the issue:\n In function APIPCamera::updateCaptureComponentSetting the following line is creating render target textures with disabled linear gamma for rendering request for Scene, Segmentation, SurfaceNormals and Infrared:\n render_target->InitCustomFormat(setting.width, setting.height, pixel_format, false);\n Changing the last flag to true results in the cyan surface from above screenshot has the right color (0,127,127) instead of (0,187,187) and thus also the right world normal of (-1, 0, 0).\n Please stay tuned for a PR :)\n PS This flag could also be the reason why non of the colors of the segmentation request outputs is in the list of <denchmark-link:https://microsoft.github.io/AirSim/seg_rgbs.txt>https://microsoft.github.io/AirSim/seg_rgbs.txt</denchmark-link>\n . I'll take a look in that as well.\n \t\t"}}}, "commit": {"commit_id": "d9289cf6a09e982a01cfd6867bd40417588a8d97", "commit_author": "Christoph Reinbothe", "commitT": "2020-07-23 23:07:38-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.9285714285714286"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "Unreal\\Plugins\\AirSim\\Content\\HUDAssets\\NormalsMaterial.uasset", "file_new_name": "Unreal\\Plugins\\AirSim\\Content\\HUDAssets\\NormalsMaterial.uasset", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "Unreal\\Plugins\\AirSim\\Source\\PIPCamera.cpp", "file_new_name": "Unreal\\Plugins\\AirSim\\Source\\PIPCamera.cpp", "file_complexity": {"file_NLOC": "431", "file_CCN": "84", "file_NToken": "3032"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313", "deleted_lines": "293,294,295,296,297,298,311,319", "method_info": {"method_name": "APIPCamera::setupCameraFromSettings", "method_params": "camera_setting,ned_transform", "method_startline": "270", "method_endline": "323", "method_complexity": {"method_NLOC": "44", "method_CCN": "8", "method_NToken": "338", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "326,327,335", "deleted_lines": null, "method_info": {"method_name": "APIPCamera::updateCaptureComponentSetting", "method_params": "capture,render_target,auto_format,pixel_format,setting,ned_transform,force_linear_gamma", "method_startline": "325", "method_endline": "349", "method_complexity": {"method_NLOC": "21", "method_CCN": "6", "method_NToken": "172", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "310,311,312,313,326,327", "deleted_lines": "311,319", "method_info": {"method_name": "APIPCamera::updateCaptureComponentSetting", "method_params": "capture,render_target,auto_format,pixel_format,setting,ned_transform", "method_startline": "310", "method_endline": "333", "method_complexity": {"method_NLOC": "20", "method_CCN": "6", "method_NToken": "169", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "Unreal\\Plugins\\AirSim\\Source\\PIPCamera.h", "file_new_name": "Unreal\\Plugins\\AirSim\\Source\\PIPCamera.h", "file_complexity": {"file_NLOC": "61", "file_CCN": "0", "file_NToken": "424"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "78,79,80", "deleted_lines": "78,79"}}}}}}