{"BR": {"BR_id": "25537", "BR_author": "ggyuan", "BRopenT": "2020-07-15T04:19:37Z", "BRcloseT": "2020-10-01T08:23:17Z", "BR_text": {"BRsummary": "CPU\u9884\u6d4b\u6a21\u578b\u5f00\u542fMKLDNN\u540e\u62a5\u9519", "BRdescription": "\n \n \n \u7248\u672c\u3001\u73af\u5883\u4fe1\u606f\uff1a\n \u00a0 \u00a01\uff09PaddlePaddle\u7248\u672c\uff1a1.8.1\n \u00a0 \u00a02\uff09CPU\uff1aIntel(R) Xeon(R) Gold 5117 CPU @ 2.00GHz, MKLDNN\n \u00a0 \u00a03\uff09GPU\uff1a\u65e0\n \u00a0 \u00a04\uff09\u7cfb\u7edf\u73af\u5883\uff1aCentOS release 6.3 (Final)\u3001Python 2.7.15\n \n \n \u590d\u73b0\u4fe1\u606f\uff1a\n \u767e\u5ea6\u5185\u90e8\u63d0\u51fa\uff0c\u590d\u73b0\u4ee3\u7801\u548c\u6a21\u578b\uff0c\u8bf7hi\u4e0a\u8054\u7cfb guguiyuan\n \n \n \u95ee\u9898\u63cf\u8ff0\uff1a\n \u6a21\u578b\u4f7f\u7528\u4e86pool2d op\u5f00\u542fmkldnn\u62a5\u9519\uff0c\u672a\u4f7f\u7528\u7684\u53ef\u6b63\u5e38\u8fd0\u884c\n \u9519\u8bef\u4fe1\u606f\u5982\u4e0b\n \n \n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ggyuan", "commentT": "2020-07-15T05:21:44Z", "comment_text": "\n \t\t\u770b\u8d77\u6765\u62a5\u9519\u662f\u5728elementwise op\u4e0a elementwise op\u7684\u4e24\u4e2a\u8f93\u5165\u7ef4\u5ea6\u4e0d\u5bf9 \u5982\u62a5\u9519\uff0c\u4e24\u4e2ashape\u5e94\u8be5\u5b8c\u5168\u76f8\u7b49\u6216\u8005\u53ef\u4ee5broadcast\u3002 \u53ef\u4ee5\u4f7f\u7528fluid.layers.Print() api \u6253\u5370\u4e0b\u67d0\u4e2a\u8f93\u51fa\u770b\u662f\u5426\u7b26\u5408\u9884\u671f\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ggyuan", "commentT": "2020-07-22T08:59:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jczaja>@jczaja</denchmark-link>\n  Could you help see this issue? The model/data/codes are already emailed to <denchmark-link:https://github.com/lidanqing-intel>@lidanqing-intel</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ggyuan", "commentT": "2020-07-22T12:38:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n  Please forward model/codes to me as <denchmark-link:https://github.com/lidanqing-intel>@lidanqing-intel</denchmark-link>\n  is out of office\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ggyuan", "commentT": "2020-08-06T04:16:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/lidanqing-intel>@lidanqing-intel</denchmark-link>\n  Could this issue be fixed in 1.8.5(next month)?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ggyuan", "commentT": "2020-08-07T08:18:44Z", "comment_text": "\n \t\tIt is related to fact that some tensors are having data_layout set to NHWC , while model is NCHW. Status: investigating.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ggyuan", "commentT": "2020-08-10T13:52:24Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n  I'm sorry for late response as I was away from office. I have just resumed investigation on this problem and will do our best to have it fixed.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ggyuan", "commentT": "2020-08-11T12:44:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n  I would like to share some findings and ask for advice. Reason why there is a crash is that this model is having pool2d ops and those ops are having an attribute :  , which is used to indicate if model is working on NCHW or NHWC data. In the past it was agreed that either all  attribs are set to NCHW or all are set to NHWC , there shouldn't be scenario where some operators are working with data in NCHW and some others in data arranged in NHWC.  Problem is that in this model there are pool2d ops and their's  values are diffrent. for example pool2d(id=139) is having NHWC:\n <denchmark-link:https://user-images.githubusercontent.com/15085062/89898077-5dbc4c00-dbe0-11ea-8532-57b3398792a4.jpg></denchmark-link>\n \n While pool2d(id=134) is having  set to kNCHW:\n <denchmark-link:https://user-images.githubusercontent.com/15085062/89898379-e4712900-dbe0-11ea-8291-f20a95ac11d7.jpg></denchmark-link>\n \n PaddlePaddle oneDNN integration does not support situation where some operators are to work on NCHW and some others on NHWC. Is this intentional that two diffrent pool2d ops are using diffrent data_format ?\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "ggyuan", "commentT": "2020-08-12T06:53:36Z", "comment_text": "\n \t\t\n Is this intentional that two different pool2d ops are using different data_format\n \n Discussed with <denchmark-link:https://github.com/phlrain>@phlrain</denchmark-link>\n , it is not reasonable that two different pool2d ops are using different data_format. <denchmark-link:https://github.com/phlrain>@phlrain</denchmark-link>\n  and <denchmark-link:https://github.com/wanghuancoder>@wanghuancoder</denchmark-link>\n  will help see the training logical at first.\n Thanks for the analysis of <denchmark-link:https://github.com/jczaja>@jczaja</denchmark-link>\n !\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "ggyuan", "commentT": "2020-09-14T12:28:15Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jczaja>@jczaja</denchmark-link>\n  <denchmark-link:https://github.com/lidanqing-intel>@lidanqing-intel</denchmark-link>\n  We make two different pool2d ops use the same data_format, and train a new model for inference.\n <denchmark-link:https://user-images.githubusercontent.com/6836917/93084543-cb1f3900-f6c6-11ea-8564-91a9c76bed2a.png></denchmark-link>\n \n But we can infer successfully with MKL, but fails with MKLDNN. The error is\n <denchmark-link:https://user-images.githubusercontent.com/6836917/93085794-b348b480-f6c8-11ea-9478-8859b33c9774.png></denchmark-link>\n \n I will email the new inference model to you.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "ggyuan", "commentT": "2020-09-17T15:09:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n  I have question regarding this situation. Model is to be executed using NHWC input data as pool2d ops are having  set . The other ops in a model do not have  attribute so the way they work should be transparent to whether we use NCHW or NHWC signal. The thing is that this model is having  op . Matmul does not have  so  it should work properly regardless NCHW or NHWC used. Could you please confirm that   should NOT have  and that its implementation will work properly regardless NCWH or NHWC arrangment used?\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "ggyuan", "commentT": "2020-09-22T07:21:01Z", "comment_text": "\n \t\t\n Could you please confirm that matmul should NOT have data_format and that its implementation will work properly regardless NCWH or NHWC arrangment used\n \n Yes, it is. matmul should not have data_format attribute, and its implementation will work properly regardless any data_format used.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "ggyuan", "commentT": "2020-09-24T12:08:38Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n  I have made a fix(develop) to this issue: <denchmark-link:https://github.com/PaddlePaddle/Paddle/pull/27546>#27546</denchmark-link>\n  . Please test it and let us know if this works fine for you. Also please tell me if you need a fix to be merged to 1.8 as well.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "ggyuan", "commentT": "2020-09-24T12:52:04Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/OliverLPH>@OliverLPH</denchmark-link>\n  Could you help test it?\n <denchmark-link:https://github.com/jczaja>@jczaja</denchmark-link>\n  We have <denchmark-link:https://github.com/PaddlePaddle/Paddle/releases/tag/v1.8.5>1.8.5 tag</denchmark-link>\n  three hours before.\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "ggyuan", "commentT": "2020-09-27T10:31:11Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jczaja>@jczaja</denchmark-link>\n  <denchmark-link:https://github.com/luotao1>@luotao1</denchmark-link>\n \n I have verified <denchmark-link:https://github.com/PaddlePaddle/Paddle/pull/27546>#27546</denchmark-link>\n  has fixed this issue, please merge this PR\n \t\t"}}}, "commit": {"commit_id": "b9fda2ff096a907e67e77833fe52b72fd7cc4db3", "commit_author": "Jacek Czaja", "commitT": "2020-10-01 16:23:16+08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.1111111111111111", "commit_Nprams": "0.7777777777777778"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "paddle\\fluid\\framework\\data_layout_transform.cc", "file_new_name": "paddle\\fluid\\framework\\data_layout_transform.cc", "file_complexity": {"file_NLOC": "157", "file_CCN": "21", "file_NToken": "1209"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "206", "deleted_lines": "206", "method_info": {"method_name": "paddle::framework::innerTransDataLayoutFromMKLDNN", "method_params": "in_layout,out_layout,in,out,place", "method_startline": "146", "method_endline": "209", "method_complexity": {"method_NLOC": "48", "method_CCN": "3", "method_NToken": "408", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "paddle\\fluid\\operators\\CMakeLists.txt", "file_new_name": "paddle\\fluid\\operators\\CMakeLists.txt", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "147", "deleted_lines": null}}}, "file_2": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "paddle\\fluid\\operators\\mkldnn\\nhwc_op_tests.cmake", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "paddle\\fluid\\operators\\mkldnn\\test_mkldnn_op_nhwc.cc", "file_complexity": {"file_NLOC": "64", "file_CCN": "2", "file_NToken": "519"}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "paddle\\fluid\\operators\\transpose_op.cc", "file_new_name": "paddle\\fluid\\operators\\transpose_op.cc", "file_complexity": {"file_NLOC": "284", "file_CCN": "35", "file_NToken": "1951"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "64,65,66,67,68,69,70,71,72,73,74,75,76", "deleted_lines": null, "method_info": {"method_name": "paddle::operators::TransposeOp::InferShape", "method_params": "ctx", "method_startline": "33", "method_endline": "81", "method_complexity": {"method_NLOC": "42", "method_CCN": "7", "method_NToken": "352", "method_nesting_level": "3"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "paddle\\fluid\\platform\\mkldnn_helper.h", "file_new_name": "paddle\\fluid\\platform\\mkldnn_helper.h", "file_complexity": {"file_NLOC": "394", "file_CCN": "146", "file_NToken": "3344"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,108,109,117,118", "deleted_lines": null, "method_info": {"method_name": "paddle::platform::MatchShapeToLayout", "method_params": "tensor_in,from,to", "method_startline": "76", "method_endline": "124", "method_complexity": {"method_NLOC": "39", "method_CCN": "7", "method_NToken": "320", "method_nesting_level": "2"}}}}}}}}