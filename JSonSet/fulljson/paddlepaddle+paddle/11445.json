{"BR": {"BR_id": "11445", "BR_author": "qingqing01", "BRopenT": "2018-06-13T13:08:43Z", "BRcloseT": "2018-07-10T05:07:44Z", "BR_text": {"BRsummary": "Skip the BatchNorm when feature only have 1 element.", "BRdescription": "\n <denchmark-code>y = (x - mean(x)) / (std(x) + eps)\n </denchmark-code>\n \n If x only have 1 element, mean(x) = x,  std(x) = 0.  The output will be entirely zero (ignoring the bias). The feature is no meaningless.  In this case, we should not use feature-wise batch normalization.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "qingqing01", "commentT": "2018-06-19T14:34:36Z", "comment_text": "\n \t\tIf there is only one element in norm dimension,  for example,  feature map is [1, 128, 1, 1] or [1, 32],  the moving variance will be NaN.  The following test can reproduce this problem:\n <denchmark-code>import numpy as np\n \n import paddle\n import paddle.fluid as fluid\n \n def main():\n     epoc = 8\n     dshape = [1, 128, 1, 1]\n     data = fluid.layers.data(name='data', shape=[128, 1, 1], dtype='float32')\n     conv = fluid.layers.conv2d(data, 128, 3, stride=1, padding=1)\n     norm = fluid.layers.batch_norm(conv)\n \n     place = fluid.CUDAPlace(0)\n     exe = fluid.Executor(place)\n     exe.run(fluid.default_startup_program())\n \n     for i in range(epoc):\n         input = np.random.random(dshape).astype('float32')\n         exe.run(fluid.default_main_program(), feed={'data': input})\n         v = fluid.global_scope().find_var('batch_norm_0.w_2').get_tensor()\n         v = np.array(v)\n         print v\n         # import math\n         # for it in v.flatten().tolist():\n         #    if np.isnan(it):\n         #        print 'nan'\n          #   if np.isinf(it):\n          #       print 'inf'\n \n if __name__ == '__main__':\n     main()\n </denchmark-code>\n \n Will print:\n <denchmark-code>[nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan]\n [nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan nan\n  nan nan]\n ...\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "10fbb831edd0225d34639b5de476453a5ed0c1e0", "commit_author": "qingqing01", "commitT": "2018-07-10 13:07:43+08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "paddle\\fluid\\operators\\batch_norm_op.cc", "file_new_name": "paddle\\fluid\\operators\\batch_norm_op.cc", "file_complexity": {"file_NLOC": "440", "file_CCN": "46", "file_NToken": "3913"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "438,439,440,441,442", "deleted_lines": null, "method_info": {"method_name": "paddle::operators::BatchNormGradKernel<platform::CPUDeviceContext,T>::Compute", "method_params": "ctx", "method_startline": "390", "method_endline": "496", "method_complexity": {"method_NLOC": "87", "method_CCN": "9", "method_NToken": "940", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "219,220,221,222,223,224,225,226,227,228,229,230", "deleted_lines": "250,251,252,253", "method_info": {"method_name": "paddle::operators::BatchNormKernel<platform::CPUDeviceContext,T>::Compute", "method_params": "ctx", "method_startline": "179", "method_endline": "319", "method_complexity": {"method_NLOC": "123", "method_CCN": "16", "method_NToken": "1217", "method_nesting_level": "3"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "paddle\\fluid\\operators\\batch_norm_op.cu.cc", "file_new_name": "paddle\\fluid\\operators\\batch_norm_op.cu.cc", "file_complexity": {"file_NLOC": "237", "file_CCN": "24", "file_NToken": "2451"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234", "deleted_lines": "250,251,252,253,254,255,256,257,258,264", "method_info": {"method_name": "paddle::operators::BatchNormGradKernel<platform::CUDADeviceContext,T>::Compute", "method_params": "ctx", "method_startline": "198", "method_endline": "293", "method_complexity": {"method_NLOC": "78", "method_CCN": "7", "method_NToken": "898", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "75,76,77,99,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184", "deleted_lines": "96,116,117,118,119,120,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180", "method_info": {"method_name": "paddle::operators::BatchNormKernel<platform::CUDADeviceContext,T>::Compute", "method_params": "ctx", "method_startline": "56", "method_endline": "191", "method_complexity": {"method_NLOC": "105", "method_CCN": "9", "method_NToken": "1162", "method_nesting_level": "3"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "paddle\\fluid\\operators\\cross_entropy_op.cc", "file_new_name": "paddle\\fluid\\operators\\cross_entropy_op.cc", "file_complexity": {"file_NLOC": "144", "file_CCN": "7", "file_NToken": "761"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "127", "deleted_lines": "127,128", "method_info": {"method_name": "paddle::operators::CrossEntropyOpMaker::Make", "method_params": "", "method_startline": "114", "method_endline": "160", "method_complexity": {"method_NLOC": "47", "method_CCN": "1", "method_NToken": "56", "method_nesting_level": "3"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\paddle\\fluid\\tests\\unittests\\test_fake_dequantize_op.py", "file_new_name": "python\\paddle\\fluid\\tests\\unittests\\test_fake_dequantize_op.py", "file_complexity": {"file_NLOC": "32", "file_CCN": "6", "file_NToken": "246"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "43", "method_info": {"method_name": "setUp", "method_params": "self", "method_startline": "38", "method_endline": "48", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "96", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\paddle\\fluid\\tests\\unittests\\test_parallel_op.py", "file_new_name": "python\\paddle\\fluid\\tests\\unittests\\test_parallel_op.py", "file_complexity": {"file_NLOC": "150", "file_CCN": "12", "file_NToken": "1074"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "116,117,118", "deleted_lines": "116"}}}}}}