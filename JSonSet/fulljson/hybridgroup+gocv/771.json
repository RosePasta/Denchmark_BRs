{"BR": {"BR_id": "771", "BR_author": "squizzling", "BRopenT": "2020-12-05T11:17:00Z", "BRcloseT": "2021-01-11T08:19:03Z", "BR_text": {"BRsummary": "matprofile does not track Split() mats", "BRdescription": "\n When matprofile is enabled, gocv.Split() does not track the creation of mats.\n <denchmark-h:h2>Description</denchmark-h>\n \n Because  allocates a  and sets each  <denchmark-link:https://github.com/hybridgroup/gocv/blob/release/core.go#L1784-L1786>directly</denchmark-link>\n , it bypasses the profiling code.\n A similar pattern appears to be used in <denchmark-link:https://github.com/hybridgroup/gocv/blob/release/dnn.go#L180-L183>Net.ForwardLayers</denchmark-link>\n  and <denchmark-link:https://github.com/hybridgroup/gocv/blob/release/dnn.go#L373>ImagesFromBlob</denchmark-link>\n \n ImagesFromBlob in particular looks like it might be a risk, because if the mats passed in the slice have a p, then it won't be released.\n I have no direct knowledge of either of those last two being genuine problems, I just looked for writes to Mat.p in Goland.\n <denchmark-h:h2>Steps to Reproduce</denchmark-h>\n \n <denchmark-code>package main\n \n import (\n         \"bytes\"\n         \"fmt\"\n \n         \"gocv.io/x/gocv\"\n )\n \n func PrintProfile(message string) {\n         fmt.Printf(message, gocv.MatProfile.Count())\n         b := bytes.Buffer{}\n         gocv.MatProfile.WriteTo(&b, 1)\n         fmt.Print(b.String())\n }\n \n func CloseMat(mat gocv.Mat) {\n         err := mat.Close()\n         if err != nil {\n                 panic(err)\n         }\n }\n \n func main() {\n         mat := gocv.NewMatWithSize(5, 5, gocv.MatTypeCV8UC3)\n         PrintProfile(\"count after creating 3 channel mat is %d\\n\")\n \n         channels := gocv.Split(mat)\n         PrintProfile(\"count after split is %d\\n\")\n \n         for _, channel := range channels {\n                 CloseMat(channel)\n         }\n         PrintProfile(\"count after closing channels is %d\\n\")\n \n         CloseMat(mat)\n         PrintProfile(\"count after closing 3 channel mat is %d\\n\")\n }\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n Tested in hybridgroup/gocv@sha256:1a48836ce6b31adaaf45f5b85210d6f43e1eeadfd2d4c535c86d97beee42593b (latest at time of writing)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "squizzling", "commentT": "2020-12-12T19:22:01Z", "comment_text": "\n \t\tI can confirm that this is a bug. I already fixed this issue, as soon as tests are finished, I'll create a pull request. Thanks for reporting this issue.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "squizzling", "commentT": "2020-12-12T22:16:51Z", "comment_text": "\n \t\tAll tests passed, because of this issue many tests were corrected because of unclosed mats returned by Split function.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "squizzling", "commentT": "2021-01-11T08:19:02Z", "comment_text": "\n \t\tThis was released with v0.26.0 so now closing. Thank you everyone!\n \t\t"}}}, "commit": {"commit_id": "b090d9e34bd7ace5d7698a865ea60b12f37394a8", "commit_author": "Aleksandar Golubovi\u0107", "commitT": "2020-12-13 21:18:00+01:00", "commit_complexity": {"commit_NLOC": "0.16363636363636364", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "core.go", "file_new_name": "core.go", "file_complexity": {"file_NLOC": "993", "file_CCN": "206", "file_NToken": "9446"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1826", "deleted_lines": null, "method_info": {"method_name": "Split", "method_params": "Mat", "method_startline": "1819", "method_endline": "1829", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "98", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "core_test.go", "file_new_name": "core_test.go", "file_complexity": {"file_NLOC": "2175", "file_CCN": "509", "file_NToken": "16127"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "106,107,108,173,174,175", "deleted_lines": null, "method_info": {"method_name": "TestMatWithSizes", "method_params": "T", "method_startline": "22", "method_endline": "177", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "35", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "106,107,108", "deleted_lines": null, "method_info": {"method_name": "", "method_params": "", "method_startline": "58", "method_endline": "109", "method_complexity": {"method_NLOC": "45", "method_CCN": "15", "method_NToken": "358", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1724,1725,1726", "deleted_lines": null, "method_info": {"method_name": "TestMatSplit", "method_params": "T", "method_startline": "1714", "method_endline": "1734", "method_complexity": {"method_NLOC": "21", "method_CCN": "6", "method_NToken": "135", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "2355,2356,2357,2358,2370,2371,2372", "deleted_lines": null, "method_info": {"method_name": "TestMixChannels", "method_params": "T", "method_startline": "2327", "method_endline": "2373", "method_complexity": {"method_NLOC": "39", "method_CCN": "11", "method_NToken": "355", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "280,281,282", "deleted_lines": null, "method_info": {"method_name": "TestMatWithSizeFromScalar", "method_params": "T", "method_startline": "236", "method_endline": "283", "method_complexity": {"method_NLOC": "41", "method_CCN": "14", "method_NToken": "318", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "dnn.go", "file_new_name": "dnn.go", "file_complexity": {"file_NLOC": "344", "file_CCN": "63", "file_NToken": "2890"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "183", "deleted_lines": null, "method_info": {"method_name": "ForwardLayers", "method_params": "string", "method_startline": "177", "method_endline": "186", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "110", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "dnn_test.go", "file_new_name": "dnn_test.go", "file_complexity": {"file_NLOC": "493", "file_CCN": "129", "file_NToken": "3510"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "92,93,94", "deleted_lines": null, "method_info": {"method_name": "checkNet", "method_params": "T,Net", "method_startline": "11", "method_endline": "95", "method_complexity": {"method_NLOC": "69", "method_CCN": "22", "method_NToken": "507", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mat_noprofile.go", "file_new_name": "mat_noprofile.go", "file_complexity": {"file_NLOC": "14", "file_CCN": "3", "file_NToken": "65"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "12,13,14", "deleted_lines": null, "method_info": {"method_name": "addMatToProfile", "method_params": "Mat", "method_startline": "12", "method_endline": "14", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mat_profile.go", "file_new_name": "mat_profile.go", "file_complexity": {"file_NLOC": "31", "file_CCN": "5", "file_NToken": "135"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62,63,64,65", "deleted_lines": null, "method_info": {"method_name": "addMatToProfile", "method_params": "Mat", "method_startline": "62", "method_endline": "65", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "0"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "matprofile_test.go", "file_new_name": "matprofile_test.go", "file_complexity": {"file_NLOC": "62", "file_CCN": "14", "file_NToken": "378"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71", "deleted_lines": null, "method_info": {"method_name": "TestAddMatToProfile", "method_params": "T", "method_startline": "44", "method_endline": "71", "method_complexity": {"method_NLOC": "25", "method_CCN": "7", "method_NToken": "170", "method_nesting_level": "0"}}}}}}}}