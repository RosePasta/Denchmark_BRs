{"BR": {"BR_id": "1787", "BR_author": "ArbinTimilsina", "BRopenT": "2020-05-05T15:44:39Z", "BRcloseT": "2020-05-06T15:10:47Z", "BR_text": {"BRsummary": "IndexError while evaluating with a model trained with guided alignment.", "BRdescription": "\n I came across the following error while running evaluation. I am running OpenNMT-py 1.1.1 and using the transformer model trained with guided alignment. For translation, I have replace_unk and report_align set to True.\n <denchmark-code>File \".../onmt/translate/translation.py\", line 51, in _build_target_tokens\n     _, max_index = attn[i][:len(src_raw)].max(0)\n IndexError: index 12 is out of bounds for dimension 0 with size 7\n </denchmark-code>\n \n This error happens only during evaluation when I pass the -tgt file to the translator.translate(). If I don\u2019t pass the -tgt file, I don\u2019t come across this error.\n Also, in my case, the following source-target combination would create this error:\n <denchmark-code>Source: \u2581sub \u2581v f \u2581: \u2581n\u00e9 mon e , \u2581dr oo , \u2581ve en , \u2581 \u00a4 aka \u00a4 \n Target: \u2581vo \u2581by \u2581: \u2581 \u00a4 aka \u00a4\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ArbinTimilsina", "commentT": "2020-05-05T16:47:32Z", "comment_text": "\n \t\tThat's strange, I'm not sure to get why the  arg is of importance here.\n <denchmark-link:https://github.com/Zenglinxiao>@Zenglinxiao</denchmark-link>\n  any idea?\n <denchmark-link:https://github.com/ArbinTimilsina>@ArbinTimilsina</denchmark-link>\n  could you please post the full trace?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ArbinTimilsina", "commentT": "2020-05-05T17:22:40Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/francoishernandez>@francoishernandez</denchmark-link>\n , below is the full trace:\n <denchmark-code>  File \".../onmt/translate/translator.py\", line 357, in translate\n     translations = xlation_builder.from_batch(batch_data)\n   File \".../onmt/translate/translation.py\", line 101, in from_batch\n     for n in range(self.n_best)]\n   File \".../onmt/translate/translation.py\", line 101, in <listcomp>\n     for n in range(self.n_best)]\n   File \".../onmt/translate/translation.py\", line 51, in _build_target_tokens\n     _, max_index = attn[i][:len(src_raw)].max(0)\n IndexError: index 12 is out of bounds for dimension 0 with size 7\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ArbinTimilsina", "commentT": "2020-05-06T07:16:29Z", "comment_text": "\n \t\tOh. Thanks for this report. I just checked the code, so the problem came from the #L477 in translator.py that was used for debugging purpose. When you set -tgt, we do the align forward using the tgt rather than prediction, so latter when building prediction sentence, this causes a mismatch by using the output prediction and alignment between src and tgt.\n So you just need to comment out the #L477-L479, this will be fixed.\n \t\t"}}}, "commit": {"commit_id": "dd484fabe0795de4c2492d0afc55353129479fd1", "commit_author": "Linxiao ZENG", "commitT": "2020-05-06 12:30:04+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onmt\\translate\\translator.py", "file_new_name": "onmt\\translate\\translator.py", "file_complexity": {"file_NLOC": "558", "file_CCN": "29", "file_NToken": "3495"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "474,475", "deleted_lines": "477,478,479,480,481", "method_info": {"method_name": "_align_forward", "method_params": "self,batch,predictions", "method_startline": "468", "method_endline": "509", "method_complexity": {"method_NLOC": "26", "method_CCN": "3", "method_NToken": "270", "method_nesting_level": "1"}}}}}}}}