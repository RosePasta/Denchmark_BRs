{"BR": {"BR_id": "1963", "BR_author": "DEKHTIARJonathan", "BRopenT": "2020-05-19T00:04:19Z", "BRcloseT": "2020-05-29T19:39:29Z", "BR_text": {"BRsummary": "[Bug Report] `python setup.py install` is broken", "BRdescription": "\n When installing Horovod from source, it seems that one of the \"common routes\" is broken:\n Building as follows will generate an impressive number of issues at execution:\n <denchmark-code>export HOROVOD_GPU_ALLREDUCE=NCCL\n export HOROVOD_GPU_BROADCAST=NCCL\n export HOROVOD_NCCL_INCLUDE=/usr/include\n export HOROVOD_NCCL_LIB=/usr/lib/x86_64-linux-gnu\n export HOROVOD_NCCL_LINK=SHARED\n export HOROVOD_WITHOUT_PYTORCH=1\n export HOROVOD_WITHOUT_MXNET=1\n export HOROVOD_WITH_TENSORFLOW=1\n export HOROVOD_WITH_MPI=1\n export HOROVOD_BUILD_ARCH_FLAGS=\"-march=sandybridge -mtune=broadwell\"\n pip uninstall horovod -y\n python setup.py clean\n python setup.py install\n python setup.py clean\n </denchmark-code>\n \n However, building as follows perfectly works:\n <denchmark-code>export HOROVOD_GPU_ALLREDUCE=NCCL\n export HOROVOD_GPU_BROADCAST=NCCL\n export HOROVOD_NCCL_INCLUDE=/usr/include\n export HOROVOD_NCCL_LIB=/usr/lib/x86_64-linux-gnu\n export HOROVOD_NCCL_LINK=SHARED\n export HOROVOD_WITHOUT_PYTORCH=1\n export HOROVOD_WITHOUT_MXNET=1\n export HOROVOD_WITH_TENSORFLOW=1\n export HOROVOD_WITH_MPI=1\n export HOROVOD_BUILD_ARCH_FLAGS=\"-march=sandybridge -mtune=broadwell\"\n pip uninstall horovod -y\n rm -rf dist/*\n python setup.py sdist\n pip install --no-cache --no-cache-dir dist/horovod-*.tar.gz\n python setup.py clean\n </denchmark-code>\n \n <denchmark-h:hr></denchmark-h>\n \n Error Log:\n <denchmark-code>2020-05-18 23:42:11.081786: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library libcudart.so.11.0\n Traceback (most recent call last):\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/tiny_shell_exec.py\", line 33, in execute\n     exit_code = safe_shell_exec.execute(command, stdout=output, stderr=output)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/safe_shell_exec.py\", line 175, in execute\n     middleman.start()\n   File \"/usr/lib/python3.6/multiprocessing/process.py\", line 105, in start\n     self._popen = self._Popen(self)\n   File \"/usr/lib/python3.6/multiprocessing/context.py\", line 284, in _Popen\n     return Popen(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 32, in __init__\n     super().__init__(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_fork.py\", line 19, in __init__\n     self._launch(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 42, in _launch\n     prep_data = spawn.get_preparation_data(process_obj._name)\n   File \"/usr/lib/python3.6/multiprocessing/spawn.py\", line 172, in get_preparation_data\n     main_mod_name = getattr(main_module.__spec__, \"name\", None)\n AttributeError: module '__main__' has no attribute '__spec__'\n \n Traceback (most recent call last):\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/tiny_shell_exec.py\", line 33, in execute\n     exit_code = safe_shell_exec.execute(command, stdout=output, stderr=output)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/safe_shell_exec.py\", line 175, in execute\n     middleman.start()\n   File \"/usr/lib/python3.6/multiprocessing/process.py\", line 105, in start\n     self._popen = self._Popen(self)\n   File \"/usr/lib/python3.6/multiprocessing/context.py\", line 284, in _Popen\n     return Popen(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 32, in __init__\n     super().__init__(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_fork.py\", line 19, in __init__\n     self._launch(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 42, in _launch\n     prep_data = spawn.get_preparation_data(process_obj._name)\n   File \"/usr/lib/python3.6/multiprocessing/spawn.py\", line 172, in get_preparation_data\n     main_mod_name = getattr(main_module.__spec__, \"name\", None)\n AttributeError: module '__main__' has no attribute '__spec__'\n \n Traceback (most recent call last):\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/tiny_shell_exec.py\", line 33, in execute\n     exit_code = safe_shell_exec.execute(command, stdout=output, stderr=output)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/common/util/safe_shell_exec.py\", line 175, in execute\n     middleman.start()\n   File \"/usr/lib/python3.6/multiprocessing/process.py\", line 105, in start\n     self._popen = self._Popen(self)\n   File \"/usr/lib/python3.6/multiprocessing/context.py\", line 284, in _Popen\n     return Popen(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 32, in __init__\n     super().__init__(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_fork.py\", line 19, in __init__\n     self._launch(process_obj)\n   File \"/usr/lib/python3.6/multiprocessing/popen_spawn_posix.py\", line 42, in _launch\n     prep_data = spawn.get_preparation_data(process_obj._name)\n   File \"/usr/lib/python3.6/multiprocessing/spawn.py\", line 172, in get_preparation_data\n     main_mod_name = getattr(main_module.__spec__, \"name\", None)\n AttributeError: module '__main__' has no attribute '__spec__'\n \n Traceback (most recent call last):\n   File \"/usr/local/bin/horovodrun\", line 4, in <module>\n     __import__('pkg_resources').run_script('horovod==0.19.2', 'horovodrun')\n   File \"/usr/local/lib/python3.6/dist-packages/pkg_resources/__init__.py\", line 667, in run_script\n     self.require(requires)[0].run_script(script_name, ns)\n   File \"/usr/local/lib/python3.6/dist-packages/pkg_resources/__init__.py\", line 1464, in run_script\n     exec(code, namespace, namespace)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/EGG-INFO/scripts/horovodrun\", line 21, in <module>\n     run_commandline()\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/runner.py\", line 723, in run_commandline\n     _run(args)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/runner.py\", line 656, in _run\n     _launch_job(args, remote_host_names, settings, nics, command)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/runner.py\", line 717, in _launch_job\n     args.verbose)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/runner.py\", line 692, in run_controller\n     mpi_run()\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/runner.py\", line 709, in mpi_run_fn\n     mpi_run(settings, nics, env, command)\n   File \"/usr/local/lib/python3.6/dist-packages/horovod-0.19.2-py3.6-linux-x86_64.egg/horovod/run/mpi_run.py\", line 143, in mpi_run\n     raise Exception(_MPI_NOT_FOUND_ERROR_MSG)\n Exception: horovod does not find an installed MPI.\n \n Choose one of:\n 1. Install Open MPI 4.0.0+ or IBM Spectrum MPI or MPICH and re-install Horovod (use --no-cache-dir pip option).\n 2. Run distributed training script using the standard way provided by your MPI distribution (usually mpirun, srun, or jsrun).\n 3. Use built-in gloo option (horovodrun --gloo ...).\n </denchmark-code>\n \n <denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  FYI ;)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "DEKHTIARJonathan", "commentT": "2020-05-20T16:12:48Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/DEKHTIARJonathan>@DEKHTIARJonathan</denchmark-link>\n , to clarify, are these errors happening during installation, or only when you call  after install?  Looks like the  script is having some issues with spawning processes, but that shouldn't be called during installation.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "DEKHTIARJonathan", "commentT": "2020-05-20T18:20:48Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tgaddair>@tgaddair</denchmark-link>\n  installation work. In the sense that it doesn't crash. It breaks at runtime.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "DEKHTIARJonathan", "commentT": "2020-05-29T16:28:11Z", "comment_text": "\n \t\tI think I see the problem here.  When we build with python setup.py install, it produces the following horovodrun script without a __main__ guard:\n <denchmark-code># EASY-INSTALL-SCRIPT: 'horovod==0.19.2','horovodrun'\n __requires__ = 'horovod==0.19.2'\n __import__('pkg_resources').run_script('horovod==0.19.2', 'horovodrun')\n </denchmark-code>\n \n In contrast, the correct script does include the __main__ guard, which is necessary for multiprocessing spawn to work correctly:\n <denchmark-code>from horovod.run.runner import run_commandline\n \n if __name__ == '__main__':\n     run_commandline()\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "DEKHTIARJonathan", "commentT": "2020-05-29T17:13:22Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/DEKHTIARJonathan>@DEKHTIARJonathan</denchmark-link>\n , can you test out <denchmark-link:https://github.com/horovod/horovod/pull/1999>#1999</denchmark-link>\n  and see if it fixes the issue for you?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "DEKHTIARJonathan", "commentT": "2020-05-29T19:39:55Z", "comment_text": "\n \t\tThanks for verifying the fix, <denchmark-link:https://github.com/DEKHTIARJonathan>@DEKHTIARJonathan</denchmark-link>\n !  This has been landed.\n \t\t"}}}, "commit": {"commit_id": "dddfc454bb525661548aeeb61103e7b9743c4ad5", "commit_author": "Travis Addair", "commitT": "2020-05-29 12:39:28-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "bin\\horovodrun", "file_new_name": "None", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "setup.py", "file_new_name": "setup.py", "file_complexity": {"file_NLOC": "1299", "file_CCN": "305", "file_NToken": "7309"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1619,1621,1622,1623,1624,1648,1649,1650,1651,1652", "deleted_lines": "1620,1644"}}}}}}