{"BR": {"BR_id": "1550", "BR_author": "Echo9573", "BRopenT": "2019-12-26T09:19:36Z", "BRcloseT": "2019-12-31T04:20:45Z", "BR_text": {"BRsummary": "Some problem about DNN", "BRdescription": "\n When I tested the latest version of SQLFlow, I found that there are many problems with DNN prediction, as shown below\uff1a\n 1\u3001When performing a binary classification task, an error is reported when the class value is 1, 2.\n and the error info is \"\n _MultiThreadedRendezvous: <_MultiThreadedRendezvous of RPC that terminated with:\n status = StatusCode.INTERNAL\n details = \"Received RST_STREAM with error code 2\"\n debug_error_string = \"{\"created\":\"@1577256107.434626800\",\"description\":\"Error received from peer ipv4:127.0.0.1:50051\",\"file\":\"src/core/lib/surface/call.cc\",\"file_line\":1056,\"grpc_message\":\"Received RST_STREAM with error code 2\",\"grpc_status\":13}\"\n \n \n \"\n <denchmark-link:https://user-images.githubusercontent.com/24820352/71469052-f5605c00-2802-11ea-8af7-69c76c61d962.png></denchmark-link>\n \n <denchmark-link:https://user-images.githubusercontent.com/24820352/71469121-22ad0a00-2803-11ea-9c39-c79d24e70242.png></denchmark-link>\n \n 2\u3001when In the binary classification task, when the class value is 0, 1, manually set verbose = 1, an error is reported. The error info is \"\n \u201c_MultiThreadedRendezvous: <_MultiThreadedRendezvous of RPC that terminated with:\n status = StatusCode.INTERNAL\n details = \"Received RST_STREAM with error code 2\"\n debug_error_string = \"{\"created\":\"@1577351866.970226900\",\"description\":\"Error received from peer ipv4:127.0.0.1:50051\",\"file\":\"src/core/lib/surface/call.cc\",\"file_line\":1056,\"grpc_message\":\"Received RST_STREAM with error code 2\",\"grpc_status\":13}\"\n \n \u201d\n \n <denchmark-link:https://user-images.githubusercontent.com/24820352/71469073-08732c00-2803-11ea-8b79-e4ba17d434a9.png></denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Echo9573", "commentT": "2019-12-30T04:02:02Z", "comment_text": "\n \t\tThanks for submitting this issue.\n For the first point, please be aware that model.n_classes = 2 requires the class value to be either 0 or 1. However, the class column in select * from iris.train where class >= 1 is of value 1 or 2. So TensorFlow complains\n <denchmark-code>...  [Labels must be <= n_classes - 1] [Condition x <= y did not hold element-wise:x (head/losses/ToFloat:0) = ] [[2]] [y (head/losses/check_label_range/Const:0) = ] [1]\n </denchmark-code>\n \n One workaround could be manually applying minus one in the select statement.\n <denchmark-code>select sepal_length, sepal_width, petal_length, petal_width, class - 1 as class from iris.train where class >= 1 limit 10\n to train ...\n </denchmark-code>\n \n I am not sure if SQLFlow should be applying the minus one automatically.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Echo9573", "commentT": "2019-12-30T04:52:54Z", "comment_text": "\n \t\tFor the second point,\n <denchmark-code>SELECT * FROM iris.train WHERE class <= 1\n TO TRAIN DNNClassifier\n WITH\n     model.n_classes = 2,\n     model.hidden_units = [10, 10],\n     train.epoch = 10,\n     validation.select = 'select * from iris.test where class <= 1;'\n LABEL class\n INTO sqlflow_models.my_dnn_model\n </denchmark-code>\n \n Works fine, maybe the problem is due to train.verbose=1.\n <denchmark-h:hr></denchmark-h>\n \n Update:\n Indeed, the following SQL\n <denchmark-code>SELECT * FROM iris.train WHERE class <= 1\n TO TRAIN DNNClassifier\n WITH\n \tmodel.n_classes = 2,\n \tmodel.hidden_units = [10, 10],\n \ttrain.epoch = 10,\n \ttrain.verbose = 1,\n \tvalidation.select = 'select * from iris.test where class <= 1;'\n LABEL class\n INTO sqlflow_models.my_dnn_model;\n </denchmark-code>\n \n Failed with\n <denchmark-code>File \"/root/go/src/sqlflow.org/sqlflow/python/sqlflow_submitter/tensorflow/hooks.py\", line 34, in before_run\n     fetch = {\"loss\": loss_vars[0], \"step\": step_vars[0]}\n     IndexError: list index out of range\n </denchmark-code>\n \n This is due to \n \n \n sqlflow/python/sqlflow_submitter/tensorflow/hooks.py\n \n \n          Line 28\n       in\n       254a5e6\n \n \n \n \n \n \n  loss_vars = tf.compat.v1.get_collection(tf.compat.v1.GraphKeys.LOSSES) \n \n \n \n \n loss_vars is [].\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Echo9573", "commentT": "2019-12-30T05:36:42Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/typhoonzero>@typhoonzero</denchmark-link>\n , could you please take a look at this?\n \t\t"}}}, "commit": {"commit_id": "0a5b855f0be282b6f382811270831851d694d63b", "commit_author": "Wu Yi", "commitT": "2019-12-31 12:20:44+08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.09523809523809523"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\sqlflow_submitter\\tensorflow\\estimator_example.py", "file_new_name": "python\\sqlflow_submitter\\tensorflow\\estimator_example.py", "file_complexity": {"file_NLOC": "95", "file_CCN": "0", "file_NToken": "475"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "24,25,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103", "deleted_lines": "87"}}}, "file_1": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "python\\sqlflow_submitter\\tensorflow\\hooks.py", "file_new_name": "None", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "python\\sqlflow_submitter\\tensorflow\\train.py", "file_new_name": "python\\sqlflow_submitter\\tensorflow\\train.py", "file_complexity": {"file_NLOC": "186", "file_CCN": "10", "file_NToken": "1245"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "136,147,177,180,182,183,184,185", "deleted_lines": "43,137,138,139,140,141,142,143,154,186,187,188,190,191,192,193"}}}}}}