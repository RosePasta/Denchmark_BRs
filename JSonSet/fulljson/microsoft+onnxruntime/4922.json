{"BR": {"BR_id": "4922", "BR_author": "rajeevbaalwan", "BRopenT": "2020-08-26T05:28:32Z", "BRcloseT": "2020-11-16T03:48:07Z", "BR_text": {"BRsummary": "Unable to load pytorch model exported to onnx using use_external_data_format=True Flag", "BRdescription": "\n I'm trying to convert transformer encoder decoder model to onnx format but unable to export it in a single file, as protobuf capacity is limited to 2GB only\n But pytorch allows to save onnx model to external data format\n here is the doc for this parameter :\n \n external_data_format (bool, default False) \u2013 If True, then the model is exported in ONNX external data format, in which case some of the model parameters are stored in external binary files and not in the ONNX model file itself. See link for format details: https://github.com/onnx/onnx/blob/8b3f7e2e7a0f2aba0e629e23d89f07c7fc0e6a5e/onnx/onnx.proto#L423 Also, in this case, argument \u2018f\u2019 must be a string specifying the location of the model. The external binary files will be stored in the same location specified by the model location \u2018f\u2019. If False, then the model is stored in regular format, i.e. model and parameters are all in one file. This argument is ignored for all export types other than ONNX.\n \n This is how i exported the model :\n <denchmark-code>def convert_to_onnx(features):\n     import torch.onnx\n     torch.onnx.export(model,\n                       features,\n                       '/home/rajeev/pb/espnet/agent_model/onnx_model/model_aten.onnx',\n                       input_names= ['features'],\n                       output_names=['hyp_text'],\n                       dynamic_axes={\n                           'features':{0:'batch_size',1: 'time_steps'},\n                           'hyp_text':{0:'batch_size'}\n                       },\n                       verbose=True,\n                       opset_version=12,\n                       # operator_export_type= torch.onnx.OperatorExportTypes.ONNX_ATEN,\n                       use_external_data_format=True,\n                       enable_onnx_checker=True,\n                       do_constant_folding=True\n                       )\n </denchmark-code>\n \n total size of all the files exported are of 9 GB and my actual model was of 1 GB.\n /home/rajeev/pb/espnet/agent_model/onnx_model folder contains 5344 exported files along with model_aten.onnx file having size of only 4MB.\n But when I am trying to load the model I am getting this error :\n <denchmark-code>Error while loading the model: [ONNXRuntimeError] : 6 : RUNTIME_EXCEPTION : Exception during initialization: /onnxruntime_src/onnxruntime/core/optimizer/optimizer_execution_frame.cc:61 onnxruntime::OptimizerExecutionFrame::Info::Info(const std::vector<const onnxruntime::Node*>&, const InitializedTensorSet&, std::unique_ptr<onnxruntime::CPUExecutionProvider>) [ONNXRuntimeError] : 2 : INVALID_ARGUMENT : Invalid fd was supplied: -1\n </denchmark-code>\n \n Here is the way i am trying to load the model:\n <denchmark-code>try:\n     onnx_options = SessionOptions()\n     _ = InferenceSession(path, onnx_options)\n     print(\"Model correctly loaded\")\n except RuntimeException as re:\n     print(\"Error while loading the model: {}\".format(re))\n </denchmark-code>\n \n I have not found any good solution for this.\n Please me out achieving this.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "rajeevbaalwan", "commentT": "2020-08-26T17:58:17Z", "comment_text": "\n \t\tHi, thanks for the feedback.\n Can you please try to disable optimizer (Disables all optimizations) see if it works? <denchmark-link:https://github.com/microsoft/onnxruntime/blob/master/docs/ONNX_Runtime_Graph_Optimizations.md#python-api-usage>https://github.com/microsoft/onnxruntime/blob/master/docs/ONNX_Runtime_Graph_Optimizations.md#python-api-usage</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "rajeevbaalwan", "commentT": "2020-11-01T07:41:53Z", "comment_text": "\n \t\tThis issue has been automatically marked as stale due to inactivity and will be closed in 7 days if no further activity occurs. If further support is needed, please provide an update and/or more details.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "rajeevbaalwan", "commentT": "2020-11-16T03:47:49Z", "comment_text": "\n \t\tThis issue has been automatically closed due to inactivity. Please reactivate if further support is needed.\n \t\t"}}}, "commit": {"commit_id": "a6e219deff9ad90fa4afc664af2cb5f90a93b6bc", "commit_author": "Vincent Wang", "commitT": "2020-09-02 21:54:40+08:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\optimizer\\constant_folding.cc", "file_new_name": "onnxruntime\\core\\optimizer\\constant_folding.cc", "file_complexity": {"file_NLOC": "131", "file_CCN": "28", "file_NToken": "1023"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "107", "deleted_lines": "107,108", "method_info": {"method_name": "onnxruntime::ConstantFolding::ApplyImpl", "method_params": "graph,modified,graph_level,logger", "method_startline": "58", "method_endline": "186", "method_complexity": {"method_NLOC": "85", "method_CCN": "22", "method_NToken": "716", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.cc", "file_new_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.cc", "file_complexity": {"file_NLOC": "111", "file_CCN": "15", "file_NToken": "1011"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "22,31,45,46,47,49,50", "deleted_lines": "30,44,46", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::Info", "method_params": "nodes,initialized_tensor_set,execution_provider", "method_startline": "20", "method_endline": "64", "method_complexity": {"method_NLOC": "35", "method_CCN": "4", "method_NToken": "341", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "22,31,45,46,47,49,50", "deleted_lines": "30,44,46", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::Info", "method_params": "nodes,initialized_tensor_set,model_path,execution_provider", "method_startline": "20", "method_endline": "68", "method_complexity": {"method_NLOC": "39", "method_CCN": "5", "method_NToken": "365", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.h", "file_new_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.h", "file_complexity": {"file_NLOC": "69", "file_CCN": "11", "file_NToken": "450"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "23,24,25", "deleted_lines": "23"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\test\\optimizer\\optimizer_test.cc", "file_new_name": "onnxruntime\\test\\optimizer\\optimizer_test.cc", "file_complexity": {"file_NLOC": "76", "file_CCN": "6", "file_NToken": "699"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "69", "deleted_lines": "69", "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "OptimizerTest,Basic", "method_startline": "28", "method_endline": "96", "method_complexity": {"method_NLOC": "54", "method_CCN": "6", "method_NToken": "644", "method_nesting_level": "2"}}}}}}}}