{"BR": {"BR_id": "4745", "BR_author": "JianhuiD", "BRopenT": "2020-08-10T18:55:34Z", "BRcloseT": "2020-08-27T19:38:42Z", "BR_text": {"BRsummary": "InferenceSession(GraphOptimizationLevel.ORT_ENABLE_BASIC) inserts Cast nodes with hard-coded name cause name conflict", "BRdescription": "\n Describe the bug\n ONNXRT  InferenceSession(GraphOptimizationLevel.ORT_ENABLE_BASIC) inserted Cast nodes with hard-coded name(both node name and output ) cause name conflict\n Urgency\n High\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows\n ONNX Runtime installed from (source or binary): binary\n ONNX Runtime version:  1.4.0\n Python version:  3.6.8\n Visual Studio version (if applicable): N/A\n GCC/Compiler version (if compiling from source): N/A\n CUDA/cuDNN version: N/A\n GPU model and memory: M/A\n \n To Reproduce\n \n \n Run InferenceSession(GraphOptimizationLevel.ORT_ENABLE_BASIC, as below)  on the attached model twice  - the 2nd runs on the generated-model  from 1st run.  2nd run emitted the error \"onnxruntime.capi.onnxruntime_pybind11_state.Fail: [ONNXRuntimeError] : 1 : FAIL : This is an invalid model. Error: Duplicate definition of name (CastDef_0)\"\n so = onnxrt.SessionOptions()\n so.graph_optimization_level = onnxrt.GraphOptimizationLevel.ORT_ENABLE_BASIC\n so.optimized_model_filepath = model_cf_filename\n onnxrt.InferenceSession(inputmodel, sess_options=so)\n \n The attached model contains Float16 Data, The root of this issue is that InferenceSession try to  insert Cast nodes, however, the inserted node's name(output) is hard-coded which cause name conflict.  And OnnxRT NOT not assume there is no \"CastDef_X\" output used in the original model.\n \n \n Attach the ONNX model to the issue (where applicable) to expedite investigation.\n test_model.zip\n \n \n Expected behavior\n Shall not see this failure\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "JianhuiD", "commentT": "2020-08-11T05:15:39Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/JianhuiD>@JianhuiD</denchmark-link>\n ,\n Thank you for providing the details. I can reproduce this error by your model and code.\n Let me dig deeper into this to see where the problem is.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "JianhuiD", "commentT": "2020-08-27T19:38:42Z", "comment_text": "\n \t\tClosed via <denchmark-link:https://github.com/microsoft/onnxruntime/pull/4811>#4811</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "744809ceaed2cda2b4874fdd67790c819f18a8b9", "commit_author": "Chun-Wei Chen", "commitT": "2020-08-24 07:25:41-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "onnxruntime\\core\\optimizer\\insert_cast_transformer.cc", "file_new_name": "onnxruntime\\core\\optimizer\\insert_cast_transformer.cc", "file_complexity": {"file_NLOC": "209", "file_CCN": "60", "file_NToken": "1674"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "13,14", "deleted_lines": "13,14,15", "method_info": {"method_name": "onnxruntime::IdGenerator::Next", "method_params": "", "method_startline": "13", "method_endline": "15", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "34", "deleted_lines": "31,37,38,39,40,41,43,48", "method_info": {"method_name": "onnxruntime::AddCastNode", "method_params": "graph,id_generator,old_arg,new_type,new_on_input,to_type,providerType", "method_startline": "30", "method_endline": "52", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "151", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "12,13,14", "deleted_lines": "11,12,13,14,15,16,17,18", "method_info": {"method_name": "onnxruntime::InsertCastTransformer::NeedInsertCast", "method_params": "node,input", "method_startline": "11", "method_endline": "18", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "61", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "73", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::ForceSingleNodeCPUFloat16ToFloat32", "method_params": "graph", "method_startline": "66", "method_endline": "79", "method_complexity": {"method_NLOC": "11", "method_CCN": "5", "method_NToken": "74", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "26,27,29,34", "deleted_lines": "20,22,23,24,31,37,38", "method_info": {"method_name": "onnxruntime::AddCastNode", "method_params": "graph,old_arg,new_type,new_on_input,to_type,providerType", "method_startline": "20", "method_endline": "38", "method_complexity": {"method_NLOC": "15", "method_CCN": "3", "method_NToken": "133", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "195,210,259,270", "deleted_lines": "208,224,226,274,277,286", "method_info": {"method_name": "onnxruntime::InsertCastTransformer::ApplyImpl", "method_params": "graph,modified,graph_level,logger", "method_startline": "184", "method_endline": "293", "method_complexity": {"method_NLOC": "76", "method_CCN": "17", "method_NToken": "510", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\optimizer\\insert_cast_transformer.h", "file_new_name": "onnxruntime\\core\\optimizer\\insert_cast_transformer.h", "file_complexity": {"file_NLOC": "17", "file_CCN": "1", "file_NToken": "97"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": null, "deleted_lines": "26"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\test\\framework\\insert_cast_transformer_test.cc", "file_new_name": "onnxruntime\\test\\framework\\insert_cast_transformer_test.cc", "file_complexity": {"file_NLOC": "160", "file_CCN": "17", "file_NToken": "1727"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "TransformerTest,InsertCastNodeTwice", "method_startline": "180", "method_endline": "206", "method_complexity": {"method_NLOC": "20", "method_CCN": "1", "method_NToken": "213", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "onnxruntime\\test\\testdata\\transform\\insert_cast_twice.onnx", "file_new_name": "onnxruntime\\test\\testdata\\transform\\insert_cast_twice.onnx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}}}}