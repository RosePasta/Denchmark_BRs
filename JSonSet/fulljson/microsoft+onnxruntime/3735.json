{"BR": {"BR_id": "3735", "BR_author": "katrasnikj", "BRopenT": "2020-04-28T14:49:56Z", "BRcloseT": "2020-05-11T02:08:38Z", "BR_text": {"BRsummary": "Loading float16 model fails", "BRdescription": "\n When constructing Ort::Session with a float16 ONNX model I get the following error\n <denchmark-code>Exception during initialization: C:\\...\\onnxruntime\\onnxruntime\\core\\optimizer\\optimizer_execution_frame.cc:73 onnxruntime::OptimizerExecutionFrame::Info::Info [ONNXRuntimeError] : 1 : FAIL : Failed to find kernel for Sub\n </denchmark-code>\n \n System information\n \n OS: Windows 10\n ONNX Runtime build from source (6b3b4fe)\n Visual Studio version 2019\n CUDA 10.2, cuDNN 7.6.5\n GPU model and memory: NVIDIA GeForce RTX 2080 Ti 11GB\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "katrasnikj", "commentT": "2020-04-28T20:40:08Z", "comment_text": "\n \t\tAdditional note. ONNX model of type float32 works on the aforementioned configuration.\n Both ONNX models are exported using pytorch 1.4.0 and opset version 11.\n Might be related to <denchmark-link:https://github.com/dotnet/machinelearning/issues/4795>dotnet/machinelearning#4795</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "katrasnikj", "commentT": "2020-05-04T21:23:05Z", "comment_text": "\n \t\tAre you using the CPU binary or the CUDA binary ? We do not yet have a CPU kernel implemented yet for Sub (for float16 type) but the CUDA binary should have it -\n \n \n \n onnxruntime/onnxruntime/core/providers/cuda/cuda_execution_provider.cc\n \n \n          Line 392\n       in\n       156368b\n \n \n \n \n \n \n  class ONNX_OPERATOR_TYPED_KERNEL_CLASS_NAME(kCudaExecutionProvider, kOnnxDomain, 7, MLFloat16, Sub); \n \n \n \n \n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "katrasnikj", "commentT": "2020-05-05T06:31:46Z", "comment_text": "\n \t\tWe use the CUDA binary. The following code shows how we create the Ort::Session\n   auto memory_info =\n     Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU);\n \n   environment_ = std::make_unique<Ort::Env>(ORT_LOGGING_LEVEL_FATAL);\n   Ort::SessionOptions options;\n   options.SetGraphOptimizationLevel(GraphOptimizationLevel::ORT_ENABLE_ALL);\n   OrtSessionOptionsAppendExecutionProvider_CUDA(options, 0);\n   session_ = std::make_unique<Ort::Session>(*environment_, onnx_model, model_size, options);\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "katrasnikj", "commentT": "2020-05-05T09:13:57Z", "comment_text": "\n \t\tCould you share the model or a minimalistic model that can repro it ? CUDA should have a Sub kernel\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "katrasnikj", "commentT": "2020-05-05T09:26:51Z", "comment_text": "\n \t\tYou can find a minimalistic model of type float16 (reuploaded the right model) <denchmark-link:https://github.com/donrax/onnxbug/blob/master/mfp16.onnx>here</denchmark-link>\n .\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "katrasnikj", "commentT": "2020-05-06T01:57:04Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/donrax>@donrax</denchmark-link>\n   - <denchmark-link:https://github.com/microsoft/onnxruntime/pull/3836>#3836</denchmark-link>\n  will get you past the model loading stage\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "katrasnikj", "commentT": "2020-05-06T05:04:24Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n  Thank you for the assistance\n \t\t"}}}, "commit": {"commit_id": "06985a992226ba57036f503e709839e0b6504d0d", "commit_author": "Hariharan Seshadri", "commitT": "2020-05-10 19:08:37-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\optimizer\\constant_folding.cc", "file_new_name": "onnxruntime\\core\\optimizer\\constant_folding.cc", "file_complexity": {"file_NLOC": "125", "file_CCN": "27", "file_NToken": "986"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "77,78,79,80,98,99,101,102,109,110,111,112,113,114,115,116,117,118,119,122,123,124,125,129,130,131", "deleted_lines": "77,78,79,80,97,98,99,100,101,103,105,106,107,108,115,117,122", "method_info": {"method_name": "onnxruntime::ConstantFolding::ApplyImpl", "method_params": "graph,modified,graph_level,logger", "method_startline": "49", "method_endline": "181", "method_complexity": {"method_NLOC": "87", "method_CCN": "22", "method_NToken": "734", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.cc", "file_new_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.cc", "file_complexity": {"file_NLOC": "104", "file_CCN": "13", "file_NToken": "982"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "21,22,23,24,25,27,68,69,70,71,72,73,74,75,76", "deleted_lines": "21,22,23,24,25,27,66,67,68,69,70,71,72,73,74,75", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::Info", "method_params": "nodes,initialized_tensor_set", "method_startline": "20", "method_endline": "76", "method_complexity": {"method_NLOC": "42", "method_CCN": "5", "method_NToken": "435", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "21,22,23,24,25,27", "deleted_lines": "21,22,23,24,25,27,66", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::Info", "method_params": "nodes,initialized_tensor_set,cpu_execution_provider", "method_startline": "20", "method_endline": "66", "method_complexity": {"method_NLOC": "36", "method_CCN": "4", "method_NToken": "369", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "79,80", "deleted_lines": "78,79,80,81,83", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::GetKernel", "method_params": "node_id", "method_startline": "78", "method_endline": "84", "method_complexity": {"method_NLOC": "6", "method_CCN": "2", "method_NToken": "44", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "68,69,70,71,72,73,74,75,76,77,79,80", "deleted_lines": "68,69,70,71,72,73,74,75,78,79,80,81", "method_info": {"method_name": "onnxruntime::OptimizerExecutionFrame::Info::CreateKernel", "method_params": "node", "method_startline": "68", "method_endline": "81", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "90", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.h", "file_new_name": "onnxruntime\\core\\optimizer\\optimizer_execution_frame.h", "file_complexity": {"file_NLOC": "65", "file_CCN": "10", "file_NToken": "424"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "23,24,52", "deleted_lines": "23,51,70"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\test\\optimizer\\optimizer_test.cc", "file_new_name": "onnxruntime\\test\\optimizer\\optimizer_test.cc", "file_complexity": {"file_NLOC": "76", "file_CCN": "6", "file_NToken": "670"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "67,68,69,75,77,78,79,80,81", "deleted_lines": "67,73,75", "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "OptimizerTest,Basic", "method_startline": "28", "method_endline": "96", "method_complexity": {"method_NLOC": "54", "method_CCN": "6", "method_NToken": "615", "method_nesting_level": "2"}}}}}}}}