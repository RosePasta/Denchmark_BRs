{"BR": {"BR_id": "1814", "BR_author": "fdwr", "BRopenT": "2019-09-11T21:56:25Z", "BRcloseT": "2019-09-17T04:51:27Z", "BR_text": {"BRsummary": "HardMax/LpNormalization fail with negative axis", "BRdescription": "\n Describe the bug\n HardMax fails with negative axis. It should call HandleNegativeAxis to resolve the value into an absolute positive axis.\n HRESULT=0x80004005 message=Exception during initialization: S:\\WindowsAI\\engine\\lotus\\onnxruntime\\core/providers/cpu/math/hardmax.h:24 onnxruntime::Hardmax<float>::Hardmax axis_ >= 0 was false. Invalid axis provided.\n \n \n \n onnxruntime/onnxruntime/core/providers/cpu/math/hardmax.h\n \n \n          Line 24\n       in\n       d9fa632\n \n \n \n \n \n \n  ORT_ENFORCE(axis_ >= 0, \"Invalid axis provided.\"); \n \n \n \n \n \n From ONNX spec: \"Accepted range in [-r, r-1] where r = rank(input).\"\n <denchmark-link:https://github.com/onnx/onnx/blob/master/docs/Operators.md#Hardmax>https://github.com/onnx/onnx/blob/master/docs/Operators.md#Hardmax</denchmark-link>\n \n Urgency\n Preferably before Vibranium release.\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10 2019-09-09\n ONNX Runtime installed from (source or binary): source\n ONNX Runtime version: 0.5\n Python version: NA\n Visual Studio version (if applicable): 2017 15.8.5\n GCC/Compiler version (if compiling from source): NA\n CUDA/cuDNN version: NA\n GPU model and memory: NA\n \n To Reproduce\n Pass negative axis value. e.g.\n <denchmark-code>// 2D array, axis 0 via negative axis.\n {\n   \"op_type\": \"Hardmax\",\n   \"axis\": -2,\n   \"input\":  [[0, 1, 2, -2, 2],\n              [0, 1, 2, -1, 3],\n              [0, 0, 3,  0, 0]],\n   \"output\": [[0, 0, 0, 0, 0],\n              [0, 0, 0, 0, 1],\n              [0, 0, 0, 0, 0]],\n   \"T\": \"float32\"\n },\n </denchmark-code>\n \n Expected behavior\n HardMax should call HandleNegativeAxis to resolve the value into an absolute positive axis. Note GPU operator passes this.\n \ud83d\udc4d ArgMax\n \ud83d\udc4d ArgMin\n \ud83d\udc4d Concat\n \ud83d\udc4d Flatten\n \ud83d\udc4d Gather\n \u2716 Hardmax\n \ud83d\udc4d LogSoftmax\n \u2716 LpNormalization\n \ud83d\udc4d OneHot\n \ud83d\udc4d ReduceL1\n \ud83d\udc4d ReduceL2\n \ud83d\udc4d ReduceLogSum\n \ud83d\udc4d ReduceLogSumExp\n \ud83d\udc4d ReduceMax\n \ud83d\udc4d ReduceMean\n \ud83d\udc4d ReduceMin\n \ud83d\udc4d ReduceProd\n \ud83d\udc4d ReduceSum\n \ud83d\udc4d ReduceSumSquare\n \ud83d\udc4d Scatter\n \ud83d\udc4d Slice\n \ud83d\udc4d Softmax\n \ud83d\udc4d Split\n \ud83d\udc4d TopK\n Additional context\n Found while testing WinML ONNX conformance GPU vs CPU.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "fdwr", "commentT": "2019-09-11T22:06:27Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/fdwr>@fdwr</denchmark-link>\n ,\n Actually the opset-10 HardMax spec is unclear - <denchmark-link:https://github.com/onnx/onnx/blob/rel-1.5.0/docs/Operators.md#Hardmax>https://github.com/onnx/onnx/blob/rel-1.5.0/docs/Operators.md#Hardmax</denchmark-link>\n .  The line you are referring to is from current master which means opset-11 HardMax needs to support it.\n Having said that, it does seem reasonable to support negative axis for HardMax-10 as well.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "fdwr", "commentT": "2019-09-11T22:14:31Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n  : True, that clarification was added recently. Though it's always been assumed, even when unstated, that operators with an  attribute should resolve negative values (and for consistency, Softmax works in ORT, so HardMax would be expected to for consistency).\n I tested the following for negative axes and found HardMax was the only one missing the check: ArgMin, ArgMax, Concat, Gather, Hardmax, LogSoftmax, ReduceL1, ReduceL2, ReduceLogSum, ReduceLogSumExp, ReduceMax, ReduceMean, ReduceMin, ReduceProd, ReduceSum, ReduceSumSquare, Scatter, Slice, Softmax, Split, TopK\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "fdwr", "commentT": "2019-09-11T22:18:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/fdwr>@fdwr</denchmark-link>\n  - makes sense to add it then :). Will do it.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "fdwr", "commentT": "2019-09-12T00:04:28Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n  : Found one more (after double checking and sweeping through all of Operators.md for anything with an  attribute) after adding LpNormalization, OneHot, Flatten.\n LpNormalization accepts -1 but rejects -2.\n \n \n \n onnxruntime/onnxruntime/core/providers/cpu/nn/lp_norm.cc\n \n \n          Line 58\n       in\n       2b8677b\n \n \n \n \n \n \n  const auto canonical_axis = axis_ != -1 ? axis_ : (input_shape.NumDimensions() - 1); \n \n \n \n \n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "fdwr", "commentT": "2019-09-17T04:51:27Z", "comment_text": "\n \t\tFixed via <denchmark-link:https://github.com/microsoft/onnxruntime/pull/1835>#1835</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "d646dc73e45aa0fa36db679e92197a298198e627", "commit_author": "ybrnathan", "commitT": "2019-09-16 21:36:15-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.6463414634146342", "commit_Nprams": "0.8536585365853658"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\providers\\cpu\\cpu_execution_provider.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\cpu_execution_provider.cc", "file_complexity": {"file_NLOC": "718", "file_CCN": "9", "file_NToken": "10180"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "404,405,412,455,456,457,458,609,610,611,612,613,614,615", "deleted_lines": "397,398,405,448,449,450,451", "method_info": {"method_name": "onnxruntime::RegisterOnnxOperatorKernels", "method_params": "kernel_registry", "method_startline": "318", "method_endline": "621", "method_complexity": {"method_NLOC": "297", "method_CCN": "2", "method_NToken": "4601", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\providers\\cpu\\math\\hardmax.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\math\\hardmax.cc", "file_complexity": {"file_NLOC": "49", "file_CCN": "7", "file_NToken": "430"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "17,18,19", "deleted_lines": "16,17,51", "method_info": {"method_name": "onnxruntime::Hardmax<float>::Compute", "method_params": "ctx", "method_startline": "12", "method_endline": "51", "method_complexity": {"method_NLOC": "31", "method_CCN": "7", "method_NToken": "352", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\providers\\cpu\\math\\hardmax.h", "file_new_name": "onnxruntime\\core\\providers\\cpu\\math\\hardmax.h", "file_complexity": {"file_NLOC": "19", "file_CCN": "2", "file_NToken": "101"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "22,23,24", "method_info": {"method_name": "onnxruntime::Hardmax::Hardmax", "method_params": "info", "method_startline": "15", "method_endline": "25", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "69", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\providers\\cpu\\math\\logsoftmax.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\math\\logsoftmax.cc", "file_complexity": {"file_NLOC": "40", "file_CCN": "2", "file_NToken": "327"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "45,48,52,53,54,55,56,57", "deleted_lines": "45"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\providers\\cpu\\math\\softmax.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\math\\softmax.cc", "file_complexity": {"file_NLOC": "41", "file_CCN": "2", "file_NToken": "344"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "46,49,50,51,52,53,54,55,56", "deleted_lines": "46"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\core\\providers\\cpu\\nn\\lp_norm.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\nn\\lp_norm.cc", "file_complexity": {"file_NLOC": "61", "file_CCN": "9", "file_NToken": "547"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "59", "deleted_lines": "58", "method_info": {"method_name": "onnxruntime::LpNorm<float>::Compute", "method_params": "p_op_kernel_context", "method_startline": "54", "method_endline": "71", "method_complexity": {"method_NLOC": "15", "method_CCN": "3", "method_NToken": "194", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\providers\\cpu\\reduction\\reduction_ops.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\reduction\\reduction_ops.cc", "file_complexity": {"file_NLOC": "332", "file_CCN": "55", "file_NToken": "2948"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,73,74,75,76", "deleted_lines": "56,57"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "onnxruntime\\test\\providers\\cpu\\math\\hardmax_test.cc", "file_new_name": "onnxruntime\\test\\providers\\cpu\\math\\hardmax_test.cc", "file_complexity": {"file_NLOC": "116", "file_CCN": "9", "file_NToken": "1700"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "26,27,28,29,30,31,32", "deleted_lines": "26", "method_info": {"method_name": "onnxruntime::test::RunTest", "method_params": "x_vals,expected_vals,dimensions,axis,expect_result,expected_err_str", "method_startline": "12", "method_endline": "33", "method_complexity": {"method_NLOC": "18", "method_CCN": "3", "method_NToken": "146", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "144,145,146,147,148,149", "deleted_lines": "138,139,140,141,143,144,145,146,147,148", "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "HardmaxOperator,InvalidAxis", "method_startline": "138", "method_endline": "149", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "87", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,164", "deleted_lines": "144,145,146,147,148", "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "HardmaxOperator,ThreeDimsNegAxis2", "method_startline": "144", "method_endline": "165", "method_complexity": {"method_NLOC": "16", "method_CCN": "1", "method_NToken": "270", "method_nesting_level": "2"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\test\\providers\\cpu\\nn\\lp_norm_op_test.cc", "file_new_name": "onnxruntime\\test\\providers\\cpu\\nn\\lp_norm_op_test.cc", "file_complexity": {"file_NLOC": "88", "file_CCN": "4", "file_NToken": "1107"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "LpNormalizationTest,L1NormalizationWithValidNegativeAxis", "method_startline": "84", "method_endline": "108", "method_complexity": {"method_NLOC": "21", "method_CCN": "1", "method_NToken": "301", "method_nesting_level": "2"}}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "onnxruntime\\test\\providers\\cpu\\reduction\\reduction_ops_test.cc", "file_new_name": "onnxruntime\\test\\providers\\cpu\\reduction\\reduction_ops_test.cc", "file_complexity": {"file_NLOC": "1037", "file_CCN": "85", "file_NToken": "10297"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25,26,28,30,31,32,39,40,41,42,43,44,45", "deleted_lines": "26,34", "method_info": {"method_name": "onnxruntime::test::TestReduceOp", "method_params": "op,input_dims,data,axes,keepdims,expected_dims,expected_data", "method_startline": "15", "method_endline": "46", "method_complexity": {"method_NLOC": "28", "method_CCN": "6", "method_NToken": "228", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1120,1121,1122,1123,1124,1125,1126,1127,1128,1129,1130,1131,1132,1133,1134,1135,1136,1137,1138,1139,1140", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "ReductionOpTest,ArgMax_int32_neg_axis", "method_startline": "1120", "method_endline": "1140", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "146", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1120,1121,1122,1123,1124,1125,1126,1127,1128,1129,1130,1131,1132,1133,1134,1135,1136,1137,1138,1139,1140,1141,1222,1223,1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1239,1240,1241,1242", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "ReductionOpTest,ReduceSumSquare_double", "method_startline": "864", "method_endline": "1243", "method_complexity": {"method_NLOC": "37", "method_CCN": "1", "method_NToken": "169", "method_nesting_level": "2"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1222,1223,1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1239,1240,1241", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "ReductionOpTest,ArgMin_int32_neg_axis", "method_startline": "1222", "method_endline": "1241", "method_complexity": {"method_NLOC": "17", "method_CCN": "1", "method_NToken": "140", "method_nesting_level": "3"}}}}}}}}