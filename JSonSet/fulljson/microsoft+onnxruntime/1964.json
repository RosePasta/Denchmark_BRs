{"BR": {"BR_id": "1964", "BR_author": "neginraoof", "BRopenT": "2019-10-01T07:46:04Z", "BRcloseT": "2019-10-10T23:07:43Z", "BR_text": {"BRsummary": "Error parsing onnx::range inputs", "BRdescription": "\n Describe the bug\n I have an ONNX model exported as below:\n graph(%0 : Float(),\n %1 : Float(),\n %2 : Float()):\n %3 : Tensor = onnx::Cast<denchmark-link:%2>to=1</denchmark-link>\n , scope: ArangeModel\n %4 : FloatTensor = onnx::Range(%0, %1, %3), scope: ArangeModel\n %5 : Float(7) = onnx::Cast<denchmark-link:%4>to=1</denchmark-link>\n , scope: ArangeModel\n return (%5)\n The ONNX model does match the specs for Range fundtion. All inputs are of the same type.\n I see the following error when running the model.\n onnxruntime::FunctionImpl::FunctionImpl(const onnxruntime::Graph&, const NodeIndex&, const onnx::FunctionProto*) status.IsOK() was false. Resolve subgraph failed:This is an invalid model. Error in Node:0x5579ee8c0630_1 : Nodes in a graph must be topologically sorted, however input 'delta' of node:\n prev\n deltacurrent\"Add\n is not output of any previous nodes.\n Looks like ORT does not have a kernel implementation for Range yet, and this error is caused when parsing the set of alternative subnodes.\n Urgency\n We wanted to address this issue before kernel implementation for Range is in. Once we have the kernel, we cannot hit the same group of ops to reproduce this issue.\n System information\n \n OS Platform and Distribution: Linux Ubuntu 18.04\n ONNX Runtime version: ort-nightly 0.5.0.dev917\n Python version: 3.7\n \n \n Try loading and running the onnx model:\n <denchmark-link:https://microsoft-my.sharepoint.com/:f:/p/neraoof/EgIIYkQ7N2xMlrneJJg3qfEBRrZSOoWMm4OFsM2Pf46uFA?e=Fw0aVo>https://microsoft-my.sharepoint.com/:f:/p/neraoof/EgIIYkQ7N2xMlrneJJg3qfEBRrZSOoWMm4OFsM2Pf46uFA?e=Fw0aVo</denchmark-link>\n \n Additional context\n Just wanted to note that this issue is only caused since the ORT doesn't have a kernel implementation for Range yet. Implementing the kernel will only fix the symptoms here, but we want to look into any potential bugs parsing the set of ops we're hitting currently\n (why is there an error parsing inputs to \"Add\").\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "neginraoof", "commentT": "2019-10-01T18:59:41Z", "comment_text": "\n \t\tHi Negin,\n Pasting the contents of the internal email for visibility:\n There is a known issue (possibly multiple issues) in ORT with regards to handling ops with function bodies. But once a kernel is implemented for Range it should go away.\n Some background context : since ORT currently implements kernels for every op (even ops with function bodies), looking into the issue(s) with handling function bodies was de-prioritized when we had this discussion a while back. But it is something to be looked at eventually.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "neginraoof", "commentT": "2019-10-02T04:37:08Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "neginraoof", "commentT": "2019-10-08T22:19:21Z", "comment_text": "\n \t\tWe are still facing this issue even after the kernel implementation is in place.\n <denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n  is working on the fix for resolving range function inputs.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "neginraoof", "commentT": "2019-10-08T22:23:41Z", "comment_text": "\n \t\tIt seems like this issue is very specific to the Range op. It will affect any op with a function body that contains nodes with subgraphs - currently (at the time of opset-11) only Range in ONNX has this specialty.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "neginraoof", "commentT": "2019-10-09T16:20:02Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n \n Thanks for looking into this. I was able to run the model below with the fix from PR <denchmark-link:https://github.com/microsoft/onnxruntime/pull/2053>#2053</denchmark-link>\n \n <denchmark-link:https://user-images.githubusercontent.com/16928382/66499989-a877af80-ea75-11e9-8997-8723f62e75e0.png></denchmark-link>\n \n However, another model I have (this one has multiple Range nodes) is still failing to run with the same error:\n <denchmark-link:https://user-images.githubusercontent.com/16928382/66500083-d3fa9a00-ea75-11e9-9708-81f2f83b54ac.png></denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "neginraoof", "commentT": "2019-10-09T18:39:39Z", "comment_text": "\n \t\tInvestigating.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "neginraoof", "commentT": "2019-10-09T21:21:31Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/hariharans29>@hariharans29</denchmark-link>\n  for looking into this, the latest updates fixed this issue.\n \t\t"}}}, "commit": {"commit_id": "2ba705ed99046c1935abdd838ff0855a05c9ee19", "commit_author": "Hariharan Seshadri", "commitT": "2019-10-10 16:07:42-07:00", "commit_complexity": {"commit_NLOC": "0.13725490196078433", "commit_CCN": "0.13725490196078433", "commit_Nprams": "0.13725490196078433"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "onnxruntime\\core\\graph\\function.cc", "file_new_name": "onnxruntime\\core\\graph\\function.cc", "file_complexity": {"file_NLOC": "314", "file_CCN": "61", "file_NToken": "3040"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "165,166,169,170,176,177,180,181,187,188,197,201,204,210,215,221,223,224,225,226,228,231,232,233,234,237,238,240,241,288,289,290", "deleted_lines": "160,165,166,167,168,171,172,174,175,222,223,224,225,230,233,234,236,240,241,245,246,247,248,249,252,257,258,262,263,264,265,266,269,276,277,278,280,283,286,288,290", "method_info": {"method_name": "onnxruntime::FunctionImpl::FunctionImpl", "method_params": "graph,node_index,onnx_func_proto", "method_startline": "158", "method_endline": "290", "method_complexity": {"method_NLOC": "120", "method_CCN": "20", "method_NToken": "1152", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "385", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::FunctionImpl::GetFuncProto", "method_params": "", "method_startline": "384", "method_endline": "386", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "12", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145", "deleted_lines": "104,105,108,109,115,116,119,120,126,127,136,140,143", "method_info": {"method_name": "onnxruntime::update_subgraphs_within_function_body", "method_params": "subgraph_proto,parent_graph,function_node_in_parent_graph,input_name_idx_map,output_name_idx_map", "method_startline": "99", "method_endline": "145", "method_complexity": {"method_NLOC": "38", "method_CCN": "9", "method_NToken": "364", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "13,17,18,22,24,80", "deleted_lines": "13,17,18,22,24,80", "method_info": {"method_name": "onnxruntime::IOTypeConstraintHelper", "method_params": "onnx_func_proto_,op_schema_,input_name_idx_map,output_name_idx_map", "method_startline": "13", "method_endline": "84", "method_complexity": {"method_NLOC": "65", "method_CCN": "18", "method_NToken": "675", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "149,154,155,156,165,166,169,170,176,177,180,181,187,188,197,201,204,210,215", "deleted_lines": "149,154,160,165,166,167,168,171,172,174,175", "method_info": {"method_name": "onnxruntime::FunctionImpl::FunctionImpl", "method_params": "graph,customized_func", "method_startline": "147", "method_endline": "217", "method_complexity": {"method_NLOC": "61", "method_CCN": "8", "method_NToken": "608", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "13,17,18,22,24,80", "deleted_lines": "13,17,18,22,24,80", "method_info": {"method_name": "onnxruntime::IOTypeConstraintHelper", "method_params": "onnx_func_proto_,op_schema_,input_name_idx_map,output_name_idx_map", "method_startline": "13", "method_endline": "84", "method_complexity": {"method_NLOC": "65", "method_CCN": "18", "method_NToken": "675", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "221,223,224,225,226,228,231,232,233,234,237,238,240,241,288,289,290,291,296,297,298,299,300,301,304,305,307,311,312,316,317,318,319,322,327,328,332,333,334,335,338,345,346,347,348,349,350,351,352,353,354,355,357,360,363,365,366,368", "deleted_lines": "222,223,224,225,230,233,234,236,240,241,245,246,247,248,249,252,257,258,262,263,264,265,266,269,276,277,278,280,283,286,288,290,307", "method_info": {"method_name": "onnxruntime::FunctionImpl::FunctionImpl", "method_params": "graph,node_index,onnx_func_proto", "method_startline": "219", "method_endline": "368", "method_complexity": {"method_NLOC": "126", "method_CCN": "21", "method_NToken": "1256", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "onnxruntime\\core\\graph\\function_impl.h", "file_new_name": "onnxruntime\\core\\graph\\function_impl.h", "file_complexity": {"file_NLOC": "27", "file_CCN": "0", "file_NToken": "161"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "23,40", "deleted_lines": "23,40"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "onnxruntime\\core\\graph\\graph.cc", "file_new_name": "onnxruntime\\core\\graph\\graph.cc", "file_complexity": {"file_NLOC": "1866", "file_CCN": "470", "file_NToken": "14514"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "672,673", "deleted_lines": "672,673", "method_info": {"method_name": "onnxruntime::Graph::Graph", "method_params": "graph_proto,domain_to_version,ir_version,schema_registry,parent_graph,parent_node,model_functions", "method_startline": "647", "method_endline": "744", "method_complexity": {"method_NLOC": "68", "method_CCN": "17", "method_NToken": "590", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1725,1746", "deleted_lines": "1725,1746", "method_info": {"method_name": "onnxruntime::Graph::VerifyNodeAndOpMatch", "method_params": "", "method_startline": "1691", "method_endline": "1796", "method_complexity": {"method_NLOC": "72", "method_CCN": "15", "method_NToken": "657", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "onnxruntime\\test\\ir\\onnx_model_test.cc", "file_new_name": "onnxruntime\\test\\ir\\onnx_model_test.cc", "file_complexity": {"file_NLOC": "124", "file_CCN": "11", "file_NToken": "1164"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "170,171,172,173,174,175,176,177,178", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "ONNXModelsTest,TestModelsWithAnOpContainingAFunctionBody", "method_startline": "170", "method_endline": "178", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "64", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "onnxruntime\\test\\testdata\\model_containing_op_with_function_body.onnx", "file_new_name": "onnxruntime\\test\\testdata\\model_containing_op_with_function_body.onnx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}}}}