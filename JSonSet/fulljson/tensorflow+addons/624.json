{"BR": {"BR_id": "624", "BR_author": "hankcs", "BRopenT": "2019-10-26T04:10:50Z", "BRcloseT": "2019-11-13T14:09:40Z", "BR_text": {"BRsummary": "WeightNormalization layer can't save in h5", "BRdescription": "\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04):\n Ubuntu 16.04.6 LTS\n TensorFlow version and how it was installed (source or binary):\n tensorflow-gpu                   2.0.0, binary\n TensorFlow-Addons version and how it was installed (source or binary):\n tensorflow-addons                0.6.0, binary\n Python version:\n Python 3.6.9\n Is GPU used? (yes/no):\n yes\n Describe the bug\n WeightNormalization layer can't save to h5\n \n A clear and concise description of what the bug is.\n WeightNormalization causing duplicate names of variables.\n Code to reproduce the issue\n import tensorflow as tf\n import tensorflow_addons as tfa\n \n conv = tf.keras.layers.Conv1D(1, 1, name='conv')\n wn_conv = tfa.layers.WeightNormalization(conv)\n \n model = tf.keras.Sequential(layers=[wn_conv])\n model.build([1, 2, 3])\n print([w.name for w in model.layers[0].weights])\n model.save_weights('model.h5')\n Provide a reproducible test case that is the bare minimum necessary to generate the problem.\n See above.\n Other info / logs\n <denchmark-code>['weight_normalization/g:0', 'weight_normalization/kernel:0', 'weight_normalization/bias:0', 'weight_normalization/initialized:0', 'weight_normalization/kernel:0', 'weight_normalization/bias:0']\n Traceback (most recent call last):\n   File \"/home/ubuntu/hankcs/laser/tests/playground/wn_bug.py\", line 14, in <module>\n     model.save_weights('model.h5')\n   File \"/home/ubuntu/.local/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/network.py\", line 1074, in save_weights\n     saving.save_weights_to_hdf5_group(f, self.layers)\n   File \"/home/ubuntu/.local/lib/python3.6/site-packages/tensorflow_core/python/keras/saving/hdf5_format.py\", line 631, in save_weights_to_hdf5_group\n     param_dset = g.create_dataset(name, val.shape, dtype=val.dtype)\n   File \"/home/ubuntu/.local/lib/python3.6/site-packages/h5py/_hl/group.py\", line 139, in create_dataset\n     self[name] = dset\n   File \"/home/ubuntu/.local/lib/python3.6/site-packages/h5py/_hl/group.py\", line 371, in __setitem__\n     h5o.link(obj.id, self.id, name, lcpl=lcpl, lapl=self._lapl)\n   File \"h5py/_objects.pyx\", line 54, in h5py._objects.with_phil.wrapper\n   File \"h5py/_objects.pyx\", line 55, in h5py._objects.with_phil.wrapper\n   File \"h5py/h5o.pyx\", line 202, in h5py.h5o.link\n RuntimeError: Unable to create link (name already exists)\n </denchmark-code>\n \n There are 2 weight_normalization/kernel:0.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hankcs", "commentT": "2019-10-28T00:06:52Z", "comment_text": "\n \t\tThanks for reporting <denchmark-link:https://github.com/hankcs>@hankcs</denchmark-link>\n ! I'll take a look at this when time allows, but if anyone else is interested in investigating/patching it'd be much appreciated, just post your findings in this issue.\n \t\t"}}}, "commit": {"commit_id": "81566818909dd7596de2535157994859112c66e6", "commit_author": "Dheeraj R Reddy", "commitT": "2019-11-13 09:09:39-05:00", "commit_complexity": {"commit_NLOC": "0.7777777777777778", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow_addons\\layers\\wrappers.py", "file_new_name": "tensorflow_addons\\layers\\wrappers.py", "file_complexity": {"file_NLOC": "128", "file_CCN": "15", "file_NToken": "836"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "96,97,98,99,100,101,102,103", "deleted_lines": "96,97,98,99,100,101", "method_info": {"method_name": "build", "method_params": "self,input_shape", "method_startline": "62", "method_endline": "105", "method_complexity": {"method_NLOC": "34", "method_CCN": "4", "method_NToken": "280", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow_addons\\layers\\wrappers_test.py", "file_new_name": "tensorflow_addons\\layers\\wrappers_test.py", "file_complexity": {"file_NLOC": "66", "file_CCN": "8", "file_NToken": "527"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "84,85,86,87,88,89,90", "deleted_lines": null, "method_info": {"method_name": "test_save_file_h5", "method_params": "self", "method_startline": "84", "method_endline": "90", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "65", "method_nesting_level": "1"}}}}}}}}