{"BR": {"BR_id": "694", "BR_author": "guillaumekln", "BRopenT": "2019-11-12T13:26:03Z", "BRcloseT": "2019-12-21T15:38:58Z", "BR_text": {"BRsummary": "CRF functions fail on sequences of length 1 when the static dimension is undefined", "BRdescription": "\n System information\n \n OS Platform and Distribution: Ubuntu 16.04\n TensorFlow version and how it was installed: 2.0.0 (binary)\n TensorFlow-Addons version and how it was installed: 0.6.0 (binary)\n Python version: 3.5.2\n Is GPU used?: No\n \n Describe the bug\n Some CRF functions have a special case for sequence length = 1. However, this code path is not enabled when the static dimension is undefined and a InvalidArgumentError exception is raised. It can happen when CRF functions are used in tf.function.\n Conditions like:\n if inputs.shape[1] == 1:\n should probably be:\n if tf.shape(inputs)[1] == 1:\n Code to reproduce the issue\n import tensorflow as tf\n import tensorflow_addons as tfa\n \n num_tags = 10\n input_signature = (\n     tf.TensorSpec([None, None, num_tags]),\n     tf.TensorSpec([num_tags, num_tags]),\n     tf.TensorSpec([None], dtype=tf.int32))\n crf_decode = tf.function(input_signature=input_signature)(tfa.text.crf_decode)\n \n batch_size = 4\n potentials = tf.random.uniform([batch_size, 1, num_tags])\n transition_params = tf.random.uniform([num_tags, num_tags])\n sequence_length = tf.ones([batch_size], dtype=tf.int32)\n \n crf_decode(potentials, transition_params, sequence_length)\n Other info / logs\n <denchmark-code>2019-11-12 14:17:08.541583: W tensorflow/core/common_runtime/base_collective_executor.cc:216] BaseCollectiveExecutor::StartAbort Invalid argument: Tried to stack elements of an empty list with non-fully-defined element_shape: [?,10]\n          [[{{node rnn/TensorArrayV2Stack/TensorListStack}}]]\n          [[concat/_30]]\n 2019-11-12 14:17:08.541618: W tensorflow/core/common_runtime/base_collective_executor.cc:216] BaseCollectiveExecutor::StartAbort Invalid argument: Tried to stack elements of an empty list with non-fully-defined element_shape: [?,10]\n          [[{{node rnn/TensorArrayV2Stack/TensorListStack}}]]\n Traceback (most recent call last):\n   File \"test/crf.py\", line 15, in <module>\n     crf_decode(potentials, transition_params, sequence_length)\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/def_function.py\", line 457, in __call__\n     result = self._call(*args, **kwds)\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/def_function.py\", line 526, in _call\n     return self._concrete_stateful_fn._filtered_call(canon_args, canon_kwds)  # pylint: disable=protected-access\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/function.py\", line 1141, in _filtered_call\n     self.captured_inputs)\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/function.py\", line 1224, in _call_flat\n     ctx, args, cancellation_manager=cancellation_manager)\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/function.py\", line 511, in call\n     ctx=ctx)\n   File \"lib/python3.5/site-packages/tensorflow_core/python/eager/execute.py\", line 67, in quick_execute\n     six.raise_from(core._status_to_exception(e.code, message), None)\n   File \"<string>\", line 3, in raise_from\n tensorflow.python.framework.errors_impl.InvalidArgumentError: 2 root error(s) found.\n   (0) Invalid argument:  Tried to stack elements of an empty list with non-fully-defined element_shape: [?,10]\n          [[node rnn/TensorArrayV2Stack/TensorListStack (defined at lib/python3.5/site-packages/tensorflow_core/python/framework/ops.py:1751) ]]\n          [[concat/_30]]\n   (1) Invalid argument:  Tried to stack elements of an empty list with non-fully-defined element_shape: [?,10]\n          [[node rnn/TensorArrayV2Stack/TensorListStack (defined at lib/python3.5/site-packages/tensorflow_core/python/framework/ops.py:1751) ]]\n 0 successful operations.\n 0 derived errors ignored. [Op:__inference_crf_decode_264]\n \n Function call stack:\n crf_decode -> crf_decode\n </denchmark-code>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "7f68da6c717c232bc0760ca1ab9ad13ce26f221a", "commit_author": "Dheeraj R Reddy", "commitT": "2019-12-21 10:38:57-05:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.7692307692307693"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tensorflow_addons\\text\\crf.py", "file_new_name": "tensorflow_addons\\text\\crf.py", "file_complexity": {"file_NLOC": "217", "file_CCN": "31", "file_NToken": "2251"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "475", "deleted_lines": "468,469,470,471,474,481", "method_info": {"method_name": "crf_decode._multi_seq_fn", "method_params": "", "method_startline": "468", "method_endline": "493", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "226", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "110,111", "deleted_lines": "109,115", "method_info": {"method_name": "_multi_seq_fn", "method_params": "", "method_startline": "109", "method_endline": "115", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "47,48,49,50,51,52,53,54,55", "deleted_lines": "47,49,50,51,52,53", "method_info": {"method_name": "_single_seq_fn", "method_params": "", "method_startline": "46", "method_endline": "60", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "139", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "445,461,462,464,465,466,475,495,496,497,498,499,500,501,503,504,505", "deleted_lines": "447,448,449,465,466,468,469,470,471,474,481,501,502,504", "method_info": {"method_name": "crf_decode", "method_params": "potentials,transition_params,sequence_length", "method_startline": "444", "method_endline": "505", "method_complexity": {"method_NLOC": "13", "method_CCN": "3", "method_NToken": "87", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "138,139,163,164", "deleted_lines": "138,139,163,164", "method_info": {"method_name": "crf_log_norm", "method_params": "inputs,sequence_lengths,transition_params", "method_startline": "121", "method_endline": "164", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "92", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "464,465,466", "deleted_lines": "465,466", "method_info": {"method_name": "crf_decode._single_seq_fn", "method_params": "", "method_startline": "463", "method_endline": "466", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "55", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow_addons\\text\\crf_test.py", "file_new_name": "tensorflow_addons\\text\\crf_test.py", "file_complexity": {"file_NLOC": "304", "file_CCN": "26", "file_NToken": "3058"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "364,365,366,367,368,369,370,371,372,373,374,375", "deleted_lines": null, "method_info": {"method_name": "testTfFunction", "method_params": "self", "method_startline": "364", "method_endline": "375", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "122", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "359", "deleted_lines": "359,360,361", "method_info": {"method_name": "testDifferentDtype", "method_params": "self", "method_startline": "356", "method_endline": "362", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "86", "method_nesting_level": "1"}}}}}}}}