{"BR": {"BR_id": "1824", "BR_author": "ClementWalter", "BRopenT": "2020-05-13T09:00:27Z", "BRcloseT": "2020-05-24T17:59:40Z", "BR_text": {"BRsummary": "Cannot use random_cutout in keras training", "BRdescription": "\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\n TensorFlow version and how it was installed (source or binary): 2.1 from pip\n TensorFlow-Addons version and how it was installed (source or binary): 0.9.1 from pip\n Python version: Python 3.6.10 (default, Dec 19 2019, 23:04:32) [GCC 5.4.0 20160609] on linux\n Is GPU used? (yes/no): yes\n \n Describe the bug\n Cannot use the tfa.image.random_cutout is tf.keras.Sequential.fit;\n Code to reproduce the issue\n This MWE works:\n <denchmark-code>import tensorflow as tf\n import tensorflow_addons as tfa\n from tensorflow.keras.models import Sequential\n from tensorflow.keras.layers import Conv2D, Dense, GlobalMaxPooling2D, Flatten\n \n @tf.function\n def preprocessing(image):\n    return tf.image.convert_image_dtype(image, tf.float32)\n \n \n X = tf.cast(tf.random.uniform(shape=(10, 224, 224, 3), minval=0, maxval=255), tf.uint8)\n y = tf.random.uniform(shape=(10,))\n dataset = tf.data.Dataset.from_tensor_slices((X, y)).map(lambda x, y: (preprocessing(x), y)).batch(3)\n model = Sequential([Conv2D(10, (3, 3)), GlobalMaxPooling2D(), Flatten(), Dense(1)])\n model.compile(loss=\"mse\", optimizer=\"adam\")\n model.fit(dataset)\n </denchmark-code>\n \n When I try to add the random_cutout, ie:\n <denchmark-code>@tf.function\n def preprocessing(image):\n     return tf.image.convert_image_dtype(tf.squeeze(tfa.image.random_cutout(tf.expand_dims(image, 0), mask_size=(20, 20))), tf.float32)\n </denchmark-code>\n \n it fails\n Other info / logs\n <denchmark-code>Traceback (most recent call last):\n   File \"test.py\", line 16, in <module>\n     model.fit(dataset)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training.py\", line 819, in fit\n     use_multiprocessing=use_multiprocessing)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_v2.py\", line 235, in fit\n     use_multiprocessing=use_multiprocessing)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_v2.py\", line 593, in _process_training_inputs\n     use_multiprocessing=use_multiprocessing)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_v2.py\", line 706, in _process_inputs\n     use_multiprocessing=use_multiprocessing)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/data_adapter.py\", line 702, in __init__\n     x = standardize_function(x)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_v2.py\", line 684, in standardize_function\n     return dataset.map(map_fn, num_parallel_calls=dataset_ops.AUTOTUNE)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/data/ops/dataset_ops.py\", line 1591, in map\n     self, map_func, num_parallel_calls, preserve_cardinality=True)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/data/ops/dataset_ops.py\", line 3926, in __init__\n     use_legacy_function=use_legacy_function)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/data/ops/dataset_ops.py\", line 3147, in __init__\n     self._function = wrapper_fn._get_concrete_function_internal()\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/eager/function.py\", line 2395, in _get_concrete_function_internal\n     *args, **kwargs)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/eager/function.py\", line 2389, in _get_concrete_function_internal_garbage_collected\n     graph_function, _, _ = self._maybe_define_function(args, kwargs)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/eager/function.py\", line 2703, in _maybe_define_function\n     graph_function = self._create_graph_function(args, kwargs)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/eager/function.py\", line 2593, in _create_graph_function\n     capture_by_value=self._capture_by_value),\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/framework/func_graph.py\", line 978, in func_graph_from_py_func\n     func_outputs = python_func(*func_args, **func_kwargs)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/data/ops/dataset_ops.py\", line 3140, in wrapper_fn\n     ret = _wrapper_helper(*args)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/data/ops/dataset_ops.py\", line 3082, in _wrapper_helper\n     ret = autograph.tf_convert(func, ag_ctx)(*nested_args)\n   File \"/home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/autograph/impl/api.py\", line 237, in wrapper\n     raise e.ag_error_metadata.to_exception(e)\n ValueError: in converted code:\n \n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_v2.py:677 map_fn\n         batch_size=None)\n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training.py:2410 _standardize_tensors\n         exception_prefix='input')\n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_utils.py:529 standardize_input_data\n         data = [standardize_single_array(x) for x in data]\n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_utils.py:529 <listcomp>\n         data = [standardize_single_array(x) for x in data]\n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/keras/engine/training_utils.py:451 standardize_single_array\n         if (x.shape is not None and len(x.shape) == 1 and\n     /home/clementw/Keras-FewShotLearning/venv/lib/python3.6/site-packages/tensorflow_core/python/framework/tensor_shape.py:822 __len__\n         raise ValueError(\"Cannot take the length of shape with unknown rank.\")\n \n     ValueError: Cannot take the length of shape with unknown rank.\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ClementWalter", "commentT": "2020-05-13T09:23:48Z", "comment_text": "\n \t\tI don't know if It Is caused  by the missing img_utils.from_4D_image.\n There was a big thread closed yesterday about  with unknown ranks at <denchmark-link:https://github.com/tensorflow/tensorflow/issues/24520>tensorflow/tensorflow#24520</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ClementWalter", "commentT": "2020-05-13T11:05:23Z", "comment_text": "\n \t\tI have updated tensorflow to 2.2 and the error is different:\n <denchmark-code>ValueError: Input 0 of layer sequential is incompatible with the layer: its rank is undefined, but the layer requires a defined rank.\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ClementWalter", "commentT": "2020-05-13T12:19:46Z", "comment_text": "\n \t\t<denchmark-code>def preprocessing(image):\n     cout_out = tfa.image.random_cutout(tf.expand_dims(image, 0), mask_size=(20, 20))\n     output = tfa.image.utils.from_4D_image(cout_out,tfa.image.utils.get_ndims(image))\n     return tf.dtypes.cast(output, tf.dtypes.float32)\n </denchmark-code>\n \n Can you send a PR with something like <denchmark-link:https://github.com/tensorflow/addons/blob/master/tensorflow_addons/image/transform_ops.py#L117>https://github.com/tensorflow/addons/blob/master/tensorflow_addons/image/transform_ops.py#L117</denchmark-link>\n  for cut_out?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ClementWalter", "commentT": "2020-05-13T17:26:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ClementWalter>@ClementWalter</denchmark-link>\n  if you need any feedback for the PR you could reach us also on <denchmark-link:https://gitter.im/tensorflow/sig-addons>https://gitter.im/tensorflow/sig-addons</denchmark-link>\n  but I think it is quite trivial.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ClementWalter", "commentT": "2020-05-16T06:18:22Z", "comment_text": "\n \t\t\n def preprocessing(image):\n     cout_out = tfa.image.random_cutout(tf.expand_dims(image, 0), mask_size=(20, 20))\n     output = tfa.image.utils.from_4D_image(cout_out,tfa.image.utils.get_ndims(image))\n     return tf.dtypes.cast(output, tf.dtypes.float32)\n \n Can you send a PR with something like https://github.com/tensorflow/addons/blob/master/tensorflow_addons/image/transform_ops.py#L117 for cut_out?\n \n I met same bug when I ran the following script:\n <denchmark-code>@tf.function\n def preprocessing(image):\n     images = tf.expand_dims(image, 0)\n     cout_out = tfa.image.random_cutout(images, mask_size=(20, 20)\n     output = tfa.image.utils.from_4D_image(cout_out, tfa.image.utils.get_ndims(images))\n     output = tf.squeeze(output)\n     return tf.dtypes.cast(output, tf.dtypes.float32)\n </denchmark-code>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ClementWalter", "commentT": "2020-05-16T08:11:59Z", "comment_text": "\n \t\tYes if you reintroduce the squeeze you have the same problem\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ClementWalter", "commentT": "2020-05-16T12:14:09Z", "comment_text": "\n \t\t\n Yes if you reintroduce the squeeze you have the same problem\n \n I haven't met the bug with commit <denchmark-link:https://github.com/fsx950223/addons/commit/b1e7722f0750affa2eca83d195bfa7780cddfe5b>fsx950223@b1e7722</denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "ClementWalter", "commentT": "2020-05-16T15:15:21Z", "comment_text": "\n \t\tI meant with the current code in master. With that PR/commit Is ok\n \t\t"}}}, "commit": {"commit_id": "c06e9abf856015f75507dc7e04f79b73f1058bd4", "commit_author": "who who who", "commitT": "2020-05-24 10:59:38-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow_addons\\image\\cutout_ops.py", "file_new_name": "tensorflow_addons\\image\\cutout_ops.py", "file_complexity": {"file_NLOC": "150", "file_CCN": "7", "file_NToken": "777"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "131,179", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow_addons\\image\\tests\\cutout_ops_test.py", "file_new_name": "tensorflow_addons\\image\\tests\\cutout_ops_test.py", "file_complexity": {"file_NLOC": "49", "file_CCN": "6", "file_NToken": "656"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "70,74", "deleted_lines": "70,71,72,73,74", "method_info": {"method_name": "test_with_tf_function", "method_params": "", "method_startline": "68", "method_endline": "74", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "103", "method_nesting_level": "0"}}}}}}}}