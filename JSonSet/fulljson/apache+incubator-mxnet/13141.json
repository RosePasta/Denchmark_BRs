{"BR": {"BR_id": "13141", "BR_author": "azai91", "BRopenT": "2018-11-06T20:03:04Z", "BRcloseT": "2018-11-22T23:37:00Z", "BR_text": {"BRsummary": "MKLDNN softmax outputs NaN in mkldnn 0.14", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n Extremely negative softmax inputs output NaN. This is an error caught detected in MKLDNN already (<denchmark-link:https://github.com/oneapi-src/oneDNN/issues/106>oneapi-src/oneDNN#106</denchmark-link>\n ) with a fix (<denchmark-link:https://gist.github.com/emfomenk/0386c529c5df21ae308b00d16454c48e>https://gist.github.com/emfomenk/0386c529c5df21ae308b00d16454c48e</denchmark-link>\n ) in MKLDNN v0.15+ (we are v0.14).\n The fix is either to:\n \n patch MKLDNN v0.14 with the earlier fix\n to upgrade the MKLDNN version in mxnet (#12953).\n \n <denchmark-h:h2>Environment info (Required)</denchmark-h>\n \n <denchmark-code>ubuntu@ip-172-31-3-217:~$ python diagnose.py\n ----------Python Info----------\n Version      : 3.6.4\n Compiler     : GCC 7.2.0\n Build        : ('default', 'Jan 16 2018 18:10:19')\n Arch         : ('64bit', '')\n ------------Pip Info-----------\n Version      : 9.0.1\n Directory    : /home/ubuntu/anaconda3/lib/python3.6/site-packages/pip\n ----------MXNet Info-----------\n /home/ubuntu/anaconda3/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n   from ._conv import register_converters as _register_converters\n Version      : 1.3.0\n Directory    : /home/ubuntu/anaconda3/lib/python3.6/site-packages/mxnet\n Commit Hash   : b3be92f4a48bce62a5a8424271871c2f81c8f7f1\n ----------System Info----------\n Platform     : Linux-4.4.0-1065-aws-x86_64-with-debian-stretch-sid\n system       : Linux\n node         : ip-172-31-3-217\n release      : 4.4.0-1065-aws\n version      : #75-Ubuntu SMP Fri Aug 10 11:14:32 UTC 2018\n ----------Hardware Info----------\n machine      : x86_64\n processor    : x86_64\n Architecture:          x86_64\n CPU op-mode(s):        32-bit, 64-bit\n Byte Order:            Little Endian\n CPU(s):                72\n On-line CPU(s) list:   0-71\n Thread(s) per core:    2\n Core(s) per socket:    18\n Socket(s):             2\n NUMA node(s):          2\n Vendor ID:             GenuineIntel\n CPU family:            6\n Model:                 85\n Model name:            Intel(R) Xeon(R) Platinum 8124M CPU @ 3.00GHz\n Stepping:              3\n CPU MHz:               3000.000\n BogoMIPS:              6000.00\n Hypervisor vendor:     KVM\n Virtualization type:   full\n L1d cache:             32K\n L1i cache:             32K\n L2 cache:              1024K\n L3 cache:              25344K\n NUMA node0 CPU(s):     0-17,36-53\n NUMA node1 CPU(s):     18-35,54-71\n Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq monitor ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single kaiser fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f rdseed adx smap clflushopt clwb avx512cd xsaveopt xsavec xgetbv1 ida arat\n ----------Network Test----------\n Setting timeout: 10\n Timing for MXNet: https://github.com/apache/incubator-mxnet, DNS: 0.0012 sec, LOAD: 0.4806 sec.\n Timing for Gluon Tutorial(en): http://gluon.mxnet.io, DNS: 0.1717 sec, LOAD: 0.5293 sec.\n Timing for Gluon Tutorial(cn): https://zh.gluon.ai, DNS: 0.1596 sec, LOAD: 0.3734 sec.\n Timing for FashionMNIST: https://apache-mxnet.s3-accelerate.dualstack.amazonaws.com/gluon/dataset/fashion-mnist/train-labels-idx1-ubyte.gz, DNS: 0.0262 sec, LOAD: 0.1173 sec.\n Timing for PYPI: https://pypi.python.org/pypi/pip, DNS: 0.0013 sec, LOAD: 0.3264 sec.\n Timing for Conda: https://repo.continuum.io/pkgs/free/, DNS: 0.0118 sec, LOAD: 0.0690 sec.\n </denchmark-code>\n \n Package used (Python/R/Scala/Julia):\n Python\n For Scala user, please provide:\n \n Java version: (java -version)\n Maven version: (mvn -version)\n Scala runtime if applicable: (scala -version)\n \n For R user, please provide R sessionInfo():\n <denchmark-h:h2>Build info (Required if built from source)</denchmark-h>\n \n Compiler (gcc/clang/mingw/visual studio):\n MXNet commit hash:\n <denchmark-link:https://github.com/apache/incubator-mxnet/commit/6b5d9f9785a398d2e8ccaa950f89fb76d76d5bd4>6b5d9f9</denchmark-link>\n \n Build config:\n MKLDNN (pip install mxnet-mkl)\n <denchmark-h:h2>Error Message:</denchmark-h>\n \n <denchmark-code>ubuntu@ip-172-31-3-217:~/incubator-mxnet$ python tt.py\n /home/ubuntu/anaconda3/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n   from ._conv import register_converters as _register_converters\n [\n [[[[nan nan]]]]\n <NDArray 1x1x1x2 @cpu(0)>]\n </denchmark-code>\n \n <denchmark-h:h2>Minimum reproducible example</denchmark-h>\n \n <denchmark-code>import mxnet as mx\n input_data = mx.nd.array([[[[-1e30,-1e30]]]])\n data = mx.sym.Variable('data')\n out1 = data.softmax(axis=1)\n exec1 = out1.bind(mx.cpu(), args={'data': input_data, 'softmax_label': mx.nd.ones([1]), 'fc_weight': mx.nd.ones([2,2]), 'fc1_weight': mx.nd.ones([2,2])})\n exec1.forward()[0].wait_to_read()\n print(exec1.outputs)\n </denchmark-code>\n \n <denchmark-h:h2>Steps to reproduce</denchmark-h>\n \n Run the following script.\n <denchmark-h:h2>What have you tried to solve it?</denchmark-h>\n \n Applying this one line fix (<denchmark-link:https://gist.github.com/emfomenk/0386c529c5df21ae308b00d16454c48e>https://gist.github.com/emfomenk/0386c529c5df21ae308b00d16454c48e</denchmark-link>\n ) in mkldnn fixes the issue.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "azai91", "commentT": "2018-11-06T20:03:15Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/nswamy>@nswamy</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "azai91", "commentT": "2018-11-07T05:40:24Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/azai91>@azai91</denchmark-link>\n  could you help to add a testcase for this issue after the <denchmark-link:https://github.com/apache/incubator-mxnet/pull/12953>#12953</denchmark-link>\n  is merged?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "azai91", "commentT": "2018-11-08T04:51:02Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/azai91>@azai91</denchmark-link>\n  PR is merged, go ahead to create a test for this issue \n Feel free to let me know if any help is needed.\n <denchmark-link:https://github.com/TaoLv>@TaoLv</denchmark-link>\n \n Original: MKL-DNN 0.14 CI: <denchmark-link:https://github.com/apache/incubator-mxnet/commit/498e03da7ce420a48050fcd363aacb8dec2516f7>498e03d</denchmark-link>\n \n <denchmark-code>patric@mlt-skx122 mxnet]$ python soft.py\n /home/patric/.local/lib/python2.7/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n   from ._conv import register_converters as _register_converters\n [\n [[[[nan nan]]]]\n <NDArray 1x1x1x2 @cpu(0)>]\n \n </denchmark-code>\n \n Now: MKL-DNN 0.17 CI: <denchmark-link:https://github.com/apache/incubator-mxnet/commit/a32fa840262cdad5e7556a53d7ce3d7218ae7120>a32fa84</denchmark-link>\n \n <denchmark-code>[patric@mlt-skx122 mxnet]$ python soft.py\n /home/patric/.local/lib/python2.7/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.\n   from ._conv import register_converters as _register_converters\n [\n [[[[1. 1.]]]]\n <NDArray 1x1x1x2 @cpu(0)>]\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "azai91", "commentT": "2018-11-08T05:31:31Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-label-bot>@mxnet-label-bot</denchmark-link>\n  [MKLDNN]\n \t\t"}}}, "commit": {"commit_id": "be76f8595ca997ec9d340b6bf01be920086e1eac", "commit_author": "Manu Seth", "commitT": "2018-11-22 15:36:59-08:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\python\\mkl\\test_mkldnn.py", "file_new_name": "tests\\python\\mkl\\test_mkldnn.py", "file_complexity": {"file_NLOC": "349", "file_CCN": "71", "file_NToken": "4112"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "387,388,389,390,391,392,393,394", "deleted_lines": null, "method_info": {"method_name": "test_softmax_with_large_inputs.softmax_forward", "method_params": "input_data,true_output", "method_startline": "387", "method_endline": "394", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "101", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "386,387,388,389,390,391,392,393,394,395,396,397,398,399", "deleted_lines": null, "method_info": {"method_name": "test_softmax_with_large_inputs", "method_params": "", "method_startline": "386", "method_endline": "399", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "162", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\python\\unittest\\test_operator.py", "file_new_name": "tests\\python\\unittest\\test_operator.py", "file_complexity": {"file_NLOC": "5975", "file_CCN": "957", "file_NToken": "75012"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "4454,4455,4456,4457,4458,4459,4460,4461", "deleted_lines": null, "method_info": {"method_name": "test_softmax_with_large_inputs.softmax_forward", "method_params": "input_data,true_output", "method_startline": "4454", "method_endline": "4461", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "99", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "4453,4454,4455,4456,4457,4458,4459,4460,4461,4462,4463,4464,4465,4466", "deleted_lines": null, "method_info": {"method_name": "test_softmax_with_large_inputs", "method_params": "", "method_startline": "4453", "method_endline": "4466", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "162", "method_nesting_level": "0"}}}}}}}}