{"BR": {"BR_id": "12431", "BR_author": "some-guy1", "BRopenT": "2018-09-01T16:12:13Z", "BRcloseT": "2018-10-12T23:52:11Z", "BR_text": {"BRsummary": "[R] use of mx.io.arrayiter completely crashes R environment", "BRdescription": "\n Running the code below causes the entire R environment to terminate.  This code used to work on older versions of mxnet (older than 1.2.0).  It seems to be related to mx.io.arrayiter\n <denchmark-h:h2>Environment info (Required)</denchmark-h>\n \n R version 3.5.0 (2018-04-23)\n Platform: x86_64-w64-mingw32/x64 (64-bit)\n Running under: Windows >= 8 x64 (build 9200)\n Matrix products: default\n locale:\n [1] LC_COLLATE=English_United States.1252  LC_CTYPE=English_United States.1252\n [3] LC_MONETARY=English_United States.1252 LC_NUMERIC=C\n [5] LC_TIME=English_United States.1252\n attached base packages:\n [1] stats     graphics  grDevices utils     datasets  methods   base\n other attached packages:\n [1] mxnet_1.3.0\n loaded via a namespace (and not attached):\n [1] Rcpp_0.12.16       pillar_1.2.2       compiler_3.5.0     RColorBrewer_1.1-2 influenceR_0.1.0   plyr_1.8.4\n [7] bindr_0.1.1        viridis_0.5.1      tools_3.5.0        digest_0.6.15      jsonlite_1.5       viridisLite_0.3.0\n [13] tibble_1.4.2       gtable_0.2.0       rgexf_0.15.3       pkgconfig_2.0.1    rlang_0.2.0        igraph_1.2.1\n [19] rstudioapi_0.7     yaml_2.1.19        bindrcpp_0.2.2     gridExtra_2.3      downloader_0.4     DiagrammeR_1.0.0\n [25] dplyr_0.7.4        stringr_1.3.1      htmlwidgets_1.2    hms_0.4.2          grid_3.5.0         glue_1.2.0\n [31] R6_2.2.2           Rook_1.1-1         XML_3.98-1.11      readr_1.1.1        purrr_0.2.4        tidyr_0.8.0\n [37] ggplot2_2.2.1      magrittr_1.5       codetools_0.2-15   scales_0.5.0       htmltools_0.3.6    assertthat_0.2.0\n [43] colorspace_1.3-2   brew_1.0-6         stringi_1.2.2      visNetwork_2.0.3   lazyeval_0.2.1     munsell_0.4.3\n <denchmark-h:h2>Build info (Required if built from source)</denchmark-h>\n \n <denchmark-link:https://github.com/apache/incubator-mxnet/tree/master/R-package>https://github.com/apache/incubator-mxnet/tree/master/R-package</denchmark-link>\n \n <denchmark-code>cran <- getOption(\"repos\")\n cran[\"dmlc\"] <- \"https://apache-mxnet.s3-accelerate.dualstack.amazonaws.com/R/CRAN/\"\n options(repos = cran)\n install.packages(\"mxnet\")\n \n </denchmark-code>\n \n <denchmark-h:h2>Error Message:</denchmark-h>\n \n R environment crashes.\n <denchmark-h:h2>Minimum reproducible example</denchmark-h>\n \n <denchmark-code>data.A = read.csv(\"./matty_inv/A.csv\", header = FALSE)\n data.A.2 = read.csv(\"./matty_inv/A_2.csv\", header = FALSE)\n \n data.A <- as.matrix(data.A)\n data.A.2 <- as.matrix(data.A.2)\n \n dim(data.A) <- c(3,3,1,10)\n dim(data.A.2) <- c(3,3,1,10)\n \n train_iter = mx.io.arrayiter(data = data.A,\n                              label = data.A.2,\n                              batch.size = 1)\n \n data <- mx.symbol.Variable('data')\n label <- mx.symbol.Variable('label')\n \n conv_1 <- mx.symbol.Convolution(data= data, kernel = c(1,1), num_filter = 4, name=\"conv_1\")\n conv_act_1 <- mx.symbol.Activation(data= conv_1, act_type = \"relu\", name=\"conv_act_1\")\n flat <- mx.symbol.flatten(data = conv_act_1,  name=\"flatten\")\n fcl_1 <- mx.symbol.FullyConnected(data = flat, num_hidden = 9, name=\"fc_1\")\n fcl_2 <- mx.symbol.reshape(fcl_1, shape=c(3,3, 1, batch_size))\n NN_Model <- mx.symbol.LinearRegressionOutput(data=fcl_2 , label=label, name=\"lro\")\n \n mx.set.seed(99)\n   autoencoder <- mx.model.FeedForward.create(\n     NN_Model, X=train_iter, initializer = mx.init.uniform(0.01),\n     ctx=mx.cpu(), num.round=n.rounds, array.batch.size=batch_size,\n     learning.rate=8e-3, array.layout = \"rowmajor\",\n     eval.metric = mx.metric.rmse, optimizer = \"adam\",\n     verbose = TRUE)\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "some-guy1", "commentT": "2018-09-02T00:18:28Z", "comment_text": "\n \t\tCan you specify where the syntax is wrong?  Also, I think it would be best practice for mxnet to throw an error instead of causing the R environment to crash.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "some-guy1", "commentT": "2018-09-02T21:07:28Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-label-bot>@mxnet-label-bot</denchmark-link>\n  [R, Bug, Data-loading]\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "some-guy1", "commentT": "2018-09-06T23:29:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/some-guy1>@some-guy1</denchmark-link>\n  can you please share a small snapshot of these two data files  and \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "some-guy1", "commentT": "2018-09-09T13:36:07Z", "comment_text": "\n \t\tThe csv files are identical:\n <denchmark-link:https://user-images.githubusercontent.com/23563452/45265038-bc388880-b413-11e8-8c24-4f78b844a17a.png></denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "some-guy1", "commentT": "2018-09-09T13:43:46Z", "comment_text": "\n \t\tI can confirm that:\n <denchmark-code>train_iter$reset()\n train_iter$iter.next()\n train_iter$value()\n </denchmark-code>\n \n Results in the expected:\n <denchmark-code>$`data`\n , , 1, 1\n \n          [,1]     [,2]     [,3]\n [1,] 1.373546 3.595281 2.487429\n [2,] 2.183643 2.329508 2.738325\n [3,] 1.164371 1.179532 2.575781\n \n \n $label\n , , 1, 1\n \n          [,1]     [,2]     [,3]\n [1,] 1.373546 3.595281 2.487429\n [2,] 2.183643 2.329508 2.738325\n [3,] 1.164371 1.179532 2.575781\n </denchmark-code>\n \n So I have no idea why the entire R environment crashes when I started the training.  Mxnet states it is starting to train, then everything crashes.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "some-guy1", "commentT": "2018-09-21T04:34:27Z", "comment_text": "\n \t\tI think the issue comes from the evaluation metric. The following code include a modified rmse metric that flatten the pred and label vector. I think it's bug that the eval metric fails when the predictions are not in a flat setting, I'll open a PR to get it fixed.\n <denchmark-code>data.A <- mx.nd.random.normal(shape = c(3,3,1,10))\n data.A.2 <- mx.nd.random.normal(shape = c(3,3,1,10))\n \n batch_size <- 5\n \n train_iter = mx.io.arrayiter(data = as.array(data.A),\n                              label = as.array(data.A.2),\n                              batch.size = batch_size)\n \n data <- mx.symbol.Variable('data')\n label <- mx.symbol.Variable('label')\n \n conv_1 <- mx.symbol.Convolution(data= data, kernel = c(1,1), num_filter = 4, name=\"conv_1\")\n conv_act_1 <- mx.symbol.Activation(data= conv_1, act_type = \"relu\", name=\"conv_act_1\")\n flat <- mx.symbol.flatten(data = conv_act_1,  name=\"flatten\")\n fcl_1 <- mx.symbol.FullyConnected(data = flat, num_hidden = 9, name=\"fc_1\")\n fcl_2 <- mx.symbol.reshape(fcl_1, shape=c(3, 3, 1, batch_size))\n NN_Model <- mx.symbol.LinearRegressionOutput(data=fcl_2 , label=label, name=\"lro\")\n \n fcl_2$infer.shape(list(data = c(3,3,1,batch_size)))\n NN_Model$infer.shape(list(data = c(3,3,1,batch_size)))\n \n mx.metric.rmse <- mx.metric.custom(\"rmse\", function(label, pred) {\n   pred <- mx.nd.reshape(pred, shape = -1)\n   label <- mx.nd.reshape(label, shape = -1)\n   res <- mx.nd.sqrt(mx.nd.mean(mx.nd.square(label-pred)))\n   return(as.array(res))\n })\n \n mx.set.seed(99)\n autoencoder <- mx.model.FeedForward.create(\n   NN_Model, \n   X = train_iter, \n   initializer = mx.init.uniform(0.01),\n   ctx=mx.cpu(), \n   num.round=5,\n   eval.metric = mx.metric.rmse, \n   optimizer = mx.opt.create(\"sgd\"),\n   verbose = TRUE)\n \n </denchmark-code>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "some-guy1", "commentT": "2018-09-22T18:19:42Z", "comment_text": "\n \t\tThank you for the explanation!\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "some-guy1", "commentT": "2018-10-09T22:21:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jeremiedb>@jeremiedb</denchmark-link>\n  Were you able to open a PR for this ?\n If yes, can you link the PR to this issue to that it can be tracked ?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "some-guy1", "commentT": "2018-10-10T03:28:03Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/piyushghai>@piyushghai</denchmark-link>\n  Thanks for the reminder, I just open the PR.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "some-guy1", "commentT": "2018-10-11T16:43:25Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/some-guy1>@some-guy1</denchmark-link>\n  The PR for fixing this got merged. Can you verify and close this issue if the bug is bug ?\n Thanks!\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "some-guy1", "commentT": "2018-10-12T23:32:40Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/sandeep-krishnamurthy>@sandeep-krishnamurthy</denchmark-link>\n  The related PR is merged. The new R-package will include this fix when we release the new binaries of R along with the next MXNet release.\n Please close this issue.\n <denchmark-link:https://github.com/some-guy1>@some-guy1</denchmark-link>\n  Please feel free to re-open if closed in error. In case you want to instantly verify the fix, you can follow the instructions to build the R-package from source here : <denchmark-link:https://mxnet.incubator.apache.org/install/index.html?platform=Linux&language=R&processor=CPU>https://mxnet.incubator.apache.org/install/index.html?platform=Linux&language=R&processor=CPU</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "822e59f819f098e1745cf92b5e9351d7455fe5fc", "commit_author": "jeremiedb", "commitT": "2018-10-10 15:36:05-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "R-package\\R\\metric.R", "file_new_name": "R-package\\R\\metric.R", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "62,63,72,73,82,83,92,93,102,105,108,118,119,129,130", "deleted_lines": "62,71,80,89,98,101,104,114,124"}}}}}}