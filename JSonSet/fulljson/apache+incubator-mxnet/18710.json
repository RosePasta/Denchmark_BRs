{"BR": {"BR_id": "18710", "BR_author": "bgawrych", "BRopenT": "2020-07-14T11:41:28Z", "BRcloseT": "2020-08-07T09:27:37Z", "BR_text": {"BRsummary": "[Numpy] Backward of softmax, logsoftmax failed on empty ndarray", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n During backporting change <denchmark-link:https://github.com/apache/incubator-mxnet/pull/18602>#18602</denchmark-link>\n  to branch v1.x, CI detected problem similar to original issue (<denchmark-link:https://github.com/apache/incubator-mxnet/issues/18569>#18569</denchmark-link>\n ).\n Backward propagation of softmax and log_softmax causes MXNetError: Check failed: delay_alloc:\n <denchmark-h:h3>Error Message</denchmark-h>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"r.py\", line 10, in <module>\n     a.grad.wait_to_read()\n   File \"/home/wihajster/Desktop/incubator-mxnet/python/mxnet/ndarray/ndarray.py\", line 2371, in wait_to_read\n     check_call(_LIB.MXNDArrayWaitToRead(self.handle))\n   File \"/home/wihajster/Desktop/incubator-mxnet/python/mxnet/base.py\", line 246, in check_call\n     raise get_last_ffi_error()\n mxnet.base.MXNetError: Traceback (most recent call last):\n   [bt] (9) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(std::function<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)>::operator()(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&) const+0xa6) [0x7f6d58049c9a]\n   [bt] (8) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(std::_Function_handler<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&), void (*)(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)>::_M_invoke(std::_Any_data const&, nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)+0x91) [0x7f6d56fc8a7d]\n   [bt] (7) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(+0xbe611e0) [0x7f6d609281e0]\n   [bt] (6) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(mxnet::MKLDNNRun(std::function<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)>, nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)+0xad) [0x7f6d580426f3]\n   [bt] (5) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(std::function<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)>::operator()(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&) const+0xa6) [0x7f6d58049c9a]\n   [bt] (4) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(std::_Function_handler<void (nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&), void (*)(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)>::_M_invoke(std::_Any_data const&, nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)+0x91) [0x7f6d56fc8a7d]\n   [bt] (3) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(mxnet::op::MKLDNNLogSoftmaxBackward(nnvm::NodeAttrs const&, mxnet::OpContext const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&, std::vector<mxnet::OpReqType, std::allocator<mxnet::OpReqType> > const&, std::vector<mxnet::NDArray, std::allocator<mxnet::NDArray> > const&)+0x1b6) [0x7f6d580b7d37]\n   [bt] (2) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(mxnet::NDArray::GetMKLDNNData() const+0x43b) [0x7f6d61188a0f]\n   [bt] (1) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(mxnet::NDArray::Chunk::SetMKLMem(mxnet::TShape const&, int)+0x3c4) [0x7f6d61186dbe]\n   [bt] (0) /home/wihajster/Desktop/incubator-mxnet/python/mxnet/../../lib/libmxnet.so(dmlc::LogMessageFatal::~LogMessageFatal()+0x4d) [0x7f6d569b2acf]\n   File \"src/ndarray/ndarray.cc\", line 580\n MXNetError: Check failed: delay_alloc:\n </denchmark-code>\n \n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n <denchmark-code>import mxnet as mx\n from mxnet import npx\n npx.set_np()\n a = mx.np.array([]).reshape(2, 1, 0)\n a.attach_grad()\n \n with mx.autograd.record():\n     b = mx.npx.log_softmax(a)\n     b.backward()\n     a.grad.wait_to_read()\n </denchmark-code>\n \n PR is on its way\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "bgawrych", "commentT": "2020-07-16T02:20:16Z", "comment_text": "\n \t\tThanks for reporting. cc <denchmark-link:https://github.com/yzhliu>@yzhliu</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "bgawrych", "commentT": "2020-08-07T09:27:37Z", "comment_text": "\n \t\tDone :)\n \t\t"}}}, "commit": {"commit_id": "73d3a7bc9cef596b5cc8ba6d0e3cf21e1bc08fee", "commit_author": "bgawrych", "commitT": "2020-08-03 22:20:49+08:00", "commit_complexity": {"commit_NLOC": "0.3392857142857143", "commit_CCN": "0.0", "commit_Nprams": "0.7678571428571429"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\nn\\log_softmax.cc", "file_new_name": "src\\operator\\nn\\log_softmax.cc", "file_complexity": {"file_NLOC": "121", "file_CCN": "9", "file_NToken": "943"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "43", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::LogSoftmaxComputeExCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "38", "method_endline": "54", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "191", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "61", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::LogSoftmaxGradComputeExCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "56", "method_endline": "72", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "194", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "src\\operator\\nn\\softmax-inl.h", "file_new_name": "src\\operator\\nn\\softmax-inl.h", "file_complexity": {"file_NLOC": "782", "file_CCN": "191", "file_NToken": "7971"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "407", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::mxnet_op::Softmax", "method_params": "s,in,out,length,shape,axis,temperature", "method_startline": "402", "method_endline": "437", "method_complexity": {"method_NLOC": "34", "method_CCN": "6", "method_NToken": "359", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "561", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::mxnet_op::SoftmaxGrad", "method_params": "s,out,ograd,igrad,length,shape,axis,temperature", "method_startline": "555", "method_endline": "593", "method_complexity": {"method_NLOC": "35", "method_CCN": "6", "method_NToken": "377", "method_nesting_level": "3"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "74", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::mxnet_op::Softmax", "method_params": "s,in,out,length,shape,axis,temperature", "method_startline": "71", "method_endline": "162", "method_complexity": {"method_NLOC": "77", "method_CCN": "32", "method_NToken": "846", "method_nesting_level": "3"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "782,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,821,822,823,824,825,826,828,829,830,831,833", "deleted_lines": "778,801,802,803,805,806,807,808,809,810,811,812,813,814,815,816,818,819,820,821,822,823,824,825,826,827,828", "method_info": {"method_name": "mxnet::op::SoftmaxCompute", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "776", "method_endline": "837", "method_complexity": {"method_NLOC": "61", "method_CCN": "11", "method_NToken": "610", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "190", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::mxnet_op::SoftmaxGrad", "method_params": "s,out,ograd,igrad,length,shape,axis,temperature", "method_startline": "186", "method_endline": "259", "method_complexity": {"method_NLOC": "63", "method_CCN": "19", "method_NToken": "702", "method_nesting_level": "3"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\nn\\softmax.cc", "file_new_name": "src\\operator\\nn\\softmax.cc", "file_complexity": {"file_NLOC": "146", "file_CCN": "13", "file_NToken": "1169"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "44", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::SoftmaxComputeExCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "39", "method_endline": "55", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "191", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "62", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::SoftmaxGradComputeExCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "57", "method_endline": "73", "method_complexity": {"method_NLOC": "17", "method_CCN": "3", "method_NToken": "194", "method_nesting_level": "2"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\numpy\\np_boolean_mask_assign.cc", "file_new_name": "src\\operator\\numpy\\np_boolean_mask_assign.cc", "file_complexity": {"file_NLOC": "271", "file_CCN": "47", "file_NToken": "2443"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "226,256,257,273", "deleted_lines": "224,225", "method_info": {"method_name": "mxnet::op::NumpyBooleanAssignForwardCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "194", "method_endline": "281", "method_complexity": {"method_NLOC": "76", "method_CCN": "13", "method_NToken": "788", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tests\\python\\unittest\\test_numpy_op.py", "file_new_name": "tests\\python\\unittest\\test_numpy_op.py", "file_complexity": {"file_NLOC": "7174", "file_CCN": "1733", "file_NToken": "79195"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1580,1581,1582,1583,1584,1585,1586", "deleted_lines": null, "method_info": {"method_name": "test_npx_softmax.np_softmax", "method_params": "x,axis", "method_startline": "1580", "method_endline": "1586", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "82", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "1565,1566,1567", "deleted_lines": null, "method_info": {"method_name": "test_npx_softmax.__init__", "method_params": "self,axis", "method_startline": "1565", "method_endline": "1567", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1588,1589", "deleted_lines": null, "method_info": {"method_name": "test_npx_softmax.np_log_softmax", "method_params": "x,axis", "method_startline": "1588", "method_endline": "1589", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "1569,1570", "deleted_lines": null, "method_info": {"method_name": "test_npx_softmax.hybrid_forward", "method_params": "self,F,a", "method_startline": "1569", "method_endline": "1570", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "2"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "1563,1564,1565,1566,1567,1568,1569,1570,1571,1572,1573,1574,1575,1576,1577,1578,1579,1580,1581,1582,1583,1584,1585,1586,1587,1588,1589,1590,1591,1592,1593,1594,1595,1596,1597,1598,1599,1600,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616", "deleted_lines": null, "method_info": {"method_name": "test_npx_softmax", "method_params": "", "method_startline": "1563", "method_endline": "1616", "method_complexity": {"method_NLOC": "28", "method_CCN": "6", "method_NToken": "225", "method_nesting_level": "0"}}}}}}}}