{"BR": {"BR_id": "17472", "BR_author": "ChaiBapchya", "BRopenT": "2020-01-29T20:11:43Z", "BRcloseT": "2020-04-11T13:43:13Z", "BR_text": {"BRsummary": "Memory corruption issue with unravel_index", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n MXNet unravel_index function seems to run into memory corruption issue with the following inputs\n <denchmark-h:h2>Command</denchmark-h>\n \n <denchmark-code>>>> a=mx.nd.random.randn(2,20)\n >>> mx.nd.unravel_index(a, shape=(-1,10))\n </denchmark-code>\n \n <denchmark-h:h2>Error Log</denchmark-h>\n \n <denchmark-code>*** Error in `python3': double free or corruption (out): 0x00007f0cf4011d30 ***\n ======= Backtrace: =========\n /lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f0e76cb97e5]\n /lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7f0e76cc237a]\n /lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7f0e76cc653c]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZN9__gnu_cxx13new_allocatorIN5mxnet5TBlobEE10deallocateEPS2_m+0x20)[0x7f0e45141c18]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt16allocator_traitsISaIN5mxnet5TBlobEEE10deallocateERS2_PS1_m+0x2b)[0x7f0e4513f982]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt12_Vector_baseIN5mxnet5TBlobESaIS1_EE13_M_deallocateEPS1_m+0x32)[0x7f0e4513d4d4]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt12_Vector_baseIN5mxnet5TBlobESaIS1_EED1Ev+0x52)[0x7f0e4513a68a]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt6vectorIN5mxnet5TBlobESaIS1_EED1Ev+0x41)[0x7f0e451366e5]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZZN5mxnet10imperative12PushFComputeERKSt8functionIFvRKN4nnvm9NodeAttrsERKNS_9OpContextERKSt6vectorINS_5TBlobESaISA_EERKS9_INS_9OpReqTypeESaISF_EESE_EEPKNS2_2OpES5_RKNS_7ContextERKS9_IPNS_6engine3VarESaISW_EES10_RKS9_INS_8ResourceESaIS11_EERKS9_IPNS_7NDArrayESaIS17_EES1B_RKS9_IjSaIjEESJ_ENKUlNS_10RunContextEE_clES1G_+0x305)[0x7f0e451fbe4b]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt17_Function_handlerIFvN5mxnet10RunContextEEZNS0_10imperative12PushFComputeERKSt8functionIFvRKN4nnvm9NodeAttrsERKNS0_9OpContextERKSt6vectorINS0_5TBlobESaISD_EERKSC_INS0_9OpReqTypeESaISI_EESH_EEPKNS5_2OpES8_RKNS0_7ContextERKSC_IPNS0_6engine3VarESaISZ_EES13_RKSC_INS0_8ResourceESaIS14_EERKSC_IPNS0_7NDArrayESaIS1A_EES1E_RKSC_IjSaIjEESM_EUlS1_E_E9_M_invokeERKSt9_Any_dataOS1_+0x3f)[0x7f0e4520206a]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNKSt8functionIFvN5mxnet10RunContextEEEclES1_+0x42)[0x7f0e4510ab7e]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(+0x231a86f)[0x7f0e4511086f]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(+0x231bdee)[0x7f0e45111dee]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNKSt8functionIFvN5mxnet10RunContextENS0_6engine18CallbackOnCompleteEEEclES1_S3_+0x56)[0x7f0e4510bbf0]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZN5mxnet6engine14ThreadedEngine15ExecuteOprBlockENS_10RunContextEPNS0_8OprBlockE+0x3b1)[0x7f0e45120093]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZN5mxnet6engine23ThreadedEnginePerDevice9CPUWorkerILN4dmlc19ConcurrentQueueTypeE0EEEvNS_7ContextEPNS1_17ThreadWorkerBlockIXT_EEERKSt10shared_ptrINS3_11ManualEventEE+0xc6)[0x7f0e45123f04]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZZZN5mxnet6engine23ThreadedEnginePerDevice13PushToExecuteEPNS0_8OprBlockEbENKUlvE_clEvENKUlSt10shared_ptrIN4dmlc11ManualEventEEE_clES8_+0x42)[0x7f0e45121638]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt17_Function_handlerIFvSt10shared_ptrIN4dmlc11ManualEventEEEZZN5mxnet6engine23ThreadedEnginePerDevice13PushToExecuteEPNS6_8OprBlockEbENKUlvE_clEvEUlS3_E_E9_M_invokeERKSt9_Any_dataOS3_+0x5c)[0x7f0e45127b3a]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNKSt8functionIFvSt10shared_ptrIN4dmlc11ManualEventEEEEclES3_+0x49)[0x7f0e4512f615]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt12_Bind_simpleIFSt8functionIFvSt10shared_ptrIN4dmlc11ManualEventEEEES4_EE9_M_invokeIILm0EEEEvSt12_Index_tupleIIXspT_EEE+0x68)[0x7f0e4512f588]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt12_Bind_simpleIFSt8functionIFvSt10shared_ptrIN4dmlc11ManualEventEEEES4_EEclEv+0x2c)[0x7f0e4512f41c]\n /home/ubuntu/incubator-mxnet/python/mxnet/../../build/libmxnet.so(_ZNSt6thread5_ImplISt12_Bind_simpleIFSt8functionIFvSt10shared_ptrIN4dmlc11ManualEventEEEES6_EEE6_M_runEv+0x1c)[0x7f0e4512f36c]\n /usr/lib/x86_64-linux-gnu/libstdc++.so.6(+0xb8c80)[0x7f0e69b6ac80]\n /lib/x86_64-linux-gnu/libpthread.so.0(+0x76ba)[0x7f0e770136ba]\n /lib/x86_64-linux-gnu/libc.so.6(clone+0x6d)[0x7f0e76d4941d]\n ======= Memory map: ========\n 559906a44000-559906d03000 r-xp 00000000 ca:01 9987032                    /home/ubuntu/incubator-mxnet/py3_venv/bin/python3\n 559906f02000-559906f05000 r--p 002be000 ca:01 9987032                    /home/ubuntu/incubator-mxnet/py3_venv/bin/python3\n 559906f05000-559906f68000 rw-p 002c1000 ca:01 9987032                    /home/ubuntu/incubator-mxnet/py3_venv/bin/python3\n 559906f68000-559906f99000 rw-p 00000000 00:00 0\n 5599077b3000-55990901c000 rw-p 00000000 00:00 0                          [heap]\n 7f0c5c000000-7f0c5c021000 rw-p 00000000 00:00 0\n </denchmark-code>\n \n At the very least, error handling should be improved (even if the inputs were incorrect, graceful exit is desired)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ChaiBapchya", "commentT": "2020-01-29T20:44:51Z", "comment_text": "\n \t\tIt seg-faults for other inputs\n <denchmark-code>>>> a=mx.nd.random.randn(2,1024)\n >>> mx.nd.unravel_index(a,shape=(1024,1024))\n \n Segmentation fault: 11\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ChaiBapchya", "commentT": "2020-02-29T23:49:35Z", "comment_text": "\n \t\tI can confirm it here too (mxnet 1.5.1 on Linux)\n <denchmark-code>free(): invalid pointer\n Aborted (core dumped)\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ChaiBapchya", "commentT": "2020-03-02T16:05:07Z", "comment_text": "\n \t\tI can reproduce the bug.\n I check the code of unravel_index, which only support 1D input.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ChaiBapchya", "commentT": "2020-03-03T02:25:58Z", "comment_text": "\n \t\tI have fixed the bug, and I will submit the PR.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ChaiBapchya", "commentT": "2020-07-26T22:39:44Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-bot>@mxnet-bot</denchmark-link>\n  test if you comment on an issue\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ChaiBapchya", "commentT": "2020-07-26T22:39:45Z", "comment_text": "\n \t\tUndefined action detected.\n Permissible actions are : run ci [all], run ci [job1, job2]\n Example : <denchmark-link:https://github.com/mxnet-bot>@mxnet-bot</denchmark-link>\n  run ci [all]\n Example : <denchmark-link:https://github.com/mxnet-bot>@mxnet-bot</denchmark-link>\n  run ci [centos-cpu, clang]\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ChaiBapchya", "commentT": "2020-07-26T23:14:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-bot>@mxnet-bot</denchmark-link>\n  test if it detects that this is an issue and not a PR\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "ChaiBapchya", "commentT": "2020-07-26T23:14:18Z", "comment_text": "\n \t\tHey <denchmark-link:https://github.com/ChaiBapchya>@ChaiBapchya</denchmark-link>\n \n <denchmark-link:https://github.com/mxnet-bot>@mxnet-bot</denchmark-link>\n  can only be invoked on a PR.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "ChaiBapchya", "commentT": "2020-07-26T23:21:02Z", "comment_text": "\n \t\tPlease ignore previous comments. I just used them for testing out a bot functionality.\n \t\t"}}}, "commit": {"commit_id": "6692d2cc76c4bb841d43abbe53f4d4aff059ba77", "commit_author": "JackieWu", "commitT": "2020-04-11 21:43:12+08:00", "commit_complexity": {"commit_NLOC": "0.5", "commit_CCN": "1.0", "commit_Nprams": "0.5"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\operator\\tensor\\ravel.cc", "file_new_name": "src\\operator\\tensor\\ravel.cc", "file_complexity": {"file_NLOC": "64", "file_CCN": "0", "file_NToken": "381"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "65,66,67,68,69,70,71,72,73,74", "deleted_lines": "65,66"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\tensor\\ravel.h", "file_new_name": "src\\operator\\tensor\\ravel.h", "file_complexity": {"file_NLOC": "136", "file_CCN": "14", "file_NToken": "1394"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "79,80,81,82,83,84,85,86,90,95,96", "deleted_lines": "79,80,88", "method_info": {"method_name": "mxnet::op::UnravelOpShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "71", "method_endline": "100", "method_complexity": {"method_NLOC": "30", "method_CCN": "4", "method_NToken": "299", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "167,168,169", "deleted_lines": "159,160", "method_info": {"method_name": "mxnet::op::UnravelForward", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "152", "method_endline": "171", "method_complexity": {"method_NLOC": "20", "method_CCN": "1", "method_NToken": "299", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\python\\unittest\\test_operator.py", "file_new_name": "tests\\python\\unittest\\test_operator.py", "file_complexity": {"file_NLOC": "8207", "file_CCN": "1321", "file_NToken": "100801"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "8432,8433,8434,8435,8436,8437,8438,8439,8440", "deleted_lines": null, "method_info": {"method_name": "test_unravel_index", "method_params": "", "method_startline": "8432", "method_endline": "8440", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "112", "method_nesting_level": "0"}}}}}}}}