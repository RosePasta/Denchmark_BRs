{"BR": {"BR_id": "16670", "BR_author": "DickJC123", "BRopenT": "2019-10-29T17:57:58Z", "BRcloseT": "2019-11-04T19:58:44Z", "BR_text": {"BRsummary": "cuDNN RNN dtype_with_fallback_ calc needs update", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n In src/operator/rnn-inl.h, the calculation of the mathPrec passed to cudnnSetRNNDescriptor_v6() needs review (the variable is dtype_with_fallback_).  The current logic is:\n <denchmark-code>#if __CUDA_ARCH__ < 530 && CUDNN_VERSION >= 7500\n       if (dtype_ == CUDNN_DATA_HALF) {\n         dtype_with_fallback_ = CUDNN_DATA_FLOAT;\n       } else {\n         dtype_with_fallback_ = dtype_;\n       }\n #else\n         dtype_with_fallback_ = dtype_;\n #endif\n </denchmark-code>\n \n The use of __CUDA_ARCH__ in determining host-side code behavior is not appropriate (the variable would be undefined in this case and interpreted as 0 in all cases).  Thus the intent of the code (to ensure pseudo-fp16 handling of RNNs for Maxwell GPUs even after the API change of cuDNN 7.5) is being applied to all architectures.\n My recommendation would be to adopt pseudo-fp16 for all architectures anyway.  A possible fix:\n <denchmark-code>    cudnnDataType_t dtype_with_fallback_ =\n         (CUDNN_VERSION >= 7500 && dtype_ == CUDNN_DATA_HALF) ? CUDNN_DATA_FLOAT\n                                                              : dtype_; \n </denchmark-code>\n \n Technically, since cuDNN prior to v7.5 ignores the use mathPrec in cudnnSetRNNDescriptor_v6(), the CUDNN_VERSION >= 7500 term could be dropped with no impact.\n While we're fixing this, I think we should consider turning on Tensor Cores by default, or at least giving the user a mechanism to do so.\n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n To verify my claim about __CUDA_ARCH__, I inserted the following code in rnn-inl.h just before the definition of dtype_with_fallback_:\n <denchmark-code>#ifdef __CUDA_ARCH__\n       LOG(INFO) << \"************* __CUDA_ARCH__ = \" << __CUDA_ARCH__;\n #else\n       LOG(INFO) << \"************* __CUDA_ARCH__ is not defined\";\n #endif\n </denchmark-code>\n \n <denchmark-code>$ nosetests --verbose -s tests/python/gpu/test_operator_gpu.py:test_rnn\n ...\n [10:53:00] src/operator/./rnn-inl.h:1388: ************* __CUDA_ARCH__ is not defined\n [10:53:00] src/operator/./rnn-inl.h:1388: ************* __CUDA_ARCH__ is not defined\n </denchmark-code>\n \n <denchmark-link:https://github.com/stu1130>@stu1130</denchmark-link>\n  <denchmark-link:https://github.com/ptrendx>@ptrendx</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "DickJC123", "commentT": "2019-10-29T21:01:59Z", "comment_text": "\n \t\tThanks for the suggestion <denchmark-link:https://github.com/DickJC123>@DickJC123</denchmark-link>\n \n I created a quick fix <denchmark-link:https://github.com/apache/incubator-mxnet/pull/16671>#16671</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "DickJC123", "commentT": "2019-11-04T19:50:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/DickJC123>@DickJC123</denchmark-link>\n  do you think we can close the issue?\n My though is that there are two things in the issue, first one was addressed but the the second one which is enabling the Tensor Cores by default is not tackled yet so I kept it open. But feel free to close it and maybe create enabling Tensor Cores issue if you want.\n \t\t"}}}, "commit": {"commit_id": "77e8f516e7f3d7d2a6c40387028a82ffd761909c", "commit_author": "Jake Lee", "commitT": "2019-10-30 16:33:15-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\rnn-inl.h", "file_new_name": "src\\operator\\rnn-inl.h", "file_complexity": {"file_NLOC": "1315", "file_CCN": "175", "file_NToken": "8235"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1379,1380,1381,1382", "deleted_lines": "1379,1382,1383,1384,1385,1386,1387,1388,1389,1390,1391,1392,1393", "method_info": {"method_name": "mxnet::op::RNNOp::Init", "method_params": "ctx,s,in_data,out_data", "method_startline": "1192", "method_endline": "1491", "method_complexity": {"method_NLOC": "219", "method_CCN": "28", "method_NToken": "1338", "method_nesting_level": "3"}}}}}}}}