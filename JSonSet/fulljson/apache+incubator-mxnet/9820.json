{"BR": {"BR_id": "9820", "BR_author": "marcoabreu", "BRopenT": "2018-02-18T11:13:26Z", "BRcloseT": "2018-03-01T10:55:31Z", "BR_text": {"BRsummary": "Flaky test_gluon_model_zoo_gpu.test_training @ Python3: MKLDNN-GPU", "BRdescription": "\n <denchmark-link:http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-9809/4/pipeline>http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-9809/4/pipeline</denchmark-link>\n \n <denchmark-link:http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/389/pipeline>http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/389/pipeline</denchmark-link>\n \n <denchmark-link:http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/391/pipeline>http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/391/pipeline</denchmark-link>\n \n <denchmark-link:http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/387/pipeline>http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/387/pipeline</denchmark-link>\n \n <denchmark-code>======================================================================\n \n FAIL: test_gluon_model_zoo_gpu.test_training\n \n ----------------------------------------------------------------------\n \n Traceback (most recent call last):\n \n   File \"/usr/local/lib/python3.5/dist-packages/nose/case.py\", line 198, in runTest\n \n     self.test(*self.arg)\n \n   File \"/workspace/tests/python/gpu/../unittest/common.py\", line 155, in test_new\n \n     orig_test(*args, **kwargs)\n \n   File \"/workspace/tests/python/gpu/test_gluon_model_zoo_gpu.py\", line 159, in test_training\n \n     assert_almost_equal(cpu_out.asnumpy(), gpu_out.asnumpy(), rtol=1e-2, atol=1e-2)\n \n   File \"/workspace/python/mxnet/test_utils.py\", line 493, in assert_almost_equal\n \n     raise AssertionError(msg)\n \n AssertionError: \n \n Items are not equal:\n \n Error 84.491165 exceeds tolerance rtol=0.010000, atol=0.010000.  Location of maximum error:(9, 877), a=0.816808, b=-0.181214\n \n  a: array([[ 0.46908194,  0.25131682,  0.27432024, ..., -0.3243659 ,\n \n         -0.8637756 ,  0.57461524],\n \n        [ 0.18945426,  0.32339886,  0.18884647, ...,  0.00044107,...\n \n  b: array([[ 0.34904164,  0.3221189 ,  0.05189171, ..., -0.14858764,\n \n         -0.9381798 ,  0.39666444],\n \n        [ 0.3438487 ,  0.4455883 ,  0.32494336, ...,  0.15454161,...\n \n -------------------- >> begin captured logging << --------------------\n \n urllib3.connectionpool: DEBUG: Starting new HTTP connection (1): data.mxnet.io\n \n urllib3.connectionpool: DEBUG: http://data.mxnet.io:80 \"GET /data/val-5k-256.rec HTTP/1.1\" 200 150874780\n \n root: INFO: downloaded http://data.mxnet.io/data/val-5k-256.rec into data/val-5k-256.rec successfully\n \n common: INFO: Setting test np/mx/python random seeds, use MXNET_TEST_SEED=1760574333 to reproduce.\n \n --------------------- >> end captured logging << ---------------------\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "marcoabreu", "commentT": "2018-02-18T17:03:00Z", "comment_text": "\n \t\tI think we should disable it for now.\n I run the tests many times. It seems both CPU and GPU occasionally generate\n incorrect results. I need more time to test the tests.\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Sun, Feb 18, 2018 at 3:13 AM Marco de Abreu ***@***.***> wrote:\n  \u00b4\u00b4\u00b4 FAIL: test_gluon_model_zoo_gpu.test_training\n \n  Traceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/nose/case.py\", line 197, in\n  runTest\n  self.test(*self.arg)\n  File \"/workspace/tests/python/gpu/test_gluon_model_zoo_gpu.py\", line 150,\n  in test_training\n  assert_almost_equal(cpu_out.asnumpy(), gpu_out.asnumpy(), rtol=1e-2,\n  atol=1e-2)\n  File \"/workspace/python/mxnet/test_utils.py\", line 495, in\n  assert_almost_equal\n  raise AssertionError(msg)\n  AssertionError:\n  Items are not equal:\n  Error 76.641708 exceeds tolerance rtol=0.010000, atol=0.010000. Location\n  of maximum error:(9, 304), a=0.754152, b=-0.052508\n  a: array([[ 0.45648926, -0.19809955, 0.35798055, ..., 1.0708873 ,\n  -0.3380539 , -0.22070615],\n  [ 0.42138988, 0.02357741, 0.38420224, ..., 1.0584493 ,...\n  b: array([[ 0.28696495, -0.17991166, 0.37088192, ..., 1.0100358 ,\n  -0.3728746 , -0.14392784],\n  [ 0.27283525, 0.03558442, 0.45698166, ..., 0.9900025 ,...\n  -------------------- >> begin captured logging << --------------------\n  urllib3.connectionpool: DEBUG: Starting new HTTP connection (1):\n  data.mxnet.io\n  urllib3.connectionpool: DEBUG: http://data.mxnet.io:80 \"GET\n  /data/val-5k-256.rec HTTP/1.1\" 200 150874780\n  root: INFO: downloaded http://data.mxnet.io/data/val-5k-256.rec into\n  data/val-5k-256.rec successfully\n  --------------------- >> end captured logging << ---------------------\n  \u00b4\u00b4\u00b4\n \n  \u2014\n  You are receiving this because you are subscribed to this thread.\n  Reply to this email directly, view it on GitHub\n  <#9820>, or mute the\n  thread\n  <https://github.com/notifications/unsubscribe-auth/AAETUbgbE8AKGK5QtCNCn119Qr8M2JNlks5tWAXYgaJpZM4SJpzP>\n  .\n \n \n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "marcoabreu", "commentT": "2018-02-18T17:05:37Z", "comment_text": "\n \t\tSounds good. Since we've now got the CI randomness PR merged into the master, it should be no problem to generate faulty tests.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "marcoabreu", "commentT": "2018-02-21T08:21:32Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/piiswrong>@piiswrong</denchmark-link>\n  <denchmark-link:https://github.com/szha>@szha</denchmark-link>\n  are you fine with disabling this test?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "marcoabreu", "commentT": "2018-02-21T08:24:49Z", "comment_text": "\n \t\tAh wait. I just checked a few runs of test failures and it ONLY happens with MKLDNN. It looks to me like this is not a flaky test but could rather have a problem in the underlying implementation.\n <denchmark-link:https://github.com/zheng-da>@zheng-da</denchmark-link>\n  <denchmark-link:https://github.com/mli>@mli</denchmark-link>\n  can you please make sure this gets resolved? This test is one of the biggest failure reasons and there might be a valid test failure.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "marcoabreu", "commentT": "2018-02-21T15:49:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/marcoabreu>@marcoabreu</denchmark-link>\n  Thanks for the testing.\n Seems it's a non-deterministic failure both in GPU and CPU backend.\n We will take look this case to figure out the root cause w/ .\n BTW, the root cause of  <denchmark-link:https://github.com/apache/incubator-mxnet/issues/9843>#9843</denchmark-link>\n , <denchmark-link:https://github.com/apache/incubator-mxnet/issues/9844>#9844</denchmark-link>\n  & <denchmark-link:https://github.com/apache/incubator-mxnet/issues/9845>#9845</denchmark-link>\n  may be the same as this one so I think we can duplicate these issues and track the progress in one thread.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "marcoabreu", "commentT": "2018-02-21T17:07:17Z", "comment_text": "\n \t\tAt least <denchmark-link:https://github.com/apache/incubator-mxnet/issues/9845>#9845</denchmark-link>\n  is not MKLDNN specific - I've seen (deterministic) failures in that test before, see <denchmark-link:https://github.com/apache/incubator-mxnet/issues/8780>#8780</denchmark-link>\n .\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "marcoabreu", "commentT": "2018-02-21T17:58:12Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/marcoabreu>@marcoabreu</denchmark-link>\n  I was testing it yesterday. It seems the problem exists when MKLDNN is compiled into MXNet, so it should be a bug caused by the code inside USE_MKLDNN. I'll look into the problem this week and try to fix it as soon as possible.\n I agree with <denchmark-link:https://github.com/pengzhao-intel>@pengzhao-intel</denchmark-link>\n  . This problem might be related to the other flaky failures.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "marcoabreu", "commentT": "2018-02-21T21:51:10Z", "comment_text": "\n \t\tI run more tests. The bug occurs when MKLDNN is compiled into MXNet and we use the threaded engine, which is the default executing engine. If we use the naive executing engine, the problem doesn't show up. It means that the bug isn't in the operator implementation. It should be in the executor engine or in the NDArray.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "marcoabreu", "commentT": "2018-02-21T21:55:05Z", "comment_text": "\n \t\tThank you for the elaboration!\n <denchmark-link:https://github.com/szha>@szha</denchmark-link>\n  <denchmark-link:https://github.com/piiswrong>@piiswrong</denchmark-link>\n  what do you think?\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "marcoabreu", "commentT": "2018-02-21T21:57:06Z", "comment_text": "\n \t\tMost likely, what happens is that an operation needs to wait for some variables before proceeding to the next operator, but somehow the implementation doesn't wait for the right variables or misses some variables.\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "marcoabreu", "commentT": "2018-02-22T19:22:43Z", "comment_text": "\n \t\tAfter one day of testing, I think I know where the problem is now. Basically, the current implementation sometimes needs to convert data format (from the MKLDNN format to the default format) inside an NDArray. In the threaded execution engine, while an NDArray is being converted in a thread, the array can also be read by another thread. In this case, the other thread can read wrong data.\n I changed the code to avoid data layout conversion inside an NDArray. It seems to work fine now. I'll have more tests.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "marcoabreu", "commentT": "2018-02-22T19:26:44Z", "comment_text": "\n \t\tGreat news, thanks for diving deep on this problem!\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "marcoabreu", "commentT": "2018-03-01T10:55:31Z", "comment_text": "\n \t\tFixed as of <denchmark-link:https://github.com/apache/incubator-mxnet/pull/9862>#9862</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "f9c2689ec2ffd61ce123dce5857f8a797f21e4df", "commit_author": "Da Zheng", "commitT": "2018-03-01 11:54:35+01:00", "commit_complexity": {"commit_NLOC": "0.3880597014925373", "commit_CCN": "0.014925373134328358", "commit_Nprams": "0.746268656716418"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "include\\mxnet\\ndarray.h", "file_new_name": "include\\mxnet\\ndarray.h", "file_complexity": {"file_NLOC": "594", "file_CCN": "92", "file_NToken": "4655"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "625,626,627,628", "deleted_lines": "625", "method_info": {"method_name": "mxnet::NDArray::MKLDNNDataReorder", "method_params": "desc", "method_startline": "625", "method_endline": "628", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "29", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 10, "file_old_name": "src\\ndarray\\ndarray.cc", "file_new_name": "src\\ndarray\\ndarray.cc", "file_complexity": {"file_NLOC": "1681", "file_CCN": "369", "file_NToken": "16444"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "582,583,584,585", "deleted_lines": "584,585,586,587", "method_info": {"method_name": "mxnet::NDArray::GetMKLDNNData", "method_params": "", "method_startline": "580", "method_endline": "617", "method_complexity": {"method_NLOC": "31", "method_CCN": "7", "method_NToken": "338", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "627,628,629,630", "deleted_lines": null, "method_info": {"method_name": "mxnet::NDArray::CopyFrom", "method_params": "mem", "method_startline": "619", "method_endline": "699", "method_complexity": {"method_NLOC": "63", "method_CCN": "12", "method_NToken": "820", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574", "deleted_lines": "537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574", "method_info": {"method_name": "mxnet::NDArray::MKLDNNDataReorder", "method_params": "pd", "method_startline": "537", "method_endline": "574", "method_complexity": {"method_NLOC": "29", "method_CCN": "7", "method_NToken": "317", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "556,557,558,559,560,561,562,563,564,565,566", "deleted_lines": "556,557,558,559,560,561,562,563,564,565,566", "method_info": {"method_name": "mxnet::NDArray::Reorder2DefaultAsync", "method_params": "", "method_startline": "556", "method_endline": "566", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "97", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "1896,1897,1898,1899,1900,1901", "deleted_lines": null, "method_info": {"method_name": "mxnet::NDArray::SyncCopyToCPU", "method_params": "data,size", "method_startline": "1887", "method_endline": "1919", "method_complexity": {"method_NLOC": "26", "method_CCN": "5", "method_NToken": "265", "method_nesting_level": "1"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554", "deleted_lines": "537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554", "method_info": {"method_name": "mxnet::NDArray::Reorder2Default", "method_params": "", "method_startline": "536", "method_endline": "554", "method_complexity": {"method_NLOC": "16", "method_CCN": "3", "method_NToken": "190", "method_nesting_level": "1"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416", "deleted_lines": null, "method_info": {"method_name": "mxnet::NDArray::Chunk::MKLDNNDataReorder", "method_params": "pd", "method_startline": "381", "method_endline": "417", "method_complexity": {"method_NLOC": "29", "method_CCN": "7", "method_NToken": "291", "method_nesting_level": "1"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "1063,1072", "deleted_lines": null, "method_info": {"method_name": "mxnet::CopyFromToDnsImpl", "method_params": "from,to,ctx", "method_startline": "1029", "method_endline": "1076", "method_complexity": {"method_NLOC": "37", "method_CCN": "11", "method_NToken": "422", "method_nesting_level": "1"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "378,379", "deleted_lines": "378", "method_info": {"method_name": "mxnet::NDArray::Chunk::Reorder2Default", "method_params": "", "method_startline": "360", "method_endline": "379", "method_complexity": {"method_NLOC": "15", "method_CCN": "2", "method_NToken": "171", "method_nesting_level": "1"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "568,569,570,571,572,573,574,575,576,577,578", "deleted_lines": "568,569,570,571,572,573,574,575", "method_info": {"method_name": "mxnet::NDArray::MKLDNNDataReorderAsync", "method_params": "desc", "method_startline": "568", "method_endline": "578", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "108", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_base.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_base.cc", "file_complexity": {"file_NLOC": "336", "file_CCN": "98", "file_NToken": "3119"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "273,275,276,277,278,279,281,282,283,284,285,286,287,288,289,291,292", "deleted_lines": null, "method_info": {"method_name": "mxnet::FallBackCompute", "method_params": "fn,attrs,ctx,inputs,req,outputs", "method_startline": "267", "method_endline": "301", "method_complexity": {"method_NLOC": "30", "method_CCN": "6", "method_NToken": "327", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "file_complexity": {"file_NLOC": "304", "file_CCN": "48", "file_NToken": "3079"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "265,266,274,275,276,277,278,282,283,284,285,286,287,288,289,290", "deleted_lines": "265,266,274,275,276,277,281,282,283", "method_info": {"method_name": "mxnet::op::MKLDNNConvolutionForward", "method_params": "attrs,ctx,in_data,req,out_data", "method_startline": "259", "method_endline": "302", "method_complexity": {"method_NLOC": "34", "method_CCN": "6", "method_NToken": "395", "method_nesting_level": "2"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_deconvolution.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_deconvolution.cc", "file_complexity": {"file_NLOC": "325", "file_CCN": "40", "file_NToken": "3219"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "237,242,243,244,245,249,250,251,252,253,254,255,256,257", "deleted_lines": "241,242,243,244,245,249,250,251", "method_info": {"method_name": "mxnet::op::MKLDNNDeconvForward::SetDataHandle", "method_params": "param,ctx,in_data,req,out_data", "method_startline": "230", "method_endline": "266", "method_complexity": {"method_NLOC": "30", "method_CCN": "4", "method_NToken": "268", "method_nesting_level": "2"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_fully_connected.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_fully_connected.cc", "file_complexity": {"file_NLOC": "164", "file_CCN": "25", "file_NToken": "1785"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "93,94,95,96,97", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::MKLDNNFCForward", "method_params": "attrs,ctx,in_data,req,out_data", "method_startline": "83", "method_endline": "130", "method_complexity": {"method_NLOC": "44", "method_CCN": "8", "method_NToken": "618", "method_nesting_level": "2"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\tensor\\cast_storage-inl.h", "file_new_name": "src\\operator\\tensor\\cast_storage-inl.h", "file_complexity": {"file_NLOC": "324", "file_CCN": "61", "file_NToken": "2689"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "354,355,356,357,358,359", "deleted_lines": "354", "method_info": {"method_name": "mxnet::op::CastStorageComputeImpl", "method_params": "ctx,input,output", "method_startline": "332", "method_endline": "369", "method_complexity": {"method_NLOC": "33", "method_CCN": "16", "method_NToken": "342", "method_nesting_level": "2"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\tensor\\elemwise_sum.cc", "file_new_name": "src\\operator\\tensor\\elemwise_sum.cc", "file_complexity": {"file_NLOC": "140", "file_CCN": "19", "file_NToken": "1083"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "127,128", "deleted_lines": "125,127,128,129,130,131,132", "method_info": {"method_name": "mxnet::op::ElementWiseSumComputeExCPU", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "108", "method_endline": "132", "method_complexity": {"method_NLOC": "23", "method_CCN": "6", "method_NToken": "253", "method_nesting_level": "2"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\python\\gpu\\test_gluon_model_zoo_gpu.py", "file_new_name": "tests\\python\\gpu\\test_gluon_model_zoo_gpu.py", "file_complexity": {"file_NLOC": "133", "file_CCN": "14", "file_NToken": "1194"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "160,161,162,163", "deleted_lines": "159", "method_info": {"method_name": "test_training", "method_params": "", "method_startline": "104", "method_endline": "180", "method_complexity": {"method_NLOC": "61", "method_CCN": "6", "method_NToken": "598", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "89,90,91", "deleted_lines": "90", "method_info": {"method_name": "test_inference", "method_params": "", "method_startline": "41", "method_endline": "92", "method_complexity": {"method_NLOC": "43", "method_CCN": "4", "method_NToken": "415", "method_nesting_level": "0"}}}}}}}}