{"BR": {"BR_id": "18854", "BR_author": "kpuatamazon", "BRopenT": "2020-08-03T19:41:59Z", "BRcloseT": "2020-08-17T09:27:51Z", "BR_text": {"BRsummary": "Default CPU allocator no longer multiple of 64 bytes", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n CPUs perform best when tensors are allocated at a multiple of 64 bytes.  The reason is that AVX512 instructions operate on 64 bytes at a time and memory access is more efficient when memory is aligned.\n This code intends to align to a multiple of 64 bytes:\n \n \n \n incubator-mxnet/src/storage/cpu_device_storage.h\n \n \n         Lines 54 to 56\n       in\n       4bb8224\n \n \n \n \n \n \n  // MKLDNN requires special alignment. 64 is used by the MKLDNN library in \n \n \n \n  // memory allocation. \n \n \n \n  static constexpr size_t alignment_ = kMKLDNNAlign; \n \n \n \n \n \n However, the above code pedantically only controls overall alignment of memory blocks, not the storage managers that divvy them up. Commit <denchmark-link:https://github.com/apache/incubator-mxnet/commit/3ef00b8840c05c49118705f6fd9663ebb951f3a1>3ef00b8</denchmark-link>\n  broke 64-byte alignment in the default storage manager.\n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n \n Add the line\n \n   CHECK_EQ(reinterpret_cast<intptr_t>(handle->dptr) % 64, 0);\n here: \n \n \n incubator-mxnet/src/storage/storage.cc\n \n \n          Line 205\n       in\n       4bb8224\n \n \n \n \n \n \n  } \n \n \n \n \n \n 2. Compile MXNet including MKLDNN (otherwise 16-byte alignment is allowed though in my opinion it shouldn't be, since compilers can still vectorize without MKLDNN).\n 3. Use MXNet to compute something (and be sure to print it out to actually force things to happen).  Do this often enough and you'll get errors from the above check.\n Note that doing the same on <denchmark-link:https://github.com/apache/incubator-mxnet/commit/2abf0b8c2b3361c73c9dfdeabdb8a88278b693d0>2abf0b8</denchmark-link>\n  works successfully without error.\n cc <denchmark-link:https://github.com/andrei5055>@andrei5055</denchmark-link>\n  <denchmark-link:https://github.com/pengzhao-intel>@pengzhao-intel</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "kpuatamazon", "commentT": "2020-08-05T10:23:08Z", "comment_text": "\n \t\tI will take a look at this\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "kpuatamazon", "commentT": "2020-08-07T05:20:23Z", "comment_text": "\n \t\t\n I will take a look at this\n \n Thanks \ud83d\udc4d\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "kpuatamazon", "commentT": "2020-08-17T09:27:51Z", "comment_text": "\n \t\tFixed by <denchmark-link:https://github.com/apache/incubator-mxnet/pull/18885>#18885</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "ee80b77d423efab6563cc14482fc294d73c1f7ff", "commit_author": "bgawrych", "commitT": "2020-08-13 22:19:52-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.6666666666666666"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\common\\utils.h", "file_new_name": "src\\common\\utils.h", "file_complexity": {"file_NLOC": "660", "file_CCN": "191", "file_NToken": "4939"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "953,954,955,956,957,958,959,960,961,962,963,964", "deleted_lines": null, "method_info": {"method_name": "mxnet::common::AlignedMemAlloc", "method_params": "ptr,size,alignment", "method_startline": "953", "method_endline": "964", "method_complexity": {"method_NLOC": "9", "method_CCN": "4", "method_NToken": "58", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "966,967,968,969,970,971,972", "deleted_lines": null, "method_info": {"method_name": "mxnet::common::AlignedMemFree", "method_params": "ptr", "method_startline": "966", "method_endline": "972", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "18", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\storage\\cpu_device_storage.h", "file_new_name": "src\\storage\\cpu_device_storage.h", "file_complexity": {"file_NLOC": "20", "file_CCN": "3", "file_NToken": "130"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "68", "deleted_lines": "67,68,69", "method_info": {"method_name": "mxnet::storage::CPUDeviceStorage::Free", "method_params": "handle", "method_startline": "67", "method_endline": "69", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "22", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "63,64", "deleted_lines": "63,64,65", "method_info": {"method_name": "mxnet::storage::CPUDeviceStorage::Alloc", "method_params": "handle", "method_startline": "62", "method_endline": "65", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "48", "method_nesting_level": "2"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\storage\\storage_manager_helpers.h", "file_new_name": "src\\storage\\storage_manager_helpers.h", "file_complexity": {"file_NLOC": "92", "file_CCN": "23", "file_NToken": "684"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "114,115", "deleted_lines": "113,116", "method_info": {"method_name": "mxnet::storage::ContextHelperCPU::Malloc", "method_params": "ppNtr,size", "method_startline": "113", "method_endline": "116", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "37", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "118,119,120", "deleted_lines": null, "method_info": {"method_name": "mxnet::storage::ContextHelperCPU::Free", "method_params": "dptr", "method_startline": "118", "method_endline": "120", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "3"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\cpp\\storage\\storage_test.cc", "file_new_name": "tests\\cpp\\storage\\storage_test.cc", "file_complexity": {"file_NLOC": "87", "file_CCN": "7", "file_NToken": "721"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70", "deleted_lines": null, "method_info": {"method_name": "TEST", "method_params": "Storage,CPU_MemAlign", "method_startline": "50", "method_endline": "70", "method_complexity": {"method_NLOC": "14", "method_CCN": "3", "method_NToken": "137", "method_nesting_level": "0"}}}}}}}}