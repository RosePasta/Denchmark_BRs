{"BR": {"BR_id": "12404", "BR_author": "szha", "BRopenT": "2018-08-30T05:05:14Z", "BRcloseT": "2019-07-19T22:33:12Z", "BR_text": {"BRsummary": "init.Constant does not work in symbol", "BRdescription": "\n Note: Providing complete information in the most concise form is the best way to get help. This issue template serves as the checklist for essential information to most of the technical issues and bug reports. For non-technical issues and feature requests, feel free to present the information in what you believe is the best form.\n For Q & A and discussion, please start a discussion thread at <denchmark-link:https://discuss.mxnet.io>https://discuss.mxnet.io</denchmark-link>\n \n <denchmark-h:h2>Description</denchmark-h>\n \n init.Constant fails when used in gluon parameter\n <denchmark-h:h2>Minimum reproducible example</denchmark-h>\n \n <denchmark-h:h3>Symbol</denchmark-h>\n \n import mxnet as mx\n import numpy as np\n net = mx.sym.var('a', init=mx.init.Constant(np.ones((5, 5))))\n ---------------------------------------------------------------------------\n <ipython-input-1-777255712a8b> in <module>()\n       1 import mxnet as mx\n       2 import numpy as np\n ----> 3 net = mx.sym.var('a', init=mx.init.Constant(np.ones((5, 5))))\n \n mxnet/symbol/symbol.py in var(name, attr, shape, lr_mult, wd_mult, dtype, init, stype, **kwargs)\n    2516     if init is not None:\n    2517         if not isinstance(init, string_types):\n -> 2518             init = init.dumps()\n    2519         attr['__init__'] = init\n    2520     if stype is not None:\n \n mxnet/initializer.py in dumps(self)\n     113         '[\"xavier\", {\"rnd_type\": \"uniform\", \"magnitude\": 2.34, \"factor_type\": \"in\"}]'\n     114         \"\"\"\n --> 115         return json.dumps([self.__class__.__name__.lower(), self._kwargs])\n     116\n     117     def __call__(self, desc, arr):\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/__init__.py in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)\n     229         cls is None and indent is None and separators is None and\n     230         default is None and not sort_keys and not kw):\n --> 231         return _default_encoder.encode(obj)\n     232     if cls is None:\n     233         cls = JSONEncoder\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in encode(self, o)\n     197         # exceptions aren't as detailed.  The list call should be roughly\n     198         # equivalent to the PySequence_Fast that ''.join() would do.\n --> 199         chunks = self.iterencode(o, _one_shot=True)\n     200         if not isinstance(chunks, (list, tuple)):\n     201             chunks = list(chunks)\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in iterencode(self, o, _one_shot)\n     255                 self.key_separator, self.item_separator, self.sort_keys,\n     256                 self.skipkeys, _one_shot)\n --> 257         return _iterencode(o, 0)\n     258\n     259 def _make_iterencode(markers, _default, _encoder, _indent, _floatstr,\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in default(self, o)\n     177\n     178         \"\"\"\n --> 179         raise TypeError(f'Object of type {o.__class__.__name__} '\n     180                         f'is not JSON serializable')\n     181\n \n TypeError: Object of type ndarray is not JSON serializable\n <denchmark-h:h3>Impact on Gluon</denchmark-h>\n \n import mxnet as mx\n from mxnet import gluon\n net = gluon.nn.Dense(5)\n import numpy as np\n net = gluon.nn.Dense(5, weight_initializer=mx.init.Constant(np.ones((5, 5))))\n net.initialize()\n net.hybridize()\n net(mx.nd.ones((5, 5)))\n \n ---------------------------------------------------------------------------\n TypeError                                 Traceback (most recent call last)\n <ipython-input-7-812f6ff55149> in <module>()\n ----> 1 net(mx.nd.ones((5, 5)))\n \n mxnet/python/mxnet/gluon/block.py in __call__(self, *args)\n     539             hook(self, args)\n     540\n --> 541         out = self.forward(*args)\n     542\n     543         for hook in self._forward_hooks.values():\n \n mxnet/python/mxnet/gluon/block.py in forward(self, x, *args)\n     906             with x.context as ctx:\n     907                 if self._active:\n --> 908                     return self._call_cached_op(x, *args)\n     909\n     910                 try:\n \n mxnet/python/mxnet/gluon/block.py in _call_cached_op(self, *args)\n     796     def _call_cached_op(self, *args):\n     797         if self._cached_op is None:\n --> 798             self._build_cache(*args)\n     799\n     800         args, fmt = _flatten(args, \"input\")\n \n mxnet/python/mxnet/gluon/block.py in _build_cache(self, *args)\n     748\n     749     def _build_cache(self, *args):\n --> 750         data, out = self._get_graph(*args)\n     751         data_names = {data.name : i for i, data in enumerate(data)}\n     752         params = self.collect_params()\n \n mxnet/python/mxnet/gluon/block.py in _get_graph(self, *args)\n     738             grouped_inputs = _regroup(inputs, self._in_format)[0]\n     739\n --> 740             params = {i: j.var() for i, j in self._reg_params.items()}\n     741             with self.name_scope():\n     742                 out = self.hybrid_forward(symbol, *grouped_inputs, **params)  # pylint: disable=no-value-for-parameter\n \n mxnet/python/mxnet/gluon/block.py in <dictcomp>(.0)\n     738             grouped_inputs = _regroup(inputs, self._in_format)[0]\n     739\n --> 740             params = {i: j.var() for i, j in self._reg_params.items()}\n     741             with self.name_scope():\n     742                 out = self.hybrid_forward(symbol, *grouped_inputs, **params)  # pylint: disable=no-value-for-parameter\n \n mxnet/python/mxnet/gluon/parameter.py in var(self)\n     553             self._var = symbol.var(self.name, shape=self.shape, dtype=self.dtype,\n     554                                    lr_mult=self.lr_mult, wd_mult=self.wd_mult,\n --> 555                                    init=self.init, stype=self._stype)\n     556         return self._var\n     557\n \n mxnet/python/mxnet/symbol/symbol.py in var(name, attr, shape, lr_mult, wd_mult, dtype, init, stype, **kwargs)\n    2516     if init is not None:\n    2517         if not isinstance(init, string_types):\n -> 2518             init = init.dumps()\n    2519         attr['__init__'] = init\n    2520     if stype is not None:\n \n mxnet/python/mxnet/initializer.py in dumps(self)\n     113         '[\"xavier\", {\"rnd_type\": \"uniform\", \"magnitude\": 2.34, \"factor_type\": \"in\"}]'\n     114         \"\"\"\n --> 115         return json.dumps([self.__class__.__name__.lower(), self._kwargs])\n     116\n     117     def __call__(self, desc, arr):\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/__init__.py in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)\n     229         cls is None and indent is None and separators is None and\n     230         default is None and not sort_keys and not kw):\n --> 231         return _default_encoder.encode(obj)\n     232     if cls is None:\n     233         cls = JSONEncoder\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in encode(self, o)\n     197         # exceptions aren't as detailed.  The list call should be roughly\n     198         # equivalent to the PySequence_Fast that ''.join() would do.\n --> 199         chunks = self.iterencode(o, _one_shot=True)\n     200         if not isinstance(chunks, (list, tuple)):\n     201             chunks = list(chunks)\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in iterencode(self, o, _one_shot)\n     255                 self.key_separator, self.item_separator, self.sort_keys,\n     256                 self.skipkeys, _one_shot)\n --> 257         return _iterencode(o, 0)\n     258\n     259 def _make_iterencode(markers, _default, _encoder, _indent, _floatstr,\n \n /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/json/encoder.py in default(self, o)\n     177\n     178         \"\"\"\n --> 179         raise TypeError(f'Object of type {o.__class__.__name__} '\n     180                         f'is not JSON serializable')\n     181\n \n TypeError: Object of type ndarray is not JSON serializable\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "szha", "commentT": "2019-05-03T00:46:11Z", "comment_text": "\n \t\tThe error happens here - <denchmark-link:https://github.com/apache/incubator-mxnet/blob/master/python/mxnet/initializer.py#L116>https://github.com/apache/incubator-mxnet/blob/master/python/mxnet/initializer.py#L116</denchmark-link>\n  while trying to serialize a  array into json format.\n I think the fix is instead of using the in-built json.dumps we should write our own custom JSONEncoder and JSONDecoder that will extend the one implemented in json package. This implementation should handle numpy.ndarrays. I will try to do that.\n \t\t"}}}, "commit": {"commit_id": "da71324882808f6e6b1bc520076f65113636bc54", "commit_author": "Abhinav Sharma", "commitT": "2019-07-19 15:33:11-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\mxnet\\initializer.py", "file_new_name": "python\\mxnet\\initializer.py", "file_complexity": {"file_NLOC": "580", "file_CCN": "108", "file_NToken": "2973"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "467,468,469,470,471", "deleted_lines": null, "method_info": {"method_name": "dumps", "method_params": "self", "method_startline": "467", "method_endline": "471", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "74", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\python\\unittest\\test_init.py", "file_new_name": "tests\\python\\unittest\\test_init.py", "file_complexity": {"file_NLOC": "64", "file_CCN": "7", "file_NToken": "794"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "72,73,74,75,76,77,78,79,80,81,82,83,84", "deleted_lines": null, "method_info": {"method_name": "test_const_init_dumps", "method_params": "", "method_startline": "72", "method_endline": "84", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "142", "method_nesting_level": "0"}}}}}}}}