{"BR": {"BR_id": "3348", "BR_author": "danielkingai2", "BRopenT": "2019-03-01T19:04:09Z", "BRcloseT": "2019-03-06T22:58:39Z", "BR_text": {"BRsummary": "Document similarity does not work on gpu with models including word vectors", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n It seems that the document similarity function does not work on GPU for spacy models that have word vectors.\n <denchmark-code>Python 3.6.7 | packaged by conda-forge | (default, Feb 28 2019, 09:07:38) \n [GCC 7.3.0] on linux\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n >>> import spacy\n >>> spacy.prefer_gpu()\n True\n >>> nlp = spacy.load('en_core_web_md')\n >>> doc1 = nlp(\"this is some text.\")\n >>> doc2 = nlp(\"this is some more text.\")\n >>> doc1.similarity(doc2)\n Traceback (most recent call last):\n   File \"<stdin>\", line 1, in <module>\n   File \"doc.pyx\", line 322, in spacy.tokens.doc.Doc.similarity\n   File \"doc.pyx\", line 386, in spacy.tokens.doc.Doc.vector_norm.__get__\n   File \"doc.pyx\", line 361, in spacy.tokens.doc.Doc.vector.__get__\n   File \"cupy/core/core.pyx\", line 1741, in cupy.core.core.ndarray.__array_ufunc__\n   File \"cupy/core/_kernel.pyx\", line 789, in cupy.core._kernel.ufunc.__call__\n   File \"cupy/core/_kernel.pyx\", line 86, in cupy.core._kernel._preprocess_args\n TypeError: Unsupported type <class 'numpy.ndarray'>\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n <denchmark-h:h2>Info about spaCy</denchmark-h>\n \n \n spaCy version: 2.0.18\n Platform: Linux-4.4.0-112-generic-x86_64-with-debian-stretch-sid\n Python version: 3.6.7\n Models: en_core_web_md, en_core_web_sm\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "danielkingai2", "commentT": "2019-03-06T13:22:33Z", "comment_text": "\n \t\tThanks! Disappointed I made this error, but I'm pretty sure I see what's wrong. If you have a look here:\n <denchmark-link:https://github.com/explosion/spaCy/blob/develop/spacy/tokens/doc.pyx#L332>https://github.com/explosion/spaCy/blob/develop/spacy/tokens/doc.pyx#L332</denchmark-link>\n \n You should see that there's a direct call to numpy.dot(). We instead want to do something like:\n vector = self.vector\n xp = thinc.neural.util.get_array_module(vector)\n xp.dot(...)\n This should select cupy or numpy, depending on the data. I don't have a GPU server booted just now, so if it's easy for you to do so, would you mind submitting a PR? You should also check the token.similarity() and span.similarity() methods, and ideally have a quick look for other direct invocations of numpy if the data could be on GPU.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "danielkingai2", "commentT": "2019-04-05T23:56:43Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "5f40229397f8ed283386f8422432dfdbecfcdc07", "commit_author": "Daniel King", "commitT": "2019-03-06 22:58:38+00:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": ".github\\contributors\\danielkingai2.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\lexeme.pyx", "file_new_name": "spacy\\lexeme.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "11,127,128,129,130", "deleted_lines": "126"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\doc.pyx", "file_new_name": "spacy\\tokens\\doc.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "324,325,326,327,362", "deleted_lines": "324,359,360,361,362"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\span.pyx", "file_new_name": "spacy\\tokens\\span.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "9,218,219,220,221", "deleted_lines": "217"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\token.pyx", "file_new_name": "spacy\\tokens\\token.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12,169,170,171,172", "deleted_lines": "168"}}}}}}