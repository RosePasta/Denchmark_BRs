{"BR": {"BR_id": "4673", "BR_author": "mmaybeno", "BRopenT": "2019-11-19T21:43:50Z", "BRcloseT": "2019-12-10T08:48:47Z", "BR_text": {"BRsummary": "vector_norm throws error for unusual text in sentence with more than one word.", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n I found this bug that I'm not sure if it resides in spacy or cupy. It only appears on GPU instances and when you try to get vectors from a multiple word document containing non standard words. Any help tracking it down with a potential fix would be fantastic.\n <denchmark-code>import en_core_web_md\n import spacy\n spacy.prefer_gpu()\n nlp = en_core_web_md.load()\n \n doc = nlp(\"somerandomword\")\n doc.vector_norm\n # works\n \n doc = nlp(\"somerandomword.\")\n doc.vector_norm\n # throws type error\n \n doc = nlp(\"The somerandomword\")\n doc.vector_norm\n # throws type error\n </denchmark-code>\n \n <denchmark-code>---------------------------------------------------------------------------\n TypeError                                 Traceback (most recent call last)\n <ipython-input-96-d19c7b8f8943> in <module>()\n ----> 1 doc.vector_norm\n doc.pyx in spacy.tokens.doc.Doc.vector_norm.__get__()\n doc.pyx in __iter__()\n cupy/core/core.pyx in cupy.core.core.ndarray.__add__()\n cupy/core/_kernel.pyx in cupy.core._kernel.ufunc.__call__()\n cupy/core/_kernel.pyx in cupy.core._kernel._preprocess_args()\n TypeError: Unsupported type <class 'numpy.ndarray'>\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n Operating System: Ubuntu 18.04.3\n Python Version Used: 3.6.8\n spaCy Version Used: 2.2.2\n Environment Information: Running on Google Colab but also experienced it on other GPU instances.\n \n <denchmark-code>+-----------------------------------------------------------------------------+\n | NVIDIA-SMI 430.50       Driver Version: 418.67       CUDA Version: 10.1     |\n |-------------------------------+----------------------+----------------------+\n | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n |===============================+======================+======================|\n |   0  Tesla K80           Off  | 00000000:00:04.0 Off |                    0 |\n | N/A   34C    P8    26W / 149W |      0MiB / 11441MiB |      0%      Default |\n +-------------------------------+----------------------+----------------------+\n                                                                                \n +-----------------------------------------------------------------------------+\n | Processes:                                                       GPU Memory |\n |  GPU       PID   Type   Process name                             Usage      |\n |=============================================================================|\n |  No running processes found                                                 |\n +-----------------------------------------------------------------------------+\n </denchmark-code>\n \n <denchmark-code>!pip install spacy==2.2.2\n !pip install chainer\n !pip install thinc_gpu_ops thinc\n !python -m spacy download en_core_web_md \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mmaybeno", "commentT": "2019-11-19T21:48:19Z", "comment_text": "\n \t\tFor context. I found this  PR that was merged recently and thought that would fix it, but building from source didn't appear to fix this issue.\n <denchmark-link:https://github.com/cupy/cupy/pull/2611>cupy/cupy#2611</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "mmaybeno", "commentT": "2019-11-19T22:33:58Z", "comment_text": "\n \t\tI think it has to do with this part specifically.\n \n <denchmark-link:https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx#L439>https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx#L439</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "mmaybeno", "commentT": "2019-11-19T22:38:18Z", "comment_text": "\n \t\tFound it. There is a case where a token will have an empty numpy.ndarray instead of a cupy.core.core.ndarray, which makes incompatible types when you try and sum them.\n <denchmark-code>[type(t.vector) for t in nlp(\"somerandomword.\")]\n # [numpy.ndarray, cupy.core.core.ndarray]\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "mmaybeno", "commentT": "2019-11-19T22:59:27Z", "comment_text": "\n \t\tVocab's  defaults to a numpy array, so if the word does not exist it will stay a zero numpy array. I think this is the bug. <denchmark-link:https://github.com/explosion/spaCy/blob/master/spacy/vocab.pyx#L364>https://github.com/explosion/spaCy/blob/master/spacy/vocab.pyx#L364</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "mmaybeno", "commentT": "2019-11-20T06:26:03Z", "comment_text": "\n \t\tAttempting to create a PR for this fix but unsure on how to test it since it's cupy related.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "mmaybeno", "commentT": "2019-12-10T08:48:47Z", "comment_text": "\n \t\tFixed by <denchmark-link:https://github.com/explosion/spaCy/pull/4680>#4680</denchmark-link>\n .\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "mmaybeno", "commentT": "2019-12-10T17:08:13Z", "comment_text": "\n \t\tAwesome!\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "mmaybeno", "commentT": "2020-01-09T18:01:55Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "c9f1e99787073869bca07eb1fe43e8054f29d8ae", "commit_author": "Matt Maybeno", "commitT": "2019-11-23 14:59:52+01:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": ".github\\contributors\\mmaybeno.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\vocab.pyx", "file_new_name": "spacy\\vocab.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "363,364,384", "deleted_lines": "6,364,384"}}}}}}