{"BR": {"BR_id": "4717", "BR_author": "RandomJungle", "BRopenT": "2019-11-26T11:37:36Z", "BRcloseT": "2019-12-06T18:22:58Z", "BR_text": {"BRsummary": "Error on token attribute in pattern matcher", "BRdescription": "\n Hello,\n I noticed a strange behavior when updating to new version 2.2.3 from the version I was using before, which was 2.1.4. The 'LENGTH' attribute of token used in patterns started to match on anything. Below is the piece of code I used to reproduce the error:\n <denchmark-code>import spacy\n from spacy.matcher import Matcher\n nlp = spacy.load(\"fr_core_news_md\")\n matcher = Matcher(nlp.vocab)\n pattern = [{'SHAPE': 'dddd', 'LENGTH': 9}]\n matcher.add(\"number\", None, pattern)\n doc = nlp(\"Bonjour nous sommes bien en 2005 ! Il est 9h du matin\")\n matches = matcher(doc)\n print(matches)\n </denchmark-code>\n \n On former version, there was no match, which is expected behavior. On newer version however, I get a match on 2005, [(432, 5, 6)]. Now here's a run of the same code, without the \"shape\" ingredient :\n <denchmark-code>import spacy\n from spacy.matcher import Matcher\n nlp = spacy.load(\"fr_core_news_md\")\n matcher = Matcher(nlp.vocab)\n pattern = [{'LENGTH': 10}]\n matcher.add(\"number\", None, pattern)\n doc = nlp(\"Bonjour nous sommes bien en 2005 ! Il est 9h du matin, surprenant !\")\n matches = matcher(doc)\n if matches:\n     for match in matches:\n         print(doc[match[1]:match[2]])\n </denchmark-code>\n \n It prints out every token of the sentence, which is odd to me, since LENGTH is listed as one of the token attribute that can be used in matcher on the official doc. Now if I run the exact same code with the former version (2.1.4) with model 2.1 of fr_core_news_md, it prints out \"surprenant\", which makes sense.\n Is the LENGTH attribute of the token deprecated in the new model version ?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "RandomJungle", "commentT": "2019-11-26T15:03:36Z", "comment_text": "\n \t\tUpdate : I noticed that on release 2.2.2 it was mentioned that a new pattern adding behavior had been added, meant to replace the former. I tried using that but it produced the same result :\n <denchmark-code>import spacy\n from spacy.matcher import Matcher\n nlp = spacy.load(\"fr_core_news_md\")\n matcher = Matcher(nlp.vocab)\n pattern = [[{'LENGTH': 10}]]\n matcher.add(\"number\", pattern)\n doc = nlp(\"Bonjour nous sommes bien en 2005 ! Il est 9h du matin, surprenant !\")\n matches = matcher(doc)\n if matches:\n     for match in matches:\n         print(doc[match[1]:match[2]])\n </denchmark-code>\n \n prints out :\n <denchmark-code>Bonjour\n nous\n sommes\n bien\n en\n 2005\n !\n Il\n est\n 9h\n du\n matin\n ,\n surprenant\n !\n </denchmark-code>\n \n Unless I missed another major change on version 2.2 that explains that behavior ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "RandomJungle", "commentT": "2019-11-26T15:06:20Z", "comment_text": "\n \t\tNo, this looks like an unrelated bug. I can reproduce the problem and will see if I can figure out what's going on.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "RandomJungle", "commentT": "2019-11-29T08:09:32Z", "comment_text": "\n \t\tIn spacy v2.1, invalid features were silently discarded, so you could have {'ASDF': 'asdf'} and it would act like {}. We tried to improve the validation so that you couldn't add as many obviously invalid patterns without validate=True and so that Matcher with validate=True would run a complete pattern scheme validation.\n It looks like  ends up passing the validation (see <denchmark-link:https://github.com/explosion/spaCy/issues/4442>#4442</denchmark-link>\n ) but is still being silently discarded, which is kind of the worst of both options.\n I still have to figure out why the integer version is not working as expected, but in the meanwhile, this pattern syntax does work:\n <denchmark-code>[{'LENGTH': {\"==\": 2}}]\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "RandomJungle", "commentT": "2019-11-29T09:25:15Z", "comment_text": "\n \t\tGot it,\n I ended up using the 'REGEX' operator but I think this will be faster, thanks a lot for the workaround !\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "RandomJungle", "commentT": "2020-01-05T19:35:49Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "c208eb6e4d26ae874a84dd4485bd809599748552", "commit_author": "adrianeboyd", "commitT": "2019-12-06 19:22:57+01:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\matcher\\matcher.pyx", "file_new_name": "spacy\\matcher\\matcher.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "680,681,682", "deleted_lines": "680"}}}}}}