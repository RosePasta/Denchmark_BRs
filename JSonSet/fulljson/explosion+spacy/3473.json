{"BR": {"BR_id": "3473", "BR_author": "Tpt", "BRopenT": "2019-03-23T19:49:51Z", "BRcloseT": "2019-03-31T11:59:21Z", "BR_text": {"BRsummary": "TextCategorizer: TypeError: Only cupy arrays can be concatenated (Training on GPU)", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n Sorry for bothering you again with the nearly same problem. After upgrading to Spacy 2.1.3, if I try to train a text categorizer with CUDA enabled, I get back the error . It seems to be the same problem as <denchmark-link:https://github.com/explosion/spaCy/issues/3355>#3355</denchmark-link>\n \n I purged my venv and made a pip install --upgrade 'spacy[cuda100]', so it's probably not because an old library version is kept in my environment.\n Backtrace:\n <denchmark-code>Traceback (most recent call last):\n ...\n     nlp.update(texts, annotations, sgd=optimizer, drop=0.5, losses=losses)\n   File \"venv/lib/python3.7/site-packages/spacy/language.py\", line 452, in update\n     proc.update(docs, golds, sgd=get_grads, losses=losses, **kwargs)\n   File \"pipes.pyx\", line 931, in spacy.pipeline.pipes.TextCategorizer.update\n   File \"venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py\", line 46, in begin_update\n     X, inc_layer_grad = layer.begin_update(X, drop=drop)\n   File \"venv/lib/python3.7/site-packages/thinc/api.py\", line 132, in begin_update\n     values = [fwd(X, *a, **k) for fwd in forward]\n   File \"venv/lib/python3.7/site-packages/thinc/api.py\", line 132, in <listcomp>\n     values = [fwd(X, *a, **k) for fwd in forward]\n   File \"venv/lib/python3.7/site-packages/thinc/api.py\", line 225, in wrap\n     output = func(*args, **kwargs)\n   File \"venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py\", line 46, in begin_update\n     X, inc_layer_grad = layer.begin_update(X, drop=drop)\n   File \"venv/lib/python3.7/site-packages/spacy/_ml.py\", line 138, in begin_update\n     keys = self.ops.xp.concatenate(ngrams)\n   File \"venv/lib/python3.7/site-packages/cupy/manipulation/join.py\", line 49, in concatenate\n     return core.concatenate_method(tup, axis)\n   File \"cupy/core/_routines_manipulation.pyx\", line 561, in cupy.core._routines_manipulation.concatenate_method\n   File \"cupy/core/_routines_manipulation.pyx\", line 574, in cupy.core._routines_manipulation.concatenate_method\n TypeError: Only cupy arrays can be concatenated\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n spaCy version    2.1.3\n Platform         Linux-5.0.3-arch1-1-ARCH-x86_64-with-arch\n Python version   3.7.2\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Tpt", "commentT": "2019-03-26T09:30:43Z", "comment_text": "\n \t\tArgh. Thanks for the report. We still don't have a CI server running the GPU paths, so it's really hard to prevent this reliably. For now you could edit your spacy/_ml.py file to make the following patch:\n <denchmark-code>613 def build_bow_text_classifier(nr_class, ngram_size=1, exclusive_classes=False,\n 614         no_output_layer=False, **cfg):\n 615     with Model.define_operators({\">>\": chain}):\n 616         model = (\n 617             with_cpu(Model.ops,\n 618                 extract_ngrams(ngram_size, attr=ORTH)\n 619                 >> LinearModel(nr_class)\n 620             )\n 621         )\n 622         if not no_output_layer:\n 623             model = model >> (cpu_softmax if exclusive_classes else logistic)\n 624     model.nO = nr_class\n 625     return model\n 626\n </denchmark-code>\n \n Thanks for your help reporting.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Tpt", "commentT": "2019-03-26T09:38:57Z", "comment_text": "\n \t\tThank you for maintaining this amazing library and for the hot fix!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Tpt", "commentT": "2019-04-30T12:52:17Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "f77bf2bdb1b62b97e9582fcc14d4550448a6340d", "commit_author": "Matthew Honnibal", "commitT": "2019-03-26 13:36:11+01:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\_ml.py", "file_new_name": "spacy\\_ml.py", "file_complexity": {"file_NLOC": "596", "file_CCN": "131", "file_NToken": "4989"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "617,618,619", "deleted_lines": "617,618,619"}}}}}}