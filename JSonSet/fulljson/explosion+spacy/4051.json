{"BR": {"BR_id": "4051", "BR_author": "prashantbudania", "BRopenT": "2019-07-30T22:46:02Z", "BRcloseT": "2019-09-08T11:04:50Z", "BR_text": {"BRsummary": "Retokenizer not setting POS tags correctly", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n I am trying to merge entities and noun chunks for a custom application without having to use merge_entities or merge_noun_chunks pipeline. But the pos tag information is inaccurate. Here's one example:\n <denchmark-code>import spacy \n from spacy import displacy\n from spacy.util import filter_spans\n \n nlp = spacy.load('en_2.1.0_md')\n doc = nlp(\"While our net charge-off rate improved from a year ago, our provision expense increased due to a $150 million reserve build in the first quarter of 2019 compared with a $550 million reserve release a year ago.\")\n \n spans = list(doc.ents) + list(doc.noun_chunks)\n spans = filter_spans(spans)\n \n with doc.retokenize() as retokenizer:\n     for span in spans:\n         retokenizer.merge(span)\n \n for i, tkn in enumerate(doc):\n     print(\"{:<2}{:<2}{:<32}{:<2}{:<8}{:<2}{:<8}{:<2}{:<2}\".format(i, '|', tkn.text, '|', tkn.pos_, '|', tkn.dep_, '|', tkn.ent_type_))\n </denchmark-code>\n \n But if I specifically set the pos attribute to be the same as the root's attribute, it works fine:\n <denchmark-code>with doc.retokenize() as retokenizer:\n     for span in spans:\n         retokenizer.merge(span, attrs={\"POS\": span.root.pos_})\n </denchmark-code>\n \n I remember this being the default behaviour in 2.0. And also, even after the fix, displacy would show the incorrect pos tag information:\n <denchmark-code>displacy.render(doc, style='dep')\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n Operating System: MacOS\n Python Version Used: 3.6\n spaCy Version Used: 2.1.4\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "prashantbudania", "commentT": "2019-07-31T08:46:21Z", "comment_text": "\n \t\tThanks for the report. I think what you're obversing here in displaCy might be related to a recent change that made the pos attribute writable (but possibly doesn't always account for the pos \u2192 tag) relationship. What happens if you set both the POS and the TAG?\n And yes, I do think it makes sense for those attribute to default to the root \u2013 not sure why this isn't happening here.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "prashantbudania", "commentT": "2019-07-31T14:44:38Z", "comment_text": "\n \t\tYeah, it works fine if both the POS and the TAG attributes are set.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "prashantbudania", "commentT": "2019-10-08T11:42:58Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "aec755d3a3439c406801543c004975d718af4a56", "commit_author": "adrianeboyd", "commitT": "2019-09-08 13:04:49+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "spacy\\tests\\doc\\test_retokenize_merge.py", "file_new_name": "spacy\\tests\\doc\\test_retokenize_merge.py", "file_complexity": {"file_NLOC": "340", "file_CCN": "39", "file_NToken": "3817"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134", "deleted_lines": null, "method_info": {"method_name": "test_doc_retokenize_spans_merge_tokens_default_attrs", "method_params": "en_tokenizer", "method_startline": "102", "method_endline": "134", "method_complexity": {"method_NLOC": "33", "method_CCN": "3", "method_NToken": "363", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "185,198,218", "method_info": {"method_name": "test_doc_retokenize_spans_entity_merge_iob", "method_params": "", "method_startline": "185", "method_endline": "218", "method_complexity": {"method_NLOC": "32", "method_CCN": "1", "method_NToken": "319", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "220,233,234,238,239,240,241,242,243,244,245,246,247,248,249,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312", "deleted_lines": null, "method_info": {"method_name": "test_doc_retokenize_spans_entity_merge_iob", "method_params": "en_vocab", "method_startline": "220", "method_endline": "312", "method_complexity": {"method_NLOC": "83", "method_CCN": "1", "method_NToken": "873", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\_retokenize.pyx", "file_new_name": "spacy\\tokens\\_retokenize.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "112,113,138,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,281,400,401,402,403,404,405,406,407,408", "deleted_lines": "112,113,114,115,116,117,118,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,354,355,356,357,358,359,360,361,362,363,364"}}}}}}