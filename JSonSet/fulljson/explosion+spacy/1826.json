{"BR": {"BR_id": "1826", "BR_author": "sanjeeku", "BRopenT": "2018-01-11T10:46:38Z", "BRcloseT": "2018-12-08T11:27:22Z", "BR_text": {"BRsummary": "Segmentation fault if text too long or doc parsed twice", "BRdescription": "\n I just installed Spacy 2.0.5 in Python 3.6.4 (that Anaconda).\n I also installed the default model ('en')\n Spacy is giving seg fault when I try to load my text file (it is about 2MB in size).\n Here's the code the reproduces it:\n Python 3.6.4 |Anaconda, Inc.| (default, Dec 21 2017, 21:42:08)\n [GCC 7.2.0] on linux\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n \n \n \n import spacy\n nlp = spacy.load('en')\n with open('wf.txt') as f:\n ...     text = f.read()\n ...\n doc = nlp(text)\n Segmentation fault (core dumped)\n \n \n \n I tried with another text file (slightly larger though) with the same result.\n <denchmark-h:h2>Info about spaCy</denchmark-h>\n \n \n spaCy version: 2.0.5\n Platform: Linux-4.10.0-42-generic-x86_64-with-debian-stretch-sid\n Python version: 3.6.4\n Models: en\n \n Is there any other information I can provide to troubleshoot this seg fault?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "sanjeeku", "commentT": "2018-01-11T11:14:55Z", "comment_text": "\n \t\tAn update:  I tried on a new/clean aws instance where I installed Spacy differently (using conda forge). I still got the same seg fault.\n Here's the environment info:\n (py3) ubuntu@ip-172-31-16-211:~$ python -m spacy info --markdown\n <denchmark-h:h2>Info about spaCy</denchmark-h>\n \n \n spaCy version: 2.0.4\n Platform: Linux-4.4.0-1048-aws-x86_64-with-debian-stretch-sid\n Python version: 3.6.4\n Models: en\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "sanjeeku", "commentT": "2018-01-11T11:21:20Z", "comment_text": "\n \t\tFurther update:\n I had an old conda env with spacy 1.9.0 installed.\n Both text files were parsed perfectly.\n So the SegFault issue is only with Spacy 2.0 or later (I have tested with 2.0.4 and 2.0.5)\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "sanjeeku", "commentT": "2018-01-30T17:03:41Z", "comment_text": "\n \t\tI am experiencing a similar issue, though it occurs when using the English language model parse method. The problem occurs < 1% of the time in a corpus of 250K documents, but I have yet to determine its root cause. An example paragraph is shown below.\n Similarly, the problem occurs in 2.0.5, but is not present in 1.9.0. I have reproduced this across multiple machines.\n \n spaCy version: 2.0.5\n Platform: Ubuntu 14.04\n Python version: 2.7\n Models: en\n \n <denchmark-code>import spacy\n \n nlp  = spacy.load('en')\n text = u'This will be a prospective study in patients aged between 18 and 70 years old who have already been screened and planned for elective bariatric surgery. In bariatric surgery, a large portion of the stomach will be removed. Pneumoperitoneum is also known as the abdominal pressure which will be the experimental aspect in this study. Laparoscopy surgery will be performed by introducing the camera (optical trocar) after making an incision at the belly button (umbilicus), and carbon dioxide which will be given at a rate of 5 L/min until the intra abdominal pressure of either 8 10 mmHg (low pressure group) or 12 15 mmHg (standard pressure group) is achieved. The remaining three standard ports will be placed and the laparoscopic sleeve gastrectomy will be performed at an insufflation rate of 15 L/min. The greater omentum will be divided at the greater curvature of the stomach using an ultrasonic dissector, beginning from the proximal antrum until the fundus. The omentum will be divided close to the stomach wall hence preserving the gastro epiploic vessels. Short gastric vessels will be divided entirely from the stomach and this dissection will continue until the left crus of the diaphragm are exposed. Endoscopic staplers will then be used to staple and divide the stomach until the angle of His. A 39Fr gastric calibration tube will be placed along the lesser curvature of the stomach, acts as a guide during the division of the stomach. Finally, the divided stomach will be removed through a 12mm port site and the incision will be closed with sutures. Towards the end of the surgery, all residual pneumoperitoneum will be evacuated by keeping the trocar valves open under direct telescopic vision. The duration of surgery or any intraoperative complications will be recorded. The starting of surgery will be regarded after the induction of anaesthesia and the end of surgery is regarded when the end of skin closure. Operating field or also known as surgical view is defined as the view of the intra abdomen. A clear operating field allows a good working space for the surgeon. Numeric rating score will be used to access the operating field during the surgery. Post operative pain will be rated on a Visual Analog Scale at rest and with movement.'\n \n doc = nlp(text) # works\n nlp.parse(doc) # Segmentation fault/core dump\n \n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "sanjeeku", "commentT": "2018-02-05T05:53:32Z", "comment_text": "\n \t\tConfirming that this bug continues to exists in Spacy v2.0.7\n <denchmark-link:https://github.com/honnibal>@honnibal</denchmark-link>\n  - I am happy to privately send you the text files on which it is bombing. Please let me know where to send.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "sanjeeku", "commentT": "2018-02-17T21:21:36Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/sanjeeku>@sanjeeku</denchmark-link>\n  Thanks, could you mail to <denchmark-link:mailto:matt@explosion.ai>matt@explosion.ai</denchmark-link>\n  ?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "sanjeeku", "commentT": "2018-03-05T16:52:49Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/honnibal>@honnibal</denchmark-link>\n  -- Just emailed the text file.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "sanjeeku", "commentT": "2018-03-29T20:29:29Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/sanjeeku>@sanjeeku</denchmark-link>\n  Thanks for the text, finally got to this.\n Your issue is simply that the text is too long. This is rather frustrating --- I wish we used less temporary memory per word than the neural networks currently do. However, I don't see a way around this without significantly impacting performance.\n I've added an error message and added an option on the Language class to note the problem. In your case, the solution is very simple: just process each newline individually.\n <denchmark-link:https://github.com/godelstheory>@godelstheory</denchmark-link>\n  Your problem is different. I think the problem occurs from parsing the text twice. This shouldn't cause a segfault, but as a workaround, you can avoid doing that for now? You can verify that the double-parsing is the problem by changing the first line to .\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "sanjeeku", "commentT": "2019-01-07T11:28:03Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "23afa6429f460a8fbea704d221884b10659b90f6", "commit_author": "Matthew Honnibal", "commitT": "2018-03-29 21:45:26+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "spacy\\language.py", "file_new_name": "spacy\\language.py", "file_complexity": {"file_NLOC": "529", "file_CCN": "123", "file_NToken": "3859"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "353,354,355,356,357,358,359,360,361,362,363", "deleted_lines": null, "method_info": {"method_name": "__call__", "method_params": "self,text,disable", "method_startline": "339", "method_endline": "369", "method_complexity": {"method_NLOC": "18", "method_CCN": "4", "method_NToken": "88", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "114,129,130,131,132,133,134,135,136,137,153", "deleted_lines": "114", "method_info": {"method_name": "__init__", "method_params": "self,vocab,make_doc,max_length,meta,kwargs", "method_startline": "114", "method_endline": "154", "method_complexity": {"method_NLOC": "16", "method_CCN": "4", "method_NToken": "154", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "114,129,130,131,132,133,134,135,136,137", "deleted_lines": "114", "method_info": {"method_name": "__init__", "method_params": "self,vocab,make_doc,meta,kwargs", "method_startline": "114", "method_endline": "144", "method_complexity": {"method_NLOC": "15", "method_CCN": "4", "method_NToken": "143", "method_nesting_level": "1"}}}}}}}}