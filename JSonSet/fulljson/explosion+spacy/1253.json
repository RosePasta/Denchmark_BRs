{"BR": {"BR_id": "1253", "BR_author": "leighhopcroft", "BRopenT": "2017-08-10T19:11:31Z", "BRcloseT": "2017-10-20T14:29:41Z", "BR_text": {"BRsummary": "RuntimeError: Array bounds exceeded while searching for root word. This likely means the parse tree is in an invalid state.", "BRdescription": "\n I'm trying to merge any multi-token entities found in a text in to a single token with the following code adapted from <denchmark-link:https://explosion.ai/blog/sense2vec-with-spacy>https://explosion.ai/blog/sense2vec-with-spacy</denchmark-link>\n \n My code within a function that processes a generator of texts:\n <denchmark-code>for doc in nlp.pipe(texts, batch_size=batch_size, n_threads=n_threads):\n     # Iterate over named entities\n         for ent in doc.ents:\n             if len(ent) > 1:\n                 # Merge them into single tokens\n                 ent.merge(ent.root.tag_, ent.text, ent.label_)\n </denchmark-code>\n \n I get the following error on one entity when trying to perform the merge:\n <denchmark-code>File \"spacy/tokens/span.pyx\", line 307, in spacy.tokens.span.Span.root.__get__ (spacy/tokens/span.cpp:7562)\n   File \"spacy/tokens/span.pyx\", line 415, in spacy.tokens.span._count_words_to_root (spacy/tokens/span.cpp:10330)\n RuntimeError: Array bounds exceeded while searching for root word. This likely means the parse tree is in an invalid state. Please report this issue here: http://github.com/explosion/spaCy/issues\n </denchmark-code>\n \n The particular entity in question is \"\u00a332 million\" and the error seems to occur when trying to access the ent.root.tag_ attribute.\n I'm using a Python 3.6.2 Conda environment:\n '3.6.2 |Continuum Analytics, Inc.| (default, Jul 20 2017, 13:14:59) \\n[GCC 4.2.1 Compatible Apple LLVM 6.0 (clang-600.0.57)]'\n <denchmark-h:h2>Info about spaCy</denchmark-h>\n \n \n spaCy version: 1.9.0\n Platform: Darwin-16.7.0-x86_64-i386-64bit\n Python version: 3.6.2\n Installed models: en\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leighhopcroft", "commentT": "2017-09-08T19:35:59Z", "comment_text": "\n \t\tI've encountered a similar error.\n I'm using en_core_web_sm and it seems that running its parser on (some type of tokenized text that has been tagged) more than once, corrupts the state of the parse tree, causing exception in _count_words_to_root.\n Repro Step:\n <denchmark-code>import en_core_web_sm\n SPACY_EN_CORE_WEB_SM = en_core_web_sm.load()\n \n def ss(tt):\n ...   for i in range(len(tt)-1):\n ...     for j in range(i+1, len(tt)):\n ...       tt[i:j].root\n \n t_t = SPACY_EN_CORE_WEB_SM.tokenizer(\"Highly rated - I'll definitely\")\n SPACY_EN_CORE_WEB_SM.tagger(t_t)\n SPACY_EN_CORE_WEB_SM.parser(t_t)\n SPACY_EN_CORE_WEB_SM.parser(t_t)\n ss(t_t)\n \n </denchmark-code>\n \n <denchmark-code>  File \"<stdin>\", line 1, in <module>\n   File \"<stdin>\", line 4, in ss\n   File \"spacy/tokens/span.pyx\", line 307, in spacy.tokens.span.Span.root.__get__ (spacy/tokens/span.cpp:7562)\n   File \"spacy/tokens/span.pyx\", line 415, in spacy.tokens.span._count_words_to_root (spacy/tokens/span.cpp:10330)\n RuntimeError: Array bounds exceeded while searching for root word. This likely means the parse tree is in an invalid state. Please report this issue here: http://github.com/explosion/spaCy/issues\n \n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "leighhopcroft", "commentT": "2017-09-09T21:07:09Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/carolingfish>@carolingfish</denchmark-link>\n  Thanks for the clues! That makes things a fair bit easier.\n <denchmark-link:https://github.com/leighhopcroft>@leighhopcroft</denchmark-link>\n  Until the error is fixed, you might be able to work around this by gathering the entities first, and then merging them together. I think the problem at the moment is that the document is changing tokenization after the  property produces the spans. This usually works, but it seems the call to  is throwing it off. If you get a list of the entities and their tags in one step, and then merge them in the next step, it might work around the bug.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "leighhopcroft", "commentT": "2018-05-08T13:27:53Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "f111b228e0bcd65a9b852f2687a7441628355bba", "commit_author": "Matthew Honnibal", "commitT": "2017-10-20 16:27:36+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\syntax\\arc_eager.pyx", "file_new_name": "spacy\\syntax\\arc_eager.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "215,216,450,451,452,453,454,455,456,462", "deleted_lines": "215,449,450,456"}}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "spacy\\tests\\regression\\test_issue1253.py", "file_complexity": {"file_NLOC": "15", "file_CCN": "4", "file_NToken": "102"}}}}}