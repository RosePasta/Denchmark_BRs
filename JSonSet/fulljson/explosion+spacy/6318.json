{"BR": {"BR_id": "6318", "BR_author": "AndriyMulyar", "BRopenT": "2020-10-28T21:34:19Z", "BRcloseT": "2021-01-07T07:48:34Z", "BR_text": {"BRsummary": "Cannot use BiLSTM encoder with transition based NER parser. [spacy-nightly]", "BRdescription": "\n I get the following error when attempting to use the BiLSTM encoder with the NER transition based parser:\n \u2139 Using CPU\n \n =========================== Initializing pipeline ===========================\n \u2718 Can't construct config: calling registry function\n (build_Tok2Vec_model) failed\n spacy.Tok2Vec.v1   \"Cannot get dimension 'nO' for model 'with_padded(with_padded(pytorch))'\"\n \n {'model': {'@architectures': 'spacy.Tok2Vec.v1', 'embed': {'@architectures': 'spacy.MultiHashEmbed.v1', 'width': 100, 'attrs': ['ORTH', 'SHAPE'], 'rows': [5000, 2500], 'include_static_vectors': 'True'}, 'encode': {'@architectures': 'spacy.TorchBiLSTMEncoder.v1', 'width': 100, 'depth': 2, 'dropout': 0.30000000000000004}}}\n Could the pytorch BiLSTM wrapper encoder perhaps be missing a line like this (which appears in the CNN encoders):\n \n \n \n spaCy/spacy/ml/models/tok2vec.py\n \n \n          Line 274\n       in\n       dc816bb\n \n \n \n \n \n \n  model.set_dim(\"nO\", width) \n \n \n \n \n \n \n \n \n spaCy/spacy/ml/models/tok2vec.py\n \n \n          Line 302\n       in\n       dc816bb\n \n \n \n \n \n \n  @registry.architectures.register(\"spacy.TorchBiLSTMEncoder.v1\") \n \n \n \n \n \n Also the docstring is not accurate (seems to be copied from the CNNs)\n My model components look like this:\n [components]\n \n [components.tok2vec]\n factory = \"tok2vec\"\n \n [components.tok2vec.model]\n @architectures = \"spacy.Tok2Vec.v1\"\n \n [components.tok2vec.model.embed]\n @architectures = \"spacy.MultiHashEmbed.v1\"\n width = ${components.tok2vec.model.encode.width}\n attrs = [\"ORTH\", \"SHAPE\"]\n rows = [5000, 2500]\n include_static_vectors = True\n \n [components.tok2vec.model.encode]\n @architectures = \"spacy.TorchBiLSTMEncoder.v1\"\n width = 100\n depth = 2\n dropout = ${training.dropout}\n \n [components.ner]\n factory = \"ner\"\n \n [components.ner.model]\n @architectures = \"spacy.TransitionBasedParser.v1\"\n state_type = \"ner\"\n extra_state_tokens = false\n hidden_width = 64\n maxout_pieces = 2\n use_upper = true\n nO = null\n \n [components.ner.model.tok2vec]\n @architectures = \"spacy.Tok2VecListener.v1\"\n width = ${components.tok2vec.model.encode.width}\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AndriyMulyar", "commentT": "2020-10-29T09:06:39Z", "comment_text": "\n \t\tThanks for the report! That does look suspicious. Usually the nO dimension should be set by initializing the model with example input & output, so that it can infer the dimensions, but this may not work with the Torch encoder. You could be right that we need to set it specifically. I'll have a look!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "AndriyMulyar", "commentT": "2020-11-24T16:45:59Z", "comment_text": "\n \t\tThis issue was a bit more involved than I had initially hoped, but I think <denchmark-link:https://github.com/explosion/spaCy/pull/6442>#6442</denchmark-link>\n  and <denchmark-link:https://github.com/explosion/thinc/pull/432>explosion/thinc#432</denchmark-link>\n  together should fix this. At least the training now runs for me when I replicate your config.\n Thanks again for the detailed report!\n [EDIT: it works when I set include_static_vectors to False and fails with a different error otherwise, but that's another issue that I'm looking into]\n [EDIT 2: Never mind the above, it works with static vectors as well when setting e.g. vectors = \"en_core_web_lg\"]\n \t\t"}}}, "commit": {"commit_id": "75d90193434ce13ff22b4210bfa063f9c3096936", "commit_author": "Sofie Van Landeghem", "commitT": "2021-01-07 16:39:27+11:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.42857142857142855"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\cli\\templates\\quickstart_training.jinja", "file_new_name": "spacy\\cli\\templates\\quickstart_training.jinja", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "208,223", "deleted_lines": "208,223"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "spacy\\ml\\models\\tok2vec.py", "file_new_name": "spacy\\ml\\models\\tok2vec.py", "file_complexity": {"file_NLOC": "376", "file_CCN": "16", "file_NToken": "1657"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "114,115,116", "deleted_lines": null, "method_info": {"method_name": "build_Tok2Vec_model", "method_params": "", "method_startline": "114", "method_endline": "116", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "32", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "314,315", "deleted_lines": null, "method_info": {"method_name": "MaxoutWindowEncoder", "method_params": "int,int,int,int", "method_startline": "314", "method_endline": "315", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "17", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "370,371", "deleted_lines": null, "method_info": {"method_name": "MishWindowEncoder", "method_params": "int,int,int", "method_startline": "370", "method_endline": "371", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\pipeline\\morphologizer.pyx", "file_new_name": "spacy\\pipeline\\morphologizer.pyx", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "27,38", "deleted_lines": "27,38"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\pipeline\\textcat.py", "file_new_name": "spacy\\pipeline\\textcat.py", "file_complexity": {"file_NLOC": "349", "file_CCN": "25", "file_NToken": "1699"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "22,32", "deleted_lines": "22,32"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tests\\pipeline\\test_tok2vec.py", "file_new_name": "spacy\\tests\\pipeline\\test_tok2vec.py", "file_complexity": {"file_NLOC": "161", "file_CCN": "13", "file_NToken": "1139"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "116,126", "deleted_lines": "116,126"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "website\\docs\\api\\architectures.md", "file_new_name": "website\\docs\\api\\architectures.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29,35,42,200,206,224,230,255,256,262,263,264,265,266,267,603,613", "deleted_lines": "29,35,42,200,206,224,230,255,256,262,263,264,265,266,267,603,613"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "website\\docs\\usage\\embeddings-transformers.md", "file_new_name": "website\\docs\\usage\\embeddings-transformers.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "132,138,164,170", "deleted_lines": "132,138,164,170"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "website\\docs\\usage\\layers-architectures.md", "file_new_name": "website\\docs\\usage\\layers-architectures.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "137,147,204,211,227", "deleted_lines": "137,147,204,211,227"}}}}}}