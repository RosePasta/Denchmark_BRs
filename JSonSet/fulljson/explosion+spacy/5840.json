{"BR": {"BR_id": "5840", "BR_author": "mdgilene", "BRopenT": "2020-07-29T15:18:08Z", "BRcloseT": "2020-07-31T14:09:33Z", "BR_text": {"BRsummary": "EntityRuler overlapping matches of the same length, the one appearing last in the document is chosen instead of the first", "BRdescription": "\n Believe this is caused by the following line using reverse=True for both sort keys. It should be reverse sorted on entity length, then regular sort on start index:\n \n \n \n spaCy/spacy/pipeline/entityruler.py\n \n \n         Lines 98 to 99\n       in\n       03ab518\n \n \n \n \n \n \n  get_sort_key = lambda m: (m[2] - m[1], m[1]) \n \n \n \n  matches = sorted(matches, key=get_sort_key, reverse=True) \n \n \n \n \n \n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n <denchmark-code>import spacy\n from spacy.pipeline import EntityRuler\n \n patterns = [\n     {\"label\": \"FOOBAR\", \"pattern\": \"foo bar\"},\n     {\"label\": \"BARBAZ\", \"pattern\": \"bar baz\"},\n ]\n \n nlp = spacy.load(\"en_core_web_sm\")\n ruler = EntityRuler(nlp)\n ruler.add_patterns(patterns)\n nlp.add_pipe(ruler, before=\"ner\")\n \n doc = nlp(\"foo bar baz\")\n \n print([(ent.text, ent.label_, ent.ent_id_) for ent in doc.ents])\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n spaCy version: 2.3.2\n Platform: Windows-10-10.0.17134-SP0\n Python version: 3.7.5\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mdgilene", "commentT": "2020-07-30T07:21:54Z", "comment_text": "\n \t\tThanks for the report! We'd fixed the same issue in util.filter_spans but missed the same issue here.\n \t\t"}}}, "commit": {"commit_id": "ac14ce7c30c2f6da4a71dee7978f5b765af4d966", "commit_author": "Adriane Boyd", "commitT": "2020-07-31 16:09:32+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "spacy\\pipeline\\entityruler.py", "file_new_name": "spacy\\pipeline\\entityruler.py", "file_complexity": {"file_NLOC": "244", "file_CCN": "65", "file_NToken": "1775"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "98", "deleted_lines": "98", "method_info": {"method_name": "__call__", "method_params": "self,doc", "method_startline": "86", "method_endline": "122", "method_complexity": {"method_NLOC": "29", "method_CCN": "15", "method_NToken": "263", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "spacy\\tests\\pipeline\\test_entity_ruler.py", "file_new_name": "spacy\\tests\\pipeline\\test_entity_ruler.py", "file_complexity": {"file_NLOC": "130", "file_CCN": "16", "file_NToken": "1140"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "159,160,161,162,163,164,165,166,167,168", "deleted_lines": null, "method_info": {"method_name": "test_entity_ruler_overlapping_spans", "method_params": "nlp", "method_startline": "159", "method_endline": "168", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "72", "method_nesting_level": "0"}}}}}}}}