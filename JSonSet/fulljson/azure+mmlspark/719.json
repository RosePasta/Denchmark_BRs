{"BR": {"BR_id": "719", "BR_author": "ibnopcit", "BRopenT": "2019-10-18T19:31:05Z", "BRcloseT": "2020-02-26T05:44:38Z", "BR_text": {"BRsummary": "\"port out of range error\" when training", "BRdescription": "\n Hi, I sporadically get the following error when training a LightGBMClassifier on YARN (with varying port numbers):\n <denchmark-code>: org.apache.spark.SparkException: Job aborted due to stage failure: Task 38 in stage 218.0 failed 1 times, most recent failure: Lost task 38.0 in stage 218.0 (TID 22099, gsbl427n05.wherever.com, executor 754): java.lang.IllegalArgumentException: port out of range:66688\n \tat java.net.InetSocketAddress.checkPort(InetSocketAddress.java:143)\n \tat java.net.InetSocketAddress.<init>(InetSocketAddress.java:188)\n \tat java.net.InetSocketAddress.<init>(InetSocketAddress.java:166)\n \tat com.microsoft.ml.spark.lightgbm.TrainUtils$.findOpenPort(TrainUtils.scala:292)\n \tat com.microsoft.ml.spark.lightgbm.TrainUtils$.trainLightGBM(TrainUtils.scala:392)\n \tat com.microsoft.ml.spark.lightgbm.LightGBMBase$$anonfun$6.apply(LightGBMBase.scala:85)\n \tat com.microsoft.ml.spark.lightgbm.LightGBMBase$$anonfun$6.apply(LightGBMBase.scala:85)\n \tat org.apache.spark.sql.execution.MapPartitionsExec$$anonfun$5.apply(objects.scala:188\n </denchmark-code>\n \n I notice the code computes the port number by adding an executor or partition id to a default, but there is no bounds check on the result:\n \n \n \n mmlspark/src/main/scala/com/microsoft/ml/spark/lightgbm/TrainUtils.scala\n \n \n          Line 260\n       in\n       f22aa73\n \n \n \n \n \n \n  val basePort = defaultListenPort + (LightGBMUtils.getId() * numCoresPerExec) \n \n \n \n \n \n Should this be mod 65536?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ibnopcit", "commentT": "2019-10-18T19:31:06Z", "comment_text": "\n \t\t\ud83d\udc4b Thanks for opening your first issue here! If you're reporting a \ud83d\udc1e bug, please make sure you include steps to reproduce it.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ibnopcit", "commentT": "2019-10-21T04:43:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ibnopcit>@ibnopcit</denchmark-link>\n  sorry about the issue you are encountering.  How many workers do you have?  The default listen port starts at 12400, which seems very reasonable:\n <denchmark-link:https://github.com/Azure/mmlspark/blob/master/src/main/scala/com/microsoft/ml/spark/lightgbm/LightGBMConstants.scala#L9>https://github.com/Azure/mmlspark/blob/master/src/main/scala/com/microsoft/ml/spark/lightgbm/LightGBMConstants.scala#L9</denchmark-link>\n \n maybe you have a lot of ports blocked off from access?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ibnopcit", "commentT": "2019-10-21T22:40:11Z", "comment_text": "\n \t\tOnly about 10, but I'm on a big shared cluster.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ibnopcit", "commentT": "2019-10-25T05:10:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ibnopcit>@ibnopcit</denchmark-link>\n \n hmm that does seem like a mystery, not sure why so many ports would be blocked off.  perhaps there is some firewall rule in place on the cluster.  I'm guessing you didn't specify a default port when running lightgbm in the parameters?  If not, then I'm not quite sure how to address this issue.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ibnopcit", "commentT": "2019-10-28T23:40:57Z", "comment_text": "\n \t\tIf nothing else, shouldn't the calculated port be capped at 2^16?\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Fri, Oct 25, 2019 at 12:11 AM Ilya Matiach ***@***.***> wrote:\n  hmm that does seem like a mystery, not sure why so many ports would be\n  blocked off. perhaps there is some firewall rule in place on the cluster.\n  I'm guessing you didn't specify a default port when running lightgbm in the\n  parameters? If not, then I'm not quite sure how to address this issue.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#719?email_source=notifications&email_token=AAE33CP2VBLAB5AJODWSGVTQQJ5WPA5CNFSM4JCLN422YY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOECHGMXY#issuecomment-546203231>,\n  or unsubscribe\n  <https://github.com/notifications/unsubscribe-auth/AAE33CK54COGHDKENKZI7FTQQJ5WPANCNFSM4JCLN42Q>\n  .\n \n \n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "ibnopcit", "commentT": "2019-11-04T04:39:08Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ibnopcit>@ibnopcit</denchmark-link>\n  great idea, we can cap it and throw an exception once we get to the limit.  I'm still a bit confused as to how so many ports could be blocked on your cluster though.  Seems like a real edge-case scenario.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "ibnopcit", "commentT": "2020-02-26T05:44:37Z", "comment_text": "\n \t\tclosing as this has been fixed in latest to have a cap on max allowed port, see PR\n <denchmark-link:https://github.com/Azure/mmlspark/pull/759>#759</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "3da5d4f4cb68b6a6708d26b11497e48393594aa8", "commit_author": "Ilya Matiach", "commitT": "2019-12-17 19:33:58-05:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\main\\scala\\com\\microsoft\\ml\\spark\\lightgbm\\LightGBMConstants.scala", "file_new_name": "src\\main\\scala\\com\\microsoft\\ml\\spark\\lightgbm\\LightGBMConstants.scala", "file_complexity": {"file_NLOC": "13", "file_CCN": "0", "file_NToken": "77"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "10,11,12", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\main\\scala\\com\\microsoft\\ml\\spark\\lightgbm\\TrainUtils.scala", "file_new_name": "src\\main\\scala\\com\\microsoft\\ml\\spark\\lightgbm\\TrainUtils.scala", "file_complexity": {"file_NLOC": "366", "file_CCN": "59", "file_NToken": "3030"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "287,288,289,302,303,304", "deleted_lines": null, "method_info": {"method_name": "findOpenPort", "method_params": "Int,Int,Logger", "method_startline": "285", "method_endline": "314", "method_complexity": {"method_NLOC": "29", "method_CCN": "7", "method_NToken": "154", "method_nesting_level": "0"}}}}}}}}