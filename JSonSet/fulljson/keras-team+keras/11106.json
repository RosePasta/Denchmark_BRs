{"BR": {"BR_id": "11106", "BR_author": "yanboliang", "BRopenT": "2018-09-08T02:07:44Z", "BRcloseT": "2018-09-10T17:50:18Z", "BR_text": {"BRsummary": "Chrome timeline is broken for TensorFlow backend", "BRdescription": "\n Chrome timeline is very useful to profile a Keras model, we can get the execution time for each node in the TF graph. Keras has already supported it since <denchmark-link:https://github.com/keras-team/keras/pull/6693>#6693</denchmark-link>\n  . But it seems this feature is broken since Keras 2.2. Run the following code to reproduce this bug:\n <denchmark-code>import keras\n from keras.datasets import mnist\n from keras.models import Sequential\n from keras.layers import Dense, Dropout\n from keras.optimizers import RMSprop\n \n import tensorflow as tf\n from tensorflow.python.client import timeline\n \n (x_train, y_train), (x_test, y_test) = mnist.load_data()\n \n x_train = x_train.reshape(60000, 784).astype('float32')\n y_train = keras.utils.to_categorical(y_train, 10)\n \n model = Sequential()\n model.add(Dense(512, activation='relu', input_shape=(784,)))\n model.add(Dropout(0.2))\n model.add(Dense(512, activation='relu'))\n model.add(Dropout(0.2))\n model.add(Dense(10, activation='softmax'))\n \n run_options = tf.RunOptions(trace_level=tf.RunOptions.FULL_TRACE)\n run_metadata = tf.RunMetadata()\n \n model.compile(loss='categorical_crossentropy',\n               optimizer=RMSprop(),\n               metrics=['accuracy'],\n               options=run_options,\n               run_metadata=run_metadata)\n \n history = model.fit(x_train, y_train,\n                     batch_size=128,\n                     epochs=1)\n \n trace = timeline.Timeline(step_stats=run_metadata.step_stats)\n with open('/tmp/timeline.json', 'w') as f:\n     f.write(trace.generate_chrome_trace_format())\n </denchmark-code>\n \n This is the exception:\n <denchmark-code>Using TensorFlow backend.\n Traceback (most recent call last):\n   File \"test.py\", line 72, in <module>\n     epochs=1)\n   File \"build/bdist.macosx-10.13-intel/egg/keras/engine/training.py\", line 1016, in fit\n   File \"build/bdist.macosx-10.13-intel/egg/keras/engine/training.py\", line 516, in _make_train_function\n   File \"build/bdist.macosx-10.13-intel/egg/keras/backend/tensorflow_backend.py\", line 2705, in function\n   File \"build/bdist.macosx-10.13-intel/egg/keras/backend/tensorflow_backend.py\", line 2552, in __init__\n ValueError: ('Some keys in session_kwargs are not supported at this time: %s', ['run_metadata', 'options'])\n </denchmark-code>\n \n It seems run_metadata and options arguments are not supported by K.Function.\n \t"}, "comments": {}}, "commit": {"commit_id": "244546c2fe5165b6770eb456afd5fac8878473c5", "commit_author": "Yanbo Liang", "commitT": "2018-09-10 10:50:17-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "keras\\backend\\tensorflow_backend.py", "file_new_name": "keras\\backend\\tensorflow_backend.py", "file_complexity": {"file_NLOC": "1840", "file_CCN": "389", "file_NToken": "13362"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2599,2600,2601", "deleted_lines": null, "method_info": {"method_name": "_make_callable", "method_params": "self,feed_arrays,feed_symbols,symbol_vals,session", "method_startline": "2562", "method_endline": "2610", "method_complexity": {"method_NLOC": "27", "method_CCN": "9", "method_NToken": "220", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "2652,2653,2654,2655", "deleted_lines": "2646", "method_info": {"method_name": "_call", "method_params": "self,inputs", "method_startline": "2612", "method_endline": "2656", "method_complexity": {"method_NLOC": "38", "method_CCN": "13", "method_NToken": "251", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "2685,2686,2687,2688,2689,2690,2691,2692,2693,2694", "deleted_lines": null, "method_info": {"method_name": "__call__", "method_params": "self,inputs", "method_startline": "2676", "method_endline": "2701", "method_complexity": {"method_NLOC": "22", "method_CCN": "12", "method_NToken": "146", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\keras\\backend\\backend_test.py", "file_new_name": "tests\\keras\\backend\\backend_test.py", "file_complexity": {"file_NLOC": "1429", "file_CCN": "216", "file_NToken": "16994"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554", "deleted_lines": null, "method_info": {"method_name": "test_function_tf_run_options_with_run_metadata", "method_params": "self", "method_startline": "533", "method_endline": "554", "method_complexity": {"method_NLOC": "19", "method_CCN": "1", "method_NToken": "164", "method_nesting_level": "1"}}}}}}}}