{"BR": {"BR_id": "3271", "BR_author": "JesseFarebro", "BRopenT": "2020-05-14T09:33:48Z", "BRcloseT": "2020-05-18T23:51:06Z", "BR_text": {"BRsummary": "fetchFunc doesn't work with fully qualified URLs", "BRdescription": "\n <denchmark-h:h4>TensorFlow.js version</denchmark-h>\n \n 2.0.0-rc.4\n <denchmark-h:h4>Describe the problem or feature request</denchmark-h>\n \n Currently, if you supply fetchFunc to a function like loadGraphModel it will ignore fetchFunc if the URL is a fully qualified URL. For example,\n const options = {\n   fetchFunc: (...args) => {\n     console.log(`Custom fetch`)\n     return fetch(...args)\n   }\n }\n \n let model = await loadGraphModel(`/path/model.json`, options) // Works\n model = await loadGraphModel(`https://mydomain.com/path/model.json`, options) // Doesn't work\n model = await loadGraphModel(`//mydomain.com/path/model.json`, options) // Works\n The issue arises as such:\n tfjs first tries to resolve a handler for the URL type. This involves iterating over the known routers. It gets to the HTTP router which will resolve if the following isHTTP check is true:\n \n \n \n tfjs/tfjs-core/src/io/http.ts\n \n \n          Line 42\n       in\n       a60f32f\n \n \n \n \n \n \n  static readonly URL_SCHEME_REGEX = /^https?:\\/\\//; \n \n \n \n \n \n \n \n \n tfjs/tfjs-core/src/io/http.ts\n \n \n         Lines 252 to 254\n       in\n       602111a\n \n \n \n \n \n \n  export function isHTTPScheme(url: string): boolean { \n \n \n \n  return url.match(HTTPRequest.URL_SCHEME_REGEX) != null; \n \n \n \n  } \n \n \n \n \n \n If tfjs resolves any router it won't construct a handler with the provided user options:\n \n \n \n tfjs/tfjs-converter/src/executor/graph_model.ts\n \n \n         Lines 92 to 103\n       in\n       602111a\n \n \n \n \n \n \n  const handlers = \n \n \n \n  io.getLoadHandlers(path as string, this.loadOptions.onProgress); \n \n \n \n  if (handlers.length === 0) { \n \n \n \n  // For backward compatibility: if no load handler can be found, \n \n \n \n  // assume it is a relative http path. \n \n \n \n  handlers.push(io.browserHTTPRequest(path as string, this.loadOptions)); \n \n \n \n  } else if (handlers.length > 1) { \n \n \n \n  throw new Error( \n \n \n \n  `Found more than one (${handlers.length}) load handlers for ` + \n \n \n \n  `URL '${[path]}'`); \n \n \n \n  } \n \n \n \n  this.handler = handlers[0]; \n \n \n \n \n \n I'm not sure what the reasoning for this is, shouldn't the options be passed through regardless?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "JesseFarebro", "commentT": "2020-05-14T17:17:13Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/JesseFarebro>@JesseFarebro</denchmark-link>\n  did you try using  while loading model ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "JesseFarebro", "commentT": "2020-05-14T17:19:07Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/rthadur>@rthadur</denchmark-link>\n  yes, are you referring to my example? I wrote that up quickly in Github, didn't really check it over.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "JesseFarebro", "commentT": "2020-05-14T17:45:03Z", "comment_text": "\n \t\tyes I was referring to your code , is it possible to provide an codepen example to reproduce the same , thank you.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "JesseFarebro", "commentT": "2020-05-14T18:32:17Z", "comment_text": "\n \t\t<denchmark-link:https://codesandbox.io/s/tfjs-fqurl-repro-x1y2f?file=/src/index.js>https://codesandbox.io/s/tfjs-fqurl-repro-x1y2f?file=/src/index.js</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "JesseFarebro", "commentT": "2020-05-18T16:00:05Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/JesseFarebro>@JesseFarebro</denchmark-link>\n  The custom fetch is used, even we calls the default IO handler, since the IO handler will call into the custom fetchFunc. In your example code, if you add a console.log to your custom fetch function, it will print properly.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "JesseFarebro", "commentT": "2020-05-18T17:12:09Z", "comment_text": "\n \t\tIt doesn't. Add console.log(`Fetch ${args[0]}`) to fetchFunc and notice it only prints the URL prefixed with // and not the URL prefixed with https://. There are two test cases I have there, the desired result is using fetchFunc for both URLs. Am I missing something?\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "JesseFarebro", "commentT": "2020-05-18T17:43:26Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/JesseFarebro>@JesseFarebro</denchmark-link>\n  for the case where the url does not start with 'http://', tfjs does not know how to load the model. you need to implement your own IOHander and pass it in in replacement of the modelUrl to loadGraphModel API. please take a look at the API doc.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "JesseFarebro", "commentT": "2020-05-18T17:53:21Z", "comment_text": "\n \t\tI get that, that's not where my problem stems from. My problem is there is no way to override this behaviour. I'm supplying a fully qualified URL including the protocol and I want to use a custom fetch function. The reason being is I want to track the download progress by using a custom ReadableStream. Also, no I don't want to use the builtin tfjs progress callback as its inadequate for the HTTP handler to track things like true download %, bytes received, etc.\n There doesn't seem to be an adequate builtin solution other than implementing the entire model loading scheme myself or changing my URLs to strip the protocol so the default handler doesn't get used.\n I imagined when supplying a fetchFunc it would get invoked even if the default handler was being used.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "JesseFarebro", "commentT": "2020-05-18T18:42:19Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/JesseFarebro>@JesseFarebro</denchmark-link>\n  Now I understand the issue, yes, we will add a fix to update the fetchFunc for the default http loader.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "JesseFarebro", "commentT": "2020-05-18T18:43:58Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/pyu10055>@pyu10055</denchmark-link>\n , sorry for the confusion.\n \t\t"}}}, "commit": {"commit_id": "d9034213a5d26deefe7a535ae0bf9f88de26b4f4", "commit_author": "Ping Yu", "commitT": "2020-05-18 16:50:17-07:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-converter\\src\\executor\\graph_model.ts", "file_new_name": "tfjs-converter\\src\\executor\\graph_model.ts", "file_complexity": {"file_NLOC": "172", "file_CCN": "16", "file_NToken": "1303"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "92", "deleted_lines": "92,93", "method_info": {"method_name": "findIOHandler", "method_params": "", "method_startline": "84", "method_endline": "104", "method_complexity": {"method_NLOC": "18", "method_CCN": "6", "method_NToken": "162", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tfjs-converter\\src\\executor\\graph_model_test.ts", "file_new_name": "tfjs-converter\\src\\executor\\graph_model_test.ts", "file_complexity": {"file_NLOC": "681", "file_CCN": "95", "file_NToken": "5671"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "222,223,224,225,226,227,228,229", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "222", "method_endline": "229", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "56", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "223", "deleted_lines": null, "method_info": {"method_name": "fetchFunc", "method_params": "", "method_startline": "223", "method_endline": "223", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "2", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "221,222,223,224,225,226,227,228,229", "deleted_lines": null, "method_info": {"method_name": "async", "method_params": "", "method_startline": "197", "method_endline": "230", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "29", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-core\\src\\io\\http.ts", "file_new_name": "tfjs-core\\src\\io\\http.ts", "file_complexity": {"file_NLOC": "208", "file_CCN": "23", "file_NToken": "1323"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "257,258,259,272", "deleted_lines": "257,258,271", "method_info": {"method_name": "IORouter", "method_params": "", "method_startline": "257", "method_endline": "276", "method_complexity": {"method_NLOC": "17", "method_CCN": "6", "method_NToken": "82", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-core\\src\\io\\router_registry.ts", "file_new_name": "tfjs-core\\src\\io\\router_registry.ts", "file_complexity": {"file_NLOC": "55", "file_CCN": "8", "file_NToken": "392"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "112", "deleted_lines": "112", "method_info": {"method_name": "getLoadHandlers", "method_params": "", "method_startline": "112", "method_endline": "112", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "1", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 12, "file_old_name": "tfjs-core\\src\\io\\router_registry_test.ts", "file_new_name": "tfjs-core\\src\\io\\router_registry_test.ts", "file_complexity": {"file_NLOC": "106", "file_CCN": "23", "file_NToken": "852"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "139", "deleted_lines": "139", "method_info": {"method_name": "fetchFunc", "method_params": "", "method_startline": "139", "method_endline": "139", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "2", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "129,130", "deleted_lines": "129,130", "method_info": {"method_name": "constructor", "method_params": "string,OnProgressCallback", "method_startline": "129", "method_endline": "130", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "139", "deleted_lines": "139", "method_info": {"method_name": "OnProgressCallback", "method_params": "", "method_startline": "139", "method_endline": "139", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "2", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "129,130", "deleted_lines": "129,130,131", "method_info": {"method_name": "loadOptionsData", "method_params": "", "method_startline": "129", "method_endline": "131", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "128", "deleted_lines": null, "method_info": {"method_name": "constructor", "method_params": "string,LoadOptions", "method_startline": "128", "method_endline": "128", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "121,122,123", "deleted_lines": "121,122,123", "method_info": {"method_name": "fakeLoadOptionsRouter", "method_params": "", "method_startline": "121", "method_endline": "123", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "0"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "138", "deleted_lines": null, "method_info": {"method_name": "onProgress", "method_params": "", "method_startline": "138", "method_endline": "138", "method_complexity": {"method_NLOC": "1", "method_CCN": "1", "method_NToken": "2", "method_nesting_level": "0"}}}, "hunk_7": {"Ismethod": 1, "added_lines": "139,140,141,143,145,146", "deleted_lines": "139,140,142,144,145", "method_info": {"method_name": "fetchFunc", "method_params": "", "method_startline": "139", "method_endline": "147", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "67", "method_nesting_level": "0"}}}, "hunk_8": {"Ismethod": 1, "added_lines": "121,122,123,125,128,129,130,134,135,137,138,139,140,141,143,145,146", "deleted_lines": "121,122,123,124,126,129,130,131,132,136,137,139,140,142,144,145", "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "26", "method_endline": "147", "method_complexity": {"method_NLOC": "24", "method_CCN": "1", "method_NToken": "154", "method_nesting_level": "0"}}}, "hunk_9": {"Ismethod": 1, "added_lines": "138,139,140,141,143,145,146", "deleted_lines": "139,140,142,144,145", "method_info": {"method_name": "onProgress", "method_params": "number", "method_startline": "138", "method_endline": "148", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "0"}}}, "hunk_10": {"Ismethod": 1, "added_lines": "122,123", "deleted_lines": "122,123,124", "method_info": {"method_name": "fakeOnProgressRouter", "method_params": "", "method_startline": "122", "method_endline": "124", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "11", "method_nesting_level": "0"}}}, "hunk_11": {"Ismethod": 1, "added_lines": null, "deleted_lines": "131,132", "method_info": {"method_name": "onProgressCallback", "method_params": "", "method_startline": "131", "method_endline": "133", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-layers\\src\\models.ts", "file_new_name": "tfjs-layers\\src\\models.ts", "file_complexity": {"file_NLOC": "461", "file_CCN": "42", "file_NToken": "3159"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "242", "deleted_lines": "242", "method_info": {"method_name": "loadLayersModelInternal", "method_params": "IOHandler,LoadOptions", "method_startline": "235", "method_endline": "257", "method_complexity": {"method_NLOC": "19", "method_CCN": "6", "method_NToken": "136", "method_nesting_level": "0"}}}}}}}}