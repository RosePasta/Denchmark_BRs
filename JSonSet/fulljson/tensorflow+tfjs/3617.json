{"BR": {"BR_id": "3617", "BR_author": "jbis9051", "BRopenT": "2020-07-17T03:44:29Z", "BRcloseT": "2020-07-27T00:13:15Z", "BR_text": {"BRsummary": "Tensorflow NPM Packages are shipping TypeScript sources instead of just the distrubtion files [URGENT]", "BRdescription": "\n This is in my package.json\n <denchmark-code>    \"@tensorflow/tfjs\": \"^2.0.1\",\n </denchmark-code>\n \n I'm getting this error:\n <denchmark-code>/path/to/project/node_modules/@tensorflow/tfjs-core/src/environment.ts\n TypeScript error in /path/to/project/node_modules/@tensorflow/tfjs-core/src/environment.ts(45,3):\n Property 'platformName' has no initializer and is not definitely assigned in the constructor.  TS2564\n \n     43 |   private urlFlags: Flags = {};\n     44 | \n   > 45 |   platformName: string;\n        |   ^\n     46 |   platform: Platform;\n     47 | \n     48 |   // tslint:disable-next-line: no-any\n </denchmark-code>\n \n I also tried  \"skipLibCheck\": true in tsconfig.json but that didn't work either.\n \n In the case of tfjs, there are actual .ts files (e.g. node_modules/@tensorflow/tfjs-core/src/environment.ts) which cause the failure.\n \n \n Generally npm modules should ship compiled files and their public APIs, so anything happening internally (in js files) should not be reported.\n \n Related <denchmark-link:https://www.reddit.com/r/typescript/comments/hjgd30/skiplibcheck_but_for_ts_files/>https://www.reddit.com/r/typescript/comments/hjgd30/skiplibcheck_but_for_ts_files/</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jbis9051", "commentT": "2020-07-18T00:39:05Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jbis9051>@jbis9051</denchmark-link>\n  can you please provide steps to reproduce above error ?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jbis9051", "commentT": "2020-07-18T01:35:20Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/rthadur>@rthadur</denchmark-link>\n  The linked reddit post describes why it's an issue better.\n <denchmark-h:h1>Reproduce</denchmark-h>\n \n $ mkdir test\n $ cd test\n $ npm init\n $ npm install --save @tensorflow/tfjs\n In test/node_modules/@tensorflow there is a bunch of packages:\n .\n \u251c\u2500\u2500 tfjs\n \u251c\u2500\u2500 tfjs-backend-cpu\n \u251c\u2500\u2500 tfjs-backend-webgl\n \u251c\u2500\u2500 tfjs-converter\n \u251c\u2500\u2500 tfjs-core\n \u251c\u2500\u2500 tfjs-data\n \u2514\u2500\u2500 tfjs-layers\n Inside all of these packages is something similar to the following:\n \u251c\u2500\u2500 tfjs-core\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 BUILD.bazel\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 README.md\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 cloudbuild.yml\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 development\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 dist\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 package.json\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 scripts\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 src\n \u2502\u00a0\u00a0 \u251c\u2500\u2500 test.html\n \u2502\u00a0\u00a0 \u2514\u2500\u2500 tsconfig.test.json\n Instead, only the dist folder should be there.\n <denchmark-h:h1>Why this is an issue?</denchmark-h>\n \n For starters, including the source files (used for developing) increases package sizes tremendously and unnecessarily.\n Additionally, and more importantly, if you are using typescript in a project TypeScript will do type checks on the tensorflow source despite excluding node_modules and \"skipLibCheck\": true being included in your own tsconfig.json. Since most typescript configs don't line up with tensorflow's typescript config, the compilation will fail. The only workaround is to manually delete the src folders in every folder in @tensorflow/.\n <denchmark-h:h1>How do you guys fix it?</denchmark-h>\n \n For TypeScript based packages you should only publish the built (dist) files with the deceleration [*.d.ts] files. This will allow \"skipLibCheck\": true  to work properly.\n If you look at bodyPix, that package is setup properly:\n <denchmark-code>test/node_modules/@tensorflow-models\n \u2514\u2500\u2500 body-pix\n     \u251c\u2500\u2500 README-v1.md\n     \u251c\u2500\u2500 README.md\n     \u251c\u2500\u2500 cloudbuild.yml\n     \u251c\u2500\u2500 diff\n     \u251c\u2500\u2500 dist\n     \u251c\u2500\u2500 package.json\n     \u2514\u2500\u2500 run_tests.ts\n </denchmark-code>\n \n Despite BodyPix having a  directory (<denchmark-link:https://github.com/tensorflow/tfjs-models/tree/master/body-pix/src>https://github.com/tensorflow/tfjs-models/tree/master/body-pix/src</denchmark-link>\n ), only the  folder is published and therefore installed, not the  folder.\n If we go into the dist folder then we can see all the compiled source and deceleration files.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jbis9051", "commentT": "2020-07-18T12:13:44Z", "comment_text": "\n \t\tSame issue here\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jbis9051", "commentT": "2020-07-20T19:33:42Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tylerzhu-github>@tylerzhu-github</denchmark-link>\n  can you please help with above request ?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jbis9051", "commentT": "2020-07-21T06:17:26Z", "comment_text": "\n \t\tsame here\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jbis9051", "commentT": "2020-07-21T20:02:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jbis9051>@jbis9051</denchmark-link>\n  What version of typescript are you using? Could you post your tsconfig (or a similar tsconfig that reproduces the error), we've been shipping those up to NPM for a while and it would be nice to know why skipLibCheck/exclude does not work in this instance.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jbis9051", "commentT": "2020-07-21T22:02:23Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tafsiri>@tafsiri</denchmark-link>\n   Sure.  doesn't work because, again, those are source Typescript files () not declaration files (). See here <denchmark-link:https://www.typescriptlang.org/docs/handbook/compiler-options.html>https://www.typescriptlang.org/docs/handbook/compiler-options.html</denchmark-link>\n \n \n --skipLibCheck | boolean | false | Skip type checking of all declaration files (*.d.ts).\n \n Not sure about why exclude doesn't work.\n Version:   \"typescript\": { \"version\": \"3.7.5\",\n Here's a TSConfig:\n {\n   \"compilerOptions\": {\n     \"target\": \"es5\",\n     \"lib\": [\n       \"dom\",\n       \"dom.iterable\",\n       \"esnext\"\n     ],\n     \"allowJs\": true,\n     \"skipLibCheck\": true,\n     \"esModuleInterop\": true,\n     \"allowSyntheticDefaultImports\": true,\n     \"strict\": true,\n     \"forceConsistentCasingInFileNames\": true,\n     \"module\": \"esnext\",\n     \"moduleResolution\": \"node\",\n     \"resolveJsonModule\": true,\n     \"isolatedModules\": true,\n     \"noEmit\": true,\n     \"jsx\": \"react\",\n     \"experimentalDecorators\": true\n   },\n   \"include\": [\n     \"src\"\n   ],\n   \"exclude\": [\n     \"node_modules\"\n   ]\n }\n It isn't compatible because \"strict\": true, isn't compatible with tensorflow's tsconfig.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "jbis9051", "commentT": "2020-07-24T18:48:07Z", "comment_text": "\n \t\tFound the bug, it was an errant import path in our source. Should be resolved in the next release goes out.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "jbis9051", "commentT": "2020-07-24T18:49:18Z", "comment_text": "\n \t\t\\o/\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "jbis9051", "commentT": "2020-07-25T03:25:37Z", "comment_text": "\n \t\tYeah, i independently found the problem (using ), and my workaround right now is to use <denchmark-link:https://npm.im/patch-package>https://npm.im/patch-package</denchmark-link>\n  with the following patch:\n patches/@tensorflow+tfjs-core+2.0.1.patch\n diff --git a/node_modules/@tensorflow/tfjs-core/dist/kernel_names.d.ts b/node_modules/@tensorflow/tfjs-core/dist/kernel_names.d.ts\n index 126a329..b287921 100644\n --- a/node_modules/@tensorflow/tfjs-core/dist/kernel_names.d.ts\n +++ b/node_modules/@tensorflow/tfjs-core/dist/kernel_names.d.ts\n @@ -14,7 +14,7 @@\n   * limitations under the License.\n   * =============================================================================\n   */\n -import { ExplicitPadding } from '../src/ops/conv_util';\n +import { ExplicitPadding } from './ops/conv_util';\n  import { NamedTensorInfoMap, TensorInfo } from './kernel_registry';\n  import { DataType, PixelData } from './types';\n  export declare const Add = \"Add\";\n diff --git a/node_modules/@tensorflow/tfjs-core/src/kernel_names.ts b/node_modules/@tensorflow/tfjs-core/src/kernel_names.ts\n index 4e9a822..c998fdb 100644\n --- a/node_modules/@tensorflow/tfjs-core/src/kernel_names.ts\n +++ b/node_modules/@tensorflow/tfjs-core/src/kernel_names.ts\n @@ -18,7 +18,7 @@\n  // tslint:disable: variable-name\n  // Unfortunately just enabling PascalCase per file (tslint:enable:\n  // allow-pascal-case) doesn't work.\n -import {ExplicitPadding} from '../src/ops/conv_util';\n +import {ExplicitPadding} from './ops/conv_util';\n  \n  import {NamedTensorInfoMap, TensorInfo} from './kernel_registry';\n  import {DataType, PixelData} from './types';\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "jbis9051", "commentT": "2020-07-27T00:13:17Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tfjs/issues/3617>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tfjs/issues/3617>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "7e50785d1decd20304e115e1f7482075a32ef136", "commit_author": "Yannick Assogba", "commitT": "2020-07-26 20:13:14-04:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": ".tslint\\noImportsWithRegexRule.js", "file_complexity": {"file_NLOC": "46", "file_CCN": "24", "file_NToken": "448"}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": ".tslint\\noImportsWithRegexRule.ts", "file_complexity": {"file_NLOC": "23", "file_CCN": "3", "file_NToken": "173"}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-webgpu\\src\\kernels\\reduce_webgpu.ts", "file_new_name": "tfjs-backend-webgpu\\src\\kernels\\reduce_webgpu.ts", "file_complexity": {"file_NLOC": "94", "file_CCN": "8", "file_NToken": "694"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "33,34", "deleted_lines": "19,20,35"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-core\\src\\kernel_names.ts", "file_new_name": "tfjs-core\\src\\kernel_names.ts", "file_complexity": {"file_NLOC": "662", "file_CCN": "0", "file_NToken": "4002"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "22", "deleted_lines": "21,22"}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tslint.json", "file_new_name": "tslint.json", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "41", "deleted_lines": null}}}}}}