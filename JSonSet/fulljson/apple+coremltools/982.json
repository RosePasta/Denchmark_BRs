{"BR": {"BR_id": "982", "BR_author": "xternalz", "BRopenT": "2020-10-27T21:49:12Z", "BRcloseT": "2020-12-22T21:59:29Z", "BR_text": {"BRsummary": "Conversion fails with PyTorch v1.7.0", "BRdescription": "\n coremltools unified conversion API fails with traced model from PyTorch v1.7.0. It was fine with PyTorch v1.6.0.\n <denchmark-h:h2>Trace</denchmark-h>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"test_interpolate.py\", line 18, in <module>\n     mlmodel = ct.convert(\n   File \".../coremltools/converters/_converters_entry.py\", line 176, in convert\n     mlmodel = mil_convert(\n   File \".../coremltools/converters/mil/converter.py\", line 128, in mil_convert\n     proto = mil_convert_to_proto(model, convert_from, convert_to,\n   File \".../coremltools/converters/mil/converter.py\", line 171, in mil_convert_to_proto\n     prog = frontend_converter(model, **kwargs)\n   File \".../coremltools/converters/mil/converter.py\", line 85, in __call__\n     return load(*args, **kwargs)\n   File \".../coremltools/converters/mil/frontend/torch/load.py\", line 85, in load\n     raise e\n   File \".../coremltools/converters/mil/frontend/torch/load.py\", line 75, in load\n     prog = converter.convert()\n   File \".../coremltools/converters/mil/frontend/torch/converter.py\", line 224, in convert\n     convert_nodes(self.context, self.graph)\n   File \".../coremltools/converters/mil/frontend/torch/ops.py\", line 56, in convert_nodes\n     _add_op(context, node)\n   File \".../coremltools/converters/mil/frontend/torch/ops.py\", line 417, in _convolution\n     raise ValueError(\n ValueError: unexpected number of inputs for node 11 (_convolution): 13\n </denchmark-code>\n \n <denchmark-h:h2>To Reproduce</denchmark-h>\n \n \n If a python script can reproduce the error, please paste the code snippet\n \n <denchmark-code>import torch.nn.functional as F\n import torch.nn as nn\n import torch\n import coremltools as ct\n \n class Model(nn.Module):\n     def __init__(self):\n         super(Model, self).__init__()\n         self.conv = nn.Conv2d(3, 3, 3, 1, 1)\n     \n     def forward(self, x):\n         return self.conv(x)\n \n input_batch = torch.randn(1,3,10,10)\n model = Model()\n trace = torch.jit.trace(model, input_batch)\n \n mlmodel = ct.convert(\n     trace,\n     inputs=[ct.TensorType(name=\"input\", shape=input_batch.shape)],\n )\n </denchmark-code>\n \n <denchmark-h:h2>System environment (please complete the following information):</denchmark-h>\n \n coremltools 4.0\n PyTorch v1.7.0\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "xternalz", "commentT": "2020-11-21T20:56:49Z", "comment_text": "\n \t\tI had the same issue. I fix it by downgrading to PyTorch v1.6.0\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "xternalz", "commentT": "2020-11-25T13:50:34Z", "comment_text": "\n \t\tI had the same issue, a bit of digging revealed that the coremltools documentation states:\n \n Currently, the latest supported version of PyTorch is 1.5.1\n \n <denchmark-link:https://coremltools.readme.io/docs/pytorch-conversion>https://coremltools.readme.io/docs/pytorch-conversion</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "xternalz", "commentT": "2020-12-04T22:52:25Z", "comment_text": "\n \t\tI have solved it here <denchmark-link:https://github.com/apple/coremltools/pull/1020>#1020</denchmark-link>\n . Also there are couple other fix for 1.7.0.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "xternalz", "commentT": "2020-12-22T21:59:29Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/xternalz>@xternalz</denchmark-link>\n , this issue should have been resolved as a result of the above mentioned PR. Please feel free to file a new issue if you believe this is not the case, or have additional concerns!\n \t\t"}}}, "commit": {"commit_id": "18052f0b0af42ef685620271aea8a2110af92fb6", "commit_author": "Dreyk", "commitT": "2020-12-13 21:05:57-08:00", "commit_complexity": {"commit_NLOC": "0.33962264150943394", "commit_CCN": "0.9056603773584906", "commit_Nprams": "0.2641509433962264"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "coremltools\\converters\\mil\\frontend\\torch\\ops.py", "file_new_name": "coremltools\\converters\\mil\\frontend\\torch\\ops.py", "file_complexity": {"file_NLOC": "1679", "file_CCN": "381", "file_NToken": "14507"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "409", "deleted_lines": "409", "method_info": {"method_name": "_convolution", "method_params": "context,node", "method_startline": "381", "method_endline": "496", "method_complexity": {"method_NLOC": "81", "method_CCN": "21", "method_NToken": "598", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "2432,2463,2464,2467,2469,2470", "deleted_lines": "2441,2443,2445", "method_info": {"method_name": "_std", "method_params": "x,axes,keep_dim,unbiased,eps", "method_startline": "2432", "method_endline": "2470", "method_complexity": {"method_NLOC": "29", "method_CCN": "12", "method_NToken": "249", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "1876,1877,1878,1879,1880,1881,1882,1883", "deleted_lines": null, "method_info": {"method_name": "unbind", "method_params": "context,node", "method_startline": "1876", "method_endline": "1883", "method_complexity": {"method_NLOC": "8", "method_CCN": "2", "method_NToken": "103", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977", "deleted_lines": null, "method_info": {"method_name": "group_norm", "method_params": "context,node", "method_startline": "956", "method_endline": "977", "method_complexity": {"method_NLOC": "22", "method_CCN": "3", "method_NToken": "303", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "1406,1407,1408,1409", "deleted_lines": null, "method_info": {"method_name": "upsample_nearest2d", "method_params": "context,node", "method_startline": "1395", "method_endline": "1424", "method_complexity": {"method_NLOC": "27", "method_CCN": "5", "method_NToken": "173", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "1380,1381,1382,1383", "deleted_lines": null, "method_info": {"method_name": "upsample_bilinear2d", "method_params": "context,node", "method_startline": "1366", "method_endline": "1392", "method_complexity": {"method_NLOC": "23", "method_CCN": "3", "method_NToken": "134", "method_nesting_level": "0"}}}, "hunk_6": {"Ismethod": 1, "added_lines": "2473,2474,2475,2476,2477,2478,2479,2480,2481,2482,2483,2484,2485,2486,2487,2488,2489,2490,2491,2493", "deleted_lines": null, "method_info": {"method_name": "std", "method_params": "context,node", "method_startline": "2473", "method_endline": "2493", "method_complexity": {"method_NLOC": "18", "method_CCN": "6", "method_NToken": "136", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "coremltools\\converters\\mil\\frontend\\torch\\test\\test_torch_ops.py", "file_new_name": "coremltools\\converters\\mil\\frontend\\torch\\test\\test_torch_ops.py", "file_complexity": {"file_NLOC": "1287", "file_CCN": "116", "file_NToken": "9282"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1346,1347,1348,1349,1350", "deleted_lines": null, "method_info": {"method_name": "test_unbind", "method_params": "self,backend,dim", "method_startline": "1346", "method_endline": "1350", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "82,83,84,85,86", "deleted_lines": null, "method_info": {"method_name": "test_groupnorm", "method_params": "self,group_features,eps,affine,backend", "method_startline": "82", "method_endline": "86", "method_complexity": {"method_NLOC": "5", "method_CCN": "3", "method_NToken": "70", "method_nesting_level": "1"}}}}}}}}