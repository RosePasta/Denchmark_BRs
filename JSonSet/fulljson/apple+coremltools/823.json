{"BR": {"BR_id": "823", "BR_author": "leovinus2001", "BRopenT": "2020-07-28T15:31:28Z", "BRcloseT": "2020-08-05T21:39:08Z", "BR_text": {"BRsummary": "Todays' beta2 checkin breaks  old  issue #759  F.max_pool2d where stride is NOT explicitly specified", "BRdescription": "\n Am comparing the old test case testPool from issue <denchmark-link:https://github.com/apple/coremltools/issues/759>#759</denchmark-link>\n  with today's git version\n commit <denchmark-link:https://github.com/apple/coremltools/commit/37e619d99bf603d2cb9ea0839fa3ebe649996b0a>37e619d</denchmark-link>\n  (HEAD -> master, tag: 4.0b2, origin/master, origin/HEAD)\n versus from a few days ago July 22\n commit <denchmark-link:https://github.com/apple/coremltools/commit/705244e2be26c3fb7881fd7a731d25a55f5e4765>705244e</denchmark-link>\n \n test case from issue <denchmark-link:https://github.com/apple/coremltools/issues/759>#759</denchmark-link>\n \n now fails again.\n (I cannot attach it atm. Seems AWS issue)\n reproducible:---------------\n yes\n log:---------------\n Torch version : 1.5.1\n CoreML tools version : 4.0b2\n Converting Frontend ==> MIL Ops:   0%|                                                                                                                                                                                                                                                             | 0/6 [00:00<?, ? ops/s]Converting op 13 : constant : shape = n/a\n Converting op 14 : constant : shape = n/a\n Converting op 15 : constant : shape = n/a\n Converting op 16 : constant : shape = n/a\n Converting op 11 : constant : shape = n/a\n Converting op 12 : max_pool2d : shape = (1, 1, 28, 28)\n Converting Frontend ==> MIL Ops:  83%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c                                        | 5/6 [00:00<00:00, 4629.47 ops/s]\n Traceback (most recent call last):\n File \"testPool.py\", line 94, in \n inputs=[ ct.TensorType(name=\"input1\", shape=dummy_input.shape) ],\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/_converters_entry.py\", line 299, in convert\n **kwargs\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/converter.py\", line 120, in _convert\n prog = frontend_converter(model, **kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/converter.py\", line 62, in call\n return load(*args, **kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/frontend/torch/load.py\", line 86, in load\n raise e\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/frontend/torch/load.py\", line 76, in load\n prog = converter.convert()\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/frontend/torch/converter.py\", line 221, in convert\n convert_nodes(self.context, self.graph)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/frontend/torch/ops.py\", line 64, in convert_nodes\n _add_op(context, node)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/frontend/torch/ops.py\", line 584, in max_pool2d\n name=node.name,\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/ops/registry.py\", line 62, in add_op\n return cls._add_op(op_cls, **kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/builder.py\", line 188, in _add_op\n new_op = op_cls(**kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/ops/defs/pool.py\", line 180, in init\n super(max_pool, self).init(**kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/ops/defs/pool.py\", line 25, in init\n super(Pooling, self).init(**kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/operation.py\", line 148, in init\n self._validate_and_set_inputs(**kwargs)\n File \"/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/operation.py\", line 360, in _validate_and_set_inputs\n parsed_inputs = self.input_spec.parse_inputs(kwargs)\n File \"~/Library/Python/3.7/lib/python/site-packages/coremltools/converters/mil/mil/input_type.py\", line 67, in parse_inputs\n raise TypeError(msg)\n TypeError: Input strides has type <class 'coremltools.converters.mil.mil.types.type_tensor.tensor..tensor'> not compatible with expected type IntTensorInputType\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "leovinus2001", "commentT": "2020-07-28T15:42:19Z", "comment_text": "\n \t\tAs AWS does not allow me to attach a test case, here is the code to verify with 4.0b2 vs previous\n import torch\n import torch.nn as nn\n import torch.nn.functional as F\n import coremltools as ct\n class small_model(nn.Module):\n def init(self):\n super(small_model, self).init()\n <denchmark-code>    self.pool1  = nn.MaxPool2d(2,stride=1) # Pool 2x2, explicit stride\n     self.pool1b = nn.MaxPool2d(2) # Pool 2x2, implicit stride\n     \n def forward(self, x):\n     \n     # Functional pooling\n     y = F.max_pool2d(x, 2) # BOOM, BUG,  implicit stride=1\n     #y = F.max_pool2d(x, 2, stride=1) # OK, explicit stride=1\n     \n     # Layer-based pooling\n     #y = self.pool1(x)  # OK\n     #y = self.pool1b(x) # OK\n \n     return y\n </denchmark-code>\n \n if name == 'main':\n print (\"Torch version : \" + str(torch.version))\n print (\"CoreML tools version : \" + str(ct.version))\n <denchmark-code>model = small_model()\n model.eval()\n dummy_input = torch.randn(1,1,28,28)\n traced_model = torch.jit.trace(model, dummy_input)\n model = ct.convert(\n     traced_model,\n     inputs=[ ct.TensorType(name=\"input1\", shape=dummy_input.shape) ],\n )\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "leovinus2001", "commentT": "2020-08-03T17:11:59Z", "comment_text": "\n \t\tMaybe a tentative fix and put on a branch. Will push shortly for review.\n In the meantime, new test case\n <denchmark-link:https://github.com/apple/coremltools/files/5017284/testPool.txt>testPool.txt</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "leovinus2001", "commentT": "2020-08-03T17:13:37Z", "comment_text": "\n \t\tAs I have difficulty with git pushing the branch (error 403), here is the tentative patch for review\n <denchmark-link:https://github.com/apple/coremltools/files/5017298/patch.txt>patch.txt</denchmark-link>\n \n PS: To be clear, I cannot generate the PR as I cannot push my branch at the moment. As the patch has only 4 lines of code, maybe someone else can carry it forward. Thx.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "leovinus2001", "commentT": "2020-08-03T21:23:59Z", "comment_text": "\n \t\tNever mind, created pull request <denchmark-link:https://github.com/apple/coremltools/pull/837>#837</denchmark-link>\n  to fix this.\n \t\t"}}}, "commit": {"commit_id": "828812bf897afdd7c5fa87d5f2fa9dea4f740a2e", "commit_author": "leovinus2001", "commitT": "2020-08-05 14:39:07-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.5"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "coremltools\\converters\\mil\\frontend\\torch\\ops.py", "file_new_name": "coremltools\\converters\\mil\\frontend\\torch\\ops.py", "file_complexity": {"file_NLOC": "1289", "file_CCN": "278", "file_NToken": "10500"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1532,1533", "deleted_lines": null, "method_info": {"method_name": "_avg_pool", "method_params": "context,node,inputs", "method_startline": "1528", "method_endline": "1555", "method_complexity": {"method_NLOC": "26", "method_CCN": "4", "method_NToken": "180", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "554,555", "deleted_lines": null, "method_info": {"method_name": "max_pool2d", "method_params": "context,node", "method_startline": "548", "method_endline": "579", "method_complexity": {"method_NLOC": "27", "method_CCN": "5", "method_NToken": "189", "method_nesting_level": "0"}}}}}}}}