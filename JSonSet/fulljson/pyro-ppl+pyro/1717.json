{"BR": {"BR_id": "1717", "BR_author": "adam-coogan", "BRopenT": "2019-01-24T09:47:54Z", "BRcloseT": "2019-02-01T23:40:03Z", "BR_text": {"BRsummary": "Bug in Empirical.sample() with multiple MCMC chains", "BRdescription": "\n It seems like the marginals for MCMC runs with multiple chains are not being computed correctly. Here is a simple example:\n pyro.set_rng_seed(18)\n def model(obs=None):\n     a = pyro.sample(\"a\", dist.Normal(0., 1.))\n     pyro.sample(\"y\", dist.Normal(a**2, 1.), obs=obs)\n \n y_obs = torch.tensor(1.)\n kernel = NUTS(model)\n # kernel = HMC(model)  # doesn't work with this kernel either\n mcmc_run = MCMC(kernel, num_samples=20, warmup_steps=1, num_chains=2).run(y_obs)\n \n posterior = mcmc_run.marginal(\"a\").empirical[\"a\"]\n # posterior = EmpiricalMarginal(mcmc_run, 'a')  # this doesn't work either\n posterior.mean\n posterior.sample()\n \n >>> ...\n >>> RuntimeError: index 19 is out of bounds for dim with size 2\n When I look at posterior._samples, it contains a tensor of size [2, 20]. Calling posterior.sample() generates a number between 0 and 19, which leads to the error. I'd think MCMC.marginal() should concatenate the results from the chains together. Is the right place to do this _ParallelSampler.terminate()?\n Environment info:\n \n macOS Mojave 10.14.2 (18C54)\n python 3.6.5\n torch.version is 1.0.0\n pyro.version is 0.3.0+0830f7ed\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "adam-coogan", "commentT": "2019-01-24T19:03:21Z", "comment_text": "\n \t\tThanks for reporting, this is indeed a bug. It should pull out [0, 2] and [1, 20] entries from the sample tensor instead, i.e. a sample from each of the chains. I will push a fix for this, and additionally would like to revisit some of the assumptions we made to ensure that vectorized samples are fully supported by all methods.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "adam-coogan", "commentT": "2019-02-01T23:40:03Z", "comment_text": "\n \t\tShould be fixed in <denchmark-link:https://github.com/pyro-ppl/pyro/pull/1721>#1721</denchmark-link>\n .\n \t\t"}}}, "commit": {"commit_id": "2b7b03c940da256353e35179eeed33b6f8974ade", "commit_author": "Neeraj Pradhan", "commitT": "2019-01-31 17:19:11-05:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.23076923076923078"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pyro\\distributions\\empirical.py", "file_new_name": "pyro\\distributions\\empirical.py", "file_complexity": {"file_NLOC": "113", "file_CCN": "18", "file_NToken": "738"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "76,77,78,79,80,81,82,83", "deleted_lines": null, "method_info": {"method_name": "sample", "method_params": "self,sample_shape", "method_startline": "75", "method_endline": "83", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "123", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\distributions\\test_empirical.py", "file_new_name": "tests\\distributions\\test_empirical.py", "file_complexity": {"file_NLOC": "134", "file_CCN": "14", "file_NToken": "1765"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "58,59,60,61,62,63,64,65", "deleted_lines": null, "method_info": {"method_name": "test_sample_examples", "method_params": "sample,weights,expected_mean,expected_var", "method_startline": "58", "method_endline": "65", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "87", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "31,32,33,34,35,36,37,38,39,40,41,43", "deleted_lines": "32,33", "method_info": {"method_name": "test_unweighted_samples", "method_params": "batch_shape,event_shape,sample_shape,dtype", "method_startline": "31", "method_endline": "43", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "129", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "25,26,27,28,29,31,32,33", "deleted_lines": "25,26,27,28,29,30,32,33", "method_info": {"method_name": "test_unweighted_samples", "method_params": "batch_shape,sample_shape,dtype", "method_startline": "25", "method_endline": "33", "method_complexity": {"method_NLOC": "9", "method_CCN": "2", "method_NToken": "116", "method_nesting_level": "0"}}}}}}}}