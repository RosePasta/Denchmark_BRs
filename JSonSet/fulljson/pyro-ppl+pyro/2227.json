{"BR": {"BR_id": "2227", "BR_author": "lsgos", "BRopenT": "2019-12-18T19:29:41Z", "BRcloseT": "2019-12-19T02:14:10Z", "BR_text": {"BRsummary": "Student T tests fail on GPU [bug]", "BRdescription": "\n <denchmark-code>sample_shape = torch.Size([])\n \n     def rsample(self, sample_shape=torch.Size()):\n         shape = self._extended_shape(sample_shape)\n         X = torch.empty(shape, dtype=self.df.dtype, device=self.df.device).normal_()\n         Z = self._chi2.rsample(sample_shape)\n         Y = X * torch.rsqrt(Z / self.df).unsqueeze(-1)\n >       return self.loc + self.scale_tril.matmul(Y.unsqueeze(-1)).squeeze(-1)\n E       RuntimeError: Expected object of device type cuda but got device type cpu for argument #2 'mat2' in call to _th_mm\n \n pyro/distributions/multivariate_studentt.py:74: RuntimeError\n </denchmark-code>\n \n This issue was discussed in <denchmark-link:https://github.com/pyro-ppl/pyro/pull/2226>#2226</denchmark-link>\n  - running  on the dev branch errors out for me if running on a machine with cuda. I am guessing this hasn't shown up in the CI because it uses a cpu only machine.\n I think this bug is pretty simple - it happens because, as we can see in the above snippet, y inherits its device from self.df, and in the fixture, self.df is set to a scalar value. This is not converted into a tensor by the tensors_default_to context manager, and so isn't sent to the gpu.\n I fixed this in <denchmark-link:https://github.com/pyro-ppl/pyro/pull/2226>#2226</denchmark-link>\n  by changing the fixture, but <denchmark-link:https://github.com/fritzo>@fritzo</denchmark-link>\n  suggested that it might suggest a missing coercion rather than a change to the fixture, so that change in the PR was reverted and I am opening this issue instead.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lsgos", "commentT": "2019-12-18T19:48:33Z", "comment_text": "\n \t\tWe really do want to test with Python scalars as inputs. This appears to be a bug in MultivariateStudentT which incorrectly coerces df without examining the device of other tenors:\n df, = broadcast_all(df)  # this line is buggy\n \t\t"}}}, "commit": {"commit_id": "d6ef2ee9f37e124a29e8dfde4c1bfa72296f5dcf", "commit_author": "Fritz Obermeyer", "commitT": "2019-12-18 21:14:09-05:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pyro\\distributions\\multivariate_studentt.py", "file_new_name": "pyro\\distributions\\multivariate_studentt.py", "file_complexity": {"file_NLOC": "86", "file_CCN": "12", "file_NToken": "902"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "31,32", "deleted_lines": "31", "method_info": {"method_name": "__init__", "method_params": "self,df,loc,scale_tril,validate_args", "method_startline": "28", "method_endline": "39", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "137", "method_nesting_level": "1"}}}}}}}}