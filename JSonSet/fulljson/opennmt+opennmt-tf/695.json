{"BR": {"BR_id": "695", "BR_author": "ddaspit", "BRopenT": "2020-06-23T08:43:45Z", "BRcloseT": "2020-06-23T09:44:26Z", "BR_text": {"BRsummary": "Crash when training TransformerBaseRelative model", "BRdescription": "\n When training a TransformerBaseRelative model using the following command:\n <denchmark-code>onmt-main --model_type TransformerBaseRelative --config config.yml --auto_config train --with_eval\n </denchmark-code>\n \n I receive the following error:\n <denchmark-code>Traceback (most recent call last):\n   File \"C:\\Users\\damie\\AppData\\Local\\Programs\\Python\\Python37\\lib\\runpy.py\", line 193, in _run_module_as_main\n     \"__main__\", mod_spec)\n   File \"C:\\Users\\damie\\AppData\\Local\\Programs\\Python\\Python37\\lib\\runpy.py\", line 85, in _run_code\n     exec(code, run_globals)\n   File \"C:\\Users\\damie\\AppData\\Local\\pypoetry\\Cache\\virtualenvs\\nlp-mt-testing-U3-1H1OD-py3.7\\Scripts\\onmt-main.exe\\__main__.py\", line 9, in <module>\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\bin\\main.py\", line 224, in main\n     hvd=hvd)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\runner.py\", line 236, in train\n     moving_average_decay=train_config.get(\"moving_average_decay\"))\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\training.py\", line 93, in __call__\n     for loss in self._steps(dataset, accum_steps=accum_steps, report_steps=report_steps):\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\training.py\", line 223, in _steps\n     _step()\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\def_function.py\", line 580, in __call__\n     result = self._call(*args, **kwds)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\def_function.py\", line 627, in _call\n     self._initialize(args, kwds, add_initializers_to=initializers)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\def_function.py\", line 506, in _initialize\n     *args, **kwds))\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\function.py\", line 2446, in _get_concrete_function_internal_garbage_collected\n     graph_function, _, _ = self._maybe_define_function(args, kwargs)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\function.py\", line 2777, in _maybe_define_function\n     graph_function = self._create_graph_function(args, kwargs)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\function.py\", line 2667, in _create_graph_function\n     capture_by_value=self._capture_by_value),\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\framework\\func_graph.py\", line 981, in func_graph_from_py_func\n     func_outputs = python_func(*func_args, **func_kwargs)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\eager\\def_function.py\", line 441, in wrapped_fn\n     return weak_wrapped_fn().__wrapped__(*args, **kwds)\n   File \"c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\framework\\func_graph.py\", line 968, in wrapper\n     raise e.ag_error_metadata.to_exception(e)\n ValueError: in user code:\n \n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\training.py:215 _step  *\n         return self._step()\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\training.py:314 _step  *\n         self._gradient_accumulator.reset()\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\opennmt\\optimizers\\utils.py:124 reset  *\n         gradient.assign(tf.zeros(gradient.shape, dtype=gradient.dtype))\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\ops\\array_ops.py:2677 wrapped  **\n         tensor = fun(*args, **kwargs)\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\ops\\array_ops.py:2730 zeros\n         shape = ops.convert_to_tensor(shape, dtype=dtypes.int32)\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\framework\\ops.py:1341 convert_to_tensor\n         ret = conversion_func(value, dtype=dtype, name=name, as_ref=as_ref)\n     c:\\users\\damie\\appdata\\local\\pypoetry\\cache\\virtualenvs\\nlp-mt-testing-u3-1h1od-py3.7\\lib\\site-packages\\tensorflow\\python\\framework\\constant_op.py:338 _tensor_shape_tensor_conversion_function\n         \"Cannot convert a partially known TensorShape to a Tensor: %s\" % s)\n \n     ValueError: Cannot convert a partially known TensorShape to a Tensor: (None, 64)\n </denchmark-code>\n \n This only seems to occur in OpenNMT-tf 2.11. My config file does not set any hyperparameters. It only configures the location of data. Training using TransformerBase does not produce the error. I am running on Windows 10.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ddaspit", "commentT": "2020-06-23T09:34:27Z", "comment_text": "\n \t\tThanks for reporting. This should be fixed by the PR linked above.\n \t\t"}}}, "commit": {"commit_id": "5f720e58c37a82e37bb1b28bb03977ee7d3cfa86", "commit_author": "Guillaume Klein", "commitT": "2020-06-23 11:44:26+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "opennmt\\layers\\transformer.py", "file_new_name": "opennmt\\layers\\transformer.py", "file_complexity": {"file_NLOC": "318", "file_CCN": "39", "file_NToken": "2393"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "275,276", "deleted_lines": "275,276", "method_info": {"method_name": "call", "method_params": "self,inputs,memory,mask,cache,training", "method_startline": "222", "method_endline": "304", "method_complexity": {"method_NLOC": "51", "method_CCN": "11", "method_NToken": "472", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "opennmt\\tests\\transformer_test.py", "file_new_name": "opennmt\\tests\\transformer_test.py", "file_complexity": {"file_NLOC": "162", "file_CCN": "17", "file_NToken": "1928"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "149,150,151,152,153,154,155", "deleted_lines": null, "method_info": {"method_name": "testMultiHeadSelfAttentionRelativeGradients._compute_gradients_in_function", "method_params": "x", "method_startline": "149", "method_endline": "155", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "61", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "145,146,147,148,149,150,151,152,153,154,155,156,157", "deleted_lines": null, "method_info": {"method_name": "testMultiHeadSelfAttentionRelativeGradients", "method_params": "self", "method_startline": "145", "method_endline": "157", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "42", "method_nesting_level": "1"}}}}}}}}