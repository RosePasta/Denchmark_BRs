{"BR": {"BR_id": "491", "BR_author": "nilbibi", "BRopenT": "2019-09-05T08:40:22Z", "BRcloseT": "2019-09-05T09:48:47Z", "BR_text": {"BRsummary": "(branch: v2) evaluation bug. (in training phrase)", "BRdescription": "\n when I run scripts/wmt/run_wmt_ende_1gpu.sh, I found this error in the second evaluation.\n \n Traceback (most recent call last):\n File \"/home/xinghua/miniconda3/envs/tf2.0/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n \"main\", mod_spec)\n File \"/home/xinghua/miniconda3/envs/tf2.0/lib/python3.6/runpy.py\", line 85, in _run_code\n exec(code, run_globals)\n File \"/data/xinghua/nb_project/OpenNMT-tf/opennmt/bin/main.py\", line 221, in \n main()\n File \"/data/xinghua/nb_project/OpenNMT-tf/opennmt/bin/main.py\", line 187, in main\n checkpoint_path=args.checkpoint_path)\n File \"/data/xinghua/nb_project/OpenNMT-tf/opennmt/runner.py\", line 204, in train\n eval_steps=eval_config.get(\"steps\", 5000))\n File \"/data/xinghua/nb_project/OpenNMT-tf/opennmt/training.py\", line 159, in call\n evaluator(step)\n File \"/data/xinghua/nb_project/OpenNMT-tf/opennmt/evaluation.py\", line 142, in call\n loss = loss_num / loss_den\n ZeroDivisionError: division by zero\n \n I tracked to the following code.\n <denchmark-code> iterator = iter(dataset)\n \n   def decorator(func):\n \n     @tf.function\n     def _tf_fun():\n       return func(lambda: next(iterator))\n \n     def _fun():\n       while True:\n         try:\n           yield _tf_fun()\n         except tf.errors.OutOfRangeError:\n           break\n \n     return _fun\n </denchmark-code>\n \n I change the code as below, Is this change appropriate?\n <denchmark-code>def decorator(func):\n     def _fun():\n       iterator = iter(dataset)\n       @tf.function\n       def _tf_fun():\n         return func(lambda: next(iterator))\n \n       while True:\n         try:\n           yield _tf_fun()\n         except tf.errors.OutOfRangeError:\n           break\n \n     return _fun\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "nilbibi", "commentT": "2019-09-05T08:43:50Z", "comment_text": "\n \t\tThanks for testing this branch. I'm not sure your change is related to the error. Do you have an empty line in your validation set?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "nilbibi", "commentT": "2019-09-05T08:47:43Z", "comment_text": "\n \t\tThere is no empty line in validation set, I guess the iterator is out of range when the second evaluation.(The first time evaluation has run out of elements in dataset), so the next time evaluation need to reset the iterator.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "nilbibi", "commentT": "2019-09-05T08:57:17Z", "comment_text": "\n \t\tAh, good catch! The change looks appropriate, I will do additional tests. Thanks!\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "nilbibi", "commentT": "2019-09-05T09:48:47Z", "comment_text": "\n \t\tI applied your change in the commit above. Thanks!\n \t\t"}}}, "commit": {"commit_id": "d11cb0db6feb1da52a93190a9c9ed5e2c1f24a02", "commit_author": "Guillaume Klein", "commitT": "2019-09-05 11:46:04+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "opennmt\\data\\dataset.py", "file_new_name": "opennmt\\data\\dataset.py", "file_complexity": {"file_NLOC": "211", "file_CCN": "63", "file_NToken": "1452"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "412,413", "deleted_lines": "412", "method_info": {"method_name": "function_on_next.function_on_next.decorator.function_on_next.function_on_next.decorator._fun._tf_fun", "method_params": "", "method_startline": "412", "method_endline": "413", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "3"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "408,409,411,412,413", "deleted_lines": "410,411,412,414", "method_info": {"method_name": "function_on_next.function_on_next.decorator._fun", "method_params": "", "method_startline": "408", "method_endline": "419", "method_complexity": {"method_NLOC": "9", "method_CCN": "3", "method_NToken": "33", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "408,409,411,412,413", "deleted_lines": "406,410,411,412,414", "method_info": {"method_name": "function_on_next", "method_params": "dataset", "method_startline": "393", "method_endline": "423", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "10", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "408,409,411,412,413", "deleted_lines": "410,411,412,414", "method_info": {"method_name": "function_on_next.decorator", "method_params": "func", "method_startline": "407", "method_endline": "421", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "9", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "411,412", "deleted_lines": "411,412", "method_info": {"method_name": "function_on_next.function_on_next.decorator._tf_fun", "method_params": "", "method_startline": "411", "method_endline": "412", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "opennmt\\tests\\dataset_test.py", "file_new_name": "opennmt\\tests\\dataset_test.py", "file_complexity": {"file_NLOC": "151", "file_CCN": "27", "file_NToken": "1423"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "171,172,173,174,175", "deleted_lines": null, "method_info": {"method_name": "testFunctionOnNext._check_one_pass", "method_params": "", "method_startline": "171", "method_endline": "175", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "41", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "168,169", "deleted_lines": null, "method_info": {"method_name": "testFunctionOnNext._identity", "method_params": "next_fn", "method_startline": "168", "method_endline": "169", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "14", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "164,165,166,167,168,169,170,171,172,173,174,175,176,177,178", "deleted_lines": null, "method_info": {"method_name": "testFunctionOnNext", "method_params": "self", "method_startline": "164", "method_endline": "178", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "1"}}}}}}}}