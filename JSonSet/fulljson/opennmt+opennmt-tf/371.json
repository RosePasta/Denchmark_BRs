{"BR": {"BR_id": "371", "BR_author": "BigFishMaster", "BRopenT": "2019-03-06T15:13:50Z", "BRcloseT": "2019-03-06T16:17:53Z", "BR_text": {"BRsummary": "GPT-2 training has problem: ValueError: Duplicate node name in graph: 'lm/w_embs'", "BRdescription": "\n env: opennmt-tf=master, cuda=9.0,gpu=4\n model:gpt_2.py\n error info:\n INFO:tensorflow:Using parameters:\n data:\n   eval_features_file: dev_mini.txt\n   train_features_file: train_full.txt\n   vocabulary: tokens_v3.gpt2\n eval:\n   batch_size: 32\n   eval_delay: 1200\n   exporter: last\n   exporters: last\n   external_evaluators: null\n   num_threads: 1\n   prefetch_buffer_size: 1\n   save_eval_predictions: false\n infer:\n   batch_size: 32\n   bucket_width: 5\n   n_best: 1\n   num_threads: 1\n   prefetch_buffer_size: 1\n   with_scores: false\n model_dir: run\n params:\n   average_loss_in_time: true\n   beam_width: 4\n   decay_params:\n     max_step: 1000000\n     model_dim: 512\n     warmup_steps: 8000\n   decay_type: noam_decay_v2\n   gradients_accum: 1\n   label_smoothing: 0.1\n   learning_rate: 2.0\n   length_penalty: 0.6\n   maximum_iterations: 50\n   minimum_decoding_length: 0\n   optimizer: LazyAdamOptimizer\n   optimizer_params:\n     beta1: 0.9\n     beta2: 0.998\n   weight_decay: 0.01\n score:\n   batch_size: 64\n train:\n   average_last_checkpoints: 8\n   batch_size: 4096\n   batch_type: tokens\n   bucket_width: 8\n   effective_batch_size: null\n   keep_checkpoint_max: 8\n   maximum_features_length: 256\n   maximum_labels_length: 256\n   num_threads: 8\n   prefetch_buffer_size: 4\n   sample_buffer_size: 100000\n   save_checkpoints_secs: null\n   save_checkpoints_steps: 5000\n   save_summary_steps: 100\n   train_steps: 1000000\n \n 2019-03-06 23:09:26.843446: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA\n 2019-03-06 23:09:27.382716: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 0 with properties: \n name: Tesla K40c major: 3 minor: 5 memoryClockRate(GHz): 0.745\n pciBusID: 0000:02:00.0\n totalMemory: 11.17GiB freeMemory: 11.09GiB\n 2019-03-06 23:09:27.645287: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 1 with properties: \n name: Tesla K40c major: 3 minor: 5 memoryClockRate(GHz): 0.745\n pciBusID: 0000:04:00.0\n totalMemory: 11.17GiB freeMemory: 11.09GiB\n 2019-03-06 23:09:27.910482: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 2 with properties: \n name: Tesla K40c major: 3 minor: 5 memoryClockRate(GHz): 0.745\n pciBusID: 0000:83:00.0\n totalMemory: 11.17GiB freeMemory: 11.09GiB\n 2019-03-06 23:09:28.184100: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 3 with properties: \n name: Tesla K40c major: 3 minor: 5 memoryClockRate(GHz): 0.745\n pciBusID: 0000:84:00.0\n totalMemory: 11.17GiB freeMemory: 11.09GiB\n 2019-03-06 23:09:28.184971: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1511] Adding visible gpu devices: 0, 1, 2, 3\n 2019-03-06 23:09:35.080283: I tensorflow/core/common_runtime/gpu/gpu_device.cc:982] Device interconnect StreamExecutor with strength 1 edge matrix:\n 2019-03-06 23:09:35.080335: I tensorflow/core/common_runtime/gpu/gpu_device.cc:988]      0 1 2 3 \n 2019-03-06 23:09:35.080348: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 0:   N Y N N \n 2019-03-06 23:09:35.080356: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 1:   Y N N N \n 2019-03-06 23:09:35.080364: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 2:   N N N Y \n 2019-03-06 23:09:35.080372: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 3:   N N Y N \n 2019-03-06 23:09:35.081500: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/device:GPU:0 with 10747 MB memory) -> physical GPU (device: 0, name: Tesla K40c, pci bus id: 0000:02:00.0, compute capability: 3.5)\n 2019-03-06 23:09:35.082024: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/device:GPU:1 with 10747 MB memory) -> physical GPU (device: 1, name: Tesla K40c, pci bus id: 0000:04:00.0, compute capability: 3.5)\n 2019-03-06 23:09:35.082351: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/device:GPU:2 with 10747 MB memory) -> physical GPU (device: 2, name: Tesla K40c, pci bus id: 0000:83:00.0, compute capability: 3.5)\n 2019-03-06 23:09:35.082622: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/device:GPU:3 with 10747 MB memory) -> physical GPU (device: 3, name: Tesla K40c, pci bus id: 0000:84:00.0, compute capability: 3.5)\n INFO:tensorflow:Using config: {'_model_dir': '/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/data/gpt2/run', '_tf_random_seed': None, '_save_summary_steps': 100, '_save_checkpoints_steps': 5000, '_save_checkpoints_secs': None, '_session_config': gpu_options {\n }\n allow_soft_placement: true\n graph_options {\n   rewrite_options {\n     layout_optimizer: OFF\n   }\n }\n , '_keep_checkpoint_max': 8, '_keep_checkpoint_every_n_hours': 10000, '_log_step_count_steps': 100, '_train_distribute': None, '_device_fn': None, '_protocol': None, '_eval_distribute': None, '_experimental_distribute': None, '_service': None, '_cluster_spec': <tensorflow.python.training.server_lib.ClusterSpec object at 0x7f079dd36cc0>, '_task_type': 'worker', '_task_id': 0, '_global_id_in_cluster': 0, '_master': '', '_evaluation_master': '', '_is_chief': True, '_num_ps_replicas': 0, '_num_worker_replicas': 1}\n INFO:tensorflow:Not using Distribute Coordinator.\n INFO:tensorflow:Running training and evaluation locally (non-distributed).\n INFO:tensorflow:Start train and evaluate loop. The evaluate will happen after every checkpoint. Checkpoint frequency is determined based on RunConfig arguments: save_checkpoints_steps 5000 or save_checkpoints_secs None.\n INFO:tensorflow:Calling model_fn.\n Traceback (most recent call last):\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1628, in _create_c_op\n     c_op = c_api.TF_FinishOperation(op_desc)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Duplicate node name in graph: 'lm/w_embs'\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 201, in <module>\n     main()\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 172, in main\n     runner.train_and_evaluate(checkpoint_path=args.checkpoint_path)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/runner.py\", line 295, in train_and_evaluate\n     result = tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 471, in train_and_evaluate\n     return executor.run()\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 610, in run\n     return self.run_local()\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 711, in run_local\n     saving_listeners=saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\n     loss = self._train_model(input_fn, hooks, saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1207, in _train_model\n     return self._train_model_default(input_fn, hooks, saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1237, in _train_model_default\n     features, labels, model_fn_lib.ModeKeys.TRAIN, self.config)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1195, in _call_model_fn\n     model_fn_results = self._model_fn(features=features, **kwargs)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/estimator.py\", line 162, in _fn\n     _loss_op, local_model, features_shards, labels_shards, params, mode)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/utils/parallel.py\", line 151, in __call__\n     outputs.append(funs[i](*args[i], **kwargs[i]))\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/estimator.py\", line 231, in _loss_op\n     logits, _ = model(features, labels, params, mode)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/models/model.py\", line 85, in __call__\n     return self._call(features, labels, params, mode)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/models/language_model.py\", line 56, in _call\n     self.examples_inputter.build()\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/inputters/text_inputter.py\", line 414, in build\n     name=compat.name_from_variable_scope(\"w_embs\"))\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 183, in __call__\n     return cls._variable_v1_call(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 146, in _variable_v1_call\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 125, in <lambda>\n     previous_getter = lambda **kwargs: default_variable_creator(None, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 2444, in default_variable_creator\n     expected_shape=expected_shape, import_scope=import_scope)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 187, in __call__\n     return super(VariableMetaclass, cls).__call__(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1329, in __init__\n     constraint=constraint)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1443, in _init_from_args\n     name=name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/state_ops.py\", line 77, in variable_op_v2\n     shared_name=shared_name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 1357, in variable_v2\n     shared_name=shared_name, name=name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n     op_def=op_def)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n     return func(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3274, in create_op\n     op_def=op_def)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1792, in __init__\n     control_input_ops)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1631, in _create_c_op\n     raise ValueError(str(e))\n ValueError: Duplicate node name in graph: 'lm/w_embs'\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "BigFishMaster", "commentT": "2019-03-06T15:24:56Z", "comment_text": "\n \t\tThanks for reporting.\n Does it work on a single GPU?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "BigFishMaster", "commentT": "2019-03-06T15:47:03Z", "comment_text": "\n \t\tYep, multi-GPU is currently broken. Will push a fix shortly.\n \t\t"}}}, "commit": {"commit_id": "b9df179a1227176556f144bed4f4ee5cc7a4612b", "commit_author": "Guillaume Klein", "commitT": "2019-03-06 17:17:52+01:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19,20", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "opennmt\\models\\language_model.py", "file_new_name": "opennmt\\models\\language_model.py", "file_complexity": {"file_NLOC": "163", "file_CCN": "13", "file_NToken": "1159"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "63,64,65,66", "deleted_lines": null, "method_info": {"method_name": "_call", "method_params": "self,features,labels,params,mode", "method_startline": "63", "method_endline": "108", "method_complexity": {"method_NLOC": "37", "method_CCN": "2", "method_NToken": "374", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "51", "deleted_lines": "51,52,53,54,55", "method_info": {"method_name": "_build", "method_params": "self", "method_startline": "51", "method_endline": "61", "method_complexity": {"method_NLOC": "11", "method_CCN": "2", "method_NToken": "69", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "opennmt\\models\\model.py", "file_new_name": "opennmt\\models\\model.py", "file_complexity": {"file_NLOC": "121", "file_CCN": "23", "file_NToken": "743"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "105,106,107", "deleted_lines": null, "method_info": {"method_name": "_build", "method_params": "self", "method_startline": "105", "method_endline": "107", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "7", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "86,87", "deleted_lines": null, "method_info": {"method_name": "__call__", "method_params": "self,features,labels,params,mode,config", "method_startline": "72", "method_endline": "88", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "63", "method_nesting_level": "1"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "opennmt\\models\\sequence_to_sequence.py", "file_new_name": "opennmt\\models\\sequence_to_sequence.py", "file_complexity": {"file_NLOC": "381", "file_CCN": "50", "file_NToken": "2608"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "199,232,251", "deleted_lines": "170,171,172,173,174,175,176,177,178,179,198,231,250", "method_info": {"method_name": "_call", "method_params": "self,features,labels,params,mode", "method_startline": "168", "method_endline": "297", "method_complexity": {"method_NLOC": "118", "method_CCN": "11", "method_NToken": "792", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "157,158,159,160,161,162,163,164,165,166", "deleted_lines": "158", "method_info": {"method_name": "_build", "method_params": "self", "method_startline": "157", "method_endline": "166", "method_complexity": {"method_NLOC": "10", "method_CCN": "2", "method_NToken": "90", "method_nesting_level": "1"}}}}}}}}