{"BR": {"BR_id": "414", "BR_author": "BigFishMaster", "BRopenT": "2019-04-22T15:31:27Z", "BRcloseT": "2019-04-29T10:16:27Z", "BR_text": {"BRsummary": "ValueError: Duplicate node name in graph: 'transformer/shared_embeddings/w_embs'", "BRdescription": "\n I met this problem when I use:\n <denchmark-code>model=transformer_shared_embedding.py\n $onmt_main train \\\n           --model ${model} \\\n           --config ${root}/config/transformer_gpu2.yml --auto_config \\\n           --num_gpus 1 \\\n           --checkpoint_path pretrain/model.ckpt-150000 \\\n           --data_dir ${root}\n </denchmark-code>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1628, in _create_c_op\n     c_op = c_api.TF_FinishOperation(op_desc)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Duplicate node name in graph: 'transformer/shared_embeddings/w_embs'\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 201, in <module>\n     main()\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 174, in main\n     runner.train(checkpoint_path=args.checkpoint_path)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/runner.py\", line 316, in train\n     train_spec.input_fn, hooks=train_spec.hooks, max_steps=train_spec.max_steps)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\n     loss = self._train_model(input_fn, hooks, saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1207, in _train_model\n     return self._train_model_default(input_fn, hooks, saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1241, in _train_model_default\n     saving_listeners)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1468, in _train_with_estimator_spec\n     log_step_count_steps=log_step_count_steps) as mon_sess:\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 504, in MonitoredTrainingSession\n     stop_grace_period_secs=stop_grace_period_secs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 921, in __init__\n                                                                                                                        92,3          67%\n     stop_grace_period_secs=stop_grace_period_secs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 921, in __init__\n     stop_grace_period_secs=stop_grace_period_secs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 631, in __init__\n     h.begin()\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/utils/hooks.py\", line 295, in begin\n     tf_vars.append(tf.get_variable(name, shape=value.shape, dtype=tf.as_dtype(value.dtype)))\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 1487, in get_variable\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 1237, in get_variable\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 540, in get_variable\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 492, in _true_getter\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 922, in _get_single_variable\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 183, in __call__\n     return cls._variable_v1_call(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 146, in _variable_v1_call\n     aggregation=aggregation)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 125, in <lambda>\n     previous_getter = lambda **kwargs: default_variable_creator(None, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 2444, in default_variable_creator\n     expected_shape=expected_shape, import_scope=import_scope)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 187, in __call__\n     return super(VariableMetaclass, cls).__call__(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1329, in __init__\n     constraint=constraint)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1443, in _init_from_args\n     name=name)\n                                                                                                                        124,5         89%\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1443, in _init_from_args\n     name=name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/state_ops.py\", line 77, in variable_op_v2\n     shared_name=shared_name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 1357, in variable_v2\n     shared_name=shared_name, name=name)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n     op_def=op_def)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n     return func(*args, **kwargs)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3274, in create_op\n     op_def=op_def)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1792, in __init__\n     control_input_ops)\n   File \"/data1/qspace/chriscxyan/anaconda2/envs/tensorflow/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1631, in _create_c_op\n     raise ValueError(str(e))\n ValueError: Duplicate node name in graph: 'transformer/shared_embeddings/w_embs'\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "BigFishMaster", "commentT": "2019-04-22T17:15:32Z", "comment_text": "\n \t\tThis seems to happen because of --checkpoint_path. Thanks for reporting.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "BigFishMaster", "commentT": "2019-04-28T02:41:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/guillaumekln>@guillaumekln</denchmark-link>\n  do you have any updates?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "BigFishMaster", "commentT": "2019-04-28T21:03:11Z", "comment_text": "\n \t\tSorry, I have a few days off. Will try to fix this ASAP.\n Here is the code loading the trained weights:\n <denchmark-link:https://github.com/OpenNMT/OpenNMT-tf/blob/master/opennmt/utils/hooks.py#L269>https://github.com/OpenNMT/OpenNMT-tf/blob/master/opennmt/utils/hooks.py#L269</denchmark-link>\n \n I think this should get the existing variables using tf.trainable_variables() instead of calling tf.get_variable() for each.\n \t\t"}}}, "commit": {"commit_id": "0383fea069a325e87ed38ba170b7ee672501d4cf", "commit_author": "Guillaume Klein", "commitT": "2019-04-29 12:16:26+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19,20", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "opennmt\\utils\\hooks.py", "file_new_name": "opennmt\\utils\\hooks.py", "file_complexity": {"file_NLOC": "232", "file_CCN": "70", "file_NToken": "1723"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "294,295", "deleted_lines": "292,293,294,295", "method_info": {"method_name": "after_create_session", "method_params": "self,session,coord", "method_startline": "292", "method_endline": "295", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "31", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "277,278,282,285,286,287,288,289,290", "deleted_lines": "276,277,278,279,283,285,287,288,289,290", "method_info": {"method_name": "begin", "method_params": "self", "method_startline": "276", "method_endline": "290", "method_complexity": {"method_NLOC": "14", "method_CCN": "7", "method_NToken": "115", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "274", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,checkpoint_path", "method_startline": "272", "method_endline": "274", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "1"}}}}}}}}