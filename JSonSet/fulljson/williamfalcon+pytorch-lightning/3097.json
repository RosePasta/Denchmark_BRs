{"BR": {"BR_id": "3097", "BR_author": "abrahambotros", "BRopenT": "2020-08-21T23:04:35Z", "BRcloseT": "2020-09-17T08:37:50Z", "BR_text": {"BRsummary": "IoU metric returns 0 score for classes not present in prediction or target", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n The iou metric implementation always returns a score of 0 for a class that is not present in either the prediction or the target. This can lead to a deflated score even for perfectly-predicted examples.\n Case 1: one example of an affected case is multi-class semantic segmentation of an image that does not contain one of the classes. This can be outlined as follows:\n \n We have 3 possible classes in this dataset (0, 1, and 2, where 0 can optionally be the background class).\n Ground-truth target for an image consists only of classes 0 and 2.\n Model perfectly predicts the target.\n The IoU score should be 1.0 (perfect), but the actual score will be deflated (0.67) since there will be an unnecessary penalty for class 1.\n \n Case 2: another example that is a bit more implementation-dependent to explain:\n \n Target contains only 1's.\n Prediction perfectly assigns all 1's.\n The IoU score should be 1.0 (perfect), but the actual score will be deflated (0.5) since there will be an unnecessary penalty for class 0.\n This only applies when a higher-numbered class is present, and lower-numbered classes are not present.\n \n Case 3: All the above are also affected by any num_classes parameter passed to the functional iou implementation - if num_classes=N is given, then all classes with ids <N that did not appear in the target or prediction will always be assigned 0 IoU score. For example, if N=10, and only classes 0 and 1 are present and correct in target and prediction, then classes 2-9 will all have IoU score 0.0.\n Especially in aggregate for a dataset with substantial neutral ground-truth values (i.e., semantic segmentation dataset with lots of images where not all classes are present), this can significantly deflate the (m)IoU score(s). This can also undesirably interact with checkpointing that looks at IoU-based metrics.\n <denchmark-h:h3>To Reproduce / Code sample</denchmark-h>\n \n Case 1 above:\n import torch\n from pytorch_lightning.metrics.functional.classification import iou\n \n target = torch.tensor([0, 2])\n pred = torch.tensor([0, 2])\n \n iou(pred, target) # Returns tensor(0.6667)\n # Same computation, but with 'none' reduction to illustrate what score each class gets:\n iou(pred, target, reduction='none') # Returns tensor([1., 0., 1.])\n Case 2 above:\n target = torch.tensor([1])\n pred = torch.tensor([1])\n \n iou(pred, target) # Returns tensor(0.5)\n iou(pred, target, reduction='none') # Returns tensor([0., 1.])\n Case 3 above:\n target = torch.tensor([0, 1])\n pred = torch.tensor([0, 1])\n \n iou(pred, target, num_classes=10) # Returns tensor(0.2), or 2/10\n iou(pred, target, num_classes=10, reduction='none') # Returns tensor([1., 1., 0., 0., 0., 0., 0., 0., 0., 0.])\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n The fallback IoU score to use for classes not in the target and correctly not in the prediction should be configurable. This should probably default to 1.0, which seems more expected behavior to me.\n Case 1:\n target = torch.tensor([0, 2])\n pred = torch.tensor([0, 2])\n iou(pred, target) # Should return tensor(1.)\n iou(pred, target, reduction='none') # Should return tensor([1., 1., 1.])\n Case 2:\n target = torch.tensor([1])\n pred = torch.tensor([1])\n iou(pred, target) # Should return tensor(1.)\n iou(pred, target, reduction='none') # Should return tensor([1., 1.])\n Case 3:\n target = torch.tensor([0, 1])\n pred = torch.tensor([0, 1])\n iou(pred, target, num_classes=10) # Should return tensor(1.)\n iou(pred, target, num_classes=10, reduction='none') # Should return tensor([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])\n <denchmark-h:h3>Environment</denchmark-h>\n \n <denchmark-code>* CUDA:\n \t- GPU:\n \t\t- GeForce RTX 2070 with Max-Q Design\n \t- available:         True\n \t- version:           10.2\n * Packages:\n \t- numpy:             1.19.1\n \t- pyTorch_debug:     False\n \t- pyTorch_version:   1.5.1\n \t- pytorch-lightning: 0.9.0rc18\n \t- tensorboard:       2.2.0\n \t- tqdm:              4.48.0\n * System:\n \t- OS:                Linux\n \t- architecture:\n \t\t- 64bit\n \t\t- \n \t- processor:         x86_64\n \t- python:            3.7.8\n \t- version:           #38~1596560323~20.04~7719dbd-Ubuntu SMP Tue Aug 4 19:12:34 UTC 2\n </denchmark-code>\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n I have a  open at <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/3098>#3098</denchmark-link>\n  that attempts to implement the expected behavior described above, and adds some tests for this. Any feedback welcome!\n Somewhat-related issues:\n \n #2736\n #2753\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "abrahambotros", "commentT": "2020-08-21T23:05:17Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}}}, "commit": {"commit_id": "76c4afb840b0ae5fcafee07d527c58e9245d099d", "commit_author": "Abe Botros", "commitT": "2020-09-17 10:37:49+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "33,34,35,36", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\metrics\\classification.py", "file_new_name": "pytorch_lightning\\metrics\\classification.py", "file_complexity": {"file_NLOC": "631", "file_CCN": "35", "file_NToken": "1891"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "807,808,809,810,811,812", "deleted_lines": "807,810,811,812", "method_info": {"method_name": "__init__", "method_params": "self,None,float,None,str", "method_startline": "807", "method_endline": "812", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "36", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "807,808,809,810,811,812,813,816,817,818,819,820,821,822,823", "deleted_lines": "807,810,811,812,813,814,815,816,817,818,819,822", "method_info": {"method_name": "__init__", "method_params": "self,bool,str", "method_startline": "807", "method_endline": "823", "method_complexity": {"method_NLOC": "4", "method_CCN": "1", "method_NToken": "38", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "841,842,843,844,845,846,847,848", "deleted_lines": null, "method_info": {"method_name": "forward", "method_params": "self,Tensor,Tensor,None", "method_startline": "837", "method_endline": "848", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "65", "method_nesting_level": "1"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\metrics\\functional\\classification.py", "file_new_name": "pytorch_lightning\\metrics\\functional\\classification.py", "file_complexity": {"file_NLOC": "896", "file_CCN": "30", "file_NToken": "3564"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "965,966,968", "deleted_lines": "967,968", "method_info": {"method_name": "iou", "method_params": "Tensor,Tensor,None,float,None,str", "method_startline": "962", "method_endline": "968", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "46", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "965,966,968", "deleted_lines": "967,968", "method_info": {"method_name": "iou", "method_params": "Tensor,Tensor,None,bool,str", "method_startline": "963", "method_endline": "968", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "34", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "tests\\metrics\\functional\\test_classification.py", "file_new_name": "tests\\metrics\\functional\\test_classification.py", "file_complexity": {"file_NLOC": "339", "file_CCN": "28", "file_NToken": "6002"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "419,420,421,422,423,424,425,426,427,428", "deleted_lines": null, "method_info": {"method_name": "test_iou_absent_score", "method_params": "pred,target,ignore_index,absent_score,num_classes,expected", "method_startline": "419", "method_endline": "428", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "73", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "371,373", "deleted_lines": "371,376", "method_info": {"method_name": "test_iou", "method_params": "half_ones,reduction,remove_bg,expected", "method_startline": "371", "method_endline": "377", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "92", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "373,378,379,380,381,382,383", "deleted_lines": "376", "method_info": {"method_name": "test_iou", "method_params": "half_ones,reduction,ignore_index,expected", "method_startline": "373", "method_endline": "384", "method_complexity": {"method_NLOC": "12", "method_CCN": "2", "method_NToken": "97", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "444,445,446,447,448,449,450,451,452", "deleted_lines": null, "method_info": {"method_name": "test_iou_ignore_index", "method_params": "pred,target,ignore_index,num_classes,reduction,expected", "method_startline": "444", "method_endline": "452", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "69", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\metrics\\test_classification.py", "file_new_name": "tests\\metrics\\test_classification.py", "file_complexity": {"file_NLOC": "172", "file_CCN": "24", "file_NToken": "1852"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "230,231", "deleted_lines": "230,231", "method_info": {"method_name": "test_iou", "method_params": "remove_bg", "method_startline": "230", "method_endline": "237", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "66", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "230,231", "deleted_lines": "230,231", "method_info": {"method_name": "test_iou", "method_params": "ignore_index", "method_startline": "230", "method_endline": "237", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "66", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\trainer\\test_trainer_tricks.py", "file_new_name": "tests\\trainer\\test_trainer_tricks.py", "file_complexity": {"file_NLOC": "202", "file_CCN": "19", "file_NToken": "1621"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "66", "method_info": {"method_name": "test_overfit_batch_limits", "method_params": "tmpdir", "method_startline": "41", "method_endline": "142", "method_complexity": {"method_NLOC": "51", "method_CCN": "3", "method_NToken": "566", "method_nesting_level": "0"}}}}}}}}