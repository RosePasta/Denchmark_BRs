{"BR": {"BR_id": "5087", "BR_author": "philipbecker", "BRopenT": "2020-12-11T12:07:11Z", "BRcloseT": "2021-01-17T18:34:59Z", "BR_text": {"BRsummary": "Edge case bug when validating on multiple data sets if .log is not called at least once for each data set.", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n When validating on multiple data sets, if you call self.log(..) for any data set, self.log(..) also has to have been called for all previous data sets at least once. If not, you get a KeyError when the results are auto reduced. I encountered this because for one of my validation sets I only created and logged images.\n <denchmark-h:h2>Reproduce</denchmark-h>\n \n import pytorch_lightning as pl\n import torch\n from torch.utils.data import DataLoader, TensorDataset\n \n \n class Module(pl.LightningModule):\n     def __init__(self):\n         super().__init__()\n         self.model = torch.nn.Linear(1, 1)\n \n     def validation_step(self, batch, batch_idx, dataset_idx):\n         if dataset_idx == 0:\n             # When you uncomment the following line, everything works.\n             # self.log(\"test1\", 0.)\n             # Just calling self.log for dataset 0 and not for dataset 1 also works\n             pass\n         else:\n             self.log(\"test2\", 0.)\n \n     def val_dataloader(self):\n         return (\n             DataLoader(TensorDataset(torch.ones(2, 1))),\n             DataLoader(TensorDataset(torch.ones(2, 1)))\n         )\n \n     def training_step(self, batch, batch_idx):\n         return torch.mean(self.model(batch[0]))\n \n     def train_dataloader(self):\n         return DataLoader(TensorDataset(torch.ones(2, 1)))\n \n     def configure_optimizers(self):\n         return torch.optim.SGD(self.parameters(), lr=0.01)\n \n \n if __name__ == \"__main__\":\n     trainer = pl.Trainer()\n     trainer.fit(Module())\n Error you get:\n <denchmark-code>  File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/trainer.py\", line 690, in run_sanity_check\n     _, eval_results = self.run_evaluation(test_mode=False, max_batches=self.num_sanity_val_batches)\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/trainer.py\", line 622, in run_evaluation\n     deprecated_eval_results = self.evaluation_loop.evaluation_epoch_end()\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/evaluation_loop.py\", line 203, in evaluation_epoch_end\n     self.trainer.logger_connector.evaluation_epoch_end(self.testing)\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/connectors/logger_connector/logger_connector.py\", line 225, in evaluation_epoch_end\n     self.cached_results.has_batch_loop_finished = True\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/connectors/logger_connector/epoch_result_store.py\", line 441, in has_batch_loop_finished\n     self.auto_reduce_results_on_epoch_end()\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/connectors/logger_connector/epoch_result_store.py\", line 431, in auto_reduce_results_on_epoch_end\n     hook_result.auto_reduce_results_on_epoch_end()\n   File \"/usr/local/lib/python3.6/dist-packages/pytorch_lightning/trainer/connectors/logger_connector/epoch_result_store.py\", line 195, in auto_reduce_results_on_epoch_end\n     epoch_metrics = self._internals[dl_idx]\n KeyError: 0\n </denchmark-code>\n \n <denchmark-h:h3>Environment</denchmark-h>\n \n <denchmark-code>* CUDA:\n         - GPU:\n         - available:         False\n         - version:           10.2\n * Packages:\n         - numpy:             1.19.4\n         - pyTorch_debug:     False\n         - pyTorch_version:   1.7.1\n         - pytorch-lightning: 1.1.0\n         - tqdm:              4.54.1\n * System:\n         - OS:                Linux\n         - architecture:\n                 - 64bit\n                 - ELF\n         - processor:         x86_64\n         - python:            3.6.9\n         - version:           #62-Ubuntu SMP Mon Nov 23 19:20:19 UTC 2020\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "philipbecker", "commentT": "2020-12-11T12:08:00Z", "comment_text": "\n \t\tHi! thanks for your contribution!, great first issue!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "philipbecker", "commentT": "2021-01-10T18:06:11Z", "comment_text": "\n \t\tThis issue has been automatically marked as stale because it hasn't had any recent activity. This issue will be closed in 7 days if no further activity occurs. Thank you for your contributions, Pytorch Lightning Team!\n \t\t"}}}, "commit": {"commit_id": "9cfbf8d6092de6d6b26b67dbdb93dfeb406a2c70", "commit_author": "Rohit Gupta", "commitT": "2021-01-06 12:57:24+01:00", "commit_complexity": {"commit_NLOC": "0.5714285714285714", "commit_CCN": "1.0", "commit_Nprams": "0.8809523809523809"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "71,72", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\source\\debugging.rst", "file_new_name": "docs\\source\\debugging.rst", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "31,38,39,40,41,42", "deleted_lines": "31"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\source\\trainer.rst", "file_new_name": "docs\\source\\trainer.rst", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "669,670,671", "deleted_lines": "669,670,671"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\callbacks\\early_stopping.py", "file_new_name": "pytorch_lightning\\callbacks\\early_stopping.py", "file_complexity": {"file_NLOC": "162", "file_CCN": "34", "file_NToken": "736"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "186,188,189,190,191", "deleted_lines": "181,182,183,184,185,186,187,194,196", "method_info": {"method_name": "_run_early_stopping_check", "method_params": "self,trainer,pl_module", "method_startline": "181", "method_endline": "221", "method_complexity": {"method_NLOC": "27", "method_CCN": "10", "method_NToken": "191", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "179", "deleted_lines": "179", "method_info": {"method_name": "on_train_epoch_end", "method_params": "self,trainer,pl_module,outputs", "method_startline": "174", "method_endline": "179", "method_complexity": {"method_NLOC": "4", "method_CCN": "2", "method_NToken": "25", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "167,170", "deleted_lines": "167,170", "method_info": {"method_name": "on_validation_epoch_end", "method_params": "self,trainer,pl_module", "method_startline": "166", "method_endline": "172", "method_complexity": {"method_NLOC": "5", "method_CCN": "4", "method_NToken": "34", "method_nesting_level": "1"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\callbacks\\gpu_stats_monitor.py", "file_new_name": "pytorch_lightning\\callbacks\\gpu_stats_monitor.py", "file_complexity": {"file_NLOC": "166", "file_CCN": "33", "file_NToken": "876"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "216", "method_info": {"method_name": "_should_log", "method_params": "trainer", "method_startline": "210", "method_endline": "217", "method_complexity": {"method_NLOC": "7", "method_CCN": "3", "method_NToken": "38", "method_nesting_level": "1"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pytorch_lightning\\callbacks\\lr_monitor.py", "file_new_name": "pytorch_lightning\\callbacks\\lr_monitor.py", "file_complexity": {"file_NLOC": "139", "file_CCN": "34", "file_NToken": "741"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "108", "deleted_lines": "108", "method_info": {"method_name": "on_train_batch_start", "method_params": "self,trainer,args,kwargs", "method_startline": "100", "method_endline": "109", "method_complexity": {"method_NLOC": "8", "method_CCN": "5", "method_NToken": "68", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "193", "method_info": {"method_name": "_should_log", "method_params": "trainer", "method_startline": "187", "method_endline": "194", "method_complexity": {"method_NLOC": "7", "method_CCN": "3", "method_NToken": "38", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "116", "deleted_lines": "116", "method_info": {"method_name": "on_train_epoch_start", "method_params": "self,trainer,args,kwargs", "method_startline": "111", "method_endline": "117", "method_complexity": {"method_NLOC": "6", "method_CCN": "4", "method_NToken": "58", "method_nesting_level": "1"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "file_new_name": "pytorch_lightning\\callbacks\\model_checkpoint.py", "file_complexity": {"file_NLOC": "481", "file_CCN": "93", "file_NToken": "2427"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "454,461", "deleted_lines": "453,460", "method_info": {"method_name": "__resolve_ckpt_dir", "method_params": "self,trainer,pl_module", "method_startline": "420", "method_endline": "462", "method_complexity": {"method_NLOC": "22", "method_CCN": "8", "method_NToken": "161", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "218,219", "deleted_lines": "218", "method_info": {"method_name": "save_checkpoint", "method_params": "self,trainer,pl_module", "method_startline": "208", "method_endline": "243", "method_complexity": {"method_NLOC": "19", "method_CCN": "8", "method_NToken": "110", "method_nesting_level": "1"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\callbacks\\progress.py", "file_new_name": "pytorch_lightning\\callbacks\\progress.py", "file_complexity": {"file_NLOC": "311", "file_CCN": "59", "file_NToken": "1456"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "325", "deleted_lines": "326", "method_info": {"method_name": "on_epoch_start", "method_params": "self,trainer,pl_module", "method_startline": "321", "method_endline": "332", "method_complexity": {"method_NLOC": "11", "method_CCN": "3", "method_NToken": "79", "method_nesting_level": "1"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\connectors\\debugging_connector.py", "file_new_name": "pytorch_lightning\\trainer\\connectors\\debugging_connector.py", "file_complexity": {"file_NLOC": "65", "file_CCN": "8", "file_NToken": "358"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,17,19,59,62,63,64,65,68", "deleted_lines": "15,61"}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "pytorch_lightning\\trainer\\properties.py", "file_new_name": "pytorch_lightning\\trainer\\properties.py", "file_complexity": {"file_NLOC": "237", "file_CCN": "68", "file_NToken": "1402"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "234,235,236,237,238,239", "deleted_lines": "235", "method_info": {"method_name": "early_stopping_callbacks", "method_params": "self", "method_startline": "234", "method_endline": "239", "method_complexity": {"method_NLOC": "6", "method_CCN": "3", "method_NToken": "28", "method_nesting_level": "1"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "225,226,227,228,229,230,231", "deleted_lines": "227,228", "method_info": {"method_name": "early_stopping_callback", "method_params": "self", "method_startline": "225", "method_endline": "231", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "30", "method_nesting_level": "1"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "252,253,254,255", "deleted_lines": null, "method_info": {"method_name": "checkpoint_callbacks", "method_params": "self", "method_startline": "251", "method_endline": "256", "method_complexity": {"method_NLOC": "6", "method_CCN": "3", "method_NToken": "28", "method_nesting_level": "1"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "244,245", "deleted_lines": null, "method_info": {"method_name": "checkpoint_callback", "method_params": "self", "method_startline": "242", "method_endline": "248", "method_complexity": {"method_NLOC": "7", "method_CCN": "2", "method_NToken": "30", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "202", "deleted_lines": "202", "method_info": {"method_name": "enable_validation", "method_params": "self", "method_startline": "198", "method_endline": "202", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "33", "method_nesting_level": "1"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\training_loop.py", "file_new_name": "pytorch_lightning\\trainer\\training_loop.py", "file_complexity": {"file_NLOC": "553", "file_CCN": "164", "file_NToken": "4091"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "914,915", "deleted_lines": "914,915", "method_info": {"method_name": "save_loggers_on_train_batch_end", "method_params": "self", "method_startline": "911", "method_endline": "915", "method_complexity": {"method_NLOC": "4", "method_CCN": "4", "method_NToken": "41", "method_nesting_level": "1"}}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\callbacks\\test_early_stopping.py", "file_new_name": "tests\\callbacks\\test_early_stopping.py", "file_complexity": {"file_NLOC": "193", "file_CCN": "23", "file_NToken": "1434"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "89,93,99,100", "deleted_lines": "93", "method_info": {"method_name": "test_early_stopping_no_extraneous_invocations", "method_params": "tmpdir", "method_startline": "86", "method_endline": "101", "method_complexity": {"method_NLOC": "14", "method_CCN": "1", "method_NToken": "75", "method_nesting_level": "0"}}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\checkpointing\\test_checkpoint_callback_frequency.py", "file_new_name": "tests\\checkpointing\\test_checkpoint_callback_frequency.py", "file_complexity": {"file_NLOC": "56", "file_CCN": "5", "file_NToken": "470"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66", "method_info": {"method_name": "test_mc_called_on_fastdevrun", "method_params": "tmpdir", "method_startline": "25", "method_endline": "66", "method_complexity": {"method_NLOC": "17", "method_CCN": "1", "method_NToken": "98", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "48,49,50", "method_info": {"method_name": "test_mc_called_on_fastdevrun.training_step", "method_params": "self,batch,batch_idx", "method_startline": "48", "method_endline": "50", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": null, "deleted_lines": "42,43,44,45,46", "method_info": {"method_name": "test_mc_called_on_fastdevrun.__init__", "method_params": "self", "method_startline": "42", "method_endline": "46", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "2"}}}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\checkpointing\\test_model_checkpoint.py", "file_new_name": "tests\\checkpointing\\test_model_checkpoint.py", "file_complexity": {"file_NLOC": "711", "file_CCN": "93", "file_NToken": "5327"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "893,894", "deleted_lines": "892", "method_info": {"method_name": "test_hparams_type", "method_params": "tmpdir,hparams_type", "method_startline": "880", "method_endline": "909", "method_complexity": {"method_NLOC": "26", "method_CCN": "3", "method_NToken": "148", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "866,867", "deleted_lines": "866", "method_info": {"method_name": "test_current_score_when_nan", "method_params": "tmpdir,mode", "method_startline": "851", "method_endline": "876", "method_complexity": {"method_NLOC": "22", "method_CCN": "2", "method_NToken": "104", "method_nesting_level": "0"}}}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\loggers\\test_all.py", "file_new_name": "tests\\loggers\\test_all.py", "file_complexity": {"file_NLOC": "265", "file_CCN": "29", "file_NToken": "1896"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "117,118,119", "deleted_lines": "117,118,119", "method_info": {"method_name": "_test_loggers_fit_test", "method_params": "tmpdir,logger_class", "method_startline": "83", "method_endline": "141", "method_complexity": {"method_NLOC": "45", "method_CCN": "7", "method_NToken": "280", "method_nesting_level": "0"}}}}}, "file_15": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tests\\trainer\\flags\\test_fast_dev_run.py", "file_new_name": "tests\\trainer\\flags\\test_fast_dev_run.py", "file_complexity": {"file_NLOC": "69", "file_CCN": "8", "file_NToken": "464"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "49,50,51", "deleted_lines": null, "method_info": {"method_name": "test_callbacks_and_logger_not_called_with_fastdevrun.validation_step", "method_params": "self,batch,batch_idx", "method_startline": "49", "method_endline": "51", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "25", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "43,44,45,46,47", "deleted_lines": null, "method_info": {"method_name": "test_callbacks_and_logger_not_called_with_fastdevrun.training_step", "method_params": "self,batch,batch_idx", "method_startline": "43", "method_endline": "47", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "58", "method_nesting_level": "2"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "17", "deleted_lines": null, "method_info": {"method_name": "test_skip_on_fast_dev_run_tuner", "method_params": "tmpdir,tuner_alg", "method_startline": "14", "method_endline": "27", "method_complexity": {"method_NLOC": "12", "method_CCN": "3", "method_NToken": "71", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "62,63,64,65,66,67,68,69,70,71,72,73,74", "deleted_lines": null, "method_info": {"method_name": "test_callbacks_and_logger_not_called_with_fastdevrun._make_fast_dev_run_assertions", "method_params": "trainer", "method_startline": "62", "method_endline": "74", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "71", "method_nesting_level": "1"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "37,38,39,40,41", "deleted_lines": null, "method_info": {"method_name": "test_callbacks_and_logger_not_called_with_fastdevrun.__init__", "method_params": "self", "method_startline": "37", "method_endline": "41", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "27", "method_nesting_level": "2"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101", "deleted_lines": null, "method_info": {"method_name": "test_callbacks_and_logger_not_called_with_fastdevrun", "method_params": "tmpdir,fast_dev_run", "method_startline": "32", "method_endline": "101", "method_complexity": {"method_NLOC": "29", "method_CCN": "1", "method_NToken": "131", "method_nesting_level": "0"}}}}}}}}