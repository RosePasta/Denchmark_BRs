{"BR": {"BR_id": "1321", "BR_author": "liuzh91", "BRopenT": "2020-08-27T08:44:21Z", "BRcloseT": "2020-09-01T07:08:04Z", "BR_text": {"BRsummary": "[Script] Valid sequence length used in Electra dynamic masking", "BRdescription": "\n <denchmark-h:h2>Description</denchmark-h>\n \n  is used to mark the non-reserve tokens in the sequence in <denchmark-link:https://github.com/dmlc/gluon-nlp/blob/master/scripts/pretraining/pretraining_utils.py#L503>https://github.com/dmlc/gluon-nlp/blob/master/scripts/pretraining/pretraining_utils.py#L503</denchmark-link>\n . For example, for a sequence like\n <denchmark-code>[CLS] Manhattan is the core of New York City.[SEP][PAD][PAD][PAD]\n </denchmark-code>\n \n The corresponding valid_candidates tokens should be like:\n <denchmark-code>01111111110000\n </denchmark-code>\n \n In short, valid_candidates mask out tokens like [CLS] [SEP] and [PAD]. Current implementation of valid_candidates is wrong. It will always output sequences with all 1s.\n The problem is that the initialization of  is wrong, as in <denchmark-link:https://github.com/dmlc/gluon-nlp/blob/master/scripts/pretraining/pretraining_utils.py#L497>https://github.com/dmlc/gluon-nlp/blob/master/scripts/pretraining/pretraining_utils.py#L497</denchmark-link>\n \n <denchmark-code> valid_candidates = F.np.ones_like(input_ids, dtype=np.bool)\n </denchmark-code>\n \n valid_candidates is initialized to be all 1s. When doing subsequent operations, the value will never change.\n <denchmark-h:h2>Environment</denchmark-h>\n \n We recommend using our script for collecting the diagnositc information. Run the following command and paste the outputs below:\n <denchmark-code>curl --retry 10 -s https://raw.githubusercontent.com/dmlc/gluon-nlp/master/tools/diagnose.py | python\n \n # paste outputs here\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "liuzh91", "commentT": "2020-08-27T08:49:02Z", "comment_text": "\n \t\tThis issue finds a fatal problem that makes valid_candidates invalidated\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "liuzh91", "commentT": "2020-08-27T08:53:13Z", "comment_text": "\n \t\tFor a quick fix, we may change this section\n \n \n \n gluon-nlp/scripts/pretraining/pretraining_utils.py\n \n \n         Lines 497 to 503\n       in\n       970318d\n \n \n \n \n \n \n  valid_candidates = F.np.ones_like(input_ids, dtype=np.bool) \n \n \n \n  ignore_tokens = [self.vocab.cls_id, self.vocab.sep_id, self.vocab.pad_id] \n \n \n \n  \n \n \n \n  for ignore_token in ignore_tokens: \n \n \n \n  # TODO(zheyuye), Update when operation += supported \n \n \n \n  valid_candidates = valid_candidates + \\ \n \n \n \n  F.np.not_equal(input_ids, ignore_token) \n \n \n \n \n \n We can change that to\n valid_candidates = F.np.ones_like(input_ids, dtype=np.bool) \n for ignore_token in ignore_tokens: \n     valid_candidates = valid_candidates - F.np.equal(input_ids, ignore_token)\n In addition, I think it will be better to move it to the preprocessing phase.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "liuzh91", "commentT": "2020-08-27T09:34:09Z", "comment_text": "\n \t\t\n For a quick fix, we may change this section\n \n \n \n gluon-nlp/scripts/pretraining/pretraining_utils.py\n \n \n         Lines 497 to 503\n       in\n       970318d\n \n \n \n \n \n \n  valid_candidates = F.np.ones_like(input_ids, dtype=np.bool) \n \n \n \n  ignore_tokens = [self.vocab.cls_id, self.vocab.sep_id, self.vocab.pad_id] \n \n \n \n  \n \n \n \n  for ignore_token in ignore_tokens: \n \n \n \n  # TODO(zheyuye), Update when operation += supported \n \n \n \n  valid_candidates = valid_candidates + \\ \n \n \n \n  F.np.not_equal(input_ids, ignore_token) \n \n \n \n \n \n We can change that to\n valid_candidates = F.np.ones_like(input_ids, dtype=np.bool) \n for ignore_token in ignore_tokens: \n     valid_candidates = valid_candidates - F.np.equal(input_ids, ignore_token)\n In addition, I think it will be better to move it to the preprocessing phase.\n \n You cannot use minus here, some of values may end being negative numbers after that. Use multiply will solve the problem.\n \t\t"}}}, "commit": {"commit_id": "1bd85b6dca9bf01f4f420e435eaeec7e9931c633", "commit_author": "liuzh91", "commitT": "2020-08-31 23:58:51-07:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "scripts\\pretraining\\pretraining_utils.py", "file_new_name": "scripts\\pretraining\\pretraining_utils.py", "file_complexity": {"file_NLOC": "283", "file_CCN": "37", "file_NToken": "1987"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "502,510,511,517,518", "deleted_lines": "502,510,511,517", "method_info": {"method_name": "dynamic_masking", "method_params": "self,F,input_ids,valid_lengths", "method_startline": "464", "method_endline": "554", "method_complexity": {"method_NLOC": "46", "method_CCN": "2", "method_NToken": "420", "method_nesting_level": "1"}}}}}}}}