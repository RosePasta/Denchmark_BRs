{"BR": {"BR_id": "295", "BR_author": "ardabbour", "BRopenT": "2021-01-19T13:00:20Z", "BRcloseT": "2021-01-21T00:42:34Z", "BR_text": {"BRsummary": "[Bug] Multi env problem with Taxi-v3", "BRdescription": "\n <denchmark-h:h3>\ud83d\udc1b Bug</denchmark-h>\n \n The A2C and PPO algorithms are seeming not working in parallel for the Taxi-v3 environment. Judging by the error message it is a numpy problem. There is no error unless multiprocessing is used. Also, multiprocessing works on other environments such as 'CartPole-v1', so I'm guessing it has to do with the discrete state space.\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n <denchmark-h:h4>Minimal Code</denchmark-h>\n \n from stable_baselines3 import A2C # this can also be PPO, same error\n from stable_baselines3.common.env_util import make_vec_env\n env = make_vec_env(\"Taxi-v3\", n_envs=4, seed=0)\n model = A2C(policy=\"MlpPolicy\", env=env, verbose=True)\n model.learn(total_timesteps=10000)\n <denchmark-h:h4>Traceback</denchmark-h>\n \n Using cuda device\n ---------------------------------------------------------------------------\n ValueError                                Traceback (most recent call last)\n <ipython-input-3-4551c9bb2165> in <module>\n       3 env = make_vec_env(\"Taxi-v3\", n_envs=4, seed=0)\n       4 model = A2C(policy=\"MlpPolicy\", env=env, verbose=True)\n ----> 5 model.learn(total_timesteps=10_000)\n \n ~/envs/bsh/lib/python3.8/site-packages/stable_baselines3/a2c/a2c.py in learn(self, total_timesteps, callback, log_interval, eval_env, eval_freq, n_eval_episodes, tb_log_name, eval_log_path, reset_num_timesteps)\n     181     ) -> \"A2C\":\n     182 \n --> 183         return super(A2C, self).learn(\n     184             total_timesteps=total_timesteps,\n     185             callback=callback,\n \n ~/envs/bsh/lib/python3.8/site-packages/stable_baselines3/common/on_policy_algorithm.py in learn(self, total_timesteps, callback, log_interval, eval_env, eval_freq, n_eval_episodes, tb_log_name, eval_log_path, reset_num_timesteps)\n     220         while self.num_timesteps < total_timesteps:\n     221 \n --> 222             continue_training = self.collect_rollouts(self.env, callback, self.rollout_buffer, n_rollout_steps=self.n_steps)\n     223 \n     224             if continue_training is False:\n \n ~/envs/bsh/lib/python3.8/site-packages/stable_baselines3/common/on_policy_algorithm.py in collect_rollouts(self, env, callback, rollout_buffer, n_rollout_steps)\n     176                 # Reshape in case of discrete action\n     177                 actions = actions.reshape(-1, 1)\n --> 178             rollout_buffer.add(self._last_obs, actions, rewards, self._last_dones, values, log_probs)\n     179             self._last_obs = new_obs\n     180             self._last_dones = dones\n \n ~/envs/bsh/lib/python3.8/site-packages/stable_baselines3/common/buffers.py in add(self, obs, action, reward, done, value, log_prob)\n     350             log_prob = log_prob.reshape(-1, 1)\n     351 \n --> 352         self.observations[self.pos] = np.array(obs).copy()\n     353         self.actions[self.pos] = np.array(action).copy()\n     354         self.rewards[self.pos] = np.array(reward).copy()\n \n ValueError: could not broadcast input array from shape (4) into shape (4,1)\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n A model to get trained in parallel using A2C (or PPO).\n ###\u00a0System Info\n \n pip inside venv\n Graphics card info: GeForce GTX 1050 Ti, Nvidia driver version 460.27.04, CUDA version 11.2\n Python version 3.8.7\n PyTorch version 1.7.1\n Gym version 0.18.0\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n No additional context.\n <denchmark-h:h3>Checklist</denchmark-h>\n \n \n  I have checked that there is no similar issue in the repo (required)\n  I have read the documentation (required)\n  I have provided a minimal working example to reproduce the bug (required)\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ardabbour", "commentT": "2021-01-19T13:37:50Z", "comment_text": "\n \t\tHello,\n thanks for raising the issue.\n yes, the problem comes from the discrete observation space which is apparently not handled properly in SB3 when using multiple environments.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ardabbour", "commentT": "2021-01-19T14:09:18Z", "comment_text": "\n \t\tI pushed a fix in <denchmark-link:https://github.com/DLR-RM/stable-baselines3/pull/296>#296</denchmark-link>\n , should be merged with master soon ;)\n \t\t"}}}, "commit": {"commit_id": "d7c6aff2523122aebf1e70210b2c56642e0b2735", "commit_author": "Antonin RAFFIN", "commitT": "2021-01-21 02:42:33+02:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\misc\\changelog.rst", "file_new_name": "docs\\misc\\changelog.rst", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "6,40,55,543", "deleted_lines": "6,40,542"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "stable_baselines3\\common\\buffers.py", "file_new_name": "stable_baselines3\\common\\buffers.py", "file_complexity": {"file_NLOC": "339", "file_CCN": "38", "file_NToken": "2360"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "361,362,363,364,365", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "stable_baselines3\\version.txt", "file_new_name": "stable_baselines3\\version.txt", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1", "deleted_lines": "1"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_cnn.py", "file_new_name": "tests\\test_cnn.py", "file_complexity": {"file_NLOC": "139", "file_CCN": "31", "file_NToken": "1508"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "24", "deleted_lines": "24", "method_info": {"method_name": "test_cnn", "method_params": "tmp_path,model_class", "method_startline": "17", "method_endline": "46", "method_complexity": {"method_NLOC": "16", "method_CCN": "2", "method_NToken": "178", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\test_custom_policy.py", "file_new_name": "tests\\test_custom_policy.py", "file_complexity": {"file_NLOC": "39", "file_CCN": "7", "file_NToken": "474"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "22", "deleted_lines": "22", "method_info": {"method_name": "test_flexible_mlp", "method_params": "model_class,net_arch", "method_startline": "21", "method_endline": "22", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "33", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "38", "deleted_lines": "38", "method_info": {"method_name": "test_custom_optimizer", "method_params": "model_class,optimizer_kwargs", "method_startline": "33", "method_endline": "41", "method_complexity": {"method_NLOC": "8", "method_CCN": "3", "method_NToken": "89", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_distributions.py", "file_new_name": "tests\\test_distributions.py", "file_complexity": {"file_NLOC": "79", "file_CCN": "6", "file_NToken": "679"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "40", "deleted_lines": "40", "method_info": {"method_name": "test_squashed_gaussian", "method_params": "model_class", "method_startline": "36", "method_endline": "48", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "96", "method_nesting_level": "0"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_save_load.py", "file_new_name": "tests\\test_save_load.py", "file_complexity": {"file_NLOC": "331", "file_CCN": "49", "file_NToken": "3028"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "181", "deleted_lines": "181", "method_info": {"method_name": "test_set_env", "method_params": "model_class", "method_startline": "166", "method_endline": "196", "method_complexity": {"method_NLOC": "15", "method_CCN": "3", "method_NToken": "138", "method_nesting_level": "0"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_spaces.py", "file_new_name": "tests\\test_spaces.py", "file_complexity": {"file_NLOC": "52", "file_CCN": "14", "file_NToken": "563"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "74,75,76", "deleted_lines": null, "method_info": {"method_name": "test_discrete_obs_space", "method_params": "model_class,env", "method_startline": "74", "method_endline": "76", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "36", "method_nesting_level": "0"}}}}}}}}