{"BR": {"BR_id": "143", "BR_author": "martin-laurent", "BRopenT": "2018-06-21T14:48:17Z", "BRcloseT": "2018-06-22T19:12:11Z", "BR_text": {"BRsummary": "Feature transformations order lost after filtering on a MultiFeatureSpec", "BRdescription": "\n We have noticed something strange when using the filter method of the MultiFeatureSpec: we are losing the order of the features as they were defined in the original FeatureSpec objects. We had a part of our pipeline that was actually refering explicitely to the feature number 0 and the feature number 2 of a resulting SparseVector:\n <denchmark-code>val featureSpecs: FeatureSpec[AllFeatures] = FeatureSpec.of[AllFeatures]\n     // ... Many feature transformations\n \n val labelSpecs: FeatureSpec[AllFeatures] = FeatureSpec.of[AllFeatures]\n     .optional(i => i.map(_.weight))(Identity(\"weight\"))\n     .optional(i => i.map(_.label))(Identity(\"label\"))\n \n val featureExtractor = MultiFeatureSpec(labelSpecs, featureSpecs)\n            .filter{ f =>\n             includedFeaturesWithLabels.contains(f.transformer.name)\n           }\n           .extract(rawFeatures)\n \n def toTFTrainingExample(data: Seq[SparseVector[Float]]): Example = {\n     // data is the list of the featurized raw features in the order of the FeatureSpec given\n     // to multiSpecs\n     val labels = data(0).data\n     val features: SparseVector[Float] = data(1)\n     val label = labels.headOption\n     val weight = labels.length match {\n       case 2 => Some(labels(1))\n       case 1 => Some(1f)\n       case _ => None\n     }\n     TensorFlowType[TrainingExample].toExample(\n       TrainingExample(\n         features.index.toList,\n         features.data.toList,\n         label,\n         weight\n       ))\n }\n </denchmark-code>\n \n But when the filtering is done, it seems the  are moved to a HashMap (losing the order at this point: <denchmark-link:https://github.com/spotify/featran/blob/master/core/src/main/scala/com/spotify/featran/MultiFeatureSpec.scala#L72-L76>https://github.com/spotify/featran/blob/master/core/src/main/scala/com/spotify/featran/MultiFeatureSpec.scala#L72-L76</denchmark-link>\n  then converted back to arrays.\n That means we cannot assume the order of the features in the resulting SparseVector.\n This looks like an unwanted behavior and definitely unexpected from the user point of view.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "martin-laurent", "commentT": "2018-06-22T18:30:40Z", "comment_text": "\n \t\tShould be an easy fix by using a LinkedHashMap.\n \t\t"}}}, "commit": {"commit_id": "86c2266fad514be37fc968557a27b361fb81ecf6", "commit_author": "Filipe Regadas", "commitT": "2018-06-22 15:12:10-04:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "core\\src\\main\\scala\\com\\spotify\\featran\\FeatureSpec.scala", "file_new_name": "core\\src\\main\\scala\\com\\spotify\\featran\\FeatureSpec.scala", "file_complexity": {"file_NLOC": "314", "file_CCN": "40", "file_NToken": "2991"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "126,127,128,129,130,132", "deleted_lines": "126,127,128,129,130,132", "method_info": {"method_name": "filter", "method_params": "T,_,_,Boolean", "method_startline": "125", "method_endline": "144", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "112", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "core\\src\\main\\scala\\com\\spotify\\featran\\MultiFeatureSpec.scala", "file_new_name": "core\\src\\main\\scala\\com\\spotify\\featran\\MultiFeatureSpec.scala", "file_complexity": {"file_NLOC": "53", "file_CCN": "1", "file_NToken": "568"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "72,73,74,75,76,77,78,79,80", "deleted_lines": "72,73,74,75,76,77,78,79,80", "method_info": {"method_name": "filter", "method_params": "T,_,_,Boolean", "method_startline": "71", "method_endline": "92", "method_complexity": {"method_NLOC": "10", "method_CCN": "1", "method_NToken": "122", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "core\\src\\test\\scala\\com\\spotify\\featran\\FeatureSpecSpec.scala", "file_new_name": "core\\src\\test\\scala\\com\\spotify\\featran\\FeatureSpecSpec.scala", "file_complexity": {"file_NLOC": "190", "file_CCN": "0", "file_NToken": "2508"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "core\\src\\test\\scala\\com\\spotify\\featran\\MultiFeatureSpecSpec.scala", "file_new_name": "core\\src\\test\\scala\\com\\spotify\\featran\\MultiFeatureSpecSpec.scala", "file_complexity": {"file_NLOC": "87", "file_CCN": "0", "file_NToken": "958"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "47,49,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70", "deleted_lines": "47,49,52,53,54,55"}}}}}}