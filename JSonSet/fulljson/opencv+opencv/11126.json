{"BR": {"BR_id": "11126", "BR_author": "anthonytw", "BRopenT": "2018-03-20T17:50:06Z", "BRcloseT": "2018-03-24T06:36:09Z", "BR_text": {"BRsummary": "Maximum chunk size assertion in videoio's AVI container implementation appears to be incorrect.", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 3.4.1\n Operating System / Platform => Ubuntu Linux 17.10 64-bit\n Compiler => clang-5.0\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n The AVI container implementation in the videoio module appears, to me, to have a bug. In file modules/videoio/src/container_avi.cpp the following function is defined:\n <denchmark-code>std::vector<char> AVIReadContainer::readFrame(frame_iterator it)\n {\n     m_file_stream->seekg(it->first);\n \n     RiffChunk chunk;\n     *(m_file_stream) >> chunk;\n     CV_Assert(chunk.m_size <= 0xFFFF);   // <--- ATW: Bug?\n \n     std::vector<char> result;\n \n     result.reserve(chunk.m_size);\n     result.resize(chunk.m_size);\n \n     m_file_stream->read(&(result[0]), chunk.m_size); // result.data() failed with MSVS2008\n \n     return result;\n }\n </denchmark-code>\n \n Notice the assertion: CV_Assert(chunk.m_size <= 0xFFFF);. I was running into the issue where I was unable to open an MJPG video with the VideoCapture class after writing it with the VideoWriter class. The video seems perfectly fine, and when I remove this assertion the software works as expected.\n Why is this assertion present? Has this chunk size limitation possibly been increased or removed in newer implementations? It seems this assertion either needs to be updated with a larger maximum chunk size or removed all together, but I'm not sure which. Alternatively, if this is a real limit then there may be a bug in the code that writes the AVI videos, since it seems to be using chunk sizes that trigger this assertion when the videos are read back in.\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n No code. You need to get (un)lucky and generate a video that includes large chunks. I can provide a video if helpful, but this seems like more of an API / specification technicality.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "anthonytw", "commentT": "2018-03-20T22:06:13Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/anthonytw>@anthonytw</denchmark-link>\n  , this assertion has been added to satisfy static analysis tools complaining about values read from file and then used to allocate memory. So the limit is not real, probably we can omit the assertion. Feel free to provide pull request with a fix.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "anthonytw", "commentT": "2018-03-21T06:00:44Z", "comment_text": "\n \t\tJust omitting an assertion will lead to memory DOS (vulnerability), so reasonable limit with 64Mb (or configurable in runtime) should be added. Current 64Kb is too small.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "anthonytw", "commentT": "2018-03-23T16:14:34Z", "comment_text": "\n \t\tOkay, I initiated a pull request which sets the upper threshold to 64MB.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "anthonytw", "commentT": "2018-04-11T03:31:50Z", "comment_text": "\n \t\tI also had this problem when the opencv updated from 3.0.0 to 3.4.1. The running program had an exception when the input AVI video is smaller than 64MB. Later, I found that opencv\\sources\\modules\\videoio\\src\\container_avi.cpp 514line CV_Assert(chunk.m_size <= 0xFFFF); means the video file should be larger than 64MB according to the VS output logfile. Unfortunately, the 64.5MB AVI file still failed... ^_^\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "anthonytw", "commentT": "2018-07-05T14:38:39Z", "comment_text": "\n \t\tHow do you get to the file containing this assertion?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "anthonytw", "commentT": "2019-01-18T01:57:44Z", "comment_text": "\n \t\ti have this problem too, and what i should do is omit this asseration?\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "anthonytw", "commentT": "2019-08-07T08:14:10Z", "comment_text": "\n \t\tI don't think this bug was ever cleared even in the recent version of Opencv 3.4.2.\n Testing with AVI, returned this error on one of the file: Error: Assertion failed (chunk.m_size <= 0xFFFF) in cv::AVIReadContainer::readFrame. If you have an idea how to fix this, please post here. Many thanks.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "anthonytw", "commentT": "2019-08-07T10:11:01Z", "comment_text": "\n \t\tCheck output of cv::getBuildInformation() for actual running version.\n \t\t"}}}, "commit": {"commit_id": "c6cf7f80808eee8cebec4c8417b2d99714defcac", "commit_author": "Anthony Wertz", "commitT": "2018-03-23 12:03:46-04:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\videoio\\src\\container_avi.cpp", "file_new_name": "modules\\videoio\\src\\container_avi.cpp", "file_complexity": {"file_NLOC": "826", "file_CCN": "144", "file_NToken": "4909"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "514,515,516,517,518,519", "deleted_lines": "514", "method_info": {"method_name": "cv::AVIReadContainer::readFrame", "method_params": "it", "method_startline": "508", "method_endline": "529", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "84", "method_nesting_level": "1"}}}}}}}}