{"BR": {"BR_id": "11408", "BR_author": "tomoaki0705", "BRopenT": "2018-04-27T09:53:39Z", "BRcloseT": "2018-04-28T03:20:14Z", "BR_text": {"BRsummary": "Arm: fix the test failure of OCL_Imgproc/CLAHETest.Accuracy on ODROID-XU4", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => recent master ( 61edcee )\n Operating System / Platform => Ubuntu 16.04 Arm ODROID-XU4 + Mali T628\n Compiler => GCC 5.4.0\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n \n The test OCL_Imgproc/CLAHETest.Accuracy was failing on ODROID-XU4\n \n <denchmark-code>OpenCV version: 3.4.1-dev\n OpenCV VCS version: 3.4.1-314-g61edcee\n Build type: release\n Parallel framework: pthreads\n CPU features: neon\n [ INFO:0] Initialize OpenCL runtime...\n OpenCL Platforms: \n     ARM Platform\n         iGPU: Mali-T628 (OpenCL 1.2 v1.r17p0-01rel0.a881d28363cdb20f0017ed13c980967e)\n (sniip)\n [==========] 24 tests from 1 test case ran. (625 ms total)\n [  PASSED  ] 22 tests.\n [  FAILED  ] 2 tests, listed below:\n [  FAILED  ] OCL_Imgproc/CLAHETest.Accuracy/18, where GetParam() = (8x64, 10, false)\n [  FAILED  ] OCL_Imgproc/CLAHETest.Accuracy/19, where GetParam() = (8x64, 10, true)\n </denchmark-code>\n \n \n But this test failure didn't happen on other \"Mali\" devices, such as Tinker Board, Firefly RK3399.\n More than that, the test did pass on ODROID-XU4, randomly\n \n <denchmark-code>OpenCV version: 3.4.1-dev\n OpenCV VCS version: 3.4.1-314-g61edcee\n Build type: release\n Parallel framework: pthreads\n CPU features: neon\n [ INFO:0] Initialize OpenCL runtime...\n OpenCL Platforms: \n     ARM Platform\n         iGPU: Mali-T628 (OpenCL 1.2 v1.r17p0-01rel0.a881d28363cdb20f0017ed13c980967e)\n (sniip)\n [==========] 24 tests from 1 test case ran. (490 ms total)\n [  PASSED  ] 24 tests.\n </denchmark-code>\n \n \n I could figure out that the result from GPU was varying, when the CPU version kept still.\n Reading the source code of clahe.cl, I realized there is a race condition in the reduction\n \n <denchmark-code>    barrier(CLK_LOCAL_MEM_FENCE);\n \n     if (tid < 8)\n     {\n #endif\n         smem[tid] += smem[tid + 8];\n         smem[tid] += smem[tid + 4];\n         smem[tid] += smem[tid + 2];\n         smem[tid] += smem[tid + 1];\n     }\n </denchmark-code>\n \n \n I add more lock in between the add, and so far, the random failure didn't happen after 100 iterations of opencv_test_imgproc\n I'll send a PR later.\n \n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n \n Run opencv_test_imgproc on ODROID-XU4\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "tomoaki0705", "commentT": "2018-04-28T03:20:13Z", "comment_text": "\n \t\tI confirmed that commit <denchmark-link:https://github.com/opencv/opencv/commit/87a4f4ab3afc1eaed05480f16bbae570a3d33254>87a4f4a</denchmark-link>\n   ( <denchmark-link:https://github.com/opencv/opencv/pull/11409>#11409</denchmark-link>\n  ) resolves this problem.\n \t\t"}}}, "commit": {"commit_id": "87a4f4ab3afc1eaed05480f16bbae570a3d33254", "commit_author": "Tomoaki Teshima", "commitT": "2018-04-27 16:41:56+03:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "0.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\imgproc\\src\\clahe.cpp", "file_new_name": "modules\\imgproc\\src\\clahe.cpp", "file_complexity": {"file_NLOC": "315", "file_CCN": "51", "file_NToken": "2908"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57", "deleted_lines": "57,58,59,60,61,62,63,64,65,66", "method_info": {"method_name": "clahe::calcLut", "method_params": "_src,_dst,tilesX,tilesY,tileSize,clipLimit,lutScale", "method_startline": "53", "method_endline": "81", "method_complexity": {"method_NLOC": "24", "method_CCN": "2", "method_NToken": "263", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "modules\\imgproc\\src\\opencl\\clahe.cl", "file_new_name": "modules\\imgproc\\src\\opencl\\clahe.cl", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "59,73,75,79,81,85,87,91,93,96,98,102,103,104,147", "deleted_lines": "46,47,48,49,63,64,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,125,126,127,131,132,133,134,135,136,137,138,140,182,183,184,185,186,187,188,189"}}}}}}