{"BR": {"BR_id": "16708", "BR_author": "alalek", "BRopenT": "2020-03-01T09:59:02Z", "BRcloseT": "2020-03-05T09:11:24Z", "BR_text": {"BRsummary": "Imgproc: integral OOB access (2020-03-01)", "BRdescription": "\n Relates <denchmark-link:https://github.com/opencv/opencv/pull/16556>#16556</denchmark-link>\n \n Valgrind SSE (<denchmark-link:http://pullrequest.opencv.org/buildbot/builders/3_4_valgrind-lin64-debug/builds/139>nightly</denchmark-link>\n ):\n <denchmark-code>[ RUN      ] Imgproc_Integral.accuracy\n ==13847== Invalid read of size 16\n ==13847==    at 0x5695276: _mm_blendv_epi8 (smmintrin.h:181)\n ==13847==    by 0x5695276: v_load_deinterleave (intrin_sse.hpp:2089)\n ==13847==    by 0x5695276: operator() (sumpixels.simd.hpp:243)\n ==13847==    by 0x5695276: cv::hal::cpu_baseline::integral_SIMD(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.simd.hpp:1116)\n ==13847==    by 0x5696A94: cv::hal::integral_SIMD(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.dispatch.cpp:361)\n ==13847==    by 0x5696C01: cv::hal::integral(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.dispatch.cpp:378)\n ==13847==    by 0x569BD53: cv::integral(cv::_InputArray const&, cv::_OutputArray const&, cv::_OutputArray const&, cv::_OutputArray const&, int, int) (sumpixels.dispatch.cpp:445)\n ==13847==    by 0x569D7D4: cvIntegral (sumpixels.dispatch.cpp:488)\n </denchmark-code>\n \n AVX2:\n <denchmark-code>[ RUN      ] Size_MatType_OutMatDepth_integral.integral/6, where GetParam() = (640x480, 8UC3, CV_32S)\n ==46316== Invalid read of size 16\n ==46316==    at 0x5208CE4: _mm256_loadu_si256 (avxintrin.h:921)\n ==46316==    by 0x5208CE4: cv::hal_AVX2::v_load_deinterleave(unsigned char const*, cv::hal_AVX2::v_uint8x32&, cv::hal_AVX2::v_uint8x32&, cv::hal_AVX2::v_uint8x32&) (intrin_avx.hpp:2391)\n ==46316==    by 0x531CBF3: cv::hal::opt_AVX2::(anonymous namespace)::Integral_SIMD<unsigned char, int, double>::operator()(unsigned char const*, unsigned long, int*, unsigned long, double*, unsigned long, int*, unsigned long, int, int, int) const (sumpixels.simd.hpp:243)\n ==46316==    by 0x5324374: cv::hal::opt_AVX2::integral_SIMD(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.simd.hpp:1116)\n ==46316==    by 0x50B6418: cv::hal::integral_SIMD(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.dispatch.cpp:361)\n ==46316==    by 0x50B662E: cv::hal::integral(int, int, int, unsigned char const*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, unsigned char*, unsigned long, int, int, int) (sumpixels.dispatch.cpp:378)\n </denchmark-code>\n \n \n MacOSX:\n [ RUN      ] Size_MatType_OutMatDepth_integral.integral/6, where GetParam() = (640x480, 8UC3, CV_32S)\n Process returned: -11\n \n Win64:\n [ RUN      ] OCL_ImgSize_TmplSize_Method_MatType_MatchTemplate.MatchTemplate/89, where GetParam() = (1280x1024, 11x11, TM_CCOEFF, 8UC3)\n C:\\build\\3_4_noICV-win64-vc14\\opencv\\modules\\ts\\src\\ts_perf.cpp(2038): error: Failed\n Expected: PerfTestBody() doesn't throw an exception.\n   Actual: it throws...\n params    = (1280x1024, 11x11, TM_CCOEFF, 8UC3)\n termination reason:  unhandled exception\n bytesIn   =          0\n bytesOut  =          0\n samples   =          0 of 1\n outliers  =          0\n frequency =          0\n [  FAILED  ] OCL_ImgSize_TmplSize_Method_MatType_MatchTemplate.MatchTemplate/89, where GetParam() = (1280x1024, 11x11, TM_CCOEFF, 8UC3) (32 ms)\n \n [ RUN      ] OCL_ImgSize_TmplSize_Method_MatType_MatchTemplate.MatchTemplate/113, where GetParam() = (1280x1024, 16x16, TM_CCOEFF, 8UC3)\n C:\\build\\3_4_noICV-win64-vc14\\opencv\\modules\\ts\\src\\ts_perf.cpp(2038): error: Failed\n Expected: PerfTestBody() doesn't throw an exception.\n   Actual: it throws...\n params    = (1280x1024, 16x16, TM_CCOEFF, 8UC3)\n termination reason:  unhandled exception\n bytesIn   =          0\n bytesOut  =          0\n samples   =          0 of 1\n outliers  =          0\n frequency =          0\n [  FAILED  ] OCL_ImgSize_TmplSize_Method_MatType_MatchTemplate.MatchTemplate/113, where GetParam() = (1280x1024, 16x16, TM_CCOEFF, 8UC3) (47 ms)\n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "alalek", "commentT": "2020-03-02T14:54:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n , I think this is the problem.  It is loading a whole vector (x3) but only using the lower half.\n <denchmark-code>                for ( ; j + v_uint16::nlanes * cn <= width; j += v_uint16::nlanes * cn)\n                 {\n                     v_uint8 v_src_row_1, v_src_row_2, v_src_row_3;\n                     v_load_deinterleave(src_row + j, v_src_row_1, v_src_row_2, v_src_row_3);\n                     v_int16 el8_1 = v_reinterpret_as_s16(v_expand_low(v_src_row_1));\n                     v_int16 el8_2 = v_reinterpret_as_s16(v_expand_low(v_src_row_2));\n                     v_int16 el8_3 = v_reinterpret_as_s16(v_expand_low(v_src_row_3));\n </denchmark-code>\n \n It is only an issue for 3-channels (line 240, 549 and 899 of sumpixels.simd.hpp)\n I think the solution is to change one line in each of 8UC3->S32/F32/F64 to\n <denchmark-code>                for ( ; j + v_uint16::nlanes * cn * 2 <= width; j += v_uint16::nlanes * cn)\n </denchmark-code>\n \n Currently I'm not set up for valgrind testing.  If you could test these changes, it would be a lot easier.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "alalek", "commentT": "2020-03-04T09:36:38Z", "comment_text": "\n \t\tI have adjusted loop boundaries <denchmark-link:https://github.com/opencv/opencv/pull/16731>#16731</denchmark-link>\n , but looks  (some checks are failed - need to investigate).\n \t\t"}}}, "commit": {"commit_id": "fd0941356627794efc43ceff5ce6116b871d369a", "commit_author": "Alexander Alekhin", "commitT": "2020-03-04 19:28:04+00:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.5", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\imgproc\\perf\\perf_integral.cpp", "file_new_name": "modules\\imgproc\\perf\\perf_integral.cpp", "file_complexity": {"file_NLOC": "108", "file_CCN": "7", "file_NToken": "1014"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "42,43,47,48,49,50,51,52,53,54,55,56,57,58", "deleted_lines": "45", "method_info": {"method_name": "opencv_test::PERF_TEST_P", "method_params": "Size_MatType_OutMatDepth,integral,Combine", "method_startline": "26", "method_endline": "59", "method_complexity": {"method_NLOC": "29", "method_CCN": "3", "method_NToken": "348", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "modules\\imgproc\\src\\sumpixels.simd.hpp", "file_new_name": "modules\\imgproc\\src\\sumpixels.simd.hpp", "file_complexity": {"file_NLOC": "912", "file_CCN": "154", "file_NToken": "10858"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "907,908,909,910,911", "deleted_lines": "899", "method_info": {"method_name": "cv::hal::Integral_SIMD<uchar,double,double>::operator ( )", "method_params": "src,_srcstep,sum,_sumstep,sqsum,_sqsumstep,tilted,size_t,width,height,cn", "method_startline": "717", "method_endline": "1106", "method_complexity": {"method_NLOC": "328", "method_CCN": "40", "method_NToken": "4221", "method_nesting_level": "4"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "553,554,555,556,557", "deleted_lines": "549", "method_info": {"method_name": "cv::hal::Integral_SIMD<uchar,float,double>::operator ( )", "method_params": "src,_srcstep,sum,_sumstep,sqsum,size_t,tilted,size_t,width,height,cn", "method_startline": "402", "method_endline": "708", "method_complexity": {"method_NLOC": "254", "method_CCN": "35", "method_NToken": "3120", "method_nesting_level": "4"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "240,241,242,243,244", "deleted_lines": "240", "method_info": {"method_name": "cv::hal::Integral_SIMD<uchar,int,double>::operator ( )", "method_params": "src,_srcstep,sum,_sumstep,sqsum,size_t,tilted,size_t,width,height,cn", "method_startline": "85", "method_endline": "394", "method_complexity": {"method_NLOC": "252", "method_CCN": "38", "method_NToken": "2985", "method_nesting_level": "4"}}}}}}}}