{"BR": {"BR_id": "5469", "BR_author": "amroamroamro", "BRopenT": "2015-10-07T21:08:28Z", "BRcloseT": "2015-10-12T17:44:27Z", "BR_text": {"BRsummary": "[ML] problem with cv::ml::randMVNormal", "BRdescription": "\n The <denchmark-link:http://docs.opencv.org/3.0.0/dd/ded/group__ml.html#gaf444266b05eeb29f24fc4fe6b6972c8d>randMVNormal</denchmark-link>\n  function always throws an error (failed assertion). Here is a minimal example to reproduce the error:\n #include <iostream>\n #include \"opencv2/core.hpp\"\n #include \"opencv2/ml.hpp\"\n using namespace std;\n using namespace cv;\n using namespace cv::ml;\n \n int main()\n {\n     // generate nxd matrix of samples, X~N(mean,cov) \n     int n = 10;\n     int d = 2;\n     Mat mean = Mat::zeros(1, d, CV_32F);  // I tried both 1xd and dx1\n     Mat cov = Mat::eye(d, d, CV_32F);\n     Mat samples;\n     randMVNormal(mean, cov, n, samples);\n     cout << samples << endl;\n     return 0;\n }\n \n OpenCV Error: Assertion failed\n (C.type() == type && (((flags&GEMM_3_T) == 0 && C.rows == d_size.height && C.cols == d_size.width) || ((flags&GEMM_3_T) != 0 && C.rows == d_size.width && C.cols == d_size.height)))\n in cv::gemm, file C:\\builds\\master_PackSlave-win64-vc12-shared\\opencv\\modules\\core\\src\\matmul.cpp, line 923\n \n I think the arguments of <denchmark-link:https://github.com/Itseez/opencv/blob/3.0.0/modules/core/src/matmul.cpp#L921>gemm</denchmark-link>\n  have the wrong dimensions. According to the <denchmark-link:http://docs.opencv.org/3.0.0/d2/de8/group__core__array.html#gacb6e64071dffe36434e1e7ee79e7cb35>docs</denchmark-link>\n , it performs the following operation: .\n Inside randMVNormal, it gets called with:\n <denchmark-code>src1 = samples.row(i)   // 1xd vector\n src2 = cholesky(cov)    // dxd matrix\n src3 = mean             // 1xd vector\n dst = samples.row(i)    // 1xd vector\n flags = GEMM_3_T\n </denchmark-code>\n \n Note that cv::ml::createConcentricSpheresTestSet also throws similar error, because it uses randMVNormal internally.\n <denchmark-h:hr></denchmark-h>\n \n Beside the above problem, I think there is another bug in randMVNormal. The matrix samples is initially filled with randu(samples, 0., 1.). Shouldn't randn be used here instead?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "amroamroamro", "commentT": "2015-10-08T09:13:20Z", "comment_text": "\n \t\tAre you up to supplying a pull request with the suggested fixes? That might speed up the process of getting it fixed!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "amroamroamro", "commentT": "2015-10-08T19:30:52Z", "comment_text": "\n \t\tOk. How about this version:\n void randMVNormal(InputArray _mean, InputArray _cov, int nsamples, OutputArray _samples)\n {\n     // check mean vector and covariance matrix\n     Mat mean = _mean.getMat(), cov = _cov.getMat();\n     int dim = (int)mean.total();  // dimensionality\n     CV_Assert(mean.rows == 1 || mean.cols == 1);\n     CV_Assert(cov.rows == dim && cov.cols == dim);\n     mean = mean.reshape(1,1);     // ensure a row vector\n \n     // generate n-samples of the same dimension, from ~N(0,1)\n     _samples.create(nsamples, dim, CV_32F);\n     Mat samples = _samples.getMat();\n     randn(samples, Scalar::all(0), Scalar::all(1));\n \n     // decompose covariance using Cholesky: cov = utmat.t() * utmat\n     // Note: cov must be square, symmetric, and positive semi-definite matrix\n     Mat utmat;\n     Cholesky(cov, utmat);\n \n     // transform random numbers using specified mean and covariance\n     //samples = samples * utmat + repeat(mean,nsamples,1);\n     for(int i=0; i<nsamples; ++i) {\n         Mat sample = samples.row(i);\n         sample = sample * utmat + mean;\n     }\n }\n I'm using matrix expressions to multiply instead of directly calling cv::gemm (simply because it's easier to read, I believe it will eventually call gemm as well).. I also I changed randu to randn as I previously mentioned.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "amroamroamro", "commentT": "2015-10-10T15:43:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/amroamroamro>@amroamroamro</denchmark-link>\n  it is difficult to see here what you have changed.\n Please create a pullrequest and link the pullrequest to this issue by commenting \"<denchmark-link:https://github.com/opencv/opencv/issues/5469>#5469</denchmark-link>\n \"\n Then your fix will get reviewed.\n <denchmark-link:https://github.com/Itseez/opencv/wiki/How_to_contribute#making-a-good-pull-request>https://github.com/Itseez/opencv/wiki/How_to_contribute#making-a-good-pull-request</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "amroamroamro", "commentT": "2015-10-11T17:10:37Z", "comment_text": "\n \t\tThank you for the PR!\n \t\t"}}}, "commit": {"commit_id": "13a0a37e6346c6fe45de474208f63283d6d4e729", "commit_author": "Amro", "commitT": "2015-10-11 01:54:11+03:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\ml\\src\\inner_functions.cpp", "file_new_name": "modules\\ml\\src\\inner_functions.cpp", "file_complexity": {"file_NLOC": "100", "file_CCN": "28", "file_NToken": "923"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "154,156,157,158,159,161,164,166,167,171,175", "deleted_lines": "155,159,163,168", "method_info": {"method_name": "cv::ml::randMVNormal", "method_params": "_mean,_cov,nsamples,_samples", "method_startline": "152", "method_endline": "177", "method_complexity": {"method_NLOC": "18", "method_CCN": "4", "method_NToken": "169", "method_nesting_level": "2"}}}}}}}}