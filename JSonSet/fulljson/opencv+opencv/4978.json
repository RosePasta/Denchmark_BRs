{"BR": {"BR_id": "4978", "BR_author": "opencv-pushbot", "BRopenT": "2015-07-27T11:20:41Z", "BRcloseT": "2019-01-23T10:32:42Z", "BR_text": {"BRsummary": "decomposeHomographyMat does not return the expected decomposition", "BRdescription": "\n Transferred from <denchmark-link:http://code.opencv.org/issues/4307>http://code.opencv.org/issues/4307</denchmark-link>\n \n <denchmark-code>|| Philippe Bouttefroy on 2015-05-01 18:52\n || Priority: Normal\n || Affected: branch 'master' (3.0-dev)\n || Category: calibration, 3d\n || Tracker: Bug\n || Difficulty: \n || PR: \n || Platform: Any / Any\n </denchmark-code>\n \n <denchmark-h:h2>decomposeHomographyMat does not return the expected decomposition</denchmark-h>\n \n <denchmark-code>Hi,\n \n I am integrating decomposeHomographyMat in our codebase. I noticed in my unit tests that the method returns incorrect results about 10-25% of the time. I have reproduced a case in the OpenCV unit tests framework and enclose the file here (test_homography_decomp.cpp). The data used does not seem to represent any specific configuration (or at least non that I could identify). Also, I have relaxed the threshold a LOT (from 0.001 to 1) to make sure that this is not due to a \"tight threshold\". I also copy/paste the test results at the end of this message, FYI.\n \n The formula used to generate the homography is (from Malis paper): H = R + t^{T}*n/d, where R is the rotation, t is the translation, n is the plane normal and d is the distance of the plane to the origin. Then H is scaled so that H(2,2) = 1.\n \n Could you please confirm the bug and let me know when a fix is available? Please let me know if you need any further information (I did not include any platform, etc. details because you should be able to reproduce on any platform). I can also generate more failure cases if you need.\n \n Thanks,\n Philippe\n \n -----------------------------------------------\n ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n Test with OpenCV original data:\n \n ***** VIDEOINPUT LIBRARY - 0.1995 - TFW07 *****\n \n OpenCV version: 3.0.0-dev\n OpenCV VCS version: unknown\n Build type: debug\n Parallel framework: ms-concurrency\n CPU features: popcnt mmx sse sse2 sse3 ssse3 sse4.1 sse4.2\n OpenCL Platforms:\n     NVIDIA CUDA\n         dGPU: GeForce GTX 970 (OpenCL 1.1 CUDA)\n Current OpenCL device:\n     Type = dGPU\n     Name = GeForce GTX 970\n     Version = OpenCL 1.1 CUDA\n     Compute units = 13\n     Max work group size = 1024\n     Local memory size = 47 kB 1023 B\n     Max memory allocation size = 1 GB\n     Double support = Yes\n     Host unified memory = No\n     Has AMD Blas = No\n     Has AMD Fft = No\n     Preferred vector width char = 1\n     Preferred vector width short = 1\n     Preferred vector width int = 1\n     Preferred vector width long = 1\n     Preferred vector width float = 1\n     Preferred vector width double = 1\n Note: Google Test filter = *Calib3d_DecomposeHomography*\n [==========] Running 1 test from 1 test case.\n [----------] Global test environment set-up.\n [----------] 1 test from Calib3d_DecomposeHomography\n [ RUN      ] Calib3d_DecomposeHomography.regression\n [       OK ] Calib3d_DecomposeHomography.regression (0 ms)\n [----------] 1 test from Calib3d_DecomposeHomography (0 ms total)\n \n [----------] Global test environment tear-down\n [==========] 1 test from 1 test case ran. (0 ms total)\n [  PASSED  ] 1 test.\n \n ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n Test with new data (in uploaded file):\n \n ***** VIDEOINPUT LIBRARY - 0.1995 - TFW07 *****\n \n OpenCV version: 3.0.0-dev\n OpenCV VCS version: unknown\n Build type: debug\n Parallel framework: ms-concurrency\n CPU features: popcnt mmx sse sse2 sse3 ssse3 sse4.1 sse4.2\n OpenCL Platforms:\n     NVIDIA CUDA\n         dGPU: GeForce GTX 970 (OpenCL 1.1 CUDA)\n Current OpenCL device:\n     Type = dGPU\n     Name = GeForce GTX 970\n     Version = OpenCL 1.1 CUDA\n     Compute units = 13\n     Max work group size = 1024\n     Local memory size = 47 kB 1023 B\n     Max memory allocation size = 1 GB\n     Double support = Yes\n     Host unified memory = No\n     Has AMD Blas = No\n     Has AMD Fft = No\n     Preferred vector width char = 1\n     Preferred vector width short = 1\n     Preferred vector width int = 1\n     Preferred vector width long = 1\n     Preferred vector width float = 1\n     Preferred vector width double = 1\n Note: Google Test filter = *Calib3d_DecomposeHomography*\n [==========] Running 1 test from 1 test case.\n [----------] Global test environment set-up.\n [----------] 1 test from Calib3d_DecomposeHomography\n [ RUN      ] Calib3d_DecomposeHomography.regression\n ..\\..\\..\\modules\\calib3d\\test\\test_homography_decomp.cpp(78): error: Value of: containsValidMotion(rotations, translations, normals)\n   Actual: false\n Expected: true\n [  FAILED  ] Calib3d_DecomposeHomography.regression (0 ms)\n [----------] 1 test from Calib3d_DecomposeHomography (1 ms total)\n \n [----------] Global test environment tear-down\n [==========] 1 test from 1 test case ran. (2 ms total)\n [  PASSED  ] 0 tests.\n [  FAILED  ] 1 test, listed below:\n [  FAILED  ] Calib3d_DecomposeHomography.regression\n </denchmark-code>\n \n <denchmark-h:h2>History</denchmark-h>\n \n <denchmark-h:h5>Philippe Bouttefroy on 2015-05-02 01:31</denchmark-h>\n \n <denchmark-code>The data that I provided is actually not consistent - I provided a homography with the translation denormalized but provided a normalized translation. The data below is consistent now:\n \n         _K = Matx33d(1.0,   0.0,    0.0,\n                      0.0,   1.0,    0.0,\n                      0.0,   0.0,    1.0);\n \n         _H = Matx33d(-0.102896, 0.270191,   -0.0031153,\n                      0.0406387, 1.19569,    -0.0120456,\n                      0.445351,  0.0410889,  1);\n \n         //expected solution for the given homography and intrinsic matrices\n         _R = Matx33d(0.692477,      0.657668,   -0.29656,\n                      -0.615501,     0.753003,   0.232688,\n                      0.376343,      0.0214022,  0.926233);\n \n         _t = Vec3d(0.934629,\n                    -0.775506,\n                    -0.0368358);\n         _n = Vec3d(-0.841608,\n                    -0.43925,\n                    0.314254);\n \n         Matx33d h = _R + (_t * _n.t());\n         double norm = h(2, 2);\n         h = (1 / norm)*h;\n         std::cout << h << std::endl;\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "opencv-pushbot", "commentT": "2017-03-07T21:38:33Z", "comment_text": "\n \t\tWhat's the status here? Does OpenCV have a reliable homography decomposition?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "opencv-pushbot", "commentT": "2018-04-20T23:59:17Z", "comment_text": "\n \t\tThere is an bug in decomposeHomographyMat. For many homographies it returns rotations with negative determinants. In this case the rotation and corresponding translation should be negated. Then the results are correct.\n For example, this happens with:\n <denchmark-code>cv::Mat H = cv::Matx33d(-0.3507, 0.0219, 0.0049,\n                          -0.0217, -0.3488, -0.0042,\n                          0.0187, 0.0052, -0.3515);\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "78bd55c8df9bef7b87c4cdce029b805f58345fd5", "commit_author": "Jim Zhou", "commitT": "2019-01-11 16:58:47+03:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "0.75"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "modules\\calib3d\\src\\homography_decomp.cpp", "file_new_name": "modules\\calib3d\\src\\homography_decomp.cpp", "file_complexity": {"file_NLOC": "376", "file_CCN": "70", "file_NToken": "3488"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "188,189,190,191", "deleted_lines": null, "method_info": {"method_name": "cv::HomographyDecomposition::HomographyDecompZhang::findMotionFrom_tstar_n", "method_params": "tstar,n,motion", "method_startline": "179", "method_endline": "195", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "143", "method_nesting_level": "2"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "319,320,321,322", "deleted_lines": null, "method_info": {"method_name": "cv::HomographyDecomposition::HomographyDecompInria::findRmatFrom_tstar_n", "method_params": "tstar,n,v,R", "method_startline": "310", "method_endline": "323", "method_complexity": {"method_NLOC": "13", "method_CCN": "2", "method_NToken": "129", "method_nesting_level": "2"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\calib3d\\test\\test_homography_decomp.cpp", "file_new_name": "modules\\calib3d\\test\\test_homography_decomp.cpp", "file_complexity": {"file_NLOC": "91", "file_CCN": "13", "file_NToken": "794"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166", "deleted_lines": null, "method_info": {"method_name": "opencv_test::TEST", "method_params": "Calib3d_DecomposeHomography,issue_4978", "method_startline": "138", "method_endline": "166", "method_complexity": {"method_NLOC": "24", "method_CCN": "2", "method_NToken": "229", "method_nesting_level": "2"}}}}}}}}