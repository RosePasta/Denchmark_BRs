{"BR": {"BR_id": "15011", "BR_author": "dcouwenh", "BRopenT": "2019-07-10T15:11:43Z", "BRcloseT": "2019-10-03T20:51:56Z", "BR_text": {"BRsummary": "Bayer VNG artifacts for specific edge orientations", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 3.2.0\n Operating System / Platform => Windows 10 64-bit / Python\n Compiler => MSC v.1900 64 bit (AMD64)\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n Using the VNG demosaicing in cvtColor( ) results in edge artifacts for edges running at orientations of 315 degrees (roughly NW -> SE).  You can see these artifacts in the image below created with the OpenCV VNG algorithm (top row), but not in an image created using a reference implementation of the VNG algorithm (in attached code vng.py) (bottom row).  Some color artifacts along edges are expected due to the nature of the interpolation, but the artifacts shown here on edges running from upper left to lower right are more severe than expected, and worse than the reference output.  Displaying a single channel (such as just the red channel shown on the right) makes it easier to see that pixels far from the edge are being modified in the OpenCV version.\n <denchmark-link:https://user-images.githubusercontent.com/47040981/60977391-66679200-a2fd-11e9-8e16-ab784eb6d64f.PNG></denchmark-link>\n \n For edges running along different orientations, such as 45 degrees (roughly SW -> NE), the OpenCV VNG implementation does not show artifacts, and appears to match the reference VNG implementation, as shown below.\n <denchmark-link:https://user-images.githubusercontent.com/47040981/60977435-75e6db00-a2fd-11e9-9993-4b32097a91d5.PNG></denchmark-link>\n \n Since the VNG algorithm computes gradients in the eight compass directions and there are separate blocks of code for processing each gradient direction, is it possible that there is a pointer error in the code for one of the gradient directions ?\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n The examples above were generated by calling OpenCV from Python inside a Jupyter Notebook.\n The input and output images for the examples above are attached, and can be duplicated by running the attached notebook \"VNG_bug.ipynb\"\n <denchmark-link:https://github.com/opencv/opencv/files/3378154/VNG_bug.zip>VNG_bug.zip</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "dcouwenh", "commentT": "2019-07-15T14:52:59Z", "comment_text": "\n \t\tI think I found the bug.  If I replace lines 1112 and 1120 in demosaicing.cpp as shown below, this artifact goes away.\n <denchmark-link:https://user-images.githubusercontent.com/47040981/61226606-bd4fdb80-a6f0-11e9-88db-62ad0f1e5640.png></denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "dcouwenh", "commentT": "2019-07-15T15:35:22Z", "comment_text": "\n \t\tCould you please propose this patch as pull request?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "dcouwenh", "commentT": "2019-07-15T19:50:12Z", "comment_text": "\n \t\tI also fixed these bugs in the SSE2 accelerated code blocks, and created a pull request.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "dcouwenh", "commentT": "2019-07-18T12:49:34Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/dcouwenh>@dcouwenh</denchmark-link>\n  , you should create a pull request from your repository  branch  to the main repository  branch .\n See also: <denchmark-link:https://github.com/opencv/opencv/wiki/Branches>https://github.com/opencv/opencv/wiki/Branches</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "dcouwenh", "commentT": "2019-07-18T18:23:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mshabunin>@mshabunin</denchmark-link>\n  -- thanks.  I messed up my first pull request (<denchmark-link:https://github.com/opencv/opencv/pull/15085>#15085</denchmark-link>\n ), which I closed, and opened a new pull request (<denchmark-link:https://github.com/opencv/opencv/pull/15086>#15086</denchmark-link>\n ) as you suggested.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "dcouwenh", "commentT": "2019-07-19T15:57:30Z", "comment_text": "\n \t\tprobably relates: <denchmark-link:https://github.com/opencv/opencv/issues/5089>#5089</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "d3cf0d2c06009f5adf9aff094cf95233c61fa956", "commit_author": "dcouwenh", "commitT": "2019-07-30 23:49:46+03:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\imgproc\\perf\\perf_cvt_color.cpp", "file_new_name": "modules\\imgproc\\perf\\perf_cvt_color.cpp", "file_complexity": {"file_NLOC": "407", "file_CCN": "191", "file_NToken": "2866"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "420", "deleted_lines": "420", "method_info": {"method_name": "opencv_test::PERF_TEST_P", "method_params": "Size_CvtMode_Bayer,cvtColorBayer8u,Combine", "method_startline": "400", "method_endline": "421", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "140", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\imgproc\\src\\demosaicing.cpp", "file_new_name": "modules\\imgproc\\src\\demosaicing.cpp", "file_complexity": {"file_NLOC": "1250", "file_CCN": "186", "file_NToken": "13858"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1156,1163,1397,1398,1454", "deleted_lines": "1156,1163,1397,1398,1454", "method_info": {"method_name": "cv::Bayer2RGB_VNG_8u", "method_params": "srcmat,dstmat,code", "method_startline": "959", "method_endline": "1509", "method_complexity": {"method_NLOC": "405", "method_CCN": "44", "method_NToken": "5253", "method_nesting_level": "1"}}}}}}}}