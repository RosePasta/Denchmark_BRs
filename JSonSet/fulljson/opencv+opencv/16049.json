{"BR": {"BR_id": "16049", "BR_author": "vwvw", "BRopenT": "2019-12-03T14:44:10Z", "BRcloseT": "2020-01-28T16:24:20Z", "BR_text": {"BRsummary": "solvePnPGeneric Python Binding crash when reprojectionError is not passed as argument", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 4.1.2\n Operating System / Platform => Linux / Ubuntu 18.04\n Compiler => \u2754\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n When running the code below that call  from Python the program crashes because the C++ code expect a different type for   from the one passed by  by default. The argument is however <denchmark-link:https://docs.opencv.org/master/d9/d0c/group__calib3d.html#ga624af8a6641b9bdb487f63f694e8bb90>documented</denchmark-link>\n  as optional. Passing the argument with the correct type avoid the error.\n I suspect that the binding of the solvePnPGeneric function do not pass the correct argument type for reprojectionError by default.\n The error:\n Traceback (most recent call last):\n   File \"error.py\", line 15, in <module>\n     obj_points, img_points, cameraMatrix, distCoeffs #, reprojectionError=r\n cv2.error: OpenCV(4.1.2) /io/opencv/modules/calib3d/src/solvepnp.cpp:1017: error: (-2:Unspecified error) in function 'int cv::solvePnPGeneric(cv::InputArray, cv::InputArray, cv::InputArray, cv::InputArray, cv::OutputArrayOfArrays, cv::OutputArrayOfArrays, bool, cv::SolvePnPMethod, cv::InputArray, cv::InputArray, cv::OutputArray)'\n > Type of reprojectionError must be CV_32FC1 or CV_64FC1!:\n >     'type == CV_32FC1 || type == CV_64FC1'\n > where\n >     'reprojectionError.type()' is 0 (CV_8UC1)\n This might be closely linked to <denchmark-link:https://github.com/opencv/opencv/issues/16040>#16040</denchmark-link>\n  which is about Java binding of solvePnPGeneric\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n Run this code (OpenCV 4.1.2 / Python 3.6.8)\n import numpy as np\n import cv2\n \n obj_points = np.array([[0, 0, 0], [0, 1, 0], [1, 1, 0], [1, 0, 0]], dtype=np.float32)\n img_points = np.array(\n     [[700, 400], [700, 600], [900, 600], [900, 400]], dtype=np.float32\n )\n \n cameraMatrix = np.array(\n     [[712.0634, 0, 800], [0, 712.540, 500], [0, 0, 1]], dtype=np.float32\n )\n distCoeffs = np.array([[0, 0, 0, 0]], dtype=np.float32)\n #r = np.array([], dtype=np.float32)\n x, r, t, e = cv2.solvePnPGeneric(\n     obj_points, img_points, cameraMatrix, distCoeffs #, reprojectionError=r\n )\n print(e)\n print(t)\n The error can be bypassed by uncommenting the #r = np.array([], dtype=np.float32) lines.\n Thanks for the amazing work and happy to help or provide more information!\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "vwvw", "commentT": "2019-12-04T15:26:31Z", "comment_text": "\n \t\tPython bindings is not able to pass default value for \"OutputArray reprojectionError = noArray()\" parameter.\n Need to fix bindings generator. Corresponding test check is <denchmark-link:https://github.com/opencv/opencv/blob/3.4.8/modules/python/test/test_misc.py#L53>here</denchmark-link>\n  (commented out).\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "vwvw", "commentT": "2019-12-04T18:48:58Z", "comment_text": "\n \t\t\n Python bindings is not able to pass default value for \"OutputArray reprojectionError = noArray()\" parameter.\n \n i don't quite agree. i could reproduce it from c++:\n <denchmark-code>\tcv::Mat_<float> obj_points(4,3);   obj_points << 0, 0, 0,  0, 1, 0,  1, 1, 0,  1, 0, 0;\n \tcv::Mat_<float> img_points(4,2);   img_points << 700, 400,  700, 600,  900, 600,  900, 400;\n \tcv::Mat_<float> cameraMatrix(3,3); cameraMatrix << 712.0634, 0, 800,  0, 712.540, 500,  0, 0, 1;\n \tcv::Mat_<float> distCoeffs(1,4);   distCoeffs << 0, 0, 0, 0;\n \n \tMat rep; // this is the conflicting CV_8UC1 \n \tvector<Mat> rvecs,tvecs;\n         float r = cv::solvePnPGeneric( obj_points, img_points, cameraMatrix, distCoeffs, rvecs, tvecs, false, SOLVEPNP_UPNP, noArray(), noArray(), rep );\n \n </denchmark-code>\n \n leading to:\n <denchmark-code>>     'type == CV_32FC1 || type == CV_64FC1'\n > where\n >     'reprojectionError.type()' is 0 (CV_8UC1)\n ) in int cv::solvePnPGeneric(cv::InputArray, cv::InputArray, cv::InputArray, cv::InputArray, cv::OutputArrayOfArrays, cv::Output\n ArrayOfArrays, bool, cv::SolvePnPMethod, cv::InputArray, cv::InputArray, cv::OutputArray), file C:\\p\\opencv\\modules\\calib3d\\src\\\n solvepnp.cpp, line 1017\n </denchmark-code>\n \n it's the very same thing <denchmark-link:https://gist.github.com/berak/7dd8a872b5bc9cf9893f8a1bec9aa201#file-pyopencv_generated_funcs-h-L26>done in the python wrappers</denchmark-link>\n \n so let's look here:\n \n \n \n opencv/modules/calib3d/src/solvepnp.cpp\n \n \n         Lines 1012 to 1017\n       in\n       4c71dbf\n \n \n \n \n \n \n  if (reprojectionError.needed()) \n \n \n \n  { \n \n \n \n  int type = reprojectionError.type(); \n \n \n \n      reprojectionError.create(solutions, 1, type); \n \n \n \n  CV_CheckType(reprojectionError.type(), type == CV_32FC1 || type == CV_64FC1, \n \n \n \n  \"Type of reprojectionError must be CV_32FC1 or CV_64FC1!\"); \n \n \n \n \n \n the default noArray() won't trigger needed(), but once we pass (a ref to) an empty Mat, we get past that check and it creates the wrong type (still CV_8U).\n why not create a Mat of correct type / size like:\n <denchmark-code> reprojectionError.create(solutions, 1, CV_64FC1);\n </denchmark-code>\n \n and remove the type check / assertion ?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "vwvw", "commentT": "2019-12-04T19:05:27Z", "comment_text": "\n \t\tOutputArray param = noArray() is used in meaning of optional output parameter, which should be calculated only if requested. Calculation (which can be heavy) is guarded by .needed() check.\n Python bindings is not able to work with OutputArray directly. They using Mat and the problem is in that (bindings generator and wrappers should be fixed).\n However removal of type check can unlock calling of this function with empty Mat as OutputArray parameter:\n \n with 64F type by default?\n or max(_ipoint.depth(), _opoint.depth()) == CV_64F ? CV_64F : CV_32F\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "vwvw", "commentT": "2020-01-20T19:29:54Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  , can I look into this issue?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "vwvw", "commentT": "2020-01-20T20:17:57Z", "comment_text": "\n \t\tYou can try to unlock function for empty \"Mat\".\n Start from adding corresponding simple test (modules/calib3d/misc/python/test/test_solvepnp.py) - no need to check accuracy, just check that bindings work (non empty result of \"expected\" type).\n <denchmark-h:hr></denchmark-h>\n \n But please avoid part of issue about:\n \n OutputArray param = noArray()\n \n Mentor with strong Python bindings experience is required for this task.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "vwvw", "commentT": "2020-01-21T06:48:21Z", "comment_text": "\n \t\tSure <denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n , I'll do the following:\n \n Add test in modules/calib3d/misc/python/test/test_solvepnp.py\n Change this line \n \n \n opencv/modules/calib3d/src/solvepnp.cpp\n \n \n          Line 1015\n       in\n       4c71dbf\n \n \n \n \n \n \n  reprojectionError.create(solutions, 1, type); \n \n \n \n \n \n by adding max(_ipoint.depth(), _opoint.depth()) == CV_64F ? CV_64F : CV_32F for default type\n \n \t\t"}}}, "commit": {"commit_id": "504cd8a9f5c2fdf184fa1bb06550b3ce0b0ea4b8", "commit_author": "Ganesh Kathiresan", "commitT": "2020-01-23 15:23:03+03:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.8947368421052632", "commit_Nprams": "0.8947368421052632"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\calib3d\\misc\\python\\test\\test_solvepnp.py", "file_new_name": "modules\\calib3d\\misc\\python\\test\\test_solvepnp.py", "file_complexity": {"file_NLOC": "50", "file_CCN": "4", "file_NToken": "628"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60", "deleted_lines": null, "method_info": {"method_name": "test_regression_16049", "method_params": "self", "method_startline": "42", "method_endline": "60", "method_complexity": {"method_NLOC": "17", "method_CCN": "2", "method_NToken": "203", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\calib3d\\src\\solvepnp.cpp", "file_new_name": "modules\\calib3d\\src\\solvepnp.cpp", "file_complexity": {"file_NLOC": "776", "file_CCN": "166", "file_NToken": "7242"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1012,1013,1014,1015", "deleted_lines": "1012", "method_info": {"method_name": "cv::solvePnPGeneric", "method_params": "_opoints,_ipoints,_cameraMatrix,_distCoeffs,_rvecs,_tvecs,useExtrinsicGuess,flags,_rvec,_tvec,reprojectionError", "method_startline": "743", "method_endline": "1057", "method_complexity": {"method_NLOC": "245", "method_CCN": "61", "method_NToken": "2153", "method_nesting_level": "1"}}}}}}}}