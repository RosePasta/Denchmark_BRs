{"BR": {"BR_id": "8680", "BR_author": "cdcseacave", "BRopenT": "2017-05-01T09:00:41Z", "BRcloseT": "2017-05-23T10:46:03Z", "BR_text": {"BRsummary": "Mat::release() resets channels info for Mat_", "BRdescription": "\n In debug Mat::release() resets fixed info for Mat_ (pls see <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/core/include/opencv2/core/mat.inl.hpp#L780>https://github.com/opencv/opencv/blob/master/modules/core/include/opencv2/core/mat.inl.hpp#L780</denchmark-link>\n ).\n For instance if Mat_ is compiled with 3 channels, release() sets it to 1.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "cdcseacave", "commentT": "2017-05-01T09:25:05Z", "comment_text": "\n \t\tFix: overwrite Mat_::release()\n <denchmark-code>template<typename _Tp> inline\n void Mat_<_Tp>::release()\n {\n     Mat::release();\n #ifdef _DEBUG\n     flags = (flags & ~CV_MAT_TYPE_MASK) | DataType<_Tp>::type;\n #endif\n }\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "cdcseacave", "commentT": "2017-05-05T13:15:04Z", "comment_text": "\n \t\tCould you provide a PR with the proposed fix and a regression test?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "cdcseacave", "commentT": "2017-05-05T14:36:08Z", "comment_text": "\n \t\tMat has design of smart pointer with some cached fields (like cols, rows, type/flags) - so instead of \"m->obj.field_name\" we just write m.field_name.\n Why do you need to access to information fields of released Mat?\n This \"Mat\" is not attached to any \"object/data\" anymore, so there are no valid fields \"to cache\". I believe, we should raise error in these cases (like smart ptr, working with fields of m->obj is invalid, because obj is nullptr), but there is no way (in the current C++ design) to catch these cases, so these fields always return/contain something (\"garbage\" in the case of released Mat).\n Using of released fields is not a good practice and will lead to real errors (some problems are already fixed in OpenCV).\n BTW, release() is not a virtual method, so there are still some ways \"to break\" proposed patch (just to cast to regular Mat* and release it).\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "cdcseacave", "commentT": "2017-05-05T15:10:35Z", "comment_text": "\n \t\tI'll give you an example bellow that breaks OpenCV without this patch. But before that, pls explain following our logic above, why the channels returned by m.channels(); is different from immediately after constructing the matrix cv::Mat_<cv::Point2i> m; and after m.release(); (more exactly 2 !=1).\n Example:\n <denchmark-code>\tcv::Mat_<cv::Point2i> m;\n \tmat.release();\n \tm.channels(); // this line rises an assert at mat.inl.hpp line 1597\n </denchmark-code>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "cdcseacave", "commentT": "2017-05-05T22:33:28Z", "comment_text": "\n \t\tYou can use Mat.empty() or Mat_<T>.empty() to check whether the matrix is empty before use.\n The quirk that Mat_<T>.channels() returns one (1) (as opposed to the more widely accepted practice of returning zero (0)) is due to the way OpenCV encodes the numeric type and channel count into a 32-bit integer type code.\n \n \n \n opencv/modules/core/include/opencv2/core/mat.inl.hpp\n \n \n          Line 861\n       in\n       fe24165\n \n \n \n \n \n \n  int Mat::channels() const \n \n \n \n \n \n The CN macro simply don't have a way to encode a channel count of zero. (When the masked bits give a value of zero, that is interpreted as a channel count of 1; when the masked bits give 1, that's interpreted as 2, and so on.) Likewise, the DEPTH macro simply don't have a way to encode a matrix pixel format that is not one of the 8 predefined types.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "cdcseacave", "commentT": "2017-05-06T16:45:21Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/kinchungwong>@kinchungwong</denchmark-link>\n  nothing from your answer addresses the 2 points I made earlier\n <denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  pls review\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "cdcseacave", "commentT": "2017-05-06T22:40:48Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/cdcseacave>@cdcseacave</denchmark-link>\n  Sorry, I stand corrected.\n I would suggest the following \"criteria\" (or, line of reasoning) that tries to explain why your suggested fix is better than the existing code.\n Suppose a new Mat_<T> variable is created locally without allocating its data (i.e. it doesn't have a size). Suppose we have a different variable, that is allocated, and then released. After release, it is reasonable to expect that its properties (all getters), those that don't depend on the matrix being allocated, should compare equal between a default-constructed variable and a released variable.\n <denchmark-code>Mat_<cv::Vec2i> matOne;\n Mat_<cv::Vec2i> matTwo(cv::Size(1, 1));\n matTwo.release();\n assert(matOne.channels() == matTwo.channels()); \n // Assert not just channels(), but also every property that don't depend on whether the matrix is allocated.\n </denchmark-code>\n \n Don't get me wrong; I think your fix is good; I'm just searching for a rationale in support of the new code (as opposed to being seen as an unnecessary code change).\n The OpenCV API does require that, given a Mat_<cv::Vec2i> that doesn't have allocated data, that its type() method should still return CV_32SC2.\n \t\t"}}}, "commit": {"commit_id": "003745432f5f0168d869788fdc041fd04693bf68", "commit_author": "cDc", "commitT": "2017-05-23 12:19:57+03:00", "commit_complexity": {"commit_NLOC": "1.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "modules\\core\\include\\opencv2\\core\\mat.hpp", "file_new_name": "modules\\core\\include\\opencv2\\core\\mat.hpp", "file_complexity": {"file_NLOC": "1113", "file_CCN": "0", "file_NToken": "11671"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "2188,2189,2681,2684,2685", "deleted_lines": "2679,2682,2683"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\core\\include\\opencv2\\core\\mat.inl.hpp", "file_new_name": "modules\\core\\include\\opencv2\\core\\mat.inl.hpp", "file_complexity": {"file_NLOC": "3156", "file_CCN": "734", "file_NToken": "25607"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1629,1630,1631,1632,1633,1634,1635", "deleted_lines": null, "method_info": {"method_name": "cv::Mat_<_Tp>::release", "method_params": "", "method_startline": "1629", "method_endline": "1635", "method_complexity": {"method_NLOC": "5", "method_CCN": "2", "method_NToken": "31", "method_nesting_level": "1"}}}}}}}}