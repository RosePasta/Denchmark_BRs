{"BR": {"BR_id": "250", "BR_author": "gogasca", "BRopenT": "2018-09-14T17:36:44Z", "BRcloseT": "2018-10-24T03:16:01Z", "BR_text": {"BRsummary": "Movielens Error during preprocessing", "BRdescription": "\n Describe the bug\n When running preprocess\n I get:\n <denchmark-code>  File \"preprocess.py\", line 326, in <lambda>\n NameError: global name 'random' is not defined [while running 'TransformAndWriteTraining/Shuffle/PairWithRand']\n \n </denchmark-code>\n \n Running:\n <denchmark-code>python preprocess.py \n --input_dir \"${GCS_TRAINING_INPUT_DIR}\" \n --output_dir \"${PREPROCESS_OUTPUT}\"                      \n --percent_eval 20                      \n --project_id ${PROJECT}                      \n --negative_sample_ratio 1                      \n --negative_sample_label 0.0                      \n --eval_type ranking                      \n --eval_score_threshold 4.5                     \n  --num_ranking_candidate_movie_ids 1000                      \n --partition_random_seed 0                      \n --cloud\n </denchmark-code>\n \n Note: imports, functions and other variables defined in the global context of your  file of your Dataflow pipeline are, by default, not available in the worker execution environment, and such references will cause a NameError, unless the --save_main_session pipeline option is set to True. Please see <denchmark-link:https://cloud.google.com/dataflow/faq#how-do-i-handle-nameerrors>https://cloud.google.com/dataflow/faq#how-do-i-handle-nameerrors</denchmark-link>\n  for additional documentation on configuring your worker execution environment.\n What sample is this bug related to?\n Source code / logs\n In preprocess.py\n <denchmark-code># TODO: Perhaps use Reshuffle (https://issues.apache.org/jira/browse/BEAM-1872)?\n @beam.ptransform_fn\n def _Shuffle(pcoll):  # pylint: disable=invalid-name\n   \"\"\"Shuffles a PCollection.\"\"\"\n   return (pcoll\n           | 'PairWithRand' >> beam.Map(lambda x: (random.random(), x))\n           | 'GroupByRand' >> beam.GroupByKey()\n           | 'DropRand' >> beam.FlatMap(lambda (k, vs): vs))\n \n </denchmark-code>\n \n Based on:\n <denchmark-link:https://cloud.google.com/dataflow/faq#how-do-i-handle-nameerrors>https://cloud.google.com/dataflow/faq#how-do-i-handle-nameerrors</denchmark-link>\n \n We need to add import random in method.\n <denchmark-code># TODO: Perhaps use Reshuffle (https://issues.apache.org/jira/browse/BEAM-1872)?\n @beam.ptransform_fn\n def _Shuffle(pcoll):  # pylint: disable=invalid-name\n   \"\"\"Shuffles a PCollection.\"\"\"\n   import random\n   return (pcoll\n           | 'PairWithRand' >> beam.Map(lambda x: (random.random(), x))\n           | 'GroupByRand' >> beam.GroupByKey()\n           | 'DropRand' >> beam.FlatMap(lambda (k, vs): vs))\n </denchmark-code>\n \n \n Follow tutorial here <denchmark-link:https://github.com/GoogleCloudPlatform/cloudml-samples/tree/master/movielens>https://github.com/GoogleCloudPlatform/cloudml-samples/tree/master/movielens</denchmark-link>\n \n Expected behavior\n Run directly\n \t"}, "comments": {}}, "commit": {"commit_id": "bd44d9ed4ae722a0fd054d2589c54e6937eb2d12", "commit_author": "Gonzalo Gasca Meza", "commitT": "2018-09-19 18:18:54-07:00", "commit_complexity": {"commit_NLOC": "None", "commit_CCN": "None", "commit_Nprams": "None"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "movielens\\preprocess.py", "file_new_name": "movielens\\preprocess.py", "file_complexity": {"file_NLOC": "387", "file_CCN": "19", "file_NToken": "2191"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "325", "deleted_lines": null, "method_info": {"method_name": "_Shuffle", "method_params": "pcoll", "method_startline": "323", "method_endline": "329", "method_complexity": {"method_NLOC": "6", "method_CCN": "1", "method_NToken": "59", "method_nesting_level": "0"}}}}}}}}