{"BR": {"BR_id": "168", "BR_author": "zeyu-liu", "BRopenT": "2019-02-21T16:45:46Z", "BRcloseT": "2020-04-16T11:53:39Z", "BR_text": {"BRsummary": "Can not get the correct tensor input/output shape when use DynamicType", "BRdescription": "\n I used slice / reshape ops in my networks and as it shown in <denchmark-link:https://github.com/pytorch/pytorch/blob/94a95a0c7f3c38530a9cbc79932ea89ce092d1c2/torch/onnx/symbolic.py#L41>https://github.com/pytorch/pytorch/blob/94a95a0c7f3c38530a9cbc79932ea89ce092d1c2/torch/onnx/symbolic.py#L41</denchmark-link>\n  we can not get the actual properties of this tensor. This will be a problem to calculate MACs. As <denchmark-link:https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/apputils/model_summaries.py#L190>https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/apputils/model_summaries.py#L190</denchmark-link>\n  treats these tensor as empty tensor (shape is (0, )), it may cause exception when calculating the MACs and may mislead the pruning procedure.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "zeyu-liu", "commentT": "2019-02-21T16:50:26Z", "comment_text": "\n \t\tSome Exceptions occurred when applying pruning on this model:\n <denchmark-link:https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/apputils/model_summaries.py#L212>https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/apputils/model_summaries.py#L212</denchmark-link>\n \n and\n <denchmark-link:https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/examples/automated_deep_compression/ADC.py#L807>https://github.com/NervanaSystems/distiller/blob/ee1d160f75bd171d8f9b8afd17a65bcb0327a623/examples/automated_deep_compression/ADC.py#L807</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "zeyu-liu", "commentT": "2019-02-21T20:50:18Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/zeyu-liu>@zeyu-liu</denchmark-link>\n ,\n Can you provide a minimal example of a model which has these slice/reshape operations which cause the problem?  I would like to recreate it and see when the tensor shape == 0.\n Thanks\n Neta\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "zeyu-liu", "commentT": "2019-02-22T02:57:08Z", "comment_text": "\n \t\t\n Hi @zeyu-liu,\n Can you provide a minimal example of a model which has these slice/reshape operations which cause the problem? I would like to recreate it and see when the tensor shape == 0.\n Thanks\n Neta\n \n <denchmark-link:https://github.com/nzmora>@nzmora</denchmark-link>\n \n I used an implementation of ShuffleNet from <denchmark-link:https://github.com/ericsun99/Shufflenet-v2-Pytorch>here</denchmark-link>\n .\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "zeyu-liu", "commentT": "2019-02-28T11:37:21Z", "comment_text": "\n \t\t\n Hi @zeyu-liu,\n Can you provide a minimal example of a model which has these slice/reshape operations which cause the problem? I would like to recreate it and see when the tensor shape == 0.\n Thanks\n Neta\n \n Hi <denchmark-link:https://github.com/nzmora>@nzmora</denchmark-link>\n  ,\n Any updates?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "zeyu-liu", "commentT": "2019-03-02T22:49:58Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/zeyu-liu>@zeyu-liu</denchmark-link>\n ,\n Sorry for the delay and thanks for the details - I've recreated the issue.  In Distiller there are two ways to compute the MACs\n of convolutional layers:\n \n By traversing an ONNX representation of the model and using the sizes of Convolution operation inputs and outputs, which are extracted from the ONNX IR;\n By performing a forward pass on the PyTorch model and extracting the input/output sizes from the forward callback (code)\n \n As you pointed out (1) is broken when the model uses certain slice/reshape operations that translate to a tensor with an unknown size.\n Therefore, (1) should be removed and (2) should be integrated into <denchmark-link:https://github.com/NervanaSystems/distiller/blob/d556ac51d0c8a349097c5a7ed1f5c5eb32681405/distiller/summary_graph.py#L52>SummaryGraph</denchmark-link>\n .\n I'll add this to the project issues, but I don't know when we will get to fixing this.\n Cheers\n Neta\n \t\t"}}}, "commit": {"commit_id": "e62d0a24e70ed45c5cff53e626745b9bee6981b6", "commit_author": "Neta Zmora", "commitT": "2019-03-03 13:53:54+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "distiller\\summary_graph.py", "file_new_name": "distiller\\summary_graph.py", "file_complexity": {"file_NLOC": "264", "file_CCN": "103", "file_NToken": "2059"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "199,200,201,202,203,204,205,206,207", "deleted_lines": "199,200", "method_info": {"method_name": "add_macs_attr", "method_params": "self", "method_startline": "191", "method_endline": "214", "method_complexity": {"method_NLOC": "21", "method_CCN": "5", "method_NToken": "185", "method_nesting_level": "1"}}}}}}}}