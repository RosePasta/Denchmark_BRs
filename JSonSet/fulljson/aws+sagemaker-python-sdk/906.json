{"BR": {"BR_id": "906", "BR_author": "AnshumanRanjan", "BRopenT": "2019-07-05T17:08:35Z", "BRcloseT": "2019-09-09T17:49:06Z", "BR_text": {"BRsummary": "STS call on Session Object points to Global endpoint causing failure in case of Internet Disabled SageMaker notebooks", "BRdescription": "\n Please fill out the form below.\n <denchmark-h:h3>System Information</denchmark-h>\n \n \n Framework (e.g. TensorFlow) / Algorithm (e.g. KMeans):  All\n Framework Version: NA\n Python Version: NA\n CPU or GPU: NA\n Python SDK Version: NA\n Are you using a custom image: NA\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n methods on Session.py  <denchmark-link:https://github.com/aws/sagemaker-python-sdk/blob/master/src/sagemaker/session.py>(Session.py)</denchmark-link>\n \n get_execution_role()\n \n \n OR\n default_bucket()\n \n \n use a STS client which does not use regional endpoints which means except for newer regions all region , this calls <denchmark-link:https://sts.amazonaws.com>https://sts.amazonaws.com</denchmark-link>\n   instead of say <denchmark-link:https://sts.us-west-2.amazonaws.com>https://sts.us-west-2.amazonaws.com</denchmark-link>\n \n This usually is not a problem in normal cases , but with Internet disabled Notebooks using VPC endpoint this causes a issue  , as the global endpoint resolves to a Public IP and hence the above two methods would hang and timeout\n Due to implementation on boto3 side , even if you pass a region to the  boto client creation for sts it would still use the global endpoint . The only workaround is to pass a endpoint_url to the client passing the regional endpoint\n Example :\n <denchmark-code>import boto3\n s3 = boto3.client('sts',region='eu-west-1')\n s3.meta.endpoint_url\n 'https://sts.amazonaws.com'\n \n </denchmark-code>\n \n A way to fix this would be by doing :\n <denchmark-code>\n boto3.client(\n     \"sts\", \n     region_name=\"us-west-2\", \n     endpoint_url=\"https://sts.us-west-2.amazonaws.com\"\n )\n </denchmark-code>\n \n The  Boto3 issue that addresses this problem is listed : <denchmark-link:https://github.com/boto/boto3/issues/1859>boto/boto3#1859</denchmark-link>\n \n ###################################\n Currently I am  working around the get_execution_role() by overriding the session object with below chunk of code , obviously this can also be done by just passing the role arn as .fit seems to work regardless :\n <denchmark-code>import re\n from sagemaker.session import Session\n from sagemaker import get_execution_role\n region = Session().boto_region_name\n endpoint_url = \"https://sts.{}.amazonaws.com\".format(region)\n \n def get_execution_role_override(sagemaker_session=None):\n     if not sagemaker_session:\n         sagemaker_session = Session()\n     arn = sagemaker_session.get_caller_identity_arn()\n     if \":role/\" in arn:\n         return arn\n     \n def get_caller_identity_arn_override(self):\n \n         assumed_role = self.boto_session.client(\"sts\",region_name=region,endpoint_url=endpoint_url).get_caller_identity()[\"Arn\"]\n \n         if \"AmazonSageMaker-ExecutionRole\" in assumed_role:\n             role = re.sub(\n                 r\"^(.+)sts::(\\d+):assumed-role/(.+?)/.*$\",\n                 r\"\\1iam::\\2:role/service-role/\\3\",\n                 assumed_role,\n             )\n             return role\n \n         role = re.sub(r\"^(.+)sts::(\\d+):assumed-role/(.+?)/.*$\", r\"\\1iam::\\2:role/\\3\", assumed_role)\n \n         # Call IAM to get the role's path\n         role_name = role[role.rfind(\"/\") + 1 :]\n         try:\n             role = self.boto_session.client(\"iam\").get_role(RoleName=role_name)[\"Role\"][\"Arn\"]\n         except ClientError:\n             LOGGER.warning(\n                 \"Couldn't call 'get_role' to get Role ARN from role name {} to get Role path.\".format(\n                     role_name\n                 )\n             )\n \n         return role\n     \n \n Session.get_caller_identity_arn = get_caller_identity_arn_override\n role = get_execution_role_override()\n bucket = \"YOUR_BUCKET_NAME\"\n </denchmark-code>\n \n <denchmark-h:h3>Minimal repro / logs</denchmark-h>\n \n a) Create a Internet Disabled SageMaker Notebook\n b) Add sts VPC endpoint and also sagemaker.api VPC endpoint (also others if required like s3 and cloudwatch)\n c) Run any notebook  that calls any of the above function and it would hang\n d) From notebook terminal if you nslookup <denchmark-link:https://sts.amazonaws.com>https://sts.amazonaws.com</denchmark-link>\n  you would get a public IP and not a private IP as required by sts VPC endpoint .  But nslookup on <denchmark-link:https://sts.us-west-2.amazonaws.com>https://sts.us-west-2.amazonaws.com</denchmark-link>\n   would give you a private IP that would go through the STS endpoint\n Can you see if this is something that needs to be fixed on the SageMaker SDK or followed up on boto3\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AnshumanRanjan", "commentT": "2019-07-05T22:35:13Z", "comment_text": "\n \t\tRelated to <denchmark-link:https://github.com/aws/sagemaker-python-sdk/pull/802>#802</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "AnshumanRanjan", "commentT": "2019-07-09T23:44:29Z", "comment_text": "\n \t\tHello <denchmark-link:https://github.com/AnshumanRanjan>@AnshumanRanjan</denchmark-link>\n ,\n Thanks for bringing this to our attention. It looks like there is a PR that is supposed to allow us get around this issue, as mentioned by <denchmark-link:https://github.com/jmgray24>@jmgray24</denchmark-link>\n .\n <denchmark-link:https://github.com/jmgray24>@jmgray24</denchmark-link>\n  is that PR still a WIP or ready to be reviewed? Can you please update the correspondence in the PR?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "AnshumanRanjan", "commentT": "2019-09-06T20:23:53Z", "comment_text": "\n \t\tfixed in <denchmark-link:https://github.com/aws/sagemaker-python-sdk/pull/1026>#1026</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "AnshumanRanjan", "commentT": "2019-09-09T17:49:06Z", "comment_text": "\n \t\tPR has been released: <denchmark-link:https://github.com/aws/sagemaker-python-sdk/blob/master/CHANGELOG.md#v1390-2019-09-09>https://github.com/aws/sagemaker-python-sdk/blob/master/CHANGELOG.md#v1390-2019-09-09</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "228a81d9d70a78ea3de101fa08602258b1586a5a", "commit_author": "Lauren Yu", "commitT": "2019-09-05 17:32:44-07:00", "commit_complexity": {"commit_NLOC": "0.8823529411764706", "commit_CCN": "1.0", "commit_Nprams": "1.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sagemaker\\session.py", "file_new_name": "src\\sagemaker\\session.py", "file_complexity": {"file_NLOC": "964", "file_CCN": "104", "file_NToken": "5210"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1381,1383,1385,1386,1387", "deleted_lines": "1381,1383", "method_info": {"method_name": "get_caller_identity_arn", "method_params": "self", "method_startline": "1379", "method_endline": "1409", "method_complexity": {"method_NLOC": "21", "method_CCN": "3", "method_NToken": "121", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sagemaker\\utils.py", "file_new_name": "src\\sagemaker\\utils.py", "file_complexity": {"file_NLOC": "244", "file_CCN": "60", "file_NToken": "1710"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556", "deleted_lines": null, "method_info": {"method_name": "sts_regional_endpoint", "method_params": "region", "method_startline": "541", "method_endline": "556", "method_complexity": {"method_NLOC": "2", "method_CCN": "1", "method_NToken": "13", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tests\\unit\\test_session.py", "file_new_name": "tests\\unit\\test_session.py", "file_complexity": {"file_NLOC": "1084", "file_CCN": "76", "file_NToken": "6183"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "356,357,358", "deleted_lines": null, "method_info": {"method_name": "sagemaker_session", "method_params": "", "method_startline": "354", "method_endline": "361", "method_complexity": {"method_NLOC": "8", "method_CCN": "1", "method_NToken": "60", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "120,121,122", "deleted_lines": "115,127", "method_info": {"method_name": "test_get_caller_identity_arn_from_a_role", "method_params": "boto_session", "method_startline": "115", "method_endline": "128", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "74", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "104,105,106", "deleted_lines": "101", "method_info": {"method_name": "test_get_caller_identity_arn_from_an_user_without_permissions", "method_params": "boto_session", "method_startline": "101", "method_endline": "112", "method_complexity": {"method_NLOC": "11", "method_CCN": "1", "method_NToken": "81", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "150", "deleted_lines": null, "method_info": {"method_name": "test_get_caller_identity_arn_from_role_with_path", "method_params": "boto_session", "method_startline": "146", "method_endline": "159", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "98", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "134,135,136", "deleted_lines": "141", "method_info": {"method_name": "test_get_caller_identity_arn_from_a_execution_role", "method_params": "boto_session", "method_startline": "131", "method_endline": "143", "method_complexity": {"method_NLOC": "12", "method_CCN": "1", "method_NToken": "71", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "92,93,94", "deleted_lines": "91", "method_info": {"method_name": "test_get_caller_identity_arn_from_an_user", "method_params": "boto_session", "method_startline": "89", "method_endline": "98", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "69", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\unit\\test_utils.py", "file_new_name": "tests\\unit\\test_utils.py", "file_complexity": {"file_NLOC": "402", "file_CCN": "55", "file_NToken": "2618"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "565,566,567", "deleted_lines": null, "method_info": {"method_name": "test_sts_regional_endpoint", "method_params": "", "method_startline": "565", "method_endline": "567", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "18", "method_nesting_level": "0"}}}}}}}}