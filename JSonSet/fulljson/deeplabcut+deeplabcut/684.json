{"BR": {"BR_id": "684", "BR_author": "AntoineCribel", "BRopenT": "2020-05-14T16:32:06Z", "BRcloseT": "2020-05-17T00:51:46Z", "BR_text": {"BRsummary": "Labels of the markers are mixed when evaluating/tracking (after adding new labels to config.yaml)", "BRdescription": "\n Describe the bug\n After training the network (resnet_50), evaluating it and analyzing videos, I get markers that seems to be correctly placed but with wrong labels (they seems to be mixed randomly). This happened after that I added new label names in the config file and (re)labeled previous and new videos.\n I tried a number of things:\n \n I made sure every one of the \"old\" videos were updated with the new labels\n I checked every labeled images with deeplabcut.check_labels (everything looks good)\n making a new dlc project from scratch and copy pasting inside only the labeled-data folder\n deeplabcut.dropannotationfileentriesduetodeletedimages\n I checked if coordinates/labels were mixed in the CollectedData_.csv in the training dataset, but I couldn't find anything wrong, however I noticed that it is using the same labels order than the CollectedData_.csv of the first labeled video which is different than the order in my config.yaml\n \n Indeed I also noticed that the order of the label names (in the column) in the .csv files of each labeled video is not always the same. This is because I added new labels and changed the order of the labels in my config file. Is it possible that deeplabcut get confused by that and use the wrong order for the labels?\n To Reproduce\n Steps to reproduce the behavior:\n \n Start labeling some videos (at this point the training and evaluating worked well)\n Change the order of the labels in the config.yaml\n Label more videos (I thinks it was still working at this point, but I am not sure)\n Add new label names in the config.yaml\n Relabel the previously labeled videos (to add the new labels)\n Label more videos\n Train the network + evaluate\n The marker's labels should be mixed\n \n Expected behavior\n Not getting mixed labels ^^\n Desktop:\n \n Ubuntu Mate 18.04\n DeepLabCut 2.1.7\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AntoineCribel", "commentT": "2020-05-15T02:41:19Z", "comment_text": "\n \t\twe will look into it, thanks!\n quick Q: \"Train the network + evaluate\" <-- did you reload the previous weights or use \"fresh weights\"? Just asking to help us debug.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "AntoineCribel", "commentT": "2020-05-15T06:05:30Z", "comment_text": "\n \t\tI used fresh weights (I manually deleted the trained networks in the dlc_model folder).\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "AntoineCribel", "commentT": "2020-05-15T10:07:34Z", "comment_text": "\n \t\tAnother thing, I tried removing the folders in  labeled-data that had a CollectedData_.csv with the wrong order of label names. That solved the issue of the mixed labels after training and evaluating.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "AntoineCribel", "commentT": "2020-05-16T19:36:13Z", "comment_text": "\n \t\tThis can indeed, in certain situation be wrong. We have a fix now. Will be released soon.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "AntoineCribel", "commentT": "2020-05-16T20:08:25Z", "comment_text": "\n \t\tI tried reordering the label names in the CollectedData_.csv of all labeled videos (with following script), it solved my problem.\n \n import pandas as pd\n from glob import glob\n import deeplabcut as dlc\n path_labels = \"path_labeled-data_folder\"\n path_cfg = \"path_config.yaml\"\n path_labels = glob(path_labels + '*')\n label_names_commas = 'copy/past 2nd ligne of a correct CollectedData_.csv (should be something like: 'bodyparts,mouth,mouth,tail,tail)'\n coord_names_commas = 'copy/past 3nd ligne of a correct CollectedData_.csv (should be something like: coords,x,y,x,y)'\n label_names = label_names_commas.split(',')\n coord_names = coord_names_commas.split(',')\n label_keys = pd.MultiIndex.from_tuples(zip(label_names, coord_names))\n for p in path_labels:\n path_csv = glob(p + '/CollectedData_*.csv')\n for c in path_csv:\n     header = list(pd.read_csv(c, header=None).loc[0])\n \n     df = pd.read_csv(c, header=[1, 2])\n     df_reorder = df[label_keys]  # rearrange column here\n     df_reorder.columns = pd.MultiIndex.from_tuples(zip(header, label_names, coord_names))\n     df_reorder.to_csv(c, index=False)\n \n dlc.convertcsv2h5(path_cfg, userfeedback=False)\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "AntoineCribel", "commentT": "2020-05-16T20:23:58Z", "comment_text": "\n \t\tThat makes sense, in the future this should no longer be necessary with DLC 2.1.8 :)\n Just did more testing, while shuffling wildly. Now, I can no longer get such errors!\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "AntoineCribel", "commentT": "2020-05-17T00:51:46Z", "comment_text": "\n \t\tfixed; pip install deeplabcut==2.1.8\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "AntoineCribel", "commentT": "2020-05-17T07:24:15Z", "comment_text": "\n \t\tGreat!! Thank you very much!\n \t\t"}}}, "commit": {"commit_id": "cf529ed07c570ef7d40e7c2d5d88e4221585e046", "commit_author": "Alexander Mathis", "commitT": "2020-05-16 14:51:22-04:00", "commit_complexity": {"commit_NLOC": "0.4", "commit_CCN": "0.4", "commit_Nprams": "0.4"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplabcut\\generate_training_dataset\\labeling_toolbox.py", "file_new_name": "deeplabcut\\generate_training_dataset\\labeling_toolbox.py", "file_complexity": {"file_NLOC": "535", "file_CCN": "90", "file_NToken": "6183"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "678,679", "deleted_lines": null, "method_info": {"method_name": "saveDataSet", "method_params": "self,event", "method_startline": "669", "method_endline": "681", "method_complexity": {"method_NLOC": "9", "method_CCN": "1", "method_NToken": "131", "method_nesting_level": "1"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplabcut\\generate_training_dataset\\trainingsetmanipulation.py", "file_new_name": "deeplabcut\\generate_training_dataset\\trainingsetmanipulation.py", "file_complexity": {"file_NLOC": "449", "file_CCN": "104", "file_NToken": "4237"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "393,394,398,400,401,403,405,407,408,409,410,411,412,413,414,415,416,417,418,422,424,425,426,429", "deleted_lines": "393,394,399,400,401,402,403,404,406,408,410,411,412,413,414,415,420,423", "method_info": {"method_name": "merge_annotateddatasets", "method_params": "cfg,project_path,trainingsetfolder_full,windows2linux", "method_startline": "386", "method_endline": "439", "method_complexity": {"method_NLOC": "38", "method_CCN": "13", "method_NToken": "292", "method_nesting_level": "0"}}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplabcut\\pose_estimation_tensorflow\\evaluate.py", "file_new_name": "deeplabcut\\pose_estimation_tensorflow\\evaluate.py", "file_complexity": {"file_NLOC": "243", "file_CCN": "49", "file_NToken": "2846"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "365,393", "deleted_lines": "365,393", "method_info": {"method_name": "evaluate_network", "method_params": "config,Shuffles,trainingsetindex,plotting,show_errors,comparisonbodyparts,gputouse,rescale", "method_startline": "182", "method_endline": "406", "method_complexity": {"method_NLOC": "122", "method_CCN": "26", "method_NToken": "1465", "method_nesting_level": "0"}}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplabcut\\utils\\auxiliaryfunctions.py", "file_new_name": "deeplabcut\\utils\\auxiliaryfunctions.py", "file_complexity": {"file_NLOC": "380", "file_CCN": "99", "file_NToken": "2649"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "338,339,340,342,343,344,345", "deleted_lines": "338,339,340,342,343,344", "method_info": {"method_name": "IntersectionofBodyPartsandOnesGivenbyUser", "method_params": "cfg,comparisonbodyparts", "method_startline": "336", "method_endline": "347", "method_complexity": {"method_NLOC": "10", "method_CCN": "4", "method_NToken": "45", "method_nesting_level": "0"}}}}}}}}