{"BR": {"BR_id": "1504", "BR_author": "vishalbollu", "BRopenT": "2020-10-28T22:11:48Z", "BRcloseT": "2020-12-22T01:46:56Z", "BR_text": {"BRsummary": "Submitted job is stuck in running state", "BRdescription": "\n <denchmark-h:h4>Version</denchmark-h>\n \n <= 0.21.0\n <denchmark-h:h4>Description</denchmark-h>\n \n A job gets stuck in the running status. It is possible that this happens when a worker is terminated abruptly in scenarios such as the spot instance being taken away.\n <denchmark-h:h4>Steps to reproduce (not yet confirmed)</denchmark-h>\n \n \n Submit a Job with a long running task\n Terminate the node in AWS console (to simulate abrupt worker termination)\n \n <denchmark-h:h4>Expected behaviour</denchmark-h>\n \n Once the worker is ready, the worker should take items from the queue\n <denchmark-h:h4>Actual behaviour</denchmark-h>\n \n After the new worker has spun up, it looks for items in the queue, finds that it is empty and then terminates.\n <denchmark-h:h4>Suggested solution</denchmark-h>\n \n If the error is related to the worker not being able to find a message after being killed abruptly, a potential solution can be to update the way the worker receives the message. Currently each message from the SQS is owned for 12 hours (the maximum visibility). When a message is received, set the message visibility for a short period of time (1 minute) and renew the message visibility in a background thread. When the message has been processed or an error has occurred delete the message and stop the renewing message visibility thread.\n <denchmark-h:h4>Additional context</denchmark-h>\n \n The situation might be ameliorated by <denchmark-link:https://github.com/cortexlabs/cortex/issues/927>#927</denchmark-link>\n .\n \t"}, "comments": {}}, "commit": {"commit_id": "202749a710fc0fa3c21cd6f864f126f876729d05", "commit_author": "Andrei Lapanik", "commitT": "2020-12-21 20:44:28-05:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.5934065934065934", "commit_Nprams": "0.5714285714285714"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "cli\\cmd\\lib_batch_apis.go", "file_new_name": "cli\\cmd\\lib_batch_apis.go", "file_complexity": {"file_NLOC": "207", "file_CCN": "22", "file_NToken": "1290"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "124", "deleted_lines": "124", "method_info": {"method_name": "batchAPITable", "method_params": "APIResponse", "method_startline": "84", "method_endline": "145", "method_complexity": {"method_NLOC": "50", "method_CCN": "6", "method_NToken": "318", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "203", "deleted_lines": "203", "method_info": {"method_name": "getJob", "method_params": "Environment,string,string", "method_startline": "147", "method_endline": "264", "method_complexity": {"method_NLOC": "100", "method_CCN": "11", "method_NToken": "717", "method_nesting_level": "0"}}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\workloads\\batch\\endpoints.md", "file_new_name": "docs\\workloads\\batch\\endpoints.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "36,37,38,39,61,62,63,64,87,88,89,90,111,112,113,114,136,137,138,139,160,161,162,163,190,191", "deleted_lines": "166,167"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\workloads\\batch\\example.md", "file_new_name": "docs\\workloads\\batch\\example.md", "file_complexity": {"file_NLOC": "None", "file_CCN": "None", "file_NToken": "None"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "8,9", "deleted_lines": "8"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "pkg\\cortex\\serve\\start\\batch.py", "file_new_name": "pkg\\cortex\\serve\\start\\batch.py", "file_complexity": {"file_NLOC": "254", "file_CCN": "41", "file_NToken": "1575"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,261,262,263,264,265,266,267,268,269,270,271,272,273", "deleted_lines": null, "method_info": {"method_name": "handle_on_job_complete", "method_params": "message", "method_startline": "233", "method_endline": "274", "method_complexity": {"method_NLOC": "41", "method_CCN": "7", "method_NToken": "218", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "105,106,107,108,109,110,111,112", "deleted_lines": "105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145", "method_info": {"method_name": "handle_on_complete", "method_params": "message", "method_startline": "105", "method_endline": "145", "method_complexity": {"method_NLOC": "32", "method_CCN": "8", "method_NToken": "167", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "162,163,168,169,170,171,172,175,176,178,179,182,183,184,185,186,187,188,189,190", "deleted_lines": "162,163,168,169,170,171,173,174,175,177,181,182,183,184,185,187,188,189,190", "method_info": {"method_name": "sqs_loop", "method_params": "", "method_startline": "148", "method_endline": "190", "method_complexity": {"method_NLOC": "35", "method_CCN": "7", "method_NToken": "185", "method_nesting_level": "0"}}}, "hunk_3": {"Ismethod": 1, "added_lines": "79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110", "deleted_lines": "105,106,107,108,109,110", "method_info": {"method_name": "renew_message_visibility", "method_params": "str", "method_startline": "79", "method_endline": "110", "method_complexity": {"method_NLOC": "27", "method_CCN": "6", "method_NToken": "144", "method_nesting_level": "0"}}}, "hunk_4": {"Ismethod": 1, "added_lines": "193,194", "deleted_lines": "193,194", "method_info": {"method_name": "is_on_job_complete", "method_params": "message", "method_startline": "193", "method_endline": "194", "method_complexity": {"method_NLOC": "2", "method_CCN": "2", "method_NToken": "18", "method_nesting_level": "0"}}}, "hunk_5": {"Ismethod": 1, "added_lines": "197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230", "deleted_lines": "197,198,199,200,201,202,203,204,205,206,207", "method_info": {"method_name": "handle_batch_message", "method_params": "message", "method_startline": "197", "method_endline": "230", "method_complexity": {"method_NLOC": "31", "method_CCN": "3", "method_NToken": "203", "method_nesting_level": "0"}}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pkg\\operator\\resources\\batchapi\\batch_enqueuer.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\batch_enqueuer.go", "file_complexity": {"file_NLOC": "92", "file_CCN": "13", "file_NToken": "537"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "70", "deleted_lines": null, "method_info": {"method_name": "AddToBatch", "method_params": "string,string", "method_startline": "64", "method_endline": "89", "method_complexity": {"method_NLOC": "23", "method_CCN": "5", "method_NToken": "163", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "44,45,46,47,48", "deleted_lines": "42", "method_info": {"method_name": "newSQSBatchUploader", "method_params": "string", "method_startline": "42", "method_endline": "48", "method_complexity": {"method_NLOC": "7", "method_CCN": "1", "method_NToken": "33", "method_nesting_level": "0"}}}, "hunk_2": {"Ismethod": 1, "added_lines": "44,45,46,47,48,49,50,51,52,53,54,55,57", "deleted_lines": null, "method_info": {"method_name": "newSQSBatchUploader", "method_params": "string,JobKey", "method_startline": "44", "method_endline": "62", "method_complexity": {"method_NLOC": "18", "method_CCN": "1", "method_NToken": "104", "method_nesting_level": "0"}}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\operator\\resources\\batchapi\\enqueue.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\enqueue.go", "file_complexity": {"file_NLOC": "275", "file_CCN": "28", "file_NToken": "1821"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "123", "deleted_lines": "115,154", "method_info": {"method_name": "enqueueItems", "method_params": "Job,ItemList", "method_startline": "115", "method_endline": "158", "method_complexity": {"method_NLOC": "37", "method_CCN": "10", "method_NToken": "334", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "162", "deleted_lines": null, "method_info": {"method_name": "enqueueS3Paths", "method_params": "Job,FilePathLister", "method_startline": "160", "method_endline": "199", "method_complexity": {"method_NLOC": "19", "method_CCN": "5", "method_NToken": "109", "method_nesting_level": "0"}}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\batchapi\\job.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\job.go", "file_complexity": {"file_NLOC": "212", "file_CCN": "40", "file_NToken": "1187"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "91", "deleted_lines": "91", "method_info": {"method_name": "SubmitJob", "method_params": "string,JobSubmission", "method_startline": "60", "method_endline": "133", "method_complexity": {"method_NLOC": "60", "method_CCN": "9", "method_NToken": "317", "method_nesting_level": "0"}}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\operator\\resources\\batchapi\\manage_resources_cron.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\manage_resources_cron.go", "file_complexity": {"file_NLOC": "297", "file_CCN": "63", "file_NToken": "1722"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "58,60,141,156,159,225,227", "deleted_lines": "58,60,141,156,159,225,227", "method_info": {"method_name": "ManageJobResources", "method_params": "", "method_startline": "46", "method_endline": "232", "method_complexity": {"method_NLOC": "154", "method_CCN": "35", "method_NToken": "861", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "282,283,284,285,286,287,288,290,305,306,307,309,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,333,334,335,336", "deleted_lines": "282,283,284,286,287,302,303,304,306,311,312,313,314,315,316,317,318,319,320,321,322,323,326,327", "method_info": {"method_name": "checkIfJobCompleted", "method_params": "JobKey,string,Job", "method_startline": "269", "method_endline": "339", "method_complexity": {"method_NLOC": "58", "method_CCN": "12", "method_NToken": "301", "method_nesting_level": "0"}}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\operator\\resources\\batchapi\\queue.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\queue.go", "file_complexity": {"file_NLOC": "124", "file_CCN": "26", "file_NToken": "784"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "66,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87", "deleted_lines": "65,74,75,76,77,78,79", "method_info": {"method_name": "createFIFOQueue", "method_params": "JobKey,string", "method_startline": "65", "method_endline": "87", "method_complexity": {"method_NLOC": "20", "method_CCN": "3", "method_NToken": "142", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "66,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,94,95,96", "deleted_lines": "74,75,76,77,78,79", "method_info": {"method_name": "createFIFOQueue", "method_params": "JobKey,SQSDeadLetterQueue,string", "method_startline": "66", "method_endline": "104", "method_complexity": {"method_NLOC": "32", "method_CCN": "5", "method_NToken": "212", "method_nesting_level": "0"}}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\batchapi\\validations.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\validations.go", "file_complexity": {"file_NLOC": "139", "file_CCN": "44", "file_NToken": "938"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "87,88,89,90,91,92,93,94,95", "deleted_lines": null, "method_info": {"method_name": "validateJobSubmissionSchema", "method_params": "JobSubmission", "method_startline": "31", "method_endline": "97", "method_complexity": {"method_NLOC": "56", "method_CCN": "21", "method_NToken": "457", "method_nesting_level": "0"}}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pkg\\operator\\schema\\config_key.go", "file_new_name": "pkg\\operator\\schema\\config_key.go", "file_complexity": {"file_NLOC": "16", "file_CCN": "0", "file_NToken": "44"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "21,22,23,24,25,26,27,28,29,30,31,32,33", "deleted_lines": "21,22,23,24,25,26,27,28,29,30"}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\types\\metrics\\batch_metrics.go", "file_new_name": "pkg\\types\\metrics\\batch_metrics.go", "file_complexity": {"file_NLOC": "17", "file_CCN": "2", "file_NToken": "118"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "25,26,27", "method_info": {"method_name": "TotalCompleted", "method_params": "", "method_startline": "25", "method_endline": "27", "method_complexity": {"method_NLOC": "3", "method_CCN": "1", "method_NToken": "19", "method_nesting_level": "0"}}}, "hunk_1": {"Ismethod": 1, "added_lines": "33", "deleted_lines": null, "method_info": {"method_name": "MergeInPlace", "method_params": "BatchMetrics", "method_startline": "32", "method_endline": "36", "method_complexity": {"method_NLOC": "5", "method_CCN": "1", "method_NToken": "57", "method_nesting_level": "0"}}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pkg\\types\\spec\\job_spec.go", "file_new_name": "pkg\\types\\spec\\job_spec.go", "file_complexity": {"file_NLOC": "48", "file_CCN": "5", "file_NToken": "286"}, "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "52,53,54,55,56,58,59,60,61", "deleted_lines": "53,54,55"}}}}}}