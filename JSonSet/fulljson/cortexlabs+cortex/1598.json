{"BR": {"BR_id": "1598", "BR_author": "RobertLucian", "BRopenT": "2020-11-24T23:35:26Z", "BRcloseT": "2020-12-08T19:32:35Z", "BR_text": {"BRsummary": "API tries to download local model from S3 (for TensorFlow, MMC)", "BRdescription": "\n <denchmark-h:h4>Version</denchmark-h>\n \n >= 0.22\n <denchmark-h:h4>Description</denchmark-h>\n \n For the following set of conditions, a local model cannot be loaded:\n \n For TensorFlow predictor type (Realtime kind)\n MMC is enabled\n Local model is specified\n \n <denchmark-h:h4>Steps to reproduce</denchmark-h>\n \n Add a local model to an example such as <denchmark-link:https://github.com/cortexlabs/cortex/tree/master/examples/model-caching/tensorflow/multi-model-classifier>https://github.com/cortexlabs/cortex/tree/master/examples/model-caching/tensorflow/multi-model-classifier</denchmark-link>\n  and then run a prediction on the said model.\n <denchmark-h:h4>Expected behavior</denchmark-h>\n \n Should actually load the model from disk.\n <denchmark-h:h4>Actual behavior</denchmark-h>\n \n It attempts to download the said local model from the S3 upstream.\n <denchmark-h:h4>Stack traces</denchmark-h>\n \n (error output from cortex logs <api name>)\n <denchmark-code>2020-11-24 23:21:25.743322:cortex:pid-229:INFO:200 OK POST /\n 2020-11-24 23:21:34.540678:cortex:pid-229:INFO:grabbing access to model local-resnet50 of version 1\n 2020-11-24 23:21:34.540978:cortex:pid-229:INFO:model local-resnet50 of version 1 is available\n 2020-11-24 23:21:34.541159:cortex:pid-229:INFO:checking the local-resnet50 1 status\n 2020-11-24 23:21:34.541252:cortex:pid-229:INFO:model local-resnet50 of version 1 is not loaded (with status not-available or different timestamp)\n 2020-11-24 23:21:34.541384:cortex:pid-229:INFO:downloading model local-resnet50 of version 1 from the S3 upstream\n 2020-11-24 23:21:34.541471:cortex:pid-229:INFO:downloading from bucket //mnt/model/local-resnet50/1, model local-resnet50 of version 1, temporarily to /tmp/cron and then finally to /mnt/model\n 2020-11-24 23:21:34.552484:cortex:pid-229:INFO:500 Internal Server Error POST /\n 2020-11-24 23:21:34.552773:cortex:pid-229:ERROR:Exception in ASGI application\n Traceback (most recent call last):\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/uvicorn/protocols/http/httptools_impl.py\", line 390, in run_asgi\n     result = await app(self.scope, self.receive, self.send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/uvicorn/middleware/proxy_headers.py\", line 45, in __call__\n     return await self.app(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/fastapi/applications.py\", line 181, in __call__\n     await super().__call__(scope, receive, send)  # pragma: no cover\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/applications.py\", line 111, in __call__\n     await self.middleware_stack(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/errors.py\", line 181, in __call__\n     raise exc from None\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/errors.py\", line 159, in __call__\n     await self.app(scope, receive, _send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 25, in __call__\n     response = await self.dispatch_func(request, self.call_next)\n   File \"/src/cortex/serve/serve.py\", line 176, in parse_payload\n     return await call_next(request)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 45, in call_next\n     task.result()\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 38, in coro\n     await self.app(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 25, in __call__\n     response = await self.dispatch_func(request, self.call_next)\n   File \"/src/cortex/serve/serve.py\", line 133, in register_request\n     response = await call_next(request)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 45, in call_next\n     task.result()\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/middleware/base.py\", line 38, in coro\n     await self.app(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/exceptions.py\", line 82, in __call__\n     raise exc from None\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/exceptions.py\", line 71, in __call__\n     await self.app(scope, receive, sender)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/routing.py\", line 566, in __call__\n     await route.handle(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/routing.py\", line 227, in handle\n     await self.app(scope, receive, send)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/routing.py\", line 41, in app\n     response = await func(request)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/fastapi/routing.py\", line 183, in app\n     dependant=dependant, values=values, is_coroutine=is_coroutine\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/fastapi/routing.py\", line 135, in run_endpoint_function\n     return await run_in_threadpool(dependant.call, **values)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/starlette/concurrency.py\", line 34, in run_in_threadpool\n     return await loop.run_in_executor(None, func, *args)\n   File \"/opt/conda/envs/env/lib/python3.6/concurrent/futures/thread.py\", line 56, in run\n     result = self.fn(*self.args, **self.kwargs)\n   File \"/src/cortex/serve/serve.py\", line 185, in predict\n     prediction = predictor_impl.predict(**kwargs)\n   File \"/mnt/project/predictor.py\", line 44, in predict\n     predicted_label = self.predict_image_classifier(model_name, payload[\"url\"])\n   File \"/mnt/project/predictor.py\", line 57, in predict_image_classifier\n     results = self.client.predict(img, model)[self.config[model][\"output_key\"]]\n   File \"/src/cortex/lib/client/tensorflow.py\", line 126, in predict\n     return self._run_inference(model_input, model_name, model_version)\n   File \"/src/cortex/lib/client/tensorflow.py\", line 287, in _run_inference\n     upstream_model[\"path\"],\n   File \"/src/cortex/lib/model/model.py\", line 352, in download_model\n     self._model_dir,\n   File \"/src/cortex/lib/api/predictor.py\", line 529, in model_downloader\n     sub_paths, ts = s3_client.search(model_path)\n   File \"/src/cortex/lib/storage/s3.py\", line 151, in search\n     for key, ts in self._get_matching_s3_keys_generator(prefix, suffix):\n   File \"/src/cortex/lib/storage/s3.py\", line 106, in _get_matching_s3_keys_generator\n     for obj in self._get_matching_s3_objects_generator(prefix, suffix):\n   File \"/src/cortex/lib/storage/s3.py\", line 89, in _get_matching_s3_objects_generator\n     resp = self.s3.list_objects_v2(**kwargs)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/client.py\", line 337, in _api_call\n     return self._make_api_call(operation_name, kwargs)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/client.py\", line 629, in _make_api_call\n     api_params, operation_model, context=request_context)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/client.py\", line 675, in _convert_to_request_dict\n     api_params, operation_model, context)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/client.py\", line 707, in _emit_api_params\n     params=api_params, model=operation_model, context=context)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/hooks.py\", line 356, in emit\n     return self._emitter.emit(aliased_event_name, **kwargs)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/hooks.py\", line 228, in emit\n     return self._emit(event_name, kwargs)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/hooks.py\", line 211, in _emit\n     response = handler(**kwargs)\n   File \"/opt/conda/envs/env/lib/python3.6/site-packages/botocore/handlers.py\", line 205, in validate_bucket_name\n     raise ParamValidationError(report=error_msg)\n botocore.exceptions.ParamValidationError: Parameter validation failed:\n Invalid bucket name \"\": Bucket name must match the regex \"^[a-zA-Z0-9.\\-_]{1,255}$\" or be an ARN matching the regex \"^arn:(aws).*:s3:[a-z\\-0-9]+:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\\-]{1,63}$\"\n </denchmark-code>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "1689ab638a4abaf134b3bd6286c40a3e9ee7fef1", "commit_author": "Robert Lucian Chiriac", "commitT": "2020-12-08 21:32:34+02:00", "commit_complexity": {"commit_NLOC": "0.0", "commit_CCN": "0.0", "commit_Nprams": "0.0"}, "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\workloads\\cortex\\lib\\client\\tensorflow.py", "file_new_name": "pkg\\workloads\\cortex\\lib\\client\\tensorflow.py", "file_complexity": {"file_NLOC": "384", "file_CCN": "48", "file_NToken": "1575"}, "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "280,281,282,283,284,285,286,287,288,289,290,291,292,293", "deleted_lines": "280,281,282,283,284,285,286,287,288,289,290,291,292", "method_info": {"method_name": "_run_inference", "method_params": "self,Any,str,str", "method_startline": "128", "method_endline": "321", "method_complexity": {"method_NLOC": "152", "method_CCN": "31", "method_NToken": "777", "method_nesting_level": "1"}}}}}}}}