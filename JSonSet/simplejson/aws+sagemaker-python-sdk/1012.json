{"BR": {"BR_id": "1012", "BR_author": "atibaup", "BRopenT": "2019-08-30T13:06:33Z", "BRcloseT": "2019-09-10T17:45:08Z", "BR_text": {"BRsummary": "Error when deploying custom model via `MXNetModel.deploy`", "BRdescription": "\n <denchmark-h:h3>System Information</denchmark-h>\n \n \n Framework (e.g. TensorFlow) / Algorithm (e.g. KMeans): MXNet / MXNetModel\n Framework Version: 1.4.1\n Python Version:  3.6.7\n CPU or GPU: N/A\n Python SDK Version: 1.38.4\n Are you using a custom image: No\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n We obtain the following error when trying to deploy a custom MXNet model via MXNetModel.deploy:\n Python 3.6.7 | packaged by conda-forge | (default, Jul  2 2019, 02:07:37) \n [GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)] on darwin\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n >>> from sagemaker.mxnet.model import MXNetModel\n >>> mxnet_model = MXNetModel(model_data=s3_data_bucket,\n ...                          role=role_arn,\n ...                          entry_point='inference.py',\n ...                          dependencies=['path/to/package'],\n ...                          framework_version='1.4.1',\n ...                          py_version='py3')\n >>> \n >>> mxnet_model.deploy(instance_type='ml.c5.xlarge', initial_instance_count=1)\n <denchmark-code>Traceback (most recent call last):\n   File \"<stdin>\", line 1, in <module>\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/model.py\", line 426, in deploy\n     self._create_sagemaker_model(instance_type, accelerator_type, tags)\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/model.py\", line 165, in _create_sagemaker_model\n     container_def = self.prepare_container_def(instance_type, accelerator_type=accelerator_type)\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/mxnet/model.py\", line 148, in prepare_container_def\n     self._upload_code(deploy_key_prefix, is_mms_version)\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/model.py\", line 788, in _upload_code\n     sagemaker_session=self.sagemaker_session,\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/utils.py\", line 413, in repack_model\n     model_dir, inference_script, source_directory, dependencies, sagemaker_session, tmp\n   File \"/anaconda3/envs/xx/lib/python3.6/site-packages/sagemaker/utils.py\", line 472, in _create_or_update_code_dir\n     shutil.copytree(dependency, code_dir, os.path.basename(dependency))\n   File \"/anaconda3/envs/xx/lib/python3.6/shutil.py\", line 315, in copytree\n     os.makedirs(dst)\n   File \"/anaconda3/envs/xx/lib/python3.6/os.py\", line 220, in makedirs\n     mkdir(name, mode)\n FileExistsError: [Errno 17] File exists: '/var/folders/3z/kqrl01qd2vv6248zcs56q0wh0000gn/T/tmpqbeoxi0t/model/code'\n </denchmark-code>\n \n We strongly suspect the problem to be related to <denchmark-link:https://github.com/aws/sagemaker-python-sdk/blob/9765de68ad8b776740d800148c861ca0e4794716/src/sagemaker/utils.py#L472>line 472</denchmark-link>\n  in :\n shutil.copytree(dependency, code_dir)\n The problem is that  already exists at that point and hence  throws an error (cf. <denchmark-link:https://docs.python.org/3/library/shutil.html#shutil.copytree>shutils.copytree doc</denchmark-link>\n ).\n This problem only occurs when supplying the MXNetModel constructor with the parameter framework_version, which triggers a call to utils.repack_model from FrameworkModel._upload_code.\n We believe the solution is to modify the aforementioned line to the following:\n <denchmark-code>shutil.copytree(dependency, os.path.join(code_dir, os.path.basename(dependency)))\n </denchmark-code>\n \n so that the dependency folder is copied into code_dir instead of trying to replace it.\n <denchmark-h:h3>Minimal repro / logs</denchmark-h>\n \n To reproduce:\n \n \n \n touch inference.py\n mkdir -p path/to/package\n touch path/to/package/utils.py\n \n On a Python console, run:\n \n from sagemaker.mxnet.model import MXNetModel\n \n s3_data_bucket = 'bucket_with_model_artifacts'\n role_arn = 'role_arn'\n \n mxnet_model = MXNetModel(model_data=s3_data_bucket,\n                          role=role_arn,\n                          entry_point='inference.py',\n                          dependencies=['path/to/package'],\n                          framework_version='1.4.1',\n                          py_version='py3')\n \n mxnet_model.deploy(instance_type='ml.c5.xlarge', initial_instance_count=1)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "atibaup", "commentT": "2019-09-03T03:16:00Z", "comment_text": "\n \t\t+1. It seems using framework_version='1.3.0' is OK, and I only get the error when specifying 1.4.1.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "atibaup", "commentT": "2019-09-05T00:16:21Z", "comment_text": "\n \t\tThank you for the super-detailed bug report! I've submitted a PR here: <denchmark-link:https://github.com/aws/sagemaker-python-sdk/pull/1021>#1021</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "atibaup", "commentT": "2019-09-10T17:45:08Z", "comment_text": "\n \t\tv1.39.1 has been released with this change. Hopefully this solves your issue!\n \t\t"}}}, "commit": {"commit_id": "e62dd2e9b9e2ecad4a2cf67843e44f27c325996e", "commit_author": "Lauren Yu", "commitT": "2019-09-09 18:02:23-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\sagemaker\\utils.py", "file_new_name": "src\\sagemaker\\utils.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "471,473,475,476", "deleted_lines": "472,474"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\unit\\test_utils.py", "file_new_name": "tests\\unit\\test_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "347,358,359,360,361,369,370", "deleted_lines": "347,358,366,367", "method_info": {"method_name": "test_repack_model_without_source_dir", "method_params": "tmp,fake_s3", "method_startline": "340", "method_endline": "372"}}, "hunk_1": {"Ismethod": 1, "added_lines": "455", "deleted_lines": "452", "method_info": {"method_name": "test_repack_model_from_file_to_file", "method_params": "tmp", "method_startline": "435", "method_endline": "455"}}}}}}}