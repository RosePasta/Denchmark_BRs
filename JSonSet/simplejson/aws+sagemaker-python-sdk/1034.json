{"BR": {"BR_id": "1034", "BR_author": "amchang", "BRopenT": "2019-09-09T21:51:03Z", "BRcloseT": "2019-09-10T18:53:59Z", "BR_text": {"BRsummary": "Bug: change: use regional endpoint when creating AWS STS client #1026", "BRdescription": "\n Please fill out the form below.\n <denchmark-h:h3>System Information</denchmark-h>\n \n \n Python 3.6.9\n Sagemaker SDK 1.39.0\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n PR <denchmark-link:https://github.com/aws/sagemaker-python-sdk/pull/1026>#1026</denchmark-link>\n  introduced a bug by not using a scheme for a particular STS endpoint\n <denchmark-h:h3>Minimal repro / logs</denchmark-h>\n \n sagemaker.get_execution_role(sagemaker_session)\n Leads to this stack trace\n <denchmark-code>  File \"/Library/Caches/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/sagemaker/session.py\", line 1386, in get_caller_identity_arn\n     \"sts\", endpoint_url=sts_regional_endpoint(self.boto_region_name)\n   File \"/Library/Caches/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/boto3/session.py\", line 263, in client\n     aws_session_token=aws_session_token, config=config)\n   File \"/Library/Caches/pypoetry/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/botocore/session.py\", line 839, in create_client\n     client_config=config, api_version=api_version)\n   File \"/Library/Caches/pypoetry/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/botocore/client.py\", line 86, in create_client\n     verify, credentials, scoped_config, client_config, endpoint_bridge)\n   File \"/Library/Caches/pypoetry/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/botocore/client.py\", line 328, in _get_client_args\n     verify, credentials, scoped_config, client_config, endpoint_bridge)\n   File \"/Library/Caches/pypoetry/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/botocore/args.py\", line 85, in get_client_args\n     client_cert=new_config.client_cert)\n   File \"/Library/Caches/pypoetry/virtualenvs/gocentral-ml-sagemaker-0XKWRhha-py3.6/lib/python3.6/site-packages/botocore/endpoint.py\", line 261, in create_endpoint\n     raise ValueError(\"Invalid endpoint: %s\" % endpoint_url)\n ValueError: Invalid endpoint: sts.us-west-2.amazonaws.com\n \n </denchmark-code>\n \n The endpoint.py requires a scheme and non is provided via the sts_regional_endpoint method.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "amchang", "commentT": "2019-09-09T21:53:09Z", "comment_text": "\n \t\tMore details: <denchmark-link:https://github.com/boto/botocore/blob/develop/botocore/utils.py#L832-L853>https://github.com/boto/botocore/blob/develop/botocore/utils.py#L832-L853</denchmark-link>\n  from botocore prevents this change from working\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "amchang", "commentT": "2019-09-09T22:06:45Z", "comment_text": "\n \t\tThanks for the detailed bug report, and apologies for the trouble this has caused. I've submitted a PR to fix this: <denchmark-link:https://github.com/aws/sagemaker-python-sdk/pull/1035>#1035</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "amchang", "commentT": "2019-09-10T01:01:04Z", "comment_text": "\n \t\tHey the fix of this bug was already merged and deployed?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "amchang", "commentT": "2019-09-10T03:49:12Z", "comment_text": "\n \t\tnot deployed yet - will do so tomorrow morning. In the meantime, please downgrade your SDK version to 1.38.6. Sorry for the inconvenience!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "amchang", "commentT": "2019-09-10T12:07:09Z", "comment_text": "\n \t\tI am trying to use jupyter notebook and is throwing same error, this issue will be fixed when you deployed the fixes?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "amchang", "commentT": "2019-09-10T14:17:23Z", "comment_text": "\n \t\tHow does one downgrade the SDK in the jupyter notebook?  Just spent a chunk of time on this issue trying to get the demo working.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "amchang", "commentT": "2019-09-10T14:25:13Z", "comment_text": "\n \t\tYeah, I am block now for the same thing, cannot use jupyter notebook even for demo notebooks, this issue is a headache, totally crazy a company as Amazon has this type of bugs\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "amchang", "commentT": "2019-09-10T14:39:07Z", "comment_text": "\n \t\tThe default sagemaker package still has de issue (1.39).\n But it seems it's working if you downgrade to 1.38.6:\n pip install sagemaker==1.38.6\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "amchang", "commentT": "2019-09-10T15:05:39Z", "comment_text": "\n \t\tI'm getting the same error even after downgrading to 1.38.6.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "amchang", "commentT": "2019-09-10T15:58:20Z", "comment_text": "\n \t\tAny Estimated time for this issue?\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "amchang", "commentT": "2019-09-10T16:15:55Z", "comment_text": "\n \t\tIt's working for me:\n \n open the terminal and activate the right conda env used in jupyter\n pip install sagemaker==1.38.6\n reload the kernel in jupyter and import sagemaker package\n confirm that the 1.38 version is loaded\n the get_execution_role() should be working now.\n \n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "amchang", "commentT": "2019-09-10T16:43:44Z", "comment_text": "\n \t\tApparently the second time is the charm.  Downgraded to 1.38.6 again and now it works.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "amchang", "commentT": "2019-09-10T17:43:43Z", "comment_text": "\n \t\tv1.39.1 has just been released, and should contain the fix.\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "amchang", "commentT": "2019-09-10T19:14:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/bscholesboogie>@bscholesboogie</denchmark-link>\n  Could you describe step by step How  to downgrade sagemaker package in a jupyter notebook instance, please?\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "amchang", "commentT": "2019-09-10T19:31:19Z", "comment_text": "\n \t\t\n @bscholesboogie Could you describe step by step How to downgrade sagemaker package in a jupyter notebook instance, please?\n \n Sure.  In your Jupyter notebook, insert a blank (Code) cell at the top and shift-enter the following:\n !pip install sagemaker==1.38.6\n Give it a minute, and it will uninstall v.1.39.0 and install 1.38.6 over it.  Be sure to restart the kernel before you begin running the rest of your code.\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "amchang", "commentT": "2019-09-10T21:53:39Z", "comment_text": "\n \t\tIt seems new spawned sagemaker instances still got the 1.39.0 package by default. You have either to manually  downgrade sagemaker package to 1.38.6 or to upgrade it to 1.39.1 to solve the error.\n \t\t"}, "comments_16": {"comment_id": 17, "comment_author": "amchang", "commentT": "2019-09-10T22:15:27Z", "comment_text": "\n \t\tthank you <denchmark-link:https://github.com/ivenzor>@ivenzor</denchmark-link>\n  and <denchmark-link:https://github.com/bscholesboogie>@bscholesboogie</denchmark-link>\n  for your help here! I've also reached out to the team that owns SageMaker Notebook Instances about new instances still using the buggy SDK version.\n \t\t"}, "comments_17": {"comment_id": 18, "comment_author": "amchang", "commentT": "2019-09-11T09:36:10Z", "comment_text": "\n \t\tHi, I'm trying to train some models on SageMaker's Notebooks today and it's not working at all, by the look of this thread, I think the Service Health Dashboard should have been updated to provide details on this downtime.\n Although the fix is relatively easy, just running !pip install sagemaker==1.38.6 within a notebook instance, I don't think AWS users should be expected to seek out fixes on GitHub comments sections, some information in SageMaker would have been preferable\n \t\t"}, "comments_18": {"comment_id": 19, "comment_author": "amchang", "commentT": "2019-09-11T15:17:05Z", "comment_text": "\n \t\tToday's spawned instances have already the correct package by default (1.39.1).\n \t\t"}, "comments_19": {"comment_id": 20, "comment_author": "amchang", "commentT": "2019-09-12T08:19:42Z", "comment_text": "\n \t\tI'm still getting the error as of now in eu-west-1.\n When you say \"spawned instance\" does that constitute deleting and recreating my notebook, or is simply shutting down the notebook instance and opening it again fine? Because if so, I have tried the latter.\n \t\t"}, "comments_20": {"comment_id": 21, "comment_author": "amchang", "commentT": "2019-09-12T09:58:24Z", "comment_text": "\n \t\t\n I'm still getting the error as of now in eu-west-1.\n When you say \"spawned instance\" does that constitute deleting and recreating my notebook, or is simply shutting down the notebook instance and opening it again fine? Because if so, I have tried the latter.\n \n !pip install -U sagemaker\n !pip install -U boto3\n I just ran this in SM notebook instance based in Ireland\n I had to restart the kernel, but it is now working\n Hopefully this works for you also\n \t\t"}, "comments_21": {"comment_id": 22, "comment_author": "amchang", "commentT": "2019-09-12T14:53:05Z", "comment_text": "\n \t\tSorry for the delay, for \"spawned instance\" I meant when you start your sagemaker notebook instances they already have the fixed sagemaker package (1.39.1).\n sh-4.2$ conda list | grep sagemaker\n sagemaker                 1.39.1                    \n \t\t"}}}, "commit": {"commit_id": "bae66a05da846de13a7171bafcd7895f1cd8e1e1", "commit_author": "Lauren Yu", "commitT": "2019-09-09 15:57:16-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\sagemaker\\utils.py", "file_new_name": "src\\sagemaker\\utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "556", "deleted_lines": "556", "method_info": {"method_name": "sts_regional_endpoint", "method_params": "region", "method_startline": "541", "method_endline": "556"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\unit\\test_utils.py", "file_new_name": "tests\\unit\\test_utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "568,569", "deleted_lines": "567", "method_info": {"method_name": "test_sts_regional_endpoint", "method_params": "", "method_startline": "566", "method_endline": "569"}}}}}}}