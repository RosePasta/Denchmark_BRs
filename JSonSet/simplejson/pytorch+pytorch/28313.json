{"BR": {"BR_id": "28313", "BR_author": "sadanand-singh", "BRopenT": "2019-10-18T21:53:12Z", "BRcloseT": "2020-01-22T19:08:31Z", "BR_text": {"BRsummary": "Using dill pickle module for load and save", "BRdescription": "\n In the latest codebase enforcing encoding='utf-8' breaks down the case when one uses the dill module for pickling, as dill does not take 'encoding' as an argument!\n cc <denchmark-link:https://github.com/ezyang>@ezyang</denchmark-link>\n  <denchmark-link:https://github.com/gchanan>@gchanan</denchmark-link>\n  <denchmark-link:https://github.com/zou3519>@zou3519</denchmark-link>\n  <denchmark-link:https://github.com/jerryzh168>@jerryzh168</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "sadanand-singh", "commentT": "2019-10-22T07:23:12Z", "comment_text": "\n \t\tRelevant discussion for making  use default encoding  in <denchmark-link:https://github.com/pytorch/pytorch/pull/26421>#26421</denchmark-link>\n .\n You can still pass an encoding kwarg to torch.load to override it.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "sadanand-singh", "commentT": "2019-10-22T16:20:28Z", "comment_text": "\n \t\tNo, the issue is dill does NOT even take an argument of . CCing <denchmark-link:https://github.com/ezyang>@ezyang</denchmark-link>\n  as he had opened the original <denchmark-link:https://github.com/pytorch/pytorch/issues/21743>#21743</denchmark-link>\n  issue.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "sadanand-singh", "commentT": "2019-10-22T16:22:20Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ezyang>@ezyang</denchmark-link>\n  please advise how to fix this, I would like to help\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "sadanand-singh", "commentT": "2019-10-22T19:08:15Z", "comment_text": "\n \t\tA cheap and cheerful fix is to pass utf-8 in, and if the call fails due to an argument error, retry again without that argument.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "sadanand-singh", "commentT": "2019-10-24T13:26:10Z", "comment_text": "\n \t\t(removing triaged label to make sure it is discussed in triage review)\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "sadanand-singh", "commentT": "2019-10-28T17:22:07Z", "comment_text": "\n \t\tWe don't claim to support dill, but a lot of people seem to use it.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "sadanand-singh", "commentT": "2019-11-02T22:05:56Z", "comment_text": "\n \t\tI cannot reproduce this.\n Did this get fixed in the meanwhile?\n    def test_dill_serialization_no_encoding(self):\n         try:\n             import dill\n         except:\n             return\n \n         x = torch.randn(5, 5)\n         \n         with tempfile.NamedTemporaryFile() as f:\n             torch.save(x, f, pickle_module=dill)\n             f.seek(0)\n             x2 = torch.load(f, pickle_module=dill)\n             self.assertIsInstance(x2, type(x))\n             self.assertEqual(x, x2)\n \n     def test_dill_serialization_encoding(self):\n         try:\n             import dill\n         except:\n             return\n \n         x = torch.randn(5, 5)\n         \n         with tempfile.NamedTemporaryFile() as f:\n             torch.save(x, f, pickle_module=dill)\n             f.seek(0)\n             x2 = torch.load(f, pickle_module=dill, encoding='utf-8')\n             self.assertIsInstance(x2, type(x))\n             self.assertEqual(x, x2)\n I wrote these two tests, and both are passing. <denchmark-link:https://github.com/sadanand-singh>@sadanand-singh</denchmark-link>\n  can you provide an example please?\n \n save doesn't accept encoding.\n load does but on my machine this doesn't brake the loading when using dill. See the second test.\n \n I maybe didn't understand the report so if you could provide an example, that would be best.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "sadanand-singh", "commentT": "2019-11-02T22:24:11Z", "comment_text": "\n \t\tTo add, I modified torch/serialization.py:\n <denchmark-code>    _sys_info = pickle_module.load(f, **pickle_load_args)\n     print(pickle_module, pickle_load_args, pickle_module.__version__)\n     unpickler = pickle_module.Unpickler(f, **pickle_load_args)\n     unpickler.persistent_load = persistent_load\n     result = unpickler.load()\n </denchmark-code>\n \n and I got this:\n <denchmark-code><module 'dill' from '/home/nmilosev/.conda/envs/pytorchcontrib/lib/python3.7/site-packages/dill/__init__.py'> {'encoding': 'utf-8'} 0.3.1.1\n </denchmark-code>\n \n Even further just firing a REPL:\n <denchmark-code>Python 3.7.5 (default, Oct 25 2019, 15:51:11) \n [GCC 7.3.0] :: Anaconda, Inc. on linux\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n >>> import dill\n >>> f = open('temp', 'r')\n >>> dill.Unpickler(f, encoding='utf-8')\n <dill._dill.Unpickler object at 0x7fbd028de050>\n >>> dill.Unpickler(f, encodisdng='utf-8')\n Traceback (most recent call last):\n   File \"<stdin>\", line 1, in <module>\n   File \"/home/nmilosev/.conda/envs/pytorchcontrib/lib/python3.7/site-packages/dill/_dill.py\", line 467, in __init__\n     StockUnpickler.__init__(self, *args, **kwds)\n TypeError: 'encodisdng' is an invalid keyword argument for Unpickler()\n >>> \n </denchmark-code>\n \n So seems to me that dill is definitely supporting encoding for the Unpickler, which is the only thing we added with the mentioned PR.\n Seems to me, that since  0.3.1 this is supported: <denchmark-link:https://github.com/uqfoundation/dill/issues/156>uqfoundation/dill#156</denchmark-link>\n  and checking the code <denchmark-link:https://github.com/uqfoundation/dill/blob/master/dill/_dill.py#L268>https://github.com/uqfoundation/dill/blob/master/dill/_dill.py#L268</denchmark-link>\n  it looks like they support it.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "sadanand-singh", "commentT": "2019-11-20T18:56:31Z", "comment_text": "\n \t\tI faced the same issue, it seems like upgrading dill to 0.3.1.1 fixed the problem for me.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "sadanand-singh", "commentT": "2019-12-02T19:33:44Z", "comment_text": "\n \t\tUpgrading to dill 0.3.1 as per <denchmark-link:https://github.com/nmilosev>@nmilosev</denchmark-link>\n 's comment seems to be the solution here. Here's what we can do from the pytorch side, though, if we commit to supporting dill:\n \n Detect if the user is using dill as the picker. If so, check dill's version and error out gracefully if it's too small\n Add tests for dill\n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "sadanand-singh", "commentT": "2019-12-18T18:38:37Z", "comment_text": "\n \t\tFixed in <denchmark-link:https://github.com/pytorch/pytorch/pull/30985>#30985</denchmark-link>\n  by <denchmark-link:https://github.com/kurtamohler>@kurtamohler</denchmark-link>\n \n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "sadanand-singh", "commentT": "2020-01-10T14:48:10Z", "comment_text": "\n \t\tAcccording to <denchmark-link:https://github.com/ljk53>@ljk53</denchmark-link>\n  this was only fixed in Python 3 and not Python 2.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "sadanand-singh", "commentT": "2020-01-22T18:04:04Z", "comment_text": "\n \t\tShould I still fix this for Python 2, or is skipping the dill test (commit <denchmark-link:https://github.com/pytorch/pytorch/commit/03ff3eb94d193572dd8029b02e02c34c17bada33>03ff3eb</denchmark-link>\n ) good enough? We are on the final version that will support Python 2 after all.\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "sadanand-singh", "commentT": "2020-01-22T18:38:40Z", "comment_text": "\n \t\tYeah, we're not planning on supporting Python 2 in 1.5 so it is sufficient to just skip the dill test on python 2\n \t\t"}}}, "commit": {"commit_id": "3694749cd1b2bfbb4537ea767fdbbe925b815923", "commit_author": "Kurt Mohler", "commitT": "2019-12-18 08:05:08-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "test\\common_utils.py", "file_new_name": "test\\common_utils.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "267", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "test\\test_torch.py", "file_new_name": "test\\test_torch.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "4163,4164,4165,4166,4167,4168,4169,4170,4171", "deleted_lines": null, "method_info": {"method_name": "test_serialization_dill_version_not_supported", "method_params": "self", "method_startline": "4163", "method_endline": "4171"}}, "hunk_1": {"Ismethod": 1, "added_lines": "4177,4178,4179,4180,4181,4182,4183,4184,4185,4186,4187,4188,4189", "deleted_lines": null, "method_info": {"method_name": "test_serialization_dill", "method_params": "self", "method_startline": "4177", "method_endline": "4189"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "torch\\serialization.py", "file_new_name": "torch\\serialization.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "583,584", "deleted_lines": null, "method_info": {"method_name": "load", "method_params": "f,map_location,pickle_module,pickle_load_args", "method_startline": "509", "method_endline": "597"}}, "hunk_1": {"Ismethod": 1, "added_lines": "90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128", "deleted_lines": null, "method_info": {"method_name": "check_module_version_greater_or_equal", "method_params": "module,req_version_tuple,error_if_malformed", "method_startline": "90", "method_endline": "128"}}, "hunk_2": {"Ismethod": 1, "added_lines": "335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352", "deleted_lines": null, "method_info": {"method_name": "_check_dill_version", "method_params": "pickle_module", "method_startline": "335", "method_endline": "352"}}, "hunk_3": {"Ismethod": 1, "added_lines": "381,382", "deleted_lines": null, "method_info": {"method_name": "save", "method_params": "obj,f,pickle_module,pickle_protocol,_use_new_zipfile_serialization", "method_startline": "354", "method_endline": "389"}}}}}}}