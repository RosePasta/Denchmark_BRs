{"BR": {"BR_id": "415", "BR_author": "twise2", "BRopenT": "2019-11-12T22:28:06Z", "BRcloseT": "2019-11-14T13:32:58Z", "BR_text": {"BRsummary": "Writing lock file in cache hangs for non-transient OpErrors, such as PermissionDeniedError", "BRdescription": "\n Expected Behavior: Fail or Error\n Actual Behavior: Hangs atleast 24 hours.\n If a user with higher permissions loads a tensorflow hub embedding and stores them in a cache, a user without permission to the cached store will hand when running the hub.Module(module_url) as the file will exists but they will not be able to read from it.\n Code to be run by admin then user without permissions to TFHUB_CACHE_DIR:\n <denchmark-code>import tensorflow as tf\n import tensorflow_hub as hub\n module_url = \"https://tfhub.dev/google/universal-sentence-encoder-large/3\"\n text_input = tf.placeholder(dtype=tf.string, shape=[None])\n embed = hub.Module(module_url)\n </denchmark-code>\n \n conda env of tensorflow environment:\n <denchmark-code>name: ubuntu\n channels:\n   - pytorch\n   - defaults\n dependencies:\n   - _libgcc_mutex=0.1\n   - _tflow_select=2.3.0\n   - absl-py=0.8.1\n   - asn1crypto=1.2.0\n   - astor=0.8.0\n   - beautifulsoup4=4.8.1\n   - blas=1.0\n   - c-ares=1.15.0\n   - ca-certificates=2019.10.16\n   - certifi=2019.9.11\n   - cffi=1.13.1\n   - chardet=3.0.4\n   - click=7.0\n   - cryptography=2.8\n   - faiss-cpu=1.6.0\n   - flask=1.1.1\n   - gast=0.3.2\n   - grpcio=1.16.1\n   - gunicorn=19.9.0\n   - h5py=2.9.0\n   - hdf5=1.10.4\n   - idna=2.8\n   - intel-openmp=2019.4\n   - itsdangerous=1.1.0\n   - jinja2=2.10.3\n   - keras-applications=1.0.8\n   - keras-preprocessing=1.1.0\n   - libedit=3.1.20181209\n   - libffi=3.2.1\n   - libgcc-ng=9.1.0\n   - libgfortran-ng=7.3.0\n   - libprotobuf=3.9.2\n   - libstdcxx-ng=9.1.0\n   - markdown=3.1.1\n   - markupsafe=1.1.1\n   - mkl=2019.4\n   - mkl-service=2.3.0\n   - mkl_fft=1.0.15\n   - mkl_random=1.1.0\n   - mock=3.0.5\n   - ncurses=6.1\n   - numpy=1.17.3\n   - numpy-base=1.17.3\n   - openssl=1.1.1d\n   - pip=19.3.1\n   - protobuf=3.9.2\n   - pycparser=2.19\n   - pyopenssl=19.0.0\n   - pysocks=1.7.1\n   - python=3.7.5\n   - readline=7.0\n   - requests=2.22.0\n   - scipy=1.3.1\n   - setuptools=41.6.0\n   - six=1.12.0\n   - soupsieve=1.9.3\n   - sqlite=3.30.1\n   - tensorboard=1.13.1\n   - tensorflow=1.13.1\n   - tensorflow-base=1.13.1\n   - tensorflow-estimator=1.13.0\n   - tensorflow-hub=0.6.0\n   - termcolor=1.1.0\n   - tk=8.6.8\n   - urllib3=1.24.2\n   - werkzeug=0.16.0\n   - wheel=0.33.6\n   - xz=5.2.4\n   - zlib=1.2.11\n prefix: /home/miniconda/envs/ubuntu\n </denchmark-code>\n \n executable by running conda env create -f <above code>\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "twise2", "commentT": "2019-11-13T07:35:41Z", "comment_text": "\n \t\tConfirmed: atomic_download() retries indefinitely when creating the lock file fails with any OpError other than NotFoundError. Source location: <denchmark-link:https://github.com/tensorflow/hub/blob/r0.6/tensorflow_hub/resolver.py#L388>https://github.com/tensorflow/hub/blob/r0.6/tensorflow_hub/resolver.py#L388</denchmark-link>\n \n I think this should be fixed by failing for more types of non-transient errors besides NotFoundError, notably for the PermissionDeniedError likely seen in the reported instance of this problem.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "twise2", "commentT": "2019-11-14T13:32:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/twise2>@twise2</denchmark-link>\n , thanks a lot for reporting this. Commit <denchmark-link:https://github.com/tensorflow/hub/commit/ed61dbd3a042251a414e29bd4811a3a403c59a25>ed61dbd</denchmark-link>\n  has fixed this on the master branch and will be included in the tensorflow-hub 0.8 release eventually.  If you need it sooner than that, please wait for the next tf-hub-nightly pip package and use that.\n \t\t"}}}, "commit": {"commit_id": "ed61dbd3a042251a414e29bd4811a3a403c59a25", "commit_author": "TensorFlow Hub Authors", "commitT": "2019-11-14 14:26:06+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow_hub\\resolver.py", "file_new_name": "tensorflow_hub\\resolver.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "366,387,388,389,390,391,392,393,394,395,397,398,399,400", "deleted_lines": "386"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow_hub\\resolver_test.py", "file_new_name": "tensorflow_hub\\resolver_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "289,290,291,292", "deleted_lines": null, "method_info": {"method_name": "testModuleDownloadPermissionDenied.unused_download_fn", "method_params": "handle,tmp_dir", "method_startline": "289", "method_endline": "292"}}, "hunk_1": {"Ismethod": 1, "added_lines": "284,285,286,287,288,289,290,291,292,293,294,295", "deleted_lines": null, "method_info": {"method_name": "testModuleDownloadPermissionDenied", "method_params": "self", "method_startline": "284", "method_endline": "295"}}}}}}}