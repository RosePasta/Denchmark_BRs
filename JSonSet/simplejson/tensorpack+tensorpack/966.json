{"BR": {"BR_id": "966", "BR_author": "maciejjaskowski", "BRopenT": "2018-11-05T08:54:49Z", "BRcloseT": "2018-11-05T10:48:06Z", "BR_text": {"BRsummary": "MinSaver saves wrong model without warning", "BRdescription": "\n If you're asking about an unexpected problem you met, use this template.\n PLEASE DO NOT DELETE THIS TEMPLATE, FILL IT:\n <denchmark-h:h3>1. What you did:</denchmark-h>\n \n (1) \n Run mnist example <denchmark-link:https://github.com/tensorpack/tensorpack/blob/master/examples/basics/mnist-convnet.py>https://github.com/tensorpack/tensorpack/blob/master/examples/basics/mnist-convnet.py</denchmark-link>\n \n (2) If you're using examples, have you made any changes to the examples? Paste them here:\n No changes.\n <denchmark-h:h3>2. What you observed:</denchmark-h>\n \n (1) Include the ENTIRE logs here:\n The model saved with MaxSaver is a model from epoch N+1 instead from the epoch N, as expected. Logs show no problem.\n (2) Other observations, if any:\n N/A\n <denchmark-h:h3>3. What you expected, if not obvious.</denchmark-h>\n \n There are two problems:\n \n the example is wrong, it should read:\n \n <denchmark-code>callbacks=[\n             ModelSaver(),   # save the model after every epoch\n             InferenceRunner(    # run inference(for validation) after every epoch\n                 dataset_test,   # the DataFlow instance used for validation\n                 ScalarStats(['cross_entropy_loss', 'accuracy'])),\n             MaxSaver('validation_accuracy'),  # save the model with highest accuracy (prefix 'validation_')\n            \n         ],\n </denchmark-code>\n \n Note, the order in callbacks. If InferenceRunner is run last, as originally in the example, MaxSaver will read _get_stat after epoch N but will save model after epoch N+1.\n \n There is no safeguard against the original version.\n \n In my case, _need_save() could be changed to something like\n <denchmark-code>    def _need_save(self):\n         v = self._get_stat()\n         assert v, \"No InferenceRunner was run before executing MinSaver\"\n         return v > self.min if self.reverse else v < self.min\n </denchmark-code>\n \n But I am not sure if it does not have some implications, I don't see.\n \n I didn't find a piece of documentation suggesting that MaxSaver must be after InferenceRunner in callbacks.\n \n <denchmark-h:h3>4. Your environment:</denchmark-h>\n \n N/A\n I'll be happy to fix this either way once we settle on a solution.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "maciejjaskowski", "commentT": "2018-11-05T10:14:32Z", "comment_text": "\n \t\tNice catch. This should be conveyed more clearly in the docs, and detected automatically.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "maciejjaskowski", "commentT": "2018-11-05T12:17:57Z", "comment_text": "\n \t\tProbably not a big deal if your model's performance does not variate too much epoch to epoch :-)\n \t\t"}}}, "commit": {"commit_id": "fded4f40b09af15d9ae530a1979f0a3c112b3d70", "commit_author": "Yuxin Wu", "commitT": "2018-11-05 18:47:38+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "examples\\basics\\mnist-convnet.py", "file_new_name": "examples\\basics\\mnist-convnet.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "120,121,122,123", "deleted_lines": "118,121"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tensorpack\\callbacks\\saver.py", "file_new_name": "tensorpack\\callbacks\\saver.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "105,106,107,108,109,110,115", "deleted_lines": "105,106,107,108,113", "method_info": {"method_name": "__init__", "method_params": "self,monitor_stat,reverse,filename,checkpoint_dir", "method_startline": "87", "method_endline": "118"}}, "hunk_1": {"Ismethod": 1, "added_lines": "140,143,144,145,146,147,148,149,150,151,158,159", "deleted_lines": "141,150,151", "method_info": {"method_name": "_save", "method_params": "self", "method_startline": "136", "method_endline": "159"}}, "hunk_2": {"Ismethod": 1, "added_lines": "128,129,130,131,132,133,134", "deleted_lines": "127,128,129,130,132,133,134", "method_info": {"method_name": "_trigger", "method_params": "self", "method_startline": "127", "method_endline": "134"}}, "hunk_3": {"Ismethod": 1, "added_lines": "128,129", "deleted_lines": "125,126,127,128,129", "method_info": {"method_name": "_need_save", "method_params": "self", "method_startline": "125", "method_endline": "129"}}, "hunk_4": {"Ismethod": 1, "added_lines": "122,123,124", "deleted_lines": "120,121,122,125", "method_info": {"method_name": "_get_stat", "method_params": "self", "method_startline": "120", "method_endline": "125"}}}}}}}