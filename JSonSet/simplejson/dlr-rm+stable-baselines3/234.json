{"BR": {"BR_id": "234", "BR_author": "lubiluk", "BRopenT": "2020-11-19T17:52:16Z", "BRcloseT": "2020-11-20T12:23:04Z", "BR_text": {"BRsummary": "[Bug] HER crashing when replay_buffer is smaller than total_timesteps", "BRdescription": "\n <denchmark-h:h3>\ud83d\udc1b Bug</denchmark-h>\n \n When using HER with replay_buffer that overflows at some point we get a crash with IndexError.\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Run HER + SAC with small buffer_size and small learning_starts\n from stable_baselines3 import HER, DDPG, DQN, SAC, TD3\n from stable_baselines3.her.goal_selection_strategy import GoalSelectionStrategy\n from stable_baselines3.common.bit_flipping_env import BitFlippingEnv\n from stable_baselines3.common.vec_env import DummyVecEnv\n from stable_baselines3.common.vec_env.obs_dict_wrapper import ObsDictWrapper\n \n model_class = DQN  # works also with SAC, DDPG and TD3\n N_BITS = 15\n \n env = BitFlippingEnv(n_bits=N_BITS, continuous=model_class in [DDPG, SAC, TD3], max_steps=N_BITS)\n \n # Available strategies (cf paper): future, final, episode\n goal_selection_strategy = 'future' # equivalent to GoalSelectionStrategy.FUTURE\n \n # If True the HER transitions will get sampled online\n online_sampling = True\n # Time limit for the episodes\n max_episode_length = N_BITS\n \n # Initialize the model\n model = HER('MlpPolicy', env, model_class, n_sampled_goal=4, goal_selection_strategy=goal_selection_strategy, online_sampling=online_sampling,\n                         verbose=1, max_episode_length=max_episode_length, buffer_size=100,\n                         learning_starts=1, learning_rate=1)\n # Train the model\n model.learn(1000)\n Traceback (most recent call last):\n   File \"her_fail.py\", line 25, in <module>\n     model.learn(1000)\n   File \"/home/lubiluk/Code/stable-baselines3/stable_baselines3/her/her.py\", line 214, in learn\n     self.train(batch_size=self.batch_size, gradient_steps=gradient_steps)\n   File \"/home/lubiluk/Code/stable-baselines3/stable_baselines3/dqn/dqn.py\", line 153, in train\n     replay_data = self.replay_buffer.sample(batch_size, env=self._vec_normalize_env)\n   File \"/home/lubiluk/Code/stable-baselines3/stable_baselines3/her/her_replay_buffer.py\", line 141, in sample\n     return self._sample_transitions(batch_size, maybe_vec_env=env, online_sampling=True)\n   File \"/home/lubiluk/Code/stable-baselines3/stable_baselines3/her/her_replay_buffer.py\", line 265, in _sample_transitions\n     for episode_idx, transition_idx in zip(episode_indices, transitions_indices)\n   File \"/home/lubiluk/Code/stable-baselines3/stable_baselines3/her/her_replay_buffer.py\", line 265, in <listcomp>\n     for episode_idx, transition_idx in zip(episode_indices, transitions_indices)\n IndexError: deque index out of range\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n The training should complete without crashing.\n ###\u00a0System Info\n Describe the characteristic of your environment:\n \n Installation: tried both - pip and source (master branch)\n no GPU\n Python 3.7.9\n PyTorch 1.7.0\n Gym 0.17.3\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n <denchmark-h:h3>Checklist</denchmark-h>\n \n \n [ x] I have checked that there is no similar issue in the repo (required)\n [ x] I have read the documentation (required)\n [ x] I have provided a minimal working example to reproduce the bug (required)\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lubiluk", "commentT": "2020-11-20T09:00:25Z", "comment_text": "\n \t\tHello,\n Thanks for reporting the bug =)\n <denchmark-link:https://github.com/megan-klaiber>@megan-klaiber</denchmark-link>\n  is on it, she should push a fix soon.\n \t\t"}}}, "commit": {"commit_id": "852961139e3314208ea628c8238a1e5efd04e759", "commit_author": "Megan Klaiber", "commitT": "2020-11-20 13:23:03+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\misc\\changelog.rst", "file_new_name": "docs\\misc\\changelog.rst", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "33", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "stable_baselines3\\her\\her_replay_buffer.py", "file_new_name": "stable_baselines3\\her\\her_replay_buffer.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "214,215,216,217,218,219,220", "deleted_lines": "214"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\test_her.py", "file_new_name": "tests\\test_her.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278", "deleted_lines": null, "method_info": {"method_name": "test_full_replay_buffer", "method_params": "", "method_startline": "253", "method_endline": "278"}}}}}}}