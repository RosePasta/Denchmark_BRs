{"BR": {"BR_id": "5774", "BR_author": "johann-petrak", "BRopenT": "2019-09-25T11:41:43Z", "BRcloseT": "2019-10-08T06:56:08Z", "BR_text": {"BRsummary": "Actor class attributes not visible in actor methods?", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04\n Ray installed from (source or binary): pip install under per-user Anaconda installation\n Ray version:  0.7.4\n Python version: 3.6.8\n Exact command to reproduce: N/A see code below\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n I tried to use and existing class as an actor with ray. That class assigns a number of constant values to class-level attributes and then uses those constants\n with the class methods, like so:\n class C:\n     CONST1 = 123\n     def method(self):\n         tmp = CONST1  \n     ...\n When I use that class with Ray, when calling the class method, I get the exception \"AttributeError: 'ActorClass' object has no attribute 'CONST1'\"\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n Here is a full example ready to try and run. The class wrapped as an actor is not able to access the class-level attribute:\n import ray\n ray.init()\n \n class Test0:\n     X = 1\n     def __init__(self):\n         print(\"Test 0 initialised\")\n     def run(self):\n         print(\"Test 0 called\")\n         return Test0.X\n t0 = Test0()\n print(\"Test0 result:\", t0.run())\n \n class Test1:\n     X = 1\n     def __init__(self):\n         print(\"Test 1 Initialised\" )\n     def run(self):\n         print(\"Test 1 Called\")\n         return Test1.X\n \n print(\"Test1 defined, X=\", Test1.X)\n Test1 = ray.remote(Test1)\n \n t1 = Test1.remote()\n print(\"Test1 result:\", ray.get(t1.run.remote()))\n \n @ray.remote\n class Test2:\n     X = 1\n     def __init__(self):\n         print(\"Test 2 Initialised\" )\n     def run(self):\n         print(\"Test 2 Called\")\n         return Test2.X\n \n t2 = Test2.remote()\n print(\"Test2 result:\", ray.get(t2.run.remote()))\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "johann-petrak", "commentT": "2019-09-28T01:10:34Z", "comment_text": "\n \t\tThanks a lot for reporting this and also for the reproduction code which is very useful! This is indeed a bug, let me look into it. As a workaround for now you can do this:\n class Test1:\n     X = 1\n     def __init__(self):\n         print(\"Test 1 Initialised\" )\n     def run(self):\n         print(\"Test 1 Called\")\n         return self.X\n \n Test1 = ray.remote(Test1)\n t1 = Test1.remote()\n \n In [7]: print(\"Test1 result:\", ray.get(t1.run.remote()))                                                     \n Test1 result: 1\n i.e. replace the Test1.X with self.X, which works.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "johann-petrak", "commentT": "2019-10-05T20:59:08Z", "comment_text": "\n \t\tThe problem is that that workaround then makes the class break when used without Ray.\n Another symptom of probably the same underlying problem is that static methods do not work:\n Running this:\n <denchmark-code>class Test0:\n     @staticmethod\n     def m():\n         return 2\n     def __init__(self):\n         print(\"Test 0 initialised\")\n     def run(self):\n         print(\"Test 0 called\")\n         return Test0.m()\n t0 = Test0()\n print(\"Test0 result:\", t0.run())\n \n @ray.remote\n class Test1:\n     @staticmethod\n     def m():\n         return 2\n     def __init__(self):\n         print(\"Test 1 Initialised\" )\n     def run(self):\n         print(\"Test 1 Called\")\n         return Test1.m()\n \n t1 = Test1.remote()\n print(\"Test1 result:\", ray.get(t1.run.remote()))\n </denchmark-code>\n \n causes an exception \"Methods must take a 'self' argument, but the method 'm' does not have one.\"\n This is a real problem for classes outside of the direct control of the programmer but also awkward for own classes because it means that all static classes must be copied to fake instance methods, invocation from outside the class and inside has to be made slightly different etc.\n Maybe I am unlucky but I am hitting this problem quite frequently.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "johann-petrak", "commentT": "2019-10-08T07:17:42Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/johann-petrak>@johann-petrak</denchmark-link>\n  The fix has now been merged into master, do you want to check if it solves your problems? You can install and try it out from <denchmark-link:https://ray.readthedocs.io/en/latest/installation.html#latest-snapshots-nightlies>https://ray.readthedocs.io/en/latest/installation.html#latest-snapshots-nightlies</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "785670bc18a8595219c96e9512192922fafcf510", "commit_author": "Philipp Moritz", "commitT": "2019-10-07 23:56:07-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "python\\ray\\actor.py", "file_new_name": "python\\ray\\actor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "226,238,239", "deleted_lines": "221,222,223,224,226,227,228,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244", "method_info": {"method_name": "__init__", "method_params": "cls,name,bases,attr", "method_startline": "221", "method_endline": "244"}}, "hunk_1": {"Ismethod": 1, "added_lines": "194,195,196", "deleted_lines": "194,195,196", "method_info": {"method_name": "_from_modified_class", "method_params": "cls,modified_class,class_id,max_reconstructions,num_cpus,num_gpus,memory,object_store_memory,resources", "method_startline": "194", "method_endline": "196"}}, "hunk_2": {"Ismethod": 1, "added_lines": "178,179", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "178", "method_endline": "179"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "395,396", "method_info": {"method_name": "class_id", "method_params": "self", "method_startline": "395", "method_endline": "396"}}, "hunk_4": {"Ismethod": 1, "added_lines": "262,263,264", "deleted_lines": null, "method_info": {"method_name": "_ray_from_modified_class", "method_params": "cls,modified_class,class_id,max_reconstructions,num_cpus,num_gpus,memory,object_store_memory,resources", "method_startline": "262", "method_endline": "264"}}, "hunk_5": {"Ismethod": 1, "added_lines": "258,259", "deleted_lines": "246,247,248,249,250,252,253,254", "method_info": {"method_name": "__call__", "method_params": "self,args,kwargs", "method_startline": "246", "method_endline": "259"}}, "hunk_6": {"Ismethod": 1, "added_lines": "153,154", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,modified_class,class_id,max_reconstructions,num_cpus,num_gpus,memory,object_store_memory,resources", "method_startline": "153", "method_endline": "154"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\function_manager.py", "file_new_name": "python\\ray\\function_manager.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "663", "deleted_lines": "663", "method_info": {"method_name": "_load_actor_from_local", "method_params": "self,job_id,function_descriptor", "method_startline": "654", "method_endline": "671"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "python\\ray\\tests\\test_actor.py", "file_new_name": "python\\ray\\tests\\test_actor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "284,285,286,287,288,289", "deleted_lines": null, "method_info": {"method_name": "test_actor_class_attributes.f", "method_params": "cls", "method_startline": "284", "method_endline": "289"}}, "hunk_1": {"Ismethod": 1, "added_lines": "291,292,293,294,295,296", "deleted_lines": null, "method_info": {"method_name": "test_actor_class_attributes.g", "method_params": "self", "method_startline": "291", "method_endline": "296"}}, "hunk_2": {"Ismethod": 1, "added_lines": "269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299", "deleted_lines": null, "method_info": {"method_name": "test_actor_class_attributes", "method_params": "ray_start_regular", "method_startline": "269", "method_endline": "299"}}}}}}}