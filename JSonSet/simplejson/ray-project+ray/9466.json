{"BR": {"BR_id": "9466", "BR_author": "kisuke95", "BRopenT": "2020-07-14T06:52:17Z", "BRcloseT": "2020-07-27T19:34:06Z", "BR_text": {"BRsummary": "Problems about new scheduler", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Ray version and other system information (Python version, TensorFlow version, OS):\n There are several problems about new scheduler used in raylet.\n \n  wrong allocation result for soft resource constraint in ClusterResourceScheduler::AllocateResourceInstances #9467\n \n In the following code (just copy from master), in the first for statement, we do this (*allocation)[i] = 1.; available[i] = 0;, but int the second for statement, we may clear it with (*allocation)[i] = available[i]; (because available[i] maybe set 0 in the first for statement)\n if (remaining_demand >= 1.) {\n   for (size_t i = 0; i < available.size(); i++) {\n     if (available[i] == 1.) {\n       // Allocate a full unit-capacity instance.\n       (*allocation)[i] = 1.;\n       available[i] = 0;\n       remaining_demand -= 1.;\n     }\n     if (remaining_demand < 1.) {\n       break;\n     }\n   }\n }\n \n if (soft) {\n   // Just get as many resources as available.\n   for (size_t i = 0; i < available.size(); i++) {\n     if (available[i] >= remaining_demand) {\n       available[i] -= remaining_demand;\n       (*allocation)[i] = remaining_demand;\n       return true;\n     } else {\n       (*allocation)[i] = available[i];\n       remaining_demand -= available[i];\n       available[i] = 0;\n     }\n   }\n   return true;\n }\n \n  we should call new_resource_scheduler_->RemoveNode(...) in NodeManager::NodeRemoved to remove the resource information of the removed node. If not, the new scheduler may make a wrong schedule decision. #9467\n \n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):\n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "kisuke95", "commentT": "2020-07-14T22:37:07Z", "comment_text": "\n \t\tWe currently don't pass most python unit tests for Ray. I'm going to work on passing those unit tests first, so there's no need to track bugs which are already covered by unit tests. I think it would be most helpful if we could find bugs which are not already covered by the existing test cases.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "kisuke95", "commentT": "2020-07-15T01:40:02Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/wuisawesome>@wuisawesome</denchmark-link>\n  I think we can take a look at c++ unit tests.\n \t\t"}}}, "commit": {"commit_id": "4e2e3bd348a6ca10dfdda7f1955a3daee3ac75c3", "commit_author": "kisuke95", "commitT": "2020-07-20 13:09:53-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "674,675,676,677,678,679,680,681,682", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::NodeManager::NodeRemoved", "method_params": "node_info", "method_startline": "653", "method_endline": "716"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.cc", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "941", "deleted_lines": "932", "method_info": {"method_name": "ClusterResourceScheduler::AllocateResourceInstances", "method_params": "demand,soft,available,allocation", "method_startline": "886", "method_endline": "975"}}, "hunk_1": {"Ismethod": 1, "added_lines": "497,498,499,500,501,502,503,504", "deleted_lines": null, "method_info": {"method_name": "ClusterResourceScheduler::RemoveNode", "method_params": "node_id_string", "method_startline": "497", "method_endline": "504"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.h", "file_new_name": "src\\ray\\raylet\\scheduling\\cluster_resource_scheduler.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "253", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\scheduling\\scheduling_test.cc", "file_new_name": "src\\ray\\raylet\\scheduling\\scheduling_test.cc", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970", "deleted_lines": null}}}}}}