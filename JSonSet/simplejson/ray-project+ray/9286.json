{"BR": {"BR_id": "9286", "BR_author": "ffbin", "BRopenT": "2020-07-03T05:48:15Z", "BRcloseT": "2020-07-18T17:15:20Z", "BR_text": {"BRsummary": "[Core]Worker resource leak when GCS server restarts", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n When GCS restarts, GCS client of Worker A detects that GCS server is restarted, and sends the create actor request again. It starts over the whole process and maybe picks up another Raylet or worker to schedule the actor.\n Problem: GCS doesn\u2019t know if it has leased an worker from another raylet for this actor before. Worker resources may be leaked.\n Solution: GCS server sends each raylet which lease workers it uses. If raylet finds that a lease worker is not used, release the lease worker.\n Ray version and other system information (Python version, TensorFlow version, OS):\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):\n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {}}, "commit": {"commit_id": "b12b8e132422323c9bf1e564094ef1ed18ed71b8", "commit_author": "fangfengbin", "commitT": "2020-07-18 15:49:41+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\core_worker\\test\\direct_task_transport_test.cc", "file_new_name": "src\\ray\\core_worker\\test\\direct_task_transport_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "115,116,117,118,119", "deleted_lines": null, "method_info": {"method_name": "ray::MockRayletClient::ReleaseUnusedWorkers", "method_params": "workers_in_use,callback", "method_startline": "115", "method_endline": "119"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "763,783,784,785,786,787,791,792,793,794,795", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::GcsActorManager::LoadInitialData", "method_params": "done", "method_startline": "759", "method_endline": "811"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_scheduler.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_scheduler.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "205,206,207,208,209,210,211", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::GcsActorScheduler::LeaseWorkerFromNode", "method_params": "actor,node", "method_startline": "197", "method_endline": "258"}}, "hunk_1": {"Ismethod": 1, "added_lines": "157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195", "deleted_lines": null, "method_info": {"method_name": "ray::gcs::GcsActorScheduler::ReleaseUnusedWorkers", "method_params": "node_to_workers", "method_startline": "157", "method_endline": "195"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_scheduler.h", "file_new_name": "src\\ray\\gcs\\gcs_server\\gcs_actor_scheduler.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "71,72,73,74,75,76,141,142,143,144,145,146,300,301", "deleted_lines": null}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_manager_test.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_manager_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "34,35", "deleted_lines": null, "method_info": {"method_name": "ray::MockActorScheduler::ReleaseUnusedWorkers", "method_params": "node_to_workers", "method_startline": "34", "method_endline": "35"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_scheduler_test.cc", "file_new_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_actor_scheduler_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504", "deleted_lines": null, "method_info": {"method_name": "ray::TEST_F", "method_params": "GcsActorSchedulerTest,TestReleaseUnusedWorkers", "method_startline": "470", "method_endline": "504"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_server_test_util.h", "file_new_name": "src\\ray\\gcs\\gcs_server\\test\\gcs_server_test_util.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "218,219,220,221", "deleted_lines": null, "method_info": {"method_name": "ray::GcsServerMocker::MockedGcsActorScheduler::TryLeaseWorkerFromNodeAgain", "method_params": "actor,node", "method_startline": "218", "method_endline": "221"}}, "hunk_1": {"Ismethod": 1, "added_lines": "79,80,81,82,83,84,85", "deleted_lines": null, "method_info": {"method_name": "ray::GcsServerMocker::MockRayletClient::ReleaseUnusedWorkers", "method_params": "workers_in_use,callback", "method_startline": "79", "method_endline": "85"}}, "hunk_2": {"Ismethod": 1, "added_lines": "227,228,229", "deleted_lines": null, "method_info": {"method_name": "ray::GcsServerMocker::MockedGcsActorScheduler::RetryLeasingWorkerFromNode", "method_params": "actor,node", "method_startline": "224", "method_endline": "230"}}, "hunk_3": {"Ismethod": 1, "added_lines": "138,139,140,141,142,143,144,145,146,147,148", "deleted_lines": null, "method_info": {"method_name": "ray::GcsServerMocker::MockRayletClient::ReplyReleaseUnusedWorkers", "method_params": "", "method_startline": "138", "method_endline": "148"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\protobuf\\node_manager.proto", "file_new_name": "src\\ray\\protobuf\\node_manager.proto", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "72,73,74,75,76,77,78,159,160,161,162,163,164", "deleted_lines": null}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1844,1845,1846,1847,1848,1849,1850,1851,1852,1853,1854,1855,1856,1857,1858,1859,1860,1861,1862,1863,1864,1865,1866,1867,1868,1869", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::NodeManager::HandleReleaseUnusedWorkers", "method_params": "request,reply,send_reply_callback", "method_startline": "1844", "method_endline": "1869"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\node_manager.h", "file_new_name": "src\\ray\\raylet\\node_manager.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "621,622,623,624,625", "deleted_lines": null}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet_client\\raylet_client.cc", "file_new_name": "src\\ray\\raylet_client\\raylet_client.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::RayletClient::ReleaseUnusedWorkers", "method_params": "workers_in_use,callback", "method_startline": "321", "method_endline": "338"}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet_client\\raylet_client.h", "file_new_name": "src\\ray\\raylet_client\\raylet_client.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "76,77,78,79,80,81,82,83,331,332,333,334,335", "deleted_lines": null}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\rpc\\node_manager\\node_manager_client.h", "file_new_name": "src\\ray\\rpc\\node_manager\\node_manager_client.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "89,90,91", "deleted_lines": null}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\rpc\\node_manager\\node_manager_server.h", "file_new_name": "src\\ray\\rpc\\node_manager\\node_manager_server.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "29,61,62,63,64", "deleted_lines": null}}}}}}