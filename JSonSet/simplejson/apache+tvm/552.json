{"BR": {"BR_id": "552", "BR_author": "masahi", "BRopenT": "2017-10-13T22:36:40Z", "BRcloseT": "2017-10-23T00:51:55Z", "BR_text": {"BRsummary": "[ROCM] Failed topi unittests for rocm backend", "BRdescription": "\n [Update 10/23] All failing test cases were resolved.\n [Update 10/20] Currently 3 tests in <denchmark-link:https://github.com/dmlc/tvm/tree/master/topi/tests/python>topi unittests</denchmark-link>\n  are failing.\n See the summary <denchmark-link:https://gist.github.com/masahi/4da2b5ccaaf490fe7c62332eba7441ff>here</denchmark-link>\n .\n <denchmark-h:h1>test_topi_conv2d_nchw.py</denchmark-h>\n \n 3 out of 12 test cases fail.\n <denchmark-h:h3>case verify_conv2d_nchw(1, 3, 224, 64, 7, 3, 2)</denchmark-h>\n \n <denchmark-code>\n $ python test_topi_conv2d_nchw.py \n AssertionError: \n Not equal to tolerance rtol=1e-05, atol=0\n \n (mismatch 99.98687454346238%)\n  x: array([[[[ 17.740227,  25.133751,  23.486025, ...,  25.639071,  24.148636,\n            21.255533],\n          [ 24.602934,  33.843094,  35.173992, ...,  39.136459,  36.724586,...\n  y: array([[[[ 16.973913,  25.437023,  24.094303, ...,  27.416625,  25.55851 ,\n            22.340623],\n          [ 25.350509,  35.822084,  36.533454, ...,  38.809231,  36.673988,...\n </denchmark-code>\n \n <denchmark-h:h3>case verify_conv2d_nchw(1, 128, 28, 128, 3, 1, 1)</denchmark-h>\n \n <denchmark-code>$ python test_topi_conv2d_nchw.py \n Use memoize topi.tests.test_topi_conv2d.verify_con2d_nchw.get_ref_data.pkl(5, (1, 128, 28, 28), 'float32', 1, 1, (128, 128, 3, 3))\n testing  rocm  backend\n Memory access fault by GPU node-1 on address 0x1000. Reason: Page not present or supervisor privilege.\n Aborted (core dumped)\n </denchmark-code>\n \n <denchmark-h:h3>case verify_conv2d_nchw(1, 256, 14, 256, 3, 1, 1)</denchmark-h>\n \n <denchmark-code>$ python test_topi_conv2d_nchw.py \n Use memoize topi.tests.test_topi_conv2d.verify_con2d_nchw.get_ref_data.pkl(5, (1, 256, 14, 14), 'float32', 1, 1, (256, 256, 3, 3))\n testing  rocm  backend\n Memory access fault by GPU node-1 on address 0x5fc4e1000. Reason: Page not present or supervisor privilege.\n Aborted (core dumped)\n </denchmark-code>\n \n <denchmark-h:h1>test_topi_depthwise_conv2d.py</denchmark-h>\n \n 2 out of 15 test cases fail.\n <denchmark-h:h3>case depthwise_conv2d_with_workload_nhwc(1, 728, 32, 1, 3, 1, \"SAME\")</denchmark-h>\n \n <denchmark-code>$ python test_topi_depthwise_conv2d.py \n AssertionError: \n Not equal to tolerance rtol=1e-05, atol=0\n \n (mismatch 29.669793097527474%)\n  x: array([[[[ 0.79067 ,  0.833293,  1.011379, ...,  0.855761,  0.685508,\n            1.101951],\n          [ 1.64011 ,  1.610993,  1.381752, ...,  1.928582,  1.182396,...\n  y: array([[[[ 0.79067 ,  0.833293,  1.011379, ...,  0.855761,  0.685508,\n            1.101951],\n          [ 1.64011 ,  1.610993,  1.381752, ...,  1.928582,  1.182396,...\n \n </denchmark-code>\n \n <denchmark-h:h3>case depthwise_conv2d_with_workload_nhwc(1, 728, 32, 1, 3, 1, \"VALID\")</denchmark-h>\n \n <denchmark-code>$ python test_topi_depthwise_conv2d.py \n AssertionError: \n Not equal to tolerance rtol=1e-05, atol=0\n \n (mismatch 27.69184981684981%)\n  x: array([[[[ 2.178229,  1.748752,  2.032793, ...,  2.637433,  1.739626,\n            1.027414],\n          [ 1.45854 ,  1.976049,  1.973471, ...,  1.987515,  1.736224,...\n  y: array([[[[ 2.178229,  1.748752,  2.032793, ...,  2.637433,  1.739626,\n            1.027414],\n          [ 1.45854 ,  1.976049,  1.973471, ...,  1.987515,  1.736224,...\n \n </denchmark-code>\n \n <denchmark-h:h1>test_topi_pooling.py</denchmark-h>\n \n 1 out of 8 test cases fails.\n <denchmark-h:h3>case  verify_pool(1, 256, 32, 2, 2, [0, 0], 'avg')</denchmark-h>\n \n <denchmark-code>$ python test_topi_pooling.py \n AssertionError: \n Not equal to tolerance rtol=1e-05, atol=0\n \n (mismatch 50.0%)\n  x: array([[[[ 0.383371,  0.234747,  0.431097, ...,  0.498689,  0.369492,\n            0.783951],\n          [ 0.551467,  0.405494,  0.410852, ...,  0.414632,  0.581095,...\n  y: array([[[[ 0.383371,  0.234747,  0.431097, ...,  0.498689,  0.369492,\n            0.783951],\n          [ 0.551467,  0.405494,  0.410852, ...,  0.414632,  0.581095,...\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "masahi", "commentT": "2017-10-13T22:42:22Z", "comment_text": "\n \t\tcc <denchmark-link:https://github.com/adityaatluri>@adityaatluri</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "masahi", "commentT": "2017-10-15T18:55:47Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/apache/tvm/pull/558>#558</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "masahi", "commentT": "2017-10-15T20:02:22Z", "comment_text": "\n \t\tThe segfault bug was resolved by <denchmark-link:https://github.com/apache/tvm/pull/558>#558</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "masahi", "commentT": "2017-10-20T05:00:46Z", "comment_text": "\n \t\tMath function is supported with <denchmark-link:https://github.com/apache/tvm/pull/570>#570</denchmark-link>\n , 2 failing tests resolved.\n But found another failing test in test_topi_pooling.py\n Updated to reflect the latest status.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "masahi", "commentT": "2017-10-22T22:19:31Z", "comment_text": "\n \t\tverify_conv2d_nchw(1, 128, 28, 128, 3, 1, 1) and verify_conv2d_nchw(1, 256, 14, 256, 3, 1, 1) were failing because of too aggressive unrolling when unroll_explicit = True.\n They were resolved by <denchmark-link:https://github.com/apache/tvm/pull/576>#576</denchmark-link>\n  .\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "masahi", "commentT": "2017-10-23T00:47:28Z", "comment_text": "\n \t\tThe rest of failing tests cases were due to a large thread block size.\n They were all resolved by <denchmark-link:https://github.com/apache/tvm/pull/577>#577</denchmark-link>\n .\n We still do not know why rocm backend cannot handle thread block of size 512 or 728.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "masahi", "commentT": "2017-10-23T00:51:45Z", "comment_text": "\n \t\tAll unit tests are good now. Closing.\n nosetests output:\n <denchmark-code>$ nosetests -v topi/tests/python/\n test_topi_basic.test_util ... ok\n test_topi_basic.test_ewise ... ok\n test_topi_broadcast.test_broadcast_to ... [09:44:50] src/runtime/opencl/opencl_device_api.cc:195: Initialize OpenCL platform 'AMD Accelerated Parallel Processing'\n [09:44:50] src/runtime/opencl/opencl_device_api.cc:215: opencl(0)='gfx803' cl_device_id=0x7f03c8727720\n ok\n test_topi_broadcast.test_broadcast_binary ... ok\n test_topi_clip.test_clip ... ok\n test_topi_conv2d.test_conv2d ... ok\n test_topi_conv2d_hwcn.test_conv2d_hwcn ... [09:44:57] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:57] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:57] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:58] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:58] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:58] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:58] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:44:58] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:02] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:02] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:02] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:02] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:09] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:09] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:09] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:10] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:14] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:14] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:14] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:15] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:15] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:15] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:15] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:15] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:18] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:18] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:19] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:19] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:25] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:25] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:25] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n [09:45:25] src/pass/vectorize_loop.cc:303: Detect vector condition in Vectorized Loop, scalarizing...\n ok\n test_topi_conv2d_nchw.test_conv2d_nchw ... ok\n test_topi_dense.test_dense ... ok\n test_topi_depthwise_conv2d.test_depthwise_conv2d ... ok\n test_topi_depthwise_conv2d_back_input.test_topi_depthwise_conv2d_backward_input_nhwc ... ok\n test_topi_depthwise_conv2d_back_weight.test_topi_depthwise_conv2d_backward_weight_nhwc ... ok\n test_topi_dilate.test_dilate ... ok\n test_topi_pooling.test_pool ... ok\n test_topi_pooling.test_global_pool ... ok\n test_topi_reduce.test_reduce_map ... [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03c36af960)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f03c3bba530)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp, 0x7f03c36aa150)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03c38e3cf0)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f03b61214b0)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03b9dd8890)\n [09:49:04] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f03b5b0db20)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp, 0x7f03c3bba530)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03c38ff430)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f03c8be7ee0)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03c3613670)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f0378e244a0)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp, 0x7f03c1938520)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.repl, 0x7f03c38b7820)\n [09:49:05] src/schedule/bound.cc:98: not in feed graph consumer = compute(compute_red_temp.rf, 0x7f03c3613670)\n ok\n test_topi_relu.test_relu ... ok\n test_topi_relu.test_leaky_relu ... ok\n test_topi_softmax.test_softmax ... ok\n test_topi_softmax.test_log_softmax ... ok\n test_topi_transform.test_expand_dims ... ok\n test_topi_transform.test_tranpose ... ok\n test_topi_transform.test_reshape ... ok\n test_topi_transform.test_squeeze ... ok\n test_topi_transform.test_concatenate ... ok\n test_topi_transform.test_split ... ok\n \n ----------------------------------------------------------------------\n Ran 26 tests in 261.625s\n \n OK\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_clip.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_conv2d.verify_conv2d.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_conv2d_hwcn.verify_hwcn.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_conv2d.verify_con2d_nchw.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_dense.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_depthwise_conv2d.nchw.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_depthwise_conv2d.nhwc.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_depthwise_conv2d_backward_input.nhwc.get_ref_data.pkl\n Save memoize result to .pkl_memoize_py3/topi.tests.test_topi_depthwise_conv2d_backward_weight.nhwc.get_ref_data.pkl\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "163c479505cb2d3c31c353029dde2fe738ecf9f4", "commit_author": "Tianqi Chen", "commitT": "2017-10-15 11:54:33-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\codegen\\llvm\\codegen_amdgpu.cc", "file_new_name": "src\\codegen\\llvm\\codegen_amdgpu.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "134,135,136,137,139,140,142,143,145,147", "deleted_lines": "134,135,136,137,138,139,140,141,143,145,147", "method_info": {"method_name": "tvm::codegen::DetectROCMComputeVersion", "method_params": "", "method_startline": "134", "method_endline": "147"}}, "hunk_1": {"Ismethod": 1, "added_lines": "149,150,151,152,153,154,155,156", "deleted_lines": "150,151,152,153,162", "method_info": {"method_name": "tvm::codegen::BuildAMDGPU", "method_params": "funcs,target", "method_startline": "149", "method_endline": "192"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\codegen\\llvm\\codegen_llvm.cc", "file_new_name": "src\\codegen\\llvm\\codegen_llvm.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "585,589,593,594", "deleted_lines": "591,592", "method_info": {"method_name": "tvm::codegen::CodeGenLLVM::CreateIntrinsic", "method_params": "op", "method_startline": "527", "method_endline": "600"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\codegen\\llvm\\codegen_nvptx.cc", "file_new_name": "src\\codegen\\llvm\\codegen_nvptx.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151", "deleted_lines": "136,137,138", "method_info": {"method_name": "tvm::codegen::DetectCUDAComputeVersion", "method_params": "", "method_startline": "133", "method_endline": "151"}}, "hunk_1": {"Ismethod": 1, "added_lines": "156,157,158,159,160", "deleted_lines": null, "method_info": {"method_name": "tvm::codegen::BuildNVPTX", "method_params": "funcs,target", "method_startline": "153", "method_endline": "183"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "topi\\python\\topi\\generic\\injective.py", "file_new_name": "topi\\python\\topi\\generic\\injective.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25", "deleted_lines": null, "method_info": {"method_name": "schedule_injective", "method_params": "outs", "method_startline": "8", "method_endline": "30"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "topi\\python\\topi\\generic\\nn.py", "file_new_name": "topi\\python\\topi\\generic\\nn.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "9", "deleted_lines": null, "method_info": {"method_name": "_default_schedule", "method_params": "outs,auto_inline", "method_startline": "6", "method_endline": "17"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "topi\\recipe\\gemm\\cuda_gemm_square.py", "file_new_name": "topi\\recipe\\gemm\\cuda_gemm_square.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "127,128,131", "deleted_lines": "127,128,131", "method_info": {"method_name": "test_gemm", "method_params": "", "method_startline": "28", "method_endline": "132"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "topi\\tests\\python\\test_topi_reduce.py", "file_new_name": "topi\\tests\\python\\test_topi_reduce.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "77,78", "deleted_lines": "78", "method_info": {"method_name": "verify_reduce_map_ele", "method_params": "in_shape,axis,keepdims,type", "method_startline": "28", "method_endline": "78"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "topi\\tests\\python\\test_topi_softmax.py", "file_new_name": "topi\\tests\\python\\test_topi_softmax.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62", "deleted_lines": "45,46,63", "method_info": {"method_name": "verify_log_softmax", "method_params": "m,n", "method_startline": "40", "method_endline": "63"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "topi\\tests\\python\\test_topi_transform.py", "file_new_name": "topi\\tests\\python\\test_topi_transform.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "140,141", "deleted_lines": "123,124,125,126", "method_info": {"method_name": "verify_split", "method_params": "src_shape,indices_or_sections,axis", "method_startline": "121", "method_endline": "141"}}, "hunk_1": {"Ismethod": 1, "added_lines": "46,47", "deleted_lines": null, "method_info": {"method_name": "verify_tranpose", "method_params": "in_shape,axes", "method_startline": "28", "method_endline": "47"}}, "hunk_2": {"Ismethod": 1, "added_lines": "94,95", "deleted_lines": "72,73,74", "method_info": {"method_name": "verify_squeeze", "method_params": "src_shape,axis", "method_startline": "72", "method_endline": "95"}}, "hunk_3": {"Ismethod": 1, "added_lines": "24,25", "deleted_lines": "24,25", "method_info": {"method_name": "verify_expand_dims", "method_params": "in_shape,out_shape,axis,num_newaxis", "method_startline": "6", "method_endline": "25"}}, "hunk_4": {"Ismethod": 1, "added_lines": "170", "deleted_lines": null, "method_info": {"method_name": "test_concatenate", "method_params": "", "method_startline": "169", "method_endline": "177"}}, "hunk_5": {"Ismethod": 1, "added_lines": "117,118", "deleted_lines": "98,99,100,101", "method_info": {"method_name": "verify_concatenate", "method_params": "shapes,axis", "method_startline": "97", "method_endline": "118"}}, "hunk_6": {"Ismethod": 1, "added_lines": "68,69", "deleted_lines": "50,51", "method_info": {"method_name": "verify_reshape", "method_params": "src_shape,dst_shape", "method_startline": "50", "method_endline": "69"}}}}}}}