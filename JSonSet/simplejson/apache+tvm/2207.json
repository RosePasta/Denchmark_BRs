{"BR": {"BR_id": "2207", "BR_author": "ajtulloch", "BRopenT": "2018-11-30T19:54:45Z", "BRcloseT": "2018-12-01T00:30:49Z", "BR_text": {"BRsummary": "Supporting reduction domains where the RDom depends on axis variables?", "BRdescription": "\n Here's a minimized example of a compute declaration that I would have thought should be able to be handled by TVM. Essentially, we want the range of our summation variable to be dependent on the value stored in  corresponding length tensor. For example:\n def func(Elements, Lengths):\n     def f(n, d):\n         rg = tvm.reduce_axis((0, Lengths[n]))\n         return tvm.sum(Elements[rg, d], axis=rg)\n \n     (N,) = get_const_tuple(Lengths.shape)\n     (_, D) = get_const_tuple(Elements.shape)\n     return tvm.compute((N, D), f, name=\"Y\")\n The generated IR (from tvm.lower(..) looks like:\n <denchmark-code>produce Y {\n   for (n, 0, 10) {\n     for (d, 0, 128) {\n       Y[((n*128) + d)] = 0.000000f\n       for (rv, 0, Lengths[n]) {\n         Y[((n*128) + d)] = (Y[((n*128) + d)] + Elements[(d + (rv*128))])\n       }\n     }\n   }\n }\n </denchmark-code>\n \n which seems reasonable.  Unfortunately, tvm.build fails with\n tvm._ffi.base.TVMError: [11:49:26] /Users/tulloch/src/tvm/src/pass/make_api.cc:169: Not all Vars are passed in api_args:  'n'  does not appeared in api_args,\n that is, the variable n used in the rg RDom seems to be duplicated from it's definition as the axis used in the computation of Y.\n For a full repro, try:\n from topi.util import get_const_tuple\n import tvm\n \n def func(Elements, Lengths):\n     def f(n, d):\n         rg = tvm.reduce_axis((0, Lengths[n]))\n         return tvm.sum(Elements[rg, d], axis=rg)\n \n     (N,) = get_const_tuple(Lengths.shape)\n     (_, D) = get_const_tuple(Elements.shape)\n     return tvm.compute((N, D), f, name=\"Y\")\n \n def run(N, I, D):\n     Elements = tvm.placeholder(shape=(I, D), dtype=\"float32\", name=\"Elements\")\n     Lengths = tvm.placeholder(shape=(N,), dtype=\"int32\", name=\"Lengths\")\n     Y = func(Elements, Lengths)\n     s = tvm.create_schedule([Y.op])\n     print(tvm.lower(s, [Elements, Lengths, Y], simple_mode=True))\n     print(tvm.save_json(Y))\n     f = tvm.build(s, [Elements, Lengths, Y], target=\"llvm\")\n \n run(N=10, I=10, D=128)\n Is it reasonable to expect this to work? If so,\n (For reference, the full IR from tvm.save_json(..) for this expression looks like:\n {\n   \"root\": 1, \n   \"nodes\": [\n     {\n       \"type_key\": \"\"\n     }, \n     {\n       \"type_key\": \"Tensor\", \n       \"attrs\": {\n         \"dtype\": \"float32\", \n         \"op\": \"5\", \n         \"shape\": \"2\", \n         \"value_index\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [3, 4]\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"10\"\n       }\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"128\"\n       }\n     }, \n     {\n       \"type_key\": \"ComputeOp\", \n       \"attrs\": {\n         \"attrs\": \"6\", \n         \"axis\": \"7\", \n         \"body\": \"27\", \n         \"name\": \"Y\", \n         \"reduce_axis\": \"16\", \n         \"tag\": \"\"\n       }\n     }, \n     {\n       \"type_key\": \"StrMap\"\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [8, 12]\n     }, \n     {\n       \"type_key\": \"IterVar\", \n       \"attrs\": {\n         \"dom\": \"9\", \n         \"iter_type\": \"0\", \n         \"thread_tag\": \"\", \n         \"var\": \"11\"\n       }\n     }, \n     {\n       \"type_key\": \"Range\", \n       \"attrs\": {\n         \"extent\": \"3\", \n         \"min\": \"10\"\n       }\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Variable\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"name\": \"n\"\n       }\n     }, \n     {\n       \"type_key\": \"IterVar\", \n       \"attrs\": {\n         \"dom\": \"13\", \n         \"iter_type\": \"0\", \n         \"thread_tag\": \"\", \n         \"var\": \"15\"\n       }\n     }, \n     {\n       \"type_key\": \"Range\", \n       \"attrs\": {\n         \"extent\": \"4\", \n         \"min\": \"14\"\n       }\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Variable\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"name\": \"d\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [17]\n     }, \n     {\n       \"type_key\": \"IterVar\", \n       \"attrs\": {\n         \"dom\": \"18\", \n         \"iter_type\": \"2\", \n         \"thread_tag\": \"\", \n         \"var\": \"26\"\n       }\n     }, \n     {\n       \"type_key\": \"Range\", \n       \"attrs\": {\n         \"extent\": \"20\", \n         \"min\": \"19\"\n       }\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Call\", \n       \"attrs\": {\n         \"args\": \"21\", \n         \"call_type\": \"3\", \n         \"dtype\": \"int32\", \n         \"func\": \"22\", \n         \"name\": \"Lengths\", \n         \"value_index\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [11]\n     }, \n     {\n       \"type_key\": \"PlaceholderOp\", \n       \"attrs\": {\n         \"attrs\": \"23\", \n         \"dtype\": \"int32\", \n         \"name\": \"Lengths\", \n         \"shape\": \"24\", \n         \"tag\": \"\"\n       }\n     }, \n     {\n       \"type_key\": \"StrMap\"\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [25]\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"10\"\n       }\n     }, \n     {\n       \"type_key\": \"Variable\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"name\": \"rv\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [28]\n     }, \n     {\n       \"type_key\": \"Reduce\", \n       \"attrs\": {\n         \"axis\": \"16\", \n         \"combiner\": \"29\", \n         \"condition\": \"46\", \n         \"dtype\": \"float32\", \n         \"source\": \"38\", \n         \"value_index\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"CommReducer\", \n       \"attrs\": {\n         \"identity_element\": \"36\", \n         \"lhs\": \"30\", \n         \"result\": \"34\", \n         \"rhs\": \"32\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [31]\n     }, \n     {\n       \"type_key\": \"Variable\", \n       \"attrs\": {\n         \"dtype\": \"float32\", \n         \"name\": \"x\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [33]\n     }, \n     {\n       \"type_key\": \"Variable\", \n       \"attrs\": {\n         \"dtype\": \"float32\", \n         \"name\": \"y\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [35]\n     }, \n     {\n       \"type_key\": \"Add\", \n       \"attrs\": {\n         \"a\": \"31\", \n         \"b\": \"33\", \n         \"dtype\": \"float32\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [37]\n     }, \n     {\n       \"type_key\": \"FloatImm\", \n       \"attrs\": {\n         \"dtype\": \"float32\", \n         \"value\": \"0.000000\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [39]\n     }, \n     {\n       \"type_key\": \"Call\", \n       \"attrs\": {\n         \"args\": \"40\", \n         \"call_type\": \"3\", \n         \"dtype\": \"float32\", \n         \"func\": \"41\", \n         \"name\": \"Elements\", \n         \"value_index\": \"0\"\n       }\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [26, 15]\n     }, \n     {\n       \"type_key\": \"PlaceholderOp\", \n       \"attrs\": {\n         \"attrs\": \"42\", \n         \"dtype\": \"float32\", \n         \"name\": \"Elements\", \n         \"shape\": \"43\", \n         \"tag\": \"\"\n       }\n     }, \n     {\n       \"type_key\": \"StrMap\"\n     }, \n     {\n       \"type_key\": \"Array\", \n       \"data\": [44, 45]\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"10\"\n       }\n     }, \n     {\n       \"type_key\": \"IntImm\", \n       \"attrs\": {\n         \"dtype\": \"int32\", \n         \"value\": \"128\"\n       }\n     }, \n     {\n       \"type_key\": \"UIntImm\", \n       \"attrs\": {\n         \"dtype\": \"uint1\", \n         \"value\": \"1\"\n       }\n     }\n   ], \n   \"b64ndarrays\": [], \n   \"attrs\": {\"tvm_version\": \"0.5.dev\"}\n }\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ajtulloch", "commentT": "2018-11-30T20:57:27Z", "comment_text": "\n \t\tThanks, <denchmark-link:https://github.com/ajtulloch>@ajtulloch</denchmark-link>\n  for reporting this, it is a fun bug to catch. The main of the problem cause is we call substitution too early only on the loop body before.\n Should be fixed by <denchmark-link:https://github.com/apache/tvm/pull/2208>#2208</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ajtulloch", "commentT": "2018-12-01T00:18:24Z", "comment_text": "\n \t\tThanks for the fix <denchmark-link:https://github.com/tqchen>@tqchen</denchmark-link>\n , this looks great. It should make certain sparse operations much easier to implement (and more generalizable), without having to fallback into extern ops. Thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ajtulloch", "commentT": "2018-12-05T09:13:42Z", "comment_text": "\n \t\tWhen we use:\n \n di= tvm.reduce_axis(( indice[axis] , M), name='di')\n \n tvm.build error\uff1a\n make_api.cc:184: Not all Vars are passed in api_args:  'i0'  does not appeared in api_args\n \n di= tvm.reduce_axis(( M , indice[axis] ), name='di')\n tvm.build\uff1aok\n \n why?  indice[axis]=i0,  is  a axis variables. M is a  constant.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "ajtulloch", "commentT": "2018-12-05T22:43:07Z", "comment_text": "\n \t\t@Foundea could you produce a minimal runnable example, similar to e.g.\n from topi.util import get_const_tuple\n import tvm\n \n def func(Elements, Lengths):\n     def f(n, d):\n         rg = tvm.reduce_axis((0, Lengths[n]))\n         return tvm.sum(Elements[rg, d], axis=rg)\n \n     (N,) = get_const_tuple(Lengths.shape)\n     (_, D) = get_const_tuple(Elements.shape)\n     return tvm.compute((N, D), f, name=\"Y\")\n \n def run(N, I, D):\n     Elements = tvm.placeholder(shape=(I, D), dtype=\"float32\", name=\"Elements\")\n     Lengths = tvm.placeholder(shape=(N,), dtype=\"int32\", name=\"Lengths\")\n     Y = func(Elements, Lengths)\n     s = tvm.create_schedule([Y.op])\n     print(tvm.lower(s, [Elements, Lengths, Y], simple_mode=True))\n     print(tvm.save_json(Y))\n     f = tvm.build(s, [Elements, Lengths, Y], target=\"llvm\")\n \n run(N=10, I=10, D=128)\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "ajtulloch", "commentT": "2018-12-14T01:17:33Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ajtulloch>@ajtulloch</denchmark-link>\n  <denchmark-link:https://github.com/tqchen>@tqchen</denchmark-link>\n \n \n Hi all. This is a very interesting problem.\n I use the bug fixed version of tvm, and I edited this case a little, add cache_read/cache_write in schedule part.\n \n from topi.util import get_const_tuple\n import tvm\n \n def func(Elements, Lengths):\n     def f(n, d):\n         rg = tvm.reduce_axis((0, Lengths[n]))\n         return tvm.sum(Elements[rg, d], axis=rg)\n \n     (N,) = get_const_tuple(Lengths.shape)\n     (_, D) = get_const_tuple(Elements.shape)\n     return tvm.compute((N, D), f, name=\"Y\")\n \n def run(N, I, D):\n     Elements = tvm.placeholder(shape=(I, D), dtype=\"float32\", name=\"Elements\")\n     Lengths = tvm.placeholder(shape=(N,), dtype=\"int32\", name=\"Lengths\")\n     Y = func(Elements, Lengths)\n     s = tvm.create_schedule([Y.op])\n     Elements_local = s.cache_read(Elements, \"local\", [Y])\n     Lengths_local = s.cache_read(Lengths, \"local\", [Y])\n     Y_local = s.cache_write(Y, \"local\")\n     print(tvm.lower(s, [Elements, Lengths, Y], simple_mode=True))\n     #print(tvm.save_json(Y))\n     #f = tvm.build(s, [Elements, Lengths, Y], target=\"llvm\")\n \n run(N=10, I=10, D=128)\n \n Unfortunately, tvm.lower() fails with\n \n <denchmark-code>tvm._ffi.base.TVMError: [08:42:49] /home/dylan/tvm/src/schedule/schedule_dataflow_rewrite.cc:166: Check failed: iv->iter_type == kDataPar (2 vs. 0) Can only relayout with in data parallel dimensions\n </denchmark-code>\n \n \n I don't known what is the main of the problem cause. I guess the problem is cause by the\n \n <denchmark-code>rg = tvm.reduce_axis((0, Lengths[n]))\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "6d32037c64e2acbfbbcd4efc8d8781b944bc74ea", "commit_author": "Tianqi Chen", "commitT": "2018-11-30 16:05:04-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\op\\compute_op.cc", "file_new_name": "src\\op\\compute_op.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "325,333,335,337,338,339,345,346,347,348,349", "deleted_lines": "324,331,334,336,343,344", "method_info": {"method_name": "tvm::MakeComputeStmt", "method_params": "", "method_startline": "307", "method_endline": "351"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\python\\unittest\\test_schedule_schedule_ops.py", "file_new_name": "tests\\python\\unittest\\test_schedule_schedule_ops.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "412,413,414,415,416,417,418,419", "deleted_lines": null, "method_info": {"method_name": "test_loop_dep_reduce", "method_params": "", "method_startline": "412", "method_endline": "419"}}, "hunk_1": {"Ismethod": 1, "added_lines": "414,415,416", "deleted_lines": null, "method_info": {"method_name": "test_loop_dep_reduce.f", "method_params": "n", "method_startline": "414", "method_endline": "416"}}}}}}}