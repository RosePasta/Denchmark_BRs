{"BR": {"BR_id": "183", "BR_author": "yijingchen", "BRopenT": "2019-07-22T19:55:20Z", "BRcloseT": "2019-07-30T21:43:09Z", "BR_text": {"BRsummary": "[BUG] Cannot set up nlp_gpu environment", "BRdescription": "\n <denchmark-h:h3>Description</denchmark-h>\n \n The following errors showing up while setting up the GPU environment:\n \n Collecting package metadata: done\n Solving environment: failed\n ResolvePackageNotFound:\n cudatoolkit==9.2\n \n <denchmark-link:https://user-images.githubusercontent.com/12163908/61660164-1a620900-ac7e-11e9-90e5-2eca055fba40.png></denchmark-link>\n \n <denchmark-h:h3>How do we replicate the bug?</denchmark-h>\n \n Machine: Microsoft Azure Deep Learning Virtual Machine Standard NC6\n Operation System: Windows\n Code:\n cd nlp\n python tools/generate_conda_file.py --gpu\n conda env create -n nlp_gpu -f nlp_gpu.yaml \n <denchmark-h:h3>Expected behavior (i.e. solution)</denchmark-h>\n \n The installation should complete without errors.\n <denchmark-h:h3>Other Comments</denchmark-h>\n \n I changed some package version in yaml file to this:\n \n cudatoolkit>=9.2\n tensorflow-gpu>=1.12.0\n \n The installation proceed with the above configuration, however another error occur which shows below:\n ----------------------------------------\n ERROR: Command \"'C:\\Anaconda\\envs\\nlp_gpu\\python.exe' -u -c 'import setuptools, tokenize;file='\"'\"'C:\\Users\\adminyijing\\AppData\\Local\\Temp\\2\\pip-install-9454380z\\horovod\\setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(file);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, file, '\"'\"'exec'\"'\"'))' install --record 'C:\\Users\\adminyijing\\AppData\\Local\\Temp\\2\\pip-record-su74tqwf\\install-record.txt' --single-version-externally-managed --compile\" failed with error code 1 in C:\\Users\\adminyijing\\AppData\\Local\\Temp\\2\\pip-install-9454380z\\horovod\\\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yijingchen", "commentT": "2019-07-23T06:25:13Z", "comment_text": "\n \t\tthis bug is new, a few suggestions:\n \n Can you make sure that cuda libs are configured correctly? nvidia-smi\n Can you update conda and try again? conda update -n base -c defaults conda\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yijingchen", "commentT": "2019-07-23T12:24:56Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  Does nvidia-smi work on Windows, which is the platform used by <denchmark-link:https://github.com/yijingchen>@yijingchen</denchmark-link>\n ?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yijingchen", "commentT": "2019-07-23T12:27:14Z", "comment_text": "\n \t\tIt is at \"\\Program Files\\NVIDIA Corporation\\NVSMI\\nvidia-smi.exe\"\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yijingchen", "commentT": "2019-07-24T05:24:23Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  <denchmark-link:https://github.com/saidbleik>@saidbleik</denchmark-link>\n   I did many tests today on two window DSVMs.\n Here are things I tried but didn't work:\n \n Checked nvidia-smi\n Did `conda update -n base -c defaults conda\n Downloaded and installed the cudatoolkit from NVIDA website\n \n Here are steps how I got it working:\n \n Set up the 'nlp_gpu' environment without the line cudatoolkit=9.2. This step complete without error. (FYI, I always get this Running setup.py install for horovod: finished with status 'error' in the end of the setup. Not sure if this will impact anything.)\n \n Re-install pytorch with this: conda install pytorch torchvision cudatoolkit=9.0 -c pytorch. Now I can see the GPU is accessible by the package. Besides this, I tested with a notebook using GPU and it works as well.\n \n \n Summary:\n \n Windows DSVM already have cudatoolkit installed, so this is not the issue. For users who don't have the cudatoolkit, the instruction @saidbleik added should be good enough.\n It seems that if we want deep learning package recognize the GPU on windows, we need to install it with different command. Either we update the yaml or add extra instructions.\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yijingchen", "commentT": "2019-07-24T20:59:07Z", "comment_text": "\n \t\tcan you try:\n <denchmark-code>conda activate nlp_gpu\n python -c \"import horovod.tensorflow as hvd\"\n \n </denchmark-code>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "yijingchen", "commentT": "2019-07-24T22:52:25Z", "comment_text": "\n \t\tAfter running your command, it shows: ModuleNotFoundError: No module named 'horovod'\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "yijingchen", "commentT": "2019-07-25T10:43:47Z", "comment_text": "\n \t\they <denchmark-link:https://github.com/yijingchen>@yijingchen</denchmark-link>\n  <denchmark-link:https://github.com/marabout2015>@marabout2015</denchmark-link>\n  can you try and review this <denchmark-link:https://github.com/microsoft/nlp-recipes/pull/196>#196</denchmark-link>\n ?\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "yijingchen", "commentT": "2019-07-25T19:43:36Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  I tried it on the windows DSVM, now the horovod error is gone and  can be completed without error.\n However, even the environment set up is successful, the pytorch we installed cannot recognize cuda devices on the windows DSVM even it already have cudatoolkit installed. I have to re-install pytorch with this command conda install pytorch torchvision cudatoolkit=9.0 -c pytorch. I'm not sure if this is a pytorch issue or windows issue.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "yijingchen", "commentT": "2019-07-25T22:41:31Z", "comment_text": "\n \t\t\n However, even the environment set up is successful, the pytorch we installed cannot recognize cuda devices on the windows DSVM\n \n What is the error you are getting?\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "yijingchen", "commentT": "2019-07-26T02:37:24Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  There is no error after the environment set up. I found this when running the embedding notebook. It has warning that no GPU found, using CPU instead. Also if you run the following command in python after the enviroment setup, this is the result.\n \n \n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "yijingchen", "commentT": "2019-07-26T10:14:37Z", "comment_text": "\n \t\tmmm I think we are going in circles, in this PR <denchmark-link:https://github.com/microsoft/nlp-recipes/pull/189>#189</denchmark-link>\n  we removed cuda toolkit because there were problems with windows, but now you are saying that you installed it with conda in windows and it worked. Should we then add it back?\n FYI <denchmark-link:https://github.com/awaemmanuel>@awaemmanuel</denchmark-link>\n  <denchmark-link:https://github.com/saidbleik>@saidbleik</denchmark-link>\n \n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "yijingchen", "commentT": "2019-07-26T13:10:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  <denchmark-link:https://github.com/saidbleik>@saidbleik</denchmark-link>\n  - The issues with Windows is more than just Cuda. I hit the Horovod, Pytorch, Torch and Tensorflow-gpu issue as well. Even for a conda environment. That's why I added the ceveat now that Windows is not  now. I think we should add back cuda to the yaml file for now, remove the instructions to have it manually installed and investigate more on a better fix for Windows.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "yijingchen", "commentT": "2019-07-26T18:57:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/miguelgfierro>@miguelgfierro</denchmark-link>\n  below is a summary to help you better understand the issues we hit and related solutions we found so far. I can write up a guide for DSVM window user and create a pull request for it. As for linux setup, I agree with <denchmark-link:https://github.com/awaemmanuel>@awaemmanuel</denchmark-link>\n  point, you can add back cuda to yaml. We can have seperate guideline just for windows user.\n \n Issue: The issue here is the package version is not found, not that windows can't install cudatoolkit package.\n \n \n ResolvePackageNotFound:\n cudatoolkit==9.2\n \n Solution:\n Change cudatoolkit==9.2 to cudatoolkit==9 or cudatoolkit>=9.2\n \n Issue:\n \n \n Running setup.py install for horovod: finished with status 'error'\n \n Solution:\n <denchmark-link:https://github.com/microsoft/nlp-recipes/pull/196>#196</denchmark-link>\n \n \n Issue: pytorch cannot recognize cuda device\n \n \n import torch\n torch.cuda.is_available()\n False\n \n Solution:\n Run this command after enviroment setup conda install pytorch torchvision cudatoolkit=9.0 -c pytorch\n \t\t"}}}, "commit": {"commit_id": "53fbd29d543c5aad31a6cd5759fe9f86bb0be69d", "commit_author": "miguelgfierro", "commitT": "2019-07-25 11:40:24+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tools\\generate_conda_file.py", "file_new_name": "tools\\generate_conda_file.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,17,85,86,87,88,89,90,91,126,127,128,129,130,131,132,133,134,135,136,137", "deleted_lines": "83"}}}}}}