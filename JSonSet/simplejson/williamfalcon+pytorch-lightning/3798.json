{"BR": {"BR_id": "3798", "BR_author": "chiragraman", "BRopenT": "2020-10-02T15:24:34Z", "BRcloseT": "2020-10-04T22:47:22Z", "BR_text": {"BRsummary": "User Deprecation Warning thrown even if user does not override `validation_epoch_end`", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n From <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/issues/3789>#3789</denchmark-link>\n  additional context. If the user does not override  a warning is still thrown reading: \n I tracked this down to this snippet:\n \n \n \n pytorch-lightning/pytorch_lightning/trainer/evaluation_loop.py\n \n \n         Lines 197 to 222\n       in\n       0c12065\n \n \n \n \n \n \n  eval_results = outputs \n \n \n \n  if num_dataloaders == 1: \n \n \n \n  eval_results = outputs[0] \n \n \n \n  \n \n \n \n  user_reduced = False \n \n \n \n  \n \n \n \n  if self.testing: \n \n \n \n  if is_overridden('test_epoch_end', model=model): \n \n \n \n  model._current_fx_name = 'test_epoch_end' \n \n \n \n  if using_eval_result: \n \n \n \n  eval_results = self.__gather_epoch_end_eval_results(outputs) \n \n \n \n  \n \n \n \n  eval_results = model.test_epoch_end(eval_results) \n \n \n \n  user_reduced = True \n \n \n \n  \n \n \n \n  else: \n \n \n \n  if is_overridden('validation_epoch_end', model=model): \n \n \n \n  model._current_fx_name = 'validation_epoch_end' \n \n \n \n  if using_eval_result: \n \n \n \n  eval_results = self.__gather_epoch_end_eval_results(outputs) \n \n \n \n  \n \n \n \n  eval_results = model.validation_epoch_end(eval_results) \n \n \n \n  user_reduced = True \n \n \n \n  \n \n \n \n  # depre warning \n \n \n \n  if eval_results is not None: \n \n \n \n \n \n The problem is that eval_results contains the outputs if validation_epoch_end is not overriden by the user. I believe the test in line 222 should be updated to\n if eval_results is not None and user_reduced is True:\n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n Run a model without overriding validation_epoch_end and have a single eval data loader.\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n No user warning should be thrown if the user hasn't overriden  validation_epoch_end\n <denchmark-h:h3>Environment</denchmark-h>\n \n CUDA:\n \n GPU:\n Quadro P4000\n available: True\n version: 10.2\n Packages:\n numpy: 1.19.1\n pyTorch_debug: False\n pyTorch_version: 1.6.0\n pytorch-lightning: 0.9.1rc4\n tqdm: 4.48.2\n System:\n OS: Linux\n architecture:\n 64bit\n ELF\n processor: x86_64\n python: 3.8.5\n version: #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020\n \n <denchmark-h:h3>Additional context</denchmark-h>\n \n Could have issued a PR if this seems okay but got the message there is a freeze on PRs.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "chiragraman", "commentT": "2020-10-03T01:48:11Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/williamFalcon>@williamFalcon</denchmark-link>\n  <denchmark-link:https://github.com/Borda>@Borda</denchmark-link>\n \n This is definitely not addressed by <denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/3800>#3800</denchmark-link>\n , I pulled and retested. I also don't see why it should, since the problem is in a different place than what either of the two referenced PRs address.\n Like I mentioned in the original report, the cause is that the warning should be thrown only if the user has attempted to reduce validation_step outputs in validation_epoch_end and returned something explicitly. The problem is that only eval_results is being checked, which is set to hold the output even if the user hasn't overriden  validation_epoch_end.\n <denchmark-h:hr></denchmark-h>\n \n The solution is to replace line 222 in the file evaluation_loop with the following:\n if eval_results is not None and user_reduced is True:\n instead of\n if eval_results is not None:\n <denchmark-h:hr></denchmark-h>\n \n Would have been happy to issue a PR but I can't, but please don't close this one on account of the referenced PRs, they do not address the core problem, which is a faulty check.\n \t\t"}}}, "commit": {"commit_id": "00f0d19a61b97c56ee303b2b4cab018c0a6183bb", "commit_author": "William Falcon", "commitT": "2020-10-04 19:36:51-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pytorch_lightning\\trainer\\__init__.py", "file_new_name": "pytorch_lightning\\trainer\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "49", "deleted_lines": "49"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "file_new_name": "pytorch_lightning\\trainer\\evaluation_loop.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "226", "deleted_lines": "226", "method_info": {"method_name": "__run_eval_epoch_end", "method_params": "self,num_dataloaders,using_eval_result", "method_startline": "196", "method_endline": "238"}}}}, "file_2": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tests\\trainer\\warnings\\__init__.py", "file_new_name": "tests\\trainer\\warnings\\__init__.py"}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tests\\trainer\\warnings\\test_flow_warnings.py"}}}}