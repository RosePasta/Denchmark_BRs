{"BR": {"BR_id": "14833", "BR_author": "roywei", "BRopenT": "2019-04-29T15:26:33Z", "BRcloseT": "2019-05-21T18:40:48Z", "BR_text": {"BRsummary": "[Numpy][Keras-MXNet] Infer shape partial failed for unknown shapes", "BRdescription": "\n I came from a user reported issue here: <denchmark-link:https://github.com/apache/incubator-mxnet/issues/14751#issuecomment-486866935>#14751 (comment)</denchmark-link>\n \n Currently latest MXNet does not work with Keras-MXNet(v2.2.4.1)\n In <denchmark-link:https://github.com/apache/incubator-mxnet/pull/14661>#14661</denchmark-link>\n , unknown shape in mxnet was represented using , and changed to , this brought some unexpected behavior on  of some of the operators in MXNet.\n As noted in the <denchmark-link:https://github.com/apache/incubator-mxnet/pull/14661>PR</denchmark-link>\n  discussion, when many operators were implemented for the first time, some strong assumption may have been made because zero-dim and zero-size tensors are not introduced.\n Also, many of these problems are not revealed in MXNet because unknown dim place holders (0 or -1) are not used often. For now, this change does not bring any other compatibility issue except in the <denchmark-link:https://github.com/awslabs/keras-apache-mxnet>keras-mxnet</denchmark-link>\n  project. Keras-MXNet relies a lot on unknown shapes and infer_shape_partial internally.\n As I'm trying to fix the problem, I m using this issue to record the operators in MXNet where the infer shape logic may be wrong.\n Following are the operators I found now, more to come:\n \n  dot\n DotShape need to return if lhs or rhs shape is unknow:\n adding the following at this line\n solves it\n \n <denchmark-code>if (!shape_is_known(lshape) || !shape_is_known(rshape)) return false;\n </denchmark-code>\n \n \n  transpose\n we were checking dim  here\n \n <denchmark-code>CHECK_LE(shp.ndim(), 6U)\n </denchmark-code>\n \n \n  pooling\n CHECK_GE, CHECK_LE\n https://github.com/apache/incubator-mxnet/blob/master/src/operator/pooling_v1-inl.h#L246\n \n fails if shp.dim() is -1 because it's comparing signed with unsigned and returning false, but -1 is lesser than 6\n Thanks, <denchmark-link:https://github.com/reminisce>@reminisce</denchmark-link>\n  for the help to identify these issues, I'm still trying to come up with the full list of ops impacted as I need to convert keras-mxnet bugs to pure mxnet root cause.\n cc <denchmark-link:https://github.com/junrushao1994>@junrushao1994</denchmark-link>\n  <denchmark-link:https://github.com/sandeep-krishnamurthy>@sandeep-krishnamurthy</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "roywei", "commentT": "2019-04-29T15:26:37Z", "comment_text": "\n \t\tHey, this is the MXNet Label Bot.\n Thank you for submitting the issue! I will try and suggest some labels so that the appropriate MXNet community members can help resolve it.\n Here are my recommended labels: Feature\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "roywei", "commentT": "2019-04-29T15:52:37Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mxnet-label-bot>@mxnet-label-bot</denchmark-link>\n  add [Bug, Numpy, Operator]\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "roywei", "commentT": "2019-07-22T17:57:54Z", "comment_text": "\n \t\tThis does not yet appear fixed with keras-mxnet 2.2.4.1 and mxnet 1.5.0\n <denchmark-code>mxnet.base.MXNetError: Invalid Parameter format for lrs expect tuple of <float> but value='[_mulscalar7:[tensor=True dtype=float32], _mulscalar9:[tensor=True dtype=float32], _mulscalar11:[tensor=True dtype=float32], _mulscalar13:[tensor=True dtype=float32]]', in operator multi_sgd_mom_update(name=\"\", rescale_grad=\"1.0\", momentum=\"0.9\", wds=\"[0.0, 0.0, 0.0, 0.0]\", lrs=\"[_mulscalar7:[tensor=True dtype=float32], _mulscalar9:[tensor=True dtype=float32], _mulscalar11:[tensor=True dtype=float32], _mulscalar13:[tensor=True dtype=float32]]\", num_weights=\"4\")\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "roywei", "commentT": "2019-07-22T21:25:22Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/iamthebot>@iamthebot</denchmark-link>\n  , we just released MXNet 1.5.0, and keras-mxnet will release 2.2.4.2 in next week or so. Then it will be fixed. Tracked here: <denchmark-link:https://github.com/awslabs/keras-apache-mxnet/issues/234>awslabs/keras-apache-mxnet#234</denchmark-link>\n \n The fix require change on both MXNet and keras-mxnet. change on keras-mxnet is only available in master branch and need to build from source to install for now\n \t\t"}}}, "commit": {"commit_id": "5854b98c0a2c3755af2a8df3235af0266f7bfcd5", "commit_author": "Lai Wei", "commitT": "2019-05-21 11:40:46-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\instance_norm-inl.h", "file_new_name": "src\\operator\\instance_norm-inl.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "116", "deleted_lines": "116", "method_info": {"method_name": "mxnet::op::InstanceNormOp::Backward", "method_params": "ctx,out_grad,in_data,out_data,req,in_grad,aux_states", "method_startline": "104", "method_endline": "185"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\operator\\l2_normalization-inl.h", "file_new_name": "src\\operator\\l2_normalization-inl.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "276,281", "deleted_lines": "276,281", "method_info": {"method_name": "mxnet::op::L2NormalizationProp::InferShape", "method_params": "in_shape,out_shape,aux_shape", "method_startline": "263", "method_endline": "287"}}, "hunk_1": {"Ismethod": 1, "added_lines": "105,123", "deleted_lines": "105,123", "method_info": {"method_name": "mxnet::op::L2NormalizationOp::Forward", "method_params": "ctx,in_data,req,out_data,aux_args", "method_startline": "76", "method_endline": "143"}}, "hunk_2": {"Ismethod": 1, "added_lines": "177,196", "deleted_lines": "177,196", "method_info": {"method_name": "mxnet::op::L2NormalizationOp::Backward", "method_params": "ctx,out_grad,in_data,out_data,req,in_grad,aux_args", "method_startline": "145", "method_endline": "217"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\l2_normalization.cc", "file_new_name": "src\\operator\\l2_normalization.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "73,97", "deleted_lines": "73,97", "method_info": {"method_name": "mxnet::op::L2NormalizationOpCPU::Forward", "method_params": "ctx,in_data,req,out_data,aux_args", "method_startline": "40", "method_endline": "123"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_convolution.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "66,67,68,72,73,74", "deleted_lines": "66,67,68,72,73,74", "method_info": {"method_name": "mxnet::op::GetConvFwdImpl", "method_params": "param,is_train,data,weights,bias,output", "method_startline": "48", "method_endline": "160"}}, "hunk_1": {"Ismethod": 1, "added_lines": "240,241,242,246,247,248", "deleted_lines": "240,241,242,246,247,248", "method_info": {"method_name": "mxnet::op::GetConvBwdWeights", "method_params": "param,data,weights,bias,output,fwd_pd", "method_startline": "229", "method_endline": "322"}}, "hunk_2": {"Ismethod": 1, "added_lines": "172,173,174,178,179,180", "deleted_lines": "172,173,174,178,179,180", "method_info": {"method_name": "mxnet::op::GetConvBwdData", "method_params": "param,data,weights,output,fwd_pd", "method_startline": "162", "method_endline": "227"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\operator\\nn\\mkldnn\\mkldnn_deconvolution.cc", "file_new_name": "src\\operator\\nn\\mkldnn\\mkldnn_deconvolution.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "93,94,95", "deleted_lines": "93,94,95", "method_info": {"method_name": "mxnet::op::GetDeconvFwdImpl", "method_params": "param,data,weights,has_bias,output", "method_startline": "86", "method_endline": "122"}}, "hunk_1": {"Ismethod": 1, "added_lines": "131,132,133", "deleted_lines": "131,132,133", "method_info": {"method_name": "mxnet::op::GetDeconvBwdDataImpl", "method_params": "param,data,weights,has_bias,output", "method_startline": "124", "method_endline": "145"}}, "hunk_2": {"Ismethod": 1, "added_lines": "156,157,158", "deleted_lines": "156,157,158", "method_info": {"method_name": "mxnet::op::GetDeconvBwdWeightsImpl", "method_params": "param,data,weights,has_bias,output,fwd_pd", "method_startline": "148", "method_endline": "197"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\nn\\pooling.cc", "file_new_name": "src\\operator\\nn\\pooling.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "109,113", "deleted_lines": "109,113", "method_info": {"method_name": "mxnet::op::PoolingShape", "method_params": "attrs,in_shape,out_shape", "method_startline": "93", "method_endline": "265"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\pooling_v1-inl.h", "file_new_name": "src\\operator\\pooling_v1-inl.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "246,248", "deleted_lines": "246,248", "method_info": {"method_name": "mxnet::op::PoolingV1Prop::InferShape", "method_params": "in_shape,out_shape,aux_shape", "method_startline": "241", "method_endline": "315"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\tensor\\broadcast_reduce_op.h", "file_new_name": "src\\operator\\tensor\\broadcast_reduce_op.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1376,1390", "deleted_lines": "1376,1390", "method_info": {"method_name": "mxnet::op::PickOpShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "1370", "method_endline": "1391"}}, "hunk_1": {"Ismethod": 1, "added_lines": "307,312", "deleted_lines": "307,312", "method_info": {"method_name": "mxnet::op::ReduceAxesShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "302", "method_endline": "313"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\tensor\\control_flow_op.h", "file_new_name": "src\\operator\\tensor\\control_flow_op.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "178", "deleted_lines": null, "method_info": {"method_name": "mxnet::op::WhereOpShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "172", "method_endline": "196"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\tensor\\dot-inl.h", "file_new_name": "src\\operator\\tensor\\dot-inl.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1210,1211,1212,1249,1250", "deleted_lines": "1246", "method_info": {"method_name": "mxnet::op::DotShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "1202", "method_endline": "1251"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1486,1487,1489,1490,1491,1492,1508,1509", "deleted_lines": "1498", "method_info": {"method_name": "mxnet::op::BatchDotShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "1478", "method_endline": "1510"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\tensor\\elemwise_binary_broadcast_op.h", "file_new_name": "src\\operator\\tensor\\elemwise_binary_broadcast_op.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "491", "deleted_lines": "491", "method_info": {"method_name": "mxnet::op::BinaryBroadcastComputeDenseEx", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "483", "method_endline": "523"}}, "hunk_1": {"Ismethod": 1, "added_lines": "455", "deleted_lines": "455", "method_info": {"method_name": "mxnet::op::BinaryBroadcastComputeSparseEx", "method_params": "attrs,ctx,inputs,req,outputs", "method_startline": "447", "method_endline": "480"}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "src\\operator\\tensor\\indexing_op.h", "file_new_name": "src\\operator\\tensor\\indexing_op.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1078", "deleted_lines": "1078", "method_info": {"method_name": "mxnet::op::BatchTakeOpShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "1067", "method_endline": "1084"}}, "hunk_1": {"Ismethod": 1, "added_lines": "148", "deleted_lines": "148", "method_info": {"method_name": "mxnet::op::EmbeddingOpShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "143", "method_endline": "162"}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\operator\\tensor\\matrix_op-inl.h", "file_new_name": "src\\operator\\tensor\\matrix_op-inl.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "347", "deleted_lines": "347", "method_info": {"method_name": "mxnet::op::TransposeShape", "method_params": "attrs,in_attrs,out_attrs", "method_startline": "340", "method_endline": "362"}}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "tests\\python\\unittest\\test_infer_shape.py", "file_new_name": "tests\\python\\unittest\\test_infer_shape.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "206,207,208,209,210,211,212,213,214,215,216,217,218", "deleted_lines": null, "method_info": {"method_name": "test_transpose_partial_shape", "method_params": "", "method_startline": "206", "method_endline": "218"}}, "hunk_1": {"Ismethod": 1, "added_lines": "194,195,196,197,198,199,200,201,202,203", "deleted_lines": null, "method_info": {"method_name": "test_embedding_partial_shape", "method_params": "", "method_startline": "194", "method_endline": "203"}}, "hunk_2": {"Ismethod": 1, "added_lines": "177,178,179,180,181,182,183,184,185,186,187,188,189,190,191", "deleted_lines": null, "method_info": {"method_name": "test_batch_dot_partial_shape", "method_params": "", "method_startline": "177", "method_endline": "191"}}, "hunk_3": {"Ismethod": 1, "added_lines": "221,222,223,224,225,226,227,228,229,230", "deleted_lines": null, "method_info": {"method_name": "test_pick_partial_shape", "method_params": "", "method_startline": "221", "method_endline": "230"}}, "hunk_4": {"Ismethod": 1, "added_lines": "233,234,235,236,237,238,239,240,241,242,243,244,245,246,247", "deleted_lines": null, "method_info": {"method_name": "test_where_partial_shape", "method_params": "", "method_startline": "233", "method_endline": "247"}}, "hunk_5": {"Ismethod": 1, "added_lines": "165,166,167,168,169,170,171,172,173,174", "deleted_lines": "166,167,168,169,170,171,172,173,174", "method_info": {"method_name": "test_dot_partial_shape", "method_params": "", "method_startline": "165", "method_endline": "174"}}}}}}}