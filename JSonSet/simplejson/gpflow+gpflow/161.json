{"BR": {"BR_id": "161", "BR_author": "mathDR", "BRopenT": "2016-08-11T23:46:20Z", "BRcloseT": "2016-08-15T11:10:45Z", "BR_text": {"BRsummary": "ValueError in multiclass likelihood", "BRdescription": "\n Hi,  when I run line 5 of the multiclass notebook:\n m.kern.white.variance.fixed = True\n m.Z.fixed = True\n _ = m.optimize()\n I get the following error (stacktrace):\n <denchmark-code>python\n ---------------------------------------------------------------------------\n ValueError                                Traceback (most recent call last)\n <ipython-input-5-e4eebd086840> in <module>()\n       1 m.kern.white.variance.fixed = True\n       2 m.Z.fixed = True\n ----> 3 _ = m.optimize()\n \n /Users/danmarthaler/GPflow/GPflow/model.pyc in optimize(self, method, tol, callback, maxiter, **kw)\n     207 \n     208         if type(method) is str:\n --> 209             return self._optimize_np(method, tol, callback, maxiter, **kw)\n     210         else:\n     211             return self._optimize_tf(method, callback, maxiter, **kw)\n \n /Users/danmarthaler/GPflow/GPflow/model.pyc in _optimize_np(self, method, tol, callback, maxiter, **kw)\n     265         \"\"\"\n     266         if self._needs_recompile:\n --> 267             self._compile()\n     268 \n     269         options = dict(disp=True, maxiter=maxiter)\n \n /Users/danmarthaler/GPflow/GPflow/model.pyc in _compile(self, optimizer)\n     127         with self.tf_mode():\n     128             f = self.build_likelihood() + self.build_prior()\n --> 129             g, = tf.gradients(f, self._free_vars)\n     130 \n     131         self._minusF = tf.neg(f, name='objective')\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/ops/gradients.pyc in gradients(ys, xs, grad_ys, name, colocate_gradients_with_ops, gate_gradients, aggregation_method)\n     476                 # If grad_fn was found, do not use SymbolicGradient even for\n     477                 # functions.\n --> 478                 in_grads = _AsList(grad_fn(op, *out_grads))\n     479               else:\n     480                 # For function call ops, we add a 'SymbolicGradient'\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/ops/math_grad.pyc in _ProdGrad(op, grad)\n     128   reduced = math_ops.cast(op.inputs[1], dtypes.int32)\n     129   idx = math_ops.range(0, array_ops.rank(op.inputs[0]))\n --> 130   other, _ = array_ops.listdiff(idx, reduced)\n     131   perm = array_ops.concat(0, [reduced, other])\n     132   reduced_num = math_ops.reduce_prod(array_ops.gather(input_shape, reduced))\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/ops/gen_array_ops.pyc in list_diff(x, y, name)\n    1199     idx: A `Tensor` of type `int32`. 1-D. Positions of `x` values preserved in `out`.\n    1200   \"\"\"\n -> 1201   result = _op_def_lib.apply_op(\"ListDiff\", x=x, y=y, name=name)\n    1202   return _ListDiffOutput._make(result)\n    1203 \n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/framework/op_def_library.pyc in apply_op(self, op_type_name, name, **keywords)\n     701           op = g.create_op(op_type_name, inputs, output_types, name=scope,\n     702                            input_types=input_types, attrs=attr_protos,\n --> 703                            op_def=op_def)\n     704           outputs = op.outputs\n     705           return _Restructure(ops.convert_n_to_tensor(outputs),\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.pyc in create_op(self, op_type, inputs, dtypes, input_types, name, attrs, op_def, compute_shapes, compute_device)\n    2310                     original_op=self._default_original_op, op_def=op_def)\n    2311     if compute_shapes:\n -> 2312       set_shapes_for_outputs(ret)\n    2313     self._add_op(ret)\n    2314     self._record_op_seen_by_control_dependencies(ret)\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/framework/ops.pyc in set_shapes_for_outputs(op)\n    1702       raise RuntimeError(\"No shape function registered for standard op: %s\"\n    1703                          % op.type)\n -> 1704   shapes = shape_func(op)\n    1705   if shapes is None:\n    1706     raise RuntimeError(\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/ops/array_ops.pyc in _ListDiffShape(op)\n    1979   \"\"\"Shape function for the ListDiff op.\"\"\"\n    1980   op.inputs[0].get_shape().assert_has_rank(1)\n -> 1981   op.inputs[1].get_shape().assert_has_rank(1)\n    1982   # TODO(mrry): Indicate that the length falls within an interval?\n    1983   return [tensor_shape.vector(None)] * 2\n \n /usr/local/lib/python2.7/site-packages/tensorflow/python/framework/tensor_shape.pyc in assert_has_rank(self, rank)\n     619     \"\"\"\n     620     if self.ndims not in (None, rank):\n --> 621       raise ValueError(\"Shape %s must have rank %d\" % (self, rank))\n     622 \n     623   def with_rank(self, rank):\n \n ValueError: Shape () must have rank 1\n </denchmark-code>\n \n Can anyone replicate this?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mathDR", "commentT": "2016-08-13T15:32:09Z", "comment_text": "\n \t\tNope, works for me.\n Which versions of GPflow and tensorflow are you using?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "mathDR", "commentT": "2016-08-13T20:36:13Z", "comment_text": "\n \t\tGPflow 0.2.1\n TensorFlow 0.10.0rc0\n I git pulled from latest sphinx branch and ran it again with the same error.\n On Sat, Aug 13, 2016 at 8:32 AM, James Hensman <denchmark-link:mailto:notifications@github.com>notifications@github.com</denchmark-link>\n \n wrote:\n \n Nope, works for me.\n Which versions of GPflow and tensorflow are you using?\n \u2014\n You are receiving this because you authored the thread.\n Reply to this email directly, view it on GitHub\n #161 (comment), or mute\n the thread\n https://github.com/notifications/unsubscribe-auth/ACQPhW7CpM6ZawvoIrSamRc6Q597E-3Eks5qfeN6gaJpZM4JiqSf\n .\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "mathDR", "commentT": "2016-08-14T02:11:47Z", "comment_text": "\n \t\tI'll try building tensorflow from source and see...\n Dan\n \n On Aug 13, 2016, at 08:32, James Hensman notifications@github.com wrote:\n Nope, works for me.\n Which versions of GPflow and tensorflow are you using?\n \u2014\n You are receiving this because you authored the thread.\n Reply to this email directly, view it on GitHub, or mute the thread.\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "mathDR", "commentT": "2016-08-14T09:37:10Z", "comment_text": "\n \t\tI suspect a tensorflow upgrade issue. I'm running 0.9.0, I'll try with the 10.0rc. Could you try with 0.9.0 just to make sure it's not a machine-specific issue?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "mathDR", "commentT": "2016-08-14T10:01:42Z", "comment_text": "\n \t\tConfirming this as a bug, here's the minimal code to reproduce\n import GPflow\n import tensorflow as tf\n mu, var = tf.placeholder(tf.float64), tf.placeholder(tf.float64)\n Y = tf.placeholder(tf.int32)\n lik = GPflow.likelihoods.MultiClass(3)\n ve = lik.variational_expectations(mu, var, Y)\n tf.gradients(tf.reduce_sum(ve), mu)\n python 3.5, tensorflow 0.10rc0, osx. The tests all pass except one, noted in <denchmark-link:https://github.com/GPflow/GPflow/issues/163>#163</denchmark-link>\n .\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "mathDR", "commentT": "2016-08-15T08:20:29Z", "comment_text": "\n \t\tThis is coming from reduce_prod op which has changed recently in TensorFlow. It is either a TensorFlow bug or has revealed something strange about our tensor shapes that it was previously willing to tolerate. My guess is that it is a bug with TensorFlow.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "mathDR", "commentT": "2016-08-15T08:21:41Z", "comment_text": "\n \t\tIn particular the gradient of reduce_prod was the code that changed.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "mathDR", "commentT": "2016-08-15T09:56:05Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jameshensman>@jameshensman</denchmark-link>\n  I will finish triaging this one.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "mathDR", "commentT": "2016-08-15T09:56:43Z", "comment_text": "\n \t\tOkay <denchmark-link:https://github.com/alexggmatthews>@alexggmatthews</denchmark-link>\n  good plan.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "mathDR", "commentT": "2016-08-15T10:43:37Z", "comment_text": "\n \t\tIt is a TensorFlow bug. I found a work around in <denchmark-link:https://github.com/GPflow/GPflow/pull/164>#164</denchmark-link>\n  and I've entered this TensorFlow issue\n <denchmark-link:https://github.com/tensorflow/tensorflow/issues/3815>tensorflow/tensorflow#3815</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "1076e473886cd804d8a04c65b2282f3501fa5ec7", "commit_author": "Alexander G. de G. Matthews", "commitT": "2016-08-15 12:10:45+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "GPflow\\likelihoods.py", "file_new_name": "GPflow\\likelihoods.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "390", "deleted_lines": "390", "method_info": {"method_name": "prob_is_largest", "method_params": "self,Y,mu,var,gh_x,gh_w", "method_startline": "370", "method_endline": "390"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "testing\\test_likelihoods.py", "file_new_name": "testing\\test_likelihoods.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "153,162,166,168,169,170,171,172,173,174,175,176,177,178", "deleted_lines": "154,158,160,161,162,163,164,165,166,167,170", "method_info": {"method_name": "testSymmetric", "method_params": "self", "method_startline": "151", "method_endline": "178"}}, "hunk_1": {"Ismethod": 1, "added_lines": "45,52", "deleted_lines": "44,51", "method_info": {"method_name": "setUp", "method_params": "self", "method_startline": "42", "method_endline": "52"}}, "hunk_2": {"Ismethod": 1, "added_lines": "83,84,85", "deleted_lines": "78,79", "method_info": {"method_name": "test_var_exp", "method_params": "self", "method_startline": "74", "method_endline": "86"}}, "hunk_3": {"Ismethod": 1, "added_lines": "15,19,20,22,23,25,26,27,28,29,30,31,32", "deleted_lines": "15,19,20,22,23,25,26,27,28,29,30,31,32", "method_info": {"method_name": "getTestSetups", "method_params": "includeMultiClass,addNonStandardLinks", "method_startline": "15", "method_endline": "33"}}, "hunk_4": {"Ismethod": 1, "added_lines": "123,124,131,134,138", "deleted_lines": "124,127,131", "method_info": {"method_name": "test_pred_density", "method_params": "self", "method_startline": "122", "method_endline": "141"}}, "hunk_5": {"Ismethod": 1, "added_lines": "188,189,190,191,192,193", "deleted_lines": null, "method_info": {"method_name": "testA", "method_params": "self", "method_startline": "188", "method_endline": "193"}}, "hunk_6": {"Ismethod": 1, "added_lines": "68,69,70,71", "deleted_lines": "65,66", "method_info": {"method_name": "test_variance", "method_params": "self", "method_startline": "64", "method_endline": "72"}}, "hunk_7": {"Ismethod": 1, "added_lines": "58,59,60,61", "deleted_lines": "57,58", "method_info": {"method_name": "test_mean", "method_params": "self", "method_startline": "54", "method_endline": "62"}}}}}}}