{"BR": {"BR_id": "16007", "BR_author": "sebastien-wybo", "BRopenT": "2019-11-27T16:25:45Z", "BRcloseT": "2019-12-19T14:36:09Z", "BR_text": {"BRsummary": "EstimateAffine3D bug if points are colinear in x,y coordinates", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV 4.1.2 and master branch\n Operating System: all\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n The code for Affine3DEstimatorCallback::checkSubset is bugged as it assesses colinearity of 3D points based solely on x and y coordinates. As a result, if you pass array of 3D points with coordinates [x, 0, z] and [x', 0, z'] they're always considered as colinear. CheckSubset returns false and thus EstimateAffine3D returns false as well\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n Attached is a sample file where each line is made of Pt1 coordinates Pt2 coordinates\n Sample code to read file and perform EstimateAffine3D transformation:\n <denchmark-code>std::ifstream tis(\"matches.txt\", std::ios_base::in);\n \n std::vector<cv::Point3f> m1, m2;\n while (tis.good())\n {\n     cv::Point3f p1, p2;\n     tis >> p1.x >> p1.y >> p1.z >> p2.x >> p2.y >> p2.z;\n     m1.push_back(p1);\n     m2.push_back(p2);\n }\n std::cout << \"m1 has \" << m1.size() << \" entries, m2 has \" << m2.size() << std::endl;\n cv::Mat m3D, inl;\n int res = cv::estimateAffine3D(m1, m2, m3D, inl);\n std::cout << \"estimate 3D returned \" << res << \" with \" << cv::countNonZero(inl) << \" inliers;\" << std::endl;\n </denchmark-code>\n \n On OpenCV 2.4.11 EstimateAffine3D returns 1 with 860 inliers, with OpenCV 4.1.2 it returns 0 with 0 inliers\n <denchmark-link:https://github.com/opencv/opencv/files/3897812/matches.txt>matches.txt</denchmark-link>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "e801f0e954a4d095b0240c0d83cfb5376a6f0e85", "commit_author": "Sebastien Wybo", "commitT": "2019-12-19 12:59:18+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\calib3d\\src\\ptsetreg.cpp", "file_new_name": "modules\\calib3d\\src\\ptsetreg.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "491,496,497", "deleted_lines": "491,496,497", "method_info": {"method_name": "cv::Affine3DEstimatorCallback::checkSubset", "method_params": "_ms1,_ms2,count", "method_startline": "473", "method_endline": "505"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\calib3d\\test\\test_affine3d_estimator.cpp", "file_new_name": "modules\\calib3d\\test\\test_affine3d_estimator.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "195,196,197,198,199,200,201,202,203,204,205,206,207", "deleted_lines": null, "method_info": {"method_name": "opencv_test::TEST", "method_params": "Calib3d_EstimateAffine3D,regression_16007", "method_startline": "195", "method_endline": "207"}}}}}}}