{"BR": {"BR_id": "7898", "BR_author": "PkLab", "BRopenT": "2016-12-19T16:48:36Z", "BRcloseT": "2017-02-01T14:37:25Z", "BR_text": {"BRsummary": "CvCaptureCAM_VFW and CvVideoWriter_VFW missing CoInitialize/CoUninitialize ?", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 3.1/Master\n Operating System / Platform => Windows 64 Bit\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n CoInitialize/CoUninitialize have to be called in every thread that uses COM. This is correctly done in\n <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/videoio/src/cap_vfw.cpp#L89>CvCaptureAVI_VFW</denchmark-link>\n  but not in the cam class <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/videoio/src/cap_vfw.cpp#L315>CvCaptureCAM_VFW</denchmark-link>\n  and writer <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/videoio/src/cap_vfw.cpp#L676>CvVideoWriter_VFW</denchmark-link>\n .\n Is there any reason for this ?\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n CvVideoWriter_VFW isn't used when FFMPEG is available. Sincerely it works most of times also without FFMPEG, may be the function <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/videoio/src/cap_vfw.cpp#L73>icvInitCapture_VFW</denchmark-link>\n  calls CoInitialize internally but it can happens once per session because of static control flag.\n In the case of VFW grabber and writer are used from 2 different threads, some issue can arise, in special case with MFC threads. In details <denchmark-link:https://github.com/opencv/opencv/blob/master/modules/videoio/src/cap_vfw.cpp#L734>AVIFileOpen(...)</denchmark-link>\n  fails returning  witch is <denchmark-link:https://msdn.microsoft.com/en-us/library/windows/desktop/dd542643.aspx>CO_E_NOTINITIALIZED</denchmark-link>\n \n <denchmark-h:h5>Possible solution</denchmark-h>\n \n Considering that <denchmark-link:https://msdn.microsoft.com/en-us/library/windows/desktop/ms678543.aspx>MSDN says</denchmark-link>\n \n \n Typically, the COM library is initialized on a thread only once. Subsequent calls to CoInitialize or CoInitializeEx on the same thread will succeed, as long as they do not attempt to change the concurrency model... must be balanced by a corresponding call to CoUninitialize\n \n We could rewrite CCvCaptureCAM_VFW and cvVideoWriter_VFW constructor and destructor as is for CvCaptureAVI_VFW\n <denchmark-code>    CvCaptureCAM_VFW()\n     {\n         CoInitialize(NULL);\n         init();\n     }\n     virtual ~CvCaptureCAM_VFW()\n     {\n         close();\n         CoUninitialize();\n     }\n .....\n     CvVideoWriter_VFW() {\n         CoInitialize(NULL);\n         init(); \n     }\n     virtual ~CvVideoWriter_VFW() { \n         close(); \n         CoUninitialize();\n     }\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "PkLab", "commentT": "2017-01-26T16:51:47Z", "comment_text": "\n \t\tCan I prepare a PR using above possible solution ?\n \t\t"}}}, "commit": {"commit_id": "ece3fac7efb07bf01a7875d82be51a69c0d8a1c2", "commit_author": "PkLab", "commitT": "2017-02-01 14:37:24+00:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "modules\\videoio\\src\\cap_vfw.cpp", "file_new_name": "modules\\videoio\\src\\cap_vfw.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "320,321,322,323,324", "deleted_lines": null, "method_info": {"method_name": "CvCaptureCAM_VFW::~CvCaptureCAM_VFW", "method_params": "", "method_startline": "320", "method_endline": "324"}}, "hunk_1": {"Ismethod": 1, "added_lines": "689,690,691,692,693", "deleted_lines": null, "method_info": {"method_name": "CvVideoWriter_VFW::~CvVideoWriter_VFW", "method_params": "", "method_startline": "689", "method_endline": "693"}}, "hunk_2": {"Ismethod": 1, "added_lines": "684,685,686,687,688", "deleted_lines": null, "method_info": {"method_name": "CvVideoWriter_VFW::CvVideoWriter_VFW", "method_params": "", "method_startline": "684", "method_endline": "688"}}, "hunk_3": {"Ismethod": 1, "added_lines": "315,316,317,318,319", "deleted_lines": "315,316", "method_info": {"method_name": "CvCaptureCAM_VFW::CvCaptureCAM_VFW", "method_params": "", "method_startline": "315", "method_endline": "319"}}}}}}}