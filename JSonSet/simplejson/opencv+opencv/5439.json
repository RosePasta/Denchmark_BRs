{"BR": {"BR_id": "5439", "BR_author": "pcampr", "BRopenT": "2015-10-02T12:49:47Z", "BRcloseT": "2015-10-06T10:02:00Z", "BR_text": {"BRsummary": "video writer fails for uncompressed video with latest ffmpeg 2.8", "BRdescription": "\n When using cv2.VideoWriter (tested in Python, not tested in C), the writer silently fails to write uncompressed video file (tested with mkv, avi, wmv containers) when using ffmpeg 2.8 or ffmpeg snapshot from today (2015-10-02). The generated files have nearly zero size (probably only headers are written). The writer works with ffmpeg 2.7.2.\n ffmpeg is downloaded from <denchmark-link:http://ffmpeg.org/releases/>http://ffmpeg.org/releases/</denchmark-link>\n \n tested on Ubuntu 15.04\n Testing code:\n import numpy as np\n import cv2\n import os\n \n np.random.seed(0)\n \n # test different containers\n for fn_mask in ['test_%s.mkv', 'test_%s.avi', 'test_%s.wmv']:\n   # test different codecs\n   for fourcc_name, fourcc in [('uncompressed', 0), ('mp4v', cv2.VideoWriter_fourcc(*'mp4v')), ('xvid', cv2.VideoWriter_fourcc(*'MJPG'))]:\n     fn = fn_mask % fourcc_name\n \n     writer = cv2.VideoWriter(fn, fourcc, 25, (100, 100))\n \n     # generate random 100x100 images\n     for i in range(0,100):\n         img = np.random.random_integers(0, 255, (100,100,3)).astype(np.uint8)\n         writer.write(img)\n \n     writer.release()\n \n     # test result (is generated file too small?)\n     fs = os.path.getsize(fn)\n \n     print '%s [%dB] [%s]' % (fn, fs, 'FAIL' if fs<10000 else 'OK')\n Output:\n \n opencv-3.0.0 compiled with ffmpeg 2.7.2 - is OK\n \n <denchmark-code>test_uncompressed.mkv [1504712B] [OK]\n test_mp4v.mkv [309958B] [OK]\n test_xvid.mkv [819482B] [OK]\n test_uncompressed.avi [1508086B] [OK]\n test_mp4v.avi [319296B] [OK]\n test_xvid.avi [1291120B] [OK]\n test_uncompressed.wmv [1517443B] [OK]\n test_mp4v.wmv [320684B] [OK]\n test_xvid.wmv [826237B] [OK]\n </denchmark-code>\n \n \n opencv-3.0.0 compiled with ffmpeg 2.8 - FAILS\n \n <denchmark-code>test_uncompressed.mkv [587B] [FAIL]\n test_mp4v.mkv [310026B] [OK]\n test_xvid.mkv [819550B] [OK]\n test_uncompressed.avi [5686B] [FAIL]\n test_mp4v.avi [319296B] [OK]\n test_xvid.avi [1291120B] [OK]\n test_uncompressed.wmv [533B] [FAIL]\n test_mp4v.wmv [320684B] [OK]\n test_xvid.wmv [826237B] [OK]\n </denchmark-code>\n \n \n opencv-master (from 2015-10-02) compiled with ffmpeg 2.8 - FAILS\n \n <denchmark-code>test_uncompressed.mkv [587B] [FAIL]\n test_mp4v.mkv [310026B] [OK]\n test_xvid.mkv [819550B] [OK]\n test_uncompressed.avi [5686B] [FAIL]\n test_mp4v.avi [319296B] [OK]\n test_xvid.avi [1291120B] [OK]\n test_uncompressed.wmv [533B] [FAIL]\n test_mp4v.wmv [320684B] [OK]\n test_xvid.wmv [826237B] [OK]\n </denchmark-code>\n \n \n opencv-master (from 2015-10-02) compiled with ffmpeg snapshot (from 2015-10-02) - FAILS\n \n <denchmark-code>test_uncompressed.mkv [584B] [FAIL]\n test_mp4v.mkv [310022B] [OK]\n test_xvid.mkv [819397B] [OK]\n test_uncompressed.avi [5686B] [FAIL]\n test_mp4v.avi [319194B] [OK]\n test_xvid.avi [1291120B] [OK]\n test_uncompressed.wmv [531B] [FAIL]\n test_mp4v.wmv [320681B] [OK]\n test_xvid.wmv [826235B] [OK]\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "pcampr", "commentT": "2015-10-02T14:24:04Z", "comment_text": "\n \t\tI confirm that OpenCV-master with\n \n ffmpeg 2.7.2 works fine.\n ffmpeg 2.8 writes only headers in case of fourcc=0.\n \n Existed OpenCV debug logs don't show warnings/problems about failed ffmpeg calls.\n Currently I have no ideas about problem location, but looks like that some incompatible changes were introduced into ffmpeg.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "pcampr", "commentT": "2015-10-02T14:26:58Z", "comment_text": "\n \t\tI just run test bin/opencv_test_videoio\n passes for ffmpeg 2.7.2\n fails in one test for ffmpeg 2.8:\n <denchmark-code>[ RUN      ] Videoio_Video.ffmpeg_writebig\n ERROR: File name: /tmp/__opencv_temp.NOIuEr.00000000.avi is very small (data write problems?)\n ERROR: File name: /tmp/__opencv_temp.vmnbHQ.30323449.avi is very small (data write problems?)\n OpenCV: FFMPEG: tag 0x34363248/'H264' is not supported with codec id 28 and format 'mp4 / MP4 (MPEG-4 Part 14)'\n OpenCV: FFMPEG: fallback to use tag 0x00000021/'!???'\n /home/axe/opencv/opencv-3.0.0-ffmpeg-2.8/build/opencv-3.0.0/modules/ts/src/ts.cpp:515: Failure\n Failed\n \n         failure reason: Invalid function output\n         test case #-1\n         seed: ffffffffffffffff\n -----------------------------------\n \n [  FAILED  ] Videoio_Video.ffmpeg_writebig (10069 ms)\n </denchmark-code>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "pcampr", "commentT": "2015-10-02T14:33:43Z", "comment_text": "\n \t\tFailed cases are fourcc=0 and fourcc=I420. Both are uncompressed cases.\n H264 is warning only, but file is OK (ffmpeg can't use FOURCC for mp4 files directly).\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "pcampr", "commentT": "2015-10-02T14:57:07Z", "comment_text": "\n \t\tI run  on ffmpeg repo and it finds this commit:\n <denchmark-link:https://github.com/FFmpeg/FFmpeg/commit/c41a59330f49c16acfa9b0552608fa1f41a0d823>FFmpeg/FFmpeg@c41a593</denchmark-link>\n \n <denchmark-code>c41a59330f49c16acfa9b0552608fa1f41a0d823 is the first bad commit\n commit c41a59330f49c16acfa9b0552608fa1f41a0d823\n Author: Michael Niedermayer <michael@niedermayer.cc>\n Date:   Sat Sep 5 11:56:23 2015 +0200\n \n     avcodec/rawenc: Use AVFrame parameters instead of AVCodecContext\n \n     This allows encoding raw frames with changing dimensions\n \n     Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>\n \n :040000 040000 6ef39a3a0ce9828e776c19929c9edf9be478352b b9880d04586786dfaa7b0846a38a8f440d6e6a80 M  libavcodec\n </denchmark-code>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "pcampr", "commentT": "2015-10-02T15:36:43Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/pcampr>@pcampr</denchmark-link>\n  I added PR with properly filled AVFrame fields. Please take a look on it.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "pcampr", "commentT": "2015-10-02T16:01:19Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  I tried your PR in my build (ffmpeg 2.8) and it works (both my py test script and bin/opencv_test_videoio test). Seems completely fine now \n Thanks for really fast fix!\n \t\t"}}}, "commit": {"commit_id": "50a0a167f07fca8a0b7ee324eac7708a67154650", "commit_author": "Alexander Alekhin", "commitT": "2015-10-02 18:27:18+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\videoio\\src\\cap_ffmpeg_impl.hpp", "file_new_name": "modules\\videoio\\src\\cap_ffmpeg_impl.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1133,1134,1135,1136,1137", "deleted_lines": null, "method_info": {"method_name": "icv_alloc_picture_FFMPEG", "method_params": "pix_fmt,width,height,alloc", "method_startline": "1119", "method_endline": "1152"}}}}}}}