{"BR": {"BR_id": "18350", "BR_author": "berak", "BRopenT": "2020-09-16T09:16:39Z", "BRcloseT": "2020-09-21T09:01:32Z", "BR_text": {"BRsummary": "dnn: Inconsistent shape for ConcatLayer in function 'getMemoryShapes' from onnx", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 4.4.0-dev\n Operating System / Platform => colab\n Compiler => python 3.8\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n similar  issues have been reported (and have been resolved) for tensorflow (<denchmark-link:https://github.com/opencv/opencv/issues/10739>#10739</denchmark-link>\n  , <denchmark-link:https://github.com/opencv/opencv/issues/15822>#15822</denchmark-link>\n ) and yolo(<denchmark-link:https://github.com/opencv/opencv/issues/11310>#11310</denchmark-link>\n , <denchmark-link:https://github.com/opencv/opencv/issues/16831>#16831</denchmark-link>\n )\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n <denchmark-code>git clone https://github.com/berak/VNL_Monocular_Depth_Prediction\n wget https://cloudstor.aarnet.edu.au/plus/s/7kdsKYchLdTi53p/download -O ResNext101_32x4d_NYU.pth\n \n import cv2\n import torch\n import numpy as np\n from lib.models.metric_depth_model import MetricDepthModel\n \n def load_ckpt(fn, model, optimizer=None, scheduler=None, val_err=[]):\n     checkpoint = torch.load(fn, map_location=lambda storage, loc: storage)\n     model.load_state_dict(checkpoint['model_state_dict'])\n  \n model = MetricDepthModel()\n model.eval()\n load_ckpt(\"/content/VNL_Monocular_Depth_Prediction/ResNext101_32x4d_NYU.pth\", model)\n \n def convert_to_onnx(net, output_name):\n     input = {'A':torch.randn(1,3,240,320)}\n     input_names = ['data']\n     output_names = ['output']\n     net.eval()\n     torch.onnx.export(net, input, output_name, verbose=True, input_names=input_names, output_names=output_names, opset_version=11)\n model.cuda()\n convert_to_onnx(model, \"VNL.onnx\")\n \n import cv2\n cv2.dnn.readNet(\"VNL.onnx\")\n </denchmark-code>\n \n <denchmark-code>error: OpenCV(4.4.0-dev) /content/opencv/modules/dnn/src/layers/concat_layer.cpp:102: error: (-201:Incorrect size of input array) Inconsistent shape for ConcatLayer in function 'getMemoryShapes'\n </denchmark-code>\n \n exported onnx can be checked <denchmark-link:https://drive.google.com/file/d/1LKfTm11MLjaIpJl6He3APSImit-mum2v/view?usp=sharing>from here</denchmark-link>\n \n <denchmark-h:h5>Issue submission checklist</denchmark-h>\n \n \n  I report the issue, it's not a question\n \n \n  I checked the problem with documentation, FAQ, open issues,\n answers.opencv.org, Stack Overflow, etc and have not found solution\n \n \n  I updated to latest OpenCV version and the issue is still there\n \n \n  There is reproducer code and related data files: videos, images, onnx, etc\n \n \n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "berak", "commentT": "2020-09-16T11:47:22Z", "comment_text": "\n \t\tPlease provide a shareable link to ONNX model\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "berak", "commentT": "2020-09-16T13:14:54Z", "comment_text": "\n \t\tapologies, it wasn't shareable. new  link here:\n <denchmark-link:https://drive.google.com/file/d/1LKfTm11MLjaIpJl6He3APSImit-mum2v/view?usp=sharing>https://drive.google.com/file/d/1LKfTm11MLjaIpJl6He3APSImit-mum2v/view?usp=sharing</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "berak", "commentT": "2020-09-21T09:01:32Z", "comment_text": "\n \t\tplease try <denchmark-link:https://github.com/opencv/opencv/pull/18353>#18353</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "berak", "commentT": "2020-09-21T12:48:12Z", "comment_text": "\n \t\tworks like magic, thank you ! ;)\n \t\t"}}}, "commit": {"commit_id": "ebb528976f6e7e4572a8fadf1004ffcebc9ca584", "commit_author": "Liubov Batanina", "commitT": "2020-09-18 13:01:14+00:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\dnn\\src\\onnx\\onnx_importer.cpp", "file_new_name": "modules\\dnn\\src\\onnx\\onnx_importer.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1054,1055,1056,1057,1058,1059,1060,1061,1062,1063", "deleted_lines": null, "method_info": {"method_name": "cv::dnn::ONNXImporter::populateNet", "method_params": "dstNet", "method_startline": "312", "method_endline": "1699"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\dnn\\test\\test_onnx_importer.cpp", "file_new_name": "modules\\dnn\\test\\test_onnx_importer.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "270,271,272,273,274,275", "deleted_lines": null, "method_info": {"method_name": "opencv_test::TEST_P", "method_params": "Test_ONNX_layers,Scale", "method_startline": "270", "method_endline": "275"}}}}}}}