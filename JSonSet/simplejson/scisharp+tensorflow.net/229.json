{"BR": {"BR_id": "229", "BR_author": "henon", "BRopenT": "2019-04-13T11:31:42Z", "BRcloseT": "2019-04-15T01:09:42Z", "BR_text": {"BRsummary": "flow_control_ops.cond graph not constructed correctly", "BRdescription": "\n CondTestCases.testCondTrue creates the following graph:\n             with(tf.Graph().as_default(), g =>\n             {\n                 var x = tf.constant(2);\n                 var y = tf.constant(5);\n                 var z = control_flow_ops.cond(tf.less(x, y), () => tf.multiply(x, tf.constant(17)),\n                     () => tf.add(y, tf.constant(23)));\n                 tf.train.export_meta_graph(@\"D:\\dev\\tensorboard\\logdir\\sharp.meta\", as_text: false);\n                 self.assertEquals(eval_scalar(z), 34);\n             });\n <denchmark-link:https://user-images.githubusercontent.com/44090/56079109-23764b00-5df0-11e9-91c3-50436453b1fc.PNG></denchmark-link>\n \n But the same code in Python creates this graph:\n     g = ops.Graph()\n     with g.as_default():\n         x = tf.constant(2);\n         y = tf.constant(5);\n         z = control_flow_ops.cond(tf.less(x, y), lambda: tf.multiply(x, tf.constant(17)),\n                                   lambda: tf.add(y, tf.constant(23)));\n         writer = tf.summary.FileWriter(logdir=\"D:/dev/tensorboard/logdir\", graph=g)\n         writer.flush()\n <denchmark-link:https://user-images.githubusercontent.com/44090/56079112-2ffaa380-5df0-11e9-9408-5eac945a529b.PNG></denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "henon", "commentT": "2019-04-13T18:18:26Z", "comment_text": "\n \t\tAfter <denchmark-link:https://github.com/Oceania2018>@Oceania2018</denchmark-link>\n  updated the c_api Operation._update_inputs seems to work now. Only the control dependencies are still missing from the graph:\n <denchmark-link:https://user-images.githubusercontent.com/44090/56083725-483ae480-5e29-11e9-9864-6d3dadb790c9.png></denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "henon", "commentT": "2019-04-13T19:20:09Z", "comment_text": "\n \t\tI have identified the problem why the control dependency edges are not generated. Here is how to reproduce:\n \n In Control.Operations._add_control_input add the line  var updated_control_inputs=control_inputs; after the c_api call.\n Set a breakpoint on that new line\n \n Run CondTestCases.testCondTrue\n \n You will see that the cond/switch_f control dependency is added to this (which is cond/Const). But after stepping over the new line var updated_control_inputs=control_inputs; you will see that control_inputs is still empty. Seems like the update via the c_api fails somehow\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "henon", "commentT": "2019-04-13T22:09:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/henon>@henon</denchmark-link>\n  I can't reproduce it.\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56085788-f5543380-5e0e-11e9-8c4e-00310567b149.png></denchmark-link>\n \n I just changed to Tensor.eval(), then it works.\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56085793-1f0d5a80-5e0f-11e9-8880-3e00663e929b.png></denchmark-link>\n \n I've found testCondFalse doesn't pass.\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56085830-2da84180-5e10-11e9-912f-39c5a2f8da5e.png></denchmark-link>\n \n When I enable c_api.TF_UpdateEdge(graph, output, input, status);, new error threw:\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56086266-c478fc00-5e18-11e9-9c81-bb35a7638afb.png></denchmark-link>\n \n NumControlOutputs of cond/switch_t should be 1 not 0, also for cond/switch_f.\n I think we should update managed Graph definition when we invoked TF_UpdateEdge.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "henon", "commentT": "2019-04-14T10:13:46Z", "comment_text": "\n \t\tHave you checked the problem with TF_AddControlInput I outlined above? The problem is that after adding a control input the control inputs are still 0.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "henon", "commentT": "2019-04-14T14:57:19Z", "comment_text": "\n \t\tWe recompiled the tensorflow c_api, now it passed the unit test.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "henon", "commentT": "2019-04-14T15:26:07Z", "comment_text": "\n \t\tthe simplified test case passes, the original one with Add and Mul still fails. but the graph looks better now:\n <denchmark-link:https://user-images.githubusercontent.com/44090/56095165-60b70780-5eda-11e9-8662-134bb4d550cd.png></denchmark-link>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "henon", "commentT": "2019-04-15T00:55:52Z", "comment_text": "\n \t\tThis should be 1.\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56102041-4cc9d080-5eef-11e9-97c2-57ddff8afc48.png></denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "henon", "commentT": "2019-04-15T01:03:57Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/henon>@henon</denchmark-link>\n  Fixed.\n <denchmark-link:https://user-images.githubusercontent.com/1705364/56102138-6e778780-5ef0-11e9-8128-346a904940b6.png></denchmark-link>\n \n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "henon", "commentT": "2019-04-15T07:48:37Z", "comment_text": "\n \t\tNow that it is fixed, side by side the graphs of tensorflow Python and TensorFlow.NET\n <denchmark-link:https://user-images.githubusercontent.com/44090/56115409-99e78a00-5f63-11e9-8121-6c4f91c6be4d.PNG></denchmark-link>\n \n <denchmark-link:https://user-images.githubusercontent.com/44090/56115385-8b00d780-5f63-11e9-8387-fc461896cec6.png></denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "6a1ed38e027aaa35524be981fc5a92099d5a6319", "commit_author": "Oceania2018", "commitT": "2019-04-14 20:09:31-05:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\TensorFlowNET.Core\\Operations\\ControlFlows\\CondContext.cs", "file_new_name": "src\\TensorFlowNET.Core\\Operations\\ControlFlows\\CondContext.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "40,58", "deleted_lines": "40,58", "method_info": {"method_name": "Tensorflow.Operations::CondContext::CondContext", "method_params": "pred,pivot,branch,name,context_def,import_scope", "method_startline": "38", "method_endline": "66"}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "108,109,110,111,112", "method_info": {"method_name": "Tensorflow.Operations::CondContext::AddValue", "method_params": "val", "method_startline": "84", "method_endline": "135"}}, "hunk_2": {"Ismethod": 1, "added_lines": "40,58", "deleted_lines": "40,58", "method_info": {"method_name": "Tensorflow.Operations::CondContext::CondContext", "method_params": "pred,pivot,branch,name,context_def,import_scope", "method_startline": "38", "method_endline": "66"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\TensorFlowNET.Core\\Operations\\Operation.Control.cs", "file_new_name": "src\\TensorFlowNET.Core\\Operations\\Operation.Control.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32", "deleted_lines": "32", "method_info": {"method_name": "Tensorflow::Operation::_add_control_input", "method_params": "op", "method_startline": "30", "method_endline": "34"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\TensorFlowNET.Core\\Operations\\Operation.Input.cs", "file_new_name": "src\\TensorFlowNET.Core\\Operations\\Operation.Input.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "30,31,32", "deleted_lines": "30,31,32", "method_info": {"method_name": "Tensorflow::Operation::if", "method_params": "_inputs", "method_startline": "24", "method_endline": "36"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\TensorFlowNET.Core\\Operations\\Operation.cs", "file_new_name": "src\\TensorFlowNET.Core\\Operations\\Operation.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "294", "deleted_lines": null, "method_info": {"method_name": "Tensorflow::Operation::_update_input", "method_params": "index,tensor", "method_startline": "281", "method_endline": "295"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\TensorFlowNET.Core\\Operations\\gen_control_flow_ops.py.cs", "file_new_name": "src\\TensorFlowNET.Core\\Operations\\gen_control_flow_ops.py.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "43", "deleted_lines": "39,44", "method_info": {"method_name": "Tensorflow::gen_control_flow_ops::switch", "method_params": "data,pred,name", "method_startline": "36", "method_endline": "44"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\TensorFlowNET.Core\\Tensors\\Tensor.Creation.cs", "file_new_name": "src\\TensorFlowNET.Core\\Tensors\\Tensor.Creation.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "131,132,133", "deleted_lines": "131,132,133", "method_info": {"method_name": "Tensorflow::Tensor::Tensor", "method_params": "op,value_index,dtype", "method_startline": "129", "method_endline": "135"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\TensorFlowNET.Core\\Tensors\\Tensor.cs", "file_new_name": "src\\TensorFlowNET.Core\\Tensors\\Tensor.cs", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "25,27,34,36,37", "deleted_lines": "26,33,35"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "test\\TensorFlowNET.UnitTest\\control_flow_ops_test\\CondTestCases.cs", "file_new_name": "test\\TensorFlowNET.UnitTest\\control_flow_ops_test\\CondTestCases.cs", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "25,26", "deleted_lines": "25,26", "method_info": {"method_name": "TensorFlowNET.UnitTest.control_flow_ops_test::CondTestCases::testCondTrue_ConstOnly", "method_params": "", "method_startline": "15", "method_endline": "31"}}, "hunk_1": {"Ismethod": 1, "added_lines": "44,45", "deleted_lines": "44,45", "method_info": {"method_name": "TensorFlowNET.UnitTest.control_flow_ops_test::CondTestCases::testCondFalse_ConstOnly", "method_params": "", "method_startline": "34", "method_endline": "50"}}, "hunk_2": {"Ismethod": 1, "added_lines": "80,81,82,83,84", "deleted_lines": "79,80", "method_info": {"method_name": "TensorFlowNET.UnitTest.control_flow_ops_test::CondTestCases::testCondFalse", "method_params": "", "method_startline": "72", "method_endline": "88"}}, "hunk_3": {"Ismethod": 1, "added_lines": "59,60,61,62,63,64,65", "deleted_lines": "59,60,61,62,63,69", "method_info": {"method_name": "TensorFlowNET.UnitTest.control_flow_ops_test::CondTestCases::testCondTrue", "method_params": "", "method_startline": "53", "method_endline": "69"}}}}}}}