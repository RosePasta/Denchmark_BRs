{"BR": {"BR_id": "235", "BR_author": "null-a", "BRopenT": "2017-10-11T12:02:46Z", "BRcloseT": "2017-10-12T05:41:05Z", "BR_text": {"BRsummary": "Batch indices are no longer shared between model and guide", "BRdescription": "\n Since <denchmark-link:https://github.com/pyro-ppl/pyro/commit/97eac68e57dbc11c5f57936e1add39096f1950c1>97eac68</denchmark-link>\n , the model and guide sub sample data independently, resulting in the model and the guide seeing different mini batches within a single execution. Unless I'm missing something, this looks like a bug.\n e.g.\n import pyro\n import torch\n from torch.autograd import Variable\n import torch.optim as optim\n from pyro.infer.kl_qp import KL_QP\n \n torch.manual_seed(0)\n data = range(10)\n def model():\n     pyro.map_data('mapdata', data, lambda i, x: print('i={},x={}'.format(i, x)), batch_size=2)\n     print('-----')\n KL_QP(model, model, pyro.optim(optim.Adam, {})).step()\n At <denchmark-link:https://github.com/pyro-ppl/pyro/commit/a407f13545ce7e435e257f332181a9808e1fc37f>a407f13</denchmark-link>\n :\n <denchmark-code>i=4,x=4\n i=1,x=1\n -----\n i=4,x=4\n i=1,x=1\n -----\n # cruft ...\n </denchmark-code>\n \n At <denchmark-link:https://github.com/pyro-ppl/pyro/commit/97eac68e57dbc11c5f57936e1add39096f1950c1>97eac68</denchmark-link>\n :\n <denchmark-code>i=4,x=4\n i=1,x=1\n -----\n i=3,x=3\n i=9,x=9\n -----\n # cruft ...\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "null-a", "commentT": "2017-10-11T14:06:11Z", "comment_text": "\n \t\tUh oh, this is important. Good catch!\n <denchmark-link:https://github.com/fritzo>@fritzo</denchmark-link>\n  wanna patch and add a test that would've caught it?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "null-a", "commentT": "2017-10-11T15:01:32Z", "comment_text": "\n \t\tYes, I'll look into it. Most likely culprit is <denchmark-link:https://github.com/pyro-ppl/pyro/pull/184>#184</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "null-a", "commentT": "2017-10-11T15:27:51Z", "comment_text": "\n \t\tOk sorry, I accidentally removed replay information in <denchmark-link:https://github.com/pyro-ppl/pyro/pull/184>#184</denchmark-link>\n . I'll add it back. Here's a minimal test case:\n def test_replay_map_data():\n     pyro.set_rng_seed(0)\n     data = list(range(10))\n \n     def model():\n         return pyro.map_data('mapdata', data, lambda i, x: i, batch_size=2)\n \n     traced_model = poutine.trace(model)\n     expected = traced_model()\n     actual = poutine.replay(model, traced_model.trace)()\n     assert actual == expected\n <denchmark-link:https://github.com/null-a>@null-a</denchmark-link>\n  Thanks for providing such an easily reproducible error!\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "null-a", "commentT": "2017-10-11T15:36:31Z", "comment_text": "\n \t\tWorking on a fix in <denchmark-link:https://github.com/pyro-ppl/pyro/pull/237>#237</denchmark-link>\n  (currently only has failing tests)\n \t\t"}}}, "commit": {"commit_id": "7d87b71e235ba51051fed5fbc61ace41412737eb", "commit_author": "Fritz Obermeyer", "commitT": "2017-10-11 22:41:04-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\source\\pyro.distributions.txt", "file_new_name": "docs\\source\\pyro.distributions.txt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "94,95,96,97,98,99,100", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pyro\\__init__.py", "file_new_name": "pyro\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "153", "deleted_lines": "152", "method_info": {"method_name": "iarange", "method_params": "name,size,subsample_size", "method_startline": "119", "method_endline": "160"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pyro\\distributions\\__init__.py", "file_new_name": "pyro\\distributions\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19,37", "deleted_lines": null}}}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "pyro\\distributions\\subsample.py"}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tests\\poutine\\test_mapdata.py", "file_new_name": "tests\\poutine\\test_mapdata.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "159", "deleted_lines": "158", "method_info": {"method_name": "test_nested_map_data", "method_params": "", "method_startline": "135", "method_endline": "160"}}, "hunk_1": {"Ismethod": 1, "added_lines": "180,181", "deleted_lines": null, "method_info": {"method_name": "test_replay_map_data.model", "method_params": "", "method_startline": "180", "method_endline": "181"}}, "hunk_2": {"Ismethod": 1, "added_lines": "163,164,165,166,167,168,169,170,171,172,173", "deleted_lines": null, "method_info": {"method_name": "test_replay_iarange", "method_params": "", "method_startline": "163", "method_endline": "173"}}, "hunk_3": {"Ismethod": 1, "added_lines": "166,167,168", "deleted_lines": null, "method_info": {"method_name": "test_replay_iarange.model", "method_params": "", "method_startline": "166", "method_endline": "168"}}, "hunk_4": {"Ismethod": 1, "added_lines": "176,177,178,179,180,181,182,183,184,185,186", "deleted_lines": null, "method_info": {"method_name": "test_replay_map_data", "method_params": "", "method_startline": "176", "method_endline": "186"}}}}}}}