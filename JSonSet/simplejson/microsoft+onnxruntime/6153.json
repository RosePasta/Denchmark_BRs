{"BR": {"BR_id": "6153", "BR_author": "TomWildenhain-Microsoft", "BRopenT": "2020-12-16T21:48:58Z", "BRcloseT": "2021-01-08T07:32:53Z", "BR_text": {"BRsummary": "ORT computes min/max incorrectly for negative fp16 values in opsets 12 and 13", "BRdescription": "\n Describe the bug\n ORT computes min incorrectly for negative fp16 values in opsets 12 and 13.  It says the min of 2 and -5 is 2.\n Urgency\n Bug is present in production version of ORT.  May cause existing models to fail.\n System information\n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10\n ONNX Runtime installed from (source or binary): PyPI\n ONNX Runtime version: 1.6.0\n Python version: 3.8\n \n To Reproduce\n <denchmark-code>from onnx import helper\n from onnx.onnx_pb import TensorProto\n import onnxruntime as ort\n import numpy as np\n \n node1 = helper.make_node(\"Min\", [\"X\", \"Y\"], [\"Z\"], name=\"trans\")\n \n graph = helper.make_graph(\n     [node1],\n     \"min_graph\",\n     [\n         helper.make_tensor_value_info(\"X\", TensorProto.FLOAT16, [3]), \n         helper.make_tensor_value_info(\"Y\", TensorProto.FLOAT16, [3])\n     ],\n     [helper.make_tensor_value_info(\"Z\", TensorProto.FLOAT16, [3])],\n )\n \n model_proto = helper.make_model(graph)\n \n sess = ort.InferenceSession(model_proto.SerializeToString())\n x_val = [1, 2, -3]\n y_val = [4, -5, -6]\n res = sess.run([\"Z\"], {\"X\": np.array(x_val, dtype=np.float16), \"Y\": np.array(y_val, dtype=np.float16)})\n print(res[0])\n # Should be [1, -5, -6] but is [1, 2, -3]\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "TomWildenhain-Microsoft", "commentT": "2020-12-23T08:50:32Z", "comment_text": "\n \t\tThanks. It looks like the CPU kernels don't handle the type properly.  Probably not affecting too many prod models though because people requiring float16 for their models usually use the CUDA/ other GPU backends. Worth fixing this though for correctness' sake.\n \t\t"}}}, "commit": {"commit_id": "7fc827a8a1c43e375ef0307576a75e61a194f761", "commit_author": "Hariharan Seshadri", "commitT": "2021-01-07 23:32:52-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "onnxruntime\\core\\providers\\cpu\\math\\element_wise_ops.cc", "file_new_name": "onnxruntime\\core\\providers\\cpu\\math\\element_wise_ops.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632", "deleted_lines": "573,574,575,625,626,627", "method_info": {"method_name": "onnxruntime::MinMaxMLFloat16", "method_params": "inst,context", "method_startline": "573", "method_endline": "632"}}, "hunk_1": {"Ismethod": 1, "added_lines": "695,696,697,698,699,700,701,702,703,704,705", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::Max_8::Compute", "method_params": "context", "method_startline": "694", "method_endline": "706"}}, "hunk_2": {"Ismethod": 1, "added_lines": "635,636,637,638,639,640,641,642,643,644,645", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::Min_8::Compute", "method_params": "context", "method_startline": "634", "method_endline": "646"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "onnxruntime\\test\\providers\\cpu\\math\\element_wise_ops_test.cc", "file_new_name": "onnxruntime\\test\\providers\\cpu\\math\\element_wise_ops_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1244,1245,1246,1247,1248,1249,1250,1251,1252,1253,1254,1255,1256,1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,1267,1268,1269,1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281,1459,1460,1461,1462,1463,1464,1465,1466,1467,1468,1469,1470,1471,1472,1473,1474,1475,1476,1477,1478,1479,1480,1481,1482,1483,1484,1485,1486,1487,1488,1489,1490,1491,1492,1493,1494,1495,1496,1497", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::TEST", "method_params": "MathOpTest,Pow_double_int64", "method_startline": "771", "method_endline": "2256"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,1267,1268", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Min_12_MLFLoat16_Scalar0", "method_startline": "1257", "method_endline": "1268"}}, "hunk_2": {"Ismethod": 1, "added_lines": "1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Min_12_MLFLoat16_Scalar1", "method_startline": "1270", "method_endline": "1281"}}, "hunk_3": {"Ismethod": 1, "added_lines": "1244,1245,1246,1247,1248,1249,1250,1251,1252,1253,1254,1255", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Min_12_MLFLoat16", "method_startline": "1244", "method_endline": "1255"}}, "hunk_4": {"Ismethod": 1, "added_lines": "1485,1486,1487,1488,1489,1490,1491,1492,1493,1494,1495,1496", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Max_12_MLFLoat16_Scalar1", "method_startline": "1485", "method_endline": "1496"}}, "hunk_5": {"Ismethod": 1, "added_lines": "1459,1460,1461,1462,1463,1464,1465,1466,1467,1468,1469,1470", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Max_12_MLFLoat16", "method_startline": "1459", "method_endline": "1470"}}, "hunk_6": {"Ismethod": 1, "added_lines": "1472,1473,1474,1475,1476,1477,1478,1479,1480,1481,1482,1483", "deleted_lines": null, "method_info": {"method_name": "onnxruntime::test::onnxruntime::test::TEST.TEST", "method_params": "MathOpTest,Max_12_MLFLoat16_Scalar0", "method_startline": "1472", "method_endline": "1483"}}}}}}}