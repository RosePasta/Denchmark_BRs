{"BR": {"BR_id": "4723", "BR_author": "JohnGiorgi", "BRopenT": "2019-11-27T16:06:50Z", "BRcloseT": "2019-12-11T17:19:43Z", "BR_text": {"BRsummary": "KeyError when trying to follow provided train_entity_linker.py script", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n Simply run the provided <denchmark-link:https://github.com/explosion/spaCy/blob/master/examples/training/pretrain_kb.py>pretrain_kb.py</denchmark-link>\n  and <denchmark-link:https://github.com/explosion/spaCy/blob/master/examples/training/train_entity_linker.py>train_entity_linker.py</denchmark-link>\n  scripts. E.g.\n <denchmark-code>python pretrain_kb.py -m en_core_web_lg -n 1 -o ./tmp\n python train_entity_linker.py ./tmp/kb ./tmp/vocab -o ./tmp -n 1       \n </denchmark-code>\n \n During the execution of the second command, a KeyError is raised with the following traceback\n <denchmark-code>Created blank 'en' model with vocab from 'tmp/vocab'\n Loaded Knowledge Base from 'tmp/kb'\n ('Russ Cochran his reprints include EC Comics.', 'Russ Cochran captured his first major title with his son as caddie.', 'Russ Cochran has been publishing comic art.', \"Russ Cochran was a member of University of Kentucky's golf team.\") ({'links': {(0, 12): {'Q7381115': 1.0, 'Q2146908': 0.0}}}, {'links': {(0, 12): {'Q7381115': 0.0, 'Q2146908': 1.0}}}, {'links': {(0, 12): {'Q7381115': 1.0, 'Q2146908': 0.0}}}, {'links': {(0, 12): {'Q7381115': 0.0, 'Q2146908': 1.0}}})\n Traceback (most recent call last):\n   File \"train_entity_linker.py\", line 167, in <module>\n     plac.call(main)\n   File \"/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/plac_core.py\", line 367, in call\n     cmd, result = parser.consume(arglist)\n   File \"/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/plac_core.py\", line 232, in consume\n     return cmd, self.func(*(args + varargs + extraopts), **kwargs)\n   File \"train_entity_linker.py\", line 127, in main\n     sgd=optimizer,\n   File \"/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/spacy/language.py\", line 515, in update\n     proc.update(docs, golds, sgd=get_grads, losses=losses, **kwargs)\n   File \"pipes.pyx\", line 1219, in spacy.pipeline.pipes.EntityLinker.update\n KeyError: (0, 12)\n </denchmark-code>\n \n There is another closed issue (<denchmark-link:https://github.com/explosion/spaCy/issues/4469>#4469</denchmark-link>\n ) that reports this same problem. Suggestions are to use the latest version of SpaCy (I tried with  and ) and to update the line\n <denchmark-code>kb = KnowledgeBase(vocab=nlp.vocab)\n </denchmark-code>\n \n in <denchmark-link:https://github.com/explosion/spaCy/blob/48ea2e8d0ff6e46f65761425c24369c5d4ac30e1/examples/training/pretrain_kb.py#L57>pretrain_kb.py</denchmark-link>\n  with\n <denchmark-code>kb = KnowledgeBase(vocab=nlp.vocab, entity_vector_length=64)\n </denchmark-code>\n \n This solution did not work for me (I recieve the same error as above).\n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n spaCy version: 2.2.2\n Platform: Darwin-19.0.0-x86_64-i386-64bit\n Python version: 3.7.5\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "JohnGiorgi", "commentT": "2019-12-10T16:06:16Z", "comment_text": "\n \t\tThanks for the very helpful report, <denchmark-link:https://github.com/JohnGiorgi>@JohnGiorgi</denchmark-link>\n  !\n The example scripts got outdated after the last refactor of the EL pipeline, which assumes the entities are properly set in the document. To simulate this, I added an EntityRuler to the example script, but for a realistic case you'd need to have a proper NER module.\n I also created a more friendly warning than the one you ran into ...\n PR <denchmark-link:https://github.com/explosion/spaCy/pull/4789>#4789</denchmark-link>\n  contains the fixes. Once merged, feel free to try the code again and let me know if there still would be any issues.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "JohnGiorgi", "commentT": "2020-01-04T16:58:35Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/svlandeg>@svlandeg</denchmark-link>\n ,\n Thanks for the PR! Sorry, this took a while, but I re-ran the scripts and now face a thinc.exceptions.ShapeMismatchError when running the latest version of the pretrain_kb.py script.\n I opened another issue regarding this error (<denchmark-link:https://github.com/explosion/spaCy/issues/4876>#4876</denchmark-link>\n )\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "JohnGiorgi", "commentT": "2020-02-03T18:46:02Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "5355b0038fa1b3a525d408b2bfadb96d5bcf980e", "commit_author": "Sofie Van Landeghem", "commitT": "2019-12-11 18:19:42+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "examples\\training\\pretrain_kb.py", "file_new_name": "examples\\training\\pretrain_kb.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "11,12", "deleted_lines": "11,12"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "examples\\training\\train_entity_linker.py", "file_new_name": "examples\\training\\train_entity_linker.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "74,75,76,77,78,79,80,81,82,83,84,86,87,88,95,96,97,98,100,101,102,112,113,121,124", "deleted_lines": "73,74,76,82,83,84,86,87,98,106,109,141,142,143,144,145,146,147,149,150", "method_info": {"method_name": "main", "method_params": "kb_path,vocab_path,output_dir,n_iter", "method_startline": "65", "method_endline": "151"}}, "hunk_1": {"Ismethod": 1, "added_lines": "157", "deleted_lines": null, "method_info": {"method_name": "_apply_model", "method_params": "nlp", "method_startline": "154", "method_endline": "160"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\errors.py", "file_new_name": "spacy\\errors.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "534,535,536", "deleted_lines": null}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\pipeline\\pipes.pyx", "file_new_name": "spacy\\pipeline\\pipes.pyx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1223,1225,1226,1232,1233,1234,1235,1236", "deleted_lines": "1229"}}}}}}