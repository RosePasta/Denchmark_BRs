{"BR": {"BR_id": "3437", "BR_author": "01alex", "BRopenT": "2019-03-19T22:16:19Z", "BRcloseT": "2019-03-20T00:00:08Z", "BR_text": {"BRsummary": "Spacy 2.1 bug when running with GPU: 'gpu_ops' is not defined", "BRdescription": "\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n <denchmark-code>!pip install -U spacy\n !python -m spacy download en\n \n import spacy\n \n gpu = spacy.prefer_gpu()\n print('GPU:', gpu)\n \n nlp = spacy.load(\"en_core_web_sm\")\n \n doc = nlp(\"This is a sentence. This is another sentence.\")\n for sent in doc.sents:\n     print(sent.text)\n </denchmark-code>\n \n <denchmark-h:h3>Output</denchmark-h>\n \n <denchmark-code>GPU: True\n ---------------------------------------------------------------------------\n NameError                                 Traceback (most recent call last)\n <ipython-input-3-1313493bc47b> in <module>()\n       6 nlp = spacy.load(\"en_core_web_sm\")\n       7 \n ----> 8 doc = nlp(\"This is a sentence. This is another sentence.\")\n       9 for sent in doc.sents:\n      10     print(sent.text)\n \n (...)\n \n ops.pyx in thinc.neural.ops.CupyOps.hash()\n \n NameError: name 'gpu_ops' is not defined\n \n </denchmark-code>\n \n This exact same code worked yesterday with the previous release.\n <denchmark-h:h3>Note</denchmark-h>\n \n If I do:\n <denchmark-code>!pip uninstall thinc\n !pip install thinc==7.0.3\n </denchmark-code>\n \n It works correctly:\n <denchmark-code>GPU: True\n This is a sentence.\n This is another sentence.\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n spaCy version: 2.1.0\n Platform: Linux-4.14.79+-x86_64-with-Ubuntu-18.04-bionic\n Python version: 3.6.7\n Models: en\n Environment Information: Google Colaboratory (Python 3 Google Compute Engine backend (GPU)), CUDA 10.0\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "01alex", "commentT": "2019-03-19T22:40:27Z", "comment_text": "\n \t\tDid you install the new version in the same environment as the old one, and did you specify your CUDA version <denchmark-link:https://spacy.io/usage#gpu>as described here</denchmark-link>\n ? It's possible that you ended up with stale files or packages in your , or Thinc didn't correctly pull in the .\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "01alex", "commentT": "2019-03-19T23:47:33Z", "comment_text": "\n \t\tSo I ran two new Python 3 Google Compute Engine backend (GPU).\n The first with the default spaCy 2.0.18.\n The example:\n <denchmark-code>import spacy\n \n nlp = spacy.load(\"en_core_web_sm\")\n doc = nlp(\"This is a sentence. This is another sentence.\")\n for sent in doc.sents:\n     print(sent.text)\n </denchmark-code>\n \n It works fine. Then I required the gpu after import spacy, it returns true and throws the error.\n In another runtime, I started with:\n <denchmark-code>!pip install -U spacy[cuda100]\n !python -m spacy download en\n </denchmark-code>\n \n The update output:\n <denchmark-code>Installing collected packages: srsly, numpy, wasabi, blis, thinc, spacy\n   Found existing installation: numpy 1.14.6\n     Uninstalling numpy-1.14.6:\n       Successfully uninstalled numpy-1.14.6\n   Found existing installation: thinc 6.12.1\n     Uninstalling thinc-6.12.1:\n       Successfully uninstalled thinc-6.12.1\n   Found existing installation: spacy 2.0.18\n     Uninstalling spacy-2.0.18:\n       Successfully uninstalled spacy-2.0.18\n Successfully installed blis-0.2.4 numpy-1.16.2 spacy-2.1.0 srsly-0.0.5 thinc-7.0.4 wasabi-0.1.4\n </denchmark-code>\n \n Checked version 2.1.0.  Ran the example snippet. It works fine on cpu. Required gpu and got the same error.\n It was working fine yesterday with spaCy 2.0.18.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "01alex", "commentT": "2019-03-20T00:03:01Z", "comment_text": "\n \t\tThanks, this was a regression introduced when fixing <denchmark-link:https://github.com/explosion/spaCy/issues/3430>#3430</denchmark-link>\n  .\n Thinc v7.0.3 required the thinc_gpu_ops module, which caused problems if CUDA was installed but no GPU was available (or if no compiler was installed).\n The fix is to make the thinc_gpu_ops module an extras_require. This was set correctly in Thinc v7.0.4, but I didn't set it in spaCy. Have triggered a build for v2.1.1 to fix this.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "01alex", "commentT": "2019-04-19T00:59:02Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "02d7b41893a98800c3a9514234a1d525868e611e", "commit_author": "Matthew Honnibal", "commitT": "2019-03-20 00:59:27+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "setup.py", "file_new_name": "setup.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "241,242,243,244,245,246", "deleted_lines": "241,242,243,244,245,246", "method_info": {"method_name": "setup_package", "method_params": "", "method_startline": "159", "method_endline": "271"}}}}}}}