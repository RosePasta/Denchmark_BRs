{"BR": {"BR_id": "505", "BR_author": "omrihar", "BRopenT": "2020-01-29T10:15:20Z", "BRcloseT": "2020-01-30T14:44:22Z", "BR_text": {"BRsummary": "Using curl to test lambda deployment fails with dataframe handler", "BRdescription": "\n Describe the bug\n I deployed a model that uses the DataFrameHandler to aws lambda. When I test it with curl, using, e.g.\n curl -i --request POST --data '{\"key\": \"value\"}' https://<url>/Prod/predict\n I get as response an Internal server error. The cloudwatch logs indicate a problem with the Content-Type header:\n <denchmark-code>[ERROR] KeyError: 'Content-Type'\n Traceback (most recent call last):\n   File \"/var/task/app.py\", line 66, in api_func\n     return bento_service_api.handle_aws_lambda_event(event)\n   File \"/var/task/bentoml/service.py\", line 98, in handle_aws_lambda_event\n     return self.handler.handle_aws_lambda_event(event, self.func)\n   File \"/var/task/bentoml/handlers/dataframe_handler.py\", line 203, in handle_aws_lambda_event\n     if event[\"headers\"][\"Content-Type\"] == \"application/json\":\n </denchmark-code>\n \n When using requests in an ipython shell, however, the request goes as expected. e.g.\n import requests\n resp = requests.post(url, json={\"key\": \"value\"})\n works exactly as expected.\n To Reproduce\n Steps to reproduce the behavior:\n \n Deploy a lambda function that uses the DataFrameHandler\n Use curl as described above.\n See error\n \n Expected behavior\n A response should be sent back instead of an error.\n Environment:\n \n OS: Manjaro linux  5.4.14-2\n Python/BentoML Version Python 3.7.6, BentoML-0.6.1\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "omrihar", "commentT": "2020-01-29T20:23:41Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/omrihar>@omrihar</denchmark-link>\n  I couldn't reproduce this issue on my end this time(I was able to get the error when using curl from a ubuntu docker container testing your deployment endpoint last time we discussed it in slack).\n I suspect in some edge case   will set the content-type header improperly in a way that AWS Lambda can not handle. <denchmark-link:https://github.com/bentoml/BentoML/pull/507>#507</denchmark-link>\n  should help with this issue you're encountering.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "omrihar", "commentT": "2020-01-29T21:39:03Z", "comment_text": "\n \t\tJust merged the pull request, if you installed BentoML from master now and used that version of BentoML to save a new BentoService bundle, you should be able to deploy it to lambda including this change. Let me know if that helped with the issue you ran into.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "omrihar", "commentT": "2020-01-30T11:08:57Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/parano>@parano</denchmark-link>\n , I suspect that you are correct. I am unable to deploy to lambda from the master version of bentoml, because the PythonPipBuilder isn't able to find the bentoml version. I'll try to edit the source files of the installed bentoml I have locally and see if this will work though...\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "omrihar", "commentT": "2020-01-30T14:44:21Z", "comment_text": "\n \t\tOK, I manually applied these changes to an already-deployed lambda function by downloading it, modifying, and uploading again and it works. So I guess we can close this now.\n \t\t"}}}, "commit": {"commit_id": "736b24b9affb215541b3458a51ad8ccab9b840c7", "commit_author": "Chaoyu", "commitT": "2020-01-29 13:25:46-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "bentoml\\handlers\\dataframe_handler.py", "file_new_name": "bentoml\\handlers\\dataframe_handler.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "205,208,209,210,211,212,213,214,215,216,217", "deleted_lines": "204,205,206,207,210,211,212,213", "method_info": {"method_name": "handle_aws_lambda_event", "method_params": "self,event,func", "method_startline": "204", "method_endline": "226"}}, "hunk_1": {"Ismethod": 1, "added_lines": "125,129,130,131,132,133,134,135,136,137,138,139,140,141", "deleted_lines": "125,126,127,128,129,130,131,132,136,137,138,139", "method_info": {"method_name": "handle_request", "method_params": "self,request,func", "method_startline": "124", "method_endline": "150"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "bentoml\\yatai\\yatai_service_impl.py", "file_new_name": "bentoml\\yatai\\yatai_service_impl.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "332,333,334", "deleted_lines": "332,333", "method_info": {"method_name": "GetBento", "method_params": "self,request,context", "method_startline": "324", "method_endline": "349"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\handlers\\test_dataframe_handler.py", "file_new_name": "tests\\handlers\\test_dataframe_handler.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "52,56,57,58,60,61,62,63,64,65,66,67,68,69,72,73,74,76", "deleted_lines": "52,56,58,59,62,63,64,66", "method_info": {"method_name": "test_dataframe_handle_aws_lambda_event", "method_params": "", "method_startline": "45", "method_endline": "76"}}}}}}}