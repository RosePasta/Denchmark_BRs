{"BR": {"BR_id": "1174", "BR_author": "jiyer2016", "BRopenT": "2020-10-14T09:50:09Z", "BRcloseT": "2020-10-15T03:42:42Z", "BR_text": {"BRsummary": "Cannot retrieve BentoService from S3 Minio", "BRdescription": "\n Describe the bug\n I have a Yatai-Service configured with S3 Minio and local Database (Note - I would normally use PostgresSQL - but cannot do that at the moment due to some other unrelated issue).\n I run the following in my docker build process:\n <denchmark-code>bentoml config set yatai_service.url=http://yatai-url\n bentoml retrieve Service:20201014125939_6C7163 --target_dir /bentoservice \n \n </denchmark-code>\n \n However - I run into the following error:botocore .exceptions.NoCredentialsError: Unable to locate credentials\n Why is it expecting the S3 credentials ? This was working earlier.\n Here is the full stack trace.\n <denchmark-code>Step 3/5 : RUN bentoml retrieve Service:20201014125939_6C7163 --target_dir /bentoservice\n  ---> Running in e46b6f76e28a\n Traceback (most recent call last):\n   File \"/usr/local/bin/bentoml\", line 8, in <module>\n     sys.exit(cli())\n   File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 829, in __call__\n     return self.main(*args, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 782, in main\n     rv = self.invoke(ctx)\n   File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1259, in invoke\n     return _process_result(sub_ctx.command.invoke(sub_ctx))\n   File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 1066, in invoke\n     return ctx.invoke(self.callback, **ctx.params)\n   File \"/usr/local/lib/python3.8/site-packages/click/core.py\", line 610, in invoke\n     return callback(*args, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/cli/click_utils.py\", line 138, in wrapper\n     return func(*args, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/cli/click_utils.py\", line 115, in wrapper\n     return_value = func(*args, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/cli/click_utils.py\", line 99, in wrapper\n     return func(*args, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/cli/bento_management.py\", line 267, in retrieve\n     safe_retrieve(bento_service_bundle_path, target_dir)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/saved_bundle/loader.py\", line 227, in safe_retrieve\n     with _resolve_remote_bundle_path(bundle_path) as local_bundle_path:\n   File \"/usr/local/lib/python3.8/contextlib.py\", line 113, in __enter__\n     return next(self.gen)\n   File \"/usr/local/lib/python3.8/site-packages/bentoml/saved_bundle/loader.py\", line 60, in _resolve_remote_bundle_path\n     s3.download_fileobj(bucket_name, object_name, fileobj)\n   File \"/usr/local/lib/python3.8/site-packages/boto3/s3/inject.py\", line 678, in download_fileobj\n     return future.result()\n   File \"/usr/local/lib/python3.8/site-packages/s3transfer/futures.py\", line 106, in result\n     return self._coordinator.result()\n   File \"/usr/local/lib/python3.8/site-packages/s3transfer/futures.py\", line 265, in result\n     raise self._exception\n   File \"/usr/local/lib/python3.8/site-packages/s3transfer/tasks.py\", line 255, in _main\n     self._submit(transfer_future=transfer_future, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/s3transfer/download.py\", line 340, in _submit\n     response = client.head_object(\n   File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 357, in _api_call\n     return self._make_api_call(operation_name, kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 662, in _make_api_call\n     http, parsed_response = self._make_request(\n   File \"/usr/local/lib/python3.8/site-packages/botocore/client.py\", line 682, in _make_request\n     return self._endpoint.make_request(operation_model, request_dict)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 102, in make_request\n     return self._send_request(request_dict, operation_model)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 132, in _send_request\n     request = self.create_request(request_dict, operation_model)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/endpoint.py\", line 115, in create_request\n     self._event_emitter.emit(event_name, request=request,\n   File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 356, in emit\n     return self._emitter.emit(aliased_event_name, **kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 228, in emit\n     return self._emit(event_name, kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/hooks.py\", line 211, in _emit\n     response = handler(**kwargs)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/signers.py\", line 90, in handler\n     return self.sign(operation_name, request)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/signers.py\", line 162, in sign\n     auth.add_auth(request)\n   File \"/usr/local/lib/python3.8/site-packages/botocore/auth.py\", line 357, in add_auth\n     raise NoCredentialsError\n botocore.exceptions.NoCredentialsError: Unable to locate credentials\n The command '/bin/sh -c bentoml retrieve Service:20201014125939_6C7163 --target_dir /bentoservice' returned a non-zero code: 1\n </denchmark-code>\n \n Initially, I thought this had something to do with my docker build environment - but then I was able to recreate the same error on my windows laptop.\n To debug further - On my windows laptop - I added an .aws credentials file - 'C:/Users/my_userid/.aws/credentials' and retried the retrieve operation. In this case - it went past the above error - but now fails with the following:\n botocore.exceptions.ClientError: An error occurred (403) when calling the HeadObject operation: Forbidden\n See full stack trace below:\n <denchmark-code>[2020-10-14 14:42:11,774] DEBUG - Setting debug mode: ON for current session\n [2020-10-14 14:42:12,575] DEBUG - Connecting YataiService gRPC server at: http://yatai-url\n Traceback (most recent call last):\n   File \"C:\\Program Files\\Python38\\lib\\runpy.py\", line 194, in _run_module_as_main\n     return _run_code(code, main_globals, None,\n   File \"C:\\Program Files\\Python38\\lib\\runpy.py\", line 87, in _run_code\n     exec(code, run_globals)\n   File \"C:\\pyvenvs\\model_deployment\\Scripts\\bentoml.exe\\__main__.py\", line 7, in <module>\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\click\\core.py\", line 829, in __call__\n     return self.main(*args, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\click\\core.py\", line 782, in main\n     rv = self.invoke(ctx)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\click\\core.py\", line 1259, in invoke\n     return _process_result(sub_ctx.command.invoke(sub_ctx))\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\click\\core.py\", line 1066, in invoke\n     return ctx.invoke(self.callback, **ctx.params)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\click\\core.py\", line 610, in invoke\n     return callback(*args, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\cli\\click_utils.py\", line 138, in wrapper\n     return func(*args, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\cli\\click_utils.py\", line 115, in wrapper\n     return_value = func(*args, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\cli\\click_utils.py\", line 99, in wrapper\n     return func(*args, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\cli\\bento_management.py\", line 267, in retrieve\n     safe_retrieve(bento_service_bundle_path, target_dir)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\saved_bundle\\loader.py\", line 227, in safe_retrieve\n     with _resolve_remote_bundle_path(bundle_path) as local_bundle_path:\n   File \"C:\\Program Files\\Python38\\lib\\contextlib.py\", line 113, in __enter__\n     return next(self.gen)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\bentoml\\saved_bundle\\loader.py\", line 60, in _resolve_remote_bundle_path\n     s3.download_fileobj(bucket_name, object_name, fileobj)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\boto3\\s3\\inject.py\", line 678, in download_fileobj\n     return future.result()\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\s3transfer\\futures.py\", line 106, in result\n     return self._coordinator.result()\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\s3transfer\\futures.py\", line 265, in result\n     raise self._exception\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\s3transfer\\tasks.py\", line 255, in _main\n     self._submit(transfer_future=transfer_future, **kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\s3transfer\\download.py\", line 340, in _submit\n     response = client.head_object(\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\botocore\\client.py\", line 316, in _api_call\n     return self._make_api_call(operation_name, kwargs)\n   File \"c:\\pyvenvs\\model_deployment\\lib\\site-packages\\botocore\\client.py\", line 635, in _make_api_call\n     raise error_class(parsed_response, operation_name)\n botocore.exceptions.ClientError: An error occurred (403) when calling the HeadObject operation: Forbidden\n </denchmark-code>\n \n Environment:\n \n OS: Windows / RHEL\n Python Version -  3.8.x\n BentoML-0.9.1\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jiyer2016", "commentT": "2020-10-14T13:04:24Z", "comment_text": "\n \t\tI want to add that when I rolled back to v0.8.6 of BentoML - the errors go away.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jiyer2016", "commentT": "2020-10-15T00:59:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jiyer2016>@jiyer2016</denchmark-link>\n  Thanks for finding this bug. It was introduced with the GCP storage support.  I am adding test to prevent this for future releases.\n \t\t"}}}, "commit": {"commit_id": "123fce97a3151b3c467a1105109e793d152ec7a8", "commit_author": "Bozhao", "commitT": "2020-10-14 20:42:42-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "bentoml\\cli\\bento_management.py", "file_new_name": "bentoml\\cli\\bento_management.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "262", "deleted_lines": "262", "method_info": {"method_name": "add_bento_sub_command.retrieve", "method_params": "bento,target_dir", "method_startline": "242", "method_endline": "269"}}, "hunk_1": {"Ismethod": 1, "added_lines": "262", "deleted_lines": "262", "method_info": {"method_name": "add_bento_sub_command", "method_params": "cli", "method_startline": "94", "method_endline": "269"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "e2e_tests\\yatai_server\\test_sqlite_gcs.py", "file_new_name": "e2e_tests\\yatai_server\\test_sqlite_gcs.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "33,34,35,36,37", "deleted_lines": null, "method_info": {"method_name": "test_yatai_server_with_sqlite_and_gcs", "method_params": "", "method_startline": "16", "method_endline": "45"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "e2e_tests\\yatai_server\\test_sqlite_s3.py", "file_new_name": "e2e_tests\\yatai_server\\test_sqlite_s3.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "36,37,38,39", "deleted_lines": null, "method_info": {"method_name": "test_yatai_server_with_sqlite_and_s3", "method_params": "", "method_startline": "16", "method_endline": "48"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "e2e_tests\\yatai_server\\utils.py", "file_new_name": "e2e_tests\\yatai_server\\utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54", "deleted_lines": null, "method_info": {"method_name": "execute_bentoml_retrieve_command", "method_params": "bento_tag", "method_startline": "38", "method_endline": "54"}}}}}}}