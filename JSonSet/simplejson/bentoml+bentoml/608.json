{"BR": {"BR_id": "608", "BR_author": "smolendawid", "BRopenT": "2020-04-23T12:07:26Z", "BRcloseT": "2020-04-27T08:56:06Z", "BR_text": {"BRsummary": "Python code dependencies not saved in SavedBundle", "BRdescription": "\n Describe the bug\n After saving the object bentoml.BentoService with save() method, I have everything working except that my local package (recognition) is not saved in the Bundle. While saving I can see the warning:\n WARNING - unknown package dependency for module: recognition\n Expected behavior\n I'd like SavedBundle to contain python code dependencies, not only PyPI dependencies.\n Environment:\n \n OS: [e.g. MacOS 10.15.1]\n Python/BentoML Version [e.g. Python 3.7.1, BentoML-0.0.5]\n \n My project structure is\n <denchmark-code>Project/:\n   - bento_server/\n     - MyClass.py\n     - server.py - I save Bundle here\n   - recognition/\n     - model.py\n </denchmark-code>\n \n I run bento_server/server.py from Project root, with export PYTHONPATH./\n So bento_server/server.py starts with\n import recognition.model\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "smolendawid", "commentT": "2020-04-23T22:04:28Z", "comment_text": "\n \t\thi <denchmark-link:https://github.com/smolendawid>@smolendawid</denchmark-link>\n , thank you for reporting this issue. Python code dependencies are expected to be bundled with BentoML . Here are some unit test covering this behavior:\n <denchmark-link:https://github.com/bentoml/BentoML/blob/master/tests/test_bundle_local_dependencies.py>https://github.com/bentoml/BentoML/blob/master/tests/test_bundle_local_dependencies.py</denchmark-link>\n \n <denchmark-link:https://github.com/bentoml/BentoML/blob/master/tests/bento_service_examples/local_dependencies/my_test_bento_service.py>https://github.com/bentoml/BentoML/blob/master/tests/bento_service_examples/local_dependencies/my_test_bento_service.py</denchmark-link>\n  This might be an edge case where our implementation does not work.\n Question about your project structure -  the server.py file is where you call my_bento_service.save() and your BentoService class is defined in MyClass.py file right? Do you also have import recognition.model in the MyClass.py file?  And was the recognition.model module only used in training/saving time? or is it also required in serving time?\n It would be a great help if you could share those two files, you can remove the code not related to BentoML.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "smolendawid", "commentT": "2020-04-24T17:00:12Z", "comment_text": "\n \t\t\n Question about your project structure - the server.py file is where you call my_bento_service.save() and your BentoService class is defined in MyClass.py file right?\n \n Exactly\n \n And was the recognition.model module only used in training/saving time? or is it also required in serving time?\n \n The local dependencies are mainly for the model loading but also for the serving.\n Well, I'll try to upload my anonymized files. The original local dependencies are pretty complex.\n bento_server/server.py:\n <denchmark-code>import sys\n from os import path\n sys.path.append(path.dirname(path.dirname(path.abspath(__file__))))\n \n from recognition.my_model import load_model\n from bento_server.my_class import MyClass\n \n \n if __name__ == '__main__':\n \n     model, converter, opt = load_model('path')\n \n     bento_svc = MyClass()\n     bento_svc.pack('recognizer', model)\n     saved_path = bento_svc.save()\n     print(saved_path)\n </denchmark-code>\n \n bento_server/my_class.py:\n <denchmark-code>import sys\n from os import path\n sys.path.append(path.dirname(path.dirname(path.abspath(__file__))))\n \n import bentoml\n from bentoml.artifact import PytorchModelArtifact\n from bentoml.handlers import ImageHandler\n \n from recognition.my_model import recognize\n \n \n pip_dependencies = [\n     'bentoml==0.7.3',\n     'torch==1.4.0',\n     'pillow==7.0.0',\n     'numpy==1.18.1',\n ]\n \n @bentoml.env(pip_dependencies=pip_dependencies)\n @bentoml.artifacts([PytorchModelArtifact('recognizer')])\n class MyClass(bentoml.BentoService):\n \n     def _prepare_input(self, image):\n \n         return image\n \n     @bentoml.api(ImageHandler, pilmode='RGB')\n     def predict(self, image: np.ndarray):\n         image = self._prepare_input(image)\n         prediction = recognize(image,  self.artifacts.recognizer)\n \n         return prediction\n \n </denchmark-code>\n \n So we have recognition.my_model that has load_model() and recognize() functions. The former is used only in server.py for loading the model for artifacts (Bundle knows how to load it later, doesn't it?) and the latter is used during serving.\n TBH I don't know why but I don't see the warning anymore. But it's still not adding local dependencies. I can verify them added looking into the bentoml/ correct version and seeing the original files there, like recognition/my_model.py, yes?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "smolendawid", "commentT": "2020-04-26T05:29:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/smolendawid>@smolendawid</denchmark-link>\n  thanks for sharing the details, it may has to do with the , I will try to reproduce on my end.\n And yes you can verify by looking for the file in the generated SavedBundle directory. You can find the directory path using the bentoml CLI, e.g.: bentoml get PyTorchVINModel:latest, the path is in the uri field of the CLI's json output. Could you verify if you see the recognition/my_model.py file in that directory?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "smolendawid", "commentT": "2020-04-26T05:35:34Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/smolendawid>@smolendawid</denchmark-link>\n  do you mind add the following lines before the code that saves the BentoService and share with us the logs? This code will enable debug logs which will help us diagnose this issue.\n <denchmark-code>import bentoml\n import logging\n bentoml.config().set('core', 'debug', 'true')\n bentoml.utils.log.configure_logging(logging.DEBUG)\n </denchmark-code>\n \n Thanks!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "smolendawid", "commentT": "2020-04-26T09:13:56Z", "comment_text": "\n \t\t\n @smolendawid thanks for sharing the details, it may has to do with the sys.path.append(path.dirname(path.dirname(path.abspath(file)))), I will try to reproduce on my end.\n \n Well it's necessary if I want to run bento related scripts from the main project directory like python bento_server/server.py and python bento_server/my_class.py. Otherwise, I would have to run export PYTHONPATH=./ in main directory.\n \n And yes you can verify by looking for the file in the generated SavedBundle directory.\n \n Indeed, the required local dependencies are not there.\n I attach the logs,\n \n 4] DEBUG - Created temporary directory: /private/var/folders/xc/958bb1gj3dz57_7qy64gw45xnj4n1d/T/bentoml-temp-yyqybcar\n [2020-04-26 11:05:42,721] DEBUG - copy_used_py_modules target_module_name: bento_server.my_class, target_module_file: /Users/dasm/projects/Project/bento_server/my_class.py\n [2020-04-26 11:05:42,721] DEBUG - Searching for dependant modules of bento_server.my_class:/Users/dasm/projects/Project/bento_server/my_class.py\n [2020-04-26 11:05:59,283] DEBUG - Ignoring deps within local site-packages path: ['/Library/Frameworks/Python.framework/Versions/3.7/lib/python37.zip', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/lib-dynload', '/Users/dasm/venv/lib/python3.7/site-packages', '/Users/dasm/venv/lib/python3.7/site-packages/typing-3.7.4.1-py3.7.egg', '/Users/dasm/venv/lib/python3.7/site-packages/IPython/extensions', '/Users/dasm/venv', '/Library/Frameworks/Python.framework/Versions/3.7']\n [2020-04-26 11:05:59,283] DEBUG - User local module deps found: main\n [2020-04-26 11:05:59,291] DEBUG - Copying user local python dependencies: {'bento_server.my_class': <module 'bento_server.my_class' from '/Users/dasm/projects/Project/bento_server/my_class.py'>}\n [2020-04-26 11:05:59,291] DEBUG - Copying local python module '/Users/dasm/projects/Project/bento_server/my_class.py'\n [2020-04-26 11:05:59,291] DEBUG - Creating empty init.py under folder:'/private/var/folders/xc/958bb1gj3dz57_7qy64gw45xnj4n1d/T/bentoml-temp-yyqybcar/MyClass'\n [2020-04-26 11:05:59,292] DEBUG - Creating empty init.py under folder:'/private/var/folders/xc/958bb1gj3dz57_7qy64gw45xnj4n1d/T/bentoml-temp-yyqybcar/MyClass/artifacts'\n [2020-04-26 11:05:59,292] DEBUG - Creating empty init.py under folder:'/private/var/folders/xc/958bb1gj3dz57_7qy64gw45xnj4n1d/T/bentoml-temp-yyqybcar/MyClass/bento_server'\n [2020-04-26 11:05:59,292] DEBUG - Done copying local python dependant modules\n [2020-04-26 11:05:59,525] INFO - BentoService bundle 'MyClass:20200426110541_5BDB97' saved to: /Users/dasm/bentoml/repository/MyClass/20200426110541_5BDB97\n [2020-04-26 11:05:59,525] DEBUG - BentoML in debug mode, keeping temp directory \"/private/var/folders/xc/958bb1gj3dz57_7qy64gw45xnj4n1d/T/bentoml-temp-yyqybcar\"\n /Users/dasm/bentoml/repository/MyClass/20200426110541_5BDB97\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "smolendawid", "commentT": "2020-04-26T09:54:24Z", "comment_text": "\n \t\tI'm getting familiar with bentml, so maybe I'll be able to solve that issue. In bundler/py_module_utils.py, my local dependencies are in bad_modules attribute of finder.\n in modulefinder.py in find_head_package(self, parent, name) parent=None  and name=recognition.my_model. This function fails. I don't understand how the input should look like, maybe parent=recognition and my_model=name. I'll debug it later, thanks for help\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "smolendawid", "commentT": "2020-04-27T05:53:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/smolendawid>@smolendawid</denchmark-link>\n  I tried with a few examples that modify  and everything seems to work, see a test that I added here: <denchmark-link:https://github.com/bentoml/BentoML/pull/611>#611</denchmark-link>\n \n Could you try creating a minimal sample project that can reproduce this problem?\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "smolendawid", "commentT": "2020-04-27T08:56:06Z", "comment_text": "\n \t\tWell, my bad. I didn't have  file in . <denchmark-link:https://github.com/parano>@parano</denchmark-link>\n  I appreciate your support greatly!\n \t\t"}}}, "commit": {"commit_id": "873fd16e98c516307e3ec4a0a2cf4faf99a9a226", "commit_author": "Chaoyu", "commitT": "2020-04-27 11:27:03-07:00", "changed_files": {"file_0": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tests\\bento_service_examples\\bento_service_with_modified_sys_path.py"}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\test_bundle_local_dependencies.py", "file_new_name": "tests\\test_bundle_local_dependencies.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "55,56,57,59,60", "deleted_lines": null, "method_info": {"method_name": "test_bundle_local_dependencies_with_modified_sys_path", "method_params": "", "method_startline": "55", "method_endline": "60"}}, "hunk_1": {"Ismethod": 1, "added_lines": "10,16,17,20,23,25,44", "deleted_lines": "12,18,19,22,25,27", "method_info": {"method_name": "run_test_with_bento_service_class", "method_params": "bento_service_class", "method_startline": "10", "method_endline": "44"}}, "hunk_2": {"Ismethod": 1, "added_lines": "47,48,49,50,51,52", "deleted_lines": "47", "method_info": {"method_name": "test_bundle_local_dependencies", "method_params": "", "method_startline": "47", "method_endline": "52"}}}}}}}