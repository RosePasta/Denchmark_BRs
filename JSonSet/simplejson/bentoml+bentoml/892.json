{"BR": {"BR_id": "892", "BR_author": "oonisim", "BRopenT": "2020-07-14T01:46:39Z", "BRcloseT": "2020-07-23T18:13:57Z", "BR_text": {"BRsummary": "Yatai does not handle the STS assumed role in operator.get_arn_role_from_current_aws_user()", "BRdescription": "\n Describe the bug\n Yatai causes the error:\n <denchmark-code>Error: sagemaker deploy failed: INTERNAL:Not supported role type assumed-role; sts arn is arn:aws:sts::103365315157:assumed-role/<rolename>/<username>\n </denchmark-code>\n \n because <denchmark-link:https://github.com/bentoml/BentoML/blob/master/bentoml/yatai/deployment/sagemaker/operator.py>bentoml/yatai/deployment/sagemaker/operator.py</denchmark-link>\n  does not handle assumed role by checking type_role[0] is either \"user\", \"root\", or \"role\".\n <denchmark-code>def get_arn_role_from_current_aws_user():\n     sts_client = boto3.client(\"sts\")\n     identity = sts_client.get_caller_identity()\n     sts_arn = identity[\"Arn\"]\n     sts_arn_list = sts_arn.split(\":\")\n     type_role = sts_arn_list[-1].split(\"/\")\n     iam_client = boto3.client(\"iam\")\n     if type_role[0] in (\"user\", \"root\"):\n         role_list = iam_client.list_roles()\n         arn = None\n         for role in role_list[\"Roles\"]:\n             policy_document = role[\"AssumeRolePolicyDocument\"]\n             statement = policy_document[\"Statement\"][0]\n             if (\n                 statement[\"Effect\"] == \"Allow\"\n                 and statement[\"Principal\"].get(\"Service\", None)\n                 == \"sagemaker.amazonaws.com\"\n             ):\n                 arn = role[\"Arn\"]\n         if arn is None:\n             raise YataiDeploymentException(\n                 \"Can't find proper Arn role for Sagemaker, please create one and try \"\n                 \"again\"\n             )\n         return arn\n     elif type_role[0] == \"role\":\n         role_response = iam_client.get_role(RoleName=type_role[1])\n         return role_response[\"Role\"][\"Arn\"]\n  \n     raise YataiDeploymentException(\n         \"Not supported role type {}; sts arn is {}\".format(type_role[0], sts_arn)    # <-----\n     )\n </denchmark-code>\n \n However, as in [Boto3 STS get_caller_identity] (<denchmark-link:https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts.html#STS.Client.get_caller_identity>https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts.html#STS.Client.get_caller_identity</denchmark-link>\n ), type_role[0] can be \"assumed-role\". Which is common in AWS when a user need to switch roles depending on the environment.\n <denchmark-code>response = client.get_caller_identity(\n )\n print(response)\n -----\n Expected Output: {\n     'Account': '123456789012',\n     'Arn': 'arn:aws:sts::123456789012:assumed-role/my-role-name/my-role-session-name',    <----- \"assumed-role\"\n     'UserId': 'AKIAI44QH8DHBEXAMPLE:my-role-session-name',\n     'ResponseMetadata': {\n         '...': '...',\n     },\n }\n </denchmark-code>\n \n To Reproduce\n Steps to reproduce the behavior:\n \n With AWS CLI, assume role (https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html)\n Run Sagemaker deployment.\n \n <denchmark-code>$ bentoml sagemaker deploy my-first-sagemaker-deployment -b IrisClassifier:20200713155751_57AC77 --api-name predict\n </denchmark-code>\n \n \n See error\n \n Expected behavior\n Assumed role situation is handled and causes no error at deployment.\n Screenshots/Logs\n If applicable, add screenshots, logs or error outputs to help explain your problem.\n <denchmark-code>$ bentoml sagemaker deploy my-first-sagemaker-deployment -b IrisClassifier:20200713155751_57AC77 --api-name predict\n ...\n ==> WARNING: A newer version of conda exists. <==\n   current version: 4.8.2\n   latest version: 4.8.3\n \n Please update conda by running\n \n     $ conda update -n base -c defaults conda\n \n \n \n [2020-07-14 10:47:28,586] INFO - #\n # To activate this environment, use\n #\n #     $ conda activate base\n #\n # To deactivate an active environment, use\n #\n #     $ conda deactivate\n \n \n |[2020-07-14 10:47:28,921] INFO - + pip install -r ./requirements.txt\n \n /[2020-07-14 10:47:29,645] INFO - Collecting scikit-learn\n \n |[2020-07-14 10:47:29,694] INFO -   Downloading scikit_learn-0.23.1-cp37-cp37m-manylinux1_x86_64.whl (6.8 MB)\n \n \\[2020-07-14 10:47:31,479] INFO - Collecting pandas\n \n [2020-07-14 10:47:31,494] INFO -   Downloading pandas-1.0.5-cp37-cp37m-manylinux1_x86_64.whl (10.1 MB)\n \n /[2020-07-14 10:47:33,745] INFO - Requirement already satisfied: bentoml==0.8.3 in /opt/conda/lib/python3.7/site-packages (from -r ./requirements.txt (line 3)) (0.8.3)\n \n \\[2020-07-14 10:47:33,969] INFO - Collecting threadpoolctl>=2.0.0\n \n [2020-07-14 10:47:33,981] INFO -   Downloading threadpoolctl-2.1.0-py3-none-any.whl (12 kB)\n \n |[2020-07-14 10:47:34,294] INFO - Collecting scipy>=0.19.1\n \n [2020-07-14 10:47:34,308] INFO -   Downloading scipy-1.5.1-cp37-cp37m-manylinux1_x86_64.whl (25.9 MB)\n \n |[2020-07-14 10:47:40,018] INFO - Collecting joblib>=0.11\n \n [2020-07-14 10:47:40,031] INFO -   Downloading joblib-0.16.0-py3-none-any.whl (300 kB)\n \n \\[2020-07-14 10:47:40,134] INFO - Requirement already satisfied: numpy>=1.13.3 in /opt/conda/lib/python3.7/site-packages (from scikit-learn->-r ./requirements.txt (line 1)) (1.19.0)\n \n [2020-07-14 10:47:40,136] INFO - Requirement already satisfied: python-dateutil>=2.6.1 in /opt/conda/lib/python3.7/site-packages (from pandas->-r ./requirements.txt (line 2)) (2.8.0)\n \n /[2020-07-14 10:47:40,325] INFO - Collecting pytz>=2017.2\n \n [2020-07-14 10:47:40,339] INFO -   Downloading pytz-2020.1-py2.py3-none-any.whl (510 kB)\n \n \\[2020-07-14 10:47:40,544] INFO - Requirement already satisfied: gunicorn in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (20.0.4)\n \n [2020-07-14 10:47:40,551] INFO - Requirement already satisfied: prometheus-client in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.8.0)\n \n [2020-07-14 10:47:40,555] INFO - Requirement already satisfied: psutil in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (5.7.0)\n \n [2020-07-14 10:47:40,559] INFO - Requirement already satisfied: alembic in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.4.2)\n \n [2020-07-14 10:47:40,564] INFO - Requirement already satisfied: ruamel.yaml>=0.15.0 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.16.10)\n \n [2020-07-14 10:47:40,575] INFO - Requirement already satisfied: tabulate in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.8.7)\n \n [2020-07-14 10:47:40,579] INFO - Requirement already satisfied: aiohttp in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (3.6.2)\n \n [2020-07-14 10:47:40,592] INFO - Requirement already satisfied: certifi in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (2020.6.20)\n \n [2020-07-14 10:47:40,594] INFO - Requirement already satisfied: python-json-logger in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.1.11)\n \n [2020-07-14 10:47:40,595] INFO - Requirement already satisfied: requests in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (2.22.0)\n \n [2020-07-14 10:47:40,611] INFO - Requirement already satisfied: sqlalchemy-utils in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.36.7)\n \n -[2020-07-14 10:47:40,674] INFO - Requirement already satisfied: sqlalchemy>=1.3.0 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.3.18)\n \n [2020-07-14 10:47:40,688] INFO - Requirement already satisfied: grpcio<=1.27.2 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.27.2)\n \n [2020-07-14 10:47:40,692] INFO - Requirement already satisfied: click>=7.0 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (7.1.2)\n \n [2020-07-14 10:47:40,693] INFO - Requirement already satisfied: py-zipkin in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.20.0)\n \n [2020-07-14 10:47:40,698] INFO - Requirement already satisfied: configparser in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (5.0.0)\n \n [2020-07-14 10:47:40,707] INFO - Requirement already satisfied: flask in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.1.2)\n \n [2020-07-14 10:47:40,724] INFO - Requirement already satisfied: packaging in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (20.4)\n \n [2020-07-14 10:47:40,728] INFO - Requirement already satisfied: humanfriendly in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (8.2)\n \n [2020-07-14 10:47:40,733] INFO - Requirement already satisfied: docker in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (4.2.2)\n \n /[2020-07-14 10:47:40,747] INFO - Requirement already satisfied: boto3 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.14.17)\n \n [2020-07-14 10:47:40,751] INFO - Requirement already satisfied: cerberus in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.3.2)\n \n [2020-07-14 10:47:40,754] INFO - Requirement already satisfied: protobuf>=3.6.0 in /opt/conda/lib/python3.7/site-packages (from bentoml==0.8.3->-r ./requirements.txt (line 3)) (3.12.2)\n \n [2020-07-14 10:47:40,757] INFO - Requirement already satisfied: six>=1.5 in /opt/conda/lib/python3.7/site-packages (from python-dateutil>=2.6.1->pandas->-r ./requirements.txt (line 2)) (1.14.0)\n \n [2020-07-14 10:47:40,759] INFO - Requirement already satisfied: setuptools>=3.0 in /opt/conda/lib/python3.7/site-packages (from gunicorn->bentoml==0.8.3->-r ./requirements.txt (line 3)) (45.2.0.post20200210)\n \n [2020-07-14 10:47:40,770] INFO - Requirement already satisfied: python-editor>=0.3 in /opt/conda/lib/python3.7/site-packages (from alembic->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.0.4)\n \n [2020-07-14 10:47:40,771] INFO - Requirement already satisfied: Mako in /opt/conda/lib/python3.7/site-packages (from alembic->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.1.3)\n \n [2020-07-14 10:47:40,777] INFO - Requirement already satisfied: ruamel.yaml.clib>=0.1.2; platform_python_implementation == \"CPython\" and python_version < \"3.9\" in /opt/conda/lib/python3.7/site-packages (from ruamel.yaml>=0.15.0->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.2.0)\n \n [2020-07-14 10:47:40,779] INFO - Requirement already satisfied: chardet<4.0,>=2.0 in /opt/conda/lib/python3.7/site-packages (from aiohttp->bentoml==0.8.3->-r ./requirements.txt (line 3)) (3.0.4)\n \n [2020-07-14 10:47:40,781] INFO - Requirement already satisfied: multidict<5.0,>=4.5 in /opt/conda/lib/python3.7/site-packages (from aiohttp->bentoml==0.8.3->-r ./requirements.txt (line 3)) (4.7.6)\n \n [2020-07-14 10:47:40,784] INFO - Requirement already satisfied: attrs>=17.3.0 in /opt/conda/lib/python3.7/site-packages (from aiohttp->bentoml==0.8.3->-r ./requirements.txt (line 3)) (19.3.0)\n \n [2020-07-14 10:47:40,827] INFO - Requirement already satisfied: async-timeout<4.0,>=3.0 in /opt/conda/lib/python3.7/site-packages (from aiohttp->bentoml==0.8.3->-r ./requirements.txt (line 3)) (3.0.1)\n \n [2020-07-14 10:47:40,829] INFO - Requirement already satisfied: yarl<2.0,>=1.0 in /opt/conda/lib/python3.7/site-packages (from aiohttp->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.4.2)\n \n [2020-07-14 10:47:40,836] INFO - Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/lib/python3.7/site-packages (from requests->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.25.8)\n \n |[2020-07-14 10:47:40,850] INFO - Requirement already satisfied: idna<2.9,>=2.5 in /opt/conda/lib/python3.7/site-packages (from requests->bentoml==0.8.3->-r ./requirements.txt (line 3)) (2.8)\n \n [2020-07-14 10:47:40,853] INFO - Requirement already satisfied: thriftpy2>=0.4.0 in /opt/conda/lib/python3.7/site-packages (from py-zipkin->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.4.11)\n \n [2020-07-14 10:47:40,866] INFO - Requirement already satisfied: Werkzeug>=0.15 in /opt/conda/lib/python3.7/site-packages (from flask->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.0.1)\n \n [2020-07-14 10:47:40,878] INFO - Requirement already satisfied: itsdangerous>=0.24 in /opt/conda/lib/python3.7/site-packages (from flask->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.1.0)\n \n [2020-07-14 10:47:40,880] INFO - Requirement already satisfied: Jinja2>=2.10.1 in /opt/conda/lib/python3.7/site-packages (from flask->bentoml==0.8.3->-r ./requirements.txt (line 3)) (2.11.2)\n \n [2020-07-14 10:47:40,885] INFO - Requirement already satisfied: pyparsing>=2.0.2 in /opt/conda/lib/python3.7/site-packages (from packaging->bentoml==0.8.3->-r ./requirements.txt (line 3)) (2.4.7)\n \n [2020-07-14 10:47:40,887] INFO - Requirement already satisfied: websocket-client>=0.32.0 in /opt/conda/lib/python3.7/site-packages (from docker->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.57.0)\n \n [2020-07-14 10:47:40,891] INFO - Requirement already satisfied: jmespath<1.0.0,>=0.7.1 in /opt/conda/lib/python3.7/site-packages (from boto3->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.10.0)\n \n [2020-07-14 10:47:40,893] INFO - Requirement already satisfied: botocore<1.18.0,>=1.17.17 in /opt/conda/lib/python3.7/site-packages (from boto3->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.17.17)\n \n [2020-07-14 10:47:40,903] INFO - Requirement already satisfied: s3transfer<0.4.0,>=0.3.0 in /opt/conda/lib/python3.7/site-packages (from boto3->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.3.3)\n \n [2020-07-14 10:47:40,907] INFO - Requirement already satisfied: MarkupSafe>=0.9.2 in /opt/conda/lib/python3.7/site-packages (from Mako->alembic->bentoml==0.8.3->-r ./requirements.txt (line 3)) (1.1.1)\n \n [2020-07-14 10:47:40,910] INFO - Requirement already satisfied: ply<4.0,>=3.4 in /opt/conda/lib/python3.7/site-packages (from thriftpy2>=0.4.0->py-zipkin->bentoml==0.8.3->-r ./requirements.txt (line 3)) (3.11)\n \n [2020-07-14 10:47:40,912] INFO - Requirement already satisfied: docutils<0.16,>=0.10 in /opt/conda/lib/python3.7/site-packages (from botocore<1.18.0,>=1.17.17->boto3->bentoml==0.8.3->-r ./requirements.txt (line 3)) (0.15.2)\n \n \\[2020-07-14 10:47:41,027] INFO - Installing collected packages: threadpoolctl, scipy, joblib, scikit-learn, pytz, pandas\n \n -[2020-07-14 10:47:49,756] INFO - Successfully installed joblib-0.16.0 pandas-1.0.5 pytz-2020.1 scikit-learn-0.23.1 scipy-1.5.1 threadpoolctl-2.1.0\n \n |[2020-07-14 10:47:49,994] INFO - + for filename in ./bundled_pip_dependencies/*.tar.gz\n + '[' -e './bundled_pip_dependencies/*.tar.gz' ']'\n + continue\n \n |[2020-07-14 10:47:53,748] INFO -  ---> 895e4a390376\n \n [2020-07-14 10:47:53,749] INFO - Step 9/9 : ENV PATH=\"/bento:$PATH\"\n [2020-07-14 10:47:53,749] INFO - \n \n \\[2020-07-14 10:47:53,797] INFO -  ---> Running in 2c5c72de1601\n \n -[2020-07-14 10:47:53,890] INFO -  ---> 05b6fd2ed048\n \n [2020-07-14 10:47:53,892] INFO - Successfully built 05b6fd2ed048\n \n [2020-07-14 10:47:53,898] INFO - Successfully tagged 103365315157.dkr.ecr.ap-southeast-2.amazonaws.com/irisclassifier-sagemaker:20200713155751_57AC77\n \n Error: sagemaker deploy failed: INTERNAL:Not supported role type assumed-role; sts arn is arn:aws:sts::103365315157:assumed-role/<rolename>/<username>\n </denchmark-code>\n \n To give us more information for diagnosing the issue, make sure to enable debug logging:\n Add the following lines to your Python code before invoking BentoML:\n import bentoml\n import logging\n bentoml.config().set('core', 'debug', 'true')\n bentoml.configure_logging(logging.DEBUG)\n And use the --verbose option when running bentoml CLI command, e.g.:\n bentoml get IrisClassifier --verbose\n Environment:\n \n OS: [e.g. MacOS 10.15.5]\n Python/BentoML Version [e.g. Python 3.7.6, BentoML-0.8.3]\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "oonisim", "commentT": "2020-07-14T03:02:49Z", "comment_text": "\n \t\tPut a quick change.\n <denchmark-code>    # elif type_role[0] == \"role\":\n     elif type_role[0] in [\"role\", \"assumed-role\"]:\n         role_response = iam_client.get_role(RoleName=type_role[1])\n         return role_response[\"Role\"][\"Arn\"]\n \n     raise YataiDeploymentException(\n         \"Not supported role type {}; sts arn is {}\".format(type_role[0], sts_arn)\n     )\n </denchmark-code>\n \n But got an error. Please advise what this code is suppose to achieve.\n <denchmark-code>Error: sagemaker deploy failed: INTERNAL:Failed to create sagemaker model; AWS ClientError - operation: CreateModel, code: ValidationException, message: The execution role ARN \"arn:aws:iam::103365315157:role/<rolename>\" is invalid. Please ensure that the role exists and that its trust relationship policy allows the action \"sts:AssumeRole\" for the service principal \"sagemaker.amazonaws.com\".\n </denchmark-code>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "oonisim", "commentT": "2020-07-21T18:58:08Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/oonisim>@oonisim</denchmark-link>\n  Sorry for the late response; I took time to catch up with AWS  since I am not familiar with it.\n The error you are encountering The execution role ARN \"arn:aws:iam::103365315157:role/<>rolename>\" ... \"sts:AssumeRole\" for the service principal \"sagemaker.amazonaws.com\" is caused you didn't enable Sagemaker as one of your trusted relationships.\n Sagemaker model needs to have permission to model artifacts and docker image for deployment on ML compute instances or for batch transform jobs, by assuming the role from ExecutionRoleArn.   Since BentoML will get the current arn role from the current user.  You would have to include Sagemaker as part of your trusted relationships in your role's policy document.\n This is an example of trusted relationships I used to test it out.\n <denchmark-code>{\n   \"Version\": \"2012-10-17\",\n   \"Statement\": [\n     {\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"Service\": [\n           \"ec2.amazonaws.com\",\n           \"sagemaker.amazonaws.com\"\n         ],\n         \"AWS\": \"arn:aws:iam::ACCOUNT_ID:user/USER_NAME\"\n       },\n       \"Action\": \"sts:AssumeRole\"\n     }\n   ]\n }\n </denchmark-code>\n \n I will create a PR that includes the assumed-role as part of the accept ARN.  Thank you for discovering this!\n \t\t"}}}, "commit": {"commit_id": "f9c8ddb8c74614b9eaa7ec1d64b72d83040eb358", "commit_author": "Bozhao", "commitT": "2020-07-23 11:13:56-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "bentoml\\yatai\\deployment\\sagemaker\\operator.py", "file_new_name": "bentoml\\yatai\\deployment\\sagemaker\\operator.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "100", "deleted_lines": "100", "method_info": {"method_name": "get_arn_role_from_current_aws_user", "method_params": "", "method_startline": "75", "method_endline": "106"}}}}}}}