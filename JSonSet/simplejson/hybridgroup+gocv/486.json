{"BR": {"BR_id": "486", "BR_author": "sshibs", "BRopenT": "2019-07-18T19:46:13Z", "BRcloseT": "2019-12-28T19:57:59Z", "BR_text": {"BRsummary": "Memory Leak in Mat.Size()", "BRdescription": "\n I am using gocv to process a large number of images and I noticed I had a bit of a memory leak. I narrowed it down to the Mat.Size() call. It could be you already know about this, and I don't know what the solution would be, but I thought I would post it just incase.\n <denchmark-h:h2>Description</denchmark-h>\n \n Looking at the C++ code for Mat_Size it looks like the issue is because \"new\" is called to make the ids array, but it is never deleted because ids is returned to the go code.\n <denchmark-code>void Mat_Size(Mat m, IntVector* res) {\n     cv::MatSize ms(m->size);\n     int* ids = new int[ms.dims()];\n \n     for (size_t i = 0; i < ms.dims(); ++i) {\n         ids[i] = ms[i];\n     }\n \n     res->length = ms.dims();\n     res->val = ids;\n     return;\n }\n </denchmark-code>\n \n <denchmark-h:h2>Steps to Reproduce</denchmark-h>\n \n Here is a simple program to reproduce the issue:\n <denchmark-code>import (\n \t\"gocv.io/x/gocv\"\n )\n \n func main() {\n \timg := gocv.NewMatWithSizeFromScalar(gocv.Scalar{0, 0, 0, 0}, 500, 500, gocv.MatTypeCV8UC3)\n \tdefer img.Close()\n \tfor i := 0; i < 100000000; i++ {\n \t\timg.Size()\n \t}\n }\n </denchmark-code>\n \n <denchmark-h:h2>Your Environment</denchmark-h>\n \n \n Operating System and version: Ubuntu 18.04\n OpenCV version used: 4.1\n How did you install OpenCV? installation guide\n GoCV version used: 0.20.0\n Go version: 1.12.1\n Did you run the env.sh or env.cmd script before trying to go run or go build? No\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "sshibs", "commentT": "2019-12-28T19:57:59Z", "comment_text": "\n \t\tThis issue was corrected by <denchmark-link:https://github.com/hybridgroup/gocv/pull/580>#580</denchmark-link>\n  so now closing. Thank you!\n \t\t"}}}, "commit": {"commit_id": "50f43938d30f32886f2546ad842e3256e6c606d1", "commit_author": "xxb-at-julichina", "commitT": "2019-12-28 20:56:10+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "core.cpp", "file_new_name": "core.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "764,765,766", "deleted_lines": null, "method_info": {"method_name": "IntVector_Close", "method_params": "ivec", "method_startline": "764", "method_endline": "766"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "core.go", "file_new_name": "core.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1722", "deleted_lines": null, "method_info": {"method_name": "Split", "method_params": "Mat", "method_startline": "1719", "method_endline": "1728"}}, "hunk_1": {"Ismethod": 1, "added_lines": "290", "deleted_lines": null, "method_info": {"method_name": "Size", "method_params": "", "method_startline": "287", "method_endline": "303"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "core.h", "file_new_name": "core.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "381,382", "deleted_lines": null}}}}}}