{"BR": {"BR_id": "1286", "BR_author": "theNded", "BRopenT": "2019-10-30T17:12:07Z", "BRcloseT": "2019-11-01T05:59:56Z", "BR_text": {"BRsummary": "Unexpected Colored ICP failure", "BRdescription": "\n \n Minimal reproducible bug described in <denchmark-link:https://github.com/intel-isl/Open3D/issues/1264>#1264</denchmark-link>\n , <denchmark-link:https://github.com/intel-isl/Open3D/issues/1281>#1281</denchmark-link>\n : Colored ICP fails unexpectedly with a reasonable initialization.\n Before registration:\n <denchmark-link:https://user-images.githubusercontent.com/6127282/67880808-c042d080-fb15-11e9-9fb4-1ff691ff246c.png></denchmark-link>\n \n <denchmark-code>Pose is from multi-scale ICP:\n [[ 0.99696919  0.0052096  -0.07762277 -0.2456588 ]\n  [-0.00870445  0.99896014 -0.04475343 -0.43198081]\n  [ 0.0773089   0.04529345  0.99597783  0.52008339]\n  [ 0.          0.          0.          1.        ]]\n </denchmark-code>\n \n After registration:\n <denchmark-link:https://user-images.githubusercontent.com/6127282/67880814-c46eee00-fb15-11e9-80bd-3d25422a323f.png></denchmark-link>\n \n <denchmark-code>[[-6.78238736e-01  4.42398071e-01  5.86750513e-01 -4.48030729e+00]\n  [ 3.04820107e-01  8.95911960e-01 -3.23150836e-01 -4.01951769e+01]\n  [-6.68638108e-01 -4.03200603e-02 -7.42494022e-01  6.79608267e+01]\n  [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  1.00000000e+00]]\n </denchmark-code>\n \n Log:\n <denchmark-code>[Open3D DEBUG] InitializePointCloudForColoredICP\n [Open3D DEBUG] ICP Iteration #0: Fitness 0.4250, RMSE 0.0057\n [Open3D DEBUG] Residual : 2.25e+01 (# of elements : 38595)\n [Open3D DEBUG] ICP Iteration #1: Fitness 0.0001, RMSE 0.0082\n [Open3D DEBUG] Residual : 6.95e-03 (# of elements : 13)\n [Open3D DEBUG] ICP Iteration #2: Fitness 0.0000, RMSE 0.0000\n </denchmark-code>\n \n \n Minimal example extracted from the reconstruction system. Files can be found as provided:\n <denchmark-link:https://www.dropbox.com/s/1pydy6cv8prxawn/trans.npy?dl=0>trans.npy</denchmark-link>\n \n <denchmark-link:https://www.dropbox.com/s/lv6wbl28dr4ae2o/fragment_011.ply?dl=0>fragment_011.ply</denchmark-link>\n \n <denchmark-link:https://www.dropbox.com/s/hjr1qm4r99i6is1/fragment_012.ply?dl=0>fragment_012.ply</denchmark-link>\n \n import numpy as np\n import copy\n import open3d as o3d\n \n \n def draw_registration_result_original_color(source, target, transformation):\n     flip_transform = [[1, 0, 0, 0], [0, -1, 0, 0], [0, 0, -1, 0], [0, 0, 0, 1]]\n     source_temp = copy.deepcopy(source)\n     target_temp = copy.deepcopy(target)\n     source_temp.transform(transformation)\n     source_temp.transform(flip_transform)\n     target_temp.transform(flip_transform)\n     o3d.visualization.draw_geometries([source_temp, target_temp])\n \n \n if __name__ == '__main__':\n     o3d.utility.set_verbosity_level(o3d.utility.Debug)\n     voxel_size = 0.05 / 4\n \n     init_trans = np.load('trans.npy')\n     print(init_trans)\n \n     source = o3d.io.read_point_cloud('fragment_011.ply')\n     target = o3d.io.read_point_cloud('fragment_012.ply')\n     source_down = source.voxel_down_sample(voxel_size)\n     target_down = target.voxel_down_sample(voxel_size)\n \n     draw_registration_result_original_color(source_down, target_down,\n                                             init_trans)\n \n     source_down.estimate_normals(\n         o3d.geometry.KDTreeSearchParamHybrid(radius=voxel_size * 2.0,\n                                              max_nn=30))\n     target_down.estimate_normals(\n         o3d.geometry.KDTreeSearchParamHybrid(radius=voxel_size * 2.0,\n                                              max_nn=30))\n \n     result_icp = o3d.registration.registration_colored_icp(\n         source_down, target_down, voxel_size, init_trans,\n         o3d.registration.ICPConvergenceCriteria(relative_fitness=1e-6,\n                                                 relative_rmse=1e-6,\n                                                 max_iteration=14))\n \n     draw_registration_result_original_color(source_down, target_down,\n                                             result_icp.transformation)\n     print(result_icp.transformation)\n Expected behavior\n Successful registration.\n Additional notes\n Point-to-point and point-to-plane ICP succeeds on this pair.\n Reverting the order of fragments and using the inverse of init_pose will also produce a failure registration, but less abusrd:\n <denchmark-link:https://user-images.githubusercontent.com/6127282/67881330-b1a8e900-fb16-11e9-8303-72c487135c41.png></denchmark-link>\n \n Environment (please complete the following information):\n \n OS: Ubuntu 18.04 | macOS\n Python version: 3.7.4\n Open3D version: 0.8.0.0\n Is this remote workstation?: no\n How did you install Open3D?: conda\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "theNded", "commentT": "2019-10-31T01:49:52Z", "comment_text": "\n \t\tHello <denchmark-link:https://github.com/theNded>@theNded</denchmark-link>\n . This is not expected behavior. I haven't noticed before, so I presume some commits were problematic. Could you try <denchmark-link:https://git-scm.com/docs/git-bisect>bisect git</denchmark-link>\n  and find the problematic commit?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "theNded", "commentT": "2019-10-31T06:47:39Z", "comment_text": "\n \t\tI change the method of \"icp_method\": \"point_to_plane\" in config/tutorial.json\n The picture below is a comparison of two icp_methods, in the same fragments folder (generated by using --make once), and run --register --refine --integrate with different icp_method\n So the color_icp has some unpredictable problems ?\n <denchmark-link:https://user-images.githubusercontent.com/35401968/67924892-c192fc80-fbec-11e9-93bf-88d61b39b252.png></denchmark-link>\n \n \n the left is \"icp_method\": \"point_to_plane\" and the right is \"icp_method\": \"color\"\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "theNded", "commentT": "2019-10-31T15:02:23Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/syncle>@syncle</denchmark-link>\n  I have traced back to 0.7.0 and the bug has already been there. Before that Open3D's structure was totally different, it might be harder to config.\n I'm trying to directly modify the code now. There are surely some problems with the color part: when I turn the photometric coeff to 0, the registration is correct, and the linear system looks like\n <denchmark-code>JTJ: \n  97338.5 -1696.52  16632.3  3870.86 -41394.1 -27123.3\n -1696.52  26066.7 -1141.67    10016 -1008.41  6525.47\n  16632.3 -1141.67  15425.4  2668.18 -6787.57 -2862.44\n  3870.86    10016  2668.18  5818.21  -2230.1   2376.6\n -41394.1 -1008.41 -6787.57  -2230.1  19794.5  12441.9\n -27123.3  6525.47 -2862.44   2376.6  12441.9  11747.2\n JTr: \n  14.2091 -1.46349 -1.02842  1.28828 -4.84222  -5.1516\n </denchmark-code>\n \n But when I turn it on, the results become\n <denchmark-code>JTJ: \n  9.04476e+09 -2.15437e+10 -3.10165e+09  8.25759e+08  2.38016e+09 -1.41246e+10\n -2.15437e+10   5.1318e+10  7.38836e+09 -1.96696e+09  -5.6697e+09  3.36451e+10\n -3.10165e+09  7.38836e+09  1.06374e+09 -2.83185e+08 -8.16286e+08  4.84395e+09\n  8.25759e+08 -1.96696e+09 -2.83185e+08  7.53997e+07  2.17314e+08 -1.28959e+09\n  2.38016e+09  -5.6697e+09 -8.16286e+08  2.17314e+08  6.26426e+08 -3.71719e+09\n -1.41246e+10  3.36451e+10  4.84395e+09 -1.28959e+09 -3.71719e+09  2.20586e+10\n JTr: \n  4.54983e+07 -1.08011e+08 -1.55415e+07  4.12067e+06  1.18777e+07 -7.04842e+07\n </denchmark-code>\n \n I will dig deeper here.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "theNded", "commentT": "2019-10-31T15:43:03Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/syncle>@syncle</denchmark-link>\n  it seems that some ill color gradiants polluted the linear system:\n <denchmark-code>suspicious gradient: -24266.6 -69947.5   415081 from 3 nn\n suspicious gradient:   -24278 -69980.1   415275 from 3 nn\n suspicious gradient: -24280.3 -69986.9   415315 from 3 nn\n </denchmark-code>\n \n Actually, we need at least 4-nn here\n <denchmark-link:https://github.com/intel-isl/Open3D/blob/master/src/Open3D/Registration/ColoredICP.cpp#L104>https://github.com/intel-isl/Open3D/blob/master/src/Open3D/Registration/ColoredICP.cpp#L104</denchmark-link>\n \n In the 3-nn case, we are building a 3x3 linear system with only 2 constraints (even if we have a regularizor, this is still pretty ill-posed).\n After setting it to 4-nn, the problem is gone. Does it make sense? If so I will make a PR.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "theNded", "commentT": "2019-11-01T05:57:34Z", "comment_text": "\n \t\tThanks <denchmark-link:https://github.com/theNded>@theNded</denchmark-link>\n  <denchmark-link:https://github.com/MaxChanger>@MaxChanger</denchmark-link>\n  for the analysis. That sounds feasible. I will review the PR.\n \t\t"}}}, "commit": {"commit_id": "ebc2621195406f22ac2efed870513b322ccf31a0", "commit_author": "Wei Dong", "commitT": "2019-11-01 14:59:08+09:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\Open3D\\Registration\\ColoredICP.cpp", "file_new_name": "src\\Open3D\\Registration\\ColoredICP.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "105", "deleted_lines": "105", "method_info": {"method_name": "open3d::InitializePointCloudForColoredICP", "method_params": "target,search_param", "method_startline": "78", "method_endline": "141"}}}}}}}