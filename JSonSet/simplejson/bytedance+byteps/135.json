{"BR": {"BR_id": "135", "BR_author": "jazka", "BRopenT": "2019-10-25T02:42:21Z", "BRcloseT": "2019-11-05T06:22:38Z", "BR_text": {"BRsummary": "Crash during MXNet distributed training", "BRdescription": "\n As described in [https://github.com/bytedance/byteps/blob/master/docs/step-by-step-tutorial.md], for section \"Distributed Training (TCP)\" with MXNet, everything is fine at first, then crash after training a while.\n <denchmark-code>2019-10-24T14:11:27.552522043Z INFO:root:Epoch[0] Batch [40000-40020]\tSpeed: 141.83 samples/sec\taccuracy=1.000000\n 2019-10-24T14:11:27.552524672Z INFO:root:Epoch[0] Batch [40000-40020]\tSpeed: 141.85 samples/sec\taccuracy=1.000000\n 2019-10-24T14:11:27.552527341Z INFO:root:Epoch[0] Batch [40000-40020]\tSpeed: 141.85 samples/sec\taccuracy=1.000000\n 2019-10-24T14:11:27.552530088Z INFO:root:Epoch[0] Batch [40000-40020]\tSpeed: 141.83 samples/sec\taccuracy=1.000000\n 2019-10-24T14:11:30.895411795Z INFO:root:Epoch[0] Train-accuracy=0.990960\n 2019-10-24T14:11:30.895451643Z INFO:root:Epoch[0] Time cost=8809.962\n 2019-10-24T14:11:30.895456768Z INFO:root:Epoch[0] Train-accuracy=0.990373\n 2019-10-24T14:11:30.895460990Z INFO:root:Epoch[0] Train-accuracy=0.990857\n 2019-10-24T14:11:30.895464996Z INFO:root:Epoch[0] Time cost=8809.948\n 2019-10-24T14:11:30.895469883Z INFO:root:Epoch[0] Time cost=8809.938\n 2019-10-24T14:11:30.895474126Z INFO:root:Epoch[0] Train-accuracy=0.990121\n 2019-10-24T14:11:30.895478329Z INFO:root:Epoch[0] Time cost=8809.948\n 2019-10-24T14:11:30.895482272Z INFO:root:Epoch[0] Train-accuracy=0.991191\n 2019-10-24T14:11:30.895502052Z INFO:root:Epoch[0] Time cost=8809.940\n 2019-10-24T14:11:30.895506735Z INFO:root:Epoch[0] Train-accuracy=0.991340\n 2019-10-24T14:11:30.895510343Z INFO:root:Epoch[0] Time cost=8809.942\n 2019-10-24T14:11:30.895514023Z INFO:root:Epoch[0] Train-accuracy=0.990433\n 2019-10-24T14:11:30.895517677Z INFO:root:Epoch[0] Time cost=8809.942\n 2019-10-24T14:11:30.906795173Z INFO:root:Epoch[0] Train-accuracy=0.989851\n 2019-10-24T14:11:30.906839797Z INFO:root:Epoch[0] Time cost=8809.934\n 2019-10-24T14:11:31.098516951Z \n 2019-10-24T14:11:31.098545436Z Segmentation fault: 11\n 2019-10-24T14:11:31.098548428Z \n 2019-10-24T14:11:31.098550789Z Stack trace returned 10 entries:\n 2019-10-24T14:11:31.098553259Z [bt] (0) /usr/local/lib/python2.7/dist-packages/mxnet/libmxnet.so(+0x40b29a) [0x7ff62ff5f29a]\n 2019-10-24T14:11:31.098555937Z [bt] (1) /usr/local/lib/python2.7/dist-packages/mxnet/libmxnet.so(+0x342be86) [0x7ff632f7fe86]\n 2019-10-24T14:11:31.098558416Z [bt] (2) /lib/x86_64-linux-gnu/libc.so.6(+0x354b0) [0x7ff6eb9ec4b0]\n 2019-10-24T14:11:31.098560609Z [bt] (3) /lib/x86_64-linux-gnu/libpthread.so.0(pthread_join+0x9) [0x7ff6ebd898d9]\n 2019-10-24T14:11:31.098562828Z [bt] (4) /usr/lib/x86_64-linux-gnu/libstdc++.so.6(std::thread::join()+0x27) [0x7ff6e71f5b97]\n 2019-10-24T14:11:31.098565128Z [bt] (5) /usr/local/lib/python2.7/dist-packages/byteps-0.1.0-py2.7-linux-x86_64.egg/byteps/mxnet/c_lib.so(byteps::common::BytePSCommSocket::~BytePSCommSocket()+0xe5) [0x7ff57401dc65]\n 2019-10-24T14:11:31.098567759Z [bt] (6) /usr/local/lib/python2.7/dist-packages/byteps-0.1.0-py2.7-linux-x86_64.egg/byteps/mxnet/c_lib.so(+0x29215) [0x7ff574002215]\n 2019-10-24T14:11:31.098570108Z [bt] (7) /usr/local/lib/python2.7/dist-packages/byteps-0.1.0-py2.7-linux-x86_64.egg/byteps/mxnet/c_lib.so(byteps::common::NcclManager::~NcclManager()+0x10c) [0x7ff57401e0ac]\n 2019-10-24T14:11:31.098572490Z [bt] (8) /usr/local/lib/python2.7/dist-packages/byteps-0.1.0-py2.7-linux-x86_64.egg/byteps/mxnet/c_lib.so(+0x29215) [0x7ff574002215]\n 2019-10-24T14:11:31.098574930Z [bt] (9) /usr/local/lib/python2.7/dist-packages/byteps-0.1.0-py2.7-linux-x86_64.egg/byteps/mxnet/c_lib.so(byteps::common::BytePSGlobal::Shutdown()+0x39a) [0x7ff57401499a]\n 2019-10-24T14:11:35.301298756Z Exception in thread Thread-5:\n 2019-10-24T14:11:35.301328223Z Traceback (most recent call last):\n 2019-10-24T14:11:35.301331125Z   File \"/usr/lib/python2.7/threading.py\", line 801, in __bootstrap_inner\n 2019-10-24T14:11:35.301333868Z     self.run()\n 2019-10-24T14:11:35.301336079Z   File \"/usr/lib/python2.7/threading.py\", line 754, in run\n 2019-10-24T14:11:35.301338565Z     self.__target(*self.__args, **self.__kwargs)\n 2019-10-24T14:11:35.301340997Z   File \"/usr/local/byteps/launcher/launch.py\", line 41, in worker\n 2019-10-24T14:11:35.301344944Z     subprocess.check_call(command, env=my_env, stdout=sys.stdout, stderr=sys.stderr, shell=True)\n 2019-10-24T14:11:35.301357489Z   File \"/usr/lib/python2.7/subprocess.py\", line 541, in check_call\n 2019-10-24T14:11:35.301360000Z     raise CalledProcessError(retcode, cmd)\n 2019-10-24T14:11:35.301362338Z CalledProcessError: Command '/usr/local/byteps/example/mxnet/start_mxnet_byteps.sh --benchmark 1 --batch-size=32' returned non-zero exit status 255\n </denchmark-code>\n \n More Details:\n \n Two machine with 8*GPU, \"Scheduler\" and \"Work0\" are running on one machine, \"Server\" and \"Work1\" are running on another one.\n The config and script:\n \n <denchmark-code>docker run -it --net=host bytepsimage/byteps_server bash\n export DMLC_NUM_WORKER=2\n export DMLC_ROLE=scheduler\n export DMLC_NUM_SERVER=1\n export DMLC_PS_ROOT_URI=172.31.60.11\n export DMLC_PS_ROOT_PORT=9001\n python /usr/local/byteps/launcher/launch.py\n </denchmark-code>\n \n <denchmark-code>docker run -it --net=host bytepsimage/byteps_server bash\n export DMLC_NUM_WORKER=2 \n export DMLC_ROLE=server\n export DMLC_NUM_SERVER=1 \n export DMLC_PS_ROOT_URI=172.31.60.11\n export DMLC_PS_ROOT_PORT=9001\n export MXNET_OMP_MAX_THREADS=4\n python /usr/local/byteps/launcher/launch.py\n </denchmark-code>\n \n <denchmark-code>docker run --gpus all -it --net=host --shm-size=32768m bytepsimage/worker_mxnet bash\n export NVIDIA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7\n export DMLC_WORKER_ID=0 # worker-0\n export DMLC_NUM_WORKER=2 # 2 workers\n export DMLC_ROLE=worker # your role is worker\n export DMLC_NUM_SERVER=1 \n export DMLC_PS_ROOT_URI=172.31.60.11\n export DMLC_PS_ROOT_PORT=9001\n export EVAL_TYPE=benchmark\n python /usr/local/byteps/launcher/launch.py /usr/local/byteps/example/mxnet/start_mxnet_byteps.sh --benchmark 1 --batch-size=32\n </denchmark-code>\n \n <denchmark-code>docker run --gpus all -it --net=host --shm-size=32768m bytepsimage/worker_mxnet bash\n export NVIDIA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7\n export DMLC_WORKER_ID=1 # worker-1\n export DMLC_NUM_WORKER=2 # 2 workers\n export DMLC_ROLE=worker # your role is worker\n export DMLC_NUM_SERVER=1 \n export DMLC_PS_ROOT_URI=172.31.60.11\n export DMLC_PS_ROOT_PORT=9001\n export EVAL_TYPE=benchmark\n python /usr/local/byteps/launcher/launch.py /usr/local/byteps/example/mxnet/start_mxnet_byteps.sh --benchmark 1 --batch-size=32\n </denchmark-code>\n \n \n To speed up the test,  \"num_epochs\" is set with 1 in file \"/usr/local/byteps/example/mxnet/train_imagenet_byteps.py\"\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jazka", "commentT": "2019-10-25T02:45:30Z", "comment_text": "\n \t\tThanks for reporting this. This is a known issue that BytePS may crash after the training is finished. Probably it does not release the resources well enough. We will work on this.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jazka", "commentT": "2019-10-25T02:49:29Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/bobzhuyb>@bobzhuyb</denchmark-link>\n  Is there any workaround? I need the benchmark result to compare TCP and RDMA?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jazka", "commentT": "2019-10-25T02:55:06Z", "comment_text": "\n \t\tIf you just want to compare the performance, you have the output \"Speed: 141.83 samples/sec\" in your log. If you train a real workload, you can save the model before exiting the program. It only crashes when the whole process terminates (when BytePSGlobal::Shutdown() is called)..\n We shall fix this bug soon.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jazka", "commentT": "2019-10-25T03:12:16Z", "comment_text": "\n \t\tI see. After you public the new release with bug fix, I will close this issue. Thanks!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jazka", "commentT": "2019-10-29T05:49:29Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jazka>@jazka</denchmark-link>\n  The fix has been merged. Can you try again?\n The docker image has not been updated. You may need to build the latest code yourself.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jazka", "commentT": "2019-10-30T08:24:57Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jazka>@jazka</denchmark-link>\n  The docker image has been updated now. You may use  to get the latest one.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jazka", "commentT": "2019-11-05T04:49:01Z", "comment_text": "\n \t\tYes, crash has gone. A little issue is that there is no benchmark results after training.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "jazka", "commentT": "2019-11-05T04:55:12Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jazka>@jazka</denchmark-link>\n  We often use the output \"Speed: 141.83 samples/sec\" as the benchmark result. Would you clarify what kind of result you may like to see?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "jazka", "commentT": "2019-11-05T06:22:38Z", "comment_text": "\n \t\tYes, the current output is enough, and it will be great to output the summary benchmark results like \"Tensorflow\" or \"PyTorch\".\n <denchmark-code>Img/sec per GPU: 158.6 +-3.7\n Total img/sec on 16 GPU(s): 2537.1 +-59.1\n </denchmark-code>\n \n Anyway, the crash has been fixed, I will close the issue. Thanks for your update!\n \t\t"}}}, "commit": {"commit_id": "63cb3bb182deb87be672a258246e30c1f331ebf1", "commit_author": "Yimin Jiang", "commitT": "2019-10-29 13:33:00+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "byteps\\common\\communicator.cc", "file_new_name": "byteps\\common\\communicator.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "147,148,149,150,151,152", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSCommSocket::initSocket", "method_params": "rank,path", "method_startline": "126", "method_endline": "160"}}, "hunk_1": {"Ismethod": 1, "added_lines": "240,241,242,243,249", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSCommSocket::recvSignal", "method_params": "source,data,max_len", "method_startline": "235", "method_endline": "258"}}, "hunk_2": {"Ismethod": 1, "added_lines": "263", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSCommSocket::recvSignalFromRoot", "method_params": "data,max_len", "method_startline": "260", "method_endline": "266"}}, "hunk_3": {"Ismethod": 1, "added_lines": "171,172,173,174,178,179,203,204", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSCommSocket::startListenThread", "method_params": "", "method_startline": "162", "method_endline": "205"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "byteps\\common\\communicator.h", "file_new_name": "byteps\\common\\communicator.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "102,108,109", "deleted_lines": "101,107", "method_info": {"method_name": "byteps::common::BytePSCommSocket::~BytePSCommSocket", "method_params": "", "method_startline": "101", "method_endline": "110"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 15, "file_old_name": "byteps\\common\\core_loops.cc", "file_new_name": "byteps\\common\\core_loops.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "670", "deleted_lines": null, "method_info": {"method_name": "byteps::common::PullLoop", "method_params": "", "method_startline": "667", "method_endline": "671"}}, "hunk_1": {"Ismethod": 1, "added_lines": "623", "deleted_lines": null, "method_info": {"method_name": "byteps::common::CoordinatePushLoop", "method_params": "", "method_startline": "619", "method_endline": "624"}}, "hunk_2": {"Ismethod": 1, "added_lines": "692", "deleted_lines": null, "method_info": {"method_name": "byteps::common::NonRootCopyHost2DeviceLoop", "method_params": "", "method_startline": "687", "method_endline": "693"}}, "hunk_3": {"Ismethod": 1, "added_lines": "684", "deleted_lines": null, "method_info": {"method_name": "byteps::common::NonRootCopyListenLoop", "method_params": "", "method_startline": "680", "method_endline": "685"}}, "hunk_4": {"Ismethod": 1, "added_lines": "580", "deleted_lines": null, "method_info": {"method_name": "byteps::common::RunNonRootCopyListenLoopOnce", "method_params": "", "method_startline": "571", "method_endline": "589"}}, "hunk_5": {"Ismethod": 1, "added_lines": "609", "deleted_lines": null, "method_info": {"method_name": "byteps::common::CoordinateReduceLoop", "method_params": "", "method_startline": "605", "method_endline": "610"}}, "hunk_6": {"Ismethod": 1, "added_lines": "644", "deleted_lines": null, "method_info": {"method_name": "byteps::common::NonRootNcclLoop", "method_params": "", "method_startline": "640", "method_endline": "645"}}, "hunk_7": {"Ismethod": 1, "added_lines": "616", "deleted_lines": null, "method_info": {"method_name": "byteps::common::CoordinateBroadcastLoop", "method_params": "", "method_startline": "612", "method_endline": "617"}}, "hunk_8": {"Ismethod": 1, "added_lines": "664", "deleted_lines": null, "method_info": {"method_name": "byteps::common::PushLoop", "method_params": "", "method_startline": "661", "method_endline": "665"}}, "hunk_9": {"Ismethod": 1, "added_lines": "630", "deleted_lines": null, "method_info": {"method_name": "byteps::common::PcieReduceLoop", "method_params": "", "method_startline": "626", "method_endline": "631"}}, "hunk_10": {"Ismethod": 1, "added_lines": "651", "deleted_lines": null, "method_info": {"method_name": "byteps::common::SyncNcclLoop", "method_params": "", "method_startline": "647", "method_endline": "652"}}, "hunk_11": {"Ismethod": 1, "added_lines": "658", "deleted_lines": null, "method_info": {"method_name": "byteps::common::CopyDevice2HostLoop", "method_params": "", "method_startline": "654", "method_endline": "659"}}, "hunk_12": {"Ismethod": 1, "added_lines": "677", "deleted_lines": null, "method_info": {"method_name": "byteps::common::RootCopyHost2DeviceLoop", "method_params": "", "method_startline": "673", "method_endline": "678"}}, "hunk_13": {"Ismethod": 1, "added_lines": "637", "deleted_lines": null, "method_info": {"method_name": "byteps::common::RootNcclLoop", "method_params": "", "method_startline": "633", "method_endline": "638"}}, "hunk_14": {"Ismethod": 1, "added_lines": "271", "deleted_lines": null, "method_info": {"method_name": "byteps::common::RunNonRootNcclLoopOnce", "method_params": "", "method_startline": "257", "method_endline": "298"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "byteps\\common\\global.cc", "file_new_name": "byteps\\common\\global.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "187,188", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSGlobal::Init", "method_params": "", "method_startline": "83", "method_endline": "198"}}, "hunk_1": {"Ismethod": 1, "added_lines": "362,363,364,365", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSGlobal::IsAllThreadFinish", "method_params": "total_thread_num", "method_startline": "362", "method_endline": "365"}}, "hunk_2": {"Ismethod": 1, "added_lines": "238,239,241,242,250,251,252,253,254,291,292", "deleted_lines": "279", "method_info": {"method_name": "byteps::common::BytePSGlobal::Shutdown", "method_params": "", "method_startline": "237", "method_endline": "294"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "byteps\\common\\global.h", "file_new_name": "byteps\\common\\global.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "112", "deleted_lines": null, "method_info": {"method_name": "byteps::common::BytePSGlobal::ReportThreadFinish", "method_params": "", "method_startline": "112", "method_endline": "112"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "byteps\\common\\operations.cc", "file_new_name": "byteps\\common\\operations.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "140,141,142,143", "deleted_lines": null, "method_info": {"method_name": "byteps::common::EnqueueTensor", "method_params": "context,input,output,ready_event,device,priority,version,callback,queue_list", "method_startline": "134", "method_endline": "202"}}, "hunk_1": {"Ismethod": 1, "added_lines": "79", "deleted_lines": "79", "method_info": {"method_name": "byteps::common::byteps_shutdown", "method_params": "", "method_startline": "77", "method_endline": "81"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "byteps\\common\\shared_memory.h", "file_new_name": "byteps\\common\\shared_memory.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "45", "deleted_lines": "45", "method_info": {"method_name": "byteps::common::BytePSSharedMemory::~BytePSSharedMemory", "method_params": "", "method_startline": "38", "method_endline": "47"}}}}}}}