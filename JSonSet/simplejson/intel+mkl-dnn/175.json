{"BR": {"BR_id": "175", "BR_author": "CaoZhongZ", "BRopenT": "2018-01-04T04:06:17Z", "BRcloseT": "2018-01-18T20:01:51Z", "BR_text": {"BRsummary": "Corner case crash when batch size of tensor is 0", "BRdescription": "\n <denchmark-h:h3>Description</denchmark-h>\n \n There is a test case created a memory shape like (0, 16, 8, 8), then MKL-DNN will crash at nd_iterator_init (in reorder or other primitives). Quick fix would be compare start and end and found out there was nothing to calculate and then bailout earlier or fix nd_iterator_init to skip mode 0.\n I know this is very rare and probability never happen in real situation, however change testcase of a framework seems also a bad option.\n <denchmark-h:h3>Environment</denchmark-h>\n \n Linux/OS X, general\n <denchmark-h:h3>Steps to reproduce</denchmark-h>\n \n reorder from a(0, 16, 8, 8) to b (0, 16, 8, 8).\n <denchmark-h:h3>Actual behavior</denchmark-h>\n \n Crash in nd_iterator_init\n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n Nothing happen and finish sucessfully\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "CaoZhongZ", "commentT": "2018-01-04T04:27:10Z", "comment_text": "\n \t\tThis is kind of embarrassing... Thanks for the report!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "CaoZhongZ", "commentT": "2018-01-05T18:49:23Z", "comment_text": "\n \t\tWhich formats you are converting from / to and which compiler and MKL-DNN version do you use? I can make MKL-DNN fail when converting nhwc to chwn with icc but the backtrace does not point me to nd_iterator_init().\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "CaoZhongZ", "commentT": "2018-01-06T04:36:55Z", "comment_text": "\n \t\tOh I see, you go to the ref.\n Mine: Reorder from nchw to nchw. homebrew llvm/clang 5.0, direct_copy except dim0.\n It seems my ref path is good even on Linux with icpc-18 or gcc.\n \t\t"}}}, "commit": {"commit_id": "dfcd7578bfb79c6c7bd26088e588f7d0822a58b9", "commit_author": "Roman Dubtsov", "commitT": "2018-01-10 13:33:21-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\batch_normalization.cpp", "file_new_name": "src\\common\\batch_normalization.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "76", "deleted_lines": null, "method_info": {"method_name": "bnrm_desc_init", "method_params": "bnrm_desc,prop_kind,data_desc,diff_data_desc,epsilon,flags", "method_startline": "32", "method_endline": "86"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\convolution.cpp", "file_new_name": "src\\common\\convolution.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "86,87,88", "deleted_lines": null, "method_info": {"method_name": "conv_desc_init", "method_params": "conv_desc,prop_kind,alg_kind,src_desc,weights_desc,bias_desc,dst_desc,strides,dilates,padding_l,padding_r,padding_kind", "method_startline": "32", "method_endline": "113"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\eltwise.cpp", "file_new_name": "src\\common\\eltwise.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "59", "deleted_lines": null, "method_info": {"method_name": "eltwise_desc_init", "method_params": "eltwise_desc,prop_kind,alg_kind,data_desc,diff_data_desc,alpha,beta", "method_startline": "32", "method_endline": "67"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\inner_product.cpp", "file_new_name": "src\\common\\inner_product.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62,63,64", "deleted_lines": null, "method_info": {"method_name": "ip_desc_init", "method_params": "ip_desc,prop_kind,src_desc,weights_desc,bias_desc,dst_desc", "method_startline": "31", "method_endline": "78"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\lrn.cpp", "file_new_name": "src\\common\\lrn.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "61", "deleted_lines": null, "method_info": {"method_name": "lrn_desc_init", "method_params": "lrn_desc,prop_kind,alg_kind,data_desc,diff_data_desc,local_size,alpha,beta,k", "method_startline": "32", "method_endline": "71"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\memory.cpp", "file_new_name": "src\\common\\memory.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "257,258,259", "deleted_lines": null, "method_info": {"method_name": "mkldnn_sum_primitive_desc_create_v2", "method_params": "sum_pd,output_d,n,scales,input_pds,attr", "method_startline": "248", "method_endline": "304"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\pooling.cpp", "file_new_name": "src\\common\\pooling.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "77,78", "deleted_lines": null, "method_info": {"method_name": "pooling_desc_init", "method_params": "pool_desc,prop_kind,alg_kind,src_desc,dst_desc,strides,kernel,padding_l,padding_r,padding_kind", "method_startline": "32", "method_endline": "92"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\reorder.cpp", "file_new_name": "src\\common\\reorder.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "51,52,53,54,55,56,57", "deleted_lines": "51", "method_info": {"method_name": "mkldnn_reorder_primitive_desc_create_v2", "method_params": "reorder_primitive_desc,input,output,attr", "method_startline": "32", "method_endline": "73"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\common\\softmax.cpp", "file_new_name": "src\\common\\softmax.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "35", "deleted_lines": null, "method_info": {"method_name": "softmax_desc_init", "method_params": "softmax_desc,prop_kind,data_desc,softmax_axis", "method_startline": "31", "method_endline": "48"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tests\\gtests\\convolution_common.h", "file_new_name": "tests\\gtests\\convolution_common.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "90,91,92,93,94", "deleted_lines": null}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tests\\gtests\\in\\convolution_simple_small.h", "file_new_name": "tests\\gtests\\in\\convolution_simple_small.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "17,18,19,20,21", "deleted_lines": null}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\mkldnn_test_common.hpp", "file_new_name": "tests\\gtests\\mkldnn_test_common.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386", "deleted_lines": null, "method_info": {"method_name": "catch_expected_failures", "method_params": "f,expect_to_fail,expected_status", "method_startline": "361", "method_endline": "386"}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_convolution_backward_data_common.hpp", "file_new_name": "tests\\gtests\\test_convolution_backward_data_common.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "95,96,101,102,103,107,108,109,110,111,112,113,114,115,116,117,118,119,122,123,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183", "deleted_lines": "95,100,101,102,106,107,108,109,110,111,114,134,135,136,137,138,139,141,142,143,144,145,146,147,148,149,150,151,152,153", "method_info": {"method_name": "mkldnn::convolution_backward_data_test::SetUp", "method_params": "", "method_startline": "93", "method_endline": "184"}}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_convolution_backward_weights.cpp", "file_new_name": "tests\\gtests\\test_convolution_backward_weights.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "164,165,166,167,168,169,171,172,173,174,175,177,178,180,184,188,189,190,191,192,193,195,196,197,199,200,201,202,204,205", "deleted_lines": "122,165,166,167,168,170,171,172,173,175,176,178,182,186,187,188,190,191,193,194,195,197,198,199", "method_info": {"method_name": "mkldnn::convolution_backward_weights_test::SetUp", "method_params": "", "method_startline": "117", "method_endline": "206"}}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_convolution_forward_common.hpp", "file_new_name": "tests\\gtests\\test_convolution_forward_common.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "193,194,195,196,197,198,199,200,201,202,203,224,225,226,227", "deleted_lines": "193,194,195,196,197,198,199,200,201,202,203,204,225,226,227", "method_info": {"method_name": "mkldnn::convolution_forward_test::SetUp", "method_params": "", "method_startline": "121", "method_endline": "228"}}}}, "file_15": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_convolution_relu_forward_common.hpp", "file_new_name": "tests\\gtests\\test_convolution_relu_forward_common.hpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "133,134,135,136,137,138,139,140,168,169,170,173,174,179,180,181,182,183,184,185,186,187,188,189,190,192,193,195,196,200,202,203", "deleted_lines": "133,134,135,136,137,138,166,167,170,171,176,177,178,179,181,182,183,184,185,186,187,189,193", "method_info": {"method_name": "mkldnn::convolution_relu_test::SetUp", "method_params": "", "method_startline": "97", "method_endline": "204"}}}}, "file_16": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_inner_product_backward_data.cpp", "file_new_name": "tests\\gtests\\test_inner_product_backward_data.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "104,105,106,107,110,111,114,115,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161", "deleted_lines": "102,105,106,109,110,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148", "method_info": {"method_name": "mkldnn::inner_product_test_bwd_data::SetUp", "method_params": "", "method_startline": "92", "method_endline": "162"}}}}, "file_17": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_inner_product_backward_weights.cpp", "file_new_name": "tests\\gtests\\test_inner_product_backward_weights.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "126,127,128,129,130,131,134,135,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,199,200,201", "deleted_lines": "124,127,128,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,187,188,189", "method_info": {"method_name": "mkldnn::inner_product_test_bwd_weights::SetUp", "method_params": "", "method_startline": "113", "method_endline": "203"}}}}, "file_18": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_inner_product_forward.cpp", "file_new_name": "tests\\gtests\\test_inner_product_forward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,152,153,155,156,158,159,161,162,163", "deleted_lines": "111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,138,139,140,141,142,144,145,147,149,150,151", "method_info": {"method_name": "mkldnn::inner_product_test::SetUp", "method_params": "", "method_startline": "86", "method_endline": "164"}}}}, "file_19": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\gtests\\test_lrn_backward.cpp", "file_new_name": "tests\\gtests\\test_lrn_backward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279", "deleted_lines": "258,259,260,261,262,263,264,265,266,267,268,269,270,271,272", "method_info": {"method_name": "mkldnn::lrn_test::Forward", "method_params": "", "method_startline": "247", "method_endline": "282"}}, "hunk_1": {"Ismethod": 1, "added_lines": "297,298,299,300,301,302,303,304,305,306,307,308", "deleted_lines": "290,291,292,293,294,295,296", "method_info": {"method_name": "mkldnn::lrn_test::Backward", "method_params": "", "method_startline": "284", "method_endline": "311"}}}}, "file_20": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_lrn_forward.cpp", "file_new_name": "tests\\gtests\\test_lrn_forward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177", "deleted_lines": "129,130,131,132,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168", "method_info": {"method_name": "mkldnn::lrn_forward_test::SetUp", "method_params": "", "method_startline": "111", "method_endline": "180"}}}}, "file_21": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\gtests\\test_pooling_backward.cpp", "file_new_name": "tests\\gtests\\test_pooling_backward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "303,304,306,307,308,309,310,311,313,314,316,318,319,321,322,323,325,326,327,328,330,332,333,334,335,336", "deleted_lines": "298,299,300,302,303,305,307,308,310,311,313,314,315,317,319", "method_info": {"method_name": "mkldnn::pooling_bwd_test::Backward", "method_params": "", "method_startline": "298", "method_endline": "339"}}, "hunk_1": {"Ismethod": 1, "added_lines": "259,260,261,262,263,265,266,268,269,270,271,272,274,275,276,278,279,280,282,283,284,286,287,289,290,291,292,293", "deleted_lines": "257,258,259,261,262,264,265,266,267,269,270,271,273,274,276,277,278,280,281,283,293,295,296", "method_info": {"method_name": "mkldnn::pooling_bwd_test::Forward", "method_params": "", "method_startline": "252", "method_endline": "296"}}}}, "file_22": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_pooling_forward.cpp", "file_new_name": "tests\\gtests\\test_pooling_forward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "157,158,159,160,161,162,169,171,172,173,174,175,177,178,180,181,182,183,184,185,186,187,188,189,190,192,193,195,196,198,199,201", "deleted_lines": "161,162,163,165,167,168,169,170,171,172,173,174,176,177,179,180,181,183,184,186,188", "method_info": {"method_name": "mkldnn::pooling_test::SetUp", "method_params": "", "method_startline": "139", "method_endline": "202"}}}}, "file_23": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\gtests\\test_relu.cpp", "file_new_name": "tests\\gtests\\test_relu.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "126,127,128,129,130,131,133,134,135,136,137,138,139,140", "deleted_lines": "124,125,126,127,128,130,131,132,133", "method_info": {"method_name": "mkldnn::relu_test::Forward", "method_params": "", "method_startline": "115", "method_endline": "144"}}, "hunk_1": {"Ismethod": 1, "added_lines": "153,154,155,156,157,158,159,160,161,162,163,164,165,166,168,169", "deleted_lines": "146,147,148,149,150,151,152,154,155,156,157", "method_info": {"method_name": "mkldnn::relu_test::Backward", "method_params": "", "method_startline": "146", "method_endline": "173"}}}}, "file_24": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tests\\gtests\\test_reorder.cpp", "file_new_name": "tests\\gtests\\test_reorder.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "129", "deleted_lines": null, "method_info": {"method_name": "mkldnn::TEST_P", "method_params": "reorder_simple_expected_fail_f32_f32,TestsReorder", "method_startline": "129", "method_endline": "129"}}, "hunk_1": {"Ismethod": 1, "added_lines": "91,92,93,94,95,96,97,98", "deleted_lines": "89,90", "method_info": {"method_name": "mkldnn::reorder_simple_test::SetUp", "method_params": "", "method_startline": "59", "method_endline": "104"}}}}, "file_25": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_softmax_forward.cpp", "file_new_name": "tests\\gtests\\test_softmax_forward.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,179,180", "deleted_lines": "160,161,162,163,164,165,166,168,169,170,171", "method_info": {"method_name": "mkldnn::softmax_test::SetUp", "method_params": "", "method_startline": "140", "method_endline": "183"}}}}, "file_26": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\gtests\\test_sum.cpp", "file_new_name": "tests\\gtests\\test_sum.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "109,111,112,113,114,115,116,117,118,119,120,121,122,123,124,126,127,128,130,131,132,133,135,136,137,138,139,140,142,143,145", "deleted_lines": "107,108,109,111,112,113,114,116,117,118,120,121,122,123,124,126,127,128,129,131,132,133,134,136", "method_info": {"method_name": "mkldnn::sum_test::SetUp", "method_params": "", "method_startline": "84", "method_endline": "146"}}}}}}}