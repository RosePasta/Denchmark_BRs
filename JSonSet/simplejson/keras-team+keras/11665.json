{"BR": {"BR_id": "11665", "BR_author": "mawright", "BRopenT": "2018-11-18T07:38:53Z", "BRcloseT": "2018-11-25T14:51:06Z", "BR_text": {"BRsummary": "Poor memory performance of K.batch_dot under tensorflow backend relative to batched tf.matmul", "BRdescription": "\n \n \n [ x] Check that you are up-to-date with the master branch of Keras. You can update with:\n pip install git+git://github.com/keras-team/keras.git --upgrade --no-deps\n \n \n [ x] Check that your version of TensorFlow is up-to-date. The installation instructions can be found here.\n \n \n [x ] Provide a link to a GitHub Gist of a Python script that can reproduce your issue (or just copy the script here if it is short).\n \n \n I am performing batch matrix multiplies of two tensors of size (batch, N, M) and (batch, M, K) to get a tensor of size (batch, N, K), with the matrix products. This behavior can be done with both tf.matmul and K.batch_dot with the default axis arguments.\n However in K.batch_dot, the elementwise multiplication in the line \n \n \n keras/keras/backend/tensorflow_backend.py\n \n \n          Line 1248\n       in\n       75a3503\n \n \n \n \n \n \n  result = tf.reduce_sum(x * y, 1) \n \n \n \n \n  eats up a lot of memory. The elementwise multiplication followed by summing over an axis is of course mathematically equivalent to the matrix multiply, but in the two-step implementation, Tensorflow assigns memory to the intermediate very large tensor.\n In this simple example, my small GPU (Nvidia 970) is able to perform the calculation using tf.matmul, but using K.batch_dot Tensorflow fails with an OOM error.\n <denchmark-code>import numpy as np\n import tensorflow as tf\n from keras import backend as K\n \n a = np.random.normal(size=(100, 500, 10000)).astype(np.float32)\n b = np.random.normal(size=(100, 10000, 32)).astype(np.float32)\n \n a_t = K.placeholder(a.shape)\n b_t = K.placeholder(b.shape)\n \n td = tf.matmul(a_t, b_t)\n bd = K.batch_dot(a_t, b_t)\n \n sess = K.get_session()\n sess.run(td, feed_dict={a_t: a, b_t: b})\n sess.run(bd, feed_dict={a_t: a, b_t: b})\n </denchmark-code>\n \n This fails when it tries to assign a tensor of size (100, 10000, 500, 32) in the elementwise multiply in batch_dot (the dimension of 10000 not being strictly necessary in this case since we are only interested in the sum).\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mawright", "commentT": "2018-11-20T23:10:48Z", "comment_text": "\n \t\tThanks for reporting. Will fix in Keras this Saturday.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "mawright", "commentT": "2018-11-23T22:58:44Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/keras-team/keras/pull/11719>#11719</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "edd0c0a4bd4cea027842bc8925048976d65b1ae9", "commit_author": "Fariz Rahman", "commitT": "2018-11-25 13:10:17+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "keras\\backend\\tensorflow_backend.py", "file_new_name": "keras\\backend\\tensorflow_backend.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1239,1240,1241,1242,1243,1244,1246,1248,1249,1250,1251,1253,1254,1255,1256,1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,1267,1268,1269,1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281,1282,1283,1284,1285,1286,1287,1288,1289,1290,1291,1292,1293,1294,1295,1296,1297,1298,1299,1300,1301,1302,1303,1304,1305,1306,1307,1308,1309,1310,1311,1312,1313,1314,1315,1316,1317,1318,1319,1320,1321,1322,1323,1324,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,1353,1354,1355,1356", "deleted_lines": "1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1239,1240,1242,1243,1245,1246,1248,1250,1251", "method_info": {"method_name": "batch_dot", "method_params": "x,y,axes", "method_startline": "1100", "method_endline": "1358"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\keras\\backend\\backend_test.py", "file_new_name": "tests\\keras\\backend\\backend_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "294,295,296,297,298,299,300,301,302,303,304,305,306,307,308", "deleted_lines": null, "method_info": {"method_name": "test_batch_dot_shape", "method_params": "self", "method_startline": "256", "method_endline": "319"}}}}}}}