{"BR": {"BR_id": "387", "BR_author": "aaronbriel", "BRopenT": "2020-09-16T22:10:17Z", "BRcloseT": "2020-09-17T14:47:03Z", "BR_text": {"BRsummary": "ValidationError from haystack API when attempting curl request to doc-qa", "BRdescription": "\n \n This appears to be the same issue as <denchmark-link:https://github.com/deepset-ai/haystack/issues/101>#101</denchmark-link>\n   , but I'm able to reproduce with the latest release 0.3.0 and the latest master branch. When executing a curl request against the haystack API, I see a ValidationError when requesting to doc-qa and an AttributeError when requesting to faq_qa.\n \n Here is the stack trace from the haystack server when I attempt to run:\n curl --request POST --url '<denchmark-link:http://127.0.0.1:8000/models/1/doc-qa>http://127.0.0.1:8000/models/1/doc-qa</denchmark-link>\n ' --data '{\"questions\": [\"Where is covid from?\"]}':\n <denchmark-code>(.venv) Aarons-MacBook-Pro-3:haystack aaronbriel$ gunicorn rest_api.application:app -b 0.0.0.0:8000 -k uvicorn.workers.UvicornWorker\n [2020-09-16 16:19:39 -0500] [74657] [INFO] Starting gunicorn 20.0.4\n [2020-09-16 16:19:39 -0500] [74657] [INFO] Listening at: http://0.0.0.0:8000 (74657)\n [2020-09-16 16:19:39 -0500] [74657] [INFO] Using worker: uvicorn.workers.UvicornWorker\n [2020-09-16 16:19:39 -0500] [74660] [INFO] Booting worker with pid: 74660\n 09/16/2020 16:19:42 - INFO - elasticsearch -   HEAD http://localhost:9200/document [status:200 request:0.015s]\n 09/16/2020 16:19:43 - INFO - elasticsearch -   HEAD http://localhost:9200/label [status:200 request:0.006s]\n 09/16/2020 16:19:43 - INFO - elasticsearch -   HEAD http://localhost:9200/document [status:200 request:0.010s]\n 09/16/2020 16:19:43 - INFO - elasticsearch -   HEAD http://localhost:9200/label [status:200 request:0.003s]\n 09/16/2020 16:19:43 - INFO - farm.utils -   device: cpu n_gpu: 0, distributed training: False, automatic mixed precision training: None\n 09/16/2020 16:19:43 - INFO - farm.infer -   Could not find `deepset/roberta-base-squad2` locally. Try to download from model hub ...\n 09/16/2020 16:19:47 - WARNING - farm.modeling.language_model -   Could not automatically detect from language model name what language it is.\n \t We guess it's an *ENGLISH* model ...\n \t If not: Init the language model by supplying the 'language' param.\n 09/16/2020 16:19:51 - WARNING - farm.modeling.prediction_head -   Some unused parameters are passed to the QuestionAnsweringHead. Might not be a problem. Params: {\"loss_ignore_index\": -1}\n 09/16/2020 16:19:51 - WARNING - farm.utils -   Failed to log params: Could not find experiment with ID 0\n 09/16/2020 16:19:53 - WARNING - farm.utils -   Failed to log params: Could not find experiment with ID 0\n 09/16/2020 16:19:53 - INFO - farm.utils -   device: cpu n_gpu: 0, distributed training: False, automatic mixed precision training: None\n 09/16/2020 16:19:53 - INFO - farm.infer -   Got ya 4 parallel workers to do inference ...\n 09/16/2020 16:19:53 - INFO - farm.infer -    0    0    0    0\n 09/16/2020 16:19:53 - INFO - farm.infer -   /w\\  /w\\  /w\\  /w\\\n 09/16/2020 16:19:53 - INFO - farm.infer -   /'\\  / \\  /'\\  /'\\\n 09/16/2020 16:19:53 - INFO - farm.infer -\n 09/16/2020 16:19:53 - INFO - elasticsearch -   HEAD http://localhost:9200/document [status:200 request:0.011s]\n 09/16/2020 16:19:53 - INFO - elasticsearch -   HEAD http://localhost:9200/label [status:200 request:0.006s]\n 09/16/2020 16:19:53 - INFO - rest_api.application -   Open http://127.0.0.1:8000/docs to see Swagger API Documentation.\n 09/16/2020 16:19:53 - INFO - rest_api.application -\n Or just try it out directly: curl --request POST --url 'http://127.0.0.1:8000/models/1/doc-qa' --data '{\"questions\": [\"What is the capital of Germany?\"]}'\n \n [2020-09-16 16:19:53 -0500] [74660] [INFO] Started server process [74660]\n [2020-09-16 16:19:53 -0500] [74660] [INFO] Waiting for application startup.\n [2020-09-16 16:19:53 -0500] [74660] [INFO] Application startup complete.\n 09/16/2020 16:20:13 - INFO - haystack.retriever.sparse -   Got 1 candidates from retriever\n 09/16/2020 16:20:13 - INFO - haystack.finder -   Reader is looking for detailed answer in 705 chars ...\n Inferencing Samples: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1/1 [00:00<00:00,  3.44 Batches/s]\n 09/16/2020 16:20:14 - INFO - rest_api.controller.search -   {\"request\": {\"questions\": [\"How is the virus spreading?\"], \"filters\": null, \"top_k_reader\": 5, \"top_k_retriever\": 1}, \"results\": [{\"question\": \"How is the virus spreading?\", \"no_ans_gap\": 17.944154739379883, \"answers\": [{\"answer\": \"from person-to-person\", \"score\": 12.883939743041992, \"probability\": 0.8334797478865303, \"context\": \"This virus was first detected in Wuhan City, Hubei Province, China. The first infections were linked to a live animal market, but the virus is now spreading from person-to-person. It\\u2019s important to note that person-to-person spread can happen on a continuum. Some viruses are highly contagious (like measles), while other viruses are less so.\\n\\nThe virus that causes COVID-19 seems to be spreading easily and sustainably in the community (\\u201ccommunity spread\\u201d) in some affected geographic areas. Communi\", \"offset_start\": 157, \"offset_end\": 178, \"offset_start_in_doc\": 157, \"offset_end_in_doc\": 178, \"document_id\": \"764dbd34-a152-4ae6-9d87-d1aaf3d2b11c\", \"meta\": {\"question_emb\": [0.5515517847878593, -1.12009368624006, -0.3748682567051479, -0.5144797733851841, 0.2756530387060983, \n ... 0.43540845598493305, -0.7300209999084473, 0.1662832157952445, -0.11270188433783394, 0.0368795565196446], \"answer_html\": \"<p>This virus was first detected in Wuhan City, Hubei Province, China. The first infections were linked to a live animal market, but the virus is now spreading from person-to-person. It&rsquo;s important to note that person-to-person spread can happen on a continuum. Some viruses are highly contagious (like measles), while other viruses are less so.</p>\\n<p>The virus that causes COVID-19 seems to be spreading easily and sustainably in the community (&ldquo;community spread&rdquo;) in <a href=\\\"/coronavirus/2019-ncov/about/transmission.html#geographic\\\">some affected geographic areas</a>. Community spread means people have been infected with the virus in an area, including some who are not sure how or where they became infected.</p>\\n<p>Learn what is known about the <a href=\\\"/coronavirus/2019-ncov/about/transmission.html\\\">spread of newly emerged coronaviruses</a>.</p>\", \"link\": \"\\nhttps://www.cdc.gov/coronavirus/2019-ncov/faq.html\", \"source\": \"Center for Disease Control and Prevention (CDC)\", \"category\": \"How It Spreads\", \"country\": \"USA\", \"region\": \"\", \"city\": \"\", \"lang\": \"en\", \"last_update\": \"2020/03/17\", \"name\": \"Frequently Asked Questions\"}}, {\"answer\": null, \"score\": -5.060214996337891, \"probability\": 0.34693779767057226, \"context\": null, \"offset_start\": 0, \"offset_end\": 0, \"document_id\": null, \"meta\": {}}]}], \"time\": \"0.74\"}\n [2020-09-16 16:20:14 -0500] [74660] [ERROR] Exception in ASGI application\n Traceback (most recent call last):\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/uvicorn/protocols/http/httptools_impl.py\", line 390, in run_asgi\n     result = await app(self.scope, self.receive, self.send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/uvicorn/middleware/proxy_headers.py\", line 45, in __call__\n     return await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/applications.py\", line 179, in __call__\n     await super().__call__(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/applications.py\", line 111, in __call__\n     await self.middleware_stack(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/errors.py\", line 181, in __call__\n     raise exc from None\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/errors.py\", line 159, in __call__\n     await self.app(scope, receive, _send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/cors.py\", line 78, in __call__\n     await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/exceptions.py\", line 82, in __call__\n     raise exc from None\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/exceptions.py\", line 71, in __call__\n     await self.app(scope, receive, sender)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 566, in __call__\n     await route.handle(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 227, in handle\n     await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 41, in app\n     response = await func(request)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/routing.py\", line 199, in app\n     is_coroutine=is_coroutine,\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/routing.py\", line 111, in serialize_response\n     raise ValidationError(errors, field.type_)\n pydantic.error_wrappers.ValidationError: 1 validation error for Answers\n response -> results -> 0 -> answers -> 0 -> meta -> question_emb\n   str type expected (type=type_error.str)\n </denchmark-code>\n \n Here is the haystack stack trace when I attempt to run:\n curl --request POST --url '<denchmark-link:http://127.0.0.1:8000/models/1/faq-qa>http://127.0.0.1:8000/models/1/faq-qa</denchmark-link>\n ' --data '{\"questions\": [\"Where is covid from?\"]}':\n <denchmark-code>09/16/2020 16:23:07 - INFO - haystack.retriever.sparse -   Got 10 candidates from retriever\n [2020-09-16 16:23:07 -0500] [74660] [ERROR] Exception in ASGI application\n Traceback (most recent call last):\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/uvicorn/protocols/http/httptools_impl.py\", line 390, in run_asgi\n     result = await app(self.scope, self.receive, self.send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/uvicorn/middleware/proxy_headers.py\", line 45, in __call__\n     return await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/applications.py\", line 179, in __call__\n     await super().__call__(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/applications.py\", line 111, in __call__\n     await self.middleware_stack(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/errors.py\", line 181, in __call__\n     raise exc from None\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/errors.py\", line 159, in __call__\n     await self.app(scope, receive, _send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/middleware/cors.py\", line 78, in __call__\n     await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/exceptions.py\", line 82, in __call__\n     raise exc from None\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/exceptions.py\", line 71, in __call__\n     await self.app(scope, receive, sender)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 566, in __call__\n     await route.handle(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 227, in handle\n     await self.app(scope, receive, send)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/routing.py\", line 41, in app\n     response = await func(request)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/routing.py\", line 183, in app\n     dependant=dependant, values=values, is_coroutine=is_coroutine\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/fastapi/routing.py\", line 135, in run_endpoint_function\n     return await run_in_threadpool(dependant.call, **values)\n   File \"/Users/aaronbriel/chatbot/.venv/lib/python3.7/site-packages/starlette/concurrency.py\", line 34, in run_in_threadpool\n     return await loop.run_in_executor(None, func, *args)\n   File \"/usr/local/opt/python@3.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/concurrent/futures/thread.py\", line 57, in run\n     result = self.fn(*self.args, **self.kwargs)\n   File \"/Users/aaronbriel/chatbot/chatbots/haystack/rest_api/controller/search.py\", line 190, in faq_qa\n     question=question, top_k_retriever=request.top_k_retriever, filters=filters,\n   File \"/Users/aaronbriel/chatbot/.venv/src/farm-haystack/haystack/finder.py\", line 107, in get_answers_via_similar_questions\n     if self.retriever.embedding_model:  # type: ignore\n AttributeError: 'ElasticsearchRetriever' object has no attribute 'embedding_model'\n </denchmark-code>\n \n Expected behavior\n I expected a response.\n Additional context\n I've tried the latest release of haystack from pip as well as the latest directly installed from the github repo master branch.\n \n Start gunicorn server like: gunicorn rest_api.application:app -b 0.0.0.0:8000 -k uvicorn.workers.UvicornWorker\n Execute curl request like: curl --request POST --url '<denchmark-link:http://127.0.0.1:8000/models/1/doc-qa>http://127.0.0.1:8000/models/1/doc-qa</denchmark-link>\n ' --data '{\"questions\": [\"Where is covid from?\"]}':\n System:\n \n OS: MacOS Mojave 10.14.6\n GPU/CPU:\n Haystack version (commit or version number): Latest master branch\n DocumentStore: ElasticSearch in docker container, installed based on medium article\n Reader:\n Retriever:\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "aaronbriel", "commentT": "2020-09-17T13:34:11Z", "comment_text": "\n \t\tFix verified for doc-qa route with latest fixes from <denchmark-link:https://github.com/deepset-ai/haystack/pull/390>#390</denchmark-link>\n . Thank for for the quick response to this!\n However, running faq-qa route (ie curl --request POST --url '<denchmark-link:http://127.0.0.1:8000/models/1/faq-qa>http://127.0.0.1:8000/models/1/faq-qa</denchmark-link>\n ' --data '{\"questions\": [\"How is the virus spreading?\"]}') still throws:\n \n I figured this was due to EMBEDDING_MODEL_PATH not being set, so I tried setting it as env variable and also as default value in rest_api/config.py (EMBEDDING_MODEL_PATH = os.getenv(\"EMBEDDING_MODEL_PATH\", 'deepset/sentence_bert')) but the error persists.\n If this is a separate issue I can log a new defect.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "aaronbriel", "commentT": "2020-09-17T14:07:35Z", "comment_text": "\n \t\tYep, these were indeed two separate problems.\n We tackled the first one in <denchmark-link:https://github.com/deepset-ai/haystack/pull/390>#390</denchmark-link>\n  and are working on the second one in <denchmark-link:https://github.com/deepset-ai/haystack/pull/389>#389</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "aaronbriel", "commentT": "2020-09-17T14:47:03Z", "comment_text": "\n \t\tBeautiful. 2nd issue verified fixed from <denchmark-link:https://github.com/deepset-ai/haystack/pull/389>#389</denchmark-link>\n . Thanks!\n \t\t"}}}, "commit": {"commit_id": "03fa4a8740311e7577a8f2fc65f7973c99dca192", "commit_author": "Tanay Soni", "commitT": "2020-09-17 14:37:01+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rest_api\\config.py", "file_new_name": "rest_api\\config.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "43", "deleted_lines": "43"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rest_api\\controller\\search.py", "file_new_name": "rest_api\\controller\\search.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "105,121", "deleted_lines": "105,121"}}}}}}