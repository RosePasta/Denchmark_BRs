{"BR": {"BR_id": "391", "BR_author": "lalitpagaria", "BRopenT": "2020-09-17T14:38:48Z", "BRcloseT": "2020-09-18T10:22:52Z", "BR_text": {"BRsummary": "SQL store incorrectly apply filter query", "BRdescription": "\n Describe the bug\n SQL store incorrectly apply filter while searching document with data and return wrong document.\n Error message\n No error\n Expected behavior\n Store should apply filter correctly and return intended documents.\n Additional context\n Store filter apply IN clause across meta.value, so if same value exist in different meta.name then that document also returned by store. Please refer get_all_documents function of SQLDocumentStore. It generate following query and second part of it have issue.\n <denchmark-code>SELECT document.id AS document_id, document.created AS document_created, document.updated AS document_updated, document.text AS document_text, document.\"index\" AS document_index \n FROM document \n WHERE document.\"index\" = ? AND (EXISTS (SELECT 1 \n FROM document_meta, meta \n WHERE document.id = document_meta.document_id AND meta.id = document_meta.meta_id AND meta.name IN (?))) AND (EXISTS (SELECT 1 \n FROM document_meta, meta \n WHERE document.id = document_meta.document_id AND meta.id = document_meta.meta_id AND meta.value IN (?)))\n </denchmark-code>\n \n To Reproduce\n Use following test data with SQLDocumentStore and check\n <denchmark-code>documents = [\n         Document(\n             text=\"Doc1\",\n             meta={\"f1\": \"0\"}\n         ),\n         Document(\n             text=\"Doc1\",\n             meta={\"f2\": \"1\", \"vector_id\": \"0\"}\n         ),\n         Document(\n             text=text=\"Doc2\",,\n             meta={\"f3\": \"0\"}\n         )\n     ]\n \n     document_store_with_docs.write_documents(documents)\n     documents = document_store_with_docs.get_all_documents(filters={\"vector_id\": [\"0\"]})\n     assert len(documents) == 1\n     assert {d.meta[\"vector_id\"] for d in documents} == {\"0\"}\n </denchmark-code>\n \n System:\n Any system\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lalitpagaria", "commentT": "2020-09-17T17:01:37Z", "comment_text": "\n \t\tThanks for reporting <denchmark-link:https://github.com/lalitpagaria>@lalitpagaria</denchmark-link>\n .\n We are already working on a fix.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "lalitpagaria", "commentT": "2020-09-17T17:07:28Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tholor>@tholor</denchmark-link>\n  Thanks. I just mentioned this bug in PR. Actually while working on <denchmark-link:https://github.com/deepset-ai/haystack/pull/385>#385</denchmark-link>\n , I encountered these two issues <denchmark-link:https://github.com/deepset-ai/haystack/issues/391>#391</denchmark-link>\n  and <denchmark-link:https://github.com/deepset-ai/haystack/issues/392>#392</denchmark-link>\n .\n <denchmark-link:https://github.com/deepset-ai/haystack/issues/392>#392</denchmark-link>\n  will be fixed by my PR.\n \t\t"}}}, "commit": {"commit_id": "0859da8f74c2617dcb165a17f7ab0aadc5a00568", "commit_author": "Tanay Soni", "commitT": "2020-09-18 12:22:52+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "haystack\\document_store\\sql.py", "file_new_name": "haystack\\document_store\\sql.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "145,146,147,148", "deleted_lines": null, "method_info": {"method_name": "update_document_meta", "method_params": "self,str,str", "method_startline": "144", "method_endline": "149"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "test\\test_db.py", "file_new_name": "test\\test_db.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281", "deleted_lines": null, "method_info": {"method_name": "test_elasticsearch_update_meta", "method_params": "document_store", "method_startline": "260", "method_endline": "281"}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "238,239,240,241,242", "method_info": {"method_name": "test_elasticsearch_update_meta", "method_params": "document_store_with_docs", "method_startline": "238", "method_endline": "242"}}, "hunk_2": {"Ismethod": 1, "added_lines": "18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37", "deleted_lines": null, "method_info": {"method_name": "test_get_all_document_filter_duplicate_value", "method_params": "document_store", "method_startline": "18", "method_endline": "37"}}}}}}}