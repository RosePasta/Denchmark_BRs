{"BR": {"BR_id": "1378", "BR_author": "elitap", "BRopenT": "2020-12-17T11:03:18Z", "BRcloseT": "2020-12-28T13:49:32Z", "BR_text": {"BRsummary": "SegmentationSaver fails if dtype is np.uint8", "BRdescription": "\n SegmentationSaver fails with RuntimeError: \"inverse_cpu\" not implemented for 'Byte' if dtype is np.uint8 in monai.networks.utils line 158. It hapens when the output image that should be written by the Segmentation Saver should be uint8 (which in my eyes is the most meaningfull datatype for saving labelmaps) and an affine transformation is to be applied to rescale the output to the same spacing as the inputimage was.\n It debugged it down to monai.data.nifty_writer.py line 135 wehre the dtype of the SegmentationSaver is set before the transormation is done. This is happening since monai 3.0 and is still the case in monai 4.0. In monai 2.0 the dtype before the call off affine_xform was hardcoded to np.float32 so that the transformation worked out and the desired output dtype was just set at the end of nifti_writer.py. The workaround for now is to not set the output datatype for the SegmentationSaver so it defaults to np.float32, however the output labelmaps get much larger compared to using np.unit8.\n To Reproduce\n Use the SegmentationSaver with some integer dtype, and make it use an affine transformation (eg. rescale to the original spacing of the inputfile with batch_transform=lambda batch: batch[\"somedictkey_meta_dict\"])\n Expected behavior\n Should write uint8 labelmaps\n Environment\n monai 4.0 and 3.0,\n works in monai 2.0\n Thank you guys once more for the amazing work :-)\n Best Eli\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "elitap", "commentT": "2020-12-17T15:17:11Z", "comment_text": "\n \t\tthanks for the detailed feedback, there are options of dtype and output_dtype in nifti_writer 0.4.0 to address this issue: \n \n \n MONAI/monai/data/nifti_writer.py\n \n \n         Lines 34 to 35\n       in\n       1608b10\n \n \n \n \n \n \n  dtype: Optional[np.dtype] = np.float64, \n \n \n \n  output_dtype: Optional[np.dtype] = np.float32, \n \n \n \n \n \n the options should be made available for NiftiSaver SegmentationSaver\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "elitap", "commentT": "2020-12-18T23:20:03Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/elitap>@elitap</denchmark-link>\n  and <denchmark-link:https://github.com/wyli>@wyli</denchmark-link>\n  ,\n Thanks for raising this up, I will try to enhance it ASAP.\n \t\t"}}}, "commit": {"commit_id": "f20e13298171d2d35f38d6a87a8eaa4181b5773b", "commit_author": "Nic Ma", "commitT": "2020-12-28 13:49:31+00:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "monai\\data\\nifti_saver.py", "file_new_name": "monai\\data\\nifti_saver.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "40", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,str,str,str,bool,GridSampleMode,BILINEAR,GridSamplePadMode,BORDER,bool,float64,float32", "method_startline": "30", "method_endline": "40"}}, "hunk_1": {"Ismethod": 1, "added_lines": "124", "deleted_lines": null, "method_info": {"method_name": "save", "method_params": "self,Tensor,None", "method_startline": "74", "method_endline": "125"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "monai\\handlers\\segmentation_saver.py", "file_new_name": "monai\\handlers\\segmentation_saver.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "41,42", "deleted_lines": "41", "method_info": {"method_name": "__init__", "method_params": "self,str,str,str,bool,GridSampleMode,InterpolateMode,GridSamplePadMode,BORDER,None,None,Callable,Callable,None", "method_startline": "32", "method_endline": "44"}}, "hunk_1": {"Ismethod": 1, "added_lines": "41,42", "deleted_lines": "41", "method_info": {"method_name": "__init__", "method_params": "self,str,str,str,bool,GridSampleMode,InterpolateMode,GridSamplePadMode,BORDER,None,float64,float32,Callable,Callable,None", "method_startline": "32", "method_endline": "45"}}}}}}}