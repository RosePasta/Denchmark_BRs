{"BR": {"BR_id": "362", "BR_author": "yu-iskw", "BRopenT": "2019-02-14T05:20:05Z", "BRcloseT": "2019-02-19T07:16:17Z", "BR_text": {"BRsummary": "Can't use TPU", "BRdescription": "\n <denchmark-h:h3>Describe the bug</denchmark-h>\n \n I tried to use Cloud TPU. But I got the error on StackDriver logging. And the experiment was failed. It seems that we need to specify tensorflow version with annotation.\n <denchmark-code>HTTP response body: {\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"Internal error occurred: admission webhook \\\"pod-init.cloud-tpus.google.com\\\" denied the request: TensorFlow version must be specified in annotation \\\"tf-version.cloud-tpus.google.com\\\" for pod requesting Cloud TPUs\",\"reason\":\"InternalError\",\"details\":{\"causes\":[{\"message\":\"admission webhook \\\"pod-init.cloud-tpus.google.com\\\" denied the request: TensorFlow version must be specified in annotation \\\"tf-version.cloud-tpus.google.com\\\" for pod requesting Cloud TPUs\"}]},\"code\":500}\n </denchmark-code>\n \n <denchmark-h:h3>To Reproduce</denchmark-h>\n \n <denchmark-h:h4>YAML</denchmark-h>\n \n <denchmark-code>---\n version: 1\n \n kind: experiment\n \n environment:\n   resources:\n     cpu:\n       requests: 4\n       limits: 4\n     memory:\n       requests: 15000\n       limits: 15000\n     tpu:\n       requests: 8\n       limits: 8\n \n build:\n   image: tensorflow/tensorflow:1.12.0\n   build_steps:\n     - pip install --no-cache-dir -r requirements.txt\n \n run:\n   # this is just a dummy python file.\n   cmd: python test.py\n </denchmark-code>\n \n <denchmark-h:h4>requirements.txt</denchmark-h>\n \n <denchmark-code>polyaxon-client==0.3.8\n polyaxon-cli==0.3.8\n jupyter\n google-cloud-storage\n </denchmark-code>\n \n <denchmark-h:h3>Expected behavior</denchmark-h>\n \n We can create a TPU.\n <denchmark-h:h3>Environment</denchmark-h>\n \n \n Polyaxon: 0.3.8\n \n <denchmark-h:h2>Links</denchmark-h>\n \n \n https://cloud.google.com/tpu/docs/kubernetes-engine-setup\n https://github.com/tensorflow/tpu/blob/master/models/official/resnet/resnet_k8s.yaml#L28\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "yu-iskw", "commentT": "2019-02-14T09:34:25Z", "comment_text": "\n \t\tSorry about that, should be fixed for next release with possible customization, during deployment you can set the follwoing options in your config:\n \n tpuTensorflowVersion: to set the tensorflow version, default 1.12\n tpuResourceKey: to set the resource key, default  cloud-tpus.google.com/v2, you can change this to use the preemptible-v2.\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "yu-iskw", "commentT": "2019-02-14T17:24:28Z", "comment_text": "\n \t\tAlright. I look forward to the next release! Thank  you for your great works as always.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "yu-iskw", "commentT": "2019-02-14T18:12:11Z", "comment_text": "\n \t\tWould you mind trying this pod manifest, and see if it succeeds for you? kubectl create -f filename.yaml\n apiVersion: v1\n kind: Pod\n metadata:\n   name: somejob\n   annotations:\n     tf-version.cloud-tpus.google.com: \"1.12\"\n spec:\n   containers:\n   - args:\n     - echo scheduled\n     command:\n     - /bin/bash\n     - -c\n     image: gcr.io/tensorflow/tpu-models:r1.12\n     name: polyaxon-experiment-job\n     resources:\n       limits:\n         cloud-tpus.google.com/preemptible-v2: \"8\"\n       requests:\n         cloud-tpus.google.com/preemptible-v2: \"8\"\n   - args:\n     - echo sidecar\n     command:\n     - /bin/sh\n     - -c\n     image: ubuntu\n     name: polyaxon-job-sidecar\n   initContainers:\n   - args:\n     - echo init\n     command:\n     - /bin/sh\n     - -c\n     image: ubuntu\n     name: polyaxon-job-init\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "yu-iskw", "commentT": "2019-02-14T19:05:08Z", "comment_text": "\n \t\tI tried it, but I got the error.\n <denchmark-code>The Pod \"\" is invalid: metadata.name: Required value: name or generateName is required\n </denchmark-code>\n \n FYI: I was able to run it on our GKE cluster.\n <denchmark-link:https://github.com/tensorflow/tpu/blob/master/models/official/resnet/resnet_k8s.yaml>https://github.com/tensorflow/tpu/blob/master/models/official/resnet/resnet_k8s.yaml</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "yu-iskw", "commentT": "2019-02-14T19:08:24Z", "comment_text": "\n \t\tTrue, Updated the manifest\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "yu-iskw", "commentT": "2019-02-14T19:20:34Z", "comment_text": "\n \t\tI could submit the YAML file. It seems that a TPU was created and the output looks as expected. But the pod status is CrashLoopBackOff.\n <denchmark-code>$ kubectl create -f test.yml\n \n $ kubectl logs somejob -c polyaxon-experiment-job\n scheduled\n \n $ gcloud compute tpus describe gke-us-decent-polyaxon-ce9c85ad-tpu-2b0bd9e6 --zone=us-central1-b\n acceleratorType: v2-8\n cidrBlock: 10.20.48.0/29\n createTime: '2019-02-14T19:10:38.301313402Z'\n health: HEALTHY\n ipAddress: 10.20.48.2\n labels:\n   goog-gke-tpu: ''\n name: projects/xxxxxxxxx/locations/us-central1-b/nodes/gke-us-decent-polyaxon-ce9c85ad-tpu-2b0bd9e6\n network: global/networks/default\n networkEndpoints:\n - ipAddress: 10.20.48.2\n   port: 8470\n port: '8470'\n schedulingConfig:\n   preemptible: true\n serviceAccount: service-305320364537@cloud-tpu.iam.gserviceaccount.com\n state: READY\n tensorflowVersion: '1.12'\n \n $ kubectl get pods\n NAME      READY   STATUS             RESTARTS   AGE\n somejob   0/2     CrashLoopBackOff   10         9m\n </denchmark-code>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "yu-iskw", "commentT": "2019-02-14T19:22:29Z", "comment_text": "\n \t\tok thanks, just to make sure, because for me it stays pending for long.\n the real experiment pod is different.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "yu-iskw", "commentT": "2019-02-18T22:48:30Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mouradmourafiq>@mouradmourafiq</denchmark-link>\n  I will try the fixed version in 0.3.9 later. Can you tell me an example of YAML file to set up TPU environment? I am looking into the code, but I haven't completely understand how to specify the TPU environment yet.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "yu-iskw", "commentT": "2019-02-18T22:50:27Z", "comment_text": "\n \t\tyour yaml file, the one in the first comment, should work. I am updating the docs with all new features of this version, should be live some time tomorrow.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "yu-iskw", "commentT": "2019-02-18T23:00:30Z", "comment_text": "\n \t\tI got it. I would like to know especially how to pass annotation for tensorflow version and TPU resource key. I look forward to the documentation. I appriciate the great work!\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "yu-iskw", "commentT": "2019-02-18T23:03:18Z", "comment_text": "\n \t\tI am looking into them for YAML file.\n \n \n \n \n polyaxon/polyaxon/polyaxon/config_settings/core.py\n \n \n          Line 9\n       in\n       5866bd2\n \n \n \n \n \n \n  K8S_TPU_RESOURCE_KEY = config.get_string('POLYAXON_K8S_TPU_RESOURCE_KEY', \n \n \n \n \n \n \n \n \n polyaxon/polyaxon/polyaxon/config_settings/spawner.py\n \n \n          Line 146\n       in\n       ae999e0\n \n \n \n \n \n \n  K8S_TPU_TF_VERSION = config.get_string('POLYAXON_K8S_TPU_TF_VERSION', \n \n \n \n \n \n \n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "yu-iskw", "commentT": "2019-02-18T23:07:07Z", "comment_text": "\n \t\tAh I see, tpuTensorflowVersion and tpuResourceKey in your deployment config file. those are the default values. It will be reflected in the docs ASAP.\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "yu-iskw", "commentT": "2019-02-19T01:57:58Z", "comment_text": "\n \t\tI have made sure that we can run an experiment with TPU by default on polyaxon 0.3.9. The experiment is inspired by the following ResNet example.\n <denchmark-link:https://cloud.google.com/tpu/docs/tutorials/kubernetes-engine-resnet>https://cloud.google.com/tpu/docs/tutorials/kubernetes-engine-resnet</denchmark-link>\n \n <denchmark-code>---\n version: 1\n \n kind: experiment\n \n environment:\n   resources:\n     cpu:\n       requests: 8\n       limits: 8\n     memory:\n       requests: 10000\n       limits: 10000\n     tpu:\n       requests: 8\n       limits: 8\n \n build:\n   image: gcr.io/tensorflow/tpu-models:r1.11\n   env_vars:\n     - ['PYTHONPATH', '/tensorflow_tpu_models/models']\n \n run:\n   cmd: python \\\n         /tensorflow_tpu_models/models/official/resnet/resnet_main.py \\\n         --data_dir=\"gs://cloud-tpu-test-datasets/fake_imagenet\" \\\n         --model_dir=\"gs://xxxxxxxxxxx/resnet\"\n </denchmark-code>\n \n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "yu-iskw", "commentT": "2019-02-19T07:13:04Z", "comment_text": "\n \t\tSo I assume we can close this?\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "yu-iskw", "commentT": "2019-02-19T07:16:09Z", "comment_text": "\n \t\tYes, we can.\n \t\t"}, "comments_15": {"comment_id": 16, "comment_author": "yu-iskw", "commentT": "2019-02-19T21:59:04Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mouradmourafiq>@mouradmourafiq</denchmark-link>\n  Thank you for adding the documentaiton about custom TPU resources. But I don't clearly understand which level in the deployment config I should put the definition. I tried to put the top leven and under , but the YAML is not valid. I also trid to put it under  and , but it created a regular TPU v2, not preemptible one.  Can you tell me how to pass that in detail?\n <denchmark-link:https://github.com/polyaxon/polyaxon/blob/master/docs/configuration/custom-run-environment.md#using-tpus>https://github.com/polyaxon/polyaxon/blob/master/docs/configuration/custom-run-environment.md#using-tpus</denchmark-link>\n \n <denchmark-h:h2>Wrong YAML</denchmark-h>\n \n <denchmark-code>environment:\n   resources:\n     cpu:\n       requests: 16\n       limits: 16\n     memory:\n       requests: 20000\n       limits: 200000\n     tpu:\n       requests: 8\n       limits: 8\n     tpuTensorflowVersion: \"cloud-tpus.google.com/preemptible-v2\"\n     tpuResourceKey: \"1.12\"\n </denchmark-code>\n \n \t\t"}, "comments_16": {"comment_id": 17, "comment_author": "yu-iskw", "commentT": "2019-02-19T22:01:36Z", "comment_text": "\n \t\tThe config deployment file is the file you use to deploy Polyaxon, basically you need to update it and upgrade, it is supposed to be default values, not updated for every polyaxonfile.\n \t\t"}, "comments_17": {"comment_id": 18, "comment_author": "yu-iskw", "commentT": "2019-02-19T22:33:22Z", "comment_text": "\n \t\tThank you for answering my questions.  I understand. We can only specify which TPU type we use with the polyaxon deployment config, not YAML file for experiments.\n If possible, I want to change the type of TPU by experiment with experiment YAML files in the future. Because we definitely change the tensorflow version by experiment.\n \t\t"}, "comments_18": {"comment_id": 19, "comment_author": "yu-iskw", "commentT": "2019-02-19T22:36:50Z", "comment_text": "\n \t\tYeah we might introduce an annotation section, to accept more or less arbitrary values. unfortunately it will be quite frustrating for the time being.\n \t\t"}, "comments_19": {"comment_id": 20, "comment_author": "yu-iskw", "commentT": "2019-02-19T22:40:31Z", "comment_text": "\n \t\tI understand we must use the fixed TPU type and TF version at the moment. I look forward to it. And I am glad to be on the same page with you. Thanks!\n \t\t"}}}, "commit": {"commit_id": "6fabfbfff25e589af5287e4657405dc928cd8fe0", "commit_author": "Anton Friberg", "commitT": "2019-02-15 13:33:46+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "polystores\\stores\\azure_store.py", "file_new_name": "polystores\\stores\\azure_store.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "247", "deleted_lines": "247", "method_info": {"method_name": "download_dir", "method_params": "self,blob,local_path,container_name,use_basename", "method_startline": "226", "method_endline": "269"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "polystores\\stores\\gcs_store.py", "file_new_name": "polystores\\stores\\gcs_store.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "302", "deleted_lines": "302", "method_info": {"method_name": "download_dir", "method_params": "self,blob,local_path,bucket_name,use_basename", "method_startline": "281", "method_endline": "324"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "polystores\\stores\\s3_store.py", "file_new_name": "polystores\\stores\\s3_store.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "557", "deleted_lines": "557", "method_info": {"method_name": "download_dir", "method_params": "self,key,local_path,bucket_name,use_basename", "method_startline": "536", "method_endline": "579"}}}}}}}