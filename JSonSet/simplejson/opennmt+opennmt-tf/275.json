{"BR": {"BR_id": "275", "BR_author": "Dagamies", "BRopenT": "2018-11-28T08:46:00Z", "BRcloseT": "2018-11-28T09:18:03Z", "BR_text": {"BRsummary": "Latest (1.14) OpenNMT-tf gives error on inferencing", "BRdescription": "\n Hi,\n I have trained a model ParallelEncoder having two input files (words and their features). This far all has worked just fine, but now I get following error when trying to run inference:\n Traceback (most recent call last):\n File \"opennmt/bin/main.py\", line 192, in \n main()\n File \"opennmt/bin/main.py\", line 175, in main\n log_time=args.log_prediction_time)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/runner.py\", line 329, in infer\n hooks=infer_hooks):\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 548, in predict\n input_fn, model_fn_lib.ModeKeys.PREDICT)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1023, in _get_features_from_input_fn\n result = self._call_input_fn(input_fn, mode)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1135, in _call_input_fn\n return input_fn(**kwargs)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/model.py\", line 492, in \n maximum_labels_length=maximum_labels_length)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/model.py\", line 415, in _input_fn_impl\n length_fn=self._get_features_length)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/data.py\", line 352, in inference_pipeline\n _key_func, _reduce_func, window_size=batch_size))\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/data/ops/dataset_ops.py\", line 1140, in apply\n dataset = transformation_func(self)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 117, in _apply_fn\n window_size_func)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 422, in init\n self._make_key_func(key_func, input_dataset)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/contrib/data/python/ops/grouping.py\", line 451, in _make_key_func\n \"key_func must return a single tf.int64 scalar tensor.\")\n ValueError: key_func must return a single tf.int64 scalar tensor.\n When I run infer on 1.10 it will work just fine on the model trained on 1.14. Error seems to be present also on 1.13.1\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Dagamies", "commentT": "2018-11-28T08:50:32Z", "comment_text": "\n \t\tHi,\n Thanks for reporting. Do you confirm you are using the --auto_config flag?\n To workaround the issue, try adding this in your configuration:\n infer:\n   bucket_width: 0\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Dagamies", "commentT": "2018-11-28T09:02:16Z", "comment_text": "\n \t\tGreat. This now works on \"old\" models. bucket_width 0 or 1 work just fine. When I'm trying to infer the new multi-source transformer mode I started getting another error:\n 2018-11-28 10:58:38.020515: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n INFO:tensorflow:Running local_init_op.\n 2018-11-28 10:58:38.257302: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n INFO:tensorflow:Done running local_init_op.\n 2018-11-28 10:58:38.349261: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n 2018-11-28 10:58:38.580481: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n Traceback (most recent call last):\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1292, in _do_call\n return fn(*args)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1277, in _run_fn\n options, feed_dict, fetch_list, target_list, run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1365, in _call_tf_sessionrun\n run_metadata)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n [[{{node transformer/decoder/while/Reshape_70}} = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n [[{{node transformer/Cast/_1585}} = _Recv<denchmark-link:>client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"</denchmark-link>\n ]]\n During handling of the above exception, another exception occurred:\n Traceback (most recent call last):\n File \"opennmt/bin/main.py\", line 192, in \n main()\n File \"opennmt/bin/main.py\", line 175, in main\n log_time=args.log_prediction_time)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/runner.py\", line 329, in infer\n hooks=infer_hooks):\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 568, in predict\n preds_evaluated = mon_sess.run(predictions)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 671, in run\n run_metadata=run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1148, in run\n run_metadata=run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1239, in run\n raise six.reraise(*original_exc_info)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/six.py\", line 693, in reraise\n raise value\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1224, in run\n return self._sess.run(*args, **kwargs)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1296, in run\n run_metadata=run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1076, in run\n return self._sess.run(*args, **kwargs)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 887, in run\n run_metadata_ptr)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1110, in _run\n feed_dict_tensor, options, run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1286, in _do_run\n run_metadata)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1306, in _do_call\n raise type(e)(node_def, op, message)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n [[node transformer/decoder/while/Reshape_70 (defined at /home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py:88)  = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n [[{{node transformer/Cast/_1585}} = _Recv<denchmark-link:>client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"</denchmark-link>\n ]]\n Caused by op 'transformer/decoder/while/Reshape_70', defined at:\n File \"opennmt/bin/main.py\", line 192, in \n main()\n File \"opennmt/bin/main.py\", line 175, in main\n log_time=args.log_prediction_time)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/runner.py\", line 329, in infer\n hooks=infer_hooks):\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 550, in predict\n features, None, model_fn_lib.ModeKeys.PREDICT, self.config)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1168, in _call_model_fn\n model_fn_results = self._model_fn(features=features, **kwargs)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/model.py\", line 152, in _model_fn\n _, predictions = self._build(features, labels, params, mode, config=config)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/sequence_to_sequence.py\", line 277, in _build\n return_alignment_history=True))\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/decoders/decoder.py\", line 378, in dynamic_decode_and_search\n min_decode_length=minimum_length)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 613, in beam_search\n back_prop=False)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3274, in while_loop\n return_same_structure)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2994, in BuildLoop\n pred, body, original_loop_vars, loop_vars, shape_invariants)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2929, in _BuildLoop\n body_result = body(*packed_vars_for_body)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 539, in inner_loop\n i, alive_seq, alive_log_probs, states)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 428, in grow_topk\n lambda t: _unmerge_beam_dim(t, batch_size, beam_size), flat_states)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/nest.py\", line 347, in map_structure\n structure[0], [func(*x) for x in entries])\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/nest.py\", line 347, in \n structure[0], [func(*x) for x in entries])\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 428, in \n lambda t: _unmerge_beam_dim(t, batch_size, beam_size), flat_states)\n File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 88, in _unmerge_beam_dim\n return tf.reshape(tensor, new_shape)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6296, in reshape\n \"Reshape\", tensor=tensor, shape=shape, name=name)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n op_def=op_def)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n return func(*args, **kwargs)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3274, in create_op\n op_def=op_def)\n File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1770, in init\n self._traceback = tf_stack.extract_stack()\n InvalidArgumentError (see above for traceback): Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n [[node transformer/decoder/while/Reshape_70 (defined at /home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py:88)  = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n [[{{node transformer/Cast/_1585}} = _Recv<denchmark-link:>client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"</denchmark-link>\n ]]\n The model trains just fine (and it is a copy from example)\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Dagamies", "commentT": "2018-11-28T09:11:07Z", "comment_text": "\n \t\tI moved your last error log to a separate issue <denchmark-link:https://github.com/OpenNMT/OpenNMT-tf/issues/276>#276</denchmark-link>\n  as it is a different problem.\n \t\t"}}}, "commit": {"commit_id": "0a2890a7ea72a8ee0335c25e6dcaffdb920c3a10", "commit_author": "Guillaume Klein", "commitT": "2018-11-28 10:18:02+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "19,20", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "opennmt\\utils\\data.py", "file_new_name": "opennmt\\utils\\data.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "333,334,336,337", "deleted_lines": "333,334,336,337", "method_info": {"method_name": "_key_func", "method_params": "x", "method_startline": "332", "method_endline": "337"}}}}}}}