{"BR": {"BR_id": "377", "BR_author": "BigFishMaster", "BRopenT": "2019-03-09T03:35:03Z", "BRcloseT": "2019-03-11T10:28:33Z", "BR_text": {"BRsummary": "ValueError: Duplicate node name in graph: 'lm/position_encoding/w_embs'", "BRdescription": "\n When I train GPT-2 model, I meet this error after the evaluation.\n <denchmark-code>INFO:tensorflow:loss = 8.426817, step = 14800 (274.140 sec)\n INFO:tensorflow:source_words/sec: 13932\n INFO:tensorflow:loss = 8.261417, step = 14900 (275.013 sec)\n INFO:tensorflow:source_words/sec: 13854\n INFO:tensorflow:Saving checkpoints for 15000 into /mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/data/gpt2_12/run/model.ckpt.\n INFO:tensorflow:Calling model_fn.\n INFO:tensorflow:Done calling model_fn.\n INFO:tensorflow:Starting evaluation at 2019-03-08-13:46:01\n INFO:tensorflow:Graph was finalized.\n 2019-03-08 21:46:01.956459: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1511] Adding visible gpu devices: 0, 1, 2, 3\n 2019-03-08 21:46:01.956642: I tensorflow/core/common_runtime/gpu/gpu_device.cc:982] Device interconnect StreamExecutor with strength 1 edge matrix:\n 2019-03-08 21:46:01.956657: I tensorflow/core/common_runtime/gpu/gpu_device.cc:988]      0 1 2 3 \n 2019-03-08 21:46:01.956664: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 0:   N Y Y Y \n 2019-03-08 21:46:01.956671: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 1:   Y N Y Y \n 2019-03-08 21:46:01.956678: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 2:   Y Y N Y \n 2019-03-08 21:46:01.956684: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 3:   Y Y Y N \n 2019-03-08 21:46:01.957593: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 23005 MB memory) -> physical GPU (device: 0, name: Tesla P40, pci bus id: 0000:04:00.0, compute capability: 6.1)\n 2019-03-08 21:46:01.957740: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:1 with 23005 MB memory) -> physical GPU (device: 1, name: Tesla P40, pci bus id: 0000:06:00.0, compute capability: 6.1)\n 2019-03-08 21:46:01.957867: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:2 with 23005 MB memory) -> physical GPU (device: 2, name: Tesla P40, pci bus id: 0000:07:00.0, compute capability: 6.1)\n 2019-03-08 21:46:01.957976: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:3 with 23005 MB memory) -> physical GPU (device: 3, name: Tesla P40, pci bus id: 0000:0e:00.0, compute capability: 6.1)\n INFO:tensorflow:Restoring parameters from /mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/data/gpt2_12/run/model.ckpt-15000\n INFO:tensorflow:Running local_init_op.\n INFO:tensorflow:Done running local_init_op.\n INFO:tensorflow:Finished evaluation at 2019-03-09-02:43:36\n INFO:tensorflow:Saving dict for global step 15000: global_step = 15000, loss = 8.081819\n INFO:tensorflow:Saving 'checkpoint_path' summary for global step 15000: /mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/data/gpt2_12/run/model.ckpt-15000\n INFO:tensorflow:Calling model_fn.\n Traceback (most recent call last):\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1628, in _create_c_op\n     c_op = c_api.TF_FinishOperation(op_desc)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Duplicate node name in graph: 'lm/position_encoding/w_embs'\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 201, in <module>\n     main()\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/code/../OpenNMT-tf-master/opennmt/bin/main.py\", line 172, in main\n     runner.train_and_evaluate(checkpoint_path=args.checkpoint_path)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/runner.py\", line 295, in train_and_evaluate\n     result = tf.estimator.train_and_evaluate(estimator, train_spec, eval_spec)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 471, in train_and_evaluate\n     return executor.run()\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 610, in run\n     return self.run_local()\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 711, in run_local\n     saving_listeners=saving_listeners)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 354, in train\n     loss = self._train_model(input_fn, hooks, saving_listeners)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1207, in _train_model\n     return self._train_model_default(input_fn, hooks, saving_listeners)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1241, in _train_model_default\n     saving_listeners)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1471, in _train_with_estimator_spec\n     _, loss = mon_sess.run([estimator_spec.train_op, estimator_spec.loss])\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 671, in run\n     run_metadata=run_metadata)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1156, in run\n     run_metadata=run_metadata)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1255, in run\n     raise six.reraise(*original_exc_info)\n   File \"/usr/local/python3/lib/python3.6/site-packages/six.py\", line 693, in reraise\n     raise value\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1240, in run\n     return self._sess.run(*args, **kwargs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1320, in run\n     run_metadata=run_metadata))\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 582, in after_run\n     if self._save(run_context.session, global_step):\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/training/basic_session_run_hooks.py\", line 607, in _save\n     if l.after_save(session, step):\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 517, in after_save\n     self._evaluate(global_step_value)  # updates self.eval_result\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 537, in _evaluate\n     self._evaluator.evaluate_and_export())\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 924, in evaluate_and_export\n     is_the_final_export)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/training.py\", line 957, in _export_eval_result\n     is_the_final_export=is_the_final_export))\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/exporter.py\", line 472, in export\n     is_the_final_export)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/exporter.py\", line 126, in export\n     strip_default_attrs=self._strip_default_attrs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 663, in export_savedmodel\n     mode=model_fn_lib.ModeKeys.PREDICT)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 789, in _export_saved_model_for_mode\n     strip_default_attrs=strip_default_attrs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 907, in _export_all_saved_models\n     mode=model_fn_lib.ModeKeys.PREDICT)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 984, in _add_meta_graph_for_mode\n     config=self.config)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1195, in _call_model_fn\n     model_fn_results = self._model_fn(features=features, **kwargs)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/estimator.py\", line 208, in _fn\n     _, predictions = local_model(features, labels, params, mode)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/models/model.py\", line 88, in __call__\n     return self._call(features, labels, params, mode)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/models/language_model.py\", line 99, in _call\n     sample_temperature=params.get(\"sampling_temperature\", 1))\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/decoders/decoder.py\", line 784, in greedy_decode\n     parallel_iterations=1)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3291, in while_loop\n     return_same_structure)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3004, in BuildLoop\n     pred, body, original_loop_vars, loop_vars, shape_invariants)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2939, in _BuildLoop\n     body_result = body(*packed_vars_for_body)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/decoders/decoder.py\", line 727, in _body\n     logits, state = symbols_to_logits_fn(inputs, step, state)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/models/language_model.py\", line 113, in _decode\n     logits, state, _ = self.decoder(inputs, length_or_step, state=state, training=training)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/keras/engine/base_layer.py\", line 757, in __call__\n     outputs = self.call(inputs, *args, **kwargs)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/decoders/decoder.py\", line 593, in call\n     training=training)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/decoders/self_attention_decoder.py\", line 404, in step\n     training=training)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/decoders/self_attention_decoder.py\", line 338, in _run\n     inputs = self.position_encoder(inputs, position=step + 1 if step is not None else None)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/layers/position.py\", line 72, in __call__\n     self.build(inputs.shape)\n   File \"/mnt/yardcephfs/mmyard/g_wxg_td_prc/chriscxyan/OpenNMT-TF/opennmt-tf/OpenNMT-tf-master/opennmt/layers/position.py\", line 155, in build\n     name=compat.name_from_variable_scope(\"position_encoding/w_embs\"))\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 183, in __call__\n     return cls._variable_v1_call(*args, **kwargs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 146, in _variable_v1_call\n     aggregation=aggregation)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 125, in <lambda>\n     previous_getter = lambda **kwargs: default_variable_creator(None, **kwargs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 2444, in default_variable_creator\n     expected_shape=expected_shape, import_scope=import_scope)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 187, in __call__\n     return super(VariableMetaclass, cls).__call__(*args, **kwargs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1329, in __init__\n     constraint=constraint)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 1443, in _init_from_args\n     name=name)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/state_ops.py\", line 77, in variable_op_v2\n     shared_name=shared_name)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/ops/gen_state_ops.py\", line 1357, in variable_v2\n     shared_name=shared_name, name=name)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n     op_def=op_def)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n     return func(*args, **kwargs)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3274, in create_op\n     op_def=op_def)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1792, in __init__\n     control_input_ops)\n   File \"/usr/local/python3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1631, in _create_c_op\n     raise ValueError(str(e))\n ValueError: Duplicate node name in graph: 'lm/position_encoding/w_embs'\n \n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "BigFishMaster", "commentT": "2019-03-09T09:42:18Z", "comment_text": "\n \t\tCould you try disabling the model export? There could be incompatibility with this model currently.\n eval:\n   exporters: null\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "BigFishMaster", "commentT": "2019-03-09T13:11:17Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/guillaumekln>@guillaumekln</denchmark-link>\n  I will try it.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "BigFishMaster", "commentT": "2019-03-11T09:57:09Z", "comment_text": "\n \t\tActually, the inference is currently broken with this model. Sorry, it's a very new and experimental model so thank you for testing and reporting.\n \t\t"}}}, "commit": {"commit_id": "1020e975c540cfec26722977ab567abc01e9fc75", "commit_author": "Guillaume Klein", "commitT": "2019-03-11 11:28:32+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "20", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "opennmt\\models\\language_model.py", "file_new_name": "opennmt\\models\\language_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "90,91,92,93,94,95,96,97,98,99,100", "deleted_lines": "90,91,92,93,94,95,96,97,98,99", "method_info": {"method_name": "_call", "method_params": "self,features,labels,params,mode", "method_startline": "63", "method_endline": "109"}}}}}}}