{"BR": {"BR_id": "276", "BR_author": "guillaumekln", "BRopenT": "2018-11-28T09:07:42Z", "BRcloseT": "2018-11-28T12:18:28Z", "BR_text": {"BRsummary": "Error when running inference on the multi-source Transformer", "BRdescription": "\n <denchmark-code>2018-11-28 10:58:38.020515: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n INFO:tensorflow:Running local_init_op.\n 2018-11-28 10:58:38.257302: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n INFO:tensorflow:Done running local_init_op.\n 2018-11-28 10:58:38.349261: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n 2018-11-28 10:58:38.580481: I tensorflow/core/grappler/optimizers/meta_optimizer.cc:344] Starting optimization for grappler item: tf_graph\n Traceback (most recent call last):\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1292, in _do_call\n     return fn(*args)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1277, in _run_fn\n     options, feed_dict, fetch_list, target_list, run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1365, in _call_tf_sessionrun\n     run_metadata)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n \t [[{{node transformer/decoder/while/Reshape_70}} = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n \t [[{{node transformer/Cast/_1585}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"opennmt/bin/main.py\", line 192, in <module>\n     main()\n   File \"opennmt/bin/main.py\", line 175, in main\n     log_time=args.log_prediction_time)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/runner.py\", line 329, in infer\n     hooks=infer_hooks):\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 568, in predict\n     preds_evaluated = mon_sess.run(predictions)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 671, in run\n     run_metadata=run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1148, in run\n     run_metadata=run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1239, in run\n     raise six.reraise(*original_exc_info)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/six.py\", line 693, in reraise\n     raise value\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1224, in run\n     return self._sess.run(*args, **kwargs)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1296, in run\n     run_metadata=run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/training/monitored_session.py\", line 1076, in run\n     return self._sess.run(*args, **kwargs)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 887, in run\n     run_metadata_ptr)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1110, in _run\n     feed_dict_tensor, options, run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1286, in _do_run\n     run_metadata)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/client/session.py\", line 1306, in _do_call\n     raise type(e)(node_def, op, message)\n tensorflow.python.framework.errors_impl.InvalidArgumentError: Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n \t [[node transformer/decoder/while/Reshape_70 (defined at /home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py:88)  = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n \t [[{{node transformer/Cast/_1585}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n \n Caused by op 'transformer/decoder/while/Reshape_70', defined at:\n   File \"opennmt/bin/main.py\", line 192, in <module>\n     main()\n   File \"opennmt/bin/main.py\", line 175, in main\n     log_time=args.log_prediction_time)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/runner.py\", line 329, in infer\n     hooks=infer_hooks):\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 550, in predict\n     features, None, model_fn_lib.ModeKeys.PREDICT, self.config)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/estimator/estimator.py\", line 1168, in _call_model_fn\n     model_fn_results = self._model_fn(features=features, **kwargs)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/model.py\", line 152, in _model_fn\n     _, predictions = self._build(features, labels, params, mode, config=config)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/models/sequence_to_sequence.py\", line 277, in _build\n     return_alignment_history=True))\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/decoders/decoder.py\", line 378, in dynamic_decode_and_search\n     min_decode_length=minimum_length)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 613, in beam_search\n     back_prop=False)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 3274, in while_loop\n     return_same_structure)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2994, in BuildLoop\n     pred, body, original_loop_vars, loop_vars, shape_invariants)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/control_flow_ops.py\", line 2929, in _BuildLoop\n     body_result = body(*packed_vars_for_body)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 539, in inner_loop\n     i, alive_seq, alive_log_probs, states)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 428, in grow_topk\n     lambda t: _unmerge_beam_dim(t, batch_size, beam_size), flat_states)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/nest.py\", line 347, in map_structure\n     structure[0], [func(*x) for x in entries])\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/nest.py\", line 347, in <listcomp>\n     structure[0], [func(*x) for x in entries])\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 428, in <lambda>\n     lambda t: _unmerge_beam_dim(t, batch_size, beam_size), flat_states)\n   File \"/home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py\", line 88, in _unmerge_beam_dim\n     return tf.reshape(tensor, new_shape)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py\", line 6296, in reshape\n     \"Reshape\", tensor=tensor, shape=shape, name=name)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py\", line 787, in _apply_op_helper\n     op_def=op_def)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py\", line 488, in new_func\n     return func(*args, **kwargs)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 3274, in create_op\n     op_def=op_def)\n   File \"/home/ari/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 1770, in __init__\n     self._traceback = tf_stack.extract_stack()\n \n InvalidArgumentError (see above for traceback): Input to reshape is a tensor with 1818624 values, but the requested shape has 3637248\n \t [[node transformer/decoder/while/Reshape_70 (defined at /home/ari/tf/Onmt-14/OpenNMT-tf/opennmt/utils/beam_search.py:88)  = Reshape[T=DT_FLOAT, Tshape=DT_INT32, _device=\"/job:localhost/replica:0/task:0/device:GPU:0\"](transformer/decoder/while/layer_5/multi_head_1/cond/Merge_1, transformer/decoder/while/Reshape_70/shape)]]\n \t [[{{node transformer/Cast/_1585}} = _Recv[client_terminated=false, recv_device=\"/job:localhost/replica:0/task:0/device:CPU:0\", send_device=\"/job:localhost/replica:0/task:0/device:GPU:0\", send_device_incarnation=1, tensor_name=\"edge_1967_transformer/Cast\", tensor_type=DT_INT64, _device=\"/job:localhost/replica:0/task:0/device:CPU:0\"]()]]\n </denchmark-code>\n \n The model trains just fine (and it is a copy from example)\n Originally posted by @Dagamies in #275 (comment)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "guillaumekln", "commentT": "2018-11-28T09:21:03Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Dagamies>@Dagamies</denchmark-link>\n , can you share your run configuration?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "guillaumekln", "commentT": "2018-11-28T09:25:54Z", "comment_text": "\n \t\tModel is from example, other parameters are:\n <denchmark-code>model_dir: /data/20/tf/multi_tf\n \n data:\n   train_features_file: \n     - /data/20/tf/a_train.words.txt\n     - /data/20/tf/a_train.feats.txt\n   train_labels_file: /data/19/tf/a_train_r.words.txt\n   eval_features_file: \n     - /data/20/tf/a_validate.words.txt\n     - /data/20/tf/a_validate.feats.txt\n   eval_labels_file: /data/20/tf/a_validate_r.words.txt\n   source_vocabulary_1: /data/20/tf/a_train.words-vocab.txt\n   source_vocabulary_2: /data/20/tf/a_train.feats-vocab.txt\n   target_vocabulary: /data/20/tf/a_train_r.words-vocab.txt\n \n \n params:\n   optimizer: AdamOptimizer\n   learning_rate: 4.0  \n   decay_type: noam_decay\n   decay_rate: 512  \n   decay_steps: 1000  \n \n \n   decay_step_duration: 8  \n \n   average_loss_in_time: true\n   label_smoothing: 0.01  # was 0.1\n \n   beam_width: 16\n   # length_penalty: 0.6\n   clip_gradients: 8.0\n \n   optimizer_params: \n     beta1: 0.9\n     beta2: 0.998\n \n \n train:\n   batch_size: 32\n   batch_type: tokens\n   bucket_width: 1\n \n   maximum_features_length: 351\n   maximum_labels_length: 767\n \n   save_checkpoints_steps: 20000\n   keep_checkpoint_max: 8\n   save_summary_steps: 100\n   train_steps: 10000000\n   clip_gradients: 8.0\n   # Consider setting this to -1 to match the number of training examples.\n   sample_buffer_size: -1\n \n eval:\n   batch_size: 32\n   eval_delay: 3600  \n \n infer:\n   batch_size: 1\n   bucket_width: 0\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "06eba7fdf11c6d84bf127ffbc7b9349eda5eb825", "commit_author": "Guillaume Klein", "commitT": "2018-11-28 13:18:27+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGELOG.md", "file_new_name": "CHANGELOG.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "20", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "opennmt\\models\\sequence_to_sequence.py", "file_new_name": "opennmt\\models\\sequence_to_sequence.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "239", "deleted_lines": "239", "method_info": {"method_name": "_build", "method_params": "self,features,labels,params,mode,config", "method_startline": "179", "method_endline": "312"}}}}}}}