{"BR": {"BR_id": "518", "BR_author": "jithunnair-amd", "BRopenT": "2020-11-09T23:20:23Z", "BRcloseT": "2020-11-19T16:17:16Z", "BR_text": {"BRsummary": "NCCL error in test_checkpointing.py distributed tests", "BRdescription": "\n Many of the distributed tests in test_checkpointing.py seem to be incorrectly written: they end up using the same device 0 for the various ranks. One can verify this by setting the  environment variables while running the tests. Older versions of NCCL eg. 2.4.8 would allow this, but it causes errors with newer versions of NCCL  eg. 2.7.8. Attaching the run logs for both NCCL versions with above-mentioned environment variables set. DeepSpeed commit used is <denchmark-link:https://github.com/microsoft/DeepSpeed/commit/7d4d742bf03f8e1707130391e0b39bd6d93a702a>7d4d742</denchmark-link>\n .\n <denchmark-link:https://github.com/microsoft/DeepSpeed/files/5513800/test_checkpoint_unfused_optimizer.nccl_2.7.8.log>test_checkpoint_unfused_optimizer.nccl_2.7.8.log</denchmark-link>\n \n <denchmark-link:https://github.com/microsoft/DeepSpeed/files/5513801/test_checkpoint_unfused_optimizer.nccl_2.4.8.log>test_checkpoint_unfused_optimizer.nccl_2.4.8.log</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jithunnair-amd", "commentT": "2020-11-11T18:47:35Z", "comment_text": "\n \t\tThanks for the report and logs! As you can see, we test on older NCCL versions.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jithunnair-amd", "commentT": "2020-11-11T19:49:11Z", "comment_text": "\n \t\tYes. However, this really seems to be an issue in the way the distributed test logic is written, because it ends up having multiple ranks on the same device (NCCL does not control the association of device to rank; it just uses the current CUDA device).\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jithunnair-amd", "commentT": "2020-11-11T20:36:21Z", "comment_text": "\n \t\tYep, understood. I just meant we had not encountered the error before due to older NCCL versions.\n I haven't had a chance to dig into specifics yet, but am curious why the ranks are all pinned to the same device. Our distributed_test helper assigns devices: \n \n \n DeepSpeed/tests/unit/common.py\n \n \n          Line 42\n       in\n       eea1c28\n \n \n \n \n \n \n  torch.cuda.set_device(local_rank) \n \n \n \n \n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jithunnair-amd", "commentT": "2020-11-12T05:32:05Z", "comment_text": "\n \t\tRight, I noticed the same myself. However, when profiling the CUDA calls, I noticed that cudaSetDevice(0) was being called after the cudaSetDevice(<device>) call triggered from the line above. I wasn't able to narrow down where the subsequent cudaSetDevice calls were being triggered from.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jithunnair-amd", "commentT": "2020-11-19T16:17:16Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/jithunnair-amd>@jithunnair-amd</denchmark-link>\n , this issue should now be resolved. Feel free to re-open if you're still seeing an issue though.\n \t\t"}}}, "commit": {"commit_id": "08c96a1bc6d9c0345b31889bba66d73f20d0b0b5", "commit_author": "Jeff Rasley", "commitT": "2020-11-19 08:16:27-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deepspeed\\runtime\\engine.py", "file_new_name": "deepspeed\\runtime\\engine.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "664", "deleted_lines": "664", "method_info": {"method_name": "_configure_zero_optimizer", "method_params": "self,optimizer", "method_startline": "661", "method_endline": "701"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deepspeed\\runtime\\utils.py", "file_new_name": "deepspeed\\runtime\\utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "71,72,73,74,75,76", "method_info": {"method_name": "check", "method_params": "self,param_groups", "method_startline": "70", "method_endline": "88"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 13, "file_old_name": "deepspeed\\runtime\\zero\\stage1.py", "file_new_name": "deepspeed\\runtime\\zero\\stage1.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1012,1013,1014,1015,1017,1018", "deleted_lines": null, "method_info": {"method_name": "_restore_base_optimizer_state", "method_params": "self,state_dict_list", "method_startline": "1006", "method_endline": "1025"}}, "hunk_1": {"Ismethod": 1, "added_lines": "967,978", "deleted_lines": "963,982", "method_info": {"method_name": "_retrieve_group_optimizer_states", "method_params": "self,all_partition_states", "method_startline": "963", "method_endline": "984"}}, "hunk_2": {"Ismethod": 1, "added_lines": "464", "deleted_lines": null, "method_info": {"method_name": "get_flat_sub_partitions", "method_params": "comm_tensor_list,comm_param_offsets,sub_partition_size,dtype,default_device,num_comm_intervals,return_partition_params", "method_startline": "460", "method_endline": "466"}}, "hunk_3": {"Ismethod": 1, "added_lines": "936,937,938,939,940,942,943", "deleted_lines": "931,939,946", "method_info": {"method_name": "_restore_from_fp32_weights", "method_params": "self,all_state_dict", "method_startline": "929", "method_endline": "948"}}, "hunk_4": {"Ismethod": 1, "added_lines": "951,952,953,954", "deleted_lines": "952", "method_info": {"method_name": "_partition_base_optimizer_state", "method_params": "self,state_key,all_partition_states,max_elems_per_comm", "method_startline": "951", "method_endline": "954"}}, "hunk_5": {"Ismethod": 1, "added_lines": "939,940,942,943,951,952,953,954", "deleted_lines": "939,946,952", "method_info": {"method_name": "_partition_base_optimizer_state", "method_params": "self,state_key,all_partition_states", "method_startline": "939", "method_endline": "957"}}, "hunk_6": {"Ismethod": 1, "added_lines": "321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346", "deleted_lines": null, "method_info": {"method_name": "best_max_elems_per_comm", "method_params": "num_elements,max_elements_per_comm,dp", "method_startline": "321", "method_endline": "346"}}, "hunk_7": {"Ismethod": 1, "added_lines": "862", "deleted_lines": null, "method_info": {"method_name": "_elastic_state_dict", "method_params": "self", "method_startline": "849", "method_endline": "869"}}, "hunk_8": {"Ismethod": 1, "added_lines": "894,895,896", "deleted_lines": null, "method_info": {"method_name": "_retrieve_group_sub_partition_weights", "method_params": "self,all_partition_fp32_weights,max_elems_per_comm", "method_startline": "894", "method_endline": "896"}}, "hunk_9": {"Ismethod": 1, "added_lines": "978,997,998", "deleted_lines": "982,997", "method_info": {"method_name": "_retrieve_group_optimizer_states", "method_params": "self,all_partition_states,max_elems_per_comm", "method_startline": "978", "method_endline": "1000"}}, "hunk_10": {"Ismethod": 1, "added_lines": null, "deleted_lines": "423", "method_info": {"method_name": "get_flat_sub_partitions", "method_params": "comm_tensor_list,comm_param_offsets,sub_partition_size,dtype,num_comm_intervals,default_device,return_partition_params", "method_startline": "418", "method_endline": "424"}}, "hunk_11": {"Ismethod": 1, "added_lines": "660", "deleted_lines": "629,637,638,639,640,641,642,643,644,645,646,655,658,661", "method_info": {"method_name": "step", "method_params": "self,closure", "method_startline": "625", "method_endline": "708"}}, "hunk_12": {"Ismethod": 1, "added_lines": "894,895,896,911,917", "deleted_lines": "890,905,911", "method_info": {"method_name": "_retrieve_group_sub_partition_weights", "method_params": "self,all_partition_fp32_weights", "method_startline": "890", "method_endline": "917"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tests\\unit\\common.py", "file_new_name": "tests\\unit\\common.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "44,45", "deleted_lines": null, "method_info": {"method_name": "distributed_test.dist_wrap", "method_params": "run_func", "method_startline": "30", "method_endline": "100"}}, "hunk_1": {"Ismethod": 1, "added_lines": "44,45", "deleted_lines": null, "method_info": {"method_name": "distributed_test.distributed_test.dist_wrap.dist_init", "method_params": "local_rank,num_procs,func_args,func_kwargs", "method_startline": "32", "method_endline": "46"}}, "hunk_2": {"Ismethod": 1, "added_lines": "44,45", "deleted_lines": null, "method_info": {"method_name": "distributed_test", "method_params": "world_size,backend", "method_startline": "14", "method_endline": "102"}}}}}}}