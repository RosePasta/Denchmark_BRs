{"BR": {"BR_id": "117", "BR_author": "nwschurink", "BRopenT": "2020-04-08T10:16:20Z", "BRcloseT": "2020-04-08T14:39:14Z", "BR_text": {"BRsummary": "CropOrPad only crops Mask", "BRdescription": "\n TorchIO version\n 0.15.0\n What I did\n Create the following sequence of transforms:\n <denchmark-code>input_H = 160\n input_W = 160\n input_D = 80\n \n transforms = [\n     torchio.transforms.ToCanonical(),\n     torchio.transforms.Resample(target_spacing=(1,1,1)),\n     torchio.transforms.RescaleIntensity(out_min_max=(0,1),percentiles=(0.5,99.5)),\n     torchio.transforms.ZNormalization(),\n     torchio.transforms.CropOrPad(target_shape=(input_D,input_H,input_W),padding_mode='constant',padding_fill=0,mask_name='mask'),\n ]\n transform = Compose(transforms)\n \n dataset = ImagesDataset(subjects, transform=transform)\n sample = dataset[0]\n </denchmark-code>\n \n I then checked the size of one of the images in the sample e.g. sample['t2']['data'].shape which returns torch.Size([1, 247, 345, 346]) whereas sample['mask']['data'].shape returns torch.Size([1, 80, 160, 160])\n What I expected to happen\n Both the image and mask have the same size\n What actually happened\n The sizes are different.\n \n In the crop and pad function (<denchmark-link:https://github.com/fepegar/torchio/blob/master/torchio/transforms/preprocessing/spatial/crop_or_pad.py#L224-L225>here</denchmark-link>\n ) these lines should probably be changed\n <denchmark-code>        padding_params = tuple(padding.tolist()) if padding.any() else None\n         cropping_params = tuple(cropping.tolist()) if padding.any() else None\n </denchmark-code>\n \n should be\n <denchmark-code>        padding_params = tuple(padding.tolist()) if padding.any() else None\n         cropping_params = tuple(cropping.tolist()) if cropping.any() else None\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "nwschurink", "commentT": "2020-04-08T10:19:08Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/nwschurink>@nwschurink</denchmark-link>\n . Thanks for reporting. That's obviously me pasting the previous line and messing up. I'll fix that in a sec.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "nwschurink", "commentT": "2020-04-08T11:00:40Z", "comment_text": "\n \t\tI haven't been able to reproduce your issue with this code:\n from torchio import Image, Subject, ImagesDataset, INTENSITY, LABEL, DATA\n from torchio.transforms import CropOrPad\n \n subject = Subject(\n     t1=Image('/tmp/t1.nii.gz', INTENSITY),\n     label=Image('/tmp/eyes.nrrd', LABEL),\n )\n transform = CropOrPad((79, 160, 160), mask_name='label')\n dataset = ImagesDataset([subject], transform=transform)\n sample = dataset[0]\n \n for key in sample:\n     print(sample[key][DATA].shape)\n \n dataset.save_sample(\n     sample,\n     dict(t1='/tmp/t1_crop.nii.gz', label='/tmp/eyes_crop.nii.gz'),\n )\n Output:\n torch.Size([1, 80, 160, 160])\n torch.Size([1, 80, 160, 160])\n The shapes are wrong (as I have reported in <denchmark-link:https://github.com/fepegar/torchio/pull/119>#119</denchmark-link>\n ), but consistent. Can you share a minimal working example and, if possible, some data? You can send it by email if you like.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "nwschurink", "commentT": "2020-04-08T12:06:23Z", "comment_text": "\n \t\tI think the reason why this happens is related to <denchmark-link:https://github.com/fepegar/torchio/issues/118>issue 118</denchmark-link>\n  and probably can be reproduced by changing the field of view of the mask to its bounding box (before loading it to Subject, e.g. your 'eyes.nrrd').\n The reason for this is that when the field of view of the mask and image are not the same it is possible that padding.any() evaluates to None for the T1 image (when the new crop falls within the field of view of the T1 scan). The result of this is that in the current code tuple(cropping.tolist()) is not assigned to cropping_params because padding returns None, whereas for the mask this line does get executed since the mask apparently needs padding and thus padding.any() is not empty.\n I can check if i can make a minimum working example\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "nwschurink", "commentT": "2020-04-08T12:13:57Z", "comment_text": "\n \t\t\n The reason for this is that when the field of view of the mask and image are not the same\n \n Do you mean the shapes are different? Maybe I misunderstood, but that should be checked in\n \n \n \n torchio/torchio/transforms/preprocessing/spatial/crop_or_pad.py\n \n \n         Lines 97 to 106\n       in\n       992ab56\n \n \n \n \n \n \n  @staticmethod \n \n \n \n  def _get_sample_shape(sample: dict) -> TypeShape: \n \n \n \n  \"\"\"Return the shape of the first image in the sample.\"\"\" \n \n \n \n  check_consistent_shape(sample) \n \n \n \n  for image_dict in sample.values(): \n \n \n \n  if not is_image_dict(image_dict): \n \n \n \n  continue \n \n \n \n  data = image_dict[DATA].shape[1:]  # remove channels dimension \n \n \n \n  break \n \n \n \n  return data \n \n \n \n \n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "nwschurink", "commentT": "2020-04-08T12:19:33Z", "comment_text": "\n \t\tAh, ok then I think there must be something going wrong in the check_consistent_shape check.\n I just checked the input size of my images. My T2 image has size (320,320,36) and my mask has size (18,22,6) (i.e. it only contains the bounding box of the segmentation, but is in the same frame of reference)\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "nwschurink", "commentT": "2020-04-08T12:36:49Z", "comment_text": "\n \t\tHmm, it's weird when I run check_consistent_shape() on my sample subject it returns a Value Error because of inconsistent shapes. So the test should be working\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "nwschurink", "commentT": "2020-04-08T12:42:09Z", "comment_text": "\n \t\tAh ok I've found out why the check is not working. The shape check is only performed when doing a center crop (e.g  ) (<denchmark-link:https://github.com/fepegar/torchio/blob/992ab56cef58f6e5dd9480da1f9b77b6cce1ca9d/torchio/transforms/preprocessing/spatial/crop_or_pad.py#L161>here</denchmark-link>\n ). However, the check is not performed when performing a crop on the mask's center (e.g. )\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "nwschurink", "commentT": "2020-04-08T12:46:01Z", "comment_text": "\n \t\tGood catch!\n <denchmark-link:https://github.com/GReguig>@GReguig</denchmark-link>\n  could you please look into this?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "nwschurink", "commentT": "2020-04-08T12:47:47Z", "comment_text": "\n \t\tOk, I will give it a look\n \t\t"}}}, "commit": {"commit_id": "f22fd20198590b8a13b327e3d306fbeeca0e8046", "commit_author": "Fernando P\u00e9rez-Garc\u00eda", "commitT": "2020-04-08 15:39:12+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 9, "file_old_name": "tests\\transforms\\preprocessing\\test_crop_pad.py", "file_new_name": "tests\\transforms\\preprocessing\\test_crop_pad.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "45,46,47", "deleted_lines": "42,43", "method_info": {"method_name": "test_shape_right", "method_params": "self", "method_startline": "41", "method_endline": "47"}}, "hunk_1": {"Ismethod": 1, "added_lines": "49,50,51,52,53,54,55", "deleted_lines": null, "method_info": {"method_name": "test_only_pad", "method_params": "self", "method_startline": "49", "method_endline": "55"}}, "hunk_2": {"Ismethod": 1, "added_lines": "37,38,39", "deleted_lines": "35,36", "method_info": {"method_name": "test_different_shape", "method_params": "self", "method_startline": "32", "method_endline": "39"}}, "hunk_3": {"Ismethod": 1, "added_lines": "80,81,82", "deleted_lines": null, "method_info": {"method_name": "test_shape_one", "method_params": "self", "method_startline": "77", "method_endline": "82"}}, "hunk_4": {"Ismethod": 1, "added_lines": "121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139", "deleted_lines": null, "method_info": {"method_name": "test_mask_only_crop", "method_params": "self", "method_startline": "121", "method_endline": "139"}}, "hunk_5": {"Ismethod": 1, "added_lines": "95", "deleted_lines": null, "method_info": {"method_name": "test_empty_mask", "method_params": "self", "method_startline": "93", "method_endline": "99"}}, "hunk_6": {"Ismethod": 1, "added_lines": "57,58,59,60,61,62,63", "deleted_lines": "60,61", "method_info": {"method_name": "test_only_crop", "method_params": "self", "method_startline": "57", "method_endline": "63"}}, "hunk_7": {"Ismethod": 1, "added_lines": "27,28,29,30", "deleted_lines": "27,28", "method_info": {"method_name": "test_no_changes_mask", "method_params": "self", "method_startline": "19", "method_endline": "30"}}, "hunk_8": {"Ismethod": 1, "added_lines": "101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119", "deleted_lines": null, "method_info": {"method_name": "test_mask_only_pad", "method_params": "self", "method_startline": "101", "method_endline": "119"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "torchio\\transforms\\preprocessing\\spatial\\crop_or_pad.py", "file_new_name": "torchio\\transforms\\preprocessing\\spatial\\crop_or_pad.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "194,210,213,225", "deleted_lines": "194,210,213,225"}}}}}}