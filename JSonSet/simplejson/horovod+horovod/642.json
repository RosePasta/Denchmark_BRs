{"BR": {"BR_id": "642", "BR_author": "jeff-engineml", "BRopenT": "2018-11-22T01:25:10Z", "BRcloseT": "2018-11-22T21:17:03Z", "BR_text": {"BRsummary": "Horovod hangs on shutdown when a rank crashes", "BRdescription": "\n <denchmark-h:h1>Environment</denchmark-h>\n \n MPI Versions: 3.0.0, 3.1.2, & 4.0.0\n Pytorch 0.4.1 & Tensorflow 1.8.0\n Python 2.7\n <denchmark-h:h1>Minimal Example</denchmark-h>\n \n from __future__ import print_function\n \n import atexit\n import sys\n import time\n try:\n   import horovod.torch as hvd\n except ImportError:\n   import horovod.tensorflow as hvd\n \n if __name__ == '__main__':\n   print('initializing')\n   hvd.init()\n   # Uncomment this to achieve the expected behavior\n   # atexit._exithandlers = []\n   time.sleep(3)\n   print('initialized')\n   if hvd.rank() == 0:\n     time.sleep(10)\n     print('exiting!')\n     sys.exit(1)\n   else:\n     print('Sleeping for', sys.argv[1])\n     time.sleep(int(sys.argv[1]))\n     print('done')\n <denchmark-h:h2>Behavior</denchmark-h>\n \n After rank 0 exits, rank 1 continues to sleep. When rank 1 finishes sleeping, it prints done and mpi exits with an error.\n $ mpirun -mca btl ^tcp -np 2 python sleep.py 50\n initializing\n initializing\n initialized\n Sleeping for 30\n initialized\n exiting!\n done\n --------------------------------------------------------------------------\n Primary job  terminated normally, but 1 process returned\n a non-zero exit code. Per user-direction, the job has been aborted.\n --------------------------------------------------------------------------\n --------------------------------------------------------------------------\n mpirun.real detected that one or more processes exited with non-zero status, thus causing\n the job to be terminated. The first process to do so was:\n \n   Process name: [[39251,1],0]\n   Exit code:    1\n --------------------------------------------------------------------------\n <denchmark-h:h2>Expected Behavior</denchmark-h>\n \n When rank 0 crashes it should shut down all mpi processes. Rank 1 should never print done. This can be achieved by uncommenting the atexit handler in the above example.\n $ mpirun -mca btl ^tcp -np 2 python sleep.py 50\n initializing\n initializing\n initialized\n Sleeping for 50\n initialized\n exiting!\n -------------------------------------------------------\n Primary job  terminated normally, but 1 process returned\n a non-zero exit code. Per user-direction, the job has been aborted.\n -------------------------------------------------------\n --------------------------------------------------------------------------\n mpirun.real detected that one or more processes exited with non-zero status, thus causing\n the job to be terminated. The first process to do so was:\n \n   Process name: [[42321,1],0]\n   Exit code:    1\n --------------------------------------------------------------------------\n <denchmark-h:h2>Gdb Backtrace</denchmark-h>\n \n This is the backtrace on the rank 0 process after rank 0 has exited and while rank 1 is sleeping. It looks like ompi_mpi_finalize polling for some event, but it is hard to tell.\n <denchmark-code>(gdb) bt\n #0  0x00007f118e20430d in nanosleep () at ../sysdeps/unix/syscall-template.S:84\n #1  0x00007f118e235d94 in usleep (useconds=<optimized out>) at ../sysdeps/posix/usleep.c:32\n #2  0x00007f114abb9ea7 in ompi_mpi_finalize () from /usr/local/lib/libmpi.so.40\n #3  0x00007f114aed81ef in horovod::common::horovod_shutdown () at /tmp/pip-install-SZ9jbr/horovod/horovod/common/operations.cc:1981\n #4  0x00007f118d3e9e40 in ffi_call_unix64 () from /usr/lib/x86_64-linux-gnu/libffi.so.6\n #5  0x00007f118d3e98ab in ffi_call () from /usr/lib/x86_64-linux-gnu/libffi.so.6\n #6  0x00007f118d5f93df in _ctypes_callproc () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so\n #7  0x00007f118d5fdd82 in ?? () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so\n #8  0x00000000004c166d in PyEval_EvalFrameEx ()\n #9  0x00000000004b9b66 in PyEval_EvalCodeEx ()\n #10 0x00000000004d57a3 in ?? ()\n #11 0x00000000004a587e in PyObject_Call ()\n #12 0x00000000004be51e in PyEval_EvalFrameEx ()\n #13 0x00000000004b9b66 in PyEval_EvalCodeEx ()\n #14 0x00000000004d5669 in ?? ()\n #15 0x00000000004a587e in PyObject_Call ()\n #16 0x00000000004c5f3d in PyEval_CallObjectWithKeywords ()\n #17 0x00000000004351ad in ?? ()\n #18 0x000000000051ea38 in Py_Exit ()\n #19 0x000000000051bfd7 in ?? ()\n #20 0x000000000051b8fd in PyErr_PrintEx ()\n #21 0x0000000000430c25 in ?? ()\n #22 0x00000000004938ce in Py_Main ()\n #23 0x00007f118e158830 in __libc_start_main (main=0x493370 <main>, argc=3, argv=0x7ffd289908b8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7ffd289908a8) at ../csu/libc-start.c:291\n #24 0x0000000000493299 in _start ()\n </denchmark-code>\n \n <denchmark-h:h2>Python Backtrace</denchmark-h>\n \n <denchmark-code>Stack for thread 139999936075520\n   File \"/usr/lib/python2.7/threading.py\", line 774, in __bootstrap\n     self.__bootstrap_inner()\n   File \"/usr/lib/python2.7/threading.py\", line 801, in __bootstrap_inner\n     self.run()\n   File \"<string>\", line 167, in run\n   File \"/usr/lib/python2.7/code.py\", line 243, in interact\n     more = self.push(line)\n   File \"/usr/lib/python2.7/code.py\", line 265, in push\n     more = self.runsource(source, self.filename)\n   File \"/usr/lib/python2.7/code.py\", line 87, in runsource\n     self.runcode(code)\n   File \"/usr/lib/python2.7/code.py\", line 103, in runcode\n     exec code in self.locals\n   File \"<console>\", line 3, in <module>\n \n Stack for thread 140000023533312\n   File \"/usr/lib/python2.7/atexit.py\", line 24, in _run_exitfuncs\n     func(*targs, **kargs)\n   File \"/usr/local/lib/python2.7/dist-packages/horovod/common/__init__.py\", line 88, in shutdown\n     return self.MPI_LIB_CTYPES.horovod_shutdown()\n </denchmark-code>\n \n Is this the expected behavior?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jeff-engineml", "commentT": "2018-11-22T05:07:25Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jeff-engineml>@jeff-engineml</denchmark-link>\n , thanks for the report!  No, it's a bug.  Started <denchmark-link:https://github.com/horovod/horovod/pull/644>#644</denchmark-link>\n  with a fix.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jeff-engineml", "commentT": "2018-11-22T06:25:09Z", "comment_text": "\n \t\tNo problem. Let me know if you\u2019d like me to test\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jeff-engineml", "commentT": "2018-11-22T06:27:00Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jeff-engineml>@jeff-engineml</denchmark-link>\n , that'd be great!  The fix is in <denchmark-link:https://github.com/horovod/horovod/pull/644>#644</denchmark-link>\n , I'm checking with <denchmark-link:https://github.com/vloncar>@vloncar</denchmark-link>\n  if he remembers why we moved that code into a separate function in the first place.\n \t\t"}}}, "commit": {"commit_id": "9269b3ea3bc4dae115942cc89f110601a6a225dc", "commit_author": "Alex Sergeev", "commitT": "2018-11-22 13:17:03-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "horovod\\common\\operations.cc", "file_new_name": "horovod\\common\\operations.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1663,1664,1665,1666,1667,1668,1669,1670,1671,1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1690,1691,1692,1693,1694,1695,1696", "deleted_lines": null, "method_info": {"method_name": "horovod::common::BackgroundThreadLoop", "method_params": "state", "method_startline": "1435", "method_endline": "1697"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1694,1695,1696", "deleted_lines": "1906", "method_info": {"method_name": "horovod::common::RunLoopOnce", "method_params": "state,is_coordinator", "method_startline": "1694", "method_endline": "1907"}}, "hunk_2": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988", "method_info": {"method_name": "horovod::common::horovod_shutdown", "method_params": "", "method_startline": "1951", "method_endline": "1989"}}}}}}}