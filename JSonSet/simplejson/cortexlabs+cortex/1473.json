{"BR": {"BR_id": "1473", "BR_author": "lapaniku", "BRopenT": "2020-10-22T09:46:07Z", "BRcloseT": "2020-10-27T01:48:29Z", "BR_text": {"BRsummary": "Can't remove a job with one worker using BatchAPI and DELETE request", "BRdescription": "\n <denchmark-h:h4>Version</denchmark-h>\n \n cli version: 0.20.0\n <denchmark-h:h4>Description</denchmark-h>\n \n I've started a job with 1 worker and I can successfully get its status:\n $ cortex get imagesearch-batch 69bfbc4539100651 --env aws\n <denchmark-code>job id: 69bfbc4539100651\n status: running\n \n start time: 22 Oct 2020 08:38:57 UTC\n end time:   -\n duration:   52m47s\n \n batch stats\n total   succeeded   failed   avg time per batch\n 100     5           0        10m8.08s\n \n worker stats\n requested   running   succeeded\n 1           1         0\n \n job endpoint: https://hv5geqzdo9.execute-api.us-east-1.amazonaws.com/imagesearch-batch/69bfbc4539100651\n \n job configuration\n {\n   \"job_id\": \"69bfbc4539100651\",\n   \"api_name\": \"imagesearch-batch\",\n   \"workers\": 1,\n   \"config\": {\n     \"dest_s3_dir\": \"s3://...\"\n   },\n   \"api_id\": \"69bfbc5ab59b0d80--b2c011c906d3de3174508d257cd93b84\",\n   \"spec_id\": \"b2c011c906d3de3174508d257cd93b84\",\n   \"predictor_id\": \"6bdcd409fa472756e2a38468565cbc57325c6a323ca935da22dbd541bae05b1\",\n   \"sqs_url\": \"https://sqs.us-east-1.amazonaws.com/.../1ee11af4ed-imagesearch-batch-69bfbc4539100651.fifo\",\n   \"total_batch_count\": 100,\n   \"start_time\": \"2020-10-22T08:38:57.025302536Z\"\n } \n </denchmark-code>\n \n Though when I tried to request :\n curl -X DELETE https://hv5geqzdo9.execute-api.us-east-1.amazonaws.com/imagesearch-batch/69bfbc4539100651\n The result is:\n {\"message\":\"Not Found\"}\n Which is a bit strange as was able to delete jobs with several workers before.\n <denchmark-h:h4>Configuration</denchmark-h>\n \n <denchmark-code>- name: imagesearch-batch\n   kind: BatchAPI\n   predictor:\n     type: python\n     path: predictor.py\n   compute:\n     cpu: 1\n </denchmark-code>\n \n <denchmark-h:h4>Steps to reproduce</denchmark-h>\n \n \n Create a cluster with t3.small instances and default parameters min:1-max:5\n Submit a job with several batches but 1 worker so it's going to last for a while\n Try to delete this job using curl -X DELETE and API URL + jobib\n \n <denchmark-h:h4>Expected behavior</denchmark-h>\n \n The corresponding job should be successfully stopped.\n <denchmark-h:h4>Actual behavior</denchmark-h>\n \n Job continues to run after the DELETE request.\n <denchmark-h:h4>Stack traces</denchmark-h>\n \n No issues with the job running:\n 2020-10-22 08:39:23.978178:cortex:pid-140:INFO:loading the predictor from predictor.py\n 2020-10-22 08:39:27.785006:cortex:pid-140:INFO:polling for batches...\n 2020-10-22 08:39:27.864598:cortex:pid-140:INFO:processing batch 4b320cba-a335-40f6-ba50-e301e96f4859\n 2020-10-22 08:49:37.230117:cortex:pid-140:INFO:processing batch 0a3df022-6aa0-4d77-acdc-d2c11f7229c1\n 2020-10-22 08:59:27.638303:cortex:pid-140:INFO:processing batch c573396b-00d6-4055-a870-9c74e669e904\n 2020-10-22 09:09:57.368275:cortex:pid-140:INFO:processing batch ab729014-459f-4604-8c3a-582cfd5fe089\n 2020-10-22 09:20:05.450738:cortex:pid-140:INFO:processing batch ef24b433-661c-4507-86f0-449dc01ac701\n 2020-10-22 09:30:08.732410:cortex:pid-140:INFO:processing batch ea7dbff5-f3e9-4db6-93e0-1dd5e890e2d6\n 2020-10-22 09:41:09.451085:cortex:pid-140:INFO:processing batch f926de1a-500a-45f2-9253-7c886fcd448f\n <denchmark-h:h4>Suggested solution</denchmark-h>\n \n Might be connected with using only 1 worker as I was able to successfully delete jobs with 5 workers before.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "lapaniku", "commentT": "2020-10-23T15:34:13Z", "comment_text": "\n \t\tThanks for bringing this to our attention. After investigating this issue, we believe that this bug could be caused by some non-deterministic behaviour during the API Gateway route setup. We are continuing to investigate this issue. In the meantime, you could try to deploy your BatchAPI by explicitly disabling API Gateway:\n <denchmark-code>- name: api:\n   kind: BatchAPI\n   networking:\n     api_gateway: none # the default is public\n </denchmark-code>\n \n \t\t"}}}, "commit": {"commit_id": "1cd918e82775c5a2bc5f7bf11c1cc11dbf64660b", "commit_author": "Vishal Bollu", "commitT": "2020-10-26 21:48:28-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "cli\\cluster\\delete.go", "file_new_name": "cli\\cluster\\delete.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "82", "deleted_lines": "82", "method_info": {"method_name": "StopJob", "method_params": "OperatorConfig,string,string", "method_startline": "76", "method_endline": "94"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "cli\\cluster\\get.go", "file_new_name": "cli\\cluster\\get.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "55,56", "deleted_lines": "55,56", "method_info": {"method_name": "GetJob", "method_params": "OperatorConfig,string,string", "method_startline": "54", "method_endline": "67"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "cli\\cluster\\lib_http_client.go", "file_new_name": "cli\\cluster\\lib_http_client.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "162", "deleted_lines": "162", "method_info": {"method_name": "operatorRequest", "method_params": "OperatorConfig,string,string,Reader,string", "method_startline": "162", "method_endline": "177"}}, "hunk_1": {"Ismethod": 1, "added_lines": "72", "deleted_lines": "72", "method_info": {"method_name": "HTTPPostJSON", "method_params": "OperatorConfig,string,byte,string", "method_startline": "70", "method_endline": "78"}}, "hunk_2": {"Ismethod": 1, "added_lines": "162", "deleted_lines": "162", "method_info": {"method_name": "operatorRequest", "method_params": "OperatorConfig,string,string,Reader,string", "method_startline": "162", "method_endline": "177"}}, "hunk_3": {"Ismethod": 1, "added_lines": "127", "deleted_lines": "127", "method_info": {"method_name": "HTTPUpload", "method_params": "OperatorConfig,string,HTTPUploadInput,string", "method_startline": "101", "method_endline": "134"}}, "hunk_4": {"Ismethod": 1, "added_lines": "89", "deleted_lines": "89", "method_info": {"method_name": "HTTPDelete", "method_params": "OperatorConfig,string,string", "method_startline": "88", "method_endline": "94"}}, "hunk_5": {"Ismethod": 1, "added_lines": "81", "deleted_lines": "81", "method_info": {"method_name": "HTTPPostNoBody", "method_params": "OperatorConfig,string,string", "method_startline": "80", "method_endline": "86"}}, "hunk_6": {"Ismethod": 1, "added_lines": "55", "deleted_lines": "55", "method_info": {"method_name": "HTTPGet", "method_params": "OperatorConfig,string,string", "method_startline": "54", "method_endline": "60"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "cli\\cluster\\logs.go", "file_new_name": "cli\\cluster\\logs.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "37,38", "deleted_lines": null, "method_info": {"method_name": "StreamLogs", "method_params": "OperatorConfig,string", "method_startline": "36", "method_endline": "38"}}, "hunk_1": {"Ismethod": 1, "added_lines": "44,48", "deleted_lines": null, "method_info": {"method_name": "streamLogs", "method_params": "OperatorConfig,string,string", "method_startline": "44", "method_endline": "98"}}, "hunk_2": {"Ismethod": 1, "added_lines": "40,41,42", "deleted_lines": "40", "method_info": {"method_name": "StreamJobLogs", "method_params": "OperatorConfig,string,string", "method_startline": "40", "method_endline": "42"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "cli\\cmd\\logs.go", "file_new_name": "cli\\cmd\\logs.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "56,57,58,59,60,61,62,63,64,65,66", "deleted_lines": "57,58,59,60", "method_info": {"method_name": "", "method_params": "", "method_startline": "41", "method_endline": "77"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\deployments\\batch-api\\endpoints.md", "file_new_name": "docs\\deployments\\batch-api\\endpoints.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "36,77,116,149,191", "deleted_lines": "36,77,116,149,191"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "examples\\batch\\image-classifier\\README.md", "file_new_name": "examples\\batch\\image-classifier\\README.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "237,548", "deleted_lines": "237,548"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\endpoints\\get_job.go", "file_new_name": "pkg\\operator\\endpoints\\get_job.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "35,36,37,38,39", "deleted_lines": "35", "method_info": {"method_name": "GetJob", "method_params": "ResponseWriter,Request", "method_startline": "32", "method_endline": "78"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\endpoints\\logs.go", "file_new_name": "pkg\\operator\\endpoints\\logs.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "31,32,33,34,35,36", "deleted_lines": null, "method_info": {"method_name": "ReadLogs", "method_params": "ResponseWriter,Request", "method_startline": "29", "method_endline": "61"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\endpoints\\logs_job.go", "file_new_name": "pkg\\operator\\endpoints\\logs_job.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32,33,34,35,36", "deleted_lines": "32", "method_info": {"method_name": "ReadJobLogs", "method_params": "ResponseWriter,Request", "method_startline": "30", "method_endline": "60"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\endpoints\\stop_job.go", "file_new_name": "pkg\\operator\\endpoints\\stop_job.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "32,33,34,35,36,38", "deleted_lines": "32,34", "method_info": {"method_name": "StopJob", "method_params": "ResponseWriter,Request", "method_startline": "29", "method_endline": "47"}}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\main.go", "file_new_name": "pkg\\operator\\main.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "74,75", "deleted_lines": "74,75,76", "method_info": {"method_name": "main", "method_params": "", "method_startline": "39", "method_endline": "94"}}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 11, "file_old_name": "pkg\\operator\\operator\\gateway.go", "file_new_name": "pkg\\operator\\operator\\gateway.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "77,88,89,90,91,93,94,95,96,97,98,102,103", "deleted_lines": "78,79,80,81,84,85,86,87,88,89,92,93,94,95,96,97,99,100,101,102,103,104", "method_info": {"method_name": "RemoveAPIFromAPIGateway", "method_params": "string,APIGatewayType", "method_startline": "77", "method_endline": "104"}}, "hunk_1": {"Ismethod": 1, "added_lines": "158,161,172", "deleted_lines": "156,167,171,179,182", "method_info": {"method_name": "UpdateAPIGateway", "method_params": "string,APIGatewayType,string,APIGatewayType,bool", "method_startline": "151", "method_endline": "187"}}, "hunk_2": {"Ismethod": 1, "added_lines": "29,40,41,42,43,44,45,46,48,49,51,53,55,56,57,58,61,63,64,65,66,68,69,70,73,74", "deleted_lines": "30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,68,69,72,74,75", "method_info": {"method_name": "AddAPIToAPIGateway", "method_params": "string,APIGatewayType", "method_startline": "29", "method_endline": "75"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "207,218", "method_info": {"method_name": "UpdateAPIGatewayK8s", "method_params": "VirtualService,API,bool", "method_startline": "207", "method_endline": "219"}}, "hunk_4": {"Ismethod": 1, "added_lines": "161,172", "deleted_lines": "167,171", "method_info": {"method_name": "UpdateAPIGatewayK8s", "method_params": "VirtualService,API", "method_startline": "161", "method_endline": "173"}}, "hunk_5": {"Ismethod": 1, "added_lines": "143,158", "deleted_lines": "143,144,148,156", "method_info": {"method_name": "RemoveAPIFromAPIGatewayK8s", "method_params": "VirtualService", "method_startline": "143", "method_endline": "159"}}, "hunk_6": {"Ismethod": 1, "added_lines": "40,41,42,43,44,45,46,48,49,51,53,55,56,57", "deleted_lines": "35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57", "method_info": {"method_name": "getRouteToIntegrationMapping", "method_params": "string,bool", "method_startline": "35", "method_endline": "57"}}, "hunk_7": {"Ismethod": 1, "added_lines": null, "deleted_lines": "189,204", "method_info": {"method_name": "RemoveAPIFromAPIGatewayK8s", "method_params": "VirtualService,bool", "method_startline": "189", "method_endline": "205"}}, "hunk_8": {"Ismethod": 1, "added_lines": "61,63,64,65,66,68,69,70,73,74,77,88,89,90,91,93,94,95,96,97,98,102,103", "deleted_lines": "59,68,69,72,74,75,76,78,79,80,81,84,85,86,87,88,89,92,93,94,95,96,97,99,100,101,102,103,104,105,107,108,109,110,111,114", "method_info": {"method_name": "AddAPIToAPIGateway", "method_params": "string,APIGatewayType,bool", "method_startline": "59", "method_endline": "115"}}, "hunk_9": {"Ismethod": 1, "added_lines": "121,125,133,136,143", "deleted_lines": "117,126,127,130,131,132,133,134,135,136,138,139,140,141,142,143,144,148", "method_info": {"method_name": "RemoveAPIFromAPIGateway", "method_params": "string,APIGatewayType,bool", "method_startline": "117", "method_endline": "149"}}, "hunk_10": {"Ismethod": 1, "added_lines": "121,125,133,136", "deleted_lines": "107,108,109,110,111,114,117,126,127,130,131,132,133,134,135,136,138,139,140,141", "method_info": {"method_name": "UpdateAPIGateway", "method_params": "string,APIGatewayType,string,APIGatewayType", "method_startline": "106", "method_endline": "141"}}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\batchapi\\api.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\api.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "62,65,91", "deleted_lines": "62,65,91", "method_info": {"method_name": "UpdateAPI", "method_params": "API,string", "method_startline": "39", "method_endline": "99"}}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pkg\\operator\\resources\\batchapi\\enqueue.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\enqueue.go", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "252,259,295", "deleted_lines": "252,259,295"}}}, "file_15": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\batchapi\\manage_resources_cron.go", "file_new_name": "pkg\\operator\\resources\\batchapi\\manage_resources_cron.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "93,94,95,96,97,103", "deleted_lines": null, "method_info": {"method_name": "ManageJobResources", "method_params": "", "method_startline": "45", "method_endline": "199"}}}}, "file_16": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\realtimeapi\\api.go", "file_new_name": "pkg\\operator\\resources\\realtimeapi\\api.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "75,111", "deleted_lines": "75,111", "method_info": {"method_name": "UpdateAPI", "method_params": "API,string,bool", "method_startline": "44", "method_endline": "126"}}}}, "file_17": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\operator\\resources\\trafficsplitter\\api.go", "file_new_name": "pkg\\operator\\resources\\trafficsplitter\\api.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "55,76", "deleted_lines": "55,76", "method_info": {"method_name": "UpdateAPI", "method_params": "API,bool", "method_startline": "34", "method_endline": "83"}}}}}}}