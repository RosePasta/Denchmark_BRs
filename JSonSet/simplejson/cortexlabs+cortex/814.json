{"BR": {"BR_id": "814", "BR_author": "deliahu", "BRopenT": "2020-02-14T17:14:01Z", "BRcloseT": "2020-11-10T19:09:23Z", "BR_text": {"BRsummary": "Intermittent failed requests during rolling updates", "BRdescription": "\n <denchmark-h:h4>Description</denchmark-h>\n \n As old pods spin down during a rolling update, some requests return 503. Istio is hiding the more detailed error message - when bypassing Istio with service of type: loadbalancer, the error is:\n <denchmark-code>Post http://a2b34b2aa4ec411eaab8a0a465d27bdf-e1fddee29350e253.elb.us-west-2.amazonaws.com/predict: read tcp 172.31.1.222:42654->54.71.144.207:80: read: connection reset by peer\n </denchmark-code>\n \n <denchmark-h:h4>Reproduction</denchmark-h>\n \n Create an iris deployment with min and max of e.g. 2 replicas. Run dev/load.go with at least 100 concurrent threads and no delays. Perform a rolling update, and watch for 503 errors (or the connection reset by peer error if using the load balancer service) as the old pods are terminating.\n <denchmark-h:h4>Relevant info</denchmark-h>\n \n \n https://stackoverflow.com/questions/57727457/why-there-is-downtime-while-rolling-update-a-deployment-or-even-scaling-down-a-r\n \n <denchmark-h:h4>Possibly related issue</denchmark-h>\n \n Also, <denchmark-link:https://github.com/vishalbollu>@vishalbollu</denchmark-link>\n  reported that during large scale ups that require many new nodes (e.g. 1 -> 200 nodes), some 503 errors are also seen. This may or may not be the same root cause. A separate ticket should be created to track this if a fix for this issue doesn't resolve it.\n <denchmark-h:h4>Possibly related issue 2</denchmark-h>\n \n It seems that deleting an API, deploying it again, waiting for the previous pod to terminate, and then creating a high volume of parallel requests also results in 503 errors. See the <denchmark-link:https://github.com/cortexlabs/cortex/tree/networking-debugging>networking-debugging</denchmark-link>\n  branch.\n \t"}, "comments": {}}, "commit": {"commit_id": "c8da08542e0978c0c2f9c94694bf441092aaafe6", "commit_author": "Robert Lucian Chiriac", "commitT": "2020-11-06 22:53:53+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "cli\\local\\docker_spec.go", "file_new_name": "cli\\local\\docker_spec.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "94", "deleted_lines": "95,96,97", "method_info": {"method_name": "getAPIEnv", "method_params": "API,Client", "method_startline": "75", "method_endline": "116"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "dev\\versions.md", "file_new_name": "dev\\versions.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "175,176,177,178,179,180,181,182,183,184,185,186", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "examples\\sklearn\\iris-classifier\\cortex.yaml", "file_new_name": "examples\\sklearn\\iris-classifier\\cortex.yaml", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "15", "deleted_lines": "15"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "examples\\sklearn\\iris-classifier\\requirements.txt", "file_new_name": "examples\\sklearn\\iris-classifier\\requirements.txt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "2", "deleted_lines": null}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\neuron-rtd\\Dockerfile", "file_new_name": "images\\neuron-rtd\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,17", "deleted_lines": "16"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\onnx-predictor-cpu\\Dockerfile", "file_new_name": "images\\onnx-predictor-cpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12,15,16,17,18,19,77,78,79", "deleted_lines": "71"}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\onnx-predictor-gpu\\Dockerfile", "file_new_name": "images\\onnx-predictor-gpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12,15,16,17,18,19,77,78,79", "deleted_lines": "71"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\python-predictor-cpu\\Dockerfile", "file_new_name": "images\\python-predictor-cpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12,15,16,17,18,19,97,98,99", "deleted_lines": "91"}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\python-predictor-gpu\\Dockerfile", "file_new_name": "images\\python-predictor-gpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "14,17,18,19,20,21,102,103,104", "deleted_lines": "96"}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\python-predictor-inf\\Dockerfile", "file_new_name": "images\\python-predictor-inf\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "13,14,15,27,107,108,109", "deleted_lines": "103"}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\tensorflow-predictor\\Dockerfile", "file_new_name": "images\\tensorflow-predictor\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "12,15,16,17,18,19,77,81,82,83", "deleted_lines": "71,75"}}}, "file_11": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\tensorflow-serving-cpu\\Dockerfile", "file_new_name": "images\\tensorflow-serving-cpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "3,4,5,6", "deleted_lines": null}}}, "file_12": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\tensorflow-serving-gpu\\Dockerfile", "file_new_name": "images\\tensorflow-serving-gpu\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "6", "deleted_lines": null}}}, "file_13": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "images\\tensorflow-serving-inf\\Dockerfile", "file_new_name": "images\\tensorflow-serving-inf\\Dockerfile", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "7", "deleted_lines": null}}}, "file_14": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "pkg\\operator\\operator\\k8s.go", "file_new_name": "pkg\\operator\\operator\\k8s.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "181", "deleted_lines": null, "method_info": {"method_name": "PythonPredictorContainers", "method_params": "API", "method_startline": "115", "method_endline": "195"}}, "hunk_1": {"Ismethod": 1, "added_lines": "324", "deleted_lines": null, "method_info": {"method_name": "ONNXPredictorContainers", "method_params": "API", "method_startline": "293", "method_endline": "338"}}, "hunk_2": {"Ismethod": 1, "added_lines": "695", "deleted_lines": null, "method_info": {"method_name": "tensorflowServingContainer", "method_params": "API,VolumeMount,ResourceRequirements", "method_startline": "631", "method_endline": "699"}}, "hunk_3": {"Ismethod": 1, "added_lines": null, "deleted_lines": "412,413,414,415,416,417,418,419,420", "method_info": {"method_name": "getEnvVars", "method_params": "API,string", "method_startline": "338", "method_endline": "547"}}, "hunk_4": {"Ismethod": 1, "added_lines": "807,808,809,810,811,812,813,814,815,816,817,818", "deleted_lines": null, "method_info": {"method_name": "waitAPIContainerToStop", "method_params": "Kind", "method_startline": "807", "method_endline": "818"}}, "hunk_5": {"Ismethod": 1, "added_lines": "270", "deleted_lines": null, "method_info": {"method_name": "TensorFlowPredictorContainers", "method_params": "API", "method_startline": "197", "method_endline": "291"}}, "hunk_6": {"Ismethod": 1, "added_lines": "792,793,794,795,796,797,798,799,800,801,802,803,804,805", "deleted_lines": null, "method_info": {"method_name": "nginxGracefulStopper", "method_params": "Kind", "method_startline": "792", "method_endline": "805"}}, "hunk_7": {"Ismethod": 1, "added_lines": "717", "deleted_lines": null, "method_info": {"method_name": "neuronRuntimeDaemonContainer", "method_params": "API,VolumeMount", "method_startline": "701", "method_endline": "729"}}}}, "file_15": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "pkg\\operator\\resources\\realtimeapi\\k8s_specs.go", "file_new_name": "pkg\\operator\\resources\\realtimeapi\\k8s_specs.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "129,130", "deleted_lines": "126", "method_info": {"method_name": "pythonAPISpec", "method_params": "API,Deployment", "method_startline": "96", "method_endline": "144"}}, "hunk_1": {"Ismethod": 1, "added_lines": "79,80", "deleted_lines": "77", "method_info": {"method_name": "tensorflowAPISpec", "method_params": "API,Deployment", "method_startline": "45", "method_endline": "94"}}, "hunk_2": {"Ismethod": 1, "added_lines": "182,183", "deleted_lines": "178", "method_info": {"method_name": "onnxAPISpec", "method_params": "API,Deployment", "method_startline": "146", "method_endline": "193"}}}}, "file_16": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\types\\spec\\validations.go", "file_new_name": "pkg\\types\\spec\\validations.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "402,403,404,405,406", "deleted_lines": "402,403,404", "method_info": {"method_name": "autoscalingValidation", "method_params": "ProviderType", "method_startline": "363", "method_endline": "470"}}}}, "file_17": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pkg\\workloads\\cortex\\lib\\util.py", "file_new_name": "pkg\\workloads\\cortex\\lib\\util.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "235,236,237,238,239,240,241,242,243,244,245,246", "deleted_lines": null, "method_info": {"method_name": "render_jinja_template", "method_params": "str,dict", "method_startline": "235", "method_endline": "246"}}}}, "file_18": {"file_change_type": "RENAME", "file_Nmethod": 0, "file_old_name": "pkg\\workloads\\cortex\\serve\\run.sh", "file_new_name": "pkg\\workloads\\cortex\\serve\\init\\bootloader.sh"}, "file_19": {"file_change_type": "RENAME", "file_Nmethod": 0, "file_old_name": "pkg\\workloads\\cortex\\serve\\start.py", "file_new_name": "pkg\\workloads\\cortex\\serve\\init\\script.py"}, "file_20": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "pkg\\workloads\\cortex\\serve\\nginx.conf.j2"}, "file_21": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "pkg\\workloads\\cortex\\serve\\poll\\readiness.sh"}, "file_22": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "pkg\\workloads\\cortex\\serve\\requirements.txt", "file_new_name": "pkg\\workloads\\cortex\\serve\\requirements.txt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "11", "deleted_lines": null}}}, "file_23": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\workloads\\cortex\\serve\\serve.py", "file_new_name": "pkg\\workloads\\cortex\\serve\\serve.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "71", "deleted_lines": null, "method_info": {"method_name": "startup", "method_params": "", "method_startline": "70", "method_endline": "72"}}, "hunk_1": {"Ismethod": 1, "added_lines": "82,83,84,85,86", "deleted_lines": "80", "method_info": {"method_name": "shutdown", "method_params": "", "method_startline": "76", "method_endline": "90"}}}}, "file_24": {"file_change_type": "RENAME", "file_Nmethod": 0, "file_old_name": "pkg\\workloads\\cortex\\serve\\batch.py", "file_new_name": "pkg\\workloads\\cortex\\serve\\start\\batch.py"}, "file_25": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "pkg\\workloads\\cortex\\serve\\start\\server.py"}}}}