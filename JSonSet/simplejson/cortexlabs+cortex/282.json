{"BR": {"BR_id": "282", "BR_author": "deliahu", "BRopenT": "2019-08-04T23:12:13Z", "BRcloseT": "2019-08-22T19:35:19Z", "BR_text": {"BRsummary": "Pods occasionally error on first attempt", "BRdescription": "\n : This seems to be resolved now, since switching to Istio CNI instead of init containers (<denchmark-link:https://github.com/cortexlabs/cortex/commit/065b2c09e6927ec6f22b82f3793a81be278966f7>065b2c0</denchmark-link>\n ) and/or since removing Istio sidecar containers (<denchmark-link:https://github.com/cortexlabs/cortex/pull/368>#368</denchmark-link>\n )\n Edit: API pods seem to not restart anymore, operator still does\n <denchmark-h:h3>Operator</denchmark-h>\n \n <denchmark-code>error: unable to authenticate with AWS: RequestError: send request failed\n caused by: Post https://sts.amazonaws.com/: dial tcp 52.46.134.192:443: connect: connection refused\n </denchmark-code>\n \n <denchmark-h:h3>API pods</denchmark-h>\n \n <denchmark-code>ERROR:cortex:error: key \"apps/iris/contexts/f4844a6a01df9bca63ec1524d35dd127687b94a2d62a7b0ffdd62060638133d.msgpack\" in bucket \"cortex-cluster-david\" could not be accessed; it may not exist, or you may not have suffienct permissions\n </denchmark-code>\n \n <denchmark-h:h3>API pods 2</denchmark-h>\n \n <denchmark-code>Traceback (most recent call last):\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connection.py\", line 160, in _new_conn\n     (self._dns_host, self.port), self.timeout, **extra_kw)\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/util/connection.py\", line 80, in create_connection\n     raise err\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/util/connection.py\", line 70, in create_connection\n     sock.connect(sa)\n ConnectionRefusedError: [Errno 111] Connection refused\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/httpsession.py\", line 262, in send\n     chunked=self._chunked(request.headers),\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connectionpool.py\", line 641, in urlopen\n     _stacktrace=sys.exc_info()[2])\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/util/retry.py\", line 344, in increment\n     raise six.reraise(type(error), error, _stacktrace)\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/packages/six.py\", line 686, in reraise\n     raise value\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connectionpool.py\", line 603, in urlopen\n     chunked=chunked)\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connectionpool.py\", line 344, in _make_request\n     self._validate_conn(conn)\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connectionpool.py\", line 843, in _validate_conn\n     conn.connect()\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connection.py\", line 316, in connect\n     conn = self._new_conn()\n   File \"/usr/local/lib/python3.5/dist-packages/urllib3/connection.py\", line 169, in _new_conn\n     self, \"Failed to establish a new connection: %s\" % e)\n urllib3.exceptions.NewConnectionError: <botocore.awsrequest.AWSHTTPSConnection object at 0x7f4d17afb278>: Failed to establish a new connection: [Errno 111] Connection refused\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n   File \"/src/cortex/lib/storage/s3.py\", line 173, in download_file\n     self.s3.download_file(self.bucket, key, local_path)\n   File \"/usr/local/lib/python3.5/dist-packages/boto3/s3/inject.py\", line 172, in download_file\n     extra_args=ExtraArgs, callback=Callback)\n   File \"/usr/local/lib/python3.5/dist-packages/boto3/s3/transfer.py\", line 307, in download_file\n     future.result()\n   File \"/usr/local/lib/python3.5/dist-packages/s3transfer/futures.py\", line 73, in result\n     return self._coordinator.result()\n   File \"/usr/local/lib/python3.5/dist-packages/s3transfer/futures.py\", line 233, in result\n     raise self._exception\n   File \"/usr/local/lib/python3.5/dist-packages/s3transfer/tasks.py\", line 255, in _main\n     self._submit(transfer_future=transfer_future, **kwargs)\n   File \"/usr/local/lib/python3.5/dist-packages/s3transfer/download.py\", line 353, in _submit\n     **transfer_future.meta.call_args.extra_args\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/client.py\", line 357, in _api_call\n     return self._make_api_call(operation_name, kwargs)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/client.py\", line 648, in _make_api_call\n     operation_model, request_dict, request_context)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/client.py\", line 667, in _make_request\n     return self._endpoint.make_request(operation_model, request_dict)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/endpoint.py\", line 102, in make_request\n     return self._send_request(request_dict, operation_model)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/endpoint.py\", line 137, in _send_request\n     success_response, exception):\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/endpoint.py\", line 231, in _needs_retry\n     caught_exception=caught_exception, request_dict=request_dict)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/hooks.py\", line 356, in emit\n     return self._emitter.emit(aliased_event_name, **kwargs)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/hooks.py\", line 228, in emit\n     return self._emit(event_name, kwargs)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/hooks.py\", line 211, in _emit\n     response = handler(**kwargs)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 183, in __call__\n     if self._checker(attempts, response, caught_exception):\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 251, in __call__\n     caught_exception)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 277, in _should_retry\n     return self._checker(attempt_number, response, caught_exception)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 317, in __call__\n     caught_exception)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 223, in __call__\n     attempt_number, caught_exception)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/retryhandler.py\", line 359, in _check_caught_exception\n     raise caught_exception\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/endpoint.py\", line 200, in _do_get_response\n     http_response = self._send(request)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/endpoint.py\", line 244, in _send\n     return self.http_session.send(request)\n   File \"/usr/local/lib/python3.5/dist-packages/botocore/httpsession.py\", line 282, in send\n     raise EndpointConnectionError(endpoint_url=request.url, error=e)\n botocore.exceptions.EndpointConnectionError: Could not connect to the endpoint URL: \"https://cortex-cluster-david.s3.amazonaws.com/apps/iris/contexts/32dfa4b0f76cf52654e15c3a19af7d5e0081b57620bd57d8a7dc62f49be3f81.msgpack\"\n \n The above exception was the direct cause of the following exception:\n \n Traceback (most recent call last):\n   File \"/src/cortex/tf_api/api.py\", line 561, in <module>\n     main()\n   File \"/src/cortex/tf_api/api.py\", line 557, in main\n     args.func(args)\n   File \"/src/cortex/tf_api/api.py\", line 443, in start\n     ctx = Context(s3_path=args.context, cache_dir=args.cache_dir, workload_id=args.workload_id)\n   File \"/src/cortex/lib/context.py\", line 56, in __init__\n     S3(bucket, client_config={}).download_file(key, local_ctx_path)\n   File \"/src/cortex/lib/storage/s3.py\", line 179, in download_file\n     ) from e\n cortex.lib.exceptions.CortexException: key \"apps/iris/contexts/32dfa4b0f76cf52654e15c3a19af7d5e0081b57620bd57d8a7dc62f49be3f81.msgpack\" in bucket \"cortex-cluster-david\" could not be accessed; it may not exist, or you may not have suffienct permissions\n </denchmark-code>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "6f11987480fb7bdb4b0be86a1f1813df44cf2a33", "commit_author": "Ivan Zhang", "commitT": "2019-08-12 21:04:50-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\operator\\workloads\\api_workload.go", "file_new_name": "pkg\\operator\\workloads\\api_workload.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "279,280,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302", "deleted_lines": "278", "method_info": {"method_name": "tfAPISpec", "method_params": "Context,API,string,int32", "method_startline": "227", "method_endline": "384"}}, "hunk_1": {"Ismethod": 1, "added_lines": "432,433,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453", "deleted_lines": "410", "method_info": {"method_name": "onnxAPISpec", "method_params": "Context,API,string,int32", "method_startline": "386", "method_endline": "501"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\workloads\\cortex\\onnx_serve\\api.py", "file_new_name": "pkg\\workloads\\cortex\\onnx_serve\\api.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "227,228,229,230,231,232,233", "deleted_lines": "233,234,235,236", "method_info": {"method_name": "start", "method_params": "args", "method_startline": "221", "method_endline": "255"}}, "hunk_1": {"Ismethod": 1, "added_lines": "271,272,273,274,275,276,277", "deleted_lines": null, "method_info": {"method_name": "main", "method_params": "", "method_startline": "258", "method_endline": "281"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "pkg\\workloads\\cortex\\tf_api\\api.py", "file_new_name": "pkg\\workloads\\cortex\\tf_api\\api.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "464,465,466,472,473,474,475,476,477", "deleted_lines": "481,482,483", "method_info": {"method_name": "start", "method_params": "args", "method_startline": "447", "method_endline": "546"}}, "hunk_1": {"Ismethod": 1, "added_lines": "565,566,567,568,569,570", "deleted_lines": null, "method_info": {"method_name": "main", "method_params": "", "method_startline": "549", "method_endline": "574"}}}}}}}