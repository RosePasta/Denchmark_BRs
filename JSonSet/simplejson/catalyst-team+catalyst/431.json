{"BR": {"BR_id": "431", "BR_author": "TezRomacH", "BRopenT": "2019-10-10T12:42:22Z", "BRcloseT": "2019-11-05T13:34:30Z", "BR_text": {"BRsummary": "Fix in BaseCheckpointCallback `_metrics` not only for the last stage but for all", "BRdescription": "\n \n Now the  file created by <denchmark-link:https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/callbacks/checkpoint.py#L13>BaseCheckpointCallback</denchmark-link>\n  stores only the latest stage metrics (because the file is <denchmark-link:https://github.com/catalyst-team/catalyst/blob/master/catalyst/dl/callbacks/checkpoint.py#L30>simply overwritten there</denchmark-link>\n )\n We need to make a normal metric manager for this checkpoint.\n To Reproduce\n Steps to reproduce the behavior:\n \n Add a config file with several training stages.\n Add a CheckpointCallback with save_n_best > 1 to store several best checkpoints (for example 3)\n In logdir/checkpoints/_metrics.json we have logs only for the last stage\n \n Expected behavior\n Metrics are logged from all the stages.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "TezRomacH", "commentT": "2019-10-16T10:54:44Z", "comment_text": "\n \t\tI'll work on this one.\n My first thoughts on this is to add default argument for custom metrics filename in BaseCheckpointCallback:\n <denchmark-code>def save_metric(self, logdir: str, metrics: Dict, custom_metric_filename: str=None) -> None:\n     if custom_metric_filename is None:        \n         safitty.save(metrics, f\"{logdir}/checkpoints/{self.metric_filename}\")\n     else:\n         safitty.save(metrics, f\"{logdir}/checkpoints/{self.custom_metric_filename}\")\n </denchmark-code>\n \n And in CheckpointCallback:\n <denchmark-code>self.save_metric(logdir, metrics, custom_metric_filename=f\"_metrics_{suffix}.json\")\n </denchmark-code>\n \n Something like that. I'll check the implementation myself, because i feel that there is something else has to be done with callbacks to get it working right. :)\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "TezRomacH", "commentT": "2019-10-16T10:56:56Z", "comment_text": "\n \t\tOr we can just change metric_filename in CheckpointCallback before saving, and don't touch save_metric in BaseCheckpointCallback.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "TezRomacH", "commentT": "2019-10-16T11:52:34Z", "comment_text": "\n \t\tI've ran an example on master unchanged code catalyst/examples/_tests_mnist_stages/config1.yml, but with 9 stages.\n Got a _metrics.json file with 3 checkpoints + last and best.\n I think that for collecting all metrics we need to add separate metrics list with all the metrics and make one save for this one at stage end in separate file.\n Or we can save all metrics + n_best + best + last in one metrics file, if that suits our needs more.\n Got a thought that a PR will be more than a thousand words. :)\n \t\t"}}}, "commit": {"commit_id": "67681675591bb856c248fb7a5d8e228835c65548", "commit_author": "Artem Zolkin", "commitT": "2019-10-22 07:47:59+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "catalyst\\dl\\callbacks\\checkpoint.py", "file_new_name": "catalyst\\dl\\callbacks\\checkpoint.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "290,294,295,296,297,299,300,301,302,303", "deleted_lines": "290", "method_info": {"method_name": "get_metric", "method_params": "self,kwargs", "method_startline": "289", "method_endline": "304"}}, "hunk_1": {"Ismethod": 1, "added_lines": "131,135,136,137,138,139,142,143,144", "deleted_lines": "131,135,138,139", "method_info": {"method_name": "get_metric", "method_params": "self,last_valid_metrics", "method_startline": "130", "method_endline": "148"}}}}}}}