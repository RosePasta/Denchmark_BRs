{"BR": {"BR_id": "36700", "BR_author": "EmGarr", "BRopenT": "2020-02-12T16:35:26Z", "BRcloseT": "2020-03-26T17:45:30Z", "BR_text": {"BRsummary": "tf2 isn't enabled in tensorflow_core.python.keras.layers.__init__", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): No\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 16.04\n TensorFlow installed from (source or binary): pip install tensorflow==2.1\n TensorFlow version (use command below): 2.1\n Python version: 3.6.6\n CUDA/cuDNN version: Not used\n GPU model and memory: Not used\n \n You can collect some of this information using our environment capture\n <denchmark-link:https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh>script</denchmark-link>\n \n You can also obtain the TensorFlow version with: 1. TF 1.0:  2. TF 2.0: \n Describe the current behavior\n Whenever you import a layer using the path:\n from tensorflow.python.keras.layers\n It will import the layer using the tensorflow 1.X behavior.\n Which isn't the case when we use tensorflow.keras.layers.\n The issue is that every networks from tf.keras.applications (resnet, densenet...) use those import which can lead to some severe bugs (e.g: BatchNormalization).\n Describe the expected behavior\n Importing from from tensorflow.python.keras.layers and from tensorflow.keras.layers should have exactly the same behavior (2.X).\n Code to reproduce the issue\n from tensorflow.python.keras.layers import BatchNormalization as buggy_BN\n from tensorflow.keras.layers import BatchNormalization as good_BN\n \n print(good_BN()._USE_V2_BEHAVIOR) # TRUE\n print(buggy_BN()._USE_V2_BEHAVIOR) # FALSE\n Other info / logs\n I think that the issue could be fix by changing this <denchmark-link:https://github.com/tensorflow/tensorflow/blob/9bd55fcb645500a2c859cb3390f32b3a7c48327f/tensorflow/python/tf2.py#L43>tensorflow_core.python.tf2</denchmark-link>\n .\n from\n def enabled():\n   \"\"\"Returns True iff TensorFlow 2.0 behavior should be enabled.\"\"\"\n   if _force_enable is None:\n     return os.getenv(\"TF2_BEHAVIOR\", \"0\") != \"0\"\n   else:\n     return _force_enable\n to\n def enabled():\n   \"\"\"Returns True iff TensorFlow 2.0 behavior should be enabled.\"\"\"\n   if _force_enable is None:\n     return os.getenv(\"TF2_BEHAVIOR\", \"1\") != \"0\"\n   else:\n     return _force_enable\n it will make TF2_BEHAVIOR enabled by default\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "EmGarr", "commentT": "2020-02-13T05:25:41Z", "comment_text": "\n \t\tWas able to reproduce the issue. Please find the Gist <denchmark-link:https://colab.sandbox.google.com/gist/amahendrakar/7097b0aa2d706811bc19d086206fd55a/36700.ipynb>here</denchmark-link>\n . Thanks!\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "EmGarr", "commentT": "2020-02-13T23:32:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/EmGarr>@EmGarr</denchmark-link>\n  Importing using  is not a suggested way for importing any module as mentioned <denchmark-link:https://github.com/tensorflow/tensorflow/issues/32957#issuecomment-543819065>here</denchmark-link>\n  and <denchmark-link:https://github.com/tensorflow/tensorflow/issues/33075#issuecomment-539070546>another resource</denchmark-link>\n . Thanks!\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "EmGarr", "commentT": "2020-02-13T23:44:51Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jvishnuvardhan>@jvishnuvardhan</denchmark-link>\n  I do not use this layer but however all the base model of tensorflow keras do use those imports. It means that whenever you use a Resnet50 (or others) you'll use the batch normalization from tf 1.X which has a totally different behavior for trainable is False.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "EmGarr", "commentT": "2020-02-17T20:27:57Z", "comment_text": "\n \t\t\n @jvishnuvardhan I do not use this layer but however all the base model of tensorflow keras do use those imports. It means that whenever you use a Resnet50 (or others) you'll use the batch normalization from tf 1.X which has a totally different behavior for trainable is False.\n \n I encountered this problem just yesterday when attempting to use transfer learning with pretrained models from tensorflow.keras.application-package. The validation loss and accuracy aren\u2019t progressing as one would expect (except with VGG16 and others which don\u2019t use BN). Still after loading the model weights I manually set this flag to be true for each BN layers and after that everything seemed to work as one would expect.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "EmGarr", "commentT": "2020-03-21T03:42:45Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/EmGarr>@EmGarr</denchmark-link>\n  we have encountered this issue and was able to solve this as mentioned <denchmark-link:https://github.com/tensorflow/tensorflow/issues/36366#issuecomment-601985968>here</denchmark-link>\n \n However this has to be fixed by tf team for good as all pretrtained keras models are referencing v1 layers and giving bad results\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "EmGarr", "commentT": "2020-03-25T17:59:53Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/36700>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/36700>No</denchmark-link>\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "EmGarr", "commentT": "2020-03-26T17:45:29Z", "comment_text": "\n \t\tthis issue was fixed in this <denchmark-link:https://github.com/tensorflow/tensorflow/commit/410852dbd24899e22f0020f9fdc9757f527dda55>commit</denchmark-link>\n \n and the fix has been cherrypicked into r2.2 branch.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "EmGarr", "commentT": "2020-03-26T17:45:31Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/36700>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/36700>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "35a382295ad81f7080d306c9b09b0edaa451fcfc", "commit_author": "Martin Wicke", "commitT": "2020-03-25 10:58:45-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\api_template.__init__.py", "file_new_name": "tensorflow\\api_template.__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,17,20,21,24,25,44,45,46,47", "deleted_lines": "16,17,20,21,24,25"}}}}}}