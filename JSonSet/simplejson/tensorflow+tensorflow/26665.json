{"BR": {"BR_id": "26665", "BR_author": "murdockhou", "BRopenT": "2019-03-13T12:30:53Z", "BRcloseT": "2019-03-14T23:40:32Z", "BR_text": {"BRsummary": "tensorflow 2.0, variable_scope(), TypeError: __call__() got an unexpected keyword argument 'partition_info'", "BRdescription": "\n I have convert a CNN model from tf1.x to tf2.0 by using tf_upgrade_v2, but when i used this converted model, i got an error:\n File \"/home/hsw/virtual_env/tf2.0/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 2492, in default_variable_creator import_scope=import_scope, distribute_strategy=distribute_strategy) File \"/home/hsw/virtual_env/tf2.0/lib/python3.6/site-packages/tensorflow/python/ops/variables.py\", line 216, in __call__ return super(VariableMetaclass, cls).__call__(*args, **kwargs) File \"/home/hsw/virtual_env/tf2.0/lib/python3.6/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 422, in __init__ constraint=constraint) File \"/home/hsw/virtual_env/tf2.0/lib/python3.6/site-packages/tensorflow/python/ops/resource_variable_ops.py\", line 545, in _init_from_args initial_value() if init_from_fn else initial_value, File \"/home/hsw/virtual_env/tf2.0/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py\", line 886, in <lambda> shape.as_list(), dtype=dtype, partition_info=partition_info) TypeError: __call__() got an unexpected keyword argument 'partition_info'\n it seems like something wrong in variables.py, and the converted model such as like this :\n <denchmark-code>    with tf.compat.v1.variable_scope('backbone', reuse=tf.compat.v1.AUTO_REUSE):\n         net = tf.compat.v1.layers.separable_conv2d(inputs, 16, 3, 1, 'same',\n                                      activation=tf.nn.elu,\n                                      depthwise_initializer=tf.keras.initializers.glorot_normal(),\n                                      pointwise_initializer=tf.keras.initializers.glorot_normal(),\n                                      name='conv1')\n         net = tf.compat.v1.layers.max_pooling2d(net, 2, 2, padding='same')\n         net = tf.compat.v1.layers.separable_conv2d(net, 32, 3, 1, 'same',\n                                      activation=tf.nn.elu,\n                                      depthwise_initializer=tf.keras.initializers.glorot_normal(),\n                                      pointwise_initializer=tf.keras.initializers.glorot_normal(),\n                                      name='conv2')\n </denchmark-code>\n \n how should do to solve this problem?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "murdockhou", "commentT": "2019-03-13T17:19:07Z", "comment_text": "\n \t\tCan I see the full stack trace?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "murdockhou", "commentT": "2019-03-14T01:29:48Z", "comment_text": "\n \t\t<denchmark-link:https://user-images.githubusercontent.com/18358653/54325147-ac586600-463b-11e9-9f22-7060a5acb656.png></denchmark-link>\n \n This is the full stack trace.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "murdockhou", "commentT": "2019-03-14T16:30:50Z", "comment_text": "\n \t\tThanks! This seems to be an issue with the line\n <denchmark-code>          init_val = lambda: initializer(  # pylint: disable=g-long-lambda\n               shape.as_list(), dtype=dtype, partition_info=partition_info)\n </denchmark-code>\n \n which calls the initializer. For some reason this is calling the v2 tf.keras initializers instead of the compat.v1 initializers. I think this is a bug in the rename script.\n <denchmark-link:https://github.com/pavithrasv>@pavithrasv</denchmark-link>\n  can you revert the change in the rename script to rename tf v1 initializers to tf v2 initializers since they're not compatible?\n A workaround here is to replace the calls to tf.keras.initializers in the translated code with tf.compat.v1 initializers (take what was there originally and replace tf with tf.compat.v1).\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "murdockhou", "commentT": "2019-03-14T18:26:14Z", "comment_text": "\n \t\tThank you Alex. We do not rename v1 initializers to v2. The issue is because we do not rename v1 initializers to compat.V1, because of this users starts seeing the V2 version.\n \n \n \n tensorflow/tensorflow/tools/compatibility/tf_upgrade_v2.py\n \n \n          Line 781\n       in\n       75eca85\n \n \n \n \n \n \n  \"tf.keras.initializers.zeros\": \n \n \n \n \n \n I will add this renaming for all the initializers.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "murdockhou", "commentT": "2019-03-15T01:53:27Z", "comment_text": "\n \t\tThanks all, fixed this by using tf.compat.v1.keras replace tf.keras.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "murdockhou", "commentT": "2019-04-09T07:27:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/murdockhou>@murdockhou</denchmark-link>\n  , Have you resolved this problem, how to do it?  I \uff48\uff41ve the same problem.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "murdockhou", "commentT": "2019-06-27T02:14:49Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alextp>@alextp</denchmark-link>\n  @\n I have similar issue. I attached my problem below.\n \n <denchmark-h:hr></denchmark-h>\n \n In tf2_util.py\n def conv2d( . . .  ~):\n . . . . . . . ~ skip\n with tf.compat.v1.variable_scope(scope) as sc:\n . . . . . . .  ~\n kernel = _variable_with_weight_decay('weights',\n shape=kernel_shape,\n use_xavier=use_xavier,\n stddev=stddev,\n wd=weight_decay)\n def _variable_with_weight_decay(name, shape, stddev, wd, use_xavier=True):\n . . . . . . .  .~ skip\n if use_xavier:\n initializer = tf.keras.initializers.VarianceScaling(scale=1.0, mode=\"fan_avg\", distribution=\"uniform\")\n else:\n initializer = tf.compat.v1.truncated_normal_initializer(stddev=stddev)\n def _variable_on_cpu(name, shape, initializer, use_fp16=False):\n . . . . . . .  .~  skip\n with tf.device(\"/cpu:0\"):\n dtype = tf.float16 if use_fp16 else tf.float32\n var = tf.compat.v1.get_variable(name, shape, initializer=initializer, dtype=dtype)\n return var\n <denchmark-h:hr></denchmark-h>\n \n I guess have error above code 'tf.compat.v1.get_variable' on 'def _variable_on_cpu'\n Detail error explaination is below\n ##############################################################\n Downloads/3D/pointnet2/tf2_train.py:94 train_one_epoch  *\n train_one_step(train_data, train_label, model, optimizer)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:416 call\n self._initialize(args, kwds, add_initializers_to=initializer_map)\n Downloads/3D/pointnet2/tf2_train.py:67 train_one_step  *\n pred = model.get_model(data, True, None)\n Downloads/3D/pointnet2/models_from_pointnet/pointnet_cls.py:27 get_model  *\n transform = input_transform_net(point_cloud, is_training, bn_decay, K=3)\n Downloads/3D/pointnet2/models_from_pointnet/transform_nets.py:19 input_transform_net  *\n net = tf_util.conv2d(input_image, 64, [1,3],\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:164 conv2d  *\n kernel = _variable_with_weight_decay('weights',\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:45 _variable_with_weight_decay  *\n var = _variable_on_cpu(name, shape, initializer)\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:21 _variable_on_cpu  *\n var = tf.compat.v1.get_variable(name, shape, initializer=initializer, dtype=dtype)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1503 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1246 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:569 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:521 _true_getter\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:936 _get_single_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:260 call\n return cls._variable_v1_call(*args, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:221 _variable_v1_call\n shape=shape)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:60 getter\n return captured_getter(captured_previous, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:347 variable_capturing_scope\n lifted_initializer_graph=lifted_initializer_graph, **kwds)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:264 call\n return super(VariableMetaclass, cls).call(*args, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:139 init\n initial_value() if init_from_fn else initial_value,\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:908 \n partition_info=partition_info)\n <denchmark-code>TypeError: __call__() got an unexpected keyword argument 'partition_info'\n </denchmark-code>\n \n ##############################################################\n HOW CAN I SOLVE IT?\n THANKS, IN ADVANCE.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "murdockhou", "commentT": "2019-06-27T17:56:02Z", "comment_text": "\n \t\tCan you file a separate issue?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "murdockhou", "commentT": "2019-06-28T00:16:15Z", "comment_text": "\n \t\tDownloads/3D/pointnet2/tf2_train.py:94 train_one_epoch *\n train_one_step(train_data, train_label, model, optimizer)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:416 call\n self._initialize(args, kwds, add_initializers_to=initializer_map)\n Downloads/3D/pointnet2/tf2_train.py:67 train_one_step *\n pred = model.get_model(data, True, None)\n Downloads/3D/pointnet2/models_from_pointnet/pointnet_cls.py:27 get_model *\n transform = input_transform_net(point_cloud, is_training, bn_decay, K=3)\n Downloads/3D/pointnet2/models_from_pointnet/transform_nets.py:19 input_transform_net *\n net = tf_util.conv2d(input_image, 64, [1,3],\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:164 conv2d *\n kernel = _variable_with_weight_decay('weights',\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:45 _variable_with_weight_decay *\n var = _variable_on_cpu(name, shape, initializer)\n Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:21 _variable_on_cpu *\n var = tf.compat.v1.get_variable(name, shape, initializer=initializer, dtype=dtype)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1503 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1246 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:569 get_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:521 _true_getter\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:936 _get_single_variable\n aggregation=aggregation)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:260 call\n return cls._variable_v1_call(*args, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:221 _variable_v1_call\n shape=shape)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:60 getter\n return captured_getter(captured_previous, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:347 variable_capturing_scope\n lifted_initializer_graph=lifted_initializer_graph, **kwds)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:264 call\n return super(VariableMetaclass, cls).call(*args, **kwargs)\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:139 init\n initial_value() if init_from_fn else initial_value,\n anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:908\n partition_info=partition_info)\n TypeError: call() got an unexpected keyword argument 'partition_info'\n Above Error is the main issue.\n I Guess it came from below this lines.\n def _variable_on_cpu(name, shape, initializer, use_fp16=False):\n . . . . . . . .~ skip\n with tf.device(\"/cpu:0\"):\n dtype = tf.float16 if use_fp16 else tf.float32\n var = tf.compat.v1.get_variable(name, shape, initializer=initializer, dtype=dtype)\n return var\n Thanks you <denchmark-link:https://github.com/alextp>@alextp</denchmark-link>\n \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "murdockhou", "commentT": "2019-06-28T15:12:47Z", "comment_text": "\n \t\tI meant a separate issue with full instructions to reproduce. This looks\n like it's coming from mixing tf v1 layers with tf v2 initializers.\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Thu, Jun 27, 2019 at 5:23 PM tolry418 ***@***.***> wrote:\n  Downloads/3D/pointnet2/tf2_train.py:94 train_one_epoch *\n  train_one_step(train_data, train_label, model, optimizer)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:416\n  call\n  self._initialize(args, kwds, add_initializers_to=initializer_map)\n  Downloads/3D/pointnet2/tf2_train.py:67 train_one_step *\n  pred = model.get_model(data, True, None)\n  Downloads/3D/pointnet2/models_from_pointnet/pointnet_cls.py:27 get_model *\n  transform = input_transform_net(point_cloud, is_training, bn_decay, K=3)\n  Downloads/3D/pointnet2/models_from_pointnet/transform_nets.py:19\n  input_transform_net *\n  net = tf_util.conv2d(input_image, 64, [1,3],\n  Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:164 conv2d *\n  kernel = _variable_with_weight_decay('weights',\n  Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:45\n  _variable_with_weight_decay *\n  var = _variable_on_cpu(name, shape, initializer)\n  Downloads/3D/pointnet2/utils_from_pointnet/tf2_util.py:21 _variable_on_cpu\n  *\n  var = tf.compat.v1.get_variable(name, shape, initializer=initializer,\n  dtype=dtype)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1503\n  get_variable\n  aggregation=aggregation)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:1246\n  get_variable\n  aggregation=aggregation)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:569\n  get_variable\n  aggregation=aggregation)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:521\n  _true_getter\n  aggregation=aggregation)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:936\n  _get_single_variable\n  aggregation=aggregation)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:260\n  call\n  return cls._variable_v1_call(*args, **kwargs)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:221\n  _variable_v1_call\n  shape=shape)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:60\n  getter\n  return captured_getter(captured_previous, **kwargs)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:347\n  variable_capturing_scope\n  lifted_initializer_graph=lifted_initializer_graph, **kwds)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variables.py:264\n  call\n  return super(VariableMetaclass, cls).call(*args, **kwargs)\n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py:139\n  init\n  initial_value() if init_from_fn else initial_value,\n \n  anaconda3/envs/tf_2/lib/python3.6/site-packages/tensorflow/python/ops/variable_scope.py:908\n  partition_info=partition_info)\n \n  TypeError: *call*() got an unexpected keyword argument 'partition_info'\n \n  Above Error is the main issue.\n  I Guess it came from below this lines.\n \n  def _variable_on_cpu(name, shape, initializer, use_fp16=False):\n  . . . . . . . .~ skip\n  with tf.device(\"/cpu:0\"):\n  dtype = tf.float16 if use_fp16 else tf.float32\n  var = *tf.compat.v1.get_variable*(name, shape, initializer=initializer,\n  dtype=dtype)\n  return var\n \n  Thanks you @alextp <https://github.com/alextp>\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#26665?email_source=notifications&email_token=AAABHRJXDK7Y6SOKZWLZCTDP4VKWRA5CNFSM4G5UOJCKYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGODYYWV5I#issuecomment-506555125>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/AAABHRPL2UGAC5CO6RKBJLLP4VKWRANCNFSM4G5UOJCA>\n  .\n \n \n -- \n  - Alex\n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "murdockhou", "commentT": "2019-07-24T02:01:13Z", "comment_text": "\n \t\tNow tf 2.0.0beta0 has solved this problem... Thank <denchmark-link:https://github.com/pavithrasv>@pavithrasv</denchmark-link>\n  !\n \t\t"}}}, "commit": {"commit_id": "a236ae23782c04a057d17a8ad845500c7f15c432", "commit_author": "Pavithra Vijay", "commitT": "2019-03-14 16:24:18-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\tools\\compatibility\\tf_upgrade_v2.py", "file_new_name": "tensorflow\\tools\\compatibility\\tf_upgrade_v2.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "771,772,775,776,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868", "deleted_lines": "719,720,721,722,723,724,725,726,727,728,729,730", "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "38", "method_endline": "1682"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tensorflow\\tools\\compatibility\\tf_upgrade_v2_test.py", "file_new_name": "tensorflow\\tools\\compatibility\\tf_upgrade_v2_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "420,421,422,423,424,425,426", "deleted_lines": null, "method_info": {"method_name": "verify_compat_v1_rename_correctness", "method_params": "self,values,ns_prefix", "method_startline": "420", "method_endline": "426"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1474,1475,1480,1481", "deleted_lines": null, "method_info": {"method_name": "test_uniform_unit_scaling_initializer", "method_params": "self", "method_startline": "1472", "method_endline": "1483"}}, "hunk_2": {"Ismethod": 1, "added_lines": "428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491", "deleted_lines": null, "method_info": {"method_name": "testIntializers", "method_params": "self", "method_startline": "428", "method_endline": "491"}}}}}}}