{"BR": {"BR_id": "28849", "BR_author": "jackshi0912", "BRopenT": "2019-05-20T04:36:19Z", "BRcloseT": "2019-07-15T19:24:17Z", "BR_text": {"BRsummary": "Python3 type annotation does not work with @tf.function + for loop -&gt; tf.while_loop conversion", "BRdescription": "\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): 18.04\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: n/a\n TensorFlow installed from (source or binary): binary\n TensorFlow version (use command below): 2.0 alpha\n Python version: 3.6.7\n Bazel version (if compiling from source): n/a\n GCC/Compiler version (if compiling from source): n/a\n CUDA/cuDNN version: n/a\n GPU model and memory: n/a\n \n Describe the current behavior\n If you use python3 type annotation such as x:tf.Tensor = tf.constant(0) (I aliased tf.Tensor for various shape to keep my sanity for reinforcement learning problems) in a @tf.function and the function contains a for loop to be translated to tf.while_loop (that doesn't even have to use the tensor that's annotated), the code will fail as if you did not turn on eager execution.\n Describe the expected behavior\n Python3 type hinting should not fail the code.\n Code to reproduce the issue\n <denchmark-code>@tf.function\n def tf_for_tf_break():\n     x: tf.Tensor = tf.constant(0)\n     for i in tf.range(5):\n         x += i\n     return x\n \n print(tf_for_tf_break())\n </denchmark-code>\n \n Other info / logs\n WARNING: Logging before flag parsing goes to stderr.\n W0519 21:35:32.992043 140297958307648 tf_logging.py:161] Entity <function tf_for_tf_break at 0x7f99a9edde18> could not be transformed and will be staged without change. Error details can be found in the logs when running with the env variable AUTOGRAPH_VERBOSITY >= 1. Please report this to the AutoGraph team. Cause: AttributeError during conversion: 'NoneType' object has no attribute '_fields'\n Traceback (most recent call last):\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/conversion.py\", line 393, in function_to_graph\n node = node_to_graph(node, context)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/conversion.py\", line 436, in node_to_graph\n node = converter.standard_analysis(node, context, is_initial=True)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/core/converter.py\", line 493, in standard_analysis\n graphs = cfg.build(node)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/pyct/cfg.py\", line 813, in build\n visitor.visit(node)\n File \"/usr/lib/python3.6/ast.py\", line 253, in visit\n return visitor(node)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/pyct/cfg.py\", line 672, in visit_FunctionDef\n self.visit(stmt)\n File \"/usr/lib/python3.6/ast.py\", line 253, in visit\n return visitor(node)\n File \"/usr/lib/python3.6/ast.py\", line 257, in generic_visit\n for field, value in iter_fields(node):\n File \"/usr/lib/python3.6/ast.py\", line 171, in iter_fields\n for field in node._fields:\n AttributeError: 'NoneType' object has no attribute '_fields'\n During handling of the above exception, another exception occurred:\n Traceback (most recent call last):\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/api.py\", line 369, in converted_call\n experimental_partial_types=partial_types)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/api.py\", line 513, in to_graph\n arg_values, arg_types)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/conversion.py\", line 190, in entity_to_graph\n node, name, ns = function_to_graph(o, program_ctx, arg_values, arg_types)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/conversion.py\", line 396, in function_to_graph\n raise errors.InternalError('conversion', e)\n tensorflow.python.autograph.pyct.errors.InternalError: AttributeError during conversion: 'NoneType' object has no attribute '_fields'\n During handling of the above exception, another exception occurred:\n Traceback (most recent call last):\n File \"/home/jackshi/MagneticAccelerator/descrete_optimization/tf_scratch.py\", line 12, in \n print(tf_for_tf_break())\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 426, in call\n self._initialize(args, kwds, add_initializers_to=initializer_map)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 370, in _initialize\n *args, **kwds))\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 1313, in _get_concrete_function_internal_garbage_collected\n graph_function, _, _ = self._maybe_define_function(args, kwargs)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 1580, in _maybe_define_function\n graph_function = self._create_graph_function(args, kwargs)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/function.py\", line 1512, in _create_graph_function\n capture_by_value=self._capture_by_value),\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/framework/func_graph.py\", line 694, in func_graph_from_py_func\n func_outputs = python_func(*func_args, **func_kwargs)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/eager/def_function.py\", line 317, in wrapped_fn\n return weak_wrapped_fn().wrapped(*args, **kwds)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/framework/func_graph.py\", line 686, in wrapper\n ), args, kwargs)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/api.py\", line 390, in converted_call\n return _call_unconverted(f, args, kwargs)\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/autograph/impl/api.py\", line 188, in _call_unconverted\n return f(*args, **kwargs)\n File \"/home/jackshi/MagneticAccelerator/descrete_optimization/tf_scratch.py\", line 7, in tf_for_tf_break\n for i in tf.range(5):\n File \"/home/jackshi/.local/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 449, in iter\n \"Tensor objects are only iterable when eager execution is \"\n TypeError: Tensor objects are only iterable when eager execution is enabled. To iterate over this tensor use tf.map_fn.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jackshi0912", "commentT": "2019-05-21T05:47:39Z", "comment_text": "\n \t\tI am able to reproduce the issue on colab with TF 2.0alpha . This is the error I got TypeError: Tensor objects are only iterable when eager execution is enabled. To iterate over this tensor use tf.map_fn.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jackshi0912", "commentT": "2019-07-15T19:24:18Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=28849>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=28849>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "d3dd0726fc2a6be6235bc1e9c8825056278d3470", "commit_author": "Dan Moldovan", "commitT": "2019-07-15 12:21:54-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tensorflow\\python\\autograph\\pyct\\static_analysis\\activity.py", "file_new_name": "tensorflow\\python\\autograph\\pyct\\static_analysis\\activity.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "274,275", "deleted_lines": null, "method_info": {"method_name": "visit_AnnAssign", "method_params": "self,node", "method_startline": "274", "method_endline": "275"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tensorflow\\python\\autograph\\pyct\\static_analysis\\activity_py3_test.py", "file_new_name": "tensorflow\\python\\autograph\\pyct\\static_analysis\\activity_py3_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "49,50,51,52,53,54,55,56,57,58,59,60,61,62", "deleted_lines": null, "method_info": {"method_name": "test_annotated_assign", "method_params": "self", "method_startline": "49", "method_endline": "62"}}, "hunk_1": {"Ismethod": 1, "added_lines": "53,54,55", "deleted_lines": null, "method_info": {"method_name": "test_annotated_assign.test_fn", "method_params": "c", "method_startline": "53", "method_endline": "55"}}}}}}}