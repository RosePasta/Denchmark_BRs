{"BR": {"BR_id": "17802", "BR_author": "darthdeus", "BRopenT": "2018-03-18T03:24:59Z", "BRcloseT": "2018-03-20T22:20:23Z", "BR_text": {"BRsummary": "Importing a meta graph which contains a SummaryWriter doesn't work", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 17.10\n TensorFlow installed from (source or binary): binary via pip\n TensorFlow version (use command below): v1.6.0-0-gd2e24b6039 1.6.0\n Python version: 3.6.4\n Bazel version (if compiling from source): N/A\n GCC/Compiler version (if compiling from source): N/A\n CUDA/cuDNN version: 9.0/7.0\n GPU model and memory: GTX 1080ti 11G\n Exact command to reproduce:\n \n First run this:\n import tensorflow as tf\n v1 = tf.placeholder(tf.float32, name=\"v1\")\n v2 = tf.placeholder(tf.float32, name=\"v2\")\n v3 = v1 * v2\n vx = tf.Variable(10.0, name=\"vx\")\n v4 = v3 * vx\n writer = tf.contrib.summary.create_file_writer(\"foo\")\n saver = tf.train.Saver([vx])\n sess = tf.Session()\n sess.run(tf.initialize_all_variables())\n sess.run(vx.assign(tf.add(vx, vx)))\n result = sess.run(v4, feed_dict={v1:12.0, v2:3.3})\n print(result)\n saver.save(sess, \"./model_ex1\")\n Then in a different Python instance (it works if done right after the first snippet within the same instance)\n import tensorflow as tf\n saver = tf.train.import_meta_graph(\"./model_ex1.meta\")\n sess = tf.Session()\n saver.restore(sess, \"./model_ex1\")\n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n Trying to restore the meta graph via import_meta_graph does not work if the graph contains a SummaryWriter as shown in the example above. The example works if import_meta_graph is called within the same instance of Python, or if the tf.contrib.summary.create_file_writer(\"foo\") call is removed from the graph.\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n <denchmark-code>---------------------------------------------------------------------------\n KeyError                                  Traceback (most recent call last)\n <ipython-input-1-1661c33bc0e5> in <module>()\n       1 import tensorflow as tf\n ----> 2 saver = tf.train.import_meta_graph(\"./model_ex1.meta\")\n       3 sess = tf.Session()\n       4 saver.restore(sess, \"./model_ex1\")\n \n ~/.miniconda/lib/python3.6/site-packages/tensorflow/python/training/saver.py in import_meta_graph(meta_graph_or_file, clear_devices, import_scope, **kwargs)\n    1907                                       clear_devices=clear_devices,\n    1908                                       import_scope=import_scope,\n -> 1909                                       **kwargs)\n    1910   if meta_graph_def.HasField(\"saver_def\"):\n    1911     return Saver(saver_def=meta_graph_def.saver_def, name=import_scope)\n \n ~/.miniconda/lib/python3.6/site-packages/tensorflow/python/framework/meta_graph.py in import_scoped_meta_graph(meta_graph_or_file, clear_devices, graph, import_scope, input_map, unbound_inputs_col_name, restore_collections_predicate)\n     735     importer.import_graph_def(\n     736         input_graph_def, name=(import_scope or \"\"), input_map=input_map,\n --> 737         producer_op_list=producer_op_list)\n     738\n     739     # Restores all the other collections.\n \n ~/.miniconda/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py in new_func(*args, **kwargs)\n     430                 'in a future version' if date is None else ('after %s' % date),\n     431                 instructions)\n --> 432       return func(*args, **kwargs)\n     433     return tf_decorator.make_decorator(func, new_func, 'deprecated',\n     434                                        _add_deprecated_arg_notice_to_docstring(\n \n ~/.miniconda/lib/python3.6/site-packages/tensorflow/python/framework/importer.py in import_graph_def(graph_def, input_map, return_elements, name, op_dict, producer_op_list)\n     429   if producer_op_list is not None:\n     430     # TODO(skyewm): make a copy of graph_def so we're not mutating the argument?\n --> 431     _RemoveDefaultAttrs(op_dict, producer_op_list, graph_def)\n     432\n     433   graph = ops.get_default_graph()\n \n ~/.miniconda/lib/python3.6/site-packages/tensorflow/python/framework/importer.py in _RemoveDefaultAttrs(op_dict, producer_op_list, graph_def)\n     209     # Remove any default attr values that aren't in op_def.\n     210     if node.op in producer_op_dict:\n --> 211       op_def = op_dict[node.op]\n     212       producer_op_def = producer_op_dict[node.op]\n     213       # We make a copy of node.attr to iterate through since we may modify\n \n KeyError: 'SummaryWriter'\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "darthdeus", "commentT": "2018-03-19T19:54:40Z", "comment_text": "\n \t\tThanks for the report.\n <denchmark-link:https://github.com/alextp>@alextp</denchmark-link>\n  : Do we need to recreate the resource ops on import from the  or something?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "darthdeus", "commentT": "2018-03-19T19:59:19Z", "comment_text": "\n \t\tThis looks like the metagraph is saved from a newer version of tf than it is loaded in. It's failing to find the SummaryWriter op's registration, which doesn't make sense to me.\n <denchmark-link:https://github.com/darthdeus>@darthdeus</denchmark-link>\n  is this reproducible if you use tf-nightly?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "darthdeus", "commentT": "2018-03-19T20:02:10Z", "comment_text": "\n \t\tAh I just checked and I think I know what's going on. The python code for the generated ops is not getting imported unless you use tf.contrib.summary (because of lazy contrib imports) so we're not registering these summary ops on the separate process which loads the metagraph.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "darthdeus", "commentT": "2018-03-19T20:22:34Z", "comment_text": "\n \t\tI'm submitting a fix, but a temporary workaround is to have a line like \"tf.contrib.summary\" somewhere on your program before you try to import the metagraph.\n \t\t"}}}, "commit": {"commit_id": "88334807a5beb8b61a967d21e534ed238e7916c0", "commit_author": "Alexandre Passos", "commitT": "2018-03-19 20:25:38-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\contrib\\cmake\\tf_python.cmake", "file_new_name": "tensorflow\\contrib\\cmake\\tf_python.cmake", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "351", "deleted_lines": "422,423"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\contrib\\summary\\BUILD", "file_new_name": "tensorflow\\contrib\\summary\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "68", "deleted_lines": "13,14,15,16,17,18,64"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\contrib\\summary\\summary_ops.py", "file_new_name": "tensorflow\\contrib\\summary\\summary_ops.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "37", "deleted_lines": "29"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\BUILD", "file_new_name": "tensorflow\\core\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "725", "deleted_lines": null}}}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_CloseSummaryWriter.pbtxt"}, "file_5": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_CreateSummaryDbWriter.pbtxt"}, "file_6": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_CreateSummaryFileWriter.pbtxt"}, "file_7": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_FlushSummaryWriter.pbtxt"}, "file_8": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_ImportEvent.pbtxt"}, "file_9": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_SummaryWriter.pbtxt"}, "file_10": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteAudioSummary.pbtxt"}, "file_11": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteGraphSummary.pbtxt"}, "file_12": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteHistogramSummary.pbtxt"}, "file_13": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteImageSummary.pbtxt"}, "file_14": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteScalarSummary.pbtxt"}, "file_15": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\base_api\\api_def_WriteSummary.pbtxt"}, "file_16": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_CloseSummaryWriter.pbtxt"}, "file_17": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_CreateSummaryDbWriter.pbtxt"}, "file_18": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_CreateSummaryFileWriter.pbtxt"}, "file_19": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_FlushSummaryWriter.pbtxt"}, "file_20": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_ImportEvent.pbtxt"}, "file_21": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_SummaryWriter.pbtxt"}, "file_22": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteAudioSummary.pbtxt"}, "file_23": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteGraphSummary.pbtxt"}, "file_24": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteHistogramSummary.pbtxt"}, "file_25": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteImageSummary.pbtxt"}, "file_26": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteScalarSummary.pbtxt"}, "file_27": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tensorflow\\core\\api_def\\python_api\\api_def_WriteSummary.pbtxt"}, "file_28": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\core\\ops\\summary_ops.cc", "file_new_name": "tensorflow\\core\\ops\\summary_ops.cc", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "25,33,41,45,49,58,63,71,79,89,98,104", "deleted_lines": "25,26,27,28,29,30,31,32,33,41,42,43,44,45,46,47,48,49,50,51,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,82,83,84,85,86,87,91,92,93,94,95,96,97,98,99,108,109,110,111,112,113,114,115,116,117,118,123,124,125,126,127,128,129,130,131,132,140,141,142,143,144,145,146,147,148,149,150,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,264,265,266,267,268,269,270,271"}}}, "file_29": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\BUILD", "file_new_name": "tensorflow\\python\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1361,1362,1363,1364,1365,1366,4119", "deleted_lines": null}}}, "file_30": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tensorflow\\python\\summary\\summary.py", "file_new_name": "tensorflow\\python\\summary\\summary.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "51,56", "deleted_lines": null}}}}}}