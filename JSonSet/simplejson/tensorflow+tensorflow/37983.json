{"BR": {"BR_id": "37983", "BR_author": "hannesdm", "BRopenT": "2020-03-27T18:02:30Z", "BRcloseT": "2020-04-11T23:32:20Z", "BR_text": {"BRsummary": "Calling next with a default value on an exhausted Dataset iterator raises an OutOfRangeError in graph mode", "BRdescription": "\n System information\n \n Have I written custom code: Yes\n OS Platform and Distribution:  Windows 10\n TensorFlow installed from binary: 2.1.0\n \n Describe the current behavior\n next(iterator, default) is supposed to give the next element in the iterator or the value given as default if the iterator is at the end.\n However, when using the above construction in a function with @tf.function, the default value is not returned and an error (tensorflow.python.framework.errors_impl.OutOfRangeError) is produced when trying to call next on an iterator that is at the end.\n When running this code in eager mode, the default value is returned as expected.\n Describe the expected behavior\n In graph mode the default value should be returned when at the end of an iterator.\n Standalone code to reproduce the issue\n <denchmark-code>import tensorflow as tf\n \n x = tf.convert_to_tensor([[1], [2], [3]])\n ds = tf.data.Dataset.from_tensor_slices(x)\n dsi = iter(ds)\n \n \n @tf.function # remove this to get the expected behaviour\n def func():\n     for _ in range(4):\n         tf.print(next(dsi, -1))\n \n \n func()\n </denchmark-code>\n \n Output (see below for a full stacktrace):\n <denchmark-code>[1]\n [2]\n [3]\n 2020-03-27 18:56:09.523946: W tensorflow/core/common_runtime/base_collective_executor.cc:217] BaseCollectiveExecutor::StartAbort Out of range: End of sequence\n \t [[{{node IteratorGetNext_3}}]]\n </denchmark-code>\n \n Expected output:\n <denchmark-code>[1]\n [2]\n [3]\n -1\n \n </denchmark-code>\n \n \n  <denchmark-link:https://colab.research.google.com/drive/1PBxoXiE48aC-bo-aY-Bau1Igt4Aj6OFy>https://colab.research.google.com/drive/1PBxoXiE48aC-bo-aY-Bau1Igt4Aj6OFy</denchmark-link>\n \n <denchmark-link:https://github.com/tensorflow/tensorflow/files/4395116/stacktrace.txt>stacktrace.txt</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hannesdm", "commentT": "2020-03-28T12:05:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hannesdm>@hannesdm</denchmark-link>\n , I have tried after removing  decorator and got expected output.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "hannesdm", "commentT": "2020-03-28T13:28:33Z", "comment_text": "\n \t\t\n @hannesdm, I have tried after removing @tf.function decorator and got expected output.\n \n Yes, everything works as it should without @tf.function, the bug only occurs in graph mode i.e. with @tf.function.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "hannesdm", "commentT": "2020-04-11T23:32:21Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/37983>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tensorflow/issues/37983>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "95ea3404528afcb1a74dd5f0946ea8d17beda28b", "commit_author": "Dan Moldovan", "commitT": "2020-04-11 16:30:42-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 5, "file_old_name": "tensorflow\\python\\autograph\\operators\\py_builtins.py", "file_new_name": "tensorflow\\python\\autograph\\operators\\py_builtins.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "404,405,406,407", "deleted_lines": null, "method_info": {"method_name": "next_", "method_params": "iterator,default", "method_startline": "404", "method_endline": "407"}}, "hunk_1": {"Ismethod": 1, "added_lines": "447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473", "deleted_lines": null, "method_info": {"method_name": "_verify_structure_compatible", "method_params": "input_name,spec_name,input_,spec", "method_startline": "447", "method_endline": "473"}}, "hunk_2": {"Ismethod": 1, "added_lines": "411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444", "deleted_lines": null, "method_info": {"method_name": "_verify_spec_compatible", "method_params": "input_name,spec_name,input_,spec", "method_startline": "411", "method_endline": "444"}}, "hunk_3": {"Ismethod": 1, "added_lines": "488,489,490,491", "deleted_lines": null, "method_info": {"method_name": "next_py", "method_params": "iterator,default", "method_startline": "488", "method_endline": "491"}}, "hunk_4": {"Ismethod": 1, "added_lines": "476,477,478,479,480,481,482,483,484,485", "deleted_lines": null, "method_info": {"method_name": "next_tf_iterator", "method_params": "iterator,default", "method_startline": "476", "method_endline": "485"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 7, "file_old_name": "tensorflow\\python\\autograph\\operators\\py_builtins_test.py", "file_new_name": "tensorflow\\python\\autograph\\operators\\py_builtins_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "307,308,309,310,311,312", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator_error_checking_structures.test_fn", "method_params": "default_val", "method_startline": "307", "method_endline": "312"}}, "hunk_1": {"Ismethod": 1, "added_lines": "264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator.test_fn", "method_params": "go_out_of_range,with_default", "method_startline": "264", "method_endline": "281"}}, "hunk_2": {"Ismethod": 1, "added_lines": "292,293,294,295,296,297,298,299,300,301,302", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator_error_checking", "method_params": "self", "method_startline": "292", "method_endline": "302"}}, "hunk_3": {"Ismethod": 1, "added_lines": "261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator", "method_params": "self", "method_startline": "261", "method_endline": "290"}}, "hunk_4": {"Ismethod": 1, "added_lines": "295,296,297,298", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator_error_checking.test_fn", "method_params": "", "method_startline": "295", "method_endline": "298"}}, "hunk_5": {"Ismethod": 1, "added_lines": "304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330", "deleted_lines": null, "method_info": {"method_name": "test_next_tf_iterator_error_checking_structures", "method_params": "self", "method_startline": "304", "method_endline": "330"}}, "hunk_6": {"Ismethod": 1, "added_lines": "252,253,254,255,256,257,258,259", "deleted_lines": null, "method_info": {"method_name": "test_next_normal", "method_params": "self", "method_startline": "252", "method_endline": "259"}}}}}}}