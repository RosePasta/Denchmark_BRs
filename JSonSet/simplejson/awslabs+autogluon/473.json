{"BR": {"BR_id": "473", "BR_author": "nitinmnsn", "BRopenT": "2020-05-18T18:02:17Z", "BRcloseT": "2020-06-15T05:24:31Z", "BR_text": {"BRsummary": "/home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log   loss = -(transformed_labels * np.log(y_pred)).sum(axis=1)", "BRdescription": "\n I am using autogluon to help me a binary classification problem. It is an unbalanced dataset (90:10) and the neural network breaks down in training and never recovers. I guess a reinitialization once this has been encountered would help?\n <denchmark-code>/home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log\n   loss = -(transformed_labels * np.log(y_pred)).sum(axis=1)\n /home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log\n   loss = -(transformed_labels * np.log(y_pred)).sum(axis=1)\n /home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log\n   loss = -(transformed_labels * np.log(y_pred)).sum(axis=1)\n /home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log\n   loss = -(transformed_labels * np.log(y_pred)).sum(axis=1)\n /home/nitin/anaconda3/envs/automlgluon/lib/python3.6/site-packages/sklearn/metrics/classification.py:2174: RuntimeWarning: divide by zero encountered in log\n </denchmark-code>\n \n The task is fitting all the other models just fine and hitting an 'auc' of 0.74+ but neural network has issues (dead relus, inf encountered and now wont recover? just guesses) but i guess reinitialization once the weights have been bastardized irrevocably would help\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "nitinmnsn", "commentT": "2020-05-18T20:02:17Z", "comment_text": "\n \t\tThanks for submitting an issue!\n We are aware that the NN can at times break down as you say. We have a PR in progress that hopes to deal with at least part of the problem: <denchmark-link:https://github.com/awslabs/autogluon/pull/339>#339</denchmark-link>\n  .\n <denchmark-link:https://github.com/jwmueller>@jwmueller</denchmark-link>\n  Can you take ownership of this issue and see to resolving this problem in the next release? I think it affects quite a few datasets.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "nitinmnsn", "commentT": "2020-05-19T01:57:41Z", "comment_text": "\n \t\tYep I already have a much better fix than the one in the PR but it's currently entangled with a bunch of other code. Will try to update the PR shortly\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "nitinmnsn", "commentT": "2020-05-19T09:22:03Z", "comment_text": "\n \t\tI have seen this issue in writing my own neural networks based pipeline (it was couple of years back though). I did a few things in trying to solve it and they helped (all in tensorflow) :\n \n Gradient clipping\n Batchnorm as the first layer\n Weights normalization (You have batchnorm with dropout. I have read that they dont work well together). If anyway you have batchnorm then keeping gamma frozen at 1 and beta frozen at 0 for first few epochs might help\n Reinitializing the network altogether when nan was encounter in loss\n Leaky ReLU for first few epoch and then ReLU. Also, SELU was great at not letting the network bastardize to even 6-7 layers of depths.\n Deep feed forward netowrks with dense connections (densenet style) with SELU (since SELU can handle depth) never got the issue. But, you are going for speed as well and SELU is going to need at least 100 neurons in hidden layers for fixed point theorem to kick in plus huge network .. so.. I dont know .. just putting down what i had tried\n \n Also, with me it did happen that the network broke down at times but i didnt see it break down with every initialization but that is happening here. I dropped around 100 features using null importance and still the neural network is breaking on every initialization.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "nitinmnsn", "commentT": "2020-05-20T01:23:06Z", "comment_text": "\n \t\tThe issue is much simpler, when you specify eval_metric='roc_auc', the NN is actually internally checking the per-epoch validation log-loss metric for early stopping. Near initialization, the NN often predicts class-probabilities == 0 by pure chance which causes 'divide by zero'.  For now, if you want to use NN alone with 'roc_auc' metric, then:  simply change your eval_metric to accuracy. This may produce better 'roc_auc' from the NN as it'll avoid this issue by early stopping based on per-epoch validation accuracy rather than log-loss (despite no change to its architecture/initialization/training updates).\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "nitinmnsn", "commentT": "2020-05-22T19:16:05Z", "comment_text": "\n \t\tAlternatively, you can also set stopping_metric='roc_auc' to fix it.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "nitinmnsn", "commentT": "2020-05-24T11:35:04Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/jwmueller>@jwmueller</denchmark-link>\n   - \"Near initialization, the NN often predicts class-probabilities == 0 by pure chance\".. Maybe you wanted to say 'hard classes' and not 'class-probabilities'. Outoput of softmax wont be zero.\n \n I do not think this is a case of pure chance but a case of imbalanced data. NN is getting so many samples with 0 as the label that it initially learns to predict all 0s. Plus it is happening on every initialization. Also, for accuracy you would have to set a threshold which even if you would be setting equal to proportion of 1s., the network would have to be very unlucky to predict all probabilities below threshold to have all labels are 0. For these reasons I guess the network is just learning to predict very low probabilities for each sample\n How this translates to a 'division by zero' beats me. Can you please shed some light on it?\n This imbalanced classes is the sole reason i dont want to use accuracy as 'eval_metric'. My rule based class_predicton = 0 has 90% accuracy to begin with.\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "nitinmnsn", "commentT": "2020-06-15T05:24:31Z", "comment_text": "\n \t\tFixed in: <denchmark-link:https://github.com/awslabs/autogluon/pull/481>#481</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "de801b027cd40cf269c21f0d862c543d792ab228", "commit_author": "Jonas Mueller", "commitT": "2020-06-12 19:10:40-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "autogluon\\utils\\tabular\\ml\\constants.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\constants.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "17,18", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "autogluon\\utils\\tabular\\ml\\models\\abstract\\abstract_model.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\models\\abstract\\abstract_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "81,82,83,84,85,86", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,str,str,str,objective_func,num_classes,stopping_metric,model,hyperparameters,features,feature_types_metadata,debug,kwargs", "method_startline": "60", "method_endline": "123"}}, "hunk_1": {"Ismethod": 1, "added_lines": "216,217,218,219,220,221,222,223,224", "deleted_lines": "210,218", "method_info": {"method_name": "predict_proba", "method_params": "self,X,preprocess", "method_startline": "210", "method_endline": "229"}}, "hunk_2": {"Ismethod": 1, "added_lines": "216,217,218,219,220,221,222", "deleted_lines": "218", "method_info": {"method_name": "predict_proba", "method_params": "self,X,preprocess,normalize", "method_startline": "216", "method_endline": "222"}}, "hunk_3": {"Ismethod": 1, "added_lines": "224", "deleted_lines": null, "method_info": {"method_name": "_predict_proba", "method_params": "self,X,preprocess", "method_startline": "224", "method_endline": "242"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "autogluon\\utils\\tabular\\ml\\models\\lgb\\lgb_model.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\models\\lgb\\lgb_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "140", "deleted_lines": "139", "method_info": {"method_name": "predict_proba", "method_params": "self,X,preprocess", "method_startline": "139", "method_endline": "161"}}, "hunk_1": {"Ismethod": 1, "added_lines": "140", "deleted_lines": null, "method_info": {"method_name": "_predict_proba", "method_params": "self,X,preprocess", "method_startline": "140", "method_endline": "162"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "autogluon\\utils\\tabular\\ml\\models\\lr\\lr_model.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\models\\lr\\lr_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "141,143", "deleted_lines": "141,143", "method_info": {"method_name": "predict_proba", "method_params": "self,X,preprocess", "method_startline": "141", "method_endline": "143"}}, "hunk_1": {"Ismethod": 1, "added_lines": "141,143", "deleted_lines": "141,143", "method_info": {"method_name": "_predict_proba", "method_params": "self,X,preprocess", "method_startline": "141", "method_endline": "143"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "autogluon\\utils\\tabular\\ml\\models\\tabular_nn\\tabular_nn_model.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\models\\tabular_nn\\tabular_nn_model.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "432,434,435,436", "deleted_lines": "429,431,432,433,434,435,436", "method_info": {"method_name": "_predict_tabular_data", "method_params": "self,new_data,process,predict_proba", "method_startline": "402", "method_endline": "436"}}, "hunk_1": {"Ismethod": 1, "added_lines": "386", "deleted_lines": "383", "method_info": {"method_name": "predict_proba", "method_params": "self,X,preprocess", "method_startline": "383", "method_endline": "397"}}, "hunk_2": {"Ismethod": 1, "added_lines": "98,99,100,101", "deleted_lines": "83", "method_info": {"method_name": "__init__", "method_params": "self,kwargs", "method_startline": "69", "method_endline": "101"}}, "hunk_3": {"Ismethod": 1, "added_lines": "386", "deleted_lines": null, "method_info": {"method_name": "_predict_proba", "method_params": "self,X,preprocess", "method_startline": "386", "method_endline": "400"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "autogluon\\utils\\tabular\\ml\\trainer\\abstract_trainer.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\trainer\\abstract_trainer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": null, "deleted_lines": "640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656", "method_info": {"method_name": "predict_proba_model", "method_params": "self,X,model,model_pred_proba_dict", "method_startline": "636", "method_endline": "657"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "autogluon\\utils\\tabular\\ml\\utils.py", "file_new_name": "autogluon\\utils\\tabular\\ml\\utils.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "184,185,186,187,188,189,190,191,192,193", "deleted_lines": null, "method_info": {"method_name": "normalize_binary_probas", "method_params": "y_predprob,eps", "method_startline": "184", "method_endline": "193"}}, "hunk_1": {"Ismethod": 1, "added_lines": "157,158,159", "deleted_lines": "148,149,150,151,152,153,154,155,156,157,158,159", "method_info": {"method_name": "combine_pred_and_true", "method_params": "y_predprob,y_true,upweight_factor", "method_startline": "148", "method_endline": "159"}}, "hunk_2": {"Ismethod": 1, "added_lines": "159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181", "deleted_lines": "159,160,161", "method_info": {"method_name": "normalize_pred_probas", "method_params": "y_predprob,problem_type,eps", "method_startline": "159", "method_endline": "181"}}, "hunk_3": {"Ismethod": 1, "added_lines": "196,197,198,199,200,201,202,203,204,205", "deleted_lines": null, "method_info": {"method_name": "normalize_multi_probas", "method_params": "y_predprob,eps", "method_startline": "196", "method_endline": "205"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\tutorials\\tabular_prediction\\tabular-quickstart.md", "file_new_name": "docs\\tutorials\\tabular_prediction\\tabular-quickstart.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "110", "deleted_lines": "110"}}}}}}