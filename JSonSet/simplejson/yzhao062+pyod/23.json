{"BR": {"BR_id": "23", "BR_author": "hanshupe", "BRopenT": "2018-10-14T08:43:51Z", "BRcloseT": "2019-04-30T20:46:51Z", "BR_text": {"BRsummary": "KNN Mahalanobis distance error", "BRdescription": "\n Hi,\n When I use the Mahalanobis metric for KNN I always get the error \"Must provide either V or VI for Mahalanobis distance\" even when I provide V with metric_params. The same request works with sklearn.neighbors.\n <denchmark-code>\n from pyod.models.knn import KNN  \n from pyod.utils.data import generate_data\n from sklearn.neighbors import NearestNeighbors\n import numpy as np\n \n contamination = 0.1  \n n_train = 200  \n n_test = 100 \n \n X_train, y_train, X_test, y_test = generate_data(n_train=n_train, n_test=n_test, contamination=contamination)\n \n #Doesn't work (Must provide either V or VI for Mahalanobis distance)\n clf = KNN(algorithm='brute', metric='mahalanobis', metric_params={'V': np.cov(X_train)})\n clf.fit(X_train)\n \n #Works\n nn = NearestNeighbors(algorithm='brute', metric='mahalanobis', metric_params={'V': np.cov(X_train)})\n nn.fit(X_train)\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hanshupe", "commentT": "2018-10-14T19:50:18Z", "comment_text": "\n \t\tThanks for reporting this. It is due to the problem of passing parameters into KDTree.\n Specifically, it is caused by the difference between the parameters of NearestNeighbors and KDTree...KDTree has a distinct way of using customized distance metrics.\n I will fix it in this next few days and update you here.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "hanshupe", "commentT": "2018-10-28T12:22:46Z", "comment_text": "\n \t\tAny news on this? Thanks.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "hanshupe", "commentT": "2018-11-02T17:59:23Z", "comment_text": "\n \t\tSorry for being late on this. I was exploring several options but get stuck by passing in customized metric to sklearn KD_tree. In PyOD, KNN detector uses a KD-tree internally.\n I tried one solution to pass in mahalanobis distance:\n \n metric = DistanceMetric.get_metric('mahalanobis', V=np.cov(X_test))\n #Doesn't work (Must provide either V or VI for Mahalanobis distance)\n clf = KNN(algorithm='brute', metric=metric.pairwise)\n clf.fit(X_train)\n #scikit-learn/scikit-learn#8890\n \n The reason is that I built a KD-tree and also a NearestNeighbors for KNN, which should be combined into one. Will provide an update later...\n As an alternative, I will recommend you to check out MCD model in PyOD that uses Mahalanobis:\n \n First fit a minimum covariance determinant model and then compute the\n Mahalanobis distance as the outlier degree of the data\n \n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "hanshupe", "commentT": "2018-11-23T13:19:03Z", "comment_text": "\n \t\tHi can I ask if there will be a solution for the bug? Thanks\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "hanshupe", "commentT": "2019-01-23T10:21:51Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/yzhao062>@yzhao062</denchmark-link>\n  if you're too busy I could give it a try\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "hanshupe", "commentT": "2019-01-23T15:41:05Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/evanmiller29>@evanmiller29</denchmark-link>\n  that will be perfect!\n The current problem is I am using a KD tree and a NearestNeighbors at the same time...which might be consolidated into one with consistent parameters (KD tree has different parameters than NearestNeighbors which makes the fix more complicated).\n Let me know if you need any other tips & thanks for the help.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "hanshupe", "commentT": "2019-04-18T07:54:04Z", "comment_text": "\n \t\tHello <denchmark-link:https://github.com/evanmiller29>@evanmiller29</denchmark-link>\n , hello <denchmark-link:https://github.com/yzhao062>@yzhao062</denchmark-link>\n ,\n any news on this issue? Am evaluating pyod and stumbled over this issue. Some update here would be great.\n Thanks for your efforts and work.\n All the best\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "hanshupe", "commentT": "2019-04-18T15:03:46Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/sdoering>@sdoering</denchmark-link>\n  I am back to fix this one. Someone brought this into my attention yesterday (<denchmark-link:https://stackoverflow.com/q/55728669/4168429?sem=2>https://stackoverflow.com/q/55728669/4168429?sem=2</denchmark-link>\n ). I will aim to provide a solution this week (doing some experiments now). Stay tuned :)\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "hanshupe", "commentT": "2019-04-18T19:11:08Z", "comment_text": "\n \t\tThe bug is fixed by commit <denchmark-link:https://github.com/yzhao062/pyod/commit/db41e8e03e3901782eb68ff77ab95fc89e82bd92>db41e8e</denchmark-link>\n \n The latest commit is not yet pushed to master branch but development branch only (<denchmark-link:https://github.com/yzhao062/pyod/tree/development>https://github.com/yzhao062/pyod/tree/development</denchmark-link>\n ). The next release V0.7.0 will include this commit. See <denchmark-link:https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py>https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py</denchmark-link>\n  for example.\n Before the new version is officially released (by the end of this month), you could overwrite the PyOD source file knn.py by <denchmark-link:https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py>https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py</denchmark-link>\n  . \n First, you need to find the location of pyod installation using \n <denchmark-link:https://user-images.githubusercontent.com/15079146/56385403-045f2b00-61ed-11e9-9428-7872538590f9.png></denchmark-link>\n \n Then replace the knn.py file there by <denchmark-link:https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py>https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py</denchmark-link>\n  .\n <denchmark-link:https://user-images.githubusercontent.com/15079146/56385452-2658ad80-61ed-11e9-962a-44bf26c210bd.png></denchmark-link>\n \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "hanshupe", "commentT": "2019-04-30T20:46:51Z", "comment_text": "\n \t\tClosed by <denchmark-link:https://github.com/yzhao062/pyod/pull/84>#84</denchmark-link>\n . Available in the latest version (<denchmark-link:https://pypi.org/project/pyod/>v0.7.0</denchmark-link>\n ).\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "hanshupe", "commentT": "2019-06-21T22:43:51Z", "comment_text": "\n \t\tWhen your using the function np.cov, you need to set the parameter rowvar to False like that :\n np.cov(X_train, rowvar =False)\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "hanshupe", "commentT": "2019-06-23T02:53:07Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/lachhebo>@lachhebo</denchmark-link>\n  Yeah I think so. See the example provided here: <denchmark-link:https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py>https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "db41e8e03e3901782eb68ff77ab95fc89e82bd92", "commit_author": "Yue Zhao", "commitT": "2019-04-18 15:06:26-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "CHANGES.txt", "file_new_name": "CHANGES.txt", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "69", "deleted_lines": null}}}, "file_1": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "examples\\knn_mahalanobis_example.py"}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pyod\\models\\knn.py", "file_new_name": "pyod\\models\\knn.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "173,174,175,176,177,178,179", "deleted_lines": "173", "method_info": {"method_name": "fit", "method_params": "self,X,y", "method_startline": "157", "method_endline": "189"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 14, "file_old_name": "pyod\\test\\test_knn.py", "file_new_name": "pyod\\test\\test_knn.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "189,190,191,192,193,194,195,196,197,198,199,200,201,202,203", "deleted_lines": "189,190,191,192,193,194,195,196,197,198,199,200,201,202", "method_info": {"method_name": "setUp", "method_params": "self", "method_startline": "189", "method_endline": "203"}}, "hunk_1": {"Ismethod": 1, "added_lines": "229,230,231", "deleted_lines": null, "method_info": {"method_name": "test_prediction_labels", "method_params": "self", "method_startline": "229", "method_endline": "231"}}, "hunk_2": {"Ismethod": 1, "added_lines": "217,218", "deleted_lines": null, "method_info": {"method_name": "test_train_scores", "method_params": "self", "method_startline": "217", "method_endline": "218"}}, "hunk_3": {"Ismethod": 1, "added_lines": "243,244,245,246", "deleted_lines": null, "method_info": {"method_name": "test_prediction_proba_unify", "method_params": "self", "method_startline": "243", "method_endline": "246"}}, "hunk_4": {"Ismethod": 1, "added_lines": "205,206,207,208,209,210,211,212,213,214,215", "deleted_lines": null, "method_info": {"method_name": "test_parameters", "method_params": "self", "method_startline": "205", "method_endline": "215"}}, "hunk_5": {"Ismethod": 1, "added_lines": "233,234,235,236", "deleted_lines": null, "method_info": {"method_name": "test_prediction_proba", "method_params": "self", "method_startline": "233", "method_endline": "236"}}, "hunk_6": {"Ismethod": 1, "added_lines": "220,221,222,223,224,225,226,227", "deleted_lines": null, "method_info": {"method_name": "test_prediction_scores", "method_params": "self", "method_startline": "220", "method_endline": "227"}}, "hunk_7": {"Ismethod": 1, "added_lines": "238,239,240,241", "deleted_lines": null, "method_info": {"method_name": "test_prediction_proba_linear", "method_params": "self", "method_startline": "238", "method_endline": "241"}}, "hunk_8": {"Ismethod": 1, "added_lines": "248,249,250", "deleted_lines": null, "method_info": {"method_name": "test_prediction_proba_parameter", "method_params": "self", "method_startline": "248", "method_endline": "250"}}, "hunk_9": {"Ismethod": 1, "added_lines": "256,257,258,259,260,261,262,263,264", "deleted_lines": null, "method_info": {"method_name": "test_fit_predict_score", "method_params": "self", "method_startline": "256", "method_endline": "264"}}, "hunk_10": {"Ismethod": 1, "added_lines": "284,285", "deleted_lines": null, "method_info": {"method_name": "tearDown", "method_params": "self", "method_startline": "284", "method_endline": "285"}}, "hunk_11": {"Ismethod": 1, "added_lines": "266,267,268,269,270,271,272,273", "deleted_lines": null, "method_info": {"method_name": "test_predict_rank", "method_params": "self", "method_startline": "266", "method_endline": "273"}}, "hunk_12": {"Ismethod": 1, "added_lines": "252,253,254", "deleted_lines": null, "method_info": {"method_name": "test_fit_predict", "method_params": "self", "method_startline": "252", "method_endline": "254"}}, "hunk_13": {"Ismethod": 1, "added_lines": "275,276,277,278,279,280,281,282", "deleted_lines": null, "method_info": {"method_name": "test_predict_rank_normalized", "method_params": "self", "method_startline": "275", "method_endline": "282"}}}}}}}