{"BR": {"BR_id": "2805", "BR_author": "asdiuzd", "BRopenT": "2020-05-24T08:53:26Z", "BRcloseT": "2020-06-07T07:37:53Z", "BR_text": {"BRsummary": "bbox vertical flip is not handled correctly when aug test", "BRdescription": "\n The vertical flip process is the same as the horizontal flip.\n If I set random vertical flip, bbox transform in mmdet/core/bbox/transforms.py handle the vertical flip via horizontal flip.\n def bbox_flip(bboxes, img_shape):\n \"\"\"Flip bboxes horizontally.\n <denchmark-code>Args:\n     bboxes(Tensor or ndarray): Shape (..., 4*k)\n     img_shape(tuple): Image shape.\n \n Returns:\n     Same type as `bboxes`: Flipped bboxes.\n \"\"\"\n if isinstance(bboxes, torch.Tensor):\n     assert bboxes.shape[-1] % 4 == 0\n     flipped = bboxes.clone()\n     flipped[:, 0::4] = img_shape[1] - bboxes[:, 2::4]\n     flipped[:, 2::4] = img_shape[1] - bboxes[:, 0::4]\n     return flipped\n elif isinstance(bboxes, np.ndarray):\n     return mmcv.bbox_flip(bboxes, img_shape)\n </denchmark-code>\n \n def bbox_mapping(bboxes, img_shape, scale_factor, flip):\n \"\"\"Map bboxes from the original image scale to testing scale\"\"\"\n new_bboxes = bboxes * bboxes.new_tensor(scale_factor)\n if flip:\n new_bboxes = bbox_flip(new_bboxes, img_shape)\n return new_bboxes\n def bbox_mapping_back(bboxes, img_shape, scale_factor, flip):\n \"\"\"Map bboxes from testing scale to original image scale\"\"\"\n new_bboxes = bbox_flip(bboxes, img_shape) if flip else bboxes\n scale_factor = new_bboxes.new_tensor(scale_factor)\n new_bboxes = (new_bboxes.view(new_bboxes.size(0), -1, 4) / scale_factor).view(\n new_bboxes.size()[0], -1)\n # print(new_bboxes.shape, new_bboxes.new_tensor(scale_factor))\n # new_bboxes = new_bboxes / new_bboxes.new_tensor(scale_factor)\n return new_bboxes\n I find another bbox transform in mmdet/datasets/pipelines/transforms.py is correct.\n def bbox_flip(self, bboxes, img_shape, direction):\n \"\"\"Flip bboxes horizontally.\n <denchmark-code>    Args:\n         bboxes(ndarray): shape (..., 4*k)\n         img_shape(tuple): (height, width)\n     \"\"\"\n     assert bboxes.shape[-1] % 4 == 0\n     flipped = bboxes.copy()\n     if direction == 'horizontal':\n         w = img_shape[1]\n         flipped[..., 0::4] = w - bboxes[..., 2::4]\n         flipped[..., 2::4] = w - bboxes[..., 0::4]\n     elif direction == 'vertical':\n         h = img_shape[0]\n         flipped[..., 1::4] = h - bboxes[..., 3::4]\n         flipped[..., 3::4] = h - bboxes[..., 1::4]\n     else:\n         raise ValueError(f\"Invalid flipping direction '{direction}'\")\n     return flipped\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "asdiuzd", "commentT": "2020-06-01T05:41:20Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/asdiuzd>@asdiuzd</denchmark-link>\n \n Thanks for reporting. I will create a PR to fix this bug.\n \t\t"}}}, "commit": {"commit_id": "93073ef18313015f2f45d9b54106ed98c8dc2579", "commit_author": "Jerry Jiarui XU", "commitT": "2020-06-07 15:37:52+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "mmdet\\core\\bbox\\transforms.py", "file_new_name": "mmdet\\core\\bbox\\transforms.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "42,43,44,45,46", "deleted_lines": null, "method_info": {"method_name": "bbox_mapping_back", "method_params": "bboxes,img_shape,scale_factor,flip,flip_direction", "method_startline": "42", "method_endline": "46"}}, "hunk_1": {"Ismethod": 1, "added_lines": "34,38", "deleted_lines": "34,36", "method_info": {"method_name": "bbox_mapping_back", "method_params": "bboxes,img_shape,scale_factor,flip", "method_startline": "34", "method_endline": "38"}}, "hunk_2": {"Ismethod": 1, "added_lines": "6,9,10,11,12,13,16,18,19,20,21,22,23", "deleted_lines": "6,7,10,11,14,16,17,18,21,22,23", "method_info": {"method_name": "bbox_flip", "method_params": "bboxes,img_shape", "method_startline": "6", "method_endline": "23"}}, "hunk_3": {"Ismethod": 1, "added_lines": "5,6,9,10,11,12,13,16,18,19,20,21,22,23,24,27", "deleted_lines": "6,7,10,11,14,16,17,18,21,22,23,26", "method_info": {"method_name": "bbox_flip", "method_params": "bboxes,img_shape,direction", "method_startline": "5", "method_endline": "27"}}, "hunk_4": {"Ismethod": 1, "added_lines": "27,30,31", "deleted_lines": "26,30", "method_info": {"method_name": "bbox_mapping", "method_params": "bboxes,img_shape,scale_factor,flip", "method_startline": "26", "method_endline": "31"}}, "hunk_5": {"Ismethod": 1, "added_lines": "30,31,32,33,34", "deleted_lines": "30,34", "method_info": {"method_name": "bbox_mapping", "method_params": "bboxes,img_shape,scale_factor,flip,flip_direction", "method_startline": "30", "method_endline": "34"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "mmdet\\core\\post_processing\\merge_augs.py", "file_new_name": "mmdet\\core\\post_processing\\merge_augs.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "65,66,67", "deleted_lines": "63", "method_info": {"method_name": "merge_aug_bboxes", "method_params": "aug_bboxes,aug_scores,img_metas,rcnn_test_cfg", "method_startline": "48", "method_endline": "74"}}, "hunk_1": {"Ismethod": 1, "added_lines": "96,97,98,99,100,101,102,103,104,105,106,107,108,109", "deleted_lines": "92,93,94,95", "method_info": {"method_name": "merge_aug_masks", "method_params": "aug_masks,img_metas,rcnn_test_cfg,weights", "method_startline": "85", "method_endline": "115"}}, "hunk_2": {"Ismethod": 1, "added_lines": "32,35,36", "deleted_lines": "34", "method_info": {"method_name": "merge_aug_proposals", "method_params": "aug_proposals,img_metas,rpn_test_cfg", "method_startline": "8", "method_endline": "45"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "mmdet\\datasets\\pipelines\\__init__.py", "file_new_name": "mmdet\\datasets\\pipelines\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "7", "deleted_lines": "7"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "mmdet\\datasets\\pipelines\\formating.py", "file_new_name": "mmdet\\datasets\\pipelines\\formating.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "176", "deleted_lines": "176", "method_info": {"method_name": "__init__", "method_params": "self,keys,meta_keys", "method_startline": "172", "method_endline": "176"}}, "hunk_1": {"Ismethod": 1, "added_lines": "176", "deleted_lines": "176", "method_info": {"method_name": "__init__", "method_params": "self,keys,meta_keys", "method_startline": "172", "method_endline": "176"}}}}, "file_4": {"file_change_type": "DELETE", "file_Nmethod": 0, "file_old_name": "mmdet\\datasets\\pipelines\\test_aug.py", "file_new_name": "None"}, "file_5": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "mmdet\\datasets\\pipelines\\test_time_aug.py"}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mmdet\\models\\detectors\\reppoints_detector.py", "file_new_name": "mmdet\\models\\detectors\\reppoints_detector.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "43,44,45", "deleted_lines": "43", "method_info": {"method_name": "merge_aug_results", "method_params": "self,aug_bboxes,aug_scores,img_metas", "method_startline": "27", "method_endline": "52"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mmdet\\models\\detectors\\rpn.py", "file_new_name": "mmdet\\models\\detectors\\rpn.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "99,101,102", "deleted_lines": "100", "method_info": {"method_name": "aug_test", "method_params": "self,imgs,img_metas,rescale", "method_startline": "91", "method_endline": "104"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mmdet\\models\\roi_heads\\cascade_roi_head.py", "file_new_name": "mmdet\\models\\roi_heads\\cascade_roi_head.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "352,355,405,407", "deleted_lines": "354,405", "method_info": {"method_name": "aug_test", "method_params": "self,features,proposal_list,img_metas,rescale", "method_startline": "338", "method_endline": "428"}}}}, "file_9": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "mmdet\\models\\roi_heads\\htc_roi_head.py", "file_new_name": "mmdet\\models\\roi_heads\\htc_roi_head.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "404,407,460,462", "deleted_lines": "406,460", "method_info": {"method_name": "aug_test", "method_params": "self,img_feats,img_metas,proposals,rescale", "method_startline": "379", "method_endline": "500"}}}}, "file_10": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "mmdet\\models\\roi_heads\\test_mixins.py", "file_new_name": "mmdet\\models\\roi_heads\\test_mixins.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "81,84", "deleted_lines": "83", "method_info": {"method_name": "aug_test_bboxes", "method_params": "self,feats,img_metas,proposal_list,rcnn_test_cfg", "method_startline": "73", "method_endline": "105"}}, "hunk_1": {"Ismethod": 1, "added_lines": "184,186", "deleted_lines": "184", "method_info": {"method_name": "aug_test_mask", "method_params": "self,feats,img_metas,det_bboxes,det_labels", "method_startline": "175", "method_endline": "203"}}}}}}}