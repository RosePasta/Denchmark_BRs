{"BR": {"BR_id": "4253", "BR_author": "evanw", "BRopenT": "2020-11-17T20:59:03Z", "BRcloseT": "2020-12-16T00:01:06Z", "BR_text": {"BRsummary": "The package \"@tensorflow/tfjs-backend-wasm\" is not minifier-safe", "BRdescription": "\n I'm working on <denchmark-link:https://github.com/evanw/esbuild/issues/538>a bug</denchmark-link>\n  filed by a user of this library against <denchmark-link:https://github.com/evanw/esbuild>esbuild</denchmark-link>\n , a bundler I work on. The  package breaks when bundled and minified. This problem is not specific to esbuild; it happens with a normal Webpack production build too with all default options. However, this is a problem that needs to be solved in the library itself instead of by the bundler, so I figured I should file an issue here about this.\n System information\n \n Have I written custom code (as opposed to using a stock example script provided in TensorFlow.js): no\n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): macOS 10.15.7\n Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: N/A\n TensorFlow.js installed from (npm or script link): npm\n TensorFlow.js version (use command below): ?\n Browser version: Chrome 80\n Tensorflow.js Converter Version: N/A\n \n Describe the current behavior\n The @tensorflow/tfjs-backend-wasm package sometimes breaks when minified. This is the case with Webpack and other bundlers.\n The specific reason for the breakage is described here: <denchmark-link:https://github.com/evanw/esbuild/issues/538#issuecomment-729199631>evanw/esbuild#538 (comment)</denchmark-link>\n . At a high level, this library converts a function to a string and then converts that string back to a function. This essentially \"rips\" it out of its local scope and injects it into another scope and then re-binds all identifiers. That function accesses a local variable called  and expects that variable to keep the same name in the function source code.\n Some ways of fixing this:\n \n \n This could be fixed by placing the code that should not be minified inside a string instead of using a function expression to contain the code. This will ensure that the minifier will not transform it in any way.\n \n \n This could be fixed by not using the name of the variable to implement this binding. It would be best to pass the value of this variable as an additional parameter to the function so the function doesn't reach for anything outside of its scope.\n \n \n There is an alternative hack using direct eval if doing this is not possible. This hack is also described in evanw/esbuild#538 (comment). Using direct eval is an anti-pattern so I'd only do this if other options don't work.\n \n \n Describe the expected behavior\n The @tensorflow/tfjs-backend-wasm package should not behave differently when minified.\n Standalone code to reproduce the issue\n There is a full reproduction case here: <denchmark-link:https://github.com/evanw/esbuild/issues/538#issuecomment-728939332>evanw/esbuild#538 (comment)</denchmark-link>\n . Note that to hit the issue, you need to have both  and  enabled in .\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "evanw", "commentT": "2020-11-17T21:01:43Z", "comment_text": "\n \t\tcc <denchmark-link:https://github.com/tafsiri>@tafsiri</denchmark-link>\n  <denchmark-link:https://github.com/annxingyuan>@annxingyuan</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "evanw", "commentT": "2020-11-18T21:00:07Z", "comment_text": "\n \t\tI use @tensorflow/tfjs-backend-wasm with webpack and I have no problems. Webpack 4. I can give you my webpack config if you need.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "evanw", "commentT": "2020-11-18T21:02:55Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/annxingyuan>@annxingyuan</denchmark-link>\n  i can repro this issue (or at least one that seems related) with the sample webpack project in the repo. For the code mentioned in the issue, it this part of emscripten's output?\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "evanw", "commentT": "2020-11-19T16:26:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tafsiri>@tafsiri</denchmark-link>\n  Yes, the code is part of emscripten's output. However we prepend code to it when converting it to a blob.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "evanw", "commentT": "2020-11-19T16:28:03Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/tafsiri>@tafsiri</denchmark-link>\n  Do you think this needs the release blocker tag since it is not specific to master?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "evanw", "commentT": "2020-11-19T16:49:49Z", "comment_text": "\n \t\tHmm I was thinking so because the example in the repo doesn't work in current form? What do you think?\n I think with a closer look we can decide whether we want to this to block the next release (for example if we have to file an upstream bug with emscripten). But thought we should at least investigate before doing another release.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "evanw", "commentT": "2020-11-19T19:39:45Z", "comment_text": "\n \t\tWork-in-progress PR: <denchmark-link:https://github.com/emscripten-core/emscripten/pull/12832>emscripten-core/emscripten#12832</denchmark-link>\n \n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "evanw", "commentT": "2020-12-16T00:01:07Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tfjs/issues/4253>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tfjs/issues/4253>No</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "9d8ca6eeb2c9d61f650a006483b60bc862d2ecca", "commit_author": "Ann Yuan", "commitT": "2020-12-15 19:01:05-05:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-wasm\\src\\backend_wasm.ts", "file_new_name": "tfjs-backend-wasm\\src\\backend_wasm.ts", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "274", "deleted_lines": "274"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-wasm\\src\\cc\\BUILD", "file_new_name": "tfjs-backend-wasm\\src\\cc\\BUILD", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "70", "deleted_lines": null}}}, "file_2": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tfjs-backend-wasm\\toolchain\\emscripten_threaded_module_prejs.js"}}}}