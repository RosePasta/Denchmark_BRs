{"BR": {"BR_id": "4267", "BR_author": "jenojp", "BRopenT": "2019-09-10T14:10:54Z", "BRcloseT": "2019-09-18T19:37:18Z", "BR_text": {"BRsummary": "Different ent_iob behavior after adding EntityRuler to pipeline", "BRdescription": "\n I'm not totally sure of the expected behavior but after adding an EntityRuler to a pipeline, non entities seem to get .ent_iob tags of 0 rather than 2 when just using the EntityRecognizer. This affects what doc.is_nered returns.\n <denchmark-h:h2>How to reproduce the behaviour</denchmark-h>\n \n import spacy\n from spacy.pipeline import EntityRuler\n \n nlp = spacy.load(\"en_core_web_sm\")\n print(nlp.pipe_names)\n ## ['tagger', 'parser', 'ner']\n \n doc = nlp(\"fgfgdghgdh\")\n print(doc.is_nered)\n ## True\n \n for token in doc:\n     print(token.ent_iob)\n ## 2\n \n #addd entity ruler and run again\n ruler = EntityRuler(nlp)\n patterns = [{\"label\":\"SOFTWARE\", \"pattern\":\"spacy\"}]\n \n ruler.add_patterns(patterns)\n nlp.add_pipe(ruler)\n print(nlp.pipe_names)\n ## ['tagger', 'parser', 'ner', 'entity_ruler']\n \n doc = nlp(\"fgfgdghgdh\")\n print(doc.is_nered)\n ## False\n \n for token in doc:\n     print(token.ent_iob)\n ## 0\n <denchmark-h:h2>Your Environment</denchmark-h>\n \n <denchmark-h:h2>Info about spaCy</denchmark-h>\n \n \n spaCy version: 2.1.8\n Platform: Darwin-18.7.0-x86_64-i386-64bit\n Python version: 3.6.8\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jenojp", "commentT": "2019-09-10T20:07:04Z", "comment_text": "\n \t\tThanks for the report! I do think this is a bug. From the docs about EntityRuler:\n \n If it\u2019s added before the \"ner\" component, the entity recognizer will respect the existing entity spans and adjust its predictions around it. This can significantly improve accuracy in some cases. If it\u2019s added after the \"ner\" component, the entity ruler will only add spans to the doc.ents if they don\u2019t overlap with existing entities predicted by the model.\n \n In this case it's added after the ner, and it should respect the NER annotations. Even if there are no entities found by the NER, I would still expect -as a user- that doc.is_nered would have stayed True.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "jenojp", "commentT": "2019-09-10T20:20:18Z", "comment_text": "\n \t\tHuh, setting doc.ents does this:\n \n \n \n spaCy/spacy/tokens/doc.pyx\n \n \n         Lines 547 to 550\n       in\n       669a7d3\n \n \n \n \n \n \n  for i in range(self.length): \n \n \n \n  self.c[i].ent_type = 0 \n \n \n \n  self.c[i].ent_kb_id = 0 \n \n \n \n  self.c[i].ent_iob = 0 # Means missing. \n \n \n \n \n \n Maybe the resetting loop should preserve 2 in cases where it's 2? I'm not sure if there are some side effects I'm not thinking of...\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "jenojp", "commentT": "2019-09-10T20:33:16Z", "comment_text": "\n \t\tHa, yea, I was just looking at the same. One approach would be to set the default  to 2 instead of 0 if , see <denchmark-link:https://github.com/svlandeg/spaCy/commit/a6c137f82a68e0fa29a8869ae6c87612e7182e4b>here</denchmark-link>\n , but that makes another unit test fail...\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "jenojp", "commentT": "2019-09-10T20:39:22Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/honnibal>@honnibal</denchmark-link>\n  : I guess this discussion has been had in the <denchmark-link:https://github.com/explosion/spaCy/commit/7d4687162f1792111902754690297a3b0bc86237#diff-c80066060b9c4b494e7e89fe77fb823b>past </denchmark-link>\n ... So it is in fact desired behaviour that the setting of  resets everything to 0 (empty string) ? What about the original case discussed in this topic - would you expect the  to be reset to 0 (empty string) as well?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "jenojp", "commentT": "2019-09-10T20:40:46Z", "comment_text": "\n \t\tI don't think it's possible to have the behavior in test_doc_add_entities_set_ents_iob and the correct is_nered, at least not without major changes to is_nered. I'm not sure why we would want the behavior in test_doc_add_entities_set_ents_iob, though?\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "jenojp", "commentT": "2019-09-14T09:36:31Z", "comment_text": "\n \t\tOk it turns out this requires a more in-depth analysis and solution ;-) Will look into it ASAP.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "jenojp", "commentT": "2019-10-18T20:08:07Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "de5a9ecdf3e60240c78526d04aaa0931e3e825a6", "commit_author": "Sofie Van Landeghem", "commitT": "2019-09-18 21:37:17+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\errors.py", "file_new_name": "spacy\\errors.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "121", "deleted_lines": "121"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\syntax\\ner.pyx", "file_new_name": "spacy\\syntax\\ner.pyx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "69,70,165,269,285,286,329,341,342,344,345,346,347,348,349,350,351,352,353,354,403,404,409,411,412,413,414,415,416,417,470,471,472,473,474", "deleted_lines": "69,164,165,269,285,286,338,339,342,343,390,398,400,453,456,457,458"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\syntax\\nn_parser.pyx", "file_new_name": "spacy\\syntax\\nn_parser.pyx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "138,139,140", "deleted_lines": "138"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "spacy\\tests\\doc\\test_add_entities.py", "file_new_name": "spacy\\tests\\doc\\test_add_entities.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "27,28,29,30,31,32,33,34,35", "deleted_lines": null, "method_info": {"method_name": "test_ents_reset", "method_params": "en_vocab", "method_startline": "27", "method_endline": "35"}}, "hunk_1": {"Ismethod": 1, "added_lines": "19,21,22,24", "deleted_lines": "20,22", "method_info": {"method_name": "test_doc_add_entities_set_ents_iob", "method_params": "en_vocab", "method_startline": "11", "method_endline": "24"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 8, "file_old_name": "spacy\\tests\\parser\\test_ner.py", "file_new_name": "spacy\\tests\\parser\\test_ner.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "224,225,226", "deleted_lines": null, "method_info": {"method_name": "__call__", "method_params": "self,doc", "method_startline": "224", "method_endline": "226"}}, "hunk_1": {"Ismethod": 1, "added_lines": "132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152", "deleted_lines": null, "method_info": {"method_name": "test_overwrite_token", "method_params": "", "method_startline": "132", "method_endline": "152"}}, "hunk_2": {"Ismethod": 1, "added_lines": "85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129", "deleted_lines": "85,86,87,88,89,90,91,92,93", "method_info": {"method_name": "test_accept_blocked_token", "method_params": "", "method_startline": "85", "method_endline": "129"}}, "hunk_3": {"Ismethod": 1, "added_lines": "85,86,87,88,89,90,91,92,93", "deleted_lines": "83,84,85,86,87,88,89,90,91,92,93", "method_info": {"method_name": "test_doc_add_entities_set_ents_iob", "method_params": "en_vocab", "method_startline": "83", "method_endline": "93"}}, "hunk_4": {"Ismethod": 1, "added_lines": "155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175", "deleted_lines": null, "method_info": {"method_name": "test_ruler_before_ner", "method_params": "", "method_startline": "155", "method_endline": "175"}}, "hunk_5": {"Ismethod": 1, "added_lines": "178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198", "deleted_lines": null, "method_info": {"method_name": "test_ner_before_ruler", "method_params": "", "method_startline": "178", "method_endline": "198"}}, "hunk_6": {"Ismethod": 1, "added_lines": "220,221,222", "deleted_lines": null, "method_info": {"method_name": "__init__", "method_params": "self,start,end", "method_startline": "220", "method_endline": "222"}}, "hunk_7": {"Ismethod": 1, "added_lines": "201,202,203,204,205,206,207,208,209,210,211,212,213,214", "deleted_lines": null, "method_info": {"method_name": "test_block_ner", "method_params": "", "method_startline": "201", "method_endline": "214"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "spacy\\tests\\regression\\test_issue1-1000.py", "file_new_name": "spacy\\tests\\regression\\test_issue1-1000.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "429", "deleted_lines": "429", "method_info": {"method_name": "test_issue999", "method_params": "train_data", "method_startline": "426", "method_endline": "471"}}}}, "file_6": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "spacy\\tests\\regression\\test_issue4267.py"}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\doc.pyx", "file_new_name": "spacy\\tokens\\doc.pyx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "259,528,529,532,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570", "deleted_lines": "259,528,529,530,531,532,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568"}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "spacy\\tokens\\token.pyx", "file_new_name": "spacy\\tokens\\token.pyx", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "752,753", "deleted_lines": "752"}}}}}}