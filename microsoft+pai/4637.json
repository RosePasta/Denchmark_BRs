{"BR": {"BR_id": "4637", "BR_author": "Binyang2014", "BRopenT": "2020-06-22T08:22:41Z", "BRcloseT": "2020-06-27T13:26:53Z", "BR_text": {"BRsummary": "Jobs which mounted to the same Azure-Blob can not run on the same node", "BRdescription": "\n When two jobs which mounted to the same azure-blob scheduled to the same node, one job will be stuck in waiting status.\n And the error log is: Error: temp directory '/tmp/blobfuse' is not empty. blobfuse needs an empty temp directory\n This is a bug of blob flex-volume: <denchmark-link:https://github.com/Azure/kubernetes-volume-drivers/blob/3f77fd816170083b2575af5858eb3b47368c7f65/flexvolume/blobfuse/deployment/blobfuse-flexvol-installer/blobfuse#L107>https://github.com/Azure/kubernetes-volume-drivers/blob/3f77fd816170083b2575af5858eb3b47368c7f65/flexvolume/blobfuse/deployment/blobfuse-flexvol-installer/blobfuse#L107</denchmark-link>\n  , all jobs using the same temp path. So only the first comes job will mounted successfully.\n Consider to use  instead of blob-flex-volume.\n <denchmark-link:https://github.com/kubernetes-sigs/blobfuse-csi-driver>https://github.com/kubernetes-sigs/blobfuse-csi-driver</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Binyang2014", "commentT": "2020-06-22T10:38:05Z", "comment_text": "\n \t\tAs a workaround, add the entrypoint (command and args) in flexvolume driver, it'll insert a patch in binary.\n apiVersion: apps/v1\n kind: DaemonSet\n metadata:\n   name: blobfuse-flexvol-installer\n   namespace: kube-system\n   labels:\n     k8s-app: blobfuse\n spec:\n   selector:\n     matchLabels:\n       name: blobfuse\n   template:\n     metadata:\n       labels:\n         name: blobfuse\n     spec:\n       containers:\n         - name: blobfuse-flexvol-installer\n           image: mcr.microsoft.com/k8s/flexvolume/blobfuse-flexvolume:1.0.13\n           imagePullPolicy: IfNotPresent\n           command: [\"/bin/sh\"],\n           args: [\"-c\", \"sed -i '101i TMP_PATH=$(echo ${TMP_PATH}-$(date +%N))' /blobfuse/blobfuse && /bin/install_blobfuse_flexvol.sh\"],\n           volumeMounts:\n             - name: volplugins\n               mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/\n             - name: varlog\n               mountPath: /var/log/\n       volumes:\n         - name: varlog\n           hostPath:\n             path: /var/log/\n         - name: volplugins\n           hostPath:\n             path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec/\n       nodeSelector:\n         beta.kubernetes.io/os: linux\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Binyang2014", "commentT": "2020-06-23T14:35:55Z", "comment_text": "\n \t\tthis is a bug in azureblob. When installing blob driver, customers are recommended to use the above yaml to deploy the flexvolume driver to their k8s cluster.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Binyang2014", "commentT": "2020-06-24T06:24:40Z", "comment_text": "\n \t\tAccording to <denchmark-link:https://github.com/Azure/kubernetes-volume-drivers/issues/66#issuecomment-648616377>Azure/kubernetes-volume-drivers#66 (comment)</denchmark-link>\n  Azure blob flexvolume is in maintenance mode, and Azure blob CSI is recommended.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "Binyang2014", "commentT": "2020-06-24T07:19:52Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/microsoft/pai/pull/4644>#4644</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "Binyang2014", "commentT": "2020-06-25T03:15:48Z", "comment_text": "\n \t\toffer you another workaround, downgrade blobfuse binary to 1.1.1 :\n <denchmark-link:https://github.com/Azure/kubernetes-volume-drivers/issues/66#issuecomment-649188681>Azure/kubernetes-volume-drivers#66 (comment)</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "f6bb04b3fb079b16945587af3bef72ebd20961fe", "commit_author": "Yifan Xiong", "commitT": "2020-06-27 21:26:52+08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "docs\\manual\\cluster-admin\\how-to-set-up-storage.md", "file_new_name": "docs\\manual\\cluster-admin\\how-to-set-up-storage.md", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "110,111,112", "deleted_lines": null}}}}}}