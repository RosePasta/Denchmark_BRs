{"BR": {"BR_id": "4601", "BR_author": "AlexDBlack", "BRopenT": "2018-02-02T09:15:47Z", "BRcloseT": "2018-02-03T01:46:36Z", "BR_text": {"BRsummary": "Workspace crash on input array migration", "BRdescription": "\n Requires the following PR to reproduce:\n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/pull/4600>https://github.com/deeplearning4j/deeplearning4j/pull/4600</denchmark-link>\n \n <denchmark-code>    @Test\n     public void debugMigrateCrash() {\n         WorkspaceMode ws = WorkspaceMode.SINGLE;\n \n         Nd4j.getRandom().setSeed(123);\n         ComputationGraphConfiguration conf = new NeuralNetConfiguration.Builder()\n                 .weightInit(WeightInit.XAVIER)\n                 .inferenceWorkspaceMode(WorkspaceMode.NONE)\n                 .trainingWorkspaceMode(ws)\n                 .graphBuilder()\n                 .addInputs(\"in\")\n                 .addLayer(\"0\", new DenseLayer.Builder().nIn(4).nOut(3).activation(Activation.TANH).build(), \"in\")\n                 .addLayer(\"1\", new org.deeplearning4j.nn.conf.layers.OutputLayer.Builder(\n                                 LossFunctions.LossFunction.MCXENT).activation(Activation.SOFTMAX).nIn(3).nOut(3)\n                                 .build(),\"0\")\n                 .setOutputs(\"1\")\n                 .build();\n \n \n         ComputationGraph network = new ComputationGraph(conf);\n         network.init();\n \n         DataSetIterator iter = new IrisDataSetIterator(50, 150);\n \n         //iter = new AsyncShieldDataSetIterator(iter);    //Async shield: no more JVM crash\n \n         for (int i = 0; i < 100; i++) {\n             log.info(\"Fit \" + i);\n             network.fit(iter);\n         }\n     }\n </denchmark-code>\n \n JVM crash log:\n <denchmark-link:https://gist.github.com/AlexDBlack/29cdf35346304a57f87e640033e858fe>https://gist.github.com/AlexDBlack/29cdf35346304a57f87e640033e858fe</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "AlexDBlack", "commentT": "2018-02-02T19:27:52Z", "comment_text": "\n \t\tAre you sure it's not specific for this Iterator implementation? There's obvious use-after-reset possible internally, which can cause weird things, like that crash.\n i.e. curr in BaseDataFetcher gets allocated in spilled area, and reset just resets cursor. So on hasMore()/next() call the same curr instance gets sent through the pipeline, despite pointer was invalidated.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "AlexDBlack", "commentT": "2018-02-02T20:03:45Z", "comment_text": "\n \t\tMmm, no. that's not the case.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "AlexDBlack", "commentT": "2018-02-02T20:35:41Z", "comment_text": "\n \t\tStale pointer in labels field of output layer. Details are in pm.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "AlexDBlack", "commentT": "2018-02-03T01:46:36Z", "comment_text": "\n \t\tConfirmed that this seems to be due to migrating old / out of scope array.\n Fixed here: <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/pull/4600>https://github.com/deeplearning4j/deeplearning4j/pull/4600</denchmark-link>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "AlexDBlack", "commentT": "2018-09-23T15:26:10Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "89e1643e5ace0c57d369925b2f08658f7e8c8e0c", "commit_author": "Alex Black", "commitT": "2018-02-03 12:20:42+11:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "deeplearning4j-core\\src\\test\\java\\org\\deeplearning4j\\nn\\graph\\TestComputationGraphNetwork.java", "file_new_name": "deeplearning4j-core\\src\\test\\java\\org\\deeplearning4j\\nn\\graph\\TestComputationGraphNetwork.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "915", "deleted_lines": "913", "method_info": {"method_name": "TestComputationGraphNetwork::testIterationCountAndPresistence", "method_params": "", "method_startline": "913", "method_endline": "949"}}, "hunk_1": {"Ismethod": 1, "added_lines": "915", "deleted_lines": null, "method_info": {"method_name": "TestComputationGraphNetwork::testIterationCountAndPersistence", "method_params": "", "method_startline": "915", "method_endline": "951"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\ComputationGraph.java", "file_new_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\ComputationGraph.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "3616,3617,3618,3621,3622", "deleted_lines": "3616,3617,3620,3621", "method_info": {"method_name": "ComputationGraph::clearLayersStates", "method_params": "", "method_startline": "3615", "method_endline": "3624"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\vertex\\BaseGraphVertex.java", "file_new_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\graph\\vertex\\BaseGraphVertex.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "158", "deleted_lines": null, "method_info": {"method_name": "BaseGraphVertex::clear", "method_params": "", "method_startline": "154", "method_endline": "159"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\layers\\BaseOutputLayer.java", "file_new_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\layers\\BaseOutputLayer.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "378,379,380,381", "deleted_lines": null, "method_info": {"method_name": "BaseOutputLayer<LayerConfT::clear", "method_params": "", "method_startline": "374", "method_endline": "382"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\multilayer\\MultiLayerNetwork.java", "file_new_name": "deeplearning4j-nn\\src\\main\\java\\org\\deeplearning4j\\nn\\multilayer\\MultiLayerNetwork.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "3280,3281,3282", "deleted_lines": "3280,3281,3282,3283", "method_info": {"method_name": "MultiLayerNetwork::clearLayersStates", "method_params": "", "method_startline": "3279", "method_endline": "3284"}}}}}}}