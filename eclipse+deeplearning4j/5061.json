{"BR": {"BR_id": "5061", "BR_author": "ghost(ghost)", "BRopenT": "2018-05-05T17:10:49Z", "BRcloseT": "2018-05-07T08:08:32Z", "BR_text": {"BRsummary": "Conv1D -&gt; Flatten Not Working in Keras Loader (1.0.0-alpha)", "BRdescription": "\n Hello,\n I have trained and stored a Keras model, but I cannot import it into DL4J.\n <denchmark-code>[INFO] 2018-05-05 09:59:36,540 [Reflections:229] Reflections took 5985 ms to scan 168 urls, producing 3656 keys and 15809 values \n [INFO] 2018-05-05 09:59:37,070 [MultiLayerNetwork:55] Starting MultiLayerNetwork with WorkspaceModes set to [training: SEPARATE; inference: SEPARATE]\n \n java.lang.IllegalStateException: Mis matched lengths: [2048] != [32768] - Array 1 shape: [16, 128], array 2 shape: [256, 128]\n \n at org.nd4j.linalg.util.LinAlgExceptions.assertSameLength(LinAlgExceptions.java:42)\n at org.nd4j.linalg.api.ops.BaseTransformOp.<init>(BaseTransformOp.java:174)\n at org.nd4j.linalg.api.ops.impl.transforms.Set.<init>(Set.java:43)\n at org.nd4j.linalg.api.ndarray.BaseNDArray.assign(BaseNDArray.java:1274)\n at org.deeplearning4j.nn.layers.BaseLayer.setParam(BaseLayer.java:204)\n </denchmark-code>\n \n My Keras model is structured as follows:\n <denchmark-code>model = Sequential()\n model.add(Embedding(len(word_index) + 1, embedding_size,\n                 weights=[embedding_matrix],\n                 input_length=MAX_SEQUENCE_LENGTH,\n                 trainable=True))\n \n model.add(Conv1D(128, 5, activation='relu'))\n model.add(Conv1D(64, 5, activation='relu'))\n model.add(Conv1D(32, 5, activation='relu'))\n model.add(Conv1D(16, 5, activation='relu'))\n model.add(Flatten())\n model.add(Dense(128, activation='relu'))\n model.add(Dropout(0.2))\n model.add(Dense(Y.shape[1], activation='softmax'))\n </denchmark-code>\n \n One thing that is not immediately clear is where the 256 comes from above in Array 2 shape.  But it does appear to be an issue between the last convolutional layer and the flattening.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ghost(ghost)", "commentT": "2018-05-05T19:10:58Z", "comment_text": "\n \t\tI'll look into Flatten and Reshape next week and add you example as unit test. thanks @mobiusinversion\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "ghost(ghost)", "commentT": "2018-05-07T08:07:56Z", "comment_text": "\n \t\t@mobiusinversion we have a complete e2e test for your use case, works on master and should also work on snapshots already. this has been around for a while, so I'm not exactly sure why this happens for you. See here:\n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/scripts/embedding_conv1d_extended.py#L24-L32>https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/scripts/embedding_conv1d_extended.py#L24-L32</denchmark-link>\n \n <denchmark-link:https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L52-L56>https://github.com/deeplearning4j/deeplearning4j/blob/4f2079cfcc86dd5b74a9cfcf0ea022691969a471/deeplearning4j-modelimport/src/test/java/org/deeplearning4j/nn/modelimport/keras/weights/KerasWeightSettingTests.java#L52-L56</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "ghost(ghost)", "commentT": "2018-09-22T05:24:10Z", "comment_text": "\n \t\tThis thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.\n \t\t"}}}, "commit": {"commit_id": "6856077ce5aa71237d7a52d36e62e5d8afcacd3f", "commit_author": "maxpumperla", "commitT": "2018-05-07 10:05:18+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\KerasWeightSettingTests.java", "file_new_name": "deeplearning4j-modelimport\\src\\test\\java\\org\\deeplearning4j\\nn\\modelimport\\keras\\weights\\KerasWeightSettingTests.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "126", "deleted_lines": "126", "method_info": {"method_name": "KerasWeightSettingTests::importConv1DFlatten", "method_params": "modelPath", "method_startline": "118", "method_endline": "129"}}, "hunk_1": {"Ismethod": 1, "added_lines": "200", "deleted_lines": "200", "method_info": {"method_name": "KerasWeightSettingTests::importEmbeddingConv1D", "method_params": "modelPath", "method_startline": "185", "method_endline": "204"}}, "hunk_2": {"Ismethod": 1, "added_lines": "175", "deleted_lines": "175", "method_info": {"method_name": "KerasWeightSettingTests::importEmbeddingLstm", "method_params": "modelPath", "method_startline": "161", "method_endline": "179"}}}}}}}