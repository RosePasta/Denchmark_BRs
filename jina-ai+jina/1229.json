{"BR": {"BR_id": "1229", "BR_author": "cristianmtr", "BRopenT": "2020-11-06T08:48:59Z", "BRcloseT": "2020-12-03T17:53:42Z", "BR_text": {"BRsummary": "crash when sharding without batching", "BRdescription": "\n Describe the bug\n When attempting to upgrade the multires lyrics examples to use sharding, I encountered a bug that produced the following error at query time:\n <denchmark-code>Traceback (most recent call last):\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/peapods/pea.py\", line 292, in msg_callback\n     self.zmqlet.send_message(self._callback(msg))\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/peapods/pea.py\", line 266, in _callback\n     self.pre_hook(msg).handle(msg).post_hook(msg)\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/peapods/pea.py\", line 160, in handle\n     self.executor(self.request_type)\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/executors/__init__.py\", line 570, in __call__\n     d()\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/drivers/__init__.py\", line 251, in __call__\n     self._traverse_apply(self.req.docs, *args, **kwargs)\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/drivers/__init__.py\", line 268, in _traverse_apply\n     **kwargs,\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/drivers/__init__.py\", line 281, in _traverse_rec\n     doc.chunks, doc, 'chunks', path[1:], *args, **kwargs\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/drivers/__init__.py\", line 284, in _traverse_rec\n     self._apply_all(docs, parent_doc, parent_edge_type, *args, **kwargs)\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/drivers/search.py\", line 124, in _apply_all\n     idx, dist = self.exec_fn(embed_vecs, top_k=int(self.top_k))\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/executors/indexers/vector.py\", line 279, in query\n     dist = self._euclidean(_keys, self.query_handler)\n   File \"/home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/executors/decorators.py\", line 241, in arg_wrapper\n     for b in batch_iterator(data[:total_size], b_size, split_over_axis, yield_slice=yield_slice):\n TypeError: 'NoneType' object is not subscriptable\n </denchmark-code>\n \n See discussion and experiments in <denchmark-link:https://github.com/jina-ai/examples/pull/271>this PR</denchmark-link>\n \n The problem seems to be as follows.\n \n We should inform users that if they use sharding, they need to use batching.\n If a shard is empty, is should still return an empty list of results.\n \n Describe how you solve it\n In order to fix this, we need to use batching. See ex. v3 in the PR above.\n <denchmark-h:hr></denchmark-h>\n \n Environment\n <denchmark-code>$ jina -vf\n jina                          0.7.4\n jina-proto                    0.0.74\n jina-vcs-tag                  (unset)\n libzmq                        4.3.2\n pyzmq                         1.19.4\n protobuf                      3.13.0\n proto-backend                 cpp\n grpcio                        1.33.2\n ruamel.yaml                   0.16.12\n python                        3.7.5\n platform                      Linux\n platform-release              5.4.0-52-generic\n platform-version              #57-Ubuntu SMP Thu Oct 15 10:57:00 UTC 2020\n architecture                  x86_64\n processor                     x86_64\n jina-resources                /home/cristian/envs/lyrics/lib/python3.7/site-packages/jina/resources\n JINA_ARRAY_QUANT              (unset)\n JINA_BINARY_DELIMITER         (unset)\n JINA_CONTRIB_MODULE           (unset)\n JINA_CONTRIB_MODULE_IS_LOADING(unset)\n JINA_CONTROL_PORT             (unset)\n JINA_DB_COLLECTION            (unset)\n JINA_DB_HOSTNAME              (unset)\n JINA_DB_NAME                  (unset)\n JINA_DB_PASSWORD              (unset)\n JINA_DB_USERNAME              (unset)\n JINA_DEFAULT_HOST             (unset)\n JINA_DISABLE_UVLOOP           (unset)\n JINA_EXECUTOR_WORKDIR         (unset)\n JINA_FULL_CLI                 (unset)\n JINA_IPC_SOCK_TMP             (unset)\n JINA_LOG_CONFIG               (unset)\n JINA_LOG_NO_COLOR             (unset)\n JINA_POD_NAME                 (unset)\n JINA_PROFILING                (unset)\n JINA_RANDOM_PORTS             (unset)\n JINA_SOCKET_HWM               (unset)\n JINA_TEST_GPU                 (unset)\n JINA_TEST_PRETRAINED          (unset)\n JINA_VCS_VERSION              (unset)\n JINA_WARN_UNNAMED             (unset)\n </denchmark-code>\n \n Screenshots\n Workspace directory, when not using batch (ex v1 and v2)\n <denchmark-link:https://user-images.githubusercontent.com/8330330/98345387-e5b1c680-2014-11eb-9c0d-c14171e672f3.png></denchmark-link>\n \n Workspace directory, when we use batching (ex v3)\n <denchmark-link:https://user-images.githubusercontent.com/8330330/98345425-f2361f00-2014-11eb-8805-62d2538d686b.png></denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "cristianmtr", "commentT": "2020-11-06T08:56:09Z", "comment_text": "\n \t\tHere the issue is that when batch_size is larger than the size of the data, the load balancer in HeadPea does not send any data to that shard, leaving this shard empty. (That is for me not an issue).\n The thing is we need to decide what to do when a shard is empty (I think the indexer should be robust to not having any data and maybe just raise a warning that the index in that shard is empty.\n Note\n When I talk about shard is to understand each other, but ideally a Pea , driver or executor should be unaware of them being a shard (at least for now).\n Wrap up\n Need to make Indexers and SearchDrivers (robust to having no documents) indexed and just return no matches. (Most of the effort should be make on testing and integration testing).\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "cristianmtr", "commentT": "2020-11-27T00:41:03Z", "comment_text": "\n \t\tThis issue is stale because it has been open 20 days with no activity. Remove stale label or comment or this will be closed in 4 days\n \t\t"}}}, "commit": {"commit_id": "1ecf2d74179f29f196a964f6d779b1a32bf78e7c", "commit_author": "cristian", "commitT": "2020-12-03 18:53:41+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "jina\\executors\\decorators.py", "file_new_name": "jina\\executors\\decorators.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "247", "deleted_lines": "247", "method_info": {"method_name": "_batching", "method_params": "func", "method_startline": "237", "method_endline": "292"}}, "hunk_1": {"Ismethod": 1, "added_lines": "247", "deleted_lines": "247", "method_info": {"method_name": "_batching.arg_wrapper", "method_params": "args,kwargs", "method_startline": "239", "method_endline": "290"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "jina\\executors\\indexers\\vector.py", "file_new_name": "jina\\executors\\indexers\\vector.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "263,275,276", "deleted_lines": "263", "method_info": {"method_name": "query", "method_params": "self,int,args,kwargs", "method_startline": "263", "method_endline": "289"}}}}, "file_2": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "tests\\integration\\issues\\github_1229\\__init__.py", "file_new_name": "tests\\integration\\issues\\github_1229\\__init__.py"}, "file_3": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tests\\integration\\issues\\github_1229\\test_sharding_empty_index.py"}, "file_4": {"file_change_type": "ADD", "file_Nmethod": 0, "file_old_name": "None", "file_new_name": "tests\\integration\\issues\\github_1229\\vectorindexer.yml"}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\unit\\executors\\indexers\\test_numpyindexer.py", "file_new_name": "tests\\unit\\executors\\indexers\\test_numpyindexer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184", "deleted_lines": null, "method_info": {"method_name": "test_numpy_indexer_empty_data", "method_params": "batch_size,compress_level,test_metas", "method_startline": "166", "method_endline": "184"}}}}}}}