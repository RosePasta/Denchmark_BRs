{"BR": {"BR_id": "2615", "BR_author": "PaperclipBadger", "BRopenT": "2020-09-02T13:25:33Z", "BRcloseT": "2020-09-03T22:46:48Z", "BR_text": {"BRsummary": "[bug] Samples from LKJCorrCholesky have the wrong shape", "BRdescription": "\n <denchmark-h:h3>Issue Description</denchmark-h>\n \n The batch and sample shapes for LKJCorrCholesky are swapped when sampling.\n <denchmark-h:h3>Environment</denchmark-h>\n \n OS: Ubuntu 16.04\n Python: 3.7.2\n Torch version: 1.6.0\n Pyro version: 1.4.0\n <denchmark-h:h3>Code Snippet</denchmark-h>\n \n Minimal example:\n >>> dist = pyro.distributions.LKJCorrCholesky(d=3, eta=torch.ones(())).expand(12)\n >>> # batch shape and event shape are as you'd expect\n >>> dist.batch_shape\n torch.Size([12])\n >>> dist.event_shape\n torch.Size([3, 3])\n >>> # samples have correct shape when sample_shape=()\n >>> dist.shape(())\n torch.Size([12, 3, 3])\n >>> dist.sample().shape\n torch.Size([12, 3, 3])\n >>> # samples have the wrong shape when sample_shape is non-unit\n >>> dist.shape((4,))  # as expected\n torch.Size([4, 12, 3, 3])\n >>> dist.sample((4,)).shape\n torch.Size([12, 4, 3, 3])\n I think this line is the culprit: \n \n \n pyro/pyro/distributions/lkj.py\n \n \n          Line 67\n       in\n       7c2c22c\n \n \n \n \n \n \n  y = self._gen.sample(sample_shape=self.batch_shape + sample_shape).detach() \n \n \n \n \n \n     def sample(self, sample_shape=torch.Size()):\n         y = self._gen.sample(sample_shape=self.batch_shape + sample_shape).detach()\n         z = y.mul(2).add(-1.0)\n         return _vector_to_l_cholesky(z)\n should be\n     def sample(self, sample_shape=torch.Size()):\n         y = self._gen.sample(sample_shape=sample_shape + self.batch_shape).detach()\n         z = y.mul(2).add(-1.0)\n         return _vector_to_l_cholesky(z)\n \t"}, "comments": {}}, "commit": {"commit_id": "a46368d016aad516ad119432e58ddbb39be2e7b9", "commit_author": "Fritz Obermeyer", "commitT": "2020-09-03 17:46:47-05:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "pyro\\distributions\\lkj.py", "file_new_name": "pyro\\distributions\\lkj.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "67,68", "deleted_lines": "67", "method_info": {"method_name": "sample", "method_params": "self,sample_shape", "method_startline": "66", "method_endline": "70"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tests\\distributions\\test_lkj.py", "file_new_name": "tests\\distributions\\test_lkj.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "114,115,116,117,118,119,120,121,122,123,124,125", "deleted_lines": null, "method_info": {"method_name": "test_sample_batch", "method_params": "", "method_startline": "114", "method_endline": "125"}}}}}}}