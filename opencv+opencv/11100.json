{"BR": {"BR_id": "11100", "BR_author": "lamantine", "BRopenT": "2018-03-17T21:38:17Z", "BRcloseT": "2018-03-18T12:11:43Z", "BR_text": {"BRsummary": "Integer overflow in kmeans", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 3.4.1\n Operating System / Platform => Windows 64 Bit / Windows 32 Bit\n Compiler => Visual Studio 2017\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n I switched to 3.4.1 from 3.3.0 and my code started failing with BOWKMeansTrainer on the same dataset that worked well in 3.4.1. Error - \"OpenCV(3.4.1-dev) Error: Assertion failed (a >= 0) in cv::divUp\"\n It comes from new code from revision <denchmark-link:https://github.com/opencv/opencv/commit/90aac764dd6e8c77265b1b5d616b0a70d4c74a42>90aac76</denchmark-link>\n  when it tries to calculate divUp(dims * N * K, CV_KMEANS_PARALLEL_GRANULARITY) where in my case:\n dims = 64\n N = 28493\n K = 2000\n And it results in integer overflow (-647863296). Since all multipliers are ints, compiler also calls integer version of divUp.\n Changing could to (size_t)(dims * N * K) fixes the issue.\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n Try to train some large BoW vocabulary.\n \t"}, "comments": {}}, "commit": {"commit_id": "22ecdd16ef902f7c99f746ab83ff473f0ef7b238", "commit_author": "Aleksandr Tischenko", "commitT": "2018-03-18 15:11:42+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "modules\\core\\src\\kmeans.cpp", "file_new_name": "modules\\core\\src\\kmeans.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "131", "deleted_lines": "131", "method_info": {"method_name": "cv::generateCentersPP", "method_params": "data,_out_centers,K,rng,trials", "method_startline": "94", "method_endline": "157"}}, "hunk_1": {"Ismethod": 1, "added_lines": "432,439", "deleted_lines": "432,439", "method_info": {"method_name": "cv::kmeans", "method_params": "_data,K,_bestLabels,criteria,attempts,flags,_centers", "method_startline": "225", "method_endline": "458"}}}}}}}