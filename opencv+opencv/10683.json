{"BR": {"BR_id": "10683", "BR_author": "vs-zhehangd", "BRopenT": "2018-01-25T01:03:25Z", "BRcloseT": "2018-05-28T20:37:31Z", "BR_text": {"BRsummary": "filter2D does not utilize pixels outside ROI when kernel size &gt; 11", "BRdescription": "\n Description\n It is said\n \n ... now the filtering operations fully support the notion of image ROI, that is, pixels outside of the ROI but inside the image can be used in the filtering operations.\n \n I found when calling filter2D to filter an ROI using a kernel larger than 11x11, the function does not utilize the pixels outside the ROI. Probably related to the fact that filter uses DCT instead of convolution beyond that size? I have tested 3.1, 3.2, 3.3, 3.4. This issue happens since 3.2. 3.1 does not have this issue.\n System information\n OpenCV 3.2, 3.3, 3.4\n Ubuntu 16.04\n g++ 5.4.0\n Steps to reproduce\n The following code produces the problem. It divides an image into blocks and filters each of them.\n #include <iostream>\n #include <vector>\n \n #include <opencv2/opencv.hpp>\n \n int main(void) {\n   \n   std::cout << \"OpenCV version : \" << CV_VERSION << std::endl;\n   \n   const char* input_file  = \"roi_filter_test.jpg\";\n   const char* output_file = \"roi_filter_test_output.jpg\";\n   \n   cv::Mat image  = cv::imread(input_file);\n   cv::Mat output = cv::Mat::zeros(image.size(), image.type());\n   \n   int BLOCK_SIZE = 64; // can be any\n   \n   std::vector<cv::Rect> regions;\n   for (int r = 0; r < image.rows / BLOCK_SIZE; ++r)\n     for (int c = 0; c < image.cols / BLOCK_SIZE; ++c)\n       regions.emplace_back(c * BLOCK_SIZE, r * BLOCK_SIZE,\n                            BLOCK_SIZE, BLOCK_SIZE);\n       \n   int ksize  = 12; // issue when > 11\n   int ksize2 = ksize * ksize;\n   cv::Mat kernel = cv::Mat::ones(ksize, ksize, CV_32F) / ksize2;\n     \n   for (const auto& region: regions) {\n     cv::Mat roi_i(image,  region);\n     cv::Mat roi_o(output, region);\n     cv::filter2D(roi_i, roi_o, -1, kernel);\n   }\n   \n   cv::imwrite(output_file, output); \n   \n   return 0;\n }\n \n Input Image:\n <denchmark-link:https://user-images.githubusercontent.com/29877977/35364356-901f386e-0123-11e8-9373-40990bcea6d8.jpg></denchmark-link>\n \n Result @ OpenCV 3.1\n <denchmark-link:https://user-images.githubusercontent.com/29877977/35364363-9a283234-0123-11e8-8b7b-fc1cf41f739c.jpg></denchmark-link>\n \n Result @ OpoenCV 3.2, 3.3, 3.4\n <denchmark-link:https://user-images.githubusercontent.com/29877977/35364369-a3113422-0123-11e8-8c14-00c14623a61d.jpg></denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "vs-zhehangd", "commentT": "2018-02-04T11:13:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/alalek>@alalek</denchmark-link>\n  I would like to fix this issue. Can you get me started? What files to look into and the basic way to fix the problem?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "vs-zhehangd", "commentT": "2018-02-04T13:50:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Riyuzakii>@Riyuzakii</denchmark-link>\n  , probably you should take a look at the function: <denchmark-link:https://github.com/opencv/opencv/blob/e801e336ede0d43cb8e7be698424b7320925b700/modules/imgproc/src/filter.cpp#L4835-L4842>dftFilter2d</denchmark-link>\n  it runs when .\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "vs-zhehangd", "commentT": "2018-02-07T14:42:50Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mshabunin>@mshabunin</denchmark-link>\n , <denchmark-link:https://github.com/vs-zhehangd>@vs-zhehangd</denchmark-link>\n  's your code gives me the following error on executing the executable:\n <denchmark-code>OpenCV version : 3.3.1\n OpenCV Error: Assertion failed (0 <= roi.x && 0 <= roi.width && roi.x + roi.width <= m.cols && 0 <= roi.y && 0 <= roi.height && roi.y + roi.height <= m.rows) in Mat, file /tmp/binarydeb/ros-kinetic-opencv3-3.3.1/modules/core/src/matrix.cpp, line 538\n terminate called after throwing an instance of 'cv::Exception'\n   what():  /tmp/binarydeb/ros-kinetic-opencv3-3.3.1/modules/core/src/matrix.cpp:538: error: (-215) 0 <= roi.x && 0 <= roi.width && roi.x + roi.width <= m.cols && 0 <= roi.y && 0 <= roi.height && roi.y + roi.height <= m.rows in function Mat\n </denchmark-code>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "vs-zhehangd", "commentT": "2018-02-07T16:01:32Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Riyuzakii>@Riyuzakii</denchmark-link>\n  , I've been able to reproduce this issue on my machine using the sample provided in the description. Make sure you have read correct image in .\n In my previous comment I provided wrong condition. As can be seen from the code:\n \n \n \n opencv/modules/imgproc/src/filter.cpp\n \n \n         Lines 4659 to 4661\n       in\n       e801e33\n \n \n \n \n \n \n  int sdepth = CV_MAT_DEPTH(stype); \n \n \n \n  int ddepth = CV_MAT_DEPTH(dtype); \n \n \n \n  int dft_filter_size = ((sdepth == CV_8U && (ddepth == CV_8U || ddepth == CV_16S)) || (sdepth == CV_32F && ddepth == CV_32F)) && checkHardwareSupport(CV_CPU_SSE3) ? 130 : 50; \n \n \n \n \n \n if SSE3 is available, algorithm switches to DFT branch only in case when kernel_w * kernel_h >= 130, that is why kernel size 11 works well and 12 fails.\n If you compare two calls:\n \n \n \n opencv/modules/imgproc/src/filter.cpp\n \n \n         Lines 4835 to 4842\n       in\n       e801e33\n \n \n \n \n \n \n  res = dftFilter2D(stype, dtype, kernel_type, \n \n \n \n                    src_data, src_step, \n \n \n \n                    dst_data, dst_step, \n \n \n \n                    width, height, \n \n \n \n                    kernel_data, kernel_step, \n \n \n \n                    kernel_width, kernel_height, \n \n \n \n                    anchor_x, anchor_y, \n \n \n \n                    delta, borderType); \n \n \n \n \n \n And:\n \n \n \n opencv/modules/imgproc/src/filter.cpp\n \n \n         Lines 4845 to 4854\n       in\n       e801e33\n \n \n \n \n \n \n  ocvFilter2D(stype, dtype, kernel_type, \n \n \n \n              src_data, src_step, \n \n \n \n              dst_data, dst_step, \n \n \n \n              width, height, \n \n \n \n              full_width, full_height, \n \n \n \n              offset_x, offset_y, \n \n \n \n              kernel_data, kernel_step, \n \n \n \n              kernel_width, kernel_height, \n \n \n \n              anchor_x, anchor_y, \n \n \n \n              delta, borderType); \n \n \n \n \n \n You will see that parameters full_width, full_height, offset_x, offset_y are not used in the call to dftFilter2D, thus information about ROI is not available in this function.\n You can try to add missing arguments to the function and handle them correctly, so that underlying calls to crossCorr could use this information.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "vs-zhehangd", "commentT": "2018-02-07T18:14:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mshabunin>@mshabunin</denchmark-link>\n  how did you compile the code? I used a standard CMakeLists.txt and added this line to it:\n <denchmark-code>set (CMAKE_CXX_STANDARD 11)\n </denchmark-code>\n \n Otherwise emplace_back gave an error. and then did a make and executed the executable.\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "vs-zhehangd", "commentT": "2018-02-07T18:27:43Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Riyuzakii>@Riyuzakii</denchmark-link>\n \n Sorry it is a stupid bug:\n for (int r = 0; r < image.cols / BLOCK_SIZE; ++r) {\n   for (int c = 0; c < image.rows / BLOCK_SIZE; ++c) {\n     regions.emplace_back(c * BLOCK_SIZE, r * BLOCK_SIZE,\n                           BLOCK_SIZE, BLOCK_SIZE);\n     \n   }\n }\n Please switch image.cols and image.rows. I used to use a square image so I did not notice it. I have updated the code in the first post.\n \t\t"}}}, "commit": {"commit_id": "2d5d98ec0fafed759c1d99177b17b4a79d1b7f52", "commit_author": "yuki takehara", "commitT": "2018-05-23 20:25:11+00:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "modules\\imgproc\\src\\filter.cpp", "file_new_name": "modules\\imgproc\\src\\filter.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "4646,4647,4670,4671,4684,4687,4698,4700", "deleted_lines": "4646,4669,4670,4683,4686,4697,4699", "method_info": {"method_name": "dftFilter2D", "method_params": "stype,dtype,kernel_type,src_data,src_step,dst_data,dst_step,full_width,full_height,offset_x,offset_y,kernel_data,kernel_step,kernel_width,kernel_height,anchor_x,anchor_y,delta,borderType", "method_startline": "4643", "method_endline": "4708"}}, "hunk_1": {"Ismethod": 1, "added_lines": "4834,4835", "deleted_lines": "4833", "method_info": {"method_name": "cv::hal::filter2D", "method_params": "stype,dtype,kernel_type,src_data,src_step,dst_data,dst_step,width,height,full_width,full_height,offset_x,offset_y,kernel_data,kernel_step,kernel_width,kernel_height,anchor_x,anchor_y,delta,borderType,isSubmatrix", "method_startline": "4794", "method_endline": "4852"}}, "hunk_2": {"Ismethod": 1, "added_lines": "4646,4647,4670,4671,4684,4687,4698,4700", "deleted_lines": "4646,4669,4670,4683,4686,4697,4699", "method_info": {"method_name": "dftFilter2D", "method_params": "stype,dtype,kernel_type,src_data,src_step,dst_data,dst_step,width,height,kernel_data,kernel_step,kernel_width,kernel_height,anchor_x,anchor_y,delta,borderType", "method_startline": "4643", "method_endline": "4707"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "modules\\imgproc\\test\\test_filter.cpp", "file_new_name": "modules\\imgproc\\test\\test_filter.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "2122,2123,2124,2125,2126,2127,2128,2129,2130,2131,2132,2133,2134,2135,2136,2137,2138,2139,2140,2141,2142,2143,2144,2145,2146,2147,2148,2149,2150,2151,2152,2153,2154,2155,2156,2157,2158,2159,2160,2161,2162,2163,2164,2165,2166,2167,2168,2169,2170,2171,2172,2173,2174,2175,2176,2177,2178,2179,2180,2181,2182,2183,2184,2185,2186,2187,2188,2189,2190,2191,2192,2193,2194,2195,2196", "deleted_lines": null, "method_info": {"method_name": "opencv_test::TEST", "method_params": "Imgproc_Filter2D,dftFilter2d_regression_10683", "method_startline": "2122", "method_endline": "2196"}}}}}}}