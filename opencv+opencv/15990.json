{"BR": {"BR_id": "15990", "BR_author": "jlaheurte", "BRopenT": "2019-11-25T13:34:18Z", "BRcloseT": "2019-12-05T18:23:53Z", "BR_text": {"BRsummary": "Windows 64 bits issue with C API", "BRdescription": "\n <denchmark-h:h5>System information (version)</denchmark-h>\n \n \n OpenCV => 3.4.4 and later\n Operating System / Platform => Windows 64 bits\n Compiler => Visual Studio 2017\n \n <denchmark-h:h5>Detailed description</denchmark-h>\n \n Starting with rev. <denchmark-link:https://github.com/opencv/opencv/commit/8a3c394d6af7c8bd197a8b4ce81eadc0dd6de7ce>8a3c394</denchmark-link>\n  C structure constructors are disabled when building OpenCV but enabled when building a program that uses OpenCV. Relevant part of the diff is:\n <denchmark-code>--- a/modules/core/include/opencv2/core/types_c.h\n +++ b/modules/core/include/opencv2/core/types_c.h\n @@ -44,9 +44,7 @@\n  #ifndef OPENCV_CORE_TYPES_H\n  #define OPENCV_CORE_TYPES_H\n  \n -#if !defined(__OPENCV_BUILD) && !defined(CV__DISABLE_C_API_CTORS)\n  #define CV__ENABLE_C_API_CTORS // enable C API ctors (must be removed)\n -#endif\n \n </denchmark-code>\n \n This leads to an interesting problem when using, for instance, cvGetSize. According to <denchmark-link:https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=vs-2017>https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=vs-2017</denchmark-link>\n  when a function returns a struct with a size less than 64 bits:\n \n If it's a POD, it is returned in RAX\n If not, the caller creates a temporary and passes a reference to it in RCX; function arguments are shifted\n \n So here, when building OpenCV, CvSize is a POD, so the function assumes RCX contains the pointer to the CvArr argument. But when using the function, CvSize is not a POD any more, and the caller puts a reference to a temporary CvSize in RCX and the argument in RDX... As you can imagine, this doesn't work very well.\n The workaround is obviously to define CV__DISABLE_C_API_CTORS when building my own code, but such a runtime failure with no warning is a bit disheartening.\n <denchmark-h:h5>Steps to reproduce</denchmark-h>\n \n Use cvGetSize on an IplImage in a 64 bits Windows program. This leads to a \"Bad argument (Array should be CvMat or IplImage)\", unless by change your temporary CvSize has the right magic value packed in...\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "jlaheurte", "commentT": "2019-11-25T14:44:04Z", "comment_text": "\n \t\t\n cvGetSize\n \n similar to <denchmark-link:https://github.com/opencv/opencv/issues/6221>#6221</denchmark-link>\n , but problem here is different.\n \n runtime failure with no warning\n \n Agreed. Compile/linker-time failure is preferable.\n \t\t"}}}, "commit": {"commit_id": "f21bde4d9fddd876cfa85e1d1fbc1b98562262e2", "commit_author": "Alexander Alekhin", "commitT": "2019-12-05 14:48:18+03:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "modules\\core\\include\\opencv2\\core\\types_c.h", "file_new_name": "modules\\core\\include\\opencv2\\core\\types_c.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "47,48,49,50", "deleted_lines": "47,48"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "samples\\cpp\\image.cpp", "file_new_name": "samples\\cpp\\image.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "36,96,123", "deleted_lines": "37,97,124", "method_info": {"method_name": "main", "method_params": "argc,argv", "method_startline": "27", "method_endline": "134"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "samples\\cpp\\tutorial_code\\core\\interoperability_with_OpenCV_1\\interoperability_with_OpenCV_1.cpp", "file_new_name": "samples\\cpp\\tutorial_code\\core\\interoperability_with_OpenCV_1\\interoperability_with_OpenCV_1.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "36,104,136", "deleted_lines": "36,104,136", "method_info": {"method_name": "main", "method_params": "argc,argv", "method_startline": "31", "method_endline": "149"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "samples\\cpp\\tutorial_code\\core\\mat_operations\\mat_operations.cpp", "file_new_name": "samples\\cpp\\tutorial_code\\core\\mat_operations\\mat_operations.cpp", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "134,135", "deleted_lines": "134,135", "method_info": {"method_name": "main", "method_params": "int", "method_startline": "13", "method_endline": "180"}}}}}}}