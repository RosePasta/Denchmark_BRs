{"BR": {"BR_id": "575", "BR_author": "aureooms", "BRopenT": "2020-10-30T15:55:04Z", "BRcloseT": "2020-11-26T23:52:40Z", "BR_text": {"BRsummary": "Removing picture from album does not update the album cover", "BRdescription": "\n If one removes from an album the picture used by its cover, the cover does not get updated to use a different picture from the album. Bug or feature?\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "aureooms", "commentT": "2020-10-30T16:29:37Z", "comment_text": "\n \t\tThat's because it is cached. It will disappear later.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "aureooms", "commentT": "2020-10-31T09:21:14Z", "comment_text": "\n \t\tOk. At what level is it cached? If I open a shared album with deleted cover picture in an incognito/private tab with disabled cache the deleted picture still shows up as a cover. This happens even if the shared link is created after the deletion. There does not seem to be a way to manually change the cover picture. I could recreate the album but that defeats the purpose... I create the album first by selecting all pictures in some time range, then I delete the ones I do not want. If one of the is the cover picture then the cover picture stays there. This is bad if that picture is not meant to be shared for whatever reason.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "aureooms", "commentT": "2020-11-02T07:09:15Z", "comment_text": "\n \t\tOn the server in memory. Expires after one hour or so. Cache should be cleared if album items change, but wasn't a top priority so far.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "aureooms", "commentT": "2020-11-02T08:28:27Z", "comment_text": "\n \t\t\n On the server in memory. Expires after one hour or so. Cache should be cleared if album items change, but wasn't a top priority so far.\n \n It has been more than two weeks than the cover picture was removed from the album but it still shows up in a shared link open in incognito/private tab with disabled cache. I am using NGINX as proxy with the following configuration:\n <denchmark-code>proxy_redirect off;\n proxy_set_header X-Real-IP $remote_addr;\n proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n proxy_set_header Host $http_host;\n \n proxy_http_version 1.1;\n proxy_set_header Upgrade $http_upgrade;\n proxy_set_header Connection \"upgrade\";\n proxy_set_header X-Forwarded-Proto $scheme;\n \n client_max_body_size 30M;\n proxy_buffering off;\n location / {\n     auth_basic 'PLEASE IDENTIFY';\n     auth_basic_user_file /etc/nginx/photoprism.example.tld/.htpasswd;\n     proxy_pass http://localhost:2342;\n }\n \n location ~ ^/(?:s|static|api)/.* { # Disable authentication for shares.\n     auth_basic off;\n     proxy_pass http://localhost:2342;\n }\n </denchmark-code>\n \n I get a 200 OK response for the tile_500 request:\n <denchmark-code>Request URL: https://photoprism.example.tld/api/v1/albums/<blurb>/t/public/tile_500\n Request Method: GET\n Status Code: 200 OK\n Remote Address: <IP ADDRESS>:443\n Referrer Policy: no-referrer-when-downgrade\n Accept-Ranges: bytes\n Connection: keep-alive\n Content-Length: 112458\n Content-Type: image/jpeg\n Date: Mon, 02 Nov 2020 06:07:08 GMT\n Last-Modified: Mon, 12 Oct 2020 01:23:45 GMT\n Server: nginx\n Accept: image/avif,image/webp,image/apng,image/*,*/*;q=0.8\n Accept-Encoding: gzip, deflate, br\n Accept-Language: en-US,en;q=0.9\n Connection: keep-alive\n Host: photoprism.example.tld\n Referer: https://photoprism.example.tld/s/<blurb>\n Sec-Fetch-Dest: image\n Sec-Fetch-Mode: no-cors\n Sec-Fetch-Site: same-origin\n User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36\n </denchmark-code>\n \n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "aureooms", "commentT": "2020-11-02T08:58:08Z", "comment_text": "\n \t\tHere is the code for you to review: <denchmark-link:https://github.com/photoprism/photoprism/blob/develop/internal/api/thumbs.go#L204>https://github.com/photoprism/photoprism/blob/develop/internal/api/thumbs.go#L204</denchmark-link>\n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "aureooms", "commentT": "2020-11-08T17:07:15Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/aureooms>@aureooms</denchmark-link>\n  Could you take a look at our code? If you think this is a bug, I might be able to fix it next week. In any case, it should work to clear the cache when an album changes - just wasn't a priority so far. Last week was crazy busy again, so I didn't get to much.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "aureooms", "commentT": "2020-11-10T14:40:49Z", "comment_text": "\n \t\tAlso the cover picture does not update when I restart the server. I am 100% sure the picture used for the cover is not part of the album (it was included at album creation but was removed later). I will look at the code.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "aureooms", "commentT": "2020-11-10T15:06:06Z", "comment_text": "\n \t\tMaybe there is an issue with the db query then: We keep the database row when a photo was removed, maybe the \"hidden\" flag is ignored?\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "aureooms", "commentT": "2020-11-10T15:12:29Z", "comment_text": "\n \t\tHere is what I think is happening:\n \n Deleting a picture from an album sets hidden to true: \n \n \n photoprism/internal/entity/album.go\n \n \n          Line 357\n       in\n       7131db0\n \n \n \n \n \n \n  entry := PhotoAlbum{AlbumUID: m.AlbumUID, PhotoUID: uid, Hidden: true} \n \n \n \n \n \n Getting the album cover does not take the value of hidden into account: \n \n \n photoprism/internal/query/albums.go\n \n \n          Line 81\n       in\n       7131db0\n \n \n \n \n \n \n  Joins(\"JOIN photos_albums pa ON pa.album_uid = albums.album_uid AND pa.photo_uid = files.photo_uid\"). \n \n \n \n \n \n \n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "aureooms", "commentT": "2020-11-10T15:12:44Z", "comment_text": "\n \t\t\n Maybe there is an issue with the db query then: We keep the database row when a photo was removed, maybe the \"hidden\" flag is ignored?\n \n Yes!\n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "aureooms", "commentT": "2020-11-10T15:14:00Z", "comment_text": "\n \t\tCan you point to where hidden is used in order to filter which photos to load in the UI? I was not able to find it.\n \t\t"}, "comments_11": {"comment_id": 12, "comment_author": "aureooms", "commentT": "2020-11-13T04:32:53Z", "comment_text": "\n \t\tWhy not add a button to set album cover ? so this problem is gone\n \t\t"}, "comments_12": {"comment_id": 13, "comment_author": "aureooms", "commentT": "2020-11-14T13:35:13Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/lpnueg4>@lpnueg4</denchmark-link>\n  It's on our todo, just didn't have time for this yet. Showing a default cover is a must, selecting a cover is optional. See <denchmark-link:https://github.com/photoprism/photoprism/issues/604>#604</denchmark-link>\n .\n \t\t"}, "comments_13": {"comment_id": 14, "comment_author": "aureooms", "commentT": "2020-11-21T17:43:44Z", "comment_text": "\n \t\tStarting a new Docker build for testing soon.\n \t\t"}, "comments_14": {"comment_id": 15, "comment_author": "aureooms", "commentT": "2020-11-21T23:06:53Z", "comment_text": "\n \t\tThe changeset in <denchmark-link:https://github.com/photoprism/photoprism/commit/668025c0502e3ccbe333e523c2ab65d82b20d9cb>668025c</denchmark-link>\n  looks good to me. Clearing the cache when the album cover query response changes would be sufficient. Clearing on each update is safe.\n \t\t"}}}, "commit": {"commit_id": "668025c0502e3ccbe333e523c2ab65d82b20d9cb", "commit_author": "Michael Mayer", "commitT": "2020-11-21 18:05:20+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 4, "file_old_name": "internal\\api\\album.go", "file_new_name": "internal\\api\\album.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "379", "deleted_lines": null, "method_info": {"method_name": "AddPhotosToAlbum", "method_params": "RouterGroup", "method_startline": "338", "method_endline": "385"}}, "hunk_1": {"Ismethod": 1, "added_lines": "379", "deleted_lines": null, "method_info": {"method_name": "", "method_params": "", "method_startline": "339", "method_endline": "384"}}, "hunk_2": {"Ismethod": 1, "added_lines": "425", "deleted_lines": null, "method_info": {"method_name": "RemovePhotosFromAlbum", "method_params": "RouterGroup", "method_startline": "388", "method_endline": "431"}}, "hunk_3": {"Ismethod": 1, "added_lines": "29,30,31,32,33,34,35,36,37,38,39", "deleted_lines": null, "method_info": {"method_name": "ClearAlbumThumbCache", "method_params": "string", "method_startline": "29", "method_endline": "39"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "internal\\query\\albums.go", "file_new_name": "internal\\query\\albums.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "81", "deleted_lines": "81", "method_info": {"method_name": "AlbumCoverByUID", "method_params": "string", "method_startline": "56", "method_endline": "89"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "internal\\query\\albums_test.go", "file_new_name": "internal\\query\\albums_test.go", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "53", "deleted_lines": "53,54", "method_info": {"method_name": "", "method_params": "", "method_startline": "50", "method_endline": "55"}}, "hunk_1": {"Ismethod": 1, "added_lines": "53", "deleted_lines": "53,54", "method_info": {"method_name": "TestAlbumCoverByUID", "method_params": "T", "method_startline": "29", "method_endline": "62"}}}}}}}