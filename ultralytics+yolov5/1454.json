{"BR": {"BR_id": "1454", "BR_author": "Semihal", "BRopenT": "2020-11-19T12:15:30Z", "BRcloseT": "2020-11-19T12:45:37Z", "BR_text": {"BRsummary": "RuntimeError when try load model to CUDA device", "BRdescription": "\n <denchmark-h:h2>\ud83d\udc1b Bug</denchmark-h>\n \n I try load model (from hub) to CUDA device and receive RuntimeError.\n <denchmark-h:h2>To Reproduce (REQUIRED)</denchmark-h>\n \n Input:\n <denchmark-code>import torch\n import cv2\n \n device = torch.device('cuda')\n model = torch.hub.load('ultralytics/yolov5', 'yolov5l', pretrained=True).fuse().autoshape().eval().to(device)\n image_path = 'data/images/bus.jpg'\n img = cv2.imread(image_path)\n r = model(img)\n </denchmark-code>\n \n Output:\n <denchmark-code>Using cache found in /home/appuser/.cache/torch/hub/ultralytics_yolov5_master\n \n                  from  n    params  module                                  arguments                     \n   0                -1  1      7040  models.common.Focus                     [3, 64, 3]                    \n   1                -1  1     73984  models.common.Conv                      [64, 128, 3, 2]               \n   2                -1  1    161152  models.common.BottleneckCSP             [128, 128, 3]                 \n   3                -1  1    295424  models.common.Conv                      [128, 256, 3, 2]              \n   4                -1  1   1627904  models.common.BottleneckCSP             [256, 256, 9]                 \n   5                -1  1   1180672  models.common.Conv                      [256, 512, 3, 2]              \n   6                -1  1   6499840  models.common.BottleneckCSP             [512, 512, 9]                 \n   7                -1  1   4720640  models.common.Conv                      [512, 1024, 3, 2]             \n   8                -1  1   2624512  models.common.SPP                       [1024, 1024, [5, 9, 13]]      \n   9                -1  1  10234880  models.common.BottleneckCSP             [1024, 1024, 3, False]        \n  10                -1  1    525312  models.common.Conv                      [1024, 512, 1, 1]             \n  11                -1  1         0  torch.nn.modules.upsampling.Upsample    [None, 2, 'nearest']          \n  12           [-1, 6]  1         0  models.common.Concat                    [1]                           \n  13                -1  1   2823680  models.common.BottleneckCSP             [1024, 512, 3, False]         \n  14                -1  1    131584  models.common.Conv                      [512, 256, 1, 1]              \n  15                -1  1         0  torch.nn.modules.upsampling.Upsample    [None, 2, 'nearest']          \n  16           [-1, 4]  1         0  models.common.Concat                    [1]                           \n  17                -1  1    707328  models.common.BottleneckCSP             [512, 256, 3, False]          \n  18                -1  1    590336  models.common.Conv                      [256, 256, 3, 2]              \n  19          [-1, 14]  1         0  models.common.Concat                    [1]                           \n  20                -1  1   2561536  models.common.BottleneckCSP             [512, 512, 3, False]          \n  21                -1  1   2360320  models.common.Conv                      [512, 512, 3, 2]              \n  22          [-1, 10]  1         0  models.common.Concat                    [1]                           \n  23                -1  1  10234880  models.common.BottleneckCSP             [1024, 1024, 3, False]        \n  24      [17, 20, 23]  1    457725  models.yolo.Detect                      [80, [[10, 13, 16, 30, 33, 23], [30, 61, 62, 45, 59, 119], [116, 90, 156, 198, 373, 326]], [256, 512, 1024]]\n Model Summary: 499 layers, 47818749 parameters, 47818749 gradients\n \n Fusing layers... \n Model Summary: 400 layers, 47790077 parameters, 47790077 gradients\n Adding autoShape... \n \n RuntimeError                              Traceback (most recent call last)\n <ipython-input-3-5dc3294ee725> in <module>\n       3 image_path = 'data/images/bus.jpg'\n       4 img = cv2.imread(image_path)\n ----> 5 r = model(img)\n \n ~/.conda/envs/pytorch/lib/python3.7/site-packages/torch/nn/modules/module.py in _call_impl(self, *input, **kwargs)\n     725             result = self._slow_forward(*input, **kwargs)\n     726         else:\n --> 727             result = self.forward(*input, **kwargs)\n     728         for hook in itertools.chain(\n     729                 _global_forward_hooks.values(),\n \n ~/.cache/torch/hub/ultralytics_yolov5_master/models/common.py in forward(self, imgs, size, augment, profile)\n     172                 y[i][:, :4] = scale_coords(shape1, y[i][:, :4], shape0[i])\n     173 \n --> 174         return Detections(imgs, y, self.names)\n     175 \n     176 \n \n ~/.cache/torch/hub/ultralytics_yolov5_master/models/common.py in __init__(self, imgs, pred, names)\n     185         self.xywh = [xyxy2xywh(x) for x in pred]  # xywh pixels\n     186         gn = [torch.Tensor([*[im.shape[i] for i in [1, 0, 1, 0]], 1., 1.]) for im in imgs]  # normalization gains\n --> 187         self.xyxyn = [x / g for x, g in zip(self.xyxy, gn)]  # xyxy normalized\n     188         self.xywhn = [x / g for x, g in zip(self.xywh, gn)]  # xywh normalized\n     189         self.n = len(self.pred)\n \n ~/.cache/torch/hub/ultralytics_yolov5_master/models/common.py in <listcomp>(.0)\n     185         self.xywh = [xyxy2xywh(x) for x in pred]  # xywh pixels\n     186         gn = [torch.Tensor([*[im.shape[i] for i in [1, 0, 1, 0]], 1., 1.]) for im in imgs]  # normalization gains\n --> 187         self.xyxyn = [x / g for x, g in zip(self.xyxy, gn)]  # xyxy normalized\n     188         self.xywhn = [x / g for x, g in zip(self.xywh, gn)]  # xywh normalized\n     189         self.n = len(self.pred)\n \n RuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu!\n </denchmark-code>\n \n <denchmark-h:h2>Environment</denchmark-h>\n \n If applicable, add screenshots to help explain your problem.\n Cuda compilation tools, release 10.1, V10.1.243\n OS: CentOS\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "Semihal", "commentT": "2020-11-19T12:16:13Z", "comment_text": "\n \t\tHello <denchmark-link:https://github.com/Semihal>@Semihal</denchmark-link>\n , thank you for your interest in  YOLOv5! Please visit our  <denchmark-link:https://github.com/ultralytics/yolov5/wiki#tutorials>Tutorials</denchmark-link>\n  to get started, where you can find quickstart guides for simple tasks like <denchmark-link:https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data>Custom Data Training</denchmark-link>\n  all the way to advanced concepts like <denchmark-link:https://github.com/ultralytics/yolov5/issues/607>Hyperparameter Evolution</denchmark-link>\n .\n If this is a \ud83d\udc1b Bug Report, please provide screenshots and minimum viable code to reproduce your issue, otherwise we can not help you.\n If this is a custom training  Question, please provide as much information as possible, including dataset images, training logs, screenshots, and a public link to online <denchmark-link:https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data#visualize>W&B logging</denchmark-link>\n  if available.\n For business inquiries or professional support requests please visit <denchmark-link:https://www.ultralytics.com>https://www.ultralytics.com</denchmark-link>\n  or email Glenn Jocher at <denchmark-link:mailto:glenn.jocher@ultralytics.com>glenn.jocher@ultralytics.com</denchmark-link>\n .\n <denchmark-h:h2>Requirements</denchmark-h>\n \n Python 3.8 or later with all <denchmark-link:https://github.com/ultralytics/yolov5/blob/master/requirements.txt>requirements.txt</denchmark-link>\n  dependencies installed, including . To install run:\n $ pip install -r requirements.txt\n <denchmark-h:h2>Environments</denchmark-h>\n \n YOLOv5 may be run in any of the following up-to-date verified environments (with all dependencies including <denchmark-link:https://developer.nvidia.com/cuda>CUDA</denchmark-link>\n /<denchmark-link:https://developer.nvidia.com/cudnn>CUDNN</denchmark-link>\n , <denchmark-link:https://www.python.org/>Python</denchmark-link>\n  and <denchmark-link:https://pytorch.org/>PyTorch</denchmark-link>\n  preinstalled):\n \n Google Colab Notebook with free GPU: \n Kaggle Notebook with free GPU: https://www.kaggle.com/ultralytics/yolov5\n Google Cloud Deep Learning VM. See GCP Quickstart Guide\n Docker Image https://hub.docker.com/r/ultralytics/yolov5. See Docker Quickstart Guide \n \n <denchmark-h:h2>Status</denchmark-h>\n \n <denchmark-link:https://github.com/ultralytics/yolov5/workflows/CI%20CPU%20testing/badge.svg></denchmark-link>\n \n If this badge is green, all <denchmark-link:https://github.com/ultralytics/yolov5/actions>YOLOv5 GitHub Actions</denchmark-link>\n  Continuous Integration (CI) tests are currently passing. CI tests verify correct operation of YOLOv5 training (<denchmark-link:https://github.com/ultralytics/yolov5/blob/master/train.py>train.py</denchmark-link>\n ), testing (<denchmark-link:https://github.com/ultralytics/yolov5/blob/master/test.py>test.py</denchmark-link>\n ), inference (<denchmark-link:https://github.com/ultralytics/yolov5/blob/master/detect.py>detect.py</denchmark-link>\n ) and export (<denchmark-link:https://github.com/ultralytics/yolov5/blob/master/models/export.py>export.py</denchmark-link>\n ) on MacOS, Windows, and Ubuntu every 24 hours and on every commit.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "Semihal", "commentT": "2020-11-19T12:20:35Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Semihal>@Semihal</denchmark-link>\n  thanks for the bug report. You might want to try  with your torch.hub.load( to make sure you are using the latest code.\n Also, autoshape() already includes a call to eval(), so you can eliminate that part. I will try to reproduce in a Colab notebook.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "Semihal", "commentT": "2020-11-19T12:23:16Z", "comment_text": "\n \t\tYes I see the same error. Will debug.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "Semihal", "commentT": "2020-11-19T12:46:34Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Semihal>@Semihal</denchmark-link>\n  PR  <denchmark-link:https://github.com/ultralytics/yolov5/pull/1455>#1455</denchmark-link>\n  should fix this. Can you try to run the same commands with  to recache the latest update?\n model = torch.hub.load('ultralytics/yolov5', 'yolov5l', pretrained=True, force_reload=True).fuse().autoshape().to(device)\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "Semihal", "commentT": "2020-11-19T13:43:24Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/glenn-jocher>@glenn-jocher</denchmark-link>\n  , Yes, everything works, thank you!\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "Semihal", "commentT": "2020-11-19T14:27:19Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/Semihal>@Semihal</denchmark-link>\n  great! Let me know if you come across any other bugs. We are trying to improve the repo rapidly, so every once in a while we accidentally introduce a bug along with our updates.\n \t\t"}}}, "commit": {"commit_id": "199c9c787427ece5723d5309e1c7c524a99bc59d", "commit_author": "Glenn Jocher", "commitT": "2020-11-19 13:45:36+01:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "models\\common.py", "file_new_name": "models\\common.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "186,187", "deleted_lines": "186", "method_info": {"method_name": "__init__", "method_params": "self,imgs,pred,names", "method_startline": "179", "method_endline": "190"}}}}}}}