{"BR": {"BR_id": "3095", "BR_author": "axinging", "BRopenT": "2020-04-17T11:03:10Z", "BRcloseT": "2020-05-13T16:54:49Z", "BR_text": {"BRsummary": "[webgpu]fusedconv2d relu bias and prelu works incorrectly with certain inputs", "BRdescription": "\n For example, below test passed on WebGL/CPU, but failed on WebGPU:\n <denchmark-code>  it('relu bias stride 2 x=[1,8,8,16] f=[3,3,16,1] s=[2,2] d=8 p=same',\n      async () => {\n        const inputDepth = 16;\n        const xSize = 8;\n        const inputShape: [number, number, number, number] =\n            [1, xSize, xSize, inputDepth];\n        const outputDepth = 8;\n        const fSize = 3;\n        const pad = 'same';\n        const stride: [number, number] = [2, 2];\n \n        const inputs = generateCaseInputs(\n            1 * xSize * xSize * inputDepth,\n            fSize * fSize * inputDepth * outputDepth);\n        const x = tf.tensor4d(inputs.input, inputShape);\n        const w =\n            tf.tensor4d(inputs.filter, [fSize, fSize, inputDepth, outputDepth]);\n        const bias = tf.tensor1d([1, 4, 2, 3, 9, 6, 5, 8]);\n        const result = tf.fused.conv2d({\n          x,\n          filter: w,\n          strides: stride,\n          pad,\n          dataFormat: 'NHWC',\n          dilations: [1, 1],\n          activation: 'relu',\n          bias\n        });\n        expect(result.shape).toEqual([1, 4, 4, 8]);\n        expectArraysClose(\n            await result.data(), new Float32Array([\n              17522760, 17544724, 17566682, 17588644, 17610608, 17632566,\n              17654524, 17676488, 20163140, 20189716, 20216286, 20242852,\n              20269420, 20295990, 20322560, 20349128, 22803520, 22834708,\n              22865890, 22897060, 22928232, 22959414, 22990596, 23021768,\n              14962993, 14986084, 15009170, 15032259, 15055353, 15078438,\n              15101525, 15124616, 38645816, 38704652, 38763504, 38822308,\n              38881116, 38939968, 38998796, 39057608, 41286200, 41349644,\n              41413104, 41476516, 41539932, 41603392, 41666828, 41730248,\n              43926584, 43994628, 44062704, 44130724, 44198748, 44266824,\n              44334868, 44402888, 27472168, 27519844, 27567514, 27615172,\n              27662832, 27710502, 27758172, 27805832, 59768880, 59864564,\n              59960312, 60055972, 60151636, 60247384, 60343060, 60438728,\n              62409256, 62509556, 62609912, 62710180, 62810452, 62910808,\n              63011100, 63111368, 65049640, 65154548, 65259512, 65364388,\n              65469268, 65574232, 65679132, 65784008, 39981352, 40053596,\n              40125856, 40198084, 40270316, 40342576, 40414812, 40487048,\n              32654372, 32736612, 32818846, 32901060, 32983276, 33065510,\n              33147744, 33229960, 33824804, 33910116, 33995424, 34080708,\n              34165996, 34251304, 34336608, 34421896, 34995236, 35083620,\n              35172000, 35260356, 35348716, 35437096, 35525468, 35613832,\n              19992096, 20052548, 20112994, 20173444, 20233896, 20294342,\n              20354788, 20415240\n            ]));\n      });\n </denchmark-code>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "9b0e2daaef94e2d9afff12fa050fdb39235049cc", "commit_author": "Xu Xing", "commitT": "2020-05-13 12:54:48-04:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-wasm\\src\\setup_test.ts", "file_new_name": "tfjs-backend-wasm\\src\\setup_test.ts", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "121,122,123,124", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-webgpu\\src\\kernels\\conv2d_mm_webgpu.ts", "file_new_name": "tfjs-backend-webgpu\\src\\kernels\\conv2d_mm_webgpu.ts", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "90,91,96,102,105,106,107,108", "deleted_lines": "90,91,96,102,105"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "tfjs-backend-webgpu\\src\\kernels\\conv2d_naive_webgpu.ts", "file_new_name": "tfjs-backend-webgpu\\src\\kernels\\conv2d_naive_webgpu.ts", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "54", "deleted_lines": "54"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tfjs-core\\src\\ops\\fused_test.ts", "file_new_name": "tfjs-core\\src\\ops\\fused_test.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "654", "method_endline": "812"}}, "hunk_1": {"Ismethod": 1, "added_lines": "22,23,24,25,26,27,28,29,30,31,32,33,34,35", "deleted_lines": null, "method_info": {"method_name": "generateCaseInputs", "method_params": "number,number", "method_startline": "22", "method_endline": "35"}}}}}}}