{"BR": {"BR_id": "3823", "BR_author": "vladmandic", "BRopenT": "2020-08-18T17:26:02Z", "BRcloseT": "2020-08-24T18:21:17Z", "BR_text": {"BRsummary": "error 'backend' undefined on a single model with tfjs@2.3.0", "BRdescription": "\n anyone tried using openimages_v4/ssd/mobilenet_v2 <denchmark-link:https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1>https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1</denchmark-link>\n  model from tfhub and tfjs 2.0+ ?\n i've converted it using:\n tensorflowjs_converter --input_format tf_hub --output_format tfjs_graph_model --skip_op_check --strip_debug_ops=True --weight_shard_size_bytes 4194304 https://tfhub.dev/google/openimages_v4/ssd/mobilenet_v2/1 .\n and it works perfectly with tfjs@1.7.4.\n but with tfjs@2.3.0, it processes one image just fine and then it fails on the second image with\n <denchmark-code>TypeError: Cannot read property 'backend' of undefined\n </denchmark-code>\n \n I've tried ~10 other models, some native tfjs and some converted from tfhub and none have this issue.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "vladmandic", "commentT": "2020-08-18T20:05:59Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/vladmandic>@vladmandic</denchmark-link>\n  I tried this model, but I am having trouble getting it run properly. do you mind sharing a codepen example of this model? Thanks.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "vladmandic", "commentT": "2020-08-19T00:56:48Z", "comment_text": "\n \t\t\n @vladmandic I tried this model, but I am having trouble getting it run properly. do you mind sharing a codepen example of this model? Thanks.\n \n It's a bit long for codepen, but you can see entire source of my project at <denchmark-link:https://github.com/vladmandic/pigallery>https://github.com/vladmandic/pigallery</denchmark-link>\n \n key code is in function client/modelDetect.js:detectSSD()\n model is executed using:\n const result = await model.executeAsync({ images: batched }, [  \n   'module_apply_default/hub_input/strided_slice_1',  \n   'module_apply_default/hub_input/strided_slice_2',  \n   'module_apply_default/hub_input/strided_slice'  \n ]);\n where batched is an image buffer cast to float32 and afterwards it's just logic to decode classes and detection boxes.\n outputs are arrays of scores, classes, boxes.\n classes are in assets/OpenImage-Labels.json\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "vladmandic", "commentT": "2020-08-20T20:54:36Z", "comment_text": "\n \t\ttouch more info on the error:\n stack trace:\n <denchmark-code>Uncaught (in promise) TypeError: Cannot read property 'backend' of undefined\n     at Engine.moveData (engine.js:270)\n     at DataStorage.get (backend.js:29)\n     at MathBackendWebGL.reshape (backend_webgl.js:1729)\n     at forward (reshape.js:55)\n     at engine.js:465\n     at engine.js:308\n     at Engine.scopedRun (engine.js:318)\n     at Engine.tidy (engine.js:307)\n     at kernelFunc (engine.js:465)\n     at engine.js:477\n </denchmark-code>\n \n problematic code:\n moveData(backend, dataId) {\n   const info = this.state.tensorInfo.get(dataId); // this works fine on first execute, but returns undefined second time execute is called\n   const srcBackend = info.backend;\n   const values = this.readSync(dataId);\n \n dataId is always empty object, so that doesn't change\n during first execute, moveData is called 183 times without issues\n during second execute, moveData is called 22 times before info becomes undefined\n but this.state.tensorInfo looks like a WeakMap with fixed 2890 entries\n \n i've added this debug code after get function:\n if (!info) {           \n   console.log('dataId', dataId);\n   console.log('state', this.state);\n   console.log('tensorInfo', this.state.tensorInfo);\n   console.log('info', this.state.tensorInfo.get({}))\n }\n and you can see the output:\n <denchmark-code>dataId {}\n state EngineState\u00a0{registeredVariables: {\u2026}, nextTapeNodeId: 0, numBytes: 88874728, numTensors: 1479, numStringTensors: 1,\u00a0\u2026}\n tensorInfo WeakMap\u00a0{{\u2026} => {\u2026}, {\u2026} => {\u2026}, {\u2026} => {\u2026}, {\u2026} => {\u2026}, {\u2026} => {\u2026},\u00a0\u2026}\n info undefined\n </denchmark-code>\n \n and just to confirm, tf.backend() and tf.getBackend() are valid before and after error (using webgl).\n i don't think there is anything wrong with moveData per say, as same this.state.tensorInfo.get(dataId) gets used all over the code\n but it does seem that tensor map gets corrupt so getter fails to find value and by it's design it returns undefined\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "vladmandic", "commentT": "2020-08-23T01:12:00Z", "comment_text": "\n \t\tThere are no immediate problems I can spot, but there are tensor leaks, added couple dispose calls:\n async function detectCOCO(model, image) {\n   const imgBuf = tf.browser.fromPixels(image, 3);\n   const expanded = tf.expandDims(imgBuf, 0);\n   let batched;\n   if (!model.config.useFloat) {\n     batched = expanded;\n   } else {\n     const cast = tf.cast(expanded, 'float32');\n     batched = tf.mul(cast, [1.0 / 255.0]);\n     tf.dispose(cast);\n     tf.dispose(expanded);\n   }\n   const result = await model.executeAsync(batched);\n   const [scores, classes] = calculateMaxScores(result);\n   const reshaped = tf.tensor2d(result[1].dataSync(), [result[1].shape[1], result[1].shape[3]]);\n   tf.dispose(result);\n   // const index = tf.image.nonMaxSuppression(reshaped, scores, model.config.topK, model.config.overlap, model.config.score, model.config.softNmsSigma); // async version leaks 2 tensors\n   const index = await tf.image.nonMaxSuppressionAsync(reshaped, scores, model.config.topK, model.config.overlap, model.config.score, model.config.softNmsSigma);\n   const results = buildDetectedObjects(model, batched, result, scores, classes, index); // disposes of batched, result, index\n   tf.dispose(imgBuf);\n   tf.dispose(reshaped);\n   tf.dispose(index);\n   return results;\n }\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "vladmandic", "commentT": "2020-08-23T01:15:53Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/vladmandic>@vladmandic</denchmark-link>\n  can you try to disable cpu forwarding through this flag:\n tf.env().setFlag('WEBGL_CPU_FORWARD', false);\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "vladmandic", "commentT": "2020-08-23T02:02:07Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/pyu10055>@pyu10055</denchmark-link>\n \n FYI, Function used for OpenImages model is detectSSD(), not detectCoco(), but that shouldn't matter.\n I've added additional dispose calls in both (except for index as that one is disposed of later in buildDetectedObjects()).\n Anyhow, I've tried with tf.ENV.set('WEBGL_CPU_FORWARD', false); - no change, still fails on second image.\n Then as a test I've tried disabling anything I could think of:\n   tf.ENV.set('WEBGL_BUFFER_SUPPORTED', false);\n   tf.ENV.set('WEBGL_CONV_IM2COL', false);\n   tf.ENV.set('WEBGL_CPU_FORWARD', false);\n   tf.ENV.set('WEBGL_FENCE_API_ENABLED', false);\n   tf.ENV.set('WEBGL_FORCE_F16_TEXTURES', false);\n   tf.ENV.set('WEBGL_LAZILY_UNPACK', false);\n   tf.ENV.set('WEBGL_PACK', false);\n   tf.ENV.set('WEBGL_PACK_ARRAY_OPERATIONS', false);\n   tf.ENV.set('WEBGL_PACK_BINARY_OPERATIONS', false);\n   tf.ENV.set('WEBGL_PACK_CLIP', false);\n   tf.ENV.set('WEBGL_PACK_DEPTHWISECONV', false);\n   tf.ENV.set('WEBGL_PACK_IMAGE_OPERATIONS', false);\n   tf.ENV.set('WEBGL_PACK_UNARY_OPERATIONS', false);\n Still no change - fails while processing second image.\n And as a last test, I've tried executing two models sequentially in a large loop (CocoSSDv2 and OpenImages) while wrapping execute call in try...catch block.\n Well, CocoSSDv2 model continues processing following 100+ images even after OpenImages fails - this shows that actual backend is perfectly fine.\n And once OpenImages model fails (always on a second image), there is no way to bring it back to consistent state but to reload from scratch.\n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "vladmandic", "commentT": "2020-08-23T03:54:24Z", "comment_text": "\n \t\tThis might be an issue with the op implementation that used by OpenImage model, do you mind providing a simple demo that runs this model? I can try to identify the problematic op. thanks\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "vladmandic", "commentT": "2020-08-23T13:50:14Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/pyu10055>@pyu10055</denchmark-link>\n \n I've created minimalistic project at <denchmark-link:https://github.com/vladmandic/openimages>https://github.com/vladmandic/openimages</denchmark-link>\n \n and you can run it directly from git pages <denchmark-link:https://vladmandic.github.io/openimages/>https://vladmandic.github.io/openimages/</denchmark-link>\n \n (weights and media samples are included and tfjs is loaded from cdnjs so it's 100% self-sufficient)\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "vladmandic", "commentT": "2020-08-24T17:29:40Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/vladmandic>@vladmandic</denchmark-link>\n  Thank you for setting up the demo, I have found the issue, and submit a PR for the fix.\n \t\t"}, "comments_9": {"comment_id": 10, "comment_author": "vladmandic", "commentT": "2020-08-24T18:21:19Z", "comment_text": "\n \t\tAre you satisfied with the resolution of your issue?\n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&entry.2137816233=https://github.com/tensorflow/tfjs/issues/3823>Yes</denchmark-link>\n \n <denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&entry.2137816233=https://github.com/tensorflow/tfjs/issues/3823>No</denchmark-link>\n \n \t\t"}, "comments_10": {"comment_id": 11, "comment_author": "vladmandic", "commentT": "2020-08-24T19:35:39Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/pyu10055>@pyu10055</denchmark-link>\n  Nice & Thank you!\n I went to get the diff, but it's already been reviewed and checked into master - impressive.\n I've done a checkout and clean build and can confirm that it works perfectly!\n I'm closing this issue.\n \t\t"}}}, "commit": {"commit_id": "e66027a38fd15923a6c467bf2c4100a8e6b3f31b", "commit_author": "Ping Yu", "commitT": "2020-08-24 11:21:16-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "tfjs-converter\\src\\executor\\execution_context.ts", "file_new_name": "tfjs-converter\\src\\executor\\execution_context.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "178,180,184", "deleted_lines": "178,180,184", "method_info": {"method_name": "dispose", "method_params": "", "method_startline": "178", "method_endline": "186"}}, "hunk_1": {"Ismethod": 1, "added_lines": "178,180,184", "deleted_lines": "178,180,184", "method_info": {"method_name": "dispose", "method_params": "", "method_startline": "178", "method_endline": "186"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-converter\\src\\executor\\graph_executor.ts", "file_new_name": "tfjs-converter\\src\\executor\\graph_executor.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "227", "deleted_lines": "227", "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "197", "method_endline": "230"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tfjs-converter\\src\\executor\\graph_executor_test.ts", "file_new_name": "tfjs-converter\\src\\executor\\graph_executor_test.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "472", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "369", "method_endline": "473"}}, "hunk_1": {"Ismethod": 1, "added_lines": "599", "deleted_lines": null, "method_info": {"method_name": "createTensorAttr", "method_params": "1", "method_startline": "570", "method_endline": "600"}}, "hunk_2": {"Ismethod": 1, "added_lines": "472,599", "deleted_lines": null, "method_info": {"method_name": "createTensorAttr", "method_params": "0", "method_startline": "295", "method_endline": "622"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tfjs-converter\\src\\executor\\tensor_array.ts", "file_new_name": "tfjs-converter\\src\\executor\\tensor_array.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "56,57,58,59,60", "deleted_lines": "56", "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "56", "method_endline": "60"}}, "hunk_1": {"Ismethod": 1, "added_lines": "55,56,57,58,59,60", "deleted_lines": "55,56", "method_info": {"method_name": "clearAndClose", "method_params": "", "method_startline": "55", "method_endline": "60"}}, "hunk_2": {"Ismethod": 1, "added_lines": "55,56,57,58,59,60", "deleted_lines": "55,56", "method_info": {"method_name": "clearAndClose", "method_params": "", "method_startline": "55", "method_endline": "64"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-converter\\src\\executor\\tensor_array_test.ts", "file_new_name": "tfjs-converter\\src\\executor\\tensor_array_test.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "57", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "51", "method_endline": "60"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "tfjs-converter\\src\\executor\\tensor_list.ts", "file_new_name": "tfjs-converter\\src\\executor\\tensor_list.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "84,85,86,87,88", "deleted_lines": "84", "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "84", "method_endline": "88"}}, "hunk_1": {"Ismethod": 1, "added_lines": "83,84,85,86,87", "deleted_lines": "83,84", "method_info": {"method_name": "clearAndClose", "method_params": "", "method_startline": "83", "method_endline": "87"}}, "hunk_2": {"Ismethod": 1, "added_lines": "83,84,85,86,87,88", "deleted_lines": "83,84", "method_info": {"method_name": "clearAndClose", "method_params": "", "method_startline": "83", "method_endline": "91"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "tfjs-converter\\src\\executor\\tensor_list_test.ts", "file_new_name": "tfjs-converter\\src\\executor\\tensor_list_test.ts", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "43,44,45,46,47,48,49,50,51,52,53,54,55", "deleted_lines": null, "method_info": {"method_name": "(anonymous)", "method_params": "", "method_startline": "43", "method_endline": "55"}}}}}}}