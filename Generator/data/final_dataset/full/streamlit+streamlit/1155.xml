<bug_data>
<bug id='1155' author='treuille' open_date='2020-02-27T19:20:47Z' closed_time='2020-03-25T05:08:30Z'>
 	<summary>`hash_funcs` should properly handle classes defined in the running app script</summary>
 	<description>
 &lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;
 
 A class defined in the running app script is redefined every time the script is run, breaking hash_funcs. This is clearer if you look at the example below.
 &lt;denchmark-h:h2&gt;Steps to reproduce&lt;/denchmark-h&gt;
 
 
 Run this:
 
 import streamlit as st
 
 class X:
   def __init__(self):
     self.number = 0
 
 @st.cache(allow_output_mutation=True)
 def get_x():
   return X()
 
 @st.cache(hash_funcs={X : id})
 def should_only_be_run_once(x):
   x.number += 1
   return x.number
 
 "# Test app 1 for `hash_funcs` issue"
 
 x = get_x()
 
 number = should_only_be_run_once(x)
 
 "x:", id(x), '(singleton, should stay constant)'
 'number:', number, '(should not increment on rerun)'
 
 st.button("Rerun")
 
 
 Click on Rerun
 
 
 Note that the number keeps incrementing. This is because:
 
 
 
 The class X is redefined every time the script is rerun.
 The second time we run should_only_be_run_once, x will have a different type from the redefined X.
 Therefore x won't be in the cache and should_only_be_run_once will not only be done once.
 
 &lt;denchmark-h:h1&gt;Behavior&lt;/denchmark-h&gt;
 
 &lt;denchmark-h:h2&gt;Actual behavior&lt;/denchmark-h&gt;
 
 Number keeps increasing every time you hit rerun:
 &lt;denchmark-link:https://user-images.githubusercontent.com/1673013/75478620-21a76e80-5953-11ea-8dd9-4fca84cff414.png&gt;&lt;/denchmark-link&gt;
 
 &lt;denchmark-h:h2&gt;Expected behavior&lt;/denchmark-h&gt;
 
 Number should always be 1 because should_only_be_run_once should only run once.
 &lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;
 
 No
 &lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;
 
 &lt;denchmark-code&gt;$ streamlit version &amp;&amp; python --version &amp;&amp; pyenv --version &amp;&amp; sw_vers &amp;&amp; "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version
 
 Streamlit, version 0.52.2.post20200225
 Python 3.6.3
 pyenv 1.2.15
 ProductName:    Mac OS X
 ProductVersion: 10.15.3
 BuildVersion:   19D76
 Google Chrome 80.0.3987.122 
 &lt;/denchmark-code&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='treuille' date='2020-02-27T19:21:23Z'>
 		One solution would be to do lookups by fully qualified type name, rather than by the type object itself.
 		</comment>
 		<comment id='2' author='treuille' date='2020-03-25T05:08:27Z'>
 		Closing this as it was merged in &lt;denchmark-link:https://github.com/streamlit/streamlit/pull/1223&gt;1223&lt;/denchmark-link&gt;
 .
 		</comment>
 	</comments>
 </bug>
<commit id='a0ac11b70a426c248dae1596b2e10c42ebed334a' author='Jonathan Rhone' date='2020-03-24 22:43:18-03:00'>
 	<dmm_unit complexity='1.0' interfacing='1.0' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='lib\streamlit\caching.py' new_name='lib\streamlit\caching.py'>
 		<file_info nloc='540' complexity='73' token_count='2611'></file_info>
 		<modified_lines>
 			<added_lines>390,391,392,393,394,442,443,449,450,451,452,453,454,455</added_lines>
 			<deleted_lines>390,391,392,393,441</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\streamlit\hashing.py' new_name='lib\streamlit\hashing.py'>
 		<file_info nloc='542' complexity='139' token_count='2965'></file_info>
 		<method name='_to_bytes' parameters='self,obj,context'>
 				<method_info nloc='108' complexity='40' token_count='884' nesting_level='1' start_line='320' end_line='499'></method_info>
 			<added_lines>330,335,337,431,432</added_lines>
 			<deleted_lines>322,324,418,419,420</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,hash_funcs'>
 				<method_info nloc='11' complexity='4' token_count='69' nesting_level='1' start_line='236' end_line='258'></method_info>
 			<added_lines>237,238,239,240,241,242,243,244,245,246,247,248,249,250</added_lines>
 			<deleted_lines>237</deleted_lines>
 		</method>
 		<method name='to_bytes' parameters='self,obj,context'>
 				<method_info nloc='23' complexity='8' token_count='164' nesting_level='1' start_line='260' end_line='303'></method_info>
 			<added_lines>280</added_lines>
 			<deleted_lines>267</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>317</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\streamlit\type_util.py' new_name='lib\streamlit\type_util.py'>
 		<file_info nloc='123' complexity='50' token_count='693'></file_info>
 		<method name='get_fqn_type' parameters='obj'>
 				<method_info nloc='2' complexity='1' token_count='14' nesting_level='0' start_line='58' end_line='60'></method_info>
 			<added_lines>58,59,60</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='get_fqn' parameters='the_type'>
 				<method_info nloc='4' complexity='1' token_count='24' nesting_level='0' start_line='51' end_line='55'></method_info>
 			<added_lines>51,52,54</added_lines>
 			<deleted_lines>51,52,53,55</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>61,62</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\caching_test.py' new_name='lib\tests\streamlit\caching_test.py'>
 		<file_info nloc='422' complexity='64' token_count='2298'></file_info>
 		<method name='test_user_hash_error' parameters='self'>
 				<method_info nloc='36' complexity='1' token_count='114' nesting_level='1' start_line='548' end_line='594'></method_info>
 			<added_lines>579,580,581,584</added_lines>
 			<deleted_lines>559,560,561,564</deleted_lines>
 		</method>
 		<method name='test_hash_funcs_acceptable_keys' parameters='self'>
 				<method_info nloc='10' complexity='1' token_count='76' nesting_level='1' start_line='530' end_line='546'></method_info>
 			<added_lines>530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_hash_funcs_acceptable_keys.hf_key_as_type' parameters=''>
 				<method_info nloc='2' complexity='2' token_count='15' nesting_level='2' start_line='536' end_line='537'></method_info>
 			<added_lines>536,537</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_hash_funcs_acceptable_keys.unhashable_type_func' parameters=''>
 				<method_info nloc='2' complexity='2' token_count='15' nesting_level='2' start_line='532' end_line='533'></method_info>
 			<added_lines>532,533</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_mutation_warning_text' parameters='self'>
 				<method_info nloc='35' complexity='1' token_count='106' nesting_level='1' start_line='441' end_line='479'></method_info>
 			<added_lines>452</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_hash_funcs_acceptable_keys.hf_key_as_str' parameters=''>
 				<method_info nloc='2' complexity='2' token_count='15' nesting_level='2' start_line='540' end_line='541'></method_info>
 			<added_lines>540,541</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>20,547</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\hashing_test.py' new_name='lib\tests\streamlit\hashing_test.py'>
 		<file_info nloc='522' complexity='148' token_count='4057'></file_info>
 		<method name='test_hash_funcs_acceptable_keys' parameters='self'>
 				<method_info nloc='9' complexity='1' token_count='64' nesting_level='1' start_line='169' end_line='180'></method_info>
 			<added_lines>169,170,171,172,173,174,175,176,177,178,179,180</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_hash_funcs_acceptable_keys.__init__' parameters='self'>
 				<method_info nloc='2' complexity='2' token_count='19' nesting_level='3' start_line='171' end_line='172'></method_info>
 			<added_lines>171,172</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>181</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\scriptrunner\ScriptRunner_test.py' new_name='lib\tests\streamlit\scriptrunner\ScriptRunner_test.py'>
 		<file_info nloc='339' complexity='44' token_count='1914'></file_info>
 		<method name='test_multiple_scriptrunners' parameters='self'>
 				<method_info nloc='37' complexity='6' token_count='201' nesting_level='1' start_line='261' end_line='315'></method_info>
 			<added_lines>261,262</added_lines>
 			<deleted_lines>261</deleted_lines>
 		</method>
 		<method name='off_test_multiple_scriptrunners' parameters='self'>
 				<method_info nloc='37' complexity='6' token_count='201' nesting_level='1' start_line='262' end_line='316'></method_info>
 			<added_lines>262</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
