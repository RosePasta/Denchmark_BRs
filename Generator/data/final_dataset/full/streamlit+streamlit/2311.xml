<bug_data>
<bug id='2311' author='erwanlenagard' open_date='2020-11-03T09:34:07Z' closed_time='2020-12-08T18:33:10Z'>
 	<summary>File_uploader() - ValueError: I/O operation on closed file.</summary>
 	<description>
 &lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;
 
 I upgraded Streamlit and file_uploader() haven't the expected behavior. I'm trying to load a file, then use a dropdown menu to select the right column to analyse. I adapted the proposed solution &lt;denchmark-link:https://github.com/streamlit/streamlit/issues/2266&gt;here &lt;/denchmark-link&gt;
 , but I still have  "ValueError: I/O operation on closed file." when I select a value in the dropdown menu.
 &lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;
 
 What are the steps we should take to reproduce the bug:
 
 Select a file to upload
 Select a value in the dropdown menu
 
 &lt;denchmark-link:https://drive.google.com/file/d/1Mw33AsLPKugGS4k_dg1JlE55b4_Yy9uK/view?usp=sharing&gt;Screencast&lt;/denchmark-link&gt;
 
 &lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;
 
 Explain what you expect to happen when you go through the steps above, assuming there were no bugs.
 &lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;
 
 That is, did this use to work the way you expected in the past?
 yes
 &lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;
 
 streamlit==0.70.0
 streamlit-nightly==0.70.1.dev20201101
 &lt;denchmark-h:h1&gt;Additional information&lt;/denchmark-h&gt;
 
 Here is my code :
 &lt;denchmark-code&gt;def upload_file():
     file = st.sidebar.file_uploader("Choisir un fichier", type=["csv"])
     if file is None:
         return None,None,None,None,None,None
     file.seek(0)
     df = pd.read_csv(file, sep=';',index_col=None, encoding = "utf-8")
     menu_value = st.sidebar.selectbox('Quelle colonne correspond au texte Ã  analyser ?',df.columns)
     language,remove_hashtags,remove_usernames,ncomponents=sidebar()
     return(df,menu_value,language,remove_hashtags,remove_usernames,ncomponents)
 
 def sidebar():
     language = st.sidebar.selectbox('Quelle est la langue du corpus ?',['french','english'])
     remove_hashtags=st.sidebar.checkbox('Supprimer les hashtags',value=False)
     remove_usernames=st.sidebar.checkbox('Supprimer les mentions',value=False)
     ncomponents=st.sidebar.slider("Combien de topics Ã  dÃ©tecter", min_value=0, max_value=100, value=20, step=1, format=None, key=None)
     return language,remove_hashtags,remove_usernames,ncomponents
     
 def main():
     st.set_page_config(
         page_title="Topic Modeling",
         page_icon="ðŸ§Š",
         layout="wide",
         initial_sidebar_state="expanded",
     )
     st.set_option('deprecation.showfileUploaderEncoding', False)
 
     st.sidebar.title('ParamÃ¨tres')
     st.title('Topic Modelling')
     projet=st.sidebar.text_input("Donner un nom de projet", value='monProjet', max_chars=None, key=None, type='default')
     
     
     df,menu_value,language,remove_hashtags,remove_usernames,ncomponents=upload_file()
    
     if st.sidebar.button('Valider'):
         analyse(projet,language,remove_hashtags,remove_usernames,ncomponents,df_input,menu_value)
         list_results(path="./"+projet+"/")
 
 &lt;/denchmark-code&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='erwanlenagard' date='2020-11-11T05:09:40Z'>
 		I have the similar requirement and I am facing the same issue as mentioned above. Is there a workaround?
 		</comment>
 		<comment id='2' author='erwanlenagard' date='2020-11-17T03:03:47Z'>
 		Closing as a duplicate &lt;denchmark-link:https://github.com/streamlit/streamlit/issues/2235&gt;#2235&lt;/denchmark-link&gt;
 . Also resolved in &lt;denchmark-link:https://github.com/streamlit/streamlit/pull/2279&gt;#2279&lt;/denchmark-link&gt;
 
 		</comment>
 		<comment id='3' author='erwanlenagard' date='2020-11-20T19:21:35Z'>
 		It looks like this is still happening intermittently in v0.71.0. Reopening
 		</comment>
 		<comment id='4' author='erwanlenagard' date='2020-11-21T02:09:49Z'>
 		From Thiago:
 
 My 100% blind guess is we're creating a single file-like-object on upload and reusing it on every run â€” so if the file is closed and then gets reused it will brerak. To fix, we'd create a new file-like object each time.
 
 		</comment>
 		<comment id='5' author='erwanlenagard' date='2020-11-21T06:58:10Z'>
 		Yup, the only thing is we aren't closing the file. My guess is the memory is being reclaimed and the file is getting closed for us. However, I was testing with a 189B file and though I wasn't able to repro consistently, I was able to do so and my machine should not be complaining about 189B. Definitely need to do more research to confirm. For sure we'll add better error handling, to recreate if possible but that to me is a bandaid.
 Additionally, re-creating a new file-like object each run when we have the file seems very suboptimal to me and a waste of memory...
 		</comment>
 		<comment id='6' author='erwanlenagard' date='2020-12-16T00:56:50Z'>
 		I think this is the best thread to leave this -- I am encountering this error when using the file_uploader in combination with st.radio(), and uploaded_file.seek(0) does not solve the problem. Ill admit, I honestly do not understand what seek(0) is fundamentally doing, so maybe I am missing something obvious. Here is a minimal reproducible example:
 import streamlit as st
 import io
 
 option = st.radio(
     'Choose method of submitting sequence:',
     ["Upload a file (.txt)", "Enter a sequence"])
 
 txt = None
 
 if option == "Upload a file (.txt)":
 
     uploaded_file = st.file_uploader("Choose a file:", type=['txt'])
 
     if uploaded_file is not None:
         uploaded_file.seek(0) #does not do anything
         text_io = io.TextIOWrapper(uploaded_file,encoding='UTF-8')
         txt=list(text_io.readlines())
 
 elif option == "Enter a sequence":
     txt = st.text_area('Input sequence here:')
 
 if txt:
     st.write(txt)
 streamlit 0.71.0 and 0.72.0
 When users upload a file, switch to manually entering text, and then try to upload again, the ValueError: I/O operation on closed file is thrown. This is a regression, as I did not encounter this error with a much older version of streamlit
 any help would be much appreciated!
 		</comment>
 		<comment id='7' author='erwanlenagard' date='2020-12-16T05:31:10Z'>
 		Thanks for sending this along. The fix was recently merged and will be available in version 0.73 that will be coming out this week. If you would like to get the latest, you can use our &lt;denchmark-link:https://pypi.org/project/streamlit-nightly/&gt;streamlit-nightly package&lt;/denchmark-link&gt;
  that is updated with the latest changes every day.
 		</comment>
 	</comments>
 </bug>
<commit id='3be3d6fc4046ae1fe1d4461455ab3e2164d26d7c' author='Tim Conkling' date='2020-12-08 10:33:09-08:00'>
 	<dmm_unit complexity='1.0' interfacing='0.8372093023255814' size='0.7674418604651163'></dmm_unit>
 	<modification change_type='MODIFY' old_name='lib\streamlit\elements\file_uploader.py' new_name='lib\streamlit\elements\file_uploader.py'>
 		<file_info nloc='62' complexity='3' token_count='314'></file_info>
 		<modified_lines>
 			<added_lines>3,7,49,110,113,117,120</added_lines>
 			<deleted_lines>5,6,49,50,111,114,118,121,122,123</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\streamlit\server\upload_file_request_handler.py' new_name='lib\streamlit\server\upload_file_request_handler.py'>
 		<file_info nloc='113' complexity='22' token_count='663'></file_info>
 		<method name='post' parameters='self,kwargs'>
 				<method_info nloc='47' complexity='6' token_count='252' nesting_level='1' start_line='99' end_line='154'></method_info>
 			<added_lines>100,101,122,126</added_lines>
 			<deleted_lines>100,101,122,126</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>21</added_lines>
 			<deleted_lines>21</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\streamlit\uploaded_file_manager.py' new_name='lib\streamlit\uploaded_file_manager.py'>
 		<file_info nloc='182' complexity='20' token_count='709'></file_info>
 		<method name='_add_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='85' end_line='89'></method_info>
 			<added_lines>89</added_lines>
 			<deleted_lines>89</deleted_lines>
 		</method>
 		<method name='replace_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='197' end_line='201'></method_info>
 			<added_lines>201</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='_remove_files' parameters='self,str,str'>
 				<method_info nloc='10' complexity='1' token_count='46' nesting_level='1' start_line='155' end_line='164'></method_info>
 			<added_lines>155</added_lines>
 			<deleted_lines>163</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,id,name,type,data,kwargs'>
 				<method_info nloc='6' complexity='1' token_count='53' nesting_level='1' start_line='25' end_line='30'></method_info>
 			<added_lines>25,26,27,28,29</added_lines>
 			<deleted_lines>25,26,27,28,29,30</deleted_lines>
 		</method>
 		<method name='replace_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='180' end_line='184'></method_info>
 			<added_lines>180</added_lines>
 			<deleted_lines>184</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self'>
 				<method_info nloc='13' complexity='1' token_count='63' nesting_level='1' start_line='54' end_line='69'></method_info>
 			<added_lines>55,66,67</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='get_files' parameters='self,str,str'>
 				<method_info nloc='2' complexity='1' token_count='11' nesting_level='1' start_line='124' end_line='125'></method_info>
 			<added_lines>124,125</added_lines>
 			<deleted_lines>124,125</deleted_lines>
 		</method>
 		<method name='_add_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='69' end_line='73'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>73</deleted_lines>
 		</method>
 		<method name='remove_session_files' parameters='self,str'>
 				<method_info nloc='14' complexity='3' token_count='49' nesting_level='1' start_line='180' end_line='195'></method_info>
 			<added_lines>180</added_lines>
 			<deleted_lines>184,185</deleted_lines>
 		</method>
 		<method name='add_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='101' end_line='105'></method_info>
 			<added_lines>105</added_lines>
 			<deleted_lines>101,102</deleted_lines>
 		</method>
 		<method name='get_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='38' nesting_level='1' start_line='108' end_line='125'></method_info>
 			<added_lines>117,118,124,125</added_lines>
 			<deleted_lines>108,120,124,125</deleted_lines>
 		</method>
 		<method name='remove_file' parameters='self,str,str,str'>
 				<method_info nloc='10' complexity='4' token_count='82' nesting_level='1' start_line='144' end_line='153'></method_info>
 			<added_lines>144</added_lines>
 			<deleted_lines>149</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,UploadedFileRec'>
 				<method_info nloc='6' complexity='1' token_count='53' nesting_level='1' start_line='37' end_line='46'></method_info>
 			<added_lines>37,38,39,40,41,42,43,44,45,46</added_lines>
 			<deleted_lines>39</deleted_lines>
 		</method>
 		<method name='remove_files' parameters='self,str,str'>
 				<method_info nloc='13' complexity='1' token_count='32' nesting_level='1' start_line='166' end_line='178'></method_info>
 			<added_lines>166</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='add_files' parameters='self,str,str'>
 				<method_info nloc='5' complexity='1' token_count='19' nesting_level='1' start_line='85' end_line='89'></method_info>
 			<added_lines>89</added_lines>
 			<deleted_lines>89</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>17,21,22,23,24,31,32,33,34,35,36,106,126,138,142,202,213,225</added_lines>
 			<deleted_lines>17,18,19,20,50,51,90,127,138,196,208</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\file_uploader_test.py' new_name='lib\tests\streamlit\file_uploader_test.py'>
 		<file_info nloc='65' complexity='9' token_count='481'></file_info>
 		<method name='test_multiple_files' parameters='self,get_files_patch'>
 				<method_info nloc='26' complexity='4' token_count='162' nesting_level='1' start_line='48' end_line='85'></method_info>
 			<added_lines>50,51,52,55,64,65,66,67,68,69,70,71,73,74,75,76,77,79,80,81,82,83,84,85</added_lines>
 			<deleted_lines>51,52,53,56,65,66,68,70</deleted_lines>
 		</method>
 		<method name='test_unique_uploaded_file_instance' parameters='self,get_files_patch'>
 				<method_info nloc='12' complexity='1' token_count='109' nesting_level='1' start_line='97' end_line='118'></method_info>
 			<added_lines>97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>21,95,96</added_lines>
 			<deleted_lines>21,22</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\hashing_test.py' new_name='lib\tests\streamlit\hashing_test.py'>
 		<file_info nloc='733' complexity='173' token_count='5759'></file_info>
 		<method name='test_io' parameters='self,io_type,io_data1,io_data2,io_data3'>
 				<method_info nloc='9' complexity='1' token_count='85' nesting_level='1' start_line='330' end_line='341'></method_info>
 			<added_lines>331,332,333</added_lines>
 			<deleted_lines>333,334,335</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>57,320,321,324,325,326</added_lines>
 			<deleted_lines>26,37,59,322,323,326,327,328</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\server_test.py' new_name='lib\tests\streamlit\server_test.py'>
 		<file_info nloc='445' complexity='45' token_count='3315'></file_info>
 		<method name='test_multiple_uploaded_file_triggers_one_rerun' parameters='self'>
 				<method_info nloc='26' complexity='1' token_count='178' nesting_level='1' start_line='355' end_line='390'></method_info>
 			<added_lines>367</added_lines>
 			<deleted_lines>367</deleted_lines>
 		</method>
 		<method name='test_orphaned_upload_file_deletion' parameters='self'>
 				<method_info nloc='12' complexity='1' token_count='75' nesting_level='1' start_line='393' end_line='409'></method_info>
 			<added_lines>404</added_lines>
 			<deleted_lines>404</deleted_lines>
 		</method>
 		<method name='test_uploaded_file_triggers_rerun' parameters='self'>
 				<method_info nloc='26' complexity='1' token_count='174' nesting_level='1' start_line='317' end_line='352'></method_info>
 			<added_lines>329</added_lines>
 			<deleted_lines>329</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>32</added_lines>
 			<deleted_lines>32</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\upload_file_request_handler_test.py' new_name='lib\tests\streamlit\upload_file_request_handler_test.py'>
 		<file_info nloc='131' complexity='12' token_count='902'></file_info>
 		<method name='test_delete_file_across_sessions' parameters='self'>
 				<method_info nloc='9' complexity='1' token_count='119' nesting_level='1' start_line='159' end_line='170'></method_info>
 			<added_lines>161,162</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_upload_multiple_files' parameters='self'>
 				<method_info nloc='23' complexity='2' token_count='146' nesting_level='1' start_line='96' end_line='119'></method_info>
 			<added_lines>97,98,99,102,103,104,112,115,116</added_lines>
 			<deleted_lines>96,97,98,106,109,110</deleted_lines>
 		</method>
 		<method name='test_delete_file' parameters='self'>
 				<method_info nloc='9' complexity='1' token_count='119' nesting_level='1' start_line='146' end_line='157'></method_info>
 			<added_lines>148,149</added_lines>
 			<deleted_lines>155,156</deleted_lines>
 		</method>
 		<method name='test_upload_one_file' parameters='self'>
 				<method_info nloc='17' complexity='2' token_count='111' nesting_level='1' start_line='77' end_line='94'></method_info>
 			<added_lines>79,81,89,91,92</added_lines>
 			<deleted_lines>83,85,86,91,92,93</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>17,18,28,29,34,35,36,37,38</added_lines>
 			<deleted_lines>22,25,26,73,75,142,143</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='lib\tests\streamlit\uploaded_file_manager_test.py' new_name='lib\tests\streamlit\uploaded_file_manager_test.py'>
 		<file_info nloc='50' complexity='6' token_count='608'></file_info>
 		<modified_lines>
 			<added_lines>20,22,23</added_lines>
 			<deleted_lines>19,22,23</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
