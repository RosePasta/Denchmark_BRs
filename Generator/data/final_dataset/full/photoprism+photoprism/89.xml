<bug_data>
<bug id='89' author='rcdailey' open_date='2019-01-01T21:10:20Z' closed_time='2019-12-30T14:46:32Z'>
 	<summary>Segmentation fault on start of Docker container</summary>
 	<description>
 Using latest on  (SHA1: &lt;denchmark-link:https://github.com/photoprism/photoprism/commit/6cf39ebd677aecf3a6af42f5dacccc5df0d897ce&gt;6cf39eb&lt;/denchmark-link&gt;
 ), I have my own  as shown:
 version: '3.7'
 
 services:
   photoprism:
     build:
       context: source
       dockerfile: docker/photoprism/Dockerfile
     image: photoprism/photoprism
     #restart: always
     network_mode: bridge
     user: $UID:$GID
     ports:
     - 50180:80
     volumes:
     - /media/photo/photoprism:/srv/photoprism/photos
     - ./cache:/srv/photoprism/cache # thumbnail cache
     - ./database:/srv/photoprism/database # database files
     environment:
     - PHOTOPRISM_DEBUG=true
     - PHOTOPRISM_SERVER_MODE=debug
     - PHOTOPRISM_IMPORT_PATH=/srv/photoprism/photos/import
     - PHOTOPRISM_EXPORT_PATH=/srv/photoprism/photos/export
     - PHOTOPRISM_ORIGINALS_PATH=/srv/photoprism/photos/originals
 I have the repository cloned at directory source next to my YML file. I get this segmentation fault when I do docker-compose up after doing a docker-compose build:
 &lt;denchmark-code&gt;panic: runtime error: invalid memory address or nil pointer dereference
 [signal SIGSEGV: segmentation violation code=0x1 addr=0x40 pc=0x7c3eb7]
 
 goroutine 1 [running]:
 github.com/photoprism/photoprism/internal/fsutil.ExpandedFilename(0x191acb6, 0x1e, 0xb, 0x191acb6)
     /go/src/github.com/photoprism/photoprism/internal/fsutil/file.go:25 +0x37
 github.com/photoprism/photoprism/internal/context.NewConfig(0xc000430420, 0xc00043c7b8)
     /go/src/github.com/photoprism/photoprism/internal/context/config.go:68 +0xda
 github.com/photoprism/photoprism/internal/commands.startAction(0xc000430420, 0x0, 0xc000430420)
     /go/src/github.com/photoprism/photoprism/internal/commands/start.go:42 +0x40
 github.com/urfave/cli.HandleAction(0x1655600, 0x19902a8, 0xc000430420, 0xc000240400, 0x0)
     /go/pkg/mod/github.com/urfave/cli@v1.20.0/app.go:490 +0xc8
 github.com/urfave/cli.Command.Run(0x18f1a51, 0x5, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1905092, 0x11, 0x0, ...)
     /go/pkg/mod/github.com/urfave/cli@v1.20.0/command.go:210 +0x9a2
 github.com/urfave/cli.(*App).Run(0xc0000d8820, 0xc0000ce000, 0x2, 0x2, 0x0, 0x0)
     /go/pkg/mod/github.com/urfave/cli@v1.20.0/app.go:255 +0x687
 main.main()
     /go/src/github.com/photoprism/photoprism/cmd/photoprism/photoprism.go:33 +0x309
 &lt;/denchmark-code&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='rcdailey' date='2019-01-03T04:13:20Z'>
 		Ok, so if your source is up-to-date it looks like the current user can't be found for any reason. We need to implement error handling in file.go line 24 for that case. Do you want to send a pull request?
 		</comment>
 		<comment id='2' author='rcdailey' date='2019-01-03T05:03:10Z'>
 		Added error handling. Let me know if this fixed it.
 		</comment>
 		<comment id='3' author='rcdailey' date='2019-01-03T05:27:17Z'>
 		Now I get:
 &lt;denchmark-code&gt;2019/01/03 05:25:55.738 terror.go:327: [fatal] open /srv/photoprism/server/database/LOCK: permission denied
 github.com/pingcap/errors.AddStack
     /go/pkg/mod/github.com/pingcap/errors@v0.11.0/errors.go:174
 github.com/pingcap/errors.Trace
     /go/pkg/mod/github.com/pingcap/errors@v0.11.0/juju_adaptor.go:12
 github.com/pingcap/tidb/store/mockstore/mocktikv.NewMVCCLevelDB
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/store/mockstore/mocktikv/mvcc_leveldb.go:119
 github.com/pingcap/tidb/store/mockstore/mocktikv.NewTiKVAndPDClient
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/store/mockstore/mocktikv/mock.go:30
 github.com/pingcap/tidb/store/mockstore.NewMockTikvStore
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/store/mockstore/tikv.go:106
 github.com/pingcap/tidb/store/mockstore.MockDriver.Open
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/store/mockstore/tikv.go:47
 github.com/pingcap/tidb/store/mockstore.(*MockDriver).Open
     &lt;autogenerated&gt;:1
 github.com/pingcap/tidb/session.newStoreWithRetry.func1
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/session/tidb.go:273
 github.com/pingcap/tidb/util.RunWithRetry
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/util/misc.go:39
 github.com/pingcap/tidb/session.newStoreWithRetry
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/session/tidb.go:271
 github.com/pingcap/tidb/session.NewStore
     /go/pkg/mod/github.com/pingcap/tidb@v0.0.0-20181212102244-990f859384b8/session/tidb.go:255
 github.com/photoprism/photoprism/internal/tidb.createStoreAndDomain
     /go/src/github.com/photoprism/photoprism/internal/tidb/server.go:112
 github.com/photoprism/photoprism/internal/tidb.Start
     /go/src/github.com/photoprism/photoprism/internal/tidb/server.go:89
 runtime.goexit
     /usr/local/go/src/runtime/asm_amd64.s:1333
 &lt;/denchmark-code&gt;
 
 Does your docker container not support running as an arbitrary user?
 		</comment>
 		<comment id='4' author='rcdailey' date='2019-01-03T05:31:51Z'>
 		At least I didn't try so far... would it be possible to fix the permissions somethow and try again?
 		</comment>
 		<comment id='5' author='rcdailey' date='2019-01-03T14:09:42Z'>
 		Permissions are already correct on the host, specifically where the volumes
 are concerned.
 &lt;denchmark-link:#&gt;…&lt;/denchmark-link&gt;
 
 
 On Wed, Jan 2, 2019, 11:31 PM Michael Mayer ***@***.***&gt; wrote:
  At least I didn't try so far... would it be possible to fix the
  permissions somethow and try again?
 
  —
  You are receiving this because you authored the thread.
  Reply to this email directly, view it on GitHub
  &lt;#89 (comment)&gt;,
  or mute the thread
  &lt;https://github.com/notifications/unsubscribe-auth/ABr6dhQaLAeAkeFcbUo9YSkq7R1vet4Dks5u_ZXJgaJpZM4ZmB8x&gt;
  .
 
 
 
 		</comment>
 		<comment id='6' author='rcdailey' date='2019-01-03T14:48:58Z'>
 		Just noticed that you mount the db and cache volumes from your host:
 &lt;denchmark-code&gt;- ./cache:/srv/photoprism/cache # thumbnail cache
 - ./database:/srv/photoprism/database # database files
 &lt;/denchmark-code&gt;
 
 Why? In that case, permissions &amp; case sensitivity can be an issue. Also performance might suffer (at least on a Mac).
 		</comment>
 		<comment id='7' author='rcdailey' date='2019-01-03T15:19:05Z'>
 		I do it this way so I can directly access the files if needed, and also so
 I can control permissions manually. I cannot do either of these without
 trickery if they are true docker volumes. Not to mention that it's too easy
 to remove docker volumes, IMHO. And important data should not go into
 docker volumes for this reason (only data that is easily reproduced or
 redownloaded, such as cache but not database).
 
 Anyway, I'm not asking you to agree with how I'm doing it, just know that I
 do this with 10 other distinct docker containers and it works fine. The
 issue is likely that your entrypoint script is running commands that only
 work when you're root. However, now they are running as a non-privileged
 user inside the container. So your container logic and processes will need
 to handle both root and non-root users.
 &lt;denchmark-link:#&gt;…&lt;/denchmark-link&gt;
 
 
 On Thu, Jan 3, 2019 at 8:49 AM Michael Mayer ***@***.***&gt; wrote:
  Just noticed that you mount the db and cache volumes from your host:
 
  - ./cache:/srv/photoprism/cache # thumbnail cache
  - ./database:/srv/photoprism/database # database files
 
  Why? In that case, permissions &amp; case sensitivity can be an issue. Also
  performance might suffer (at least on a Mac).
 
  —
  You are receiving this because you authored the thread.
  Reply to this email directly, view it on GitHub
  &lt;#89 (comment)&gt;,
  or mute the thread
  &lt;https://github.com/notifications/unsubscribe-auth/ABr6dvHxLQyZBLwkrLyiZSetV6F2iF1-ks5u_hhfgaJpZM4ZmB8x&gt;
  .
 
 
 
 		</comment>
 		<comment id='8' author='rcdailey' date='2019-01-03T15:25:16Z'>
 		What is the recommended way to ensure the filesystem is always writable for our app from inside the container, independent of how you mount it and what the permissions are?
 We later want to distribute a single binary without Docker, so I didn't spend much time on those issues. Any help is much appreciated.
 Note that the DB and the cache can be re-built any time from the files (except the likes, those will later be stored in XMP and can also be restored).
 		</comment>
 		<comment id='9' author='rcdailey' date='2019-01-03T19:04:38Z'>
 		I think there's 2 principles that most containers usually follow:
 
 Do not support changes between UID/GID between multiple sessions using the same volume.
 Allow root and non-root users to be specified for running services.
 
 What number 1 means is that if I start my container with UID 1000, you assume that UID will never change. So if I start as UID 2000 after files have been created in volumes and I get permission errors, that's something I need to fix myself. Some containers do things like sudo chown -R but this is situational.
 For number 2, I've seen two approaches:
 
 Use --user with docker run or user: with Docker Compose. This runs your entrypoint as that UID/GID.
 Do not use --user, and instead provide environment variables (e.g. PHOTOPRISM_UID and PHOTOPRISM_GID, which the user specifies when they start the container.
 
 In the second case, it works a bit like this:
 
 Container is started
 Container entrypoint is executed as root user
 Perform root-level setup as-needed (initialize volumes, download/install stuff, chmod, etc)
 Execute your service (photoprism in this case) using an explicit UID/GID (pulling these values from the aforementioned environment variables the user provided to the container).
 
 This approach is generally required if you still need root for certain tasks required to initialize the container, but don't affect the host machine in any significant way (e.g. writes files to volumes as root that the user in turn can't access on the host). And usually the only thing that needs to run as that UID is the service itself, since it's the thing creating the files, using the volumes, etc.
 Both of these solutions address file permissions problems in volumes, which is generally the biggest issue you see. Imagine someone mapping an NFS mounted-volume on the host to the container. NFS is pretty permission sensitive, so if it's creating files with the root UID, that might cause failures or other problems.
 If you need a real world example, look at the LinuxServer.io containers. They have a pretty neat framework set up to run init services under specific UID/GID.
 		</comment>
 		<comment id='10' author='rcdailey' date='2019-01-04T15:35:53Z'>
 		Thank you very much for the overview! 👍
 I'll have a closer look when I find the time... A pull request would be really amazing. I'm slowly running out of food as I spent the last 6 months working for free on various open-source projects.
 		</comment>
 		<comment id='11' author='rcdailey' date='2019-01-04T16:27:10Z'>
 		I saw your previous question: Yes, you do have to do it all in the entrypoint. Most people wouldn't be bothered to build their own subimage based on yours to perform those tasks. It makes the most sense to be done as initialization of the container itself in those cases. Again, a lot of it is situational, and depends on the requirements and semantics of your services.
 No problem. And no rush. I am pretty busy myself, but if I can find the time to help out I will. The downside is that doing this right really requires a deep understanding of your services, which will take a long time for someone new to the project.
 My intention was to try out Photoprism in a test instance, but I couldn't get it working in the way I expected the configuration to work (specifically, overriding the container UID/GID, as we discussed).
 Keep up the great work.
 		</comment>
 		<comment id='12' author='rcdailey' date='2019-01-04T16:31:35Z'>
 		
 I saw your previous question
 
 Haha, yes, I thought I can figure this out myself. Thanks for the clarification. I'll leave this issue open so that someone can pick it up.
 		</comment>
 		<comment id='13' author='rcdailey' date='2019-07-29T14:28:18Z'>
 		Just heard about Photoprism and wanted to check it out, crashes with a segfault immediately on launch, can't even get any logging information out of it. Any assistance would be appreciated, including my compose file, environment is running Ubuntu 18.04, Docker 19.03.1 build 74b1e89. /media/photos is a zfs filesyste if that matters.
 &lt;denchmark-code&gt;version: '3.6'
 
 volumes:
     photoprism_db:
         driver: local
         name: photoprism_db
     photoprism_cache:
         driver: local
         name: photoprism_cache
 
 services:
     photoprism:
         container_name: photoprism
         restart: unless-stopped
         volumes:
             - '/media/photos:/home/photoprism/Pictures/Originals:ro'
             - 'photoprism_cache:/home/photoprism/.cache/photoprism'
             - 'photoprism_db:/home/photoprism/.local/share/photoprism/resources/database'
         ports:
             - '2342:2342'
         image: photoprism/photoprism
 &lt;/denchmark-code&gt;
 
 		</comment>
 		<comment id='14' author='rcdailey' date='2019-08-18T16:28:45Z'>
 		&lt;denchmark-link:https://github.com/scottjl&gt;@scottjl&lt;/denchmark-link&gt;
  Is that the same issue as &lt;denchmark-link:https://github.com/photoprism/photoprism/issues/128&gt;#128&lt;/denchmark-link&gt;
 ?
 		</comment>
 		<comment id='15' author='rcdailey' date='2019-12-30T12:35:30Z'>
 		&lt;denchmark-link:https://github.com/rcdailey&gt;@rcdailey&lt;/denchmark-link&gt;
  Does this issue still exist?
 		</comment>
 		<comment id='16' author='rcdailey' date='2019-12-30T14:46:31Z'>
 		I do not use this anymore so I'm not able to confirm. I'll close the issue.
 		</comment>
 		<comment id='17' author='rcdailey' date='2019-12-30T14:55:11Z'>
 		&lt;denchmark-link:https://github.com/rcdailey&gt;@rcdailey&lt;/denchmark-link&gt;
  Sorry we didn't meet your needs!
 		</comment>
 	</comments>
 </bug>
<commit id='95b041e25fed355a012dcaf7f081aa1a87d88403' author='Michael Mayer' date='2019-01-03 05:45:54+01:00'>
 	<dmm_unit complexity='0.0' interfacing='1.0' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='internal\fsutil\file.go' new_name='internal\fsutil\file.go'>
 		<file_info nloc='96' complexity='23' token_count='528'></file_info>
 		<method name='ExpandedFilename' parameters='string'>
 				<method_info nloc='15' complexity='6' token_count='90' nesting_level='0' start_line='23' end_line='41'></method_info>
 			<added_lines>29,30,31,34,35,36,37,38</added_lines>
 			<deleted_lines>24,25,26,32,35</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
