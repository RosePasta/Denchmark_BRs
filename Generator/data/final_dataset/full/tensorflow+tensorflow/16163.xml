<bug_data>
<bug id='16163' author='velikodniy' open_date='2018-01-16T16:55:16Z' closed_time='2018-02-23T05:43:34Z'>
 	<summary>Dataset.from_generator doesn't release memory after recreating the session</summary>
 	<description>
 &lt;denchmark-h:h3&gt;System information&lt;/denchmark-h&gt;
 
 
 Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes
 OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 17.10
 TensorFlow installed from (source or binary): binary
 TensorFlow version (use command below): 1.5.0-rc0
 Python version: Python 3.6
 Bazel version (if compiling from source): -
 GCC/Compiler version (if compiling from source): -
 CUDA/cuDNN version: -
 GPU model and memory: -
 Exact command to reproduce: see below
 
 &lt;denchmark-h:h3&gt;Describe the problem&lt;/denchmark-h&gt;
 
 After closing the session and creating new one an iterator creates the generator instance but doesn't free the memory of the previous one.
 Every calling of the line session.run(x) (see below) increases memory consumption of the script:
 
 519 MiB after the first,
 600 MiB after the second,
 681 MiB after the third and so on.
 
 As you can see the delta is equal to 80 MiB = N * sizeof(data.dtype). (data.dtype is float64 here)
 &lt;denchmark-h:h3&gt;Source code / logs&lt;/denchmark-h&gt;
 
 import numpy as np
 import tensorflow as tf
 
 N = 10 * 1024 * 1024
 
 def generate():
   data = np.random.rand(N)
   for k in range(N):
     yield data[k].copy()
 
 graph = tf.Graph()
 with graph.as_default():
   x = tf.data.Dataset\
     .from_generator(generate, tf.float32)\
     .make_one_shot_iterator()\
     .get_next()
 
 while True:
   session = tf.Session(graph=graph)
   session.run(x) # &lt;--- PUT A BREAKPOINT HERE!
                  #  Be careful running the code without it!
   session.close()
 	</description>
 	<comments>
 		<comment id='1' author='velikodniy' date='2018-01-16T17:28:40Z'>
 		Of course, if session.run consumes all the elements produced by the generator, it will be removed.
 		</comment>
 		<comment id='2' author='velikodniy' date='2018-01-16T22:49:27Z'>
 		&lt;denchmark-link:https://github.com/mrry&gt;@mrry&lt;/denchmark-link&gt;
 , could you comment on this please?
 		</comment>
 		<comment id='3' author='velikodniy' date='2018-02-06T07:36:15Z'>
 		Nagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.
 		</comment>
 		<comment id='4' author='velikodniy' date='2018-02-07T22:46:27Z'>
 		Yes, this is a bug. I have a fix in preparation.
 		</comment>
 		<comment id='5' author='velikodniy' date='2018-02-22T13:07:34Z'>
 		Nagging Assignee: It has been 14 days with no activity and this issue has an assignee. Please update the label and/or status accordingly.
 		</comment>
 		<comment id='6' author='velikodniy' date='2018-02-22T15:34:37Z'>
 		The fix has been submitted internally, but not yet merged into the Git master branch. It should be coming in the next push!
 		</comment>
 	</comments>
 </bug>
<commit id='be862d5b91e9b9044f4e028dcdae0b6ad283e8b4' author='Derek Murray' date='2018-02-20 14:18:09-08:00'>
 	<dmm_unit complexity='0.9043478260869565' interfacing='0.8' size='0.3536231884057971'></dmm_unit>
 	<modification change_type='ADD' old_name='None' new_name='tensorflow\core\api_def\base_api\api_def_GeneratorDataset.pbtxt'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\kernels\data\BUILD' new_name='tensorflow\core\kernels\data\BUILD'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>212,213,214,215,216,217,218,219,220,221,222,223,224,535</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\kernels\data\captured_function.cc' new_name='tensorflow\core\kernels\data\captured_function.cc'>
 		<file_info nloc='285' complexity='44' token_count='2101'></file_info>
 		<method name='tensorflow::CapturedFunction::Instantiate' parameters='ctx'>
 				<method_info nloc='9' complexity='2' token_count='56' nesting_level='1' start_line='259' end_line='267'></method_info>
 			<added_lines>259,260,261,262,263,264,265,266,267</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::CapturedFunction::RunInstantiated' parameters='args,rets'>
 				<method_info nloc='36' complexity='2' token_count='243' nesting_level='1' start_line='269' end_line='313'></method_info>
 			<added_lines>269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>268,314</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\kernels\data\captured_function.h' new_name='tensorflow\core\kernels\data\captured_function.h'>
 		<file_info nloc='49' complexity='2' token_count='319'></file_info>
 		<modified_lines>
 			<added_lines>67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,117</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='tensorflow\core\kernels\data\generator_dataset_op.cc'>
 		<file_info nloc='153' complexity='19' token_count='996'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\ops\dataset_ops.cc' new_name='tensorflow\core\ops\dataset_ops.cc'>
 		<file_info nloc='411' complexity='3' token_count='2173'></file_info>
 		<modified_lines>
 			<added_lines>69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\python\data\kernel_tests\dataset_from_generator_op_test.py' new_name='tensorflow\python\data\kernel_tests\dataset_from_generator_op_test.py'>
 		<file_info nloc='282' complexity='51' token_count='2264'></file_info>
 		<method name='testFromGeneratorDestructorCalled.__next__' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='7' nesting_level='3' start_line='338' end_line='339'></method_info>
 			<added_lines>338,339</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorStopShort.generator' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='10' nesting_level='2' start_line='310' end_line='313'></method_info>
 			<added_lines>310,311,312,313</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorDestructorCalled.__iter__' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='7' nesting_level='3' start_line='332' end_line='333'></method_info>
 			<added_lines>332,333</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testGeneratorDatasetFinalizeFunctionCalled.testGeneratorDatasetFinalizeFunctionCalled.finalize_fn.finalize_py_func' parameters=''>
 				<method_info nloc='3' complexity='1' token_count='11' nesting_level='3' start_line='369' end_line='371'></method_info>
 			<added_lines>369,370,371</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorDestructorCalled.__del__' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='10' nesting_level='3' start_line='341' end_line='342'></method_info>
 			<added_lines>341,342</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorDestructorCalled' parameters='self'>
 				<method_info nloc='19' complexity='1' token_count='130' nesting_level='1' start_line='326' end_line='358'></method_info>
 			<added_lines>326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testGeneratorDatasetFinalizeFunctionCalled.finalize_fn' parameters='_'>
 				<method_info nloc='4' complexity='1' token_count='27' nesting_level='2' start_line='368' end_line='373'></method_info>
 			<added_lines>368,369,370,371,372,373</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorStopShort' parameters='self'>
 				<method_info nloc='11' complexity='1' token_count='82' nesting_level='1' start_line='308' end_line='324'></method_info>
 			<added_lines>308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testFromGeneratorDestructorCalled.next' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='11' nesting_level='3' start_line='335' end_line='336'></method_info>
 			<added_lines>335,336</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testGeneratorDatasetFinalizeFunctionCalled' parameters='self'>
 				<method_info nloc='17' complexity='1' token_count='132' nesting_level='1' start_line='360' end_line='389'></method_info>
 			<added_lines>360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>24,26,29,325,359,390</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\python\data\ops\dataset_ops.py' new_name='tensorflow\python\data\ops\dataset_ops.py'>
 		<file_info nloc='1072' complexity='254' token_count='7692'></file_info>
 		<method name='__init__' parameters='self,init_args,init_func,next_func,finalize_func'>
 				<method_info nloc='29' complexity='3' token_count='240' nesting_level='1' start_line='1051' end_line='1210'></method_info>
 			<added_lines>1051,1052,1053,1054,1055,1056,1057,1058,1059,1060,1061,1062,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,1117,1118,1119,1120,1121,1122,1123,1124,1125,1126,1127,1128,1129,1130,1131,1132,1133,1134,1135,1136,1137,1138,1139,1140,1141,1142,1143,1144,1145,1146,1147,1148,1149,1150,1151,1152,1153,1154,1155,1156,1157,1158,1159,1160,1161,1162,1163,1164,1165,1166,1167,1168,1169,1170,1171,1172,1173,1174,1175,1176,1177,1178,1179,1180,1181,1182,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192,1193,1194,1195,1196,1197,1198,1199,1200,1201,1202,1203,1204,1205,1206,1207,1208,1209,1210</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__.tf_finalize_func' parameters='args'>
 				<method_info nloc='13' complexity='3' token_count='95' nesting_level='2' start_line='1192' end_line='1207'></method_info>
 			<added_lines>1192,1193,1194,1195,1196,1197,1198,1199,1200,1201,1202,1203,1204,1205,1206,1207</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='from_generator.finalize_fn' parameters='iterator_id_t'>
 				<method_info nloc='4' complexity='1' token_count='27' nesting_level='2' start_line='409' end_line='422'></method_info>
 			<added_lines>409,410,411,412,413,414,415,416,417,418,419,420,421,422</added_lines>
 			<deleted_lines>413,414,415,416,417,418,419,421</deleted_lines>
 		</method>
 		<method name='output_shapes' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='9' nesting_level='1' start_line='1230' end_line='1231'></method_info>
 			<added_lines>1230,1231</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='from_generator.from_generator.generator_next_fn.generator_py_func' parameters='iterator_id'>
 				<method_info nloc='19' complexity='5' token_count='123' nesting_level='3' start_line='364' end_line='396'></method_info>
 			<added_lines>366,367,368</added_lines>
 			<deleted_lines>366,367,368,369,370</deleted_lines>
 		</method>
 		<method name='from_generator.get_iterator_id_map_fn' parameters='unused_dummy'>
 				<method_info nloc='3' complexity='1' token_count='26' nesting_level='2' start_line='334' end_line='348'></method_info>
 			<added_lines>334,337</added_lines>
 			<deleted_lines>334,337</deleted_lines>
 		</method>
 		<method name='from_generator.generator_next_fn' parameters='iterator_id_t'>
 				<method_info nloc='8' complexity='3' token_count='59' nesting_level='2' start_line='350' end_line='407'></method_info>
 			<added_lines>350,366,367,368</added_lines>
 			<deleted_lines>350,366,367,368,369,370</deleted_lines>
 		</method>
 		<method name='from_generator.flat_map_fn' parameters='dummy_arg'>
 				<method_info nloc='3' complexity='1' token_count='16' nesting_level='2' start_line='426' end_line='433'></method_info>
 			<added_lines>426,427,428,429,430,432,433</added_lines>
 			<deleted_lines>429</deleted_lines>
 		</method>
 		<method name='__init__.tf_next_func' parameters='args'>
 				<method_info nloc='29' complexity='9' token_count='248' nesting_level='2' start_line='1138' end_line='1185'></method_info>
 			<added_lines>1138,1139,1140,1141,1142,1143,1144,1145,1146,1147,1148,1149,1150,1151,1152,1153,1154,1155,1156,1157,1158,1159,1160,1161,1162,1163,1164,1165,1166,1167,1168,1169,1170,1171,1172,1173,1174,1175,1176,1177,1178,1179,1180,1181,1182,1183,1184,1185</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='_as_variant_tensor' parameters='self'>
 				<method_info nloc='12' complexity='1' token_count='95' nesting_level='1' start_line='1212' end_line='1223'></method_info>
 			<added_lines>1212,1213,1214,1215,1216,1217,1218,1219,1220,1221,1222,1223</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='from_generator.from_generator.generator_map_fn.generator_py_func' parameters='iterator_id'>
 				<method_info nloc='23' complexity='6' token_count='139' nesting_level='3' start_line='364' end_line='398'></method_info>
 			<added_lines>366,367,368</added_lines>
 			<deleted_lines>366,367,368,369,370</deleted_lines>
 		</method>
 		<method name='__init__.tf_init_func' parameters='args'>
 				<method_info nloc='27' complexity='9' token_count='236' nesting_level='2' start_line='1082' end_line='1126'></method_info>
 			<added_lines>1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,1117,1118,1119,1120,1121,1122,1123,1124,1125,1126</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='from_generator' parameters='generator,output_types,output_shapes'>
 				<method_info nloc='19' complexity='3' token_count='113' nesting_level='1' start_line='266' end_line='449'></method_info>
 			<added_lines>334,337,350,366,367,368,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,426,427,428,429,430,432,433,441</added_lines>
 			<deleted_lines>334,337,350,366,367,368,369,370,413,414,415,416,417,418,419,421,429</deleted_lines>
 		</method>
 		<method name='output_types' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='9' nesting_level='1' start_line='1234' end_line='1235'></method_info>
 			<added_lines>1234,1235</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='from_generator.get_iterator_id_fn' parameters='unused_dummy'>
 				<method_info nloc='3' complexity='1' token_count='26' nesting_level='2' start_line='334' end_line='348'></method_info>
 			<added_lines>334,337</added_lines>
 			<deleted_lines>334,337</deleted_lines>
 		</method>
 		<method name='from_generator.generator_map_fn' parameters='iterator_id_t'>
 				<method_info nloc='8' complexity='3' token_count='59' nesting_level='2' start_line='350' end_line='409'></method_info>
 			<added_lines>350,366,367,368,409</added_lines>
 			<deleted_lines>350,366,367,368,369,370</deleted_lines>
 		</method>
 		<method name='from_generator.from_generator.finalize_fn.finalize_py_func' parameters='iterator_id'>
 				<method_info nloc='3' complexity='1' token_count='24' nesting_level='3' start_line='412' end_line='419'></method_info>
 			<added_lines>412,413,414,415,416,417,418,419</added_lines>
 			<deleted_lines>413,414,415,416,417,418,419</deleted_lines>
 		</method>
 		<method name='from_generator.flat_map_fn' parameters='iterator_id_t'>
 				<method_info nloc='3' complexity='1' token_count='25' nesting_level='2' start_line='413' end_line='421'></method_info>
 			<added_lines>413,414,415,416,417,418,419,420,421</added_lines>
 			<deleted_lines>413,414,415,416,417,418,419,421</deleted_lines>
 		</method>
 		<method name='output_classes' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='9' nesting_level='1' start_line='1226' end_line='1227'></method_info>
 			<added_lines>1226,1227</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>1048,1049,1050,1211,1224,1225,1228,1229,1232,1233,1236,1237</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
