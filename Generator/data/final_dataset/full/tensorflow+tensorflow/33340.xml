<bug_data>
<bug id='33340' author='off99555' open_date='2019-10-14T15:13:52Z' closed_time='2020-01-15T05:51:39Z'>
 	<summary>Significant prediction slowdown after model.compile()</summary>
 	<description>
 System information
 
 OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10
 TensorFlow installed from (source or binary): pip install tensorflow
 TensorFlow version: 2.0.0
 Python version: 3.7
 CUDA/cuDNN version: CUDA=10.0, cuDNN=7.6.4
 GPU model and memory: GTX 1060 6GB
 
 Describe the current behavior
 The prediction speed is slowed down a lot after model.compile() call.
 Describe the expected behavior
 Speed should not be affected. Predict function is used by users assuming that it will work fast because we use it all the time in production. It should not cause surprise to users.
 
 &lt;denchmark-link:https://nbviewer.jupyter.org/github/off99555/TensorFlowExperiments/blob/master/test-prediction-speed-after-compile.ipynb?flush_cache=true&gt;https://nbviewer.jupyter.org/github/off99555/TensorFlowExperiments/blob/master/test-prediction-speed-after-compile.ipynb?flush_cache=true&lt;/denchmark-link&gt;
 
 &lt;denchmark-link:https://user-images.githubusercontent.com/15215732/66762282-e3dc0900-eecf-11e9-8d93-82c8bcc5325b.png&gt;&lt;/denchmark-link&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='off99555' date='2019-10-14T16:30:26Z'>
 		&lt;denchmark-link:https://stackoverflow.com/questions/58378374/why-does-keras-model-predict-slower-after-compile/58378941#58378941&gt;Relevant SO&lt;/denchmark-link&gt;
 , and another minimal reproducible example:
 from tensorflow.keras.layers import Input, Dense
 from tensorflow.keras.models import Model
 import numpy as np
 from time import time
 
 def timeit(func, arg, iterations):
     t0 = time()
     for _ in range(iterations):
         func(arg)
     print("%.4f sec" % (time() - t0))
 
 ipt   = Input(shape=(4,))
 x     = Dense(2, activation='relu')(ipt)
 out   = Dense(1, activation='sigmoid')(x)
 model = Model(ipt, out)
 
 X = np.random.randn(32,4)
 
 timeit(model.predict, X, 1000)
 model.compile('adam', loss='binary_crossentropy')
 timeit(model.predict, X, 1000)
 model._make_train_function()  # build optimizer
 timeit(model.predict, X, 1000)
 Outputs:
 0.9891 sec
 29.785 sec
 29.521 sec
 That's a 30-fold slowdown. Worse yet, building the optimizer does not elicit any further slowdowns - so "graph size" may not be the main explanation here.
 		</comment>
 		<comment id='2' author='off99555' date='2019-10-15T00:01:01Z'>
 		&lt;denchmark-link:https://stackoverflow.com/questions/58378374/why-does-keras-model-predict-slower-after-compile/58385156#58385156&gt;Solved&lt;/denchmark-link&gt;
 .
 		</comment>
 		<comment id='3' author='off99555' date='2019-10-15T07:49:13Z'>
 		&lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  ,
 Can you confirm if the issue is resolved?Thanks!
 		</comment>
 		<comment id='4' author='off99555' date='2019-10-15T11:57:39Z'>
 		It does not seem to me that it is resolved. It's more like we know how the issue occurs but we don't have a solution, just workaround. I need to compare timing between compiled and non-compiled version and see which is faster. But I don't think a user will be aware of this in general. So we should make a better solution.
 In this case, should I close the issue or keep it open?
 		</comment>
 		<comment id='5' author='off99555' date='2019-10-15T13:46:08Z'>
 		&lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  I'd agree to request a documentation improvement from TensorFlow to notify users of this, but I doubt any code-level changes will be implemented to address this as it'd require revamping a massive portion of TF graph. It's up to the user to be aware of functionality differences and adjust accordingly - but admittedly, while this isn't the only issue where a workaround is required, other cases are at least documented.
 		</comment>
 		<comment id='6' author='off99555' date='2019-10-18T21:10:25Z'>
 		&lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  I cannot reproduce the issue. When I ran it in colab, computation time is little more but not as much as you reported. I have checked some other models also. Please check the &lt;denchmark-link:https://colab.sandbox.google.com/gist/jvishnuvardhan/d91713318125c34768c5f8841e60b928/untitled582.ipynb&gt;gist here&lt;/denchmark-link&gt;
 .
 &lt;denchmark-link:https://github.com/OverLordGoldDragon&gt;@OverLordGoldDragon&lt;/denchmark-link&gt;
  I could reproduce your issue. The reason is that when the model is very small, it takes more time to predict after compilation. I have checked other similar small models and I noticed it. Thanks!
 		</comment>
 		<comment id='7' author='off99555' date='2019-10-18T21:25:32Z'>
 		
 The reason is that when the model is very small, it takes more time to predict after compilation
 
 &lt;denchmark-link:https://github.com/jvishnuvardhan&gt;@jvishnuvardhan&lt;/denchmark-link&gt;
  That is the problem, yes, but not its explanation - I've done the latter &lt;denchmark-link:https://stackoverflow.com/questions/58378374/why-does-keras-model-predict-slower-after-compile/58385156#58385156&gt;here&lt;/denchmark-link&gt;
 . Further, it's not the model size, but model size  data size.
 As noted by &lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  , the solution only works for those aware of the problem and its workaround - this issue, however, isn't documented or mentioned in a docstring. To remedy, some form of mention should be made in documentation or  docstring as a disclaimer.
 		</comment>
 		<comment id='8' author='off99555' date='2019-12-28T19:11:44Z'>
 		As OverLordGoldDragon mentioned, you can disable the experimental_run_tf_function flag for a Keras model and force it to the old v1 execution path (I think). It's a bit nicer than disabling eager execution globally.
 The good news is that you can do this by simply passing the param to the compile() function, so you don't need to make any private calls. Like so: model.compile(loss=loss, optimizer=optimizer, experimental_run_tf_function=False)
 This restores the performance for me (I experienced more than 10x slowdown). Let me second everybody in that I'm surprised this is not a big issue - the parameter is on the public interface of a major release, but it's not even mentioned in the docstring.
 		</comment>
 		<comment id='9' author='off99555' date='2019-12-28T19:51:41Z'>
 		Noone assigned; if it doesn't cause a compile error, doesn't mean it isn't a worthwhile problem. Has anyone made a docstring PR on this yet? If not, I could
 		</comment>
 		<comment id='10' author='off99555' date='2019-12-28T23:12:17Z'>
 		Hi. Let me try to address some of the questions here and see if that helps.
 
 Has anyone made a docstring PR on this yet?
 
 experimental_run_tf_function is an implementation detail, and that flag is mostly there as a debug during the transition. We don't plan to document it because it will be removed at some point in the future and the True behavior will be the only behavior.
 Now I expect that you may be surprised (or aghast) that it's going to be always on given the discussion in this thread. What experimental_run_tf_function does is funnel all calls to fit, evaluate, and predict through a central adapter which creates a Dataset and performs a variety of checks and input validation. This is generally desirable because it makes everything more robust, but there is some overhead to spinning up this machinery which is not amortized by small models with little data.
 Code to profile the step:
 &lt;denchmark-code&gt;import cProfile
 import pstats
 
 profiler = cProfile.Profile()
 profiler.enable()
 for _ in range(5):
   model.predict(x)
 profiler.disable()
 
 stats = pstats.Stats(profiler)
 stats.sort_stats("cumtime").print_stats(20)
 &lt;/denchmark-code&gt;
 
 In this case most of the extra time is spent creating the dataset; there is machinery in there which makes sense, but it's surplus to requirements for the degenerate case of a single batch. (&lt;denchmark-link:https://github.com/jsimsa&gt;@jsimsa&lt;/denchmark-link&gt;
  in case you want to look into the init time, but it's not obvious that it's unreasonable given the pipeline.) Really, this is not what  is for. That endpoint is for predictions on lots of data where the batching and aggregation machinery in that endpoint is necessary. For single batch prediction there is , which doesn't invoke all of that machinery and just directly calls into the model function. I tested it, and it is identical in v1 and v2. (And faster than even v1 )
 However this seems to be a common pitfall; I see lots of issues around single batch . (&lt;denchmark-link:https://github.com/martinwicke&gt;@martinwicke&lt;/denchmark-link&gt;
  increment your counter...) From a documentation standpoint, I think the most valuable contribution would be to document  in the  docstring, and probably also warn in  when the batch cardinality is one. &lt;denchmark-link:https://github.com/ymodak&gt;@ymodak&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/jvishnuvardhan&gt;@jvishnuvardhan&lt;/denchmark-link&gt;
   Can you remind me to bring this up at the next triage? And &lt;denchmark-link:https://github.com/OverLordGoldDragon&gt;@OverLordGoldDragon&lt;/denchmark-link&gt;
  if you want to take a crack at a PR that would be great; feel free to tag me and I'll try to provide some assistance.
 		</comment>
 		<comment id='11' author='off99555' date='2019-12-28T23:12:52Z'>
 		Oh, and &lt;denchmark-link:https://github.com/goldiegadde&gt;@goldiegadde&lt;/denchmark-link&gt;
  for tracking 2.2 performance, of course.
 		</comment>
 		<comment id='12' author='off99555' date='2019-12-29T00:47:17Z'>
 		&lt;denchmark-link:https://github.com/robieta&gt;@robieta&lt;/denchmark-link&gt;
  Solid response, thanks - I'll look into the PR sometime. As for , so long as a faster alternative remains (i.e. ) and is noted in a docstring, it'd make an excellent resolution.
 		</comment>
 		<comment id='13' author='off99555' date='2019-12-29T14:17:29Z'>
 		Thanks for the clarification, and for the quick help! model.predict_on_batch speeds things up, but is still significantly slower on the v2 path. Here is the cumsum using your profile snippet (using tf2.0.0, calling predict 100 times instead of 5) for a small DQN model on a small batch of data:
 
 
 
 experimental_run_tf_function
 predict()
 predict_on_batch()
 
 
 
 
 False / v1
 0.209s
 0.078s
 
 
 True / v2 (default)
 3.720s
 0.246s
 
 
 
 So, anyone with a single batch should switch to predict_on_batch, but an even faster option exists (v1 predict_on_batch), which is going to be deprecated if I understood correctly.
 Is this use case truly so exotic that we simply should not use the Keras API for it? I understand that we should of course look into batching, but for anyone who just writes quick prototypes it would be nice to have a fast light-weight way of evaluating things. Anyway, warning single-batch users of predict() will surely help most users, so that sounds great.
 Also, here's a detail that may be important to people who migrate their code: When running in v2 mode, predict_on_batch will not return a numpy array (contrary to the docstring), but an EagerTensor instead. The caller may want to wrap the result -- as in np.array(model.predict_on_batch(...)) -- to guarantee the same behavior for both v1 and v2. predict however returns a numpy array in both cases.  If you like, I can make a PR for the docstring.
 		</comment>
 		<comment id='14' author='off99555' date='2020-01-03T14:47:30Z'>
 		&lt;denchmark-link:https://github.com/robieta&gt;@robieta&lt;/denchmark-link&gt;
  Actually I'll pass on making a PR; currently rather occupied - may try later if noone has done it
 		</comment>
 		<comment id='15' author='off99555' date='2020-01-13T11:48:25Z'>
 		&lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/OverLordGoldDragon&gt;@OverLordGoldDragon&lt;/denchmark-link&gt;
   I tried to reproduce this with tf nightly but it doesn't seem to occur anymore. Or equivalently even without compile it becomes pretty slow as well.
 Now this is more of a tensorflow 1.15 much faster than tensorflow v2 -- can you confirm?
 		</comment>
 		<comment id='16' author='off99555' date='2020-01-14T11:00:50Z'>
 		&lt;denchmark-link:https://github.com/tanzhenyu&gt;@tanzhenyu&lt;/denchmark-link&gt;
  Can confirm for nightly. The v1 path fallback has been removed in &lt;denchmark-link:https://github.com/tensorflow/tensorflow/commit/c73c99ca3e0bacf2bca313f270bb3eae28869530#diff-de9b96ac2d81503324cbbbe21732031f&gt;c73c99c#diff-de9b96ac2d81503324cbbbe21732031f&lt;/denchmark-link&gt;
  , so everything now executes on v2, regardless of model.compile()
 It's still possible to get the old speed back behavior by using tf.compat.v1.disable_eager_execution(). In any case, for most users moving to predict_on_batch() should be recommended, and also makes the slowdown less drastic (see numbers above) so the issue is less extreme.
 That said, sorry for taking so long on the PR for warning single-batch predict() users.
 		</comment>
 		<comment id='17' author='off99555' date='2020-01-15T02:44:40Z'>
 		&lt;denchmark-link:https://github.com/ttbrunner&gt;@ttbrunner&lt;/denchmark-link&gt;
  Ah yeah that was the commit, thanks.
 Ok so we follow the adapter pattern for convert numpy and dataframes to dataset first, and has a single path for execution. Apparently the speed down is mainly two things: 1) the construction of dataset. 2) creating tf.function for predict. (Check TensorLikeDataAdapter under /python/keras/engine/data_adapter.py if you're interested)
 &lt;denchmark-link:https://github.com/off99555&gt;@off99555&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/OverLordGoldDragon&gt;@OverLordGoldDragon&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/ttbrunner&gt;@ttbrunner&lt;/denchmark-link&gt;
  So here's what I would recommend going forward:
 
 
 you can predict the output using model call, not model predict, i.e., calling model(x) would make this much faster because there are no "conversion to dataset" part, and also it's directly calling a cached tf.function. However be aware that if you have batch norm layers or any other layers that behaves differently between training and inference, make sure to call it with model(x, training=False)
 
 
 I will make a docstring to recommend users to use model call and explain predict is for large dataset.
 
 
 SG?
 		</comment>
 		<comment id='18' author='off99555' date='2020-01-15T03:02:37Z'>
 		&lt;denchmark-link:https://github.com/tanzhenyu&gt;@tanzhenyu&lt;/denchmark-link&gt;
  I haven't benchmarked any of it, but if it is as you say - sounds like an excellent resolution indeed. Do let me know when it's done so I update my SO answer -- thanks for following through with this to the end.
 		</comment>
 		<comment id='19' author='off99555' date='2020-01-15T05:51:39Z'>
 		I have updated the doc, also tested the performance for model(x) in nightly. Closing it for now. Thanks all for reporting and collaborative work!
 		</comment>
 		<comment id='20' author='off99555' date='2020-01-15T06:04:14Z'>
 		&lt;denchmark-link:https://github.com/tanzhenyu&gt;@tanzhenyu&lt;/denchmark-link&gt;
  Great. To clarify, is the speedup for TF 2.1+ only, or also 2.0? (if latter, is 2.1 even faster?)
 		</comment>
 		<comment id='21' author='off99555' date='2020-01-15T06:05:21Z'>
 		
 @tanzhenyu Great. To clarify, is the speedup for TF 2.1+ only, or also 2.0? (if latter, is 2.1 even faster?)
 
 I believe this should be universal to 2.x versions
 		</comment>
 		<comment id='22' author='off99555' date='2020-01-15T09:06:29Z'>
 		Thanks for the docstring update, also for the explanation. I'm always interested!
 Can confirm that model(x) has the same runtime as predict_on_batch(x), i.e. the v2 path is still slightly slower. It's OK for my use case though, so thanks again.
 Another note for users: it's possible to specify model.run_eagerly = False before compiling. With this and the model(x) call, I am getting almost the same performance as in v1, without globally disabling eager execution.
 P.S.: Sorry for the many edits of this post.
 		</comment>
 		<comment id='23' author='off99555' date='2020-01-16T05:54:40Z'>
 		
 Thanks for the docstring update, also for the explanation. I'm always interested!
 Can confirm that model(x) has the same runtime as predict_on_batch(x), i.e. the v2 path is still slightly slower. It's OK for my use case though, so thanks again.
 Another note for users: it's possible to specify model.run_eagerly = False before compiling. With this and the model(x) call, I am getting almost the same performance as in v1, without globally disabling eager execution.
 P.S.: Sorry for the many edits of this post.
 
 You can also compile(..., run_eagerly=False)
 		</comment>
 		<comment id='24' author='off99555' date='2020-01-16T06:12:48Z'>
 		&lt;denchmark-link:https://github.com/tanzhenyu&gt;@tanzhenyu&lt;/denchmark-link&gt;
  Side-ish question: what does  do in TF2, which runs in eager by default? From inspecting a fair chunk of the source code, it seems to change only a few execution paths for certain less-usual dataset types. Likewise, any difference with  vs. disabling eager?
 		</comment>
 		<comment id='25' author='off99555' date='2020-03-27T21:50:32Z'>
 		
 @ttbrunner Ah yeah that was the commit, thanks.
 Ok so we follow the adapter pattern for convert numpy and dataframes to dataset first, and has a single path for execution. Apparently the speed down is mainly two things: 1) the construction of dataset. 2) creating tf.function for predict. (Check TensorLikeDataAdapter under /python/keras/engine/data_adapter.py if you're interested)
 @off99555 @OverLordGoldDragon @ttbrunner So here's what I would recommend going forward:
 
 you can predict the output using model call, not model predict, i.e., calling model(x) would make this much faster because there are no "conversion to dataset" part, and also it's directly calling a cached tf.function. However be aware that if you have batch norm layers or any other layers that behaves differently between training and inference, make sure to call it with model(x, training=False)
 I will make a docstring to recommend users to use model call and explain predict is for large dataset.
 
 SG?
 
 &lt;denchmark-link:https://github.com/tanzhenyu&gt;@tanzhenyu&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/robieta&gt;@robieta&lt;/denchmark-link&gt;
  Could you please clarify what the difference between model.predict_on_batch(x) and model(x) is?
 The call stack and execution times (as captured by statistical profiler pyinstrument) are extremely different.
 Here are the details for model.predict_on_batch(x):
 &lt;denchmark-code&gt;0.017 &lt;module&gt;  code1.py:1
 └─ 0.017 predict_on_batch  tensorflow_core/python/keras/engine/training.py:1220
    └─ 0.017 predict_on_batch  tensorflow_core/python/keras/engine/training_v2_utils.py:514
       ├─ 0.005 _standardize_user_data  tensorflow_core/python/keras/engine/training.py:2247
       │  ├─ 0.000 run_eagerly  tensorflow_core/python/keras/engine/training.py:508
       │  │  └─ 0.000 wrapped  tensorflow_core/python/training/tracking/layer_utils.py:126
       │  └─ 0.005 _standardize_tensors  tensorflow_core/python/keras/engine/training.py:2385
       │     ├─ 0.001 standardize_input_data  tensorflow_core/python/keras/engine/training_utils.py:460
       │     │  └─ 0.000 &lt;listcomp&gt;  tensorflow_core/python/keras/engine/training_utils.py:526
       │     │     └─ 0.000 standardize_single_array  tensorflow_core/python/keras/engine/training_utils.py:439
       │     ├─ 0.001 pack_sequence_as  tensorflow_core/python/util/nest.py:471
       │     │  └─ 0.001 _pack_sequence_as  tensorflow_core/python/util/nest.py:431
       │     │     ├─ 0.000 _packed_nest_with_indices  tensorflow_core/python/util/nest.py:396
       │     │     │  └─ 0.000 _yield_value  tensorflow_core/python/util/nest.py:174
       │     │     │     └─ 0.000 _yield_sorted_items  tensorflow_core/python/util/nest.py:179
       │     │     └─ 0.000 _sequence_like  tensorflow_core/python/util/nest.py:119
       │     ├─ 0.002 map_structure  tensorflow_core/python/util/nest.py:507
       │     │  ├─ 0.001 &lt;listcomp&gt;  tensorflow_core/python/util/nest.py:568
       │     │  │  └─ 0.001 _type_spec_from_value  tensorflow_core/python/keras/engine/training.py:2431
       │     │  │     └─ 0.000 __init__  tensorflow_core/python/framework/tensor_spec.py:39
       │     │  └─ 0.001 pack_sequence_as  tensorflow_core/python/util/nest.py:471
       │     │     └─ 0.001 _pack_sequence_as  tensorflow_core/python/util/nest.py:431
       │     │        ├─ 0.001 _packed_nest_with_indices  tensorflow_core/python/util/nest.py:396
       │     │        │  └─ 0.000 _yield_value  tensorflow_core/python/util/nest.py:174
       │     │        │     └─ 0.000 _yield_sorted_items  tensorflow_core/python/util/nest.py:179
       │     │        └─ 0.000 _sequence_like  tensorflow_core/python/util/nest.py:119
       │     │           └─ 0.000 [self]  
       │     └─ 0.000 wrapped  tensorflow_core/python/training/tracking/layer_utils.py:126
       ├─ 0.001 cast_to_model_input_dtypes  tensorflow_core/python/keras/engine/training_utils.py:1363
       │  └─ 0.001 map_structure  tensorflow_core/python/util/nest.py:507
       │     ├─ 0.000 pack_sequence_as  tensorflow_core/python/util/nest.py:471
       │     │  └─ 0.000 _pack_sequence_as  tensorflow_core/python/util/nest.py:431
       │     │     └─ 0.000 _packed_nest_with_indices  tensorflow_core/python/util/nest.py:396
       │     ├─ 0.001 &lt;listcomp&gt;  tensorflow_core/python/util/nest.py:568
       │     │  └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
       │     │     └─ 0.001 cast  tensorflow_core/python/ops/math_ops.py:649
       │     │        └─ 0.000 cast  tensorflow_core/python/ops/gen_math_ops.py:1944
       │     └─ 0.000 pack_sequence_as  tensorflow_core/python/util/nest.py:471
       ├─ 0.000 _get_or_make_on_batch_function  tensorflow_core/python/keras/engine/training_v2_utils.py:103
       └─ 0.010 __call__  tensorflow_core/python/eager/def_function.py:551
          └─ 0.010 _call  tensorflow_core/python/eager/def_function.py:590
             └─ 0.010 __call__  tensorflow_core/python/eager/function.py:2359
                ├─ 0.000 _maybe_define_function  tensorflow_core/python/eager/function.py:2637
                │  └─ 0.000 _cache_key  tensorflow_core/python/eager/function.py:2496
                └─ 0.010 _filtered_call  tensorflow_core/python/eager/function.py:1593
                   └─ 0.009 _call_flat  tensorflow_core/python/eager/function.py:1613
                      ├─ 0.008 call  tensorflow_core/python/eager/function.py:505
                      │  └─ 0.008 quick_execute  tensorflow_core/python/eager/execute.py:33
                      │     └─ 0.008 [self]  
                      └─ 0.001 _build_call_outputs  tensorflow_core/python/eager/function.py:1909
                         └─ 0.001 pack_sequence_as  tensorflow_core/python/util/nest.py:471
                            └─ 0.001 _pack_sequence_as  tensorflow_core/python/util/nest.py:431
                               ├─ 0.001 _packed_nest_with_indices  tensorflow_core/python/util/nest.py:396
                               │  └─ 0.000 _yield_value  tensorflow_core/python/util/nest.py:174
                               │     └─ 0.000 _yield_sorted_items  tensorflow_core/python/util/nest.py:179
                               └─ 0.000 _sequence_like  tensorflow_core/python/util/nest.py:119
 &lt;/denchmark-code&gt;
 
 And here are the details for the much slower model(x):
 &lt;denchmark-code&gt;0.041 &lt;module&gt;  code2.py:1
 └─ 0.041 __call__  tensorflow_core/python/keras/engine/base_layer.py:628
    └─ 0.041 call  tensorflow_core/python/keras/engine/network.py:693
       └─ 0.041 _run_internal_graph  tensorflow_core/python/keras/engine/network.py:791
          └─ 0.041 __call__  tensorflow_core/python/keras/layers/recurrent.py:637
             └─ 0.041 __call__  tensorflow_core/python/keras/engine/base_layer.py:628
                ├─ 0.001 helper  contextlib.py:237
                │  └─ 0.001 __init__  contextlib.py:81
                ├─ 0.039 call  tensorflow_core/python/keras/layers/recurrent.py:2689
                │  └─ 0.039 call  tensorflow_core/python/keras/layers/recurrent.py:699
                │     ├─ 0.001 _process_inputs  tensorflow_core/python/keras/layers/recurrent.py:804
                │     │  └─ 0.001 get_initial_state  tensorflow_core/python/keras/layers/recurrent.py:613
                │     │     └─ 0.001 get_initial_state  tensorflow_core/python/keras/layers/recurrent.py:2455
                │     │        └─ 0.001 _generate_zero_filled_state_for_cell  tensorflow_core/python/keras/layers/recurrent.py:2891
                │     │           └─ 0.001 _generate_zero_filled_state  tensorflow_core/python/keras/layers/recurrent.py:2898
                │     │              └─ 0.001 map_structure  tensorflow_core/python/util/nest.py:507
                │     │                 └─ 0.001 &lt;listcomp&gt;  tensorflow_core/python/util/nest.py:568
                │     │                    └─ 0.001 create_zeros  tensorflow_core/python/keras/layers/recurrent.py:2905
                │     │                       └─ 0.001 zeros  tensorflow_core/python/ops/array_ops.py:2399
                │     │                          └─ 0.001 fill  tensorflow_core/python/ops/array_ops.py:198
                │     │                             └─ 0.001 fill  tensorflow_core/python/ops/gen_array_ops.py:3193
                │     └─ 0.038 rnn  tensorflow_core/python/keras/backend.py:3808
                │        ├─ 0.001 &lt;listcomp&gt;  tensorflow_core/python/keras/backend.py:4023
                │        │  └─ 0.001 _slice_helper  tensorflow_core/python/ops/array_ops.py:759
                │        │     └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
                │        ├─ 0.001 [self]  
                │        └─ 0.036 while_loop  tensorflow_core/python/ops/control_flow_ops.py:2482
                │           ├─ 0.018 _step  tensorflow_core/python/keras/backend.py:4096
                │           │  ├─ 0.001 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │           │  ├─ 0.003 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │           │  │  └─ 0.003 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │           │  │     ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │           │  │     │  └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           │  │     │     └─ 0.001 __exit__  tensorflow_core/python/framework/ops.py:6396
                │           │  │     ├─ 0.001 bias_add  tensorflow_core/python/keras/backend.py:5508
                │           │  │     │  └─ 0.001 bias_add  tensorflow_core/python/ops/nn_ops.py:2699
                │           │  │     │     └─ 0.001 __exit__  tensorflow_core/python/framework/ops.py:6396
                │           │  │     └─ 0.001 dot  tensorflow_core/python/keras/backend.py:1614
                │           │  │        └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
                │           │  │           └─ 0.001 matmul  tensorflow_core/python/ops/math_ops.py:2617
                │           │  │              └─ 0.001 mat_mul  tensorflow_core/python/ops/gen_math_ops.py:5576
                │           │  ├─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4132
                │           │  │  └─ 0.001 wrapped  tensorflow_core/python/util/tf_should_use.py:234
                │           │  │     └─ 0.001 write  tensorflow_core/python/ops/tensor_array_ops.py:1139
                │           │  │        └─ 0.001 write  tensorflow_core/python/ops/tensor_array_ops.py:829
                │           │  │           └─ 0.001 _write  tensorflow_core/python/ops/tensor_array_ops.py:779
                │           │  │              └─ 0.001 numpy  tensorflow_core/python/framework/ops.py:918
                │           │  │                 └─ 0.001 _numpy  tensorflow_core/python/framework/ops.py:905
                │           │  ├─ 0.001 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │           │  │  └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4070
                │           │  │     └─ 0.001 where_v2  tensorflow_core/python/ops/array_ops.py:3889
                │           │  │        └─ 0.001 select_v2  tensorflow_core/python/ops/gen_math_ops.py:8662
                │           │  ├─ 0.002 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │           │  │  └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │           │  │     ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │           │  │     │  └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           │  │     │     └─ 0.001 _add_dispatch  tensorflow_core/python/ops/math_ops.py:1189
                │           │  │     │        └─ 0.001 __eq__  tensorflow_core/python/framework/dtypes.py:261
                │           │  │     └─ 0.001 dot  tensorflow_core/python/keras/backend.py:1614
                │           │  │        └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
                │           │  │           └─ 0.001 matmul  tensorflow_core/python/ops/math_ops.py:2617
                │           │  │              └─ 0.001 mat_mul  tensorflow_core/python/ops/gen_math_ops.py:5576
                │           │  ├─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           │  │  └─ 0.001 __exit__  tensorflow_core/python/framework/ops.py:6396
                │           │  ├─ 0.001 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │           │  │  └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │           │  │     └─ 0.001 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │           │  │        └─ 0.001 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │           │  │           └─ 0.001 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                │           │  │              └─ 0.001 args_to_matching_eager  tensorflow_core/python/eager/execute.py:236
                │           │  │                 └─ 0.001 convert_to_tensor  tensorflow_core/python/framework/ops.py:1263
                │           │  │                    └─ 0.001 _autopacking_conversion_function  tensorflow_core/python/ops/array_ops.py:1355
                │           │  │                       └─ 0.001 _should_not_autopack  tensorflow_core/python/ops/array_ops.py:1345
                │           │  │                          └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/ops/array_ops.py:1351
                │           │  ├─ 0.003 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │           │  │  ├─ 0.001 [self]  
                │           │  │  └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │           │  │     ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │           │  │     │  └─ 0.001 sigmoid  tensorflow_core/python/keras/activations.py:246
                │           │  │     │     └─ 0.001 sigmoid  tensorflow_core/python/ops/math_ops.py:3134
                │           │  │     │        └─ 0.001 sigmoid  tensorflow_core/python/ops/gen_math_ops.py:8720
                │           │  │     └─ 0.001 dot  tensorflow_core/python/keras/backend.py:1614
                │           │  │        └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
                │           │  │           └─ 0.001 matmul  tensorflow_core/python/ops/math_ops.py:2617
                │           │  │              └─ 0.001 mat_mul  tensorflow_core/python/ops/gen_math_ops.py:5576
                │           │  ├─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           │  │  └─ 0.001 _add_dispatch  tensorflow_core/python/ops/math_ops.py:1189
                │           │  │     └─ 0.001 add_v2  tensorflow_core/python/ops/gen_math_ops.py:451
                │           │  ├─ 0.001 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │           │  │  └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │           │  │     └─ 0.001 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │           │  │        └─ 0.001 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │           │  │           └─ 0.001 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                │           │  │              └─ 0.001 args_to_matching_eager  tensorflow_core/python/eager/execute.py:236
                │           │  │                 └─ 0.001 convert_to_tensor  tensorflow_core/python/framework/ops.py:1263
                │           │  └─ 0.003 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │           │     ├─ 0.001 [self]  
                │           │     └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │           │        ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │           │        │  └─ 0.001 sigmoid  tensorflow_core/python/keras/activations.py:246
                │           │        │     └─ 0.001 sigmoid  tensorflow_core/python/ops/math_ops.py:3134
                │           │        │        └─ 0.001 sigmoid  tensorflow_core/python/ops/gen_math_ops.py:8720
                │           │        └─ 0.001 dot  tensorflow_core/python/keras/backend.py:1614
                │           │           └─ 0.001 wrapper  tensorflow_core/python/util/dispatch.py:177
                │           │              └─ 0.001 matmul  tensorflow_core/python/ops/math_ops.py:2617
                │           │                 └─ 0.001 mat_mul  tensorflow_core/python/ops/gen_math_ops.py:5576
                │           ├─ 0.001 [self]  
                │           ├─ 0.004 _step  tensorflow_core/python/keras/backend.py:4096
                │           │  ├─ 0.002 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │           │  │  └─ 0.002 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │           │  │     └─ 0.002 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │           │  │        └─ 0.002 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │           │  │           └─ 0.002 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                │           │  │              ├─ 0.001 quick_execute  tensorflow_core/python/eager/execute.py:33
                │           │  │              └─ 0.001 args_to_matching_eager  tensorflow_core/python/eager/execute.py:236
                │           │  │                 └─ 0.001 convert_to_tensor  tensorflow_core/python/framework/ops.py:1263
                │           │  │                    └─ 0.001 get  tensorflow_core/python/framework/tensor_conversion_registry.py:114
                │           │  └─ 0.002 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │           │     └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │           │        ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │           │        │  └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           │        │     └─ 0.001 _mul_dispatch  tensorflow_core/python/ops/math_ops.py:1197
                │           │        │        └─ 0.001 mul  tensorflow_core/python/ops/gen_math_ops.py:6093
                │           │        └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │           ├─ 0.001 assert_same_structure  tensorflow_core/python/util/nest.py:293
                │           └─ 0.012 _step  tensorflow_core/python/keras/backend.py:4096
                │              ├─ 0.002 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │              │  └─ 0.002 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │              │     └─ 0.002 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │              │        └─ 0.002 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │              │           └─ 0.002 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                │              ├─ 0.002 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │              │  └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │              │     ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │              │     │  └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │              │     │     └─ 0.001 _mul_dispatch  tensorflow_core/python/ops/math_ops.py:1197
                │              │     │        └─ 0.001 mul  tensorflow_core/python/ops/gen_math_ops.py:6093
                │              │     └─ 0.001 binary_op_wrapper  tensorflow_core/python/ops/math_ops.py:899
                │              │        └─ 0.001 _add_dispatch  tensorflow_core/python/ops/math_ops.py:1189
                │              │           └─ 0.001 add_v2  tensorflow_core/python/ops/gen_math_ops.py:451
                │              ├─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4108
                │              │  └─ 0.001 read  tensorflow_core/python/ops/tensor_array_ops.py:1127
                │              │     └─ 0.001 read  tensorflow_core/python/ops/tensor_array_ops.py:746
                │              ├─ 0.002 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │              │  ├─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4070
                │              │  │  └─ 0.001 where_v2  tensorflow_core/python/ops/array_ops.py:3889
                │              │  │     └─ 0.001 select_v2  tensorflow_core/python/ops/gen_math_ops.py:8662
                │              │  └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │              │     └─ 0.001 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │              │        └─ 0.001 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │              │           └─ 0.001 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                │              │              └─ 0.001 args_to_matching_eager  tensorflow_core/python/eager/execute.py:236
                │              │                 └─ 0.001 &lt;listcomp&gt;  tensorflow_core/python/eager/execute.py:271
                │              ├─ 0.002 step  tensorflow_core/python/keras/layers/recurrent.py:765
                │              │  └─ 0.002 call  tensorflow_core/python/keras/layers/recurrent.py:2355
                │              │     ├─ 0.001 _compute_carry_and_output_fused  tensorflow_core/python/keras/layers/recurrent.py:2346
                │              │     │  └─ 0.001 tanh  tensorflow_core/python/keras/activations.py:224
                │              │     │     └─ 0.001 tanh  tensorflow_core/python/ops/gen_math_ops.py:10284
                │              │     └─ 0.001 bias_add  tensorflow_core/python/keras/backend.py:5508
                │              ├─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4108
                │              │  └─ 0.001 read  tensorflow_core/python/ops/tensor_array_ops.py:1127
                │              │     └─ 0.001 read  tensorflow_core/python/ops/tensor_array_ops.py:746
                │              └─ 0.002 compute_masked_output  tensorflow_core/python/keras/backend.py:4065
                │                 ├─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4070
                │                 │  └─ 0.001 where_v2  tensorflow_core/python/ops/array_ops.py:3889
                │                 └─ 0.001 &lt;genexpr&gt;  tensorflow_core/python/keras/backend.py:4067
                │                    └─ 0.001 _expand_mask  tensorflow_core/python/keras/backend.py:3913
                │                       └─ 0.001 tile  tensorflow_core/python/ops/gen_array_ops.py:10344
                │                          └─ 0.001 tile_eager_fallback  tensorflow_core/python/ops/gen_array_ops.py:10431
                └─ 0.001 _set_mask_metadata  tensorflow_core/python/keras/engine/base_layer.py:1918
                   └─ 0.001 flatten  tensorflow_core/python/util/nest.py:242
 &lt;/denchmark-code&gt;
 
 Out of the two suggestions you guys provided in this thread, the one that ended up being put in the docstring is the slowest one (even slower than model.predict(x)) for my simple LSTM encoder being run on Tensorflow 2.1.0 on with GPU support, and other users like me might be confused.
 Also, can you please clarify why calling model(x) runs the model step by step even though run_eagerly is set to False and, as per tanzhenyu's comment, it should instead call a cached tf.function?
 Thanks!
 		</comment>
 	</comments>
 </bug>
<commit id='42f469be0f3e8c36624f0b01c571e7ed15f75faf' author='Zhenyu Tan' date='2020-01-14 20:01:47-08:00'>
 	<dmm_unit complexity='None' interfacing='None' size='None'></dmm_unit>
 	<modification change_type='MODIFY' old_name='tensorflow\python\keras\engine\training.py' new_name='tensorflow\python\keras\engine\training.py'>
 		<file_info nloc='1575' complexity='339' token_count='9039'></file_info>
 		<modified_lines>
 			<added_lines>837,838,839,840,841,842</added_lines>
 			<deleted_lines>837</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
