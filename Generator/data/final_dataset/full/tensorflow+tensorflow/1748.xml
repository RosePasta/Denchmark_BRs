<bug_data>
<bug id='1748' author='elanmart' open_date='2016-04-02T15:05:39Z' closed_time='2016-06-06T20:51:06Z'>
 	<summary>Optimizers incompatible with sampling -- missing docs?</summary>
 	<description>
 Hi,
 perhaps Tensorflow docs should mention that 5 out of 7 available optimizers will not work with sampling losses? For now, they fail with mysterious messages.
 The following script will fail for Momentum, AdaGrad, AdaDelta, RMSProp and FTRL.
 Also, where should I look if I'd like to implement my own optimizers for GPU?
 import tensorflow as tf
 import numpy.random as nr
 import numpy as np
 
 # config 
 num_classes = 10000
 num_sampled = 512
 num_true = 32
 activation_dim = 512
 batch_sz = 16
 
 # "model" setup
 activations = tf.placeholder(tf.float32, shape=(None, activation_dim))
 labels = tf.placeholder(tf.int64, shape=(None, num_true))
 
 nce_W = tf.Variable(tf.truncated_normal((num_classes, activation_dim)))
 nce_b = tf.Variable(tf.truncated_normal((num_classes, )))
 
 nce_loss = tf.reduce_mean(
                 tf.nn.nce_loss(nce_W, nce_b, 
                                activations, labels, 
                                num_sampled, num_classes, num_true))
 
 # optimizer setup
 global_step   = tf.Variable(1)
 initial_alpha = tf.Variable(0.1)
 alpha         = tf.Variable(0.01)
 
 optimizer = tf.train.FtrlOptimizer(alpha)
 
 # fetches
 step = optimizer.minimize(nce_loss, global_step=global_step, name='sgd_step') 
 init = tf.initialize_all_variables()
 
 # synthetic data
 X = nr.randn(batch_sz, activation_dim).astype(np.float32)
 y = nr.randint(0, num_classes, (batch_sz, num_true)).astype(np.int64)
 
 with tf.Session() as sess:
     sess.run(init)
     sess.run(step, feed_dict={activations:X, labels:y})
 The error message is:
 &lt;denchmark-code&gt;---------------------------------------------------------------------------
 StatusNotOK                               Traceback (most recent call last)
 StatusNotOK: Invalid argument: Cannot assign a device to node 'Variable_1/read': Could not satisfy explicit device specification '' because the node was colocated with a group of nodes that required incompatible device '/job:localhost/replica:0/task:0/GPU:0'
      [[Node: Variable_1/read = Identity[T=DT_FLOAT, _class=["loc:@Variable_1"]](Variable_1)]]
 &lt;/denchmark-code&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='elanmart' date='2016-04-07T01:53:30Z'>
 		Does pinning the variables to CPU make this work? i.e.
 with tf.device("/cpu:0"):
   nce_W = …
   nce_b = …
 		</comment>
 		<comment id='2' author='elanmart' date='2016-06-06T20:51:06Z'>
 		&lt;denchmark-link:https://github.com/mrry&gt;@mrry&lt;/denchmark-link&gt;
  I assume this is fixed now, in that we don't do improper placement, but I'm not sure all sparse optimizers are supported on GPU, which is perhaps another bug which I believe we already have an issue for.
 		</comment>
 	</comments>
 </bug>
<commit id='c34a0d7ea6b557588a7a0c9f9c4e60d59f593af7' author='Vijay Vasudevan' date='2016-05-12 16:31:33-07:00'>
 	<dmm_unit complexity='0.6605504587155964' interfacing='0.7981651376146789' size='0.25688073394495414'></dmm_unit>
 	<modification change_type='MODIFY' old_name='tensorflow\core\BUILD' new_name='tensorflow\core\BUILD'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>1368</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\direct_session.cc' new_name='tensorflow\core\common_runtime\direct_session.cc'>
 		<file_info nloc='767' complexity='124' token_count='5236'></file_info>
 		<method name='tensorflow::DirectSession::GetOrCreateExecutors' parameters='inputs,outputs,target_nodes,executors_and_keys,run_state_args'>
 				<method_info nloc='126' complexity='18' token_count='1105' nesting_level='1' start_line='618' end_line='779'></method_info>
 			<added_lines>656,657,658,659,660,664,668,703,704,705</added_lines>
 			<deleted_lines>685,687,688,692,727,728,729</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::ExtendLocked' parameters='graph'>
 				<method_info nloc='10' complexity='1' token_count='70' nesting_level='1' start_line='213' end_line='225'></method_info>
 			<added_lines>214,215,216,217,219,220,221</added_lines>
 			<deleted_lines>213,214,215,216,217,218,219,220,221,222,223,224,225</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::SaveStatefulNodes' parameters='graph'>
 				<method_info nloc='8' complexity='3' token_count='68' nesting_level='1' start_line='805' end_line='812'></method_info>
 			<added_lines>805,806,807,810,811,812</added_lines>
 			<deleted_lines>805,806,807,808,809,812</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::RestoreStatefulNodes' parameters='graph'>
 				<method_info nloc='11' complexity='4' token_count='88' nesting_level='1' start_line='814' end_line='824'></method_info>
 			<added_lines>814,815,816,817,818,819,820,821,822,823,824</added_lines>
 			<deleted_lines>814,815,816,817,818,819,820,823,824</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::CreateGraphs' parameters='feeds,fetches,target_nodes,func_defs,outputs,run_state_args'>
 				<method_info nloc='93' complexity='11' token_count='679' nesting_level='1' start_line='826' end_line='945'></method_info>
 			<added_lines>826,827,831,833,837,838,856,857,858,898,903</added_lines>
 			<deleted_lines>826,827,828,829,830,831,832,833,834,835,836,837,838,839,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,865,880,920,925,943</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::CreateGraphs' parameters='options,outputs,run_state_args'>
 				<method_info nloc='110' complexity='15' token_count='760' nesting_level='1' start_line='781' end_line='922'></method_info>
 			<added_lines>781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,802,803,804,805,806,807,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,831,833,837,838,856,857,858,898,903</added_lines>
 			<deleted_lines>805,806,807,808,809,812,814,815,816,817,818,819,820,823,824,826,827,828,829,830,831,832,833,834,835,836,837,838,839,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,865,880,920</deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::~DirectSession' parameters=''>
 				<method_info nloc='17' complexity='5' token_count='92' nesting_level='1' start_line='166' end_line='183'></method_info>
 			<added_lines>180,181,182,183</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::DirectSession::MaybeInitializeExecutionState' parameters='graph'>
 				<method_info nloc='11' complexity='3' token_count='70' nesting_level='1' start_line='185' end_line='197'></method_info>
 			<added_lines>185,186,187,188,189,190,191,192,193,194,195,196</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>184</added_lines>
 			<deleted_lines>44,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,226,227,228,229,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\direct_session.h' new_name='tensorflow\core\common_runtime\direct_session.h'>
 		<file_info nloc='155' complexity='6' token_count='970'></file_info>
 		<method name='tensorflow::DirectSession::ExecutorsAndKeys::~ExecutorsAndKeys' parameters=''>
 				<method_info nloc='9' complexity='2' token_count='33' nesting_level='3' start_line='117' end_line='125'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>122</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>31,162,163,164,165,175,249,250,251,252</added_lines>
 			<deleted_lines>171,172,173,174,242,243</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\direct_session_test.cc' new_name='tensorflow\core\common_runtime\direct_session_test.cc'>
 		<file_info nloc='588' complexity='27' token_count='5539'></file_info>
 		<method name='tensorflow::TEST_F' parameters='DirectSessionMinusAXTest,InvalidDevice'>
 				<method_info nloc='30' complexity='1' token_count='342' nesting_level='2' start_line='225' end_line='262'></method_info>
 			<added_lines>243,244,245,259</added_lines>
 			<deleted_lines>243,257</deleted_lines>
 		</method>
 		<method name='tensorflow::TEST' parameters='DirectSessionTest,PlacePrunedGraph'>
 				<method_info nloc='35' complexity='1' token_count='352' nesting_level='2' start_line='437' end_line='478'></method_info>
 			<added_lines>437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>436,479</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\simple_graph_execution_state.cc' new_name='tensorflow\core\common_runtime\simple_graph_execution_state.cc'>
 		<file_info nloc='163' complexity='29' token_count='1132'></file_info>
 		<method name='tensorflow::SimpleGraphExecutionState::BuildGraph' parameters='options,out'>
 				<method_info nloc='23' complexity='4' token_count='180' nesting_level='1' start_line='199' end_line='234'></method_info>
 			<added_lines>205,211,212,213,214,215,216,217,218</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::SaveStatefulNodes' parameters='graph'>
 				<method_info nloc='8' complexity='3' token_count='68' nesting_level='1' start_line='154' end_line='161'></method_info>
 			<added_lines>154,155,156,157,158,159,160,161</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::InitBaseGraph' parameters=''>
 				<method_info nloc='10' complexity='1' token_count='79' nesting_level='1' start_line='113' end_line='123'></method_info>
 			<added_lines>113,114,115,116,117,118,119,120,122,123</added_lines>
 			<deleted_lines>113</deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::InitBaseGraph' parameters='options'>
 				<method_info nloc='19' complexity='3' token_count='155' nesting_level='1' start_line='175' end_line='197'></method_info>
 			<added_lines>175,176,181,182,183,184,185,186,187,188,189,190,194</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::RestoreStatefulNodes' parameters='graph'>
 				<method_info nloc='11' complexity='4' token_count='88' nesting_level='1' start_line='163' end_line='173'></method_info>
 			<added_lines>163,164,165,166,167,168,169,170,171,172,173</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::Extend' parameters='extension_def,out'>
 				<method_info nloc='59' complexity='11' token_count='472' nesting_level='1' start_line='68' end_line='152'></method_info>
 			<added_lines>91,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,122,123,124,125,126,127,128,129,130,131,132,133,136,145</added_lines>
 			<deleted_lines>94,113,131,137,138,139,140,141</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>30,162,174</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\simple_graph_execution_state.h' new_name='tensorflow\core\common_runtime\simple_graph_execution_state.h'>
 		<file_info nloc='67' complexity='5' token_count='330'></file_info>
 		<method name='tensorflow::SimpleGraphExecutionState::full_graph' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='14' nesting_level='2' start_line='119' end_line='122'></method_info>
 			<added_lines>119,120,121,122</added_lines>
 			<deleted_lines>120</deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::original_graph_def' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='8' nesting_level='2' start_line='126' end_line='126'></method_info>
 			<added_lines>126</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::SetStatefulPlacements' parameters='sp'>
 				<method_info nloc='4' complexity='1' token_count='26' nesting_level='2' start_line='137' end_line='140'></method_info>
 			<added_lines>137,138,139,140</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflow::SimpleGraphExecutionState::GetStatefulPlacements' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='15' nesting_level='2' start_line='130' end_line='133'></method_info>
 			<added_lines>130,131,132,133</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>117,118,123,124,125,127,128,129,134,135,136,141,145,146,147,148,149,150,151,152,153,154</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\common_runtime\simple_placer.cc' new_name='tensorflow\core\common_runtime\simple_placer.cc'>
 		<file_info nloc='405' complexity='82' token_count='2749'></file_info>
 		<method name='tensorflow::SimplePlacer::Run' parameters=''>
 				<method_info nloc='86' complexity='22' token_count='606' nesting_level='1' start_line='548' end_line='672'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>662</deleted_lines>
 		</method>
 		<method name='tensorflow::ColocationGraph::InitializeMember' parameters='node,member'>
 				<method_info nloc='49' complexity='10' token_count='341' nesting_level='3' start_line='413' end_line='487'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>472</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\core\protobuf\config.proto' new_name='tensorflow\core\protobuf\config.proto'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>83,84,85,86,87,88,89,90,91</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\python\client\session.py' new_name='tensorflow\python\client\session.py'>
 		<file_info nloc='501' complexity='107' token_count='2895'></file_info>
 		<method name='__init__' parameters='self,target,graph,config'>
 				<method_info nloc='11' complexity='3' token_count='96' nesting_level='1' start_line='883' end_line='912'></method_info>
 			<added_lines>901,902,903,904,905</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>27</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tensorflow\python\client\session_test.py' new_name='tensorflow\python\client\session_test.py'>
 		<file_info nloc='897' complexity='98' token_count='9988'></file_info>
 		<method name='testDefaultSessionPlacePrunedGraph' parameters='self'>
 				<method_info nloc='8' complexity='1' token_count='77' nesting_level='1' start_line='731' end_line='750'></method_info>
 			<added_lines>731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='testInteractivePlacePrunedGraph' parameters='self'>
 				<method_info nloc='9' complexity='1' token_count='81' nesting_level='1' start_line='710' end_line='729'></method_info>
 			<added_lines>710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>730,751</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
