<bug_data>
<bug id='1665' author='luischinchillagarcia' open_date='2020-04-22T19:08:46Z' closed_time='2020-10-19T18:09:03Z'>
 	<summary>KeyError: 'user_module' in Transform</summary>
 	<description>
 When running a TFX Pipeline, the Transform component returns an error in the form shown below. &lt;denchmark-link:https://colab.research.google.com/drive/1qpd6tlRHWoVprj7LETBB0p07zF1JNAfu&gt;This Colab&lt;/denchmark-link&gt;
  reproduces the error with the  from Transform, using a TFX Pipeline.
 RuntimeError: Traceback (most recent call last):
   File "/usr/local/lib/python3.6/dist-packages/apache_beam/runners/worker/sdk_worker.py", line 312, in get
     processor = self.cached_bundle_processors[bundle_descriptor_id].pop()
 IndexError: pop from empty list
 
 During handling of the above exception, another exception occurred:
 
 Traceback (most recent call last):
   File "/usr/local/lib/python3.6/dist-packages/apache_beam/internal/pickler.py", line 250, in dumps
     s = dill.dumps(o)
 ...
 
   File "/usr/local/lib/python3.6/dist-packages/apache_beam/internal/pickler.py", line 77, in _is_nested_class
     and cls.__name__ not in sys.modules[cls.__module__].__dict__)
 KeyError: 'user_module'
 
 During handling of the above exception, another exception occurred:
 When using Interactive Context, issue is resolved by adding:
 import tensorflow_transform as tft
 import sys
 sys.modules['user_module'] = tft
 However, it had no such luck when using a pipeline.
 	</description>
 	<comments>
 		<comment id='1' author='luischinchillagarcia' date='2020-04-23T21:56:33Z'>
 		You can't do it because it's a different process. You have the same context in an interactive context, but when you use Pipeline, you have a different context.
 		</comment>
 		<comment id='2' author='luischinchillagarcia' date='2020-04-23T23:23:28Z'>
 		Is there a possibility to solve this issue in any other way? (utilizing Pipeline) The end goal would be to use this in a Dataflow job for example.
 		</comment>
 		<comment id='3' author='luischinchillagarcia' date='2020-04-24T10:39:30Z'>
 		You need create a file with preprocessing_fn and trainer_fn. You should add "module_file" to
 transform = Transform(
 examples=example_gen.outputs['examples'],
 schema=infer_schema.outputs['schema'],
 module_file=module_file)
 Variable module_file is path to file.
 		</comment>
 		<comment id='4' author='luischinchillagarcia' date='2020-04-24T15:34:50Z'>
 		Thank you for the response. I am doing this step already though (it's under the %%writefile 'transform.py'). Here's the &lt;denchmark-link:https://colab.research.google.com/drive/1qpd6tlRHWoVprj7LETBB0p07zF1JNAfu&gt;Colab file I'm referencing&lt;/denchmark-link&gt;
 , where the error occurs in the 'TF Transform (ERROR: KeyError)' tab.
 I should note: there's no Interactive Context here, this is purely a Pipeline where all the components are running. Transform fails with the error "KeyError: 'user_module'".
 		</comment>
 		<comment id='5' author='luischinchillagarcia' date='2020-04-28T23:58:21Z'>
 		^ A follow-up on this issue, this error also appears in a Dataflow job.
 		</comment>
 		<comment id='6' author='luischinchillagarcia' date='2020-06-30T17:11:29Z'>
 		&lt;denchmark-link:https://github.com/charlesccychen&gt;@charlesccychen&lt;/denchmark-link&gt;
  I think this could be related to your upcoming plan for dependency management and/or interactive context?
 		</comment>
 		<comment id='7' author='luischinchillagarcia' date='2020-07-23T05:44:21Z'>
 		^ Follow up to see if there's any hints that may lead to a solution.
 		</comment>
 		<comment id='8' author='luischinchillagarcia' date='2020-10-19T18:09:04Z'>
 		Are you satisfied with the resolution of your issue?
 &lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&amp;entry.2137816233=https://github.com/tensorflow/tfx/issues/1665&gt;Yes&lt;/denchmark-link&gt;
 
 &lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&amp;entry.2137816233=https://github.com/tensorflow/tfx/issues/1665&gt;No&lt;/denchmark-link&gt;
 
 		</comment>
 	</comments>
 </bug>
<commit id='758cc59bfbe1761af3a3920cec139fc90c7fc19b' author='tfx-team' date='2020-10-19 11:08:53-07:00'>
 	<dmm_unit complexity='1.0' interfacing='0.42857142857142855' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='tfx\components\transform\executor.py' new_name='tfx\components\transform\executor.py'>
 		<file_info nloc='1157' complexity='69' token_count='5656'></file_info>
 		<method name='_RunBeamImpl' parameters='self,Any,bool,DatasetMetadata,Text,int,Text,bool,int'>
 				<method_info nloc='10' complexity='1' token_count='83' nesting_level='1' start_line='966' end_line='975'></method_info>
 			<added_lines>968</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,Text,Text,Text,Any,PTransform,bool'>
 				<method_info nloc='8' complexity='1' token_count='45' nesting_level='2' start_line='668' end_line='675'></method_info>
 			<added_lines>674,675</added_lines>
 			<deleted_lines>673</deleted_lines>
 		</method>
 		<method name='_RunInPlaceImpl' parameters='self,Any,bool,DatasetMetadata,Text,Text'>
 				<method_info nloc='4' complexity='1' token_count='36' nesting_level='1' start_line='1251' end_line='1254'></method_info>
 			<added_lines>1251,1252,1253,1254</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='_RunInPlaceImpl' parameters='self,Any,DatasetMetadata,Text,Text'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='1' start_line='1233' end_line='1237'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>1233,1234,1235,1236,1237</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,Text,Text,Text,Any,PTransform'>
 				<method_info nloc='7' complexity='1' token_count='41' nesting_level='2' start_line='667' end_line='673'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>673</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>415,416,683,706,744,836,837,886,887,889,937,950,951,952,958,959,982,983,1007,1008,1009,1010,1012,1013,1014,1040,1041,1053,1054,1055,1259,1260,1274,1275,1276,1277,1278,1279</added_lines>
 			<deleted_lines>37,703,741,929,942,943,949,950,995,997,1023,1035,1036,1037,1255,1256,1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,1267,1268,1269,1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281,1282,1283,1284,1285,1286,1287</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tfx\components\transform\executor_test.py' new_name='tfx\components\transform\executor_test.py'>
 		<file_info nloc='311' complexity='31' token_count='2488'></file_info>
 		<method name='Transform' parameters='self,inputs,outputs,status_file'>
 				<method_info nloc='3' complexity='1' token_count='36' nesting_level='1' start_line='67' end_line='69'></method_info>
 			<added_lines>67,68,69</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,force_tf_compat_v1'>
 				<method_info nloc='3' complexity='1' token_count='22' nesting_level='1' start_line='63' end_line='65'></method_info>
 			<added_lines>63,64,65</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='_run_pipeline_get_metrics' parameters='self'>
 				<method_info nloc='13' complexity='1' token_count='73' nesting_level='1' start_line='246' end_line='263'></method_info>
 			<added_lines>255,259</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='_use_force_tf_compat_v1' parameters='self'>
 				<method_info nloc='2' complexity='1' token_count='7' nesting_level='1' start_line='82' end_line='83'></method_info>
 			<added_lines>82,83</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='setUp' parameters='self'>
 				<method_info nloc='12' complexity='1' token_count='91' nesting_level='1' start_line='159' end_line='175'></method_info>
 			<added_lines>174,175</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>32,61,62,66,70,71,81,84</added_lines>
 			<deleted_lines>158,238,242</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='tfx\components\transform\executor_v2_test.py'>
 		<file_info nloc='13' complexity='1' token_count='60'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='tfx\components\transform\labels.py' new_name='tfx\components\transform\labels.py'>
 		<file_info nloc='23' complexity='0' token_count='66'></file_info>
 		<modified_lines>
 			<added_lines>33,34,35</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='tfx\utils\import_utils.py' new_name='tfx\utils\import_utils.py'>
 		<file_info nloc='42' complexity='4' token_count='231'></file_info>
 		<method name='import_func_from_source' parameters='Text,Text'>
 				<method_info nloc='17' complexity='2' token_count='107' nesting_level='0' start_line='43' end_line='64'></method_info>
 			<added_lines>51,52,53,54,55,56,57,58,59,60</added_lines>
 			<deleted_lines>53,54,55,56,57,58,59,60,61,62,63,64</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>22</added_lines>
 			<deleted_lines>22,25,26,65,66,67,68</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
