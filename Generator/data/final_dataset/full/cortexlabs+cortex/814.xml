<bug_data>
<bug id='814' author='deliahu' open_date='2020-02-14T17:14:01Z' closed_time='2020-11-10T19:09:23Z'>
 	<summary>Intermittent failed requests during rolling updates</summary>
 	<description>
 &lt;denchmark-h:h4&gt;Description&lt;/denchmark-h&gt;
 
 As old pods spin down during a rolling update, some requests return 503. Istio is hiding the more detailed error message - when bypassing Istio with service of type: loadbalancer, the error is:
 &lt;denchmark-code&gt;Post http://a2b34b2aa4ec411eaab8a0a465d27bdf-e1fddee29350e253.elb.us-west-2.amazonaws.com/predict: read tcp 172.31.1.222:42654-&gt;54.71.144.207:80: read: connection reset by peer
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-h:h4&gt;Reproduction&lt;/denchmark-h&gt;
 
 Create an iris deployment with min and max of e.g. 2 replicas. Run dev/load.go with at least 100 concurrent threads and no delays. Perform a rolling update, and watch for 503 errors (or the connection reset by peer error if using the load balancer service) as the old pods are terminating.
 &lt;denchmark-h:h4&gt;Relevant info&lt;/denchmark-h&gt;
 
 
 https://stackoverflow.com/questions/57727457/why-there-is-downtime-while-rolling-update-a-deployment-or-even-scaling-down-a-r
 
 &lt;denchmark-h:h4&gt;Possibly related issue&lt;/denchmark-h&gt;
 
 Also, &lt;denchmark-link:https://github.com/vishalbollu&gt;@vishalbollu&lt;/denchmark-link&gt;
  reported that during large scale ups that require many new nodes (e.g. 1 -&gt; 200 nodes), some 503 errors are also seen. This may or may not be the same root cause. A separate ticket should be created to track this if a fix for this issue doesn't resolve it.
 &lt;denchmark-h:h4&gt;Possibly related issue 2&lt;/denchmark-h&gt;
 
 It seems that deleting an API, deploying it again, waiting for the previous pod to terminate, and then creating a high volume of parallel requests also results in 503 errors. See the &lt;denchmark-link:https://github.com/cortexlabs/cortex/tree/networking-debugging&gt;networking-debugging&lt;/denchmark-link&gt;
  branch.
 	</description>
 	<comments>
 	</comments>
 </bug>
<commit id='c8da08542e0978c0c2f9c94694bf441092aaafe6' author='Robert Lucian Chiriac' date='2020-11-06 22:53:53+02:00'>
 	<dmm_unit complexity='1.0' interfacing='0.9666666666666667' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='cli\local\docker_spec.go' new_name='cli\local\docker_spec.go'>
 		<file_info nloc='459' complexity='66' token_count='3036'></file_info>
 		<method name='getAPIEnv' parameters='API,Client'>
 				<method_info nloc='36' complexity='6' token_count='302' nesting_level='0' start_line='75' end_line='116'></method_info>
 			<added_lines>94</added_lines>
 			<deleted_lines>95,96,97</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>22</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='dev\versions.md' new_name='dev\versions.md'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>175,176,177,178,179,180,181,182,183,184,185,186</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='examples\sklearn\iris-classifier\cortex.yaml' new_name='examples\sklearn\iris-classifier\cortex.yaml'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>15</added_lines>
 			<deleted_lines>15</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='examples\sklearn\iris-classifier\requirements.txt' new_name='examples\sklearn\iris-classifier\requirements.txt'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>2</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\neuron-rtd\Dockerfile' new_name='images\neuron-rtd\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>16,17</added_lines>
 			<deleted_lines>16</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\onnx-predictor-cpu\Dockerfile' new_name='images\onnx-predictor-cpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>12,15,16,17,18,19,77,78,79</added_lines>
 			<deleted_lines>71</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\onnx-predictor-gpu\Dockerfile' new_name='images\onnx-predictor-gpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>12,15,16,17,18,19,77,78,79</added_lines>
 			<deleted_lines>71</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\python-predictor-cpu\Dockerfile' new_name='images\python-predictor-cpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>12,15,16,17,18,19,97,98,99</added_lines>
 			<deleted_lines>91</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\python-predictor-gpu\Dockerfile' new_name='images\python-predictor-gpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>14,17,18,19,20,21,102,103,104</added_lines>
 			<deleted_lines>96</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\python-predictor-inf\Dockerfile' new_name='images\python-predictor-inf\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>13,14,15,27,107,108,109</added_lines>
 			<deleted_lines>103</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\tensorflow-predictor\Dockerfile' new_name='images\tensorflow-predictor\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>12,15,16,17,18,19,77,81,82,83</added_lines>
 			<deleted_lines>71,75</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\tensorflow-serving-cpu\Dockerfile' new_name='images\tensorflow-serving-cpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>3,4,5,6</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\tensorflow-serving-gpu\Dockerfile' new_name='images\tensorflow-serving-gpu\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>6</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='images\tensorflow-serving-inf\Dockerfile' new_name='images\tensorflow-serving-inf\Dockerfile'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>7</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\operator\operator\k8s.go' new_name='pkg\operator\operator\k8s.go'>
 		<file_info nloc='814' complexity='76' token_count='4684'></file_info>
 		<method name='PythonPredictorContainers' parameters='API'>
 				<method_info nloc='72' complexity='7' token_count='517' nesting_level='0' start_line='115' end_line='195'></method_info>
 			<added_lines>181</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ONNXPredictorContainers' parameters='API'>
 				<method_info nloc='41' complexity='4' token_count='294' nesting_level='0' start_line='293' end_line='338'></method_info>
 			<added_lines>324</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='tensorflowServingContainer' parameters='API,VolumeMount,ResourceRequirements'>
 				<method_info nloc='64' complexity='6' token_count='372' nesting_level='0' start_line='631' end_line='699'></method_info>
 			<added_lines>695</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='getEnvVars' parameters='API,string'>
 				<method_info nloc='195' complexity='19' token_count='1009' nesting_level='0' start_line='338' end_line='547'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>412,413,414,415,416,417,418,419,420</deleted_lines>
 		</method>
 		<method name='waitAPIContainerToStop' parameters='Kind'>
 				<method_info nloc='12' complexity='2' token_count='69' nesting_level='0' start_line='807' end_line='818'></method_info>
 			<added_lines>807,808,809,810,811,812,813,814,815,816,817,818</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='TensorFlowPredictorContainers' parameters='API'>
 				<method_info nloc='86' complexity='7' token_count='603' nesting_level='0' start_line='197' end_line='291'></method_info>
 			<added_lines>270</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='nginxGracefulStopper' parameters='Kind'>
 				<method_info nloc='12' complexity='2' token_count='62' nesting_level='0' start_line='792' end_line='805'></method_info>
 			<added_lines>792,793,794,795,796,797,798,799,800,801,802,803,804,805</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='neuronRuntimeDaemonContainer' parameters='API,VolumeMount'>
 				<method_info nloc='29' complexity='1' token_count='196' nesting_level='0' start_line='701' end_line='729'></method_info>
 			<added_lines>717</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>806,819</added_lines>
 			<deleted_lines>23</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\operator\resources\realtimeapi\k8s_specs.go' new_name='pkg\operator\resources\realtimeapi\k8s_specs.go'>
 		<file_info nloc='218' complexity='15' token_count='1394'></file_info>
 		<method name='pythonAPISpec' parameters='API,Deployment'>
 				<method_info nloc='48' complexity='1' token_count='316' nesting_level='0' start_line='96' end_line='144'></method_info>
 			<added_lines>129,130</added_lines>
 			<deleted_lines>126</deleted_lines>
 		</method>
 		<method name='tensorflowAPISpec' parameters='API,Deployment'>
 				<method_info nloc='48' complexity='1' token_count='316' nesting_level='0' start_line='45' end_line='94'></method_info>
 			<added_lines>79,80</added_lines>
 			<deleted_lines>77</deleted_lines>
 		</method>
 		<method name='onnxAPISpec' parameters='API,Deployment'>
 				<method_info nloc='47' complexity='1' token_count='312' nesting_level='0' start_line='146' end_line='193'></method_info>
 			<added_lines>182,183</added_lines>
 			<deleted_lines>178</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>30,31</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\types\spec\validations.go' new_name='pkg\types\spec\validations.go'>
 		<file_info nloc='1223' complexity='244' token_count='7093'></file_info>
 		<method name='autoscalingValidation' parameters='ProviderType'>
 				<method_info nloc='106' complexity='1' token_count='501' nesting_level='0' start_line='363' end_line='470'></method_info>
 			<added_lines>402,403,404,405,406</added_lines>
 			<deleted_lines>402,403,404</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\workloads\cortex\lib\util.py' new_name='pkg\workloads\cortex\lib\util.py'>
 		<file_info nloc='155' complexity='71' token_count='965'></file_info>
 		<method name='render_jinja_template' parameters='str,dict'>
 				<method_info nloc='9' complexity='1' token_count='79' nesting_level='0' start_line='235' end_line='246'></method_info>
 			<added_lines>235,236,237,238,239,240,241,242,243,244,245,246</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>24,233,234</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='RENAME' old_name='pkg\workloads\cortex\serve\run.sh' new_name='pkg\workloads\cortex\serve\init\bootloader.sh'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='RENAME' old_name='pkg\workloads\cortex\serve\start.py' new_name='pkg\workloads\cortex\serve\init\script.py'>
 		<file_info nloc='45' complexity='11' token_count='371'></file_info>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='pkg\workloads\cortex\serve\nginx.conf.j2'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='pkg\workloads\cortex\serve\poll\readiness.sh'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\workloads\cortex\serve\requirements.txt' new_name='pkg\workloads\cortex\serve\requirements.txt'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>11</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='pkg\workloads\cortex\serve\serve.py' new_name='pkg\workloads\cortex\serve\serve.py'>
 		<file_info nloc='257' complexity='64' token_count='1680'></file_info>
 		<method name='startup' parameters=''>
 				<method_info nloc='3' complexity='1' token_count='18' nesting_level='0' start_line='70' end_line='72'></method_info>
 			<added_lines>71</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='shutdown' parameters=''>
 				<method_info nloc='13' complexity='4' token_count='38' nesting_level='0' start_line='76' end_line='90'></method_info>
 			<added_lines>82,83,84,85,86</added_lines>
 			<deleted_lines>80</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>29,54,55,56,57,58,59,60,61</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='RENAME' old_name='pkg\workloads\cortex\serve\batch.py' new_name='pkg\workloads\cortex\serve\start\batch.py'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='pkg\workloads\cortex\serve\start\server.py'>
 		<file_info nloc='17' complexity='1' token_count='76'></file_info>
 	</modification>
 </commit>
</bug_data>
