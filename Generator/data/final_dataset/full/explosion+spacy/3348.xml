<bug_data>
<bug id='3348' author='danielkingai2' open_date='2019-03-01T19:04:09Z' closed_time='2019-03-06T22:58:39Z'>
 	<summary>Document similarity does not work on gpu with models including word vectors</summary>
 	<description>
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 It seems that the document similarity function does not work on GPU for spacy models that have word vectors.
 &lt;denchmark-code&gt;Python 3.6.7 | packaged by conda-forge | (default, Feb 28 2019, 09:07:38) 
 [GCC 7.3.0] on linux
 Type "help", "copyright", "credits" or "license" for more information.
 &gt;&gt;&gt; import spacy
 &gt;&gt;&gt; spacy.prefer_gpu()
 True
 &gt;&gt;&gt; nlp = spacy.load('en_core_web_md')
 &gt;&gt;&gt; doc1 = nlp("this is some text.")
 &gt;&gt;&gt; doc2 = nlp("this is some more text.")
 &gt;&gt;&gt; doc1.similarity(doc2)
 Traceback (most recent call last):
   File "&lt;stdin&gt;", line 1, in &lt;module&gt;
   File "doc.pyx", line 322, in spacy.tokens.doc.Doc.similarity
   File "doc.pyx", line 386, in spacy.tokens.doc.Doc.vector_norm.__get__
   File "doc.pyx", line 361, in spacy.tokens.doc.Doc.vector.__get__
   File "cupy/core/core.pyx", line 1741, in cupy.core.core.ndarray.__array_ufunc__
   File "cupy/core/_kernel.pyx", line 789, in cupy.core._kernel.ufunc.__call__
   File "cupy/core/_kernel.pyx", line 86, in cupy.core._kernel._preprocess_args
 TypeError: Unsupported type &lt;class 'numpy.ndarray'&gt;
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 &lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;
 
 
 spaCy version: 2.0.18
 Platform: Linux-4.4.0-112-generic-x86_64-with-debian-stretch-sid
 Python version: 3.6.7
 Models: en_core_web_md, en_core_web_sm
 
 	</description>
 	<comments>
 		<comment id='1' author='danielkingai2' date='2019-03-06T13:22:33Z'>
 		Thanks! Disappointed I made this error, but I'm pretty sure I see what's wrong. If you have a look here:
 &lt;denchmark-link:https://github.com/explosion/spaCy/blob/develop/spacy/tokens/doc.pyx#L332&gt;https://github.com/explosion/spaCy/blob/develop/spacy/tokens/doc.pyx#L332&lt;/denchmark-link&gt;
 
 You should see that there's a direct call to numpy.dot(). We instead want to do something like:
 vector = self.vector
 xp = thinc.neural.util.get_array_module(vector)
 xp.dot(...)
 This should select cupy or numpy, depending on the data. I don't have a GPU server booted just now, so if it's easy for you to do so, would you mind submitting a PR? You should also check the token.similarity() and span.similarity() methods, and ideally have a quick look for other direct invocations of numpy if the data could be on GPU.
 		</comment>
 		<comment id='2' author='danielkingai2' date='2019-04-05T23:56:43Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='5f40229397f8ed283386f8422432dfdbecfcdc07' author='Daniel King' date='2019-03-06 22:58:38+00:00'>
 	<dmm_unit complexity='None' interfacing='None' size='None'></dmm_unit>
 	<modification change_type='ADD' old_name='None' new_name='.github\contributors\danielkingai2.md'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\lexeme.pyx' new_name='spacy\lexeme.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>11,127,128,129,130</added_lines>
 			<deleted_lines>126</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\doc.pyx' new_name='spacy\tokens\doc.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>324,325,326,327,362</added_lines>
 			<deleted_lines>324,359,360,361,362</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\span.pyx' new_name='spacy\tokens\span.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>9,218,219,220,221</added_lines>
 			<deleted_lines>217</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\token.pyx' new_name='spacy\tokens\token.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>12,169,170,171,172</added_lines>
 			<deleted_lines>168</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
