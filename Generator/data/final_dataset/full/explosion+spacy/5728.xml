<bug_data>
<bug id='5728' author='bartvdbraak' open_date='2020-07-08T13:37:03Z' closed_time='2020-07-09T20:11:14Z'>
 	<summary>NoneType uncallable on spacy.load('fr') (if self.is_base_form(univ_pos, morphology))</summary>
 	<description>
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 I am trying to get lemmatization/stemming to work with spaCy and spaCy_lefff in French. However, everytime I try to execute this code block in iPython kernel (jupyter notebook):
 &lt;denchmark-code&gt;import spacy
 nlp = spacy.load("fr")
 
 doc = nlp("C'est une phrase.")
 print([(w.text, w.pos_) for w in doc])
 &lt;/denchmark-code&gt;
 
 I am getting the following error:
 &lt;denchmark-code&gt;---------------------------------------------------------------------------
 TypeError                                 Traceback (most recent call last)
  in 
       2 nlp = spacy.load("fr_core_news_sm")
       3 
 ----&gt; 4 doc = nlp("C'est une phrase.")
       5 print([(w.text, w.pos_) for w in doc])
 
 ~/anaconda3/lib/python3.7/site-packages/spacy/language.py in __call__(self, text, disable, component_cfg)
     447             if not hasattr(proc, "__call__"):
     448                 raise ValueError(Errors.E003.format(component=type(proc), name=name))
 --&gt; 449             doc = proc(doc, **component_cfg.get(name, {}))
     450             if doc is None:
     451                 raise ValueError(Errors.E005.format(name=name))
 
 pipes.pyx in spacy.pipeline.pipes.Tagger.__call__()
 
 pipes.pyx in spacy.pipeline.pipes.Tagger.set_annotations()
 
 morphology.pyx in spacy.morphology.Morphology.assign_tag_id()
 
 morphology.pyx in spacy.morphology.Morphology.lemmatize()
 
 ~/anaconda3/lib/python3.7/site-packages/spacy/lang/fr/lemmatizer.py in __call__(self, string, univ_pos, morphology)
      47             return [self.lookup(string)]
      48         # See Issue #435 for example of where this logic is requied.
 ---&gt; 49         if self.is_base_form(univ_pos, morphology):
      50             return list(set([string.lower()]))
      51         index_table = self.lookups.get_table("lemma_index", {})
 
 TypeError: 'NoneType' object is not callable
 &lt;/denchmark-code&gt;
 
 I have downloaded with python -m spacy download fr and python -m spacy download fr_core_news_sm.
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 &lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;
 
 
 
 spaCy version: 2.3.1
 
 
 Platform: Linux-5.3.0-62-generic-x86_64-with-debian-buster-sid
 
 
 Python version: 3.7.6
 
 
 Models: fr, en
 
 
 Environment Information: iPython kernel, Jupyter Notebook, Anaconda3
 
 
 &lt;denchmark-h:h2&gt;Extra&lt;/denchmark-h&gt;
 
 I have downloaded with python -m spacy download fr and python -m spacy download fr_core_news_sm.
 Extra info:
 &lt;denchmark-code&gt;❯ python -m spacy validate
 ✔ Loaded compatibility table
 
 ====================== Installed models (spaCy v2.3.1) ======================
 ℹ spaCy installation:
 /home/bart/anaconda3/lib/python3.7/site-packages/spacy
 
 TYPE      NAME              MODEL             VERSION                            
 package   fr-core-news-sm   fr_core_news_sm   2.3.0   ✔
 package   en-core-web-sm    en_core_web_sm    2.3.1   ✔
 link      fr                fr_core_news_sm   2.3.0   ✔
 link      en                en_core_web_sm    2.3.1   ✔
 
 ❯ python -m spacy info
 
 ============================== Info about spaCy ==============================
 
 spaCy version    2.3.1                         
 Location         /home/bart/anaconda3/lib/python3.7/site-packages/spacy
 Platform         Linux-5.3.0-62-generic-x86_64-with-debian-buster-sid
 Python version   3.7.6                         
 Models           fr, en
 &lt;/denchmark-code&gt;
 
 The english package does work however:
 &lt;denchmark-code&gt;import spacy
 nlp = spacy.load("en")
 
 doc = nlp("Just a phrase.")
 print([(w.text, w.pos_) for w in doc])
 &lt;/denchmark-code&gt;
 
 with output
 &lt;denchmark-code&gt;[('Just', 'ADV'), ('a', 'DET'), ('phrase', 'NOUN'), ('.', 'PUNCT')]
 &lt;/denchmark-code&gt;
 
 	</description>
 	<comments>
 		<comment id='1' author='bartvdbraak' date='2020-07-08T15:35:18Z'>
 		Thanks for the report!
 I can fix the bug so this code works as before, but I think the French lemmatizer is unintentionally using English-specific code here that doesn't make sense for French. Let me check the details first, but I think we can probably just remove this whole function.
 		</comment>
 		<comment id='2' author='bartvdbraak' date='2020-07-08T15:37:38Z'>
 		I'm having the exact same problem with the french model, whereas my script worked fine yesterday.
 I tried all 3 french models and there was the same error message TypeError: 'NoneType' object is not callable
 The English model works for me as well.
 Is there an update on the french models today that is causing the problem ?
 		</comment>
 		<comment id='3' author='bartvdbraak' date='2020-07-08T15:40:52Z'>
 		The bug is in spacy v2.3.1. If you downgrade to v2.3.0 it should work. The models haven't changed (and won't need to change, the bug is in spacy itself).
 		</comment>
 		<comment id='4' author='bartvdbraak' date='2020-07-09T12:09:08Z'>
 		Thanks, I will downgrade to version 2.3.0 for the time being, and hopefully your fix will be in the newest version soon :).
 		</comment>
 		<comment id='5' author='bartvdbraak' date='2020-07-09T15:07:21Z'>
 		Hello,
 I am sorry, I just got the same issue today with the French package 2.3.0 today, while it works perfectly with English package 2.3.1 and Japanese package 2.3.2.
 Typing:
 import fr_core_news_sm
 nlpf = fr_core_news_sm.load()
 texte3= "J'aime le vin blanc. »
 doc3= nlpf(texte3)
 &lt;denchmark-h:h2&gt;I get:&lt;/denchmark-h&gt;
 
 TypeError                                 Traceback (most recent call last)
  in 
 ----&gt; 1 doc3= nlpf(texte3)
 ~/opt/anaconda3/lib/python3.7/site-packages/spacy/language.py in call(self, text, disable, component_cfg)
 447             if not hasattr(proc, "call"):
 448                 raise ValueError(Errors.E003.format(component=type(proc), name=name))
 --&gt; 449             doc = proc(doc, **component_cfg.get(name, {}))
 450             if doc is None:
 451                 raise ValueError(Errors.E005.format(name=name))
 pipes.pyx in spacy.pipeline.pipes.Tagger.call()
 pipes.pyx in spacy.pipeline.pipes.Tagger.set_annotations()
 morphology.pyx in spacy.morphology.Morphology.assign_tag_id()
 morphology.pyx in spacy.morphology.Morphology.lemmatize()
 ~/opt/anaconda3/lib/python3.7/site-packages/spacy/lang/fr/lemmatizer.py in (self, string, univ_pos, morphology)
 47             return [self.lookup(string)]
 48         # See Issue &lt;denchmark-link:https://github.com/explosion/spaCy/issues/435&gt;#435&lt;/denchmark-link&gt;
  for example of where this logic is requied.
 ---&gt; 49         if self.is_base_form(univ_pos, morphology):
 50             return list(set([string.lower()]))
 51         index_table = self.lookups.get_table("lemma_index", {})
 TypeError: 'NoneType' object is not callable
 		</comment>
 		<comment id='6' author='bartvdbraak' date='2020-07-09T15:17:05Z'>
 		The problem is not the model version, it is the spacy version. Try downgrading to spacy==2.3.0 temporarily. We will have a fix in a new version of spacy soon, which should be 2.3.2.
 		</comment>
 	</comments>
 </bug>
<commit id='923affd091dac4c1a7e11168f7c8f1f05dcc224e' author='Adriane Boyd' date='2020-07-09 22:11:13+02:00'>
 	<dmm_unit complexity='1.0' interfacing='1.0' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\lang\fr\lemmatizer.py' new_name='spacy\lang\fr\lemmatizer.py'>
 		<file_info nloc='91' complexity='32' token_count='665'></file_info>
 		<method name='__call__' parameters='self,string,univ_pos,morphology'>
 				<method_info nloc='40' complexity='14' token_count='314' nesting_level='1' start_line='20' end_line='60'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>48,49,50</deleted_lines>
 		</method>
 		<method name='is_base_form' parameters='self,univ_pos,morphology'>
 				<method_info nloc='30' complexity='19' token_count='165' nesting_level='1' start_line='62' end_line='97'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>98</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
