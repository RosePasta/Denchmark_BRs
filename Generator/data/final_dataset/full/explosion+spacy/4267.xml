<bug_data>
<bug id='4267' author='jenojp' open_date='2019-09-10T14:10:54Z' closed_time='2019-09-18T19:37:18Z'>
 	<summary>Different ent_iob behavior after adding EntityRuler to pipeline</summary>
 	<description>
 I'm not totally sure of the expected behavior but after adding an EntityRuler to a pipeline, non entities seem to get .ent_iob tags of 0 rather than 2 when just using the EntityRecognizer. This affects what doc.is_nered returns.
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 import spacy
 from spacy.pipeline import EntityRuler
 
 nlp = spacy.load("en_core_web_sm")
 print(nlp.pipe_names)
 ## ['tagger', 'parser', 'ner']
 
 doc = nlp("fgfgdghgdh")
 print(doc.is_nered)
 ## True
 
 for token in doc:
     print(token.ent_iob)
 ## 2
 
 #addd entity ruler and run again
 ruler = EntityRuler(nlp)
 patterns = [{"label":"SOFTWARE", "pattern":"spacy"}]
 
 ruler.add_patterns(patterns)
 nlp.add_pipe(ruler)
 print(nlp.pipe_names)
 ## ['tagger', 'parser', 'ner', 'entity_ruler']
 
 doc = nlp("fgfgdghgdh")
 print(doc.is_nered)
 ## False
 
 for token in doc:
     print(token.ent_iob)
 ## 0
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 &lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;
 
 
 spaCy version: 2.1.8
 Platform: Darwin-18.7.0-x86_64-i386-64bit
 Python version: 3.6.8
 
 	</description>
 	<comments>
 		<comment id='1' author='jenojp' date='2019-09-10T20:07:04Z'>
 		Thanks for the report! I do think this is a bug. From the docs about EntityRuler:
 
 If it’s added before the "ner" component, the entity recognizer will respect the existing entity spans and adjust its predictions around it. This can significantly improve accuracy in some cases. If it’s added after the "ner" component, the entity ruler will only add spans to the doc.ents if they don’t overlap with existing entities predicted by the model.
 
 In this case it's added after the ner, and it should respect the NER annotations. Even if there are no entities found by the NER, I would still expect -as a user- that doc.is_nered would have stayed True.
 		</comment>
 		<comment id='2' author='jenojp' date='2019-09-10T20:20:18Z'>
 		Huh, setting doc.ents does this:
 
 
 
 spaCy/spacy/tokens/doc.pyx
 
 
         Lines 547 to 550
       in
       669a7d3
 
 
 
 
 
 
  for i in range(self.length): 
 
 
 
  self.c[i].ent_type = 0 
 
 
 
  self.c[i].ent_kb_id = 0 
 
 
 
  self.c[i].ent_iob = 0 # Means missing. 
 
 
 
 
 
 Maybe the resetting loop should preserve 2 in cases where it's 2? I'm not sure if there are some side effects I'm not thinking of...
 		</comment>
 		<comment id='3' author='jenojp' date='2019-09-10T20:33:16Z'>
 		Ha, yea, I was just looking at the same. One approach would be to set the default  to 2 instead of 0 if , see &lt;denchmark-link:https://github.com/svlandeg/spaCy/commit/a6c137f82a68e0fa29a8869ae6c87612e7182e4b&gt;here&lt;/denchmark-link&gt;
 , but that makes another unit test fail...
 		</comment>
 		<comment id='4' author='jenojp' date='2019-09-10T20:39:22Z'>
 		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
  : I guess this discussion has been had in the &lt;denchmark-link:https://github.com/explosion/spaCy/commit/7d4687162f1792111902754690297a3b0bc86237#diff-c80066060b9c4b494e7e89fe77fb823b&gt;past &lt;/denchmark-link&gt;
 ... So it is in fact desired behaviour that the setting of  resets everything to 0 (empty string) ? What about the original case discussed in this topic - would you expect the  to be reset to 0 (empty string) as well?
 		</comment>
 		<comment id='5' author='jenojp' date='2019-09-10T20:40:46Z'>
 		I don't think it's possible to have the behavior in test_doc_add_entities_set_ents_iob and the correct is_nered, at least not without major changes to is_nered. I'm not sure why we would want the behavior in test_doc_add_entities_set_ents_iob, though?
 		</comment>
 		<comment id='6' author='jenojp' date='2019-09-14T09:36:31Z'>
 		Ok it turns out this requires a more in-depth analysis and solution ;-) Will look into it ASAP.
 		</comment>
 		<comment id='7' author='jenojp' date='2019-10-18T20:08:07Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='de5a9ecdf3e60240c78526d04aaa0931e3e825a6' author='Sofie Van Landeghem' date='2019-09-18 21:37:17+02:00'>
 	<dmm_unit complexity='1.0' interfacing='0.9739130434782609' size='0.4'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\errors.py' new_name='spacy\errors.py'>
 		<file_info nloc='502' complexity='23' token_count='1622'></file_info>
 		<modified_lines>
 			<added_lines>121</added_lines>
 			<deleted_lines>121</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\syntax\ner.pyx' new_name='spacy\syntax\ner.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>69,70,165,269,285,286,329,341,342,344,345,346,347,348,349,350,351,352,353,354,403,404,409,411,412,413,414,415,416,417,470,471,472,473,474</added_lines>
 			<deleted_lines>69,164,165,269,285,286,338,339,342,343,390,398,400,453,456,457,458</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\syntax\nn_parser.pyx' new_name='spacy\syntax\nn_parser.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>138,139,140</added_lines>
 			<deleted_lines>138</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tests\doc\test_add_entities.py' new_name='spacy\tests\doc\test_add_entities.py'>
 		<file_info nloc='34' complexity='8' token_count='353'></file_info>
 		<method name='test_ents_reset' parameters='en_vocab'>
 				<method_info nloc='9' complexity='3' token_count='93' nesting_level='0' start_line='27' end_line='35'></method_info>
 			<added_lines>27,28,29,30,31,32,33,34,35</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_doc_add_entities_set_ents_iob' parameters='en_vocab'>
 				<method_info nloc='12' complexity='4' token_count='154' nesting_level='0' start_line='11' end_line='24'></method_info>
 			<added_lines>19,21,22,24</added_lines>
 			<deleted_lines>20,22</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>25,26</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tests\parser\test_ner.py' new_name='spacy\tests\parser\test_ner.py'>
 		<file_info nloc='159' complexity='36' token_count='1495'></file_info>
 		<method name='__call__' parameters='self,doc'>
 				<method_info nloc='3' complexity='1' token_count='26' nesting_level='1' start_line='224' end_line='226'></method_info>
 			<added_lines>224,225,226</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_overwrite_token' parameters=''>
 				<method_info nloc='17' complexity='3' token_count='175' nesting_level='0' start_line='132' end_line='152'></method_info>
 			<added_lines>132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_accept_blocked_token' parameters=''>
 				<method_info nloc='31' complexity='5' token_count='343' nesting_level='0' start_line='85' end_line='129'></method_info>
 			<added_lines>85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129</added_lines>
 			<deleted_lines>85,86,87,88,89,90,91,92,93</deleted_lines>
 		</method>
 		<method name='test_doc_add_entities_set_ents_iob' parameters='en_vocab'>
 				<method_info nloc='11' complexity='4' token_count='153' nesting_level='0' start_line='83' end_line='93'></method_info>
 			<added_lines>85,86,87,88,89,90,91,92,93</added_lines>
 			<deleted_lines>83,84,85,86,87,88,89,90,91,92,93</deleted_lines>
 		</method>
 		<method name='test_ruler_before_ner' parameters=''>
 				<method_info nloc='15' complexity='3' token_count='130' nesting_level='0' start_line='155' end_line='175'></method_info>
 			<added_lines>155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_ner_before_ruler' parameters=''>
 				<method_info nloc='15' complexity='3' token_count='134' nesting_level='0' start_line='178' end_line='198'></method_info>
 			<added_lines>178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,start,end'>
 				<method_info nloc='3' complexity='1' token_count='19' nesting_level='1' start_line='220' end_line='222'></method_info>
 			<added_lines>220,221,222</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_block_ner' parameters=''>
 				<method_info nloc='12' complexity='3' token_count='118' nesting_level='0' start_line='201' end_line='214'></method_info>
 			<added_lines>201,202,203,204,205,206,207,208,209,210,211,212,213,214</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>5,6,7,130,131,153,154,176,177,199,200,215,216,217,218,219,223</added_lines>
 			<deleted_lines>5</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tests\regression\test_issue1-1000.py' new_name='spacy\tests\regression\test_issue1-1000.py'>
 		<file_info nloc='352' complexity='60' token_count='3024'></file_info>
 		<method name='test_issue999' parameters='train_data'>
 				<method_info nloc='37' complexity='10' token_count='285' nesting_level='0' start_line='426' end_line='471'></method_info>
 			<added_lines>429</added_lines>
 			<deleted_lines>429</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='spacy\tests\regression\test_issue4267.py'>
 		<file_info nloc='27' complexity='3' token_count='155'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\doc.pyx' new_name='spacy\tokens\doc.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>259,528,529,532,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570</added_lines>
 			<deleted_lines>259,528,529,530,531,532,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\token.pyx' new_name='spacy\tokens\token.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>752,753</added_lines>
 			<deleted_lines>752</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
