<bug_data>
<bug id='4262' author='lautel' open_date='2019-09-09T10:44:02Z' closed_time='2019-09-13T14:37:36Z'>
 	<summary>Confussing behaviour in Phrase Matcher for Japanese model</summary>
 	<description>
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 &lt;denchmark-h:h3&gt;0. Load libraries&lt;/denchmark-h&gt;
 
 from spacy.matcher import PhraseMatcher
 from spacy.lang.ja import Japanese
 &lt;denchmark-h:h3&gt;1. Define a Phrase Matcher to find custom entities in Japanese text:&lt;/denchmark-h&gt;
 
 def phrase_matcher_test(text):
 
     nlp = Japanese()
 
     matcher = PhraseMatcher(nlp.vocab, attr="LOWER")
     patterns = ["nakagawa jun", "中川 潤", "nakagawa@xxxx.jp", "japan"]
     patterns_doc = list(nlp.pipe(patterns))
     matcher.add("ENTITY", None, *patterns_doc)
 
     doc = nlp(text)
 
     matches = matcher(doc)
     print(f'\n{len(matches)} matches found!')
 
     for match_id, start, end in matches:
         print(doc.vocab.strings[match_id]+': ', doc[start:end].text)
 &lt;denchmark-h:h3&gt;3. Call the function&lt;/denchmark-h&gt;
 
 input_text = "Nakagawa Jun (中川潤) のﾒｰﾙはnakagawa@xxxx.jpです. 彼はJapanで働いています"
 phrase_matcher_test(input_text )
 &lt;denchmark-h:h3&gt;4. Result&lt;/denchmark-h&gt;
 
 Output:
 3 matches found!
 ENTITY:  中川潤
 ENTITY:  &lt;denchmark-link:mailto:nakagawa@xxxx.jp&gt;nakagawa@xxxx.jp&lt;/denchmark-link&gt;
 
 ENTITY:  Japan
 Expected output:
 4 matches found!
 ENTITY: Nakagawa Jun
 ENTITY:  中川潤
 ENTITY:  &lt;denchmark-link:mailto:nakagawa@xxxx.jp&gt;nakagawa@xxxx.jp&lt;/denchmark-link&gt;
 
 ENTITY:  Japan
 &lt;denchmark-h:h3&gt;5. Additional info&lt;/denchmark-h&gt;
 
 If
 input_text = "nakagawa jun (中川潤) のﾒｰﾙはnakagawa@xxxx.jpです. 彼はJapanで働いています"
 it almost works as expected (note lowercase in 'nakagawa jun', but not in 'Japan'). By almost I mean that it matches the name but deletes the blank space between name and surname. See the following output.
 Output:
 ENTITY:  nakagawajun
 ENTITY:  中川潤
 ENTITY:  &lt;denchmark-link:mailto:nakagawa@xxxx.jp&gt;nakagawa@xxxx.jp&lt;/denchmark-link&gt;
 
 ENTITY:  Japan
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 
 spaCy version: 2.1.8
 Platform: Windows-10-10.0.17134-SP0
 Python version: 3.7.3
 
 	</description>
 	<comments>
 		<comment id='1' author='lautel' date='2019-09-11T13:03:30Z'>
 		Hi,
 We've kept doing some test and the example given is working fine in SpaCy version 2.1.4. Hope you find this helpful.
 		</comment>
 		<comment id='2' author='lautel' date='2019-09-12T07:29:46Z'>
 		Thanks for the report! I can only replicate the missing space, not the missing match, but I definitely think there is something going on because the Japanese tokenization tests are failing, too.
 With a clean virtual environment with spacy 2.1.8 and mecab-python3, I get the output:
 &lt;denchmark-code&gt;4 matches found!
 ENTITY:  NakagawaJun
 ENTITY:  中川潤
 ENTITY:  nakagawa@xxxx.jp
 ENTITY:  Japan
 &lt;/denchmark-code&gt;
 
 My enviroment:
 &lt;denchmark-code&gt;blis==0.2.4
 certifi==2019.9.11
 chardet==3.0.4
 cymem==2.0.2
 idna==2.8
 mecab-python3==0.996.2
 murmurhash==1.0.2
 numpy==1.17.2
 pkg-resources==0.0.0
 plac==0.9.6
 preshed==2.0.1
 requests==2.22.0
 spacy==2.1.8
 srsly==0.1.0
 thinc==7.0.8
 tqdm==4.35.0
 urllib3==1.25.3
 wasabi==0.2.2
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-link:https://github.com/polm&gt;@polm&lt;/denchmark-link&gt;
 , do you have any ideas?
 		</comment>
 		<comment id='3' author='lautel' date='2019-09-12T07:43:54Z'>
 		Can you try it with mecab-python3==0.7? I think that should be the version in optional requires, newer versions have bugs or dictionary issues.
 		</comment>
 		<comment id='4' author='lautel' date='2019-09-12T08:38:45Z'>
 		Hi, thanks for your quick response!
 So, working with mecab-python3==0.996.2 I have same output as &lt;denchmark-link:https://github.com/adrianeboyd&gt;@adrianeboyd&lt;/denchmark-link&gt;
 , both in Windows and Linux environment. However, previously I had mecab-python3==0.7 installed and that's why the first match (NakagawaJun) was missing...
 		</comment>
 		<comment id='5' author='lautel' date='2019-09-12T12:04:42Z'>
 		Sorry, I was just going by the error message (I guess the error message should be more specific?):
 
 
 
 spaCy/spacy/lang/ja/__init__.py
 
 
         Lines 27 to 29
       in
       4d4b3b0
 
 
 
 
 
 
  raise ImportError( 
 
 
 
  "Japanese support requires MeCab: " 
 
 
 
  "https://github.com/SamuraiT/mecab-python3" 
 
 
 
 
 
 However, I get the same results with 4 matches and no space with mecab-python3==0.7 and nearly all the tests in tests/lang/ja fail. A few examples are tokenized correctly, some aren't, and I think all the POS and lemma tests fail.
 		</comment>
 		<comment id='6' author='lautel' date='2019-09-13T12:15:45Z'>
 		&lt;denchmark-link:https://github.com/adrianeboyd&gt;@adrianeboyd&lt;/denchmark-link&gt;
  Are you sure you have Unidic installed? If you're using ipadic that would cause the tests to fail. To check, show the output of  and .
 &lt;denchmark-link:https://github.com/lautel&gt;@lautel&lt;/denchmark-link&gt;
  With a clean install of spaCy 2.1.8 and mecab-python3 0.7 on Linux I get this output:
 &lt;denchmark-code&gt;4 matches found!
 ENTITY:  NakagawaJun
 ENTITY:  中川潤
 ENTITY:  nakagawa@xxxx.jp
 ENTITY:  Japan
 &lt;/denchmark-code&gt;
 
 So the space issue is there, but I don't have the other mismatch issue. I'm not sure why you aren't getting Nakagawa Jun as an entity, can you figure out what POS tags it's getting?
 As to why the space is missing, the way Mecab handles half-width spaces is weird. I thought I'd handled it correctly but it's possible I missed something, so I'll look over that code in more detail.
 		</comment>
 		<comment id='7' author='lautel' date='2019-09-13T12:53:24Z'>
 		&lt;denchmark-link:https://github.com/polm&gt;@polm&lt;/denchmark-link&gt;
 , I've re-run the example to double-check the output and yes, I'm missing the first match. Anyway, this seems to be okay in mecab-python3==0.996.2
 In case you find it useful, see below further information regarding my environment (Linux):
 python -m spacy info --markdown
 
 spaCy version: 2.1.8
 Platform: Linux-4.9.184-linuxkit-x86_64-with-debian-9.9
 Python version: 3.7.4
 
 echo "図書館" | mecab
 &lt;denchmark-code&gt;図書館  名詞,一般,*,*,*,*,図書館,トショカン,トショカン
 EOS
 &lt;/denchmark-code&gt;
 
 mecab -D
 &lt;denchmark-code&gt;filename:       /usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd/sys.dic
 version:        102
 charset:        UTF8
 type:   0
 size:   4587310
 left size:      1316
 right size:     1316
 &lt;/denchmark-code&gt;
 
 pip list
 &lt;denchmark-code&gt;Package       Version
 ------------- ---------
 blis          0.2.4
 certifi       2019.9.11
 chardet       3.0.4
 cymem         2.0.2
 idna          2.8
 mecab-python3 0.7
 mojimoji      0.0.9
 murmurhash    1.0.2
 numpy         1.17.2
 pip           19.1.1
 plac          0.9.6
 preshed       2.0.1
 requests      2.22.0
 setuptools    41.0.1
 spacy         2.1.8
 srsly         0.1.0
 thinc         7.0.8
 tqdm          4.35.0
 urllib3       1.25.3
 wasabi        0.2.2
 wheel         0.33.4
 &lt;/denchmark-code&gt;
 
 Thank you both!
 		</comment>
 		<comment id='8' author='lautel' date='2019-09-13T13:17:12Z'>
 		&lt;denchmark-link:https://github.com/lautel&gt;@lautel&lt;/denchmark-link&gt;
  OK, you're using an IPADic based Neologd dictionary, which won't work. spaCy uses Universal Dependencies, which is based on / only supports Unidic. Please install Unidic and configure Mecab to use it. I would also suggest you avoid using Neologd. This is a reminder that I should probably write a dictionary sniffer to check that Unidic is being used...
 The missing spaces was a real issue; I pushed a fix in &lt;denchmark-link:https://github.com/explosion/spaCy/pull/4284&gt;#4284&lt;/denchmark-link&gt;
 . Thanks for finding it!
 		</comment>
 		<comment id='9' author='lautel' date='2019-10-13T14:42:53Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='29a9e636eb8b0f22f91eee85b4a10b8cdade4ed2' author='Paul OLeary McCann' date='2019-09-13 16:28:12+02:00'>
 	<dmm_unit complexity='1.0' interfacing='1.0' size='0.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\lang\ja\__init__.py' new_name='spacy\lang\ja\__init__.py'>
 		<file_info nloc='85' complexity='19' token_count='577'></file_info>
 		<method name='__call__' parameters='self,text'>
 				<method_info nloc='11' complexity='3' token_count='95' nesting_level='1' start_line='95' end_line='105'></method_info>
 			<added_lines>96</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='detailed_tokens' parameters='tokenizer,text'>
 				<method_info nloc='21' complexity='4' token_count='152' nesting_level='0' start_line='57' end_line='86'></method_info>
 			<added_lines>62,73,74,75,76,77,78,79,80,81,82,83,84,86</added_lines>
 			<deleted_lines>68,78,80</deleted_lines>
 		</method>
 		<method name='resolve_pos' parameters='token'>
 				<method_info nloc='10' complexity='5' token_count='70' nesting_level='0' start_line='33' end_line='54'></method_info>
 			<added_lines>40,41,42,43,44</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\lang\ja\tag_map.py' new_name='spacy\lang\ja\tag_map.py'>
 		<file_info nloc='71' complexity='0' token_count='546'></file_info>
 		<modified_lines>
 			<added_lines>5,24,25</added_lines>
 			<deleted_lines>5</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tests\lang\ja\test_tokenizer.py' new_name='spacy\tests\lang\ja\test_tokenizer.py'>
 		<file_info nloc='39' complexity='7' token_count='468'></file_info>
 		<method name='test_extra_spaces' parameters='ja_tokenizer'>
 				<method_info nloc='4' complexity='1' token_count='29' nesting_level='0' start_line='51' end_line='55'></method_info>
 			<added_lines>51,52,53,54,55</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>50</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
