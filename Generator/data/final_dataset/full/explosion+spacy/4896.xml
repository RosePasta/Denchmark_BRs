<bug_data>
<bug id='4896' author='omri374' open_date='2020-01-09T16:16:27Z' closed_time='2020-02-12T16:46:00Z'>
 	<summary>doc similarity is different between GPU version and CPU version</summary>
 	<description>
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 Introducing GPU makes doc.similarity return &lt;class 'cupy.core.core.ndarray'&gt; of size 1 instead of a scalar. On CPU the same call returns a scalar.
 Reproduce:
 import spacy
 nlp1 = spacy.load("en_vectors_web_lg")
 doc1 = nlp1("Hey there how are you?")
 doc2 = nlp1("I'm good and you?")
 doc1.similarity(doc2)
 0.9182046417319748
 Then, when requiring GPU:
 spacy.require_gpu()
 True
 nlp2 = spacy.load("en_vectors_web_lg")
 doc1 = nlp2("Hey there how are you?")
 doc2 = nlp2("I'm good and you?")
 doc1.similarity(doc2)
 array(0.9182048, dtype=float32)
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 
 spaCy version: 2.2.3
 Platform: Linux-4.15.0-1064-azure-x86_64-with-debian-stretch-sid
 Python version: 3.7.5
 
 	</description>
 	<comments>
 		<comment id='1' author='omri374' date='2020-01-09T16:19:58Z'>
 		A quick workaround is to call .item() in any case.
 		</comment>
 		<comment id='2' author='omri374' date='2020-01-15T10:05:05Z'>
 		The difference is so small that I would argue that it is negligible/rounding noise. I do agree that it'd be better if in both cases, the same type is returned.
 		</comment>
 		<comment id='3' author='omri374' date='2020-02-04T10:02:20Z'>
 		Thanks for the report! This boils down to the difference in output type of the  method between &lt;denchmark-link:https://docs.scipy.org/doc/numpy/reference/generated/numpy.dot.html&gt;numpy&lt;/denchmark-link&gt;
  and &lt;denchmark-link:https://docs-cupy.chainer.org/en/stable/reference/generated/cupy.dot.html&gt;cupy&lt;/denchmark-link&gt;
 . numpy automatically converts an array with a single element to a scalar, which  doesn't. Calling  makes sense, I'll update the codebase accordingly so there are no surprises.
 		</comment>
 		<comment id='4' author='omri374' date='2020-02-04T11:17:47Z'>
 		
 Thanks for the report! This boils down to the difference in output type of the dot method between numpy and cupy. numpy automatically converts an array with a single element to a scalar, which cupy doesn't. Calling item() makes sense, I'll update the codebase accordingly so there are no surprises.
 
 Hi. I think that's a good decision, indeed! Make sure to document this well, though, because in itself this breaks the way it was implemented before (different type returned). I don't know how many people use this in their code base, but it might cause unexpected bugs when suddenly the item() instead of the array is returned. Therefore, documenting seems very important.
 		</comment>
 		<comment id='5' author='omri374' date='2020-02-04T15:36:38Z'>
 		Yea, I was just thinking about that, we'll probably introduce it as part of v.3 ;-)
 		</comment>
 		<comment id='6' author='omri374' date='2020-02-12T16:46:00Z'>
 		Fixed by PR &lt;denchmark-link:https://github.com/explosion/spaCy/pull/4969&gt;#4969&lt;/denchmark-link&gt;
  - will be in spaCy v.3
 		</comment>
 		<comment id='7' author='omri374' date='2020-03-17T13:31:14Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='781e95cf536cd5720d07ec80b2cb89eaa4b41290' author='Sofie Van Landeghem' date='2020-02-10 20:31:49-05:00'>
 	<dmm_unit complexity='None' interfacing='None' size='None'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\tokens\doc.pyx' new_name='spacy\tokens\doc.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>394,395,396</added_lines>
 			<deleted_lines>394</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
