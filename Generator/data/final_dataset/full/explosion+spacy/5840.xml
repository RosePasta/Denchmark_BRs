<bug_data>
<bug id='5840' author='mdgilene' open_date='2020-07-29T15:18:08Z' closed_time='2020-07-31T14:09:33Z'>
 	<summary>EntityRuler overlapping matches of the same length, the one appearing last in the document is chosen instead of the first</summary>
 	<description>
 Believe this is caused by the following line using reverse=True for both sort keys. It should be reverse sorted on entity length, then regular sort on start index:
 
 
 
 spaCy/spacy/pipeline/entityruler.py
 
 
         Lines 98 to 99
       in
       03ab518
 
 
 
 
 
 
  get_sort_key = lambda m: (m[2] - m[1], m[1]) 
 
 
 
  matches = sorted(matches, key=get_sort_key, reverse=True) 
 
 
 
 
 
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 &lt;denchmark-code&gt;import spacy
 from spacy.pipeline import EntityRuler
 
 patterns = [
     {"label": "FOOBAR", "pattern": "foo bar"},
     {"label": "BARBAZ", "pattern": "bar baz"},
 ]
 
 nlp = spacy.load("en_core_web_sm")
 ruler = EntityRuler(nlp)
 ruler.add_patterns(patterns)
 nlp.add_pipe(ruler, before="ner")
 
 doc = nlp("foo bar baz")
 
 print([(ent.text, ent.label_, ent.ent_id_) for ent in doc.ents])
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 
 spaCy version: 2.3.2
 Platform: Windows-10-10.0.17134-SP0
 Python version: 3.7.5
 
 	</description>
 	<comments>
 		<comment id='1' author='mdgilene' date='2020-07-30T07:21:54Z'>
 		Thanks for the report! We'd fixed the same issue in util.filter_spans but missed the same issue here.
 		</comment>
 	</comments>
 </bug>
<commit id='ac14ce7c30c2f6da4a71dee7978f5b765af4d966' author='Adriane Boyd' date='2020-07-31 16:09:32+02:00'>
 	<dmm_unit complexity='1.0' interfacing='1.0' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\pipeline\entityruler.py' new_name='spacy\pipeline\entityruler.py'>
 		<file_info nloc='244' complexity='65' token_count='1775'></file_info>
 		<method name='__call__' parameters='self,doc'>
 				<method_info nloc='29' complexity='15' token_count='263' nesting_level='1' start_line='86' end_line='122'></method_info>
 			<added_lines>98</added_lines>
 			<deleted_lines>98</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tests\pipeline\test_entity_ruler.py' new_name='spacy\tests\pipeline\test_entity_ruler.py'>
 		<file_info nloc='130' complexity='16' token_count='1140'></file_info>
 		<method name='test_entity_ruler_overlapping_spans' parameters='nlp'>
 				<method_info nloc='10' complexity='1' token_count='72' nesting_level='0' start_line='159' end_line='168'></method_info>
 			<added_lines>159,160,161,162,163,164,165,166,167,168</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>157,158</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
