<bug_data>
<bug id='3473' author='Tpt' open_date='2019-03-23T19:49:51Z' closed_time='2019-03-31T11:59:21Z'>
 	<summary>TextCategorizer: TypeError: Only cupy arrays can be concatenated (Training on GPU)</summary>
 	<description>
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 Sorry for bothering you again with the nearly same problem. After upgrading to Spacy 2.1.3, if I try to train a text categorizer with CUDA enabled, I get back the error . It seems to be the same problem as &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3355&gt;#3355&lt;/denchmark-link&gt;
 
 I purged my venv and made a pip install --upgrade 'spacy[cuda100]', so it's probably not because an old library version is kept in my environment.
 Backtrace:
 &lt;denchmark-code&gt;Traceback (most recent call last):
 ...
     nlp.update(texts, annotations, sgd=optimizer, drop=0.5, losses=losses)
   File "venv/lib/python3.7/site-packages/spacy/language.py", line 452, in update
     proc.update(docs, golds, sgd=get_grads, losses=losses, **kwargs)
   File "pipes.pyx", line 931, in spacy.pipeline.pipes.TextCategorizer.update
   File "venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py", line 46, in begin_update
     X, inc_layer_grad = layer.begin_update(X, drop=drop)
   File "venv/lib/python3.7/site-packages/thinc/api.py", line 132, in begin_update
     values = [fwd(X, *a, **k) for fwd in forward]
   File "venv/lib/python3.7/site-packages/thinc/api.py", line 132, in &lt;listcomp&gt;
     values = [fwd(X, *a, **k) for fwd in forward]
   File "venv/lib/python3.7/site-packages/thinc/api.py", line 225, in wrap
     output = func(*args, **kwargs)
   File "venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py", line 46, in begin_update
     X, inc_layer_grad = layer.begin_update(X, drop=drop)
   File "venv/lib/python3.7/site-packages/spacy/_ml.py", line 138, in begin_update
     keys = self.ops.xp.concatenate(ngrams)
   File "venv/lib/python3.7/site-packages/cupy/manipulation/join.py", line 49, in concatenate
     return core.concatenate_method(tup, axis)
   File "cupy/core/_routines_manipulation.pyx", line 561, in cupy.core._routines_manipulation.concatenate_method
   File "cupy/core/_routines_manipulation.pyx", line 574, in cupy.core._routines_manipulation.concatenate_method
 TypeError: Only cupy arrays can be concatenated
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 
 spaCy version    2.1.3
 Platform         Linux-5.0.3-arch1-1-ARCH-x86_64-with-arch
 Python version   3.7.2
 
 	</description>
 	<comments>
 		<comment id='1' author='Tpt' date='2019-03-26T09:30:43Z'>
 		Argh. Thanks for the report. We still don't have a CI server running the GPU paths, so it's really hard to prevent this reliably. For now you could edit your spacy/_ml.py file to make the following patch:
 &lt;denchmark-code&gt;613 def build_bow_text_classifier(nr_class, ngram_size=1, exclusive_classes=False,
 614         no_output_layer=False, **cfg):
 615     with Model.define_operators({"&gt;&gt;": chain}):
 616         model = (
 617             with_cpu(Model.ops,
 618                 extract_ngrams(ngram_size, attr=ORTH)
 619                 &gt;&gt; LinearModel(nr_class)
 620             )
 621         )
 622         if not no_output_layer:
 623             model = model &gt;&gt; (cpu_softmax if exclusive_classes else logistic)
 624     model.nO = nr_class
 625     return model
 626
 &lt;/denchmark-code&gt;
 
 Thanks for your help reporting.
 		</comment>
 		<comment id='2' author='Tpt' date='2019-03-26T09:38:57Z'>
 		Thank you for maintaining this amazing library and for the hot fix!
 		</comment>
 		<comment id='3' author='Tpt' date='2019-04-30T12:52:17Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='f77bf2bdb1b62b97e9582fcc14d4550448a6340d' author='Matthew Honnibal' date='2019-03-26 13:36:11+01:00'>
 	<dmm_unit complexity='None' interfacing='None' size='None'></dmm_unit>
 	<modification change_type='MODIFY' old_name='spacy\_ml.py' new_name='spacy\_ml.py'>
 		<file_info nloc='596' complexity='131' token_count='4989'></file_info>
 		<modified_lines>
 			<added_lines>617,618,619</added_lines>
 			<deleted_lines>617,618,619</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
