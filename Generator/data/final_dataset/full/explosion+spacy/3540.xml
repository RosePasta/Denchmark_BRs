<bug_data>
<bug id='3540' author='klti' open_date='2019-04-04T09:02:24Z' closed_time='2019-08-08T13:09:56Z'>
 	<summary>Problem with vector attribute after calling Retokenizer.split</summary>
 	<description>
 When trying to use split and retokenize like in the docs (&lt;denchmark-link:https://spacy.io/usage/linguistic-features/#retokenization&gt;https://spacy.io/usage/linguistic-features/#retokenization&lt;/denchmark-link&gt;
 ),  breaks with an error
 &lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;
 
 code to reproduce (nearly the same as example in docs, only made strings unicode and added displacy.render calls)
 &lt;denchmark-code&gt;import spacy
 from spacy import displacy
 
 nlp = spacy.load("en_core_web_sm")
 doc = nlp(u"I live in NewYork right now")
 print("Before:", [token.text for token in doc])
 displacy.render(doc)  # works
 displacy.render(doc, style="dep")  # works
 displacy.render(list(doc.sents), style="dep")  # works
 
 with doc.retokenize() as retokenizer:
     heads = [(doc[3], 1), doc[2]]
     attrs = {"POS": ["PROPN", "PROPN"], "DEP": ["pobj", "compound"]}
     retokenizer.split(doc[3], [u"New", u"York"], heads=heads, attrs=attrs)
 print("After:", [token.text for token in doc])
 displacy.render(doc)  # works
 displacy.render(doc, style="dep")  # works
 displacy.render(list(doc.sents), style="dep")  # breaks
 &lt;/denchmark-code&gt;
 
 Output
 &lt;denchmark-code&gt;('Before:', [u'I', u'live', u'in', u'NewYork', u'right', u'now'])
 ('After:', [u'I', u'live', u'in', u'New', u'York', u'right', u'now'])
 Traceback (most recent call last):
   File "test_example.py", line 18, in &lt;module&gt;
     displacy.render(list(doc.sents), style="dep") # breaks
   File "/usr/lib/python2.7/site-packages/spacy/displacy/__init__.py", line 46, in render
     docs = [obj if not isinstance(obj, Span) else obj.as_doc() for obj in docs]
   File "span.pyx", line 224, in spacy.tokens.span.Span.as_doc
   File "span.pyx", line 410, in spacy.tokens.span.Span.vector.__get__
   File "span.pyx", line 187, in __iter__
   File "token.pyx", line 392, in spacy.tokens.token.Token.vector.__get__
 IndexError: index 6 is out of bounds for axis 0 with size 6
 &lt;/denchmark-code&gt;
 
 &lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;
 
 
 Python version: 2.7.16
 Platform: Linux-5.0.3-arch1-1-ARCH-x86_64-with-glibc2.2.5
 spaCy version: 2.1.3
 
 P.S.: great library, I love it üëç
 	</description>
 	<comments>
 		<comment id='1' author='klti' date='2019-04-04T09:03:57Z'>
 		Thanks for the report ‚Äì based on the error, this looks like it might be a problem with how the vector attribute is handled after splitting.
 		</comment>
 		<comment id='2' author='klti' date='2019-08-08T09:15:20Z'>
 		&lt;denchmark-link:https://github.com/klti&gt;@klti&lt;/denchmark-link&gt;
  : thanks for the report! It was indeed an issue with the  attribute as &lt;denchmark-link:https://github.com/ines&gt;@ines&lt;/denchmark-link&gt;
  pointed out. This should hopefully be fixed by PR &lt;denchmark-link:https://github.com/explosion/spaCy/pull/4097&gt;#4097&lt;/denchmark-link&gt;
 .
 		</comment>
 		<comment id='3' author='klti' date='2019-09-07T13:42:42Z'>
 		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
 		</comment>
 	</comments>
 </bug>
<commit id='963ea5e8d0290e2198b6b36fa79b420f3152f639' author='Sofie Van Landeghem' date='2019-08-08 15:09:44+02:00'>
 	<dmm_unit complexity='0.0' interfacing='1.0' size='0.0'></dmm_unit>
 	<modification change_type='ADD' old_name='None' new_name='spacy\tests\regression\test_issue3540.py'>
 		<file_info nloc='29' complexity='7' token_count='436'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='spacy\tokens\_retokenize.pyx' new_name='spacy\tokens\_retokenize.pyx'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>407,408,409,410,413,414,421,422,423,424</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
