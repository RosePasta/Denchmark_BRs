<bug_data>
<bug id='2939' author='stephanie-wang' open_date='2018-09-25T03:43:30Z' closed_time='2018-10-19T04:57:32Z'>
 	<summary>[xray] All messages on main asio event loop should be written asynchronously</summary>
 	<description>
 &lt;denchmark-h:h3&gt;System information&lt;/denchmark-h&gt;
 
 
 OS Platform and Distribution (e.g., Linux Ubuntu 16.04): all
 Ray installed from (source or binary): source
 Ray version: Master
 
 &lt;denchmark-h:h3&gt;Describe the problem&lt;/denchmark-h&gt;
 
 The backend writes messages to a socket synchronously, which can block the writer's event loop. There are a few places where we do this on the main event loop:
 
 When forwarding a task to a remote node manager: code
 When assigning a task to a worker: code
 When sending a Pull request to a remote object manager: code
 
 We should modify the  class to allow messages to be written asynchronously. boost::asio's doesn't guarantee correctness if we allow concurrent asynchronous writes on the same socket, so we must implement a queue per socket ourselves. Here is an &lt;denchmark-link:https://github.com/stephanie-wang/ray/blob/xray-ysb-failure-test/src/ray/common/client_connection.cc#L166&gt;example&lt;/denchmark-link&gt;
 .
 	</description>
 	<comments>
 		<comment id='1' author='stephanie-wang' date='2018-09-27T16:08:28Z'>
 		Maybe could use a strand when posting to a thread pool, which guarantees both correctness and order?
 		</comment>
 		<comment id='2' author='stephanie-wang' date='2018-10-19T04:57:32Z'>
 		Fixed by &lt;denchmark-link:https://github.com/ray-project/ray/pull/3023&gt;#3023&lt;/denchmark-link&gt;
 .
 		</comment>
 	</comments>
 </bug>
<commit id='9d23fa03c98f2847271bef1551c736abf03d2204' author='Eric Liang' date='2018-10-18 21:56:22-07:00'>
 	<dmm_unit complexity='0.75' interfacing='0.6032608695652174' size='0.06521739130434782'></dmm_unit>
 	<modification change_type='MODIFY' old_name='.travis.yml' new_name='.travis.yml'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>57,188</added_lines>
 			<deleted_lines>57</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='RENAME' old_name='.travis\yapf.sh' new_name='.travis\format.sh'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\common\client_connection.cc' new_name='src\ray\common\client_connection.cc'>
 		<file_info nloc='208' complexity='34' token_count='1753'></file_info>
 		<method name='ray::ServerConnection&lt;T&gt;::WriteMessageAsync' parameters='type,length,message,handler'>
 				<method_info nloc='20' complexity='4' token_count='178' nesting_level='1' start_line='96' end_line='118'></method_info>
 			<added_lines>96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::ServerConnection&lt;T&gt;::WriteMessage' parameters='type,length,message'>
 				<method_info nloc='10' complexity='1' token_count='127' nesting_level='1' start_line='73' end_line='84'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>81,82</deleted_lines>
 		</method>
 		<method name='ray::ServerConnection&lt;T&gt;::Create' parameters='socket'>
 				<method_info nloc='5' complexity='1' token_count='46' nesting_level='1' start_line='23' end_line='27'></method_info>
 			<added_lines>23,24,25,26,27</added_lines>
 			<deleted_lines>23</deleted_lines>
 		</method>
 		<method name='ray::ClientConnection&lt;T&gt;::ProcessMessageHeader' parameters='error'>
 				<method_info nloc='14' complexity='2' token_count='119' nesting_level='1' start_line='210' end_line='228'></method_info>
 			<added_lines>226,227</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::ClientConnection&lt;T&gt;::ProcessMessages' parameters=''>
 				<method_info nloc='10' complexity='1' token_count='123' nesting_level='1' start_line='196' end_line='207'></method_info>
 			<added_lines>205,206</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::ClientConnection&lt;T&gt;::ProcessMessage' parameters='error'>
 				<method_info nloc='12' complexity='3' token_count='111' nesting_level='1' start_line='231' end_line='243'></method_info>
 			<added_lines>237</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::ServerConnection&lt;T&gt;::DoAsyncWrites' parameters=''>
 				<method_info nloc='38' complexity='6' token_count='299' nesting_level='1' start_line='121' end_line='164'></method_info>
 			<added_lines>121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164</added_lines>
 			<deleted_lines>125,126,146,147,157</deleted_lines>
 		</method>
 		<method name='ray::ServerConnection&lt;T&gt;::ServerConnection' parameters='socket'>
 				<method_info nloc='5' complexity='1' token_count='44' nesting_level='1' start_line='30' end_line='34'></method_info>
 			<added_lines>31,32,33,34</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>3,22,28,95,119,120,165</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\common\client_connection.h' new_name='src\ray\common\client_connection.h'>
 		<file_info nloc='80' complexity='2' token_count='629'></file_info>
 		<method name='ray::ClientConnection::shared_ClientConnection_from_this' parameters=''>
 				<method_info nloc='3' complexity='1' token_count='21' nesting_level='2' start_line='136' end_line='138'></method_info>
 			<added_lines>136,137,138</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::ServerConnection::Close' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='19' nesting_level='2' start_line='70' end_line='73'></method_info>
 			<added_lines>70,71,72,73</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>4,30,32,33,34,35,36,37,47,48,49,50,51,52,53,54,55,69,74,76,77,78,79,80,81,82,83,84,85,86,87,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,122,124,125,139</added_lines>
 			<deleted_lines>29,31,32,75,76</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\object_manager\object_manager.cc' new_name='src\ray\object_manager\object_manager.cc'>
 		<file_info nloc='640' complexity='113' token_count='5018'></file_info>
 		<method name='ray::ObjectManager::PullEstablishConnection' parameters='object_id,client_id'>
 				<method_info nloc='25' complexity='3' token_count='154' nesting_level='1' start_line='250' end_line='277'></method_info>
 			<added_lines>269,275</added_lines>
 			<deleted_lines>269,270,271,272</deleted_lines>
 		</method>
 		<method name='ray::ObjectManager::PullSendRequest' parameters='object_id,conn'>
 				<method_info nloc='16' complexity='2' token_count='141' nesting_level='1' start_line='279' end_line='294'></method_info>
 			<added_lines>279,280,285,287,288,289,290,291,292,293</added_lines>
 			<deleted_lines>279,280,281,285,286,291,293,294</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>278,295,296,297</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\object_manager\object_manager.h' new_name='src\ray\object_manager\object_manager.h'>
 		<file_info nloc='148' complexity='3' token_count='1076'></file_info>
 		<modified_lines>
 			<added_lines>248,250,251</added_lines>
 			<deleted_lines>248,250,251</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\object_manager\object_manager_client_connection.cc' new_name='src\ray\object_manager\object_manager_client_connection.cc'>
 		<file_info nloc='23' complexity='3' token_count='163'></file_info>
 		<method name='ray::SenderConnection::Create' parameters='io_service,client_id,ip,port'>
 				<method_info nloc='13' complexity='2' token_count='109' nesting_level='1' start_line='7' end_line='19'></method_info>
 			<added_lines>14</added_lines>
 			<deleted_lines>14</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\object_manager\object_manager_client_connection.h' new_name='src\ray\object_manager\object_manager_client_connection.h'>
 		<file_info nloc='42' complexity='6' token_count='278'></file_info>
 		<method name='ray::SenderConnection::WriteMessageAsync' parameters='type,length,message,handler'>
 				<method_info nloc='4' complexity='1' token_count='45' nesting_level='2' start_line='54' end_line='57'></method_info>
 			<added_lines>54,55,56,57</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>19,48,49,50,51,52,53,58</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\CMakeLists.txt' new_name='src\ray\raylet\CMakeLists.txt'>
 		<file_info nloc='None' complexity='None' token_count='None'></file_info>
 		<modified_lines>
 			<added_lines>35</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='ADD' old_name='None' new_name='src\ray\raylet\client_connection_test.cc'>
 		<file_info nloc='121' complexity='9' token_count='1068'></file_info>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\node_manager.cc' new_name='src\ray\raylet\node_manager.cc'>
 		<file_info nloc='1092' complexity='156' token_count='8771'></file_info>
 		<method name='ray::raylet::NodeManager::ClientAdded' parameters='client_data'>
 				<method_info nloc='36' complexity='4' token_count='287' nesting_level='2' start_line='317' end_line='368'></method_info>
 			<added_lines>362</added_lines>
 			<deleted_lines>362</deleted_lines>
 		</method>
 		<method name='ray::raylet::NodeManager::ForwardTaskOrResubmit' parameters='task,node_manager_id'>
 				<method_info nloc='27' complexity='2' token_count='219' nesting_level='2' start_line='1524' end_line='1571'></method_info>
 			<added_lines>1529,1530,1531,1570</added_lines>
 			<deleted_lines>1525,1526,1528,1567,1570</deleted_lines>
 		</method>
 		<method name='ray::raylet::NodeManager::ForwardTask' parameters='task,node_id'>
 				<method_info nloc='44' complexity='8' token_count='366' nesting_level='2' start_line='1570' end_line='1639'></method_info>
 			<added_lines>1570,1573,1574,1600,1601,1605,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,1634,1635,1636,1637,1638,1639</added_lines>
 			<deleted_lines>1570,1596,1600,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1635,1636,1637,1638</deleted_lines>
 		</method>
 		<method name='ray::raylet::NodeManager::AssignTask' parameters='task'>
 				<method_info nloc='65' complexity='9' token_count='556' nesting_level='2' start_line='1255' end_line='1360'></method_info>
 			<added_lines>1307,1309,1310,1311,1312,1313,1314,1315,1316,1317,1318,1319,1320,1321,1322,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,1353,1354,1355,1356,1357,1358,1359</added_lines>
 			<deleted_lines>1307,1309,1310,1311,1312,1313,1314,1315,1316,1317,1318,1319,1320,1321,1322,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,1353,1354,1355,1356</deleted_lines>
 		</method>
 		<method name='ray::raylet::NodeManager::ForwardTask' parameters='task,node_id,on_error'>
 				<method_info nloc='49' complexity='8' token_count='409' nesting_level='2' start_line='1573' end_line='1647'></method_info>
 			<added_lines>1573,1574,1600,1601,1605,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,1634,1635,1636,1637,1638,1639,1640,1641,1643,1644,1646</added_lines>
 			<deleted_lines>1596,1600,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1635,1636,1637,1638</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\node_manager.h' new_name='src\ray\raylet\node_manager.h'>
 		<file_info nloc='105' complexity='0' token_count='732'></file_info>
 		<modified_lines>
 			<added_lines>177,178,179,180,355,356</added_lines>
 			<deleted_lines>177,178,179,180,355</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
