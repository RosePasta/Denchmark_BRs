<bug_data>
<bug id='8784' author='simon-mo' open_date='2020-06-04T19:10:23Z' closed_time='2020-07-02T18:40:15Z'>
 	<summary>[Serve] Prometheus Metric Overrides</summary>
 	<description>
 &lt;denchmark-h:h3&gt;What is the problem?&lt;/denchmark-h&gt;
 
 Serve's prometheus exporter is stores a metric name -&gt; default label mapping, this is a bug because there are can different metrics for the same name without different default labels.
 Ray version and other system information (Python version, TensorFlow version, OS):
 &lt;denchmark-h:h3&gt;Reproduction (REQUIRED)&lt;/denchmark-h&gt;
 
 Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):
 Code
 import time
 import pprint
 
 import ray
 from ray import serve
 from ray.serve.constants import SERVE_MASTER_NAME
 from ray.serve.metric import MetricClient, PrometheusExporter
 
 serve.init(metric_exporter=PrometheusExporter)
 
 @ray.remote
 class AsyncActor:
     async def run(self, key):
         actor = ray.get_actor(SERVE_MASTER_NAME)
         [metric_exporter] = ray.get(actor.get_metric_exporter.remote())
         client = MetricClient(metric_exporter, default_labels={"key": key})
         counter = client.new_counter("same_name")
         for _ in range(10):
             counter.add()
             await client._push_to_exporter_once()
 
 a = AsyncActor.remote()
 b = AsyncActor.remote()
 ray.get([a.run.remote("a"), b.run.remote("b")])
 
 print(serve.stat().decode())
 Output
 &lt;denchmark-code&gt;2020-06-04 12:07:19,281	INFO resource_spec.py:212 -- Starting Ray with 21.97 GiB memory available for workers and up to 10.99 GiB for objects. You can adjust these settings with ray.init(memory=&lt;bytes&gt;, object_store_memory=&lt;bytes&gt;).
 2020-06-04 12:07:19,500	WARNING services.py:923 -- Redis failed to start, retrying now.
 2020-06-04 12:07:19,740	INFO services.py:1165 -- View the Ray dashboard at localhost:8265
 (pid=61255) 2020-06-04 12:07:21,622	INFO master.py:182 -- Starting metric exporter with name 'SERVE_METRIC_SINK_ACTOR'
 (pid=61255) 2020-06-04 12:07:21,636	INFO master.py:130 -- Starting router with name 'SERVE_ROUTER_ACTOR'
 (pid=61255) 2020-06-04 12:07:21,644	INFO master.py:152 -- Starting HTTP proxy with name 'SERVE_PROXY_ACTOR' on node 'node:192.168.31.141'
 (pid=61267) INFO:     Started server process [61267]
 (pid=61267) INFO:     Waiting for application startup.
 (pid=61267) INFO:     Application startup complete.
 # HELP same_name_total
 # TYPE same_name_total counter
 same_name_total{key="a"} 20.0
 # TYPE same_name_created gauge
 same_name_created{key="a"} 1.591297642889063e+09
 &lt;/denchmark-code&gt;
 
 Expected:
 &lt;denchmark-code&gt;same_name_total{key="a"} 10.0
 ...
 same_name_total{key="b"} 10.0
 &lt;/denchmark-code&gt;
 
 If we cannot run your script, we cannot fix your issue.
 
  I have verified my script runs in a clean environment and reproduces the issue.
  I have verified the issue also occurs with the latest wheels.
 
 	</description>
 	<comments>
 	</comments>
 </bug>
<commit id='a25472c657d6e3338c396d4261c30a060d608274' author='Simon Mo' date='2020-07-02 11:40:14-07:00'>
 	<dmm_unit complexity='0.5882352941176471' interfacing='0.5294117647058824' size='1.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='python\ray\serve\metric\client.py' new_name='python\ray\serve\metric\client.py'>
 		<file_info nloc='113' complexity='8' token_count='473'></file_info>
 		<modified_lines>
 			<added_lines>2,4,5,29,30,112,113,114,115,116,117,118,121</added_lines>
 			<deleted_lines>2,4,5,6,7,8,32,33,104,105,106,107,121,123</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\serve\metric\exporter.py' new_name='python\ray\serve\metric\exporter.py'>
 		<file_info nloc='117' complexity='21' token_count='821'></file_info>
 		<method name='_process_batch' parameters='self,metric_metadata,batch'>
 				<method_info nloc='15' complexity='5' token_count='110' nesting_level='1' start_line='142' end_line='157'></method_info>
 			<added_lines>142,143,144,145,146,147,149</added_lines>
 			<deleted_lines>142</deleted_lines>
 		</method>
 		<method name='ingest' parameters='self,str,MetricBatch'>
 				<method_info nloc='2' complexity='1' token_count='18' nesting_level='1' start_line='57' end_line='58'></method_info>
 			<added_lines>57</added_lines>
 			<deleted_lines>57</deleted_lines>
 		</method>
 		<method name='inspect_metrics' parameters='self'>
 				<method_info nloc='7' complexity='2' token_count='71' nesting_level='1' start_line='86' end_line='94'></method_info>
 			<added_lines>92,93</added_lines>
 			<deleted_lines>91</deleted_lines>
 		</method>
 		<method name='export' parameters='self,int,MetricBatch'>
 				<method_info nloc='2' complexity='1' token_count='18' nesting_level='1' start_line='73' end_line='74'></method_info>
 			<added_lines>73,74</added_lines>
 			<deleted_lines>73</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,ExporterInterface'>
 				<method_info nloc='5' complexity='1' token_count='46' nesting_level='1' start_line='45' end_line='55'></method_info>
 			<added_lines>49,52</added_lines>
 			<deleted_lines>49,52</deleted_lines>
 		</method>
 		<method name='_process_batch' parameters='self,batch'>
 				<method_info nloc='14' complexity='4' token_count='108' nesting_level='1' start_line='137' end_line='150'></method_info>
 			<added_lines>140,141,142,143,144,145,146,147,149</added_lines>
 			<deleted_lines>137,138,139,140,142</deleted_lines>
 		</method>
 		<method name='_process_metric_metadata' parameters='self,metric_metadata'>
 				<method_info nloc='18' complexity='3' token_count='105' nesting_level='1' start_line='119' end_line='140'></method_info>
 			<added_lines>120,121,122,131,140</added_lines>
 			<deleted_lines>127,135,137,138,139,140</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self'>
 				<method_info nloc='12' complexity='1' token_count='74' nesting_level='1' start_line='98' end_line='110'></method_info>
 			<added_lines>108</added_lines>
 			<deleted_lines>106</deleted_lines>
 		</method>
 		<method name='export' parameters='self,metric_metadata,metric_batch'>
 				<method_info nloc='3' complexity='1' token_count='23' nesting_level='1' start_line='115' end_line='117'></method_info>
 			<added_lines>117</added_lines>
 			<deleted_lines>115</deleted_lines>
 		</method>
 		<method name='ingest' parameters='self,int,MetricBatch'>
 				<method_info nloc='2' complexity='1' token_count='18' nesting_level='1' start_line='57' end_line='58'></method_info>
 			<added_lines>57</added_lines>
 			<deleted_lines>57</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>1,76</added_lines>
 			<deleted_lines>1,75,118</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\serve\metric\types.py' new_name='python\ray\serve\metric\types.py'>
 		<file_info nloc='68' complexity='19' token_count='522'></file_info>
 		<method name='__hash__' parameters='self'>
 				<method_info nloc='3' complexity='1' token_count='37' nesting_level='1' start_line='32' end_line='34'></method_info>
 			<added_lines>32,33,34</added_lines>
 			<deleted_lines>33</deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,client,str,str,None'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='1' start_line='16' end_line='20'></method_info>
 			<added_lines>16,17,18,19,20</added_lines>
 			<deleted_lines>18</deleted_lines>
 		</method>
 		<method name='add' parameters='self,increment'>
 				<method_info nloc='4' complexity='1' token_count='36' nesting_level='1' start_line='92' end_line='96'></method_info>
 			<added_lines>96</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,str,MetricType,str,str'>
 				<method_info nloc='2' complexity='1' token_count='33' nesting_level='1' start_line='15' end_line='16'></method_info>
 			<added_lines>15,16</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__init__' parameters='self,client,int,str,None'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='1' start_line='42' end_line='46'></method_info>
 			<added_lines>44</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='record' parameters='self,value'>
 				<method_info nloc='4' complexity='1' token_count='34' nesting_level='1' start_line='100' end_line='104'></method_info>
 			<added_lines>104</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='__eq__' parameters='self'>
 				<method_info nloc='7' complexity='6' token_count='62' nesting_level='1' start_line='23' end_line='30'></method_info>
 			<added_lines>23,24,25,26,27,28,29,30</added_lines>
 			<deleted_lines>25</deleted_lines>
 		</method>
 		<method name='labels' parameters='self,kwargs'>
 				<method_info nloc='11' complexity='3' token_count='81' nesting_level='1' start_line='69' end_line='86'></method_info>
 			<added_lines>85</added_lines>
 			<deleted_lines>70,78,79,80,81,82,83</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>5,6,7,8,9,10,14,21,22,31,35,36,37,51,59</added_lines>
 			<deleted_lines>8,9,10,11,59</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\serve\tests\test_metric.py' new_name='python\ray\serve\tests\test_metric.py'>
 		<file_info nloc='172' complexity='20' token_count='1119'></file_info>
 		<method name='test_prometheus_conflicting_labels' parameters='serve_instance'>
 				<method_info nloc='14' complexity='3' token_count='109' nesting_level='0' start_line='143' end_line='160'></method_info>
 			<added_lines>143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='test_client' parameters=''>
 				<method_info nloc='35' complexity='3' token_count='284' nesting_level='0' start_line='29' end_line='71'></method_info>
 			<added_lines>49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71</added_lines>
 			<deleted_lines>49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>161,162</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
