<bug_data>
<bug id='6169' author='virtualluke' open_date='2019-11-15T19:29:20Z' closed_time='2019-11-25T16:11:57Z'>
 	<summary>workers dying in redis_context.cc</summary>
 	<description>
 &lt;denchmark-h:h3&gt;System information&lt;/denchmark-h&gt;
 
 
 OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Redhat 7.6
 Ray installed from (source or binary): binary
 Ray version: 0.8.0dev6 (last commit 8ff393a)
 Python version: 3.7.5
 Exact command to reproduce:
 
 &lt;denchmark-h:h3&gt;Describe the problem&lt;/denchmark-h&gt;
 
 I am seeing workers dying (infrequently but often enough) with logs like the below.
 &lt;denchmark-h:h3&gt;Source code / logs&lt;/denchmark-h&gt;
 
 &lt;denchmark-code&gt;2019-11-15 13:44:10,711 WARNING worker.py:1037 -- A worker died or was killed while executing task e36ba8830369ffffffff01000000.
 2019-11-15 13:44:13,899 WARNING worker.py:1037 -- A worker died or was killed while executing task 003e8a4c5672ffffffff01000000.
 2019-11-15 13:44:15,736 WARNING worker.py:1037 -- A worker died or was killed while executing task 55310ff8d7c0ffffffff01000000.
 2019-11-15 13:44:17,359 WARNING worker.py:1037 -- A worker died or was killed while executing task 2fd423cb8a75ffffffff01000000.
 2019-11-15 13:44:17,741 WARNING worker.py:1037 -- A worker died or was killed while executing task 361d66d76ed7ffffffff01000000.
 (pid=194534, ip=10.10.10.123) F1115 13:44:10.645040 201070 redis_context.cc:147]  Check failed: callback_items_.find(callback_index) != callback_items_.end()
 (pid=194534, ip=10.10.10.123) *** Check failure stack trace: ***
 (pid=194534, ip=10.10.10.123)     @     0x7fbed39f148d  google::LogMessage::Fail()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed39f31ac  google::LogMessage::SendToLog()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed39f0fe9  google::LogMessage::Flush()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed39f1201  google::LogMessage::~LogMessage()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed37383b9  ray::RayLog::~RayLog()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed36e5591  ray::gcs::RedisCallbackManager::get()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed36e56bd  ray::gcs::GlobalRedisCallback()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed36eb3da  redisProcessCallbacks
 (pid=194534, ip=10.10.10.123)     @     0x7fbed36e9f88  RedisAsioClient::handle_read()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed36e8967  boost::asio::detail::reactive_null_buffers_op&lt;&gt;::do_complete()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed3647345  boost::asio::detail::scheduler::run()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed364ae53  ray::CoreWorker::RunIOService()
 (pid=194534, ip=10.10.10.123)     @     0x7fbed3218678  execute_native_thread_routine_compat
 (pid=194534, ip=10.10.10.123)     @     0x7fbedb05eea5  start_thread
 (pid=194534, ip=10.10.10.123)     @     0x7fbedad878cd  __clone
 ...
 &lt;/denchmark-code&gt;
 
 ...
 	</description>
 	<comments>
 		<comment id='1' author='virtualluke' date='2019-11-20T18:22:16Z'>
 		&lt;denchmark-link:https://github.com/virtualluke&gt;@virtualluke&lt;/denchmark-link&gt;
  &lt;denchmark-link:https://github.com/ray-project/ray/pull/5946&gt;#5946&lt;/denchmark-link&gt;
  merged above should hopefully address your issue. Please let me know once you've have a chance to test it out.
 		</comment>
 		<comment id='2' author='virtualluke' date='2019-11-20T18:28:17Z'>
 		Will pull it down in a few hours (if whl has dropped)  and do some testing after that.  thanks!
 		</comment>
 		<comment id='3' author='virtualluke' date='2019-11-21T05:32:33Z'>
 		Issue still there
 		</comment>
 	</comments>
 </bug>
<commit id='ae5abc48a96a849b1b9acec665bd0aa74fe49591' author='Edward Oakes' date='2019-11-22 15:51:40-08:00'>
 	<dmm_unit complexity='0.0' interfacing='0.2' size='0.06666666666666667'></dmm_unit>
 	<modification change_type='MODIFY' old_name='src\ray\gcs\redis_async_context.cc' new_name='src\ray\gcs\redis_async_context.cc'>
 		<file_info nloc='64' complexity='11' token_count='351'></file_info>
 		<method name='ray::gcs::RedisAsyncContext::RedisAsyncHandleRead' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='25' nesting_level='2' start_line='33' end_line='41'></method_info>
 			<added_lines>34,35,36,37,38,39</added_lines>
 			<deleted_lines>34</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\gcs\redis_context.cc' new_name='src\ray\gcs\redis_context.cc'>
 		<file_info nloc='240' complexity='43' token_count='1727'></file_info>
 		<method name='ray::gcs::CallbackReply::IsNil' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='13' nesting_level='2' start_line='100' end_line='100'></method_info>
 			<added_lines>100</added_lines>
 			<deleted_lines>100</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::ReadAsStatus' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='24' nesting_level='2' start_line='107' end_line='110'></method_info>
 			<added_lines>108,109</added_lines>
 			<deleted_lines>107,108,109,110</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisCallbackManager::add' parameters='function,is_subscription,io_service'>
 				<method_info nloc='9' complexity='1' token_count='73' nesting_level='2' start_line='134' end_line='143'></method_info>
 			<added_lines>134,135,139,140,141</added_lines>
 			<deleted_lines>136,140,141</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::CallbackReply' parameters='redis_reply'>
 				<method_info nloc='44' complexity='10' token_count='271' nesting_level='2' start_line='49' end_line='98'></method_info>
 			<added_lines>49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97</added_lines>
 			<deleted_lines>49,51,52,53,56,59,60,61,62,63,64,65,66,67,71,72,73,74,75,76,77,78,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::ReadAsString' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='24' nesting_level='2' start_line='112' end_line='115'></method_info>
 			<added_lines>112,113,114</added_lines>
 			<deleted_lines>112,113,114,115</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisCallbackManager::add' parameters='function,is_subscription'>
 				<method_info nloc='7' complexity='1' token_count='58' nesting_level='2' start_line='136' end_line='143'></method_info>
 			<added_lines>139,140,141</added_lines>
 			<deleted_lines>136,140,141</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisCallbackManager::get' parameters='callback_index'>
 				<method_info nloc='6' complexity='1' token_count='44' nesting_level='2' start_line='145' end_line='150'></method_info>
 			<added_lines>145,146</added_lines>
 			<deleted_lines>145</deleted_lines>
 		</method>
 		<method name='ProcessCallback' parameters='callback_index,callback_reply'>
 				<method_info nloc='14' complexity='3' token_count='121' nesting_level='1' start_line='23' end_line='41'></method_info>
 			<added_lines>24,28,31,33,34,35,36,37</added_lines>
 			<deleted_lines>24,28,31,33,34,35,36,37</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::ReadAsStringArray' parameters='array'>
 				<method_info nloc='17' complexity='4' token_count='174' nesting_level='2' start_line='104' end_line='122'></method_info>
 			<added_lines>104,108,109,112,113,114,117,118,119</added_lines>
 			<deleted_lines>104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121</deleted_lines>
 		</method>
 		<method name='ProcessCallback' parameters='callback_index,callback_reply'>
 				<method_info nloc='16' complexity='4' token_count='128' nesting_level='1' start_line='23' end_line='41'></method_info>
 			<added_lines>24,28,31,33,34,35,36,37</added_lines>
 			<deleted_lines>24,28,31,33,34,35,36,37</deleted_lines>
 		</method>
 		<method name='ray::gcs::GlobalRedisCallback' parameters='c,r,privdata'>
 				<method_info nloc='8' complexity='2' token_count='65' nesting_level='2' start_line='125' end_line='132'></method_info>
 			<added_lines>131</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisContext::SubscribeAsync' parameters='client_id,pubsub_channel,redisCallback,out_callback_index'>
 				<method_info nloc='26' complexity='2' token_count='190' nesting_level='2' start_line='276' end_line='305'></method_info>
 			<added_lines>284,285</added_lines>
 			<deleted_lines>283</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::ReadAsInteger' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='24' nesting_level='2' start_line='102' end_line='105'></method_info>
 			<added_lines>103,104</added_lines>
 			<deleted_lines>104,105</deleted_lines>
 		</method>
 		<method name='ray::gcs::CallbackReply::ReadAsPubsubData' parameters=''>
 				<method_info nloc='4' complexity='1' token_count='24' nesting_level='2' start_line='117' end_line='120'></method_info>
 			<added_lines>117,118,119</added_lines>
 			<deleted_lines>117,118,119,120</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>99,101,133</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\gcs\redis_context.h' new_name='src\ray\gcs\redis_context.h'>
 		<file_info nloc='143' complexity='13' token_count='912'></file_info>
 		<method name='ray::gcs::RedisCallbackManager::CallbackItem::CallbackItem' parameters='callback,is_subscription,start_time'>
 				<method_info nloc='6' complexity='1' token_count='33' nesting_level='4' start_line='82' end_line='87'></method_info>
 			<added_lines>86</added_lines>
 			<deleted_lines>82,83,84,85,86</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisContext::RedisContext' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='10' nesting_level='3' start_line='114' end_line='114'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>114</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisContext::RedisContext' parameters='io_service'>
 				<method_info nloc='2' complexity='1' token_count='22' nesting_level='3' start_line='130' end_line='131'></method_info>
 			<added_lines>130,131</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisCallbackManager::CallbackItem::Dispatch' parameters='reply'>
 				<method_info nloc='6' complexity='2' token_count='60' nesting_level='4' start_line='96' end_line='101'></method_info>
 			<added_lines>96,97,98,99,100</added_lines>
 			<deleted_lines>96</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisCallbackManager::CallbackItem::CallbackItem' parameters='callback,is_subscription,start_time,io_service'>
 				<method_info nloc='6' complexity='1' token_count='43' nesting_level='4' start_line='89' end_line='94'></method_info>
 			<added_lines>89,90,91,92,93,94</added_lines>
 			<deleted_lines>89,90,91,94</deleted_lines>
 		</method>
 		<method name='ray::gcs::RedisContext::RunAsync' parameters='command,id,data,length,prefix,pubsub_channel,redisCallback,log_length'>
 				<method_info nloc='32' complexity='3' token_count='286' nesting_level='2' start_line='197' end_line='228'></method_info>
 			<added_lines>202,203</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>4,5,46,47,48,55,59,60,61,62,63,64,65,66,67,68,69,70,75,95,103,104,105,106,109,110,112,125,190</added_lines>
 			<deleted_lines>50,51,52,53,56,57,58,59,60,61,63,68,79,109,184</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\gcs\redis_gcs_client.cc' new_name='src\ray\gcs\redis_gcs_client.cc'>
 		<file_info nloc='163' complexity='30' token_count='1377'></file_info>
 		<method name='ray::gcs::RedisGcsClient::Connect' parameters='io_service'>
 				<method_info nloc='51' complexity='5' token_count='512' nesting_level='2' start_line='78' end_line='149'></method_info>
 			<added_lines>86,106,111</added_lines>
 			<deleted_lines>86,106,111</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\gcs\tables.cc' new_name='src\ray\gcs\tables.cc'>
 		<file_info nloc='656' complexity='109' token_count='5543'></file_info>
 		<method name='ray::gcs::Hash&lt;ID,Data&gt;::RemoveEntries' parameters='job_id,id,keys,remove_callback'>
 				<method_info nloc='20' complexity='3' token_count='172' nesting_level='2' start_line='375' end_line='394'></method_info>
 			<added_lines>379,380</added_lines>
 			<deleted_lines>379</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::AppendAt' parameters='job_id,id,data,done,failure,log_length'>
 				<method_info nloc='22' complexity='4' token_count='188' nesting_level='2' start_line='63' end_line='84'></method_info>
 			<added_lines>68,69</added_lines>
 			<deleted_lines>68,69</deleted_lines>
 		</method>
 		<method name='ray::gcs::Hash&lt;ID,Data&gt;::Subscribe' parameters='job_id,client_id,subscribe,done'>
 				<method_info nloc='41' complexity='8' token_count='323' nesting_level='2' start_line='433' end_line='478'></method_info>
 			<added_lines>438,439</added_lines>
 			<deleted_lines>437,438</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::CancelNotifications' parameters='job_id,id,client_id,done'>
 				<method_info nloc='16' complexity='2' token_count='117' nesting_level='2' start_line='187' end_line='204'></method_info>
 			<added_lines>195,196</added_lines>
 			<deleted_lines>195,196</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::Lookup' parameters='job_id,id,lookup'>
 				<method_info nloc='22' complexity='4' token_count='208' nesting_level='2' start_line='87' end_line='108'></method_info>
 			<added_lines>89,92,94</added_lines>
 			<deleted_lines>89,92,94</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::Subscribe' parameters='job_id,client_id,subscribe,done'>
 				<method_info nloc='33' complexity='6' token_count='240' nesting_level='2' start_line='124' end_line='162'></method_info>
 			<added_lines>129,130</added_lines>
 			<deleted_lines>129,130</deleted_lines>
 		</method>
 		<method name='ray::gcs::Table&lt;ID,Data&gt;::Add' parameters='job_id,id,data,done'>
 				<method_info nloc='14' complexity='2' token_count='133' nesting_level='2' start_line='253' end_line='266'></method_info>
 			<added_lines>257</added_lines>
 			<deleted_lines>257</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::RequestNotifications' parameters='job_id,id,client_id,done'>
 				<method_info nloc='18' complexity='3' token_count='130' nesting_level='2' start_line='165' end_line='184'></method_info>
 			<added_lines>173,174</added_lines>
 			<deleted_lines>173,174</deleted_lines>
 		</method>
 		<method name='ray::gcs::Set&lt;ID,Data&gt;::Add' parameters='job_id,id,data,done'>
 				<method_info nloc='12' complexity='2' token_count='130' nesting_level='2' start_line='317' end_line='328'></method_info>
 			<added_lines>320</added_lines>
 			<deleted_lines>320</deleted_lines>
 		</method>
 		<method name='ray::gcs::Set&lt;ID,Data&gt;::Remove' parameters='job_id,id,data,done'>
 				<method_info nloc='13' complexity='2' token_count='130' nesting_level='2' start_line='331' end_line='343'></method_info>
 			<added_lines>335</added_lines>
 			<deleted_lines>335</deleted_lines>
 		</method>
 		<method name='ray::gcs::Hash&lt;ID,Data&gt;::Lookup' parameters='job_id,id,lookup'>
 				<method_info nloc='26' complexity='4' token_count='253' nesting_level='2' start_line='405' end_line='430'></method_info>
 			<added_lines>408,411,412,414</added_lines>
 			<deleted_lines>407,410,411,413</deleted_lines>
 		</method>
 		<method name='ray::gcs::Log&lt;ID,Data&gt;::Append' parameters='job_id,id,data,done'>
 				<method_info nloc='17' complexity='2' token_count='162' nesting_level='2' start_line='43' end_line='60'></method_info>
 			<added_lines>47,48</added_lines>
 			<deleted_lines>47,48</deleted_lines>
 		</method>
 		<method name='ray::gcs::Hash&lt;ID,Data&gt;::Update' parameters='job_id,id,data_map,done'>
 				<method_info nloc='19' complexity='3' token_count='180' nesting_level='2' start_line='354' end_line='372'></method_info>
 			<added_lines>357</added_lines>
 			<deleted_lines>357</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
