<bug_data>
<bug id='12937' author='rkooo567' open_date='2020-12-17T08:11:10Z' closed_time='2020-12-19T00:00:55Z'>
 	<summary>[Core][New Scheduler] Actors borrowing CPUs infinitely.</summary>
 	<description>
 &lt;denchmark-h:h3&gt;What is the problem?&lt;/denchmark-h&gt;
 
     ray.init(
         num_cpus=1,
         _system_config={
             "debug_dump_period_milliseconds": 500
         })
     @ray.remote(num_cpus=1)
     class Foo:
         def f(self):
             return 0
     @ray.remote
     def f():
         # Creating both actors is not possible.
         actors = [Foo.remote() for _ in range(3)]
         for a in actors:
             ray.get(a.f.remote())
     # Run in a task to check we handle the blocked task case correctly
     f.remote()
 This job is supposed to be hanging because worker can borrow cpu to an actor once (and the subsequent actor creation cannot borrow a cpu anymore), but it seems like it succeeds when I ran this script.
 It fails (which is the expected behavior) when I run it with the old scheduler.
 But when we run it with only tasks, it works for both cases (which is the expected behavior)
     ray.init(
         num_cpus=1,
         _system_config={
             "debug_dump_period_milliseconds": 100000
         })
 
     @ray.remote(num_cpus=1)
     def g():
         time.sleep(2)
         return 0
 
     @ray.remote
     def f():
         for _ in range(2):
             ray.get(g.remote())
 
     ray.get(f.remote(), timeout=5)
 &lt;denchmark-h:h3&gt;Reproduction (REQUIRED)&lt;/denchmark-h&gt;
 
 Please provide a short code snippet (less than 50 lines if possible) that can be copy-pasted to reproduce the issue. The snippet should have no external library dependencies (i.e., use fake or mock data / environments):
 If the code snippet cannot be run by itself, the issue will be closed with "needs-repro-script".
 
  I have verified my script runs in a clean environment and reproduces the issue.
  I have verified the issue also occurs with the latest wheels.
 
 	</description>
 	<comments>
 	</comments>
 </bug>
<commit id='6ece291f352e1531f29fa8573e21aa47f290b485' author='Eric Liang' date='2020-12-18 16:00:54-08:00'>
 	<dmm_unit complexity='None' interfacing='None' size='None'></dmm_unit>
 	<modification change_type='MODIFY' old_name='python\ray\tests\test_failure.py' new_name='python\ray\tests\test_failure.py'>
 		<file_info nloc='952' complexity='163' token_count='6711'></file_info>
 		<modified_lines>
 			<added_lines>20</added_lines>
 			<deleted_lines>20,21,636,637</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\tests\test_gcs_fault_tolerance.py' new_name='python\ray\tests\test_gcs_fault_tolerance.py'>
 		<file_info nloc='115' complexity='15' token_count='730'></file_info>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>9,24</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\tests\test_global_state.py' new_name='python\ray\tests\test_global_state.py'>
 		<file_info nloc='249' complexity='48' token_count='1618'></file_info>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>11,220,221</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='python\ray\tests\test_reference_counting.py' new_name='python\ray\tests\test_reference_counting.py'>
 		<file_info nloc='376' complexity='60' token_count='3069'></file_info>
 		<modified_lines>
 			<added_lines>170</added_lines>
 			<deleted_lines>170</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\node_manager.cc' new_name='src\ray\raylet\node_manager.cc'>
 		<file_info nloc='2418' complexity='432' token_count='18551'></file_info>
 		<method name='ray::raylet::NodeManager::HandleDirectCallTaskBlocked' parameters='worker'>
 				<method_info nloc='30' complexity='10' token_count='213' nesting_level='2' start_line='2150' end_line='2181'></method_info>
 			<added_lines>2161,2163,2164,2165</added_lines>
 			<deleted_lines>2161,2163</deleted_lines>
 		</method>
 		<method name='ray::raylet::NodeManager::HandleDirectCallTaskUnblocked' parameters='worker'>
 				<method_info nloc='41' complexity='10' token_count='266' nesting_level='2' start_line='2183' end_line='2239'></method_info>
 			<added_lines>2204,2205,2206,2207,2208</added_lines>
 			<deleted_lines>2202,2203,2204</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\scheduling\cluster_resource_scheduler.cc' new_name='src\ray\raylet\scheduling\cluster_resource_scheduler.cc'>
 		<file_info nloc='794' complexity='190' token_count='5767'></file_info>
 		<method name='ray::ClusterResourceScheduler::SubtractAvailableResourceInstances' parameters='available,resource_instances,allow_going_negative'>
 				<method_info nloc='23' complexity='6' token_count='190' nesting_level='1' start_line='567' end_line='590'></method_info>
 			<added_lines>568,569,575,576,577,578,579,580,581,582,583,584,585,586</added_lines>
 			<deleted_lines>568,573,575,576</deleted_lines>
 		</method>
 		<method name='ray::ClusterResourceScheduler::SubtractCPUResourceInstances' parameters='cpu_instances,allow_going_negative'>
 				<method_info nloc='14' complexity='2' token_count='90' nesting_level='1' start_line='789' end_line='805'></method_info>
 			<added_lines>790,800,801</added_lines>
 			<deleted_lines>790</deleted_lines>
 		</method>
 		<method name='ray::ClusterResourceScheduler::SubtractCPUResourceInstances' parameters='cpu_instances'>
 				<method_info nloc='13' complexity='2' token_count='85' nesting_level='1' start_line='779' end_line='794'></method_info>
 			<added_lines>790</added_lines>
 			<deleted_lines>780,790</deleted_lines>
 		</method>
 		<method name='ray::ClusterResourceScheduler::SubtractAvailableResourceInstances' parameters='available,resource_instances'>
 				<method_info nloc='13' complexity='3' token_count='130' nesting_level='1' start_line='567' end_line='580'></method_info>
 			<added_lines>568,569,575,576,577,578,579,580</added_lines>
 			<deleted_lines>568,573,575,576</deleted_lines>
 		</method>
 		<method name='ray::ClusterResourceScheduler::FillResourceUsage' parameters='light_report_resource_usage_enabled,resources_data'>
 				<method_info nloc='76' complexity='20' token_count='626' nesting_level='1' start_line='899' end_line='987'></method_info>
 			<added_lines>930,931,946,947,963,964,977,978</added_lines>
 			<deleted_lines>919,934,950,963</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\scheduling\cluster_resource_scheduler.h' new_name='src\ray\raylet\scheduling\cluster_resource_scheduler.h'>
 		<file_info nloc='104' complexity='6' token_count='817'></file_info>
 		<modified_lines>
 			<added_lines>282,287,288,301,305,306</added_lines>
 			<deleted_lines>286,302</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\scheduling\cluster_task_manager.cc' new_name='src\ray\raylet\scheduling\cluster_task_manager.cc'>
 		<file_info nloc='562' complexity='98' token_count='4263'></file_info>
 		<method name='ray::raylet::ClusterTaskManager::TasksUnblocked' parameters='ready_ids'>
 				<method_info nloc='14' complexity='3' token_count='121' nesting_level='2' start_line='237' end_line='250'></method_info>
 			<added_lines>246</added_lines>
 			<deleted_lines>245,246,247,248</deleted_lines>
 		</method>
 		<method name='ray::raylet::ClusterTaskManager::AnyPendingTasks' parameters='exemplar,any_pending,num_pending_actor_creation,num_pending_tasks'>
 				<method_info nloc='20' complexity='5' token_count='124' nesting_level='2' start_line='504' end_line='528'></method_info>
 			<added_lines>508,509,510</added_lines>
 			<deleted_lines>510,511,512</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>4</added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\scheduling\cluster_task_manager.h' new_name='src\ray\raylet\scheduling\cluster_task_manager.h'>
 		<file_info nloc='66' complexity='0' token_count='528'></file_info>
 		<modified_lines>
 			<added_lines>160,164</added_lines>
 			<deleted_lines>160,164</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\test\util.h' new_name='src\ray\raylet\test\util.h'>
 		<file_info nloc='156' complexity='51' token_count='997'></file_info>
 		<method name='ray::raylet::MockWorker::GetBorrowedCPUInstances' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='8' nesting_level='3' start_line='175' end_line='175'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>175</deleted_lines>
 		</method>
 		<method name='ray::raylet::MockWorker::ClearBorrowedCPUInstances' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='13' nesting_level='3' start_line='177' end_line='177'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>177</deleted_lines>
 		</method>
 		<method name='ray::raylet::MockWorker::SetBorrowedCPUInstances' parameters='cpu_instances'>
 				<method_info nloc='3' complexity='1' token_count='17' nesting_level='3' start_line='164' end_line='166'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>164,165,166</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>167,176,178</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\worker.h' new_name='src\ray\raylet\worker.h'>
 		<file_info nloc='164' complexity='12' token_count='1175'></file_info>
 		<method name='ray::raylet::Worker::ClearBorrowedCPUInstances' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='12' nesting_level='3' start_line='205' end_line='205'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>205</deleted_lines>
 		</method>
 		<method name='ray::raylet::Worker::GetBorrowedCPUInstances' parameters=''>
 				<method_info nloc='1' complexity='1' token_count='8' nesting_level='3' start_line='203' end_line='203'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>203</deleted_lines>
 		</method>
 		<method name='ray::raylet::Worker::SetBorrowedCPUInstances' parameters='cpu_instances'>
 				<method_info nloc='3' complexity='1' token_count='17' nesting_level='3' start_line='199' end_line='201'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>199,200,201</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>101,102,103,104,105,106,202,204,206,276,277,278,279,280,281,282,283</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\raylet\worker_pool.cc' new_name='src\ray\raylet\worker_pool.cc'>
 		<file_info nloc='850' complexity='194' token_count='6152'></file_info>
 		<method name='ray::raylet::WorkerPool::WarnAboutSize' parameters=''>
 				<method_info nloc='26' complexity='5' token_count='169' nesting_level='2' start_line='958' end_line='985'></method_info>
 			<added_lines>959,960</added_lines>
 			<deleted_lines>959,960</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
