<bug_data>
<bug id='7543' author='simon-mo' open_date='2020-03-10T16:52:18Z' closed_time='2020-03-10T23:27:03Z'>
 	<summary>Idle ray worker uses too much memory</summary>
 	<description>
 It turns out each ServerCall objects are pre-created given the max concurrency. So declarations like
 &lt;denchmark-code&gt;RPC_SERVICE_HANDLER(CoreWorkerService, GetCoreWorkerStats, 9999)
 &lt;/denchmark-code&gt;
 
 will create 9999 ServerCall objects. This increase the memory consumptions in each workers.
 We actually don't need to create so many server calls since the calls are only used for "accepting" the request instead of of "handling" them.
 	</description>
 	<comments>
 	</comments>
 </bug>
<commit id='119a303ea04893c0f7f898c6b29d8d89d51c6424' author='Edward Oakes' date='2020-03-10 16:27:02-07:00'>
 	<dmm_unit complexity='0.0' interfacing='0.0' size='0.0'></dmm_unit>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\gcs_server\gcs_rpc_server.h' new_name='src\ray\rpc\gcs_server\gcs_rpc_server.h'>
 		<file_info nloc='272' complexity='24' token_count='1582'></file_info>
 		<method name='ray::rpc::StatsGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='36' nesting_level='3' start_line='338' end_line='342'></method_info>
 			<added_lines>340,341</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::rpc::ErrorInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='45' nesting_level='3' start_line='382' end_line='387'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>384,385,386</deleted_lines>
 		</method>
 		<method name='ray::rpc::WorkerInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='36' nesting_level='3' start_line='408' end_line='412'></method_info>
 			<added_lines>410,411</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::rpc::TaskInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='9' complexity='1' token_count='56' nesting_level='3' start_line='299' end_line='307'></method_info>
 			<added_lines>301,302,303,304,305,306</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::rpc::ObjectInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='7' complexity='1' token_count='46' nesting_level='3' start_line='248' end_line='254'></method_info>
 			<added_lines>250,251,252,253</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::rpc::JobInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='6' complexity='1' token_count='41' nesting_level='3' start_line='74' end_line='79'></method_info>
 			<added_lines>76,77,78</added_lines>
 			<deleted_lines>79</deleted_lines>
 		</method>
 		<method name='ray::rpc::ObjectInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='8' complexity='1' token_count='59' nesting_level='3' start_line='254' end_line='261'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>256,257,258,259,260</deleted_lines>
 		</method>
 		<method name='ray::rpc::StatsGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='45' nesting_level='3' start_line='346' end_line='351'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>348,349,350</deleted_lines>
 		</method>
 		<method name='ray::rpc::NodeInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='13' complexity='1' token_count='94' nesting_level='3' start_line='203' end_line='215'></method_info>
 			<added_lines>203,204,205,206,207,208</added_lines>
 			<deleted_lines>205,206,207,208,209,210,211,212,213,214</deleted_lines>
 		</method>
 		<method name='ray::rpc::ActorInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='10' complexity='1' token_count='61' nesting_level='3' start_line='130' end_line='139'></method_info>
 			<added_lines>132,133,134,135,136,137,138</added_lines>
 			<deleted_lines>136,137,138,139</deleted_lines>
 		</method>
 		<method name='ray::rpc::WorkerInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='45' nesting_level='3' start_line='418' end_line='423'></method_info>
 			<added_lines></added_lines>
 			<deleted_lines>420,421,422</deleted_lines>
 		</method>
 		<method name='ray::rpc::NodeInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='12' complexity='1' token_count='71' nesting_level='3' start_line='198' end_line='209'></method_info>
 			<added_lines>200,201,202,203,204,205,206,207,208</added_lines>
 			<deleted_lines>205,206,207,208,209</deleted_lines>
 		</method>
 		<method name='ray::rpc::ActorInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='11' complexity='1' token_count='80' nesting_level='3' start_line='134' end_line='144'></method_info>
 			<added_lines>134,135,136,137,138</added_lines>
 			<deleted_lines>136,137,138,139,140,141,142,143</deleted_lines>
 		</method>
 		<method name='ray::rpc::JobInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='7' complexity='1' token_count='52' nesting_level='3' start_line='77' end_line='83'></method_info>
 			<added_lines>77,78</added_lines>
 			<deleted_lines>79,80,81,82</deleted_lines>
 		</method>
 		<method name='ray::rpc::ErrorInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='36' nesting_level='3' start_line='373' end_line='377'></method_info>
 			<added_lines>375,376</added_lines>
 			<deleted_lines></deleted_lines>
 		</method>
 		<method name='ray::rpc::TaskInfoGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='10' complexity='1' token_count='73' nesting_level='3' start_line='306' end_line='315'></method_info>
 			<added_lines>306</added_lines>
 			<deleted_lines>308,309,310,311,312,313,314</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>26,27,29,30,32,33,35,36,38,39,41,43,44,46,47</added_lines>
 			<deleted_lines>26,27,29,30,32,33,35,36,38,39,41,42,44,45,47,48,49,50</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\grpc_server.cc' new_name='src\ray\rpc\grpc_server.cc'>
 		<file_info nloc='84' complexity='17' token_count='543'></file_info>
 		<method name='ray::rpc::GrpcServer::Run' parameters=''>
 				<method_info nloc='35' complexity='7' token_count='269' nesting_level='2' start_line='30' end_line='78'></method_info>
 			<added_lines>67,68,69</added_lines>
 			<deleted_lines>67,68,69,70</deleted_lines>
 		</method>
 		<method name='ray::rpc::GrpcServer::RegisterService' parameters='service'>
 				<method_info nloc='6' complexity='2' token_count='50' nesting_level='2' start_line='80' end_line='86'></method_info>
 			<added_lines>84</added_lines>
 			<deleted_lines>85</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines></deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\grpc_server.h' new_name='src\ray\rpc\grpc_server.h'>
 		<file_info nloc='56' complexity='7' token_count='329'></file_info>
 		<modified_lines>
 			<added_lines>30,36,111,112,149,153</added_lines>
 			<deleted_lines>30,36,37,112,113,114,115,152,156,157</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\node_manager\node_manager_server.h' new_name='src\ray\rpc\node_manager\node_manager_server.h'>
 		<file_info nloc='44' complexity='3' token_count='233'></file_info>
 		<method name='ray::rpc::NodeManagerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='39' nesting_level='3' start_line='87' end_line='92'></method_info>
 			<added_lines>89</added_lines>
 			<deleted_lines>89,90</deleted_lines>
 		</method>
 		<method name='ray::rpc::NodeManagerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='3' start_line='87' end_line='91'></method_info>
 			<added_lines>89</added_lines>
 			<deleted_lines>89,90</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>27,28,29,30,31,32,33</added_lines>
 			<deleted_lines>27,28,29,30,31,32,33</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\object_manager\object_manager_server.h' new_name='src\ray\rpc\object_manager\object_manager_server.h'>
 		<file_info nloc='34' complexity='3' token_count='176'></file_info>
 		<method name='ray::rpc::ObjectManagerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='3' start_line='68' end_line='72'></method_info>
 			<added_lines>70</added_lines>
 			<deleted_lines>70,71</deleted_lines>
 		</method>
 		<method name='ray::rpc::ObjectManagerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='39' nesting_level='3' start_line='68' end_line='73'></method_info>
 			<added_lines>70</added_lines>
 			<deleted_lines>70,71</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>27,28,29,30</added_lines>
 			<deleted_lines>27,28,29,30</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\server_call.h' new_name='src\ray\rpc\server_call.h'>
 		<file_info nloc='136' complexity='15' token_count='935'></file_info>
 		<method name='ray::rpc::ServerCallImpl::HandleRequestImpl' parameters=''>
 				<method_info nloc='13' complexity='1' token_count='90' nesting_level='3' start_line='151' end_line='174'></method_info>
 			<added_lines>156,157,158,159</added_lines>
 			<deleted_lines>172,173,174</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines></added_lines>
 			<deleted_lines>95,96</deleted_lines>
 		</modified_lines>
 	</modification>
 	<modification change_type='MODIFY' old_name='src\ray\rpc\worker\core_worker_server.h' new_name='src\ray\rpc\worker\core_worker_server.h'>
 		<file_info nloc='29' complexity='3' token_count='122'></file_info>
 		<method name='ray::rpc::CoreWorkerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories_and_concurrencies'>
 				<method_info nloc='6' complexity='1' token_count='39' nesting_level='3' start_line='85' end_line='90'></method_info>
 			<added_lines>87</added_lines>
 			<deleted_lines>87,88</deleted_lines>
 		</method>
 		<method name='ray::rpc::CoreWorkerGrpcService::InitServerCallFactories' parameters='cq,server_call_factories'>
 				<method_info nloc='5' complexity='1' token_count='32' nesting_level='3' start_line='85' end_line='89'></method_info>
 			<added_lines>87</added_lines>
 			<deleted_lines>87,88</deleted_lines>
 		</method>
 		<modified_lines>
 			<added_lines>31,32,33,34,35,36,37,38,39,40,41</added_lines>
 			<deleted_lines>31,32,33,34,35,36,37,38,39,40,41</deleted_lines>
 		</modified_lines>
 	</modification>
 </commit>
</bug_data>
