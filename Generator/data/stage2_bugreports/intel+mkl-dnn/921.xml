<bug id='921' author='kawakami-k' open_date='2020-12-14T07:05:38Z' closed_time='2021-01-15T04:11:50Z'>
	<summary>test_gemm_s8s8s32 failure on AzureDevOps OSX CI</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

Azure DevOps CI of the current master branch are passed as shown in
&lt;denchmark-link:https://dev.azure.com/mkldnn/dnnl/_build/results?buildId=311&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=48834338-8603-52b5-7d02-e967904bd6ed&gt;https://dev.azure.com/mkldnn/dnnl/_build/results?buildId=311&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=48834338-8603-52b5-7d02-e967904bd6ed&lt;/denchmark-link&gt;

, but I can't pass the CI for the same commit in my fork as shown in
&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=12&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=7fa14b02-7776-5964-c2fd-5874e324208b&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=12&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=7fa14b02-7776-5964-c2fd-5874e324208b&lt;/denchmark-link&gt;

The test pattern below failed.
&lt;denchmark-code&gt; ./test_gemm_s8s8s32 --gtest_filter="TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4
&lt;/denchmark-code&gt;

&lt;denchmark-h:h1&gt;Version&lt;/denchmark-h&gt;

7bd73fb5297425e3d38a80a49559f55fdbad2d8c of Master branch
&lt;denchmark-h:h1&gt;Environment&lt;/denchmark-h&gt;

Azure DevOps OSX_10_14
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;


Fork https://github.com/oneapi-src/oneDNN into my own GitHub account
Enable Azure DevOps CI of my fork and start Azure DevOps CI

&lt;denchmark-h:h1&gt;Observed behavior&lt;/denchmark-h&gt;

One of  failed.
&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=99&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=7fa14b02-7776-5964-c2fd-5874e324208b&amp;l=878&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=99&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=7fa14b02-7776-5964-c2fd-5874e324208b&amp;l=878&lt;/denchmark-link&gt;

I added some debug dump code
&lt;denchmark-link:https://github.com/kawakami-k/oneDNN/commits/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4&gt;https://github.com/kawakami-k/oneDNN/commits/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4&lt;/denchmark-link&gt;

, then I ran Azure DevOps CI. The below is the log.
&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&lt;/denchmark-link&gt;

As for (row=0, col=0) element,
the difference between the got value and the reference value is 11, which is beyond the allowable difference of 9.
&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=54197&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=54197&lt;/denchmark-link&gt;

The got value is compensated by  in ,
&lt;denchmark-link:https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/gemm/s8x8s32/simple_gemm_s8s8s32.cpp#L141&gt;https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/gemm/s8x8s32/simple_gemm_s8s8s32.cpp#L141&lt;/denchmark-link&gt;

and the compensation values are calculated in  in .
In , oneDNN on Azure DevOps OSX_10_14 received 87381 as .
&lt;denchmark-link:https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/gemm/s8x8s32/simple_gemm_s8s8s32.cpp#L62&gt;https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/gemm/s8x8s32/simple_gemm_s8s8s32.cpp#L62&lt;/denchmark-link&gt;

&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=29&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=29&lt;/denchmark-link&gt;

 seems to be reasonable, because  is 256 and  is 3 (37381 * 3 = 256K).
&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=067cd3d2-91f1-5961-4dce-c25f5665f287&amp;l=63&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=067cd3d2-91f1-5961-4dce-c25f5665f287&amp;l=63&lt;/denchmark-link&gt;

&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=067cd3d2-91f1-5961-4dce-c25f5665f287&amp;l=70&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=067cd3d2-91f1-5961-4dce-c25f5665f287&amp;l=70&lt;/denchmark-link&gt;

87381 results in blocking_factor of 30,
From the following code and log, is 256 used as ?
&lt;denchmark-link:https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/x64/gemm/gemm_driver.cpp#L622&gt;https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/x64/gemm/gemm_driver.cpp#L622&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/x64/gemm/gemm_driver.cpp#L800&gt;https://github.com/kawakami-k/oneDNN/blob/TestGEMM_heavy_s8s8s32_CPU/gemm_test.TestGEMM/4/src/cpu/x64/gemm/gemm_driver.cpp#L800&lt;/denchmark-link&gt;

&lt;denchmark-link:https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=41&gt;https://dev.azure.com/kawakamik/oneDNN/_build/results?buildId=100&amp;view=logs&amp;j=b12a3ddb-6e56-5025-2dba-bfa0589f86b9&amp;t=d42aab22-229f-5bc6-1d14-17661990413c&amp;l=41&lt;/denchmark-link&gt;

If 256 is used, there is blocking_factor mismatch between compensation and matrix calculation.
	</description>
	<comments>
		<comment id='1' author='kawakami-k' date='2020-12-14T23:13:32Z'>
		&lt;denchmark-link:https://github.com/kawakami-k&gt;@kawakami-k&lt;/denchmark-link&gt;
, thank you for the report. The same test fails in the latest run on master as well.
		</comment>
		<comment id='2' author='kawakami-k' date='2021-01-15T04:11:50Z'>
		This issue is now fixed in master. Thanks.
		</comment>
	</comments>
</bug>