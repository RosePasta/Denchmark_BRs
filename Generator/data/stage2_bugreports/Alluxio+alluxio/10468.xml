<bug id='10468' author='apc999' open_date='2019-11-13T18:30:36Z' closed_time='2020-01-14T04:45:34Z'>
	<summary>Presto queries get stuck infinitely while accessing files from alluxio.</summary>
	<description>
Alluxio Version:
Alluxio v2.1.0

Originally reported from &lt;denchmark-link:https://alluxio-community.slack.com/archives/CEXGGUBDK/p1573638510393600&gt;https://alluxio-community.slack.com/archives/CEXGGUBDK/p1573638510393600&lt;/denchmark-link&gt;

we are facing some weird issue while accessing data from Alluxio using presto. Presto queries are getting stuck infinitely while accessing files from alluxio. I checked the thread dumps for presto worker and seems that threads are getting locked while accessing alluxio file. We were facing this issue with Alluxio 2.0.0, we were told that few improvements has done on client side in the latest version so we upgraded to latest version 2.1.0, but still we are getting the same issue. Could someone please help us to resolve this issue? I am adding alluxio worker logs  and presto thread dumps.
Note - This deployment has done using kubernetes on AWS
To Reproduce
Expected behavior
Urgency
High

Thread dump
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3842826/thread_dumps.log&gt;thread_dumps.log&lt;/denchmark-link&gt;

Worker log:
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3842827/alluxio_worker_log.txt&gt;alluxio_worker_log.txt&lt;/denchmark-link&gt;

	</description>
	<comments>
		<comment id='1' author='apc999' date='2019-11-18T09:31:58Z'>
		&lt;denchmark-link:https://github.com/apc999&gt;@apc999&lt;/denchmark-link&gt;
,
As per discussion on slack I tried by setting  this property but I still getting the same issue. I have captured the thread dumps and attaching here. I hope that will help to debug the issue.
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3857872/presto-worker-thread-dump-18-11.txt&gt;presto-worker-thread-dump-18-11.txt&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='apc999' date='2019-11-18T12:14:44Z'>
		Attaching files to understand the alluxio configurations we have on production
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3858519/alluxio-env-master.txt&gt;alluxio-env-master.txt&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3858520/alluxio-env-worker.txt&gt;alluxio-env-worker.txt&lt;/denchmark-link&gt;

		</comment>
		<comment id='3' author='apc999' date='2019-11-18T18:35:05Z'>
		&lt;denchmark-link:https://github.com/bf8086&gt;@bf8086&lt;/denchmark-link&gt;
 can you help take a look?
		</comment>
		<comment id='4' author='apc999' date='2019-11-18T19:35:06Z'>
		&lt;denchmark-link:https://github.com/surajc-cuelogic&gt;@surajc-cuelogic&lt;/denchmark-link&gt;
 thanks for reporting the issue. Do you still have the Alluxio worker log for node  around timestamp ?
		</comment>
		<comment id='5' author='apc999' date='2019-11-19T05:45:10Z'>
		&lt;denchmark-link:https://github.com/bf8086&gt;@bf8086&lt;/denchmark-link&gt;
 Thanks for your response. We have saved Alluxio worker logs of soc-alluxio-worker-0.soc.alluxio-worker around timestamp 2019-11-13 07:40 and attached same. Unfortunately we do not have worker logs for soc-alluxio-worker-5.soc-alluxio-worker.
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3862093/alluxio_worker_log.txt&gt;alluxio_worker_log.txt&lt;/denchmark-link&gt;

		</comment>
		<comment id='6' author='apc999' date='2019-11-19T22:31:27Z'>
		&lt;denchmark-link:https://github.com/prashantk-cuelogic&gt;@prashantk-cuelogic&lt;/denchmark-link&gt;
 do you have master log for around the same time period? How many masters do you have?
Can you also post your Alluxio client side configuration set in presto?
		</comment>
		<comment id='7' author='apc999' date='2019-11-20T06:26:07Z'>
		&lt;denchmark-link:https://github.com/bf8086&gt;@bf8086&lt;/denchmark-link&gt;
 I do not have alluxio msater logs around the same time period. We have 3 alluxio masters running in HA mode(using zookeeper). We are using glusterFs as a journal path for masters.
Please find alluxio client side configuration set in presto:
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3867538/config_properties.txt&gt;config_properties.txt&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3867539/hive_properties.txt&gt;hive_properties.txt&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3867619/core-site-xml.txt&gt;core-site-xml.txt&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3867620/hive-site-xml.txt&gt;hive-site-xml.txt&lt;/denchmark-link&gt;

		</comment>
		<comment id='8' author='apc999' date='2019-11-20T18:40:03Z'>
		&lt;denchmark-link:https://github.com/prashantk-cuelogic&gt;@prashantk-cuelogic&lt;/denchmark-link&gt;
 is it possible for you to share the query or type of workload running when this issue happen? How many presto workers and alluxio workers are you running? Are they colocated?
		</comment>
		<comment id='9' author='apc999' date='2019-11-20T19:26:53Z'>
		From the attached thread dump it looks like the presto worker is reaching maximum number of Alluxio master clients. Can you also attach your presto worker log from the worker which hangs? To get more detailed information, please also turn on Alluxio client debug log by adding a new line alluxio=DEBUG to presto log configuration /etc/presto/log4j.properties and restart presto.
		</comment>
		<comment id='10' author='apc999' date='2019-12-02T19:31:56Z'>
		&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3912989/presto-worker-logs.log&gt;presto-worker-logs.log&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3913000/thread-dumps.for.same.presto.worker.log&gt;thread-dumps for same presto worker.log&lt;/denchmark-link&gt;

		</comment>
		<comment id='11' author='apc999' date='2019-12-02T23:43:08Z'>
		&lt;denchmark-link:https://github.com/surajc-cuelogic&gt;@surajc-cuelogic&lt;/denchmark-link&gt;
 Thanks for the additional logs. I see two issues from the logs/thread dump:


From the presto worker logs there seems to be a network issue happening around 2019-12-02T12:22 and many network requests including Presto, Kudo and Alluxio worker requests has failed. You might want to investigate the network issue which seems to cause timeout in various places.


The thread dump indicates that the presto worker is running on OpenJDK 11. Currently Alluxio only support Java JDK 8(see docs for detail). Higher version of Java is not supported and might lead to unknown issues. Can you try using Java version 8 for your presto service and see if it helps?


		</comment>
		<comment id='12' author='apc999' date='2019-12-04T08:06:14Z'>
		&lt;denchmark-link:https://github.com/apc999&gt;@apc999&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/bf8086&gt;@bf8086&lt;/denchmark-link&gt;
 I had discussion with presto team, they are saying JAVA 11 is more performant than Java 8 and in near future they are making Java 11 as minimum requirement for presto. Are we considering moving Alluxio as well to Java 11?
		</comment>
		<comment id='13' author='apc999' date='2020-01-10T00:13:39Z'>
		&lt;denchmark-link:https://github.com/surajc-cuelogic&gt;@surajc-cuelogic&lt;/denchmark-link&gt;
 we think this patch &lt;denchmark-link:https://github.com/Alluxio/alluxio/pull/10719&gt;#10719&lt;/denchmark-link&gt;
 will fix the issue (this issue looks unrelated to Java version). In the meanwhile, we are working on supporting Java 11 too.
		</comment>
		<comment id='14' author='apc999' date='2020-03-27T15:09:44Z'>
		Hi Team,
I tried to verify latest alluxio version 2.2.0 with Presto 323 with jdk11. But I am still getting the same issue. Queries are getting stuck for infinite time while fetching data from alluxio-s3. Could some one help me to get this solve?
		</comment>
		<comment id='15' author='apc999' date='2020-03-27T15:10:25Z'>
		Let me know if I need to create new issue or can we reopen this?
		</comment>
		<comment id='16' author='apc999' date='2020-03-27T15:24:48Z'>
		&lt;denchmark-link:https://github.com/surajc-cuelogic&gt;@surajc-cuelogic&lt;/denchmark-link&gt;
 if you are still seeing your queries hanging it's likely a different issue. Either misconfiguration or some other bug. You can open a new issue where you should attach a  of the presto workers which are hanging, your , and presto configuration
		</comment>
	</comments>
</bug>