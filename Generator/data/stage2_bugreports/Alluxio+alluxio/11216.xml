<bug id='11216' author='Binyang2014' open_date='2020-03-27T04:00:30Z' closed_time='2020-05-06T06:26:20Z'>
	<summary>Read part of file will download the whole block data</summary>
	<description>
Alluxio Version:
2.2
Describe the bug
In Alluxio, I want to read part of file by using alluxio-fuse. There are many records in a single file and file size is about 2GB. When I randomly read the record, I notice alluxio will download much data from remote server than I request.
According to:



alluxio/core/client/fs/src/main/java/alluxio/client/block/stream/BlockInStream.java


        Lines 372 to 384
      in
      47dfd7a






 private void readChunk() throws IOException { 



 if (mDataReader == null) { 



     mDataReader = mDataReaderFactory.create(mPos, mLength - mPos); 



   } 



 



 if (mCurrentChunk != null &amp;&amp; mCurrentChunk.readableBytes() == 0) { 



     mCurrentChunk.release(); 



     mCurrentChunk = null; 



   } 



 if (mCurrentChunk == null) { 



     mCurrentChunk = mDataReader.readChunk(); 



   } 



 } 





When I init a read op, it will create a DataReader here in my case is GrpcDataReader.
Refer to:



alluxio/core/client/fs/src/main/java/alluxio/client/block/stream/GrpcDataReader.java


        Lines 200 to 204
      in
      fb48660






 @Override 



 public DataReader create(long offset, long len) throws IOException { 



 return new GrpcDataReader(mContext, mAddress, 



       mReadRequestPartial.toBuilder().setOffset(offset).setLength(len).build()); 



 } 





Then len here is curOffset to end of block.
When data reader create, it will send a readRequest:
refer to:



alluxio/core/client/fs/src/main/java/alluxio/client/block/stream/GrpcDataReader.java


        Lines 72 to 113
      in
      fb48660






 private GrpcDataReader(FileSystemContext context, WorkerNetAddress address, 



 ReadRequest readRequest) throws IOException { 



   mContext = context; 



   mAddress = address; 



   mPosToRead = readRequest.getOffset(); 



   mReadRequest = readRequest; 



 AlluxioConfiguration alluxioConf = context.getClusterConf(); 



   mReaderBufferSizeMessages = alluxioConf 



       .getInt(PropertyKey.USER_NETWORK_READER_BUFFER_SIZE_MESSAGES); 



   mDataTimeoutMs = alluxioConf.getMs(PropertyKey.USER_NETWORK_DATA_TIMEOUT_MS); 



   mMarshaller = new ReadResponseMarshaller(); 



   mClient = mContext.acquireBlockWorkerClient(address); 



 



 try { 



 if (alluxioConf.getBoolean(PropertyKey.USER_NETWORK_ZEROCOPY_ENABLED)) { 



 String desc = "Zero Copy GrpcDataReader"; 



 if (LOG.isDebugEnabled()) { // More detailed description when debug logging is enabled 



         desc = MoreObjects.toStringHelper(this) 



             .add("request", mReadRequest) 



             .add("address", address) 



             .toString(); 



       } 



       mStream = new GrpcDataMessageBlockingStream&lt;&gt;(mClient.get()::readBlock, 



           mReaderBufferSizeMessages, 



           desc, null, mMarshaller); 



     } else { 



 String desc = "GrpcDataReader"; 



 if (LOG.isDebugEnabled()) { // More detailed description when debug logging is enabled 



         desc = MoreObjects.toStringHelper(this) 



             .add("request", mReadRequest) 



             .add("address", address) 



             .toString(); 



       } 



       mStream = new GrpcBlockingStream&lt;&gt;(mClient.get()::readBlock, mReaderBufferSizeMessages, 



           desc); 



     } 



     mStream.send(mReadRequest, mDataTimeoutMs); 



   } catch (Exception e) { 



     mClient.close(); 



 throw e; 



   } 



 } 





This read request will request all data from curOffset to blockEnd!!!
It will read too much data and slow down the read iops.
As my understand,  the initial read should only read one chunk of data and



alluxio/core/client/fs/src/main/java/alluxio/client/block/stream/BlockInStream.java


        Lines 381 to 383
      in
      fb48660






 if (mCurrentChunk == null) { 



   mCurrentChunk = mDataReader.readChunk(); 



 } 





will handler left things.
To Reproduce
Read a small piece of data from a big file
Expected behavior
A clear and concise description of what you expected to happen.
Urgency
high
Additional context
Add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='Binyang2014' date='2020-04-21T01:49:16Z'>
		&lt;denchmark-link:https://github.com/apc999&gt;@apc999&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/ZacBlanco&gt;@ZacBlanco&lt;/denchmark-link&gt;
 Could you take a look?
		</comment>
		<comment id='2' author='Binyang2014' date='2020-05-06T06:26:20Z'>
		Close it. Seems the logic is correct.
		</comment>
	</comments>
</bug>