<bug id='9874' author='cheyang' open_date='2019-09-11T08:49:21Z' closed_time='2019-09-24T18:46:20Z'>
	<summary>Failed to load the data due to the job service is busy</summary>
	<description>
Alluxio Version:
2.1.0-snapshot
Describe the bug
A clear and concise description of what the bug is.
To Reproduce

Set replication

&lt;denchmark-code&gt;/opt/alluxio/bin/alluxio fs setReplication --max 1 --min 0 /oss-gw/images
&lt;/denchmark-code&gt;


load the data

&lt;denchmark-code&gt;time /opt/alluxio/bin/alluxio fs -Dalluxio.user.ufs.block.read.location.policy=alluxio.client.block.policy.DeterministicHashPolicy  distributedLoad --replication 1 /oss-gw/images/
Failed to successfully complete the job.
&lt;/denchmark-code&gt;


Check the logs

&lt;denchmark-code&gt;kubectl logs -f alluxio-master-0 -f alluxio-job-master
2019-09-11 08:45:57,091 INFO  JobCoordinator - Starting job EvictConfig{blockId=3271557122, replicas=1}
2019-09-11 08:45:57,093 WARN  JobMasterClientServiceHandler - Exit (Error): run: request=jobConfig: "\254\355\000\005sr\000!alluxio.job.replicate.EvictConfig\f\353\231\346 \2303\311\002\000\002J\000\bmBlockIdI\000\tmReplicasxp\000\000\000\000\235\000\000\000\000\000\000\001"
, Error=alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
&lt;/denchmark-code&gt;

&lt;denchmark-code&gt;kubectl logs -f alluxio-master-0 -f alluxio-master
2019-09-11 08:42:44,031 WARN  SleepingTimer - Master Replication Check last execution took 64010 ms. Longer than the interval 60000
2019-09-11 08:43:48,044 WARN  ReplicationChecker - The job service is busy, will retry later. alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
2019-09-11 08:43:48,044 WARN  SleepingTimer - Master Replication Check last execution took 64012 ms. Longer than the interval 60000
2019-09-11 08:44:52,057 WARN  ReplicationChecker - The job service is busy, will retry later. alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
2019-09-11 08:44:52,058 WARN  SleepingTimer - Master Replication Check last execution took 64014 ms. Longer than the interval 60000
2019-09-11 08:45:56,078 WARN  ReplicationChecker - The job service is busy, will retry later. alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
2019-09-11 08:45:56,078 WARN  SleepingTimer - Master Replication Check last execution took 64020 ms. Longer than the interval 60000
2019-09-11 08:45:57,093 WARN  ReplicationChecker - The job service is busy, will retry later. alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
&lt;/denchmark-code&gt;


But it's strange that some data has been loaded.

&lt;denchmark-code&gt;/opt/alluxio/bin/alluxio fsadmin report capacity
Capacity information for all workers:
    Total Capacity: 600.00GB
        Tier: MEM  Size: 200.00GB
        Tier: SSD  Size: 400.00GB
    Used Capacity: 112.02GB
        Tier: MEM  Size: 112.02GB
        Tier: SSD  Size: 0B
    Used Percentage: 18%
    Free Percentage: 82%

Worker Name      Last Heartbeat   Storage       Total            MEM           SSD
192.168.0.194    0                capacity      150.00GB         50.00GB       100.00GB
                                  used          27.72GB (18%)    27.72GB       0B
192.168.0.117    0                capacity      150.00GB         50.00GB       100.00GB
                                  used          29.46GB (19%)    29.46GB       0B
192.168.0.118    0                capacity      150.00GB         50.00GB       100.00GB
                                  used          26.71GB (17%)    26.71GB       0B
192.168.0.195    0                capacity      150.00GB         50.00GB       100.00GB
                                  used          28.13GB (18%)    28.13GB       0B
&lt;/denchmark-code&gt;

Expected behavior
A clear and concise description of what you expected to happen.
Urgency
Describe the impact and urgency of the bug.
Additional context
Add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='cheyang' date='2019-09-11T09:01:45Z'>
		See the logs below:
&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3599894/diagnose_alluxio_1568191234.tar.gz&gt;diagnose_alluxio_1568191234.tar.gz&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='cheyang' date='2019-09-11T16:51:38Z'>
		Hi &lt;denchmark-link:https://github.com/cheyang&gt;@cheyang&lt;/denchmark-link&gt;
,
Do you know the approximate number of files in your oss-gw/images directory?
The job service has a limit on the number of concurrently scheduled jobs. If your use case requires more, then there are some properties you can adjust

 alluxio.job.master.job.capacity

This property will allow more jobs to be scheduled concurrently. Finished jobs within the retention time &lt;denchmark-link:https://docs.alluxio.io/os/user/stable/en/reference/Properties-List.html#alluxio.job.master.finished.job.retention.time&gt;alluxio.job.master.finished.job.retention.time&lt;/denchmark-link&gt;
 will also contribute towards the capacity. You can adjust the retention time and total capacity in order to accommodate larger amounts of jobs.
You should note increasing the capacity may lead to more heap consumption on the job master. Depending on how large you increase you may need to adjust the max JVM heap size.
HTH!
		</comment>
		<comment id='3' author='cheyang' date='2019-09-12T00:18:49Z'>
		
Hi @cheyang,
Do you know the approximate number of files in your oss-gw/images directory?

&lt;denchmark-code&gt;# ls -ltr | wc -l
1153
&lt;/denchmark-code&gt;


The job service has a limit on the number of concurrently scheduled jobs. If your use case requires more, then there are some properties you can adjust

 alluxio.job.master.job.capacity


I think the issue is that I just started to use alluxio. There shouldn't be so many jobs. What makes them start, and I check it today morning. the same error here:
&lt;denchmark-code&gt;time /opt/alluxio/bin/alluxio fs -Dalluxio.user.ufs.block.read.location.policy=alluxio.client.block.policy.DeterministicHashPolicy  distributedLoad --replication 1 /oss-gw/images/
Failed to successfully complete the job.
&lt;/denchmark-code&gt;

&lt;denchmark-code&gt;2019-09-12 00:16:04,027 WARN  JobMasterClientServiceHandler - Exit (Error): run: request=jobConfig: "\254\355\000\005sr\000!alluxio.job.replicate.EvictConfig\f\353\231\346 \2303\311\002\000\002J\000\bmBlockIdI\000\tmReplicasxp\000\000\000\002\000\000\000\002\000\000\000\001"
, Error=alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
2019-09-12 00:17:08,041 WARN  JobMasterClientServiceHandler - Exit (Error): run: request=jobConfig: "\254\355\000\005sr\000!alluxio.job.replicate.EvictConfig\f\353\231\346 \2303\311\002\000\002J\000\bmBlockIdI\000\tmReplicasxp\000\000\000\002\000\000\000\002\000\000\000\001"
, Error=alluxio.exception.status.ResourceExhaustedException: Job master is at full capacity of 100,000 jobs
&lt;/denchmark-code&gt;

I think it's an abnormal behavior.

This property will allow more jobs to be scheduled concurrently. Finished jobs within the retention time alluxio.job.master.finished.job.retention.time will also contribute towards the capacity. You can adjust the retention time and total capacity in order to accommodate larger amounts of jobs.
You should note increasing the capacity may lead to more heap consumption on the job master. Depending on how large you increase you may need to adjust the max JVM heap size.
HTH!

		</comment>
		<comment id='4' author='cheyang' date='2019-09-12T01:38:17Z'>
		Can you give more information about your cluster and deployment? I ran the exact commands you gave on a directory with 10K files and everything worked without issue.
		</comment>
		<comment id='5' author='cheyang' date='2019-09-12T02:54:10Z'>
		
Can you give more information about your cluster and deployment? I ran the exact commands you gave on a directory with 10K files and everything worked without issue.

Sure, I have pinged you in slack.
		</comment>
		<comment id='6' author='cheyang' date='2019-09-19T00:47:24Z'>
		One thing I noticed looking through the logs is that there are many evict jobs submitted to the master from the replication checker.
For some reason they are not able to be flushed from the queue when new jobs from the distributedLoad command are received. Many of them look completed, but are not flushed between runs.
&lt;denchmark-link:https://github.com/Alluxio/alluxio/blob/master/job/server/src/main/java/alluxio/master/job/JobMaster.java#L207-L257&gt;https://github.com/Alluxio/alluxio/blob/master/job/server/src/main/java/alluxio/master/job/JobMaster.java#L207-L257&lt;/denchmark-link&gt;

We're throwing the exception either on L218 or L238, which means either mFinishedJobs is empty, or we're within the retention time. In my setup, the retention time I've used is 15 seconds, so jobs should be swiftly removed when new ones come in, but this doesn't seem to be the case.
Still investigating
		</comment>
		<comment id='7' author='cheyang' date='2019-09-24T00:50:27Z'>
		&lt;denchmark-link:https://github.com/cheyang&gt;@cheyang&lt;/denchmark-link&gt;
 I think we found the root cause of the issue. See the PR linked above for more information
Note that after this PR it is possible in your scenario for you to still hit the ResourceExhausted exception, but jobs will now be properly evicted after the retention timeout.
		</comment>
	</comments>
</bug>