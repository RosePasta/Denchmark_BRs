<bug id='10894' author='wangyuqing4' open_date='2020-02-12T10:55:09Z' closed_time='2020-04-29T06:48:33Z'>
	<summary>Failed to pass all runTests in k8s</summary>
	<description>
Alluxio Version:
code: master branch，2.2.0；docker images tag: 2.2.0-SNAPSHOT
Describe the bug
use /integration/kubernetes/singleMaster-localJournal,
&lt;denchmark-code&gt;kubectl create -f alluxio-configmap.yaml
kubectl create -f ./master/ 
kubectl create -f ./worker/
&lt;/denchmark-code&gt;

when i kubectl get po,
&lt;denchmark-code&gt;NAME                   READY   STATUS    RESTARTS   AGE
alluxio-master-0       2/2     Running   0          10s
alluxio-worker-gvmqj   2/2     Running   0          5s
&lt;/denchmark-code&gt;

&lt;denchmark-code&gt;kubectl exec -ti alluxio-master-0 /bin/sh
./bin/alluxio runTests
&lt;/denchmark-code&gt;

some tests pass, but 12 tests failed, print
&lt;denchmark-code&gt;2020-02-12 10:43:52,171 ERROR CliUtils - Exception running test: alluxio.examples.BasicOperations@1b75c2e3       
alluxio.exception.status.NotFoundException: /opt/alluxio-2.2.0-SNAPSHOT/underFSStorage/default_tests_files/BASIC_
id: -1   
......
Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: /opt/alluxio-2.2.0-SNAPSHOT/underFSStorage/default_tests_fi
        at io.grpc.Status.asRuntimeException(Status.java:533)                                                    
        at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:449)            
        at io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39)      
        at io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23)                    
        at io.grpc.ForwardingClientCallListener$SimpleForwardingClientCallListener.onClose(ForwardingClientCallLi
        at alluxio.grpc.GrpcChannel$ChannelResponseTracker$1$1.onClose(GrpcChannel.java:176)                     
        at io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39)      
        at io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23)                    
        at io.grpc.ForwardingClientCallListener$SimpleForwardingClientCallListener.onClose(ForwardingClientCallLi
        at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:426)                                
        at io.grpc.internal.ClientCallImpl.access$500(ClientCallImpl.java:66)                                    
        at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl.close(ClientCallImpl.java:689)   
......
 Number of failed tests: 12
&lt;/denchmark-code&gt;

i just started using alluxio, i can run alluxio on centos/docker container, but i can't pass all tests on k8s. looking forward to your reply :)
Expected behavior
when i use ./bin/alluxio runTests, all tests pass
	</description>
	<comments>
		<comment id='1' author='wangyuqing4' date='2020-02-12T22:58:19Z'>
		Did you configure alluxio to point to a UFS? Have you followed the guide here:
&lt;denchmark-link:https://docs.alluxio.io/os/user/stable/en/deploy/Running-Alluxio-On-Kubernetes.html&gt;https://docs.alluxio.io/os/user/stable/en/deploy/Running-Alluxio-On-Kubernetes.html&lt;/denchmark-link&gt;

Please let us know if there are further issues.
		</comment>
		<comment id='2' author='wangyuqing4' date='2020-02-13T01:39:45Z'>
		thx, you mean when i use kubectl create -f alluxio-configmap.yaml, in the alluxio-configmap.yaml, i should add -Dalluxio.master.mount.table.root.ufs=&lt;under_storage_address&gt; to ALLUXIO_JAVA_OPTS ?
in the master branch alluxio/integration/kubernetes/singleMaster-localJournal/alluxio-configmap.yaml.template i did't see the property.
		</comment>
		<comment id='3' author='wangyuqing4' date='2020-02-13T01:44:57Z'>
		Yes you will need to add -Dalluxio.master.mount.table.root.ufs=&lt;storage_address&gt; if you haven't yet.
For a simple local deployment, you will need to create a persistent volume in k8s  and mount that to your master and worker containers in the same location.
Otherwise, if you have access to an external storage service like s3, you should just be able to specify the s3 path along with the credentials to create the mount properly
		</comment>
		<comment id='4' author='wangyuqing4' date='2020-02-13T05:55:46Z'>
		thx，now i use obs(&lt;denchmark-link:https://docs.alluxio.io/os/user/edge/en/ufs/OBS.html?q=obs&gt;https://docs.alluxio.io/os/user/edge/en/ufs/OBS.html?q=obs&lt;/denchmark-link&gt;
), according to the doc,  completed successfully in centos，but in k8s failed
kubectl exec -ti alluxio-master-0 /bin/sh
./bin/alluxio extensions install alluxio-underfs-obs-2.0.0.jar
&lt;denchmark-code&gt;Failed to install extension on hosts:
localhost
&lt;/denchmark-code&gt;

		</comment>
		<comment id='5' author='wangyuqing4' date='2020-02-13T08:46:26Z'>
		why i can't use the file /underFSStorage in node which the pod deploy?
		</comment>
		<comment id='6' author='wangyuqing4' date='2020-02-13T09:29:58Z'>
		Is there anything under ${ALLUXIO_HOME}/logs/task.log within the container you tried to install the extension with?
/underFSStorage is a local directory specific to the container that is running in that pod. In order to use that as a UFS it must be accessible to all nodes in the cluster (Alluxio masters and workers). If you have more than one physical machine (multiple kubelets), then you can't simply use a directory because that can't be read across machines unless you've mounted the same path on multiple systems.
However, if you are running on a single node, you can make PV claim in k8s which can then be mounted to any number of containers within the Alluxio pod. It can work for a simple local deployment - but will not work otherwise.
		</comment>
		<comment id='7' author='wangyuqing4' date='2020-02-14T03:15:17Z'>
		thx, now i use local directory,  one physical machine, when runTests, 12 tests failed the same.
With ASYNC_THROUGH field test will success, but without ASYNC_THROUGH test will failed.  probably not a problem with volume？
		</comment>
		<comment id='8' author='wangyuqing4' date='2020-02-19T00:35:21Z'>
		It sounds like there is a problem with the mounted volume. If the tests with THROUGH and CACHE_THROUGH write types are failing, then your volume is probably not mounted correctly for each container
		</comment>
		<comment id='9' author='wangyuqing4' date='2020-02-19T00:40:07Z'>
		i solve it last week，volumes in master branch alluxio-worker-daemonset.yaml maybe have error，when i add pvc the same as alluxio-master-statefulset.yaml， runTests all pass.
		</comment>
		<comment id='10' author='wangyuqing4' date='2020-02-19T02:31:52Z'>
		&lt;denchmark-link:https://github.com/wangyuqing4&gt;@wangyuqing4&lt;/denchmark-link&gt;
 Sounds like you are using a ReadWriteMany persistent volume as the under storage. In that case you need to mount that to masters and workers.
You mentioned volumes in master branch alluxio-worker-daemonset.yaml maybe have error. What was the error you found or observed?
		</comment>
		<comment id='11' author='wangyuqing4' date='2020-02-19T02:33:01Z'>
		&lt;denchmark-link:https://github.com/jiacheliu3&gt;@jiacheliu3&lt;/denchmark-link&gt;
 I think this was the log: &lt;denchmark-link:https://github.com/wangyuqing4/alluxio-k8s/blob/d2607444693b7fa8eac8b385b21bd4b7a6ef1574/runTests.log&gt;https://github.com/wangyuqing4/alluxio-k8s/blob/d2607444693b7fa8eac8b385b21bd4b7a6ef1574/runTests.log&lt;/denchmark-link&gt;

		</comment>
		<comment id='12' author='wangyuqing4' date='2020-02-19T02:34:53Z'>
		&lt;denchmark-link:https://github.com/ZacBlanco&gt;@ZacBlanco&lt;/denchmark-link&gt;
 I wonder why the error is
&lt;denchmark-code&gt;NOT_FOUND: /journal/default_tests_files/BASIC_NON_BYTE_BUFFER_CACHE_PROMOTE_CACHE_THROUGH
&lt;/denchmark-code&gt;

Seems the under storage dir is the journal path?
		</comment>
		<comment id='13' author='wangyuqing4' date='2020-03-16T03:31:58Z'>
		&lt;denchmark-link:https://github.com/ZacBlanco&gt;@ZacBlanco&lt;/denchmark-link&gt;
 Do you think this can be closed? I feel this is most probably due to a misconfigure on the PVC.
		</comment>
		<comment id='14' author='wangyuqing4' date='2020-04-29T06:48:32Z'>
		Closed as this is a mis-configuration
		</comment>
	</comments>
</bug>