<bug id='9390' author='cheyang' open_date='2019-06-30T22:43:46Z' closed_time='2019-08-02T01:08:40Z'>
	<summary>The Cache Hit Rate is 0 but all the data is loaded into alluxio</summary>
	<description>
Alluxio Version:
2.0.0
Describe the bug
The data is already persistent in alluxio, but it's still downloaded from the oss endpoint.

Deploy master, workers and fuse in kubernetes

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3343410/k8s.zip&gt;k8s.zip&lt;/denchmark-link&gt;


And go to the node(iZhp3bku0ru8vuxq08lorwZ),  copy whole the directory from alluxio fuse to local directory

&lt;denchmark-code&gt;time cp -r /alluxio-fuse/training-data/images /var/lib/docker/test
&lt;/denchmark-code&gt;


After that, check the persistent status. All the data are in persistent.

&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fs ls /training-data/images| wc -l
1152
bash-4.4# /opt/alluxio/bin/alluxio fs ls /training-data/images| grep  PERSIST|wc -l
1152
bash-4.4# /opt/alluxio/bin/alluxio fs ls /training-data/images| grep -v PERSIST|wc -l
0
&lt;/denchmark-code&gt;


I've checked the data is fully loaded into alluxio, in node iZhp3bku0ru8vuxq08lorwZ

&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fsadmin report ufs
Alluxio under storage system information:
oss://imagenet-huabei5/images      on  /training-data/images  (oss, capacity=-1B, used=-1B, read-only, not shared, properties={fs.oss.accessKeySecret=******, fs.oss.accessKeyId=******, fs.oss.endpoint=oss-cn-internal.aliyuncs.com})
/opt/alluxio-2.0.0/underFSStorage  on  /                      (local, capacity=4843.27GB, used=-1B(0%), not read-only, not shared, properties={})
&lt;/denchmark-code&gt;

&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fsadmin report capacity
Capacity information for all workers:
    Total Capacity: 2400.00GB
        Tier: MEM  Size: 400.00GB
        Tier: SSD  Size: 2000.00GB
    Used Capacity: 167.41GB
        Tier: MEM  Size: 109.58GB
        Tier: SSD  Size: 57.82GB
    Used Percentage: 6%
    Free Percentage: 94%

Worker Name                  Last Heartbeat   Storage       Total            MEM           SSD
iZhp3bku0ru8vuxq08loruZ      0                capacity      600.00GB         100.00GB      500.00GB
                                              used          0B (0%)          0B            0B
iZhp3bku0ru8vuxq08lorvZ      0                capacity      600.00GB         100.00GB      500.00GB
                                              used          0B (0%)          0B            0B
iZhp3bku0ru8vuxq08lorxZ      0                capacity      600.00GB         100.00GB      500.00GB
                                              used          23.74GB (3%)     23.74GB       0B
iZhp3bku0ru8vuxq08lorwZ      0                capacity      600.00GB         100.00GB      500.00GB
                                              used          143.67GB (23%)   85.84GB       57.82GB
&lt;/denchmark-code&gt;


But I went to another node to copy data, I notice it's still downloaded data from the remote storage

&lt;denchmark-code&gt;time cp -r /alluxio-fuse/training-data/images /var/lib/docker/test
&lt;/denchmark-code&gt;


Check the metrics, I notice the miss is 100%. I expect the alluxio remote should be 100%.

&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fsadmin report metrics
Total IO:
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                   143.67GB
    From Remote Instances                                      0B
    Under Filesystem Read                                 19.00MB
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B

Total IO Throughput (Last Minute):
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                         0B
    From Remote Instances                                      0B
    Under Filesystem Read                                 15.67MB
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B

Cache Hit Rate (Percentage):
    Alluxio Local                                            0.00
    Alluxio Remote                                           0.00
    Miss                                                   100.00
&lt;/denchmark-code&gt;


logs in the second node

&lt;denchmark-link:https://github.com/Alluxio/alluxio/files/3343415/logs.zip&gt;logs.zip&lt;/denchmark-link&gt;

Are there any wrong with my configuration?
To Reproduce
Steps to reproduce the behavior (as minimally and precisely as possible)
Expected behavior
A clear and concise description of what you expected to happen.
Urgency
Describe the impact and urgency of the bug.
Additional context
Add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='cheyang' date='2019-06-30T22:59:49Z'>
		/assign &lt;denchmark-link:https://github.com/apc999&gt;@apc999&lt;/denchmark-link&gt;
 , thanks for taking a look at this.
		</comment>
		<comment id='2' author='cheyang' date='2019-07-03T00:55:18Z'>
		Hi &lt;denchmark-link:https://github.com/cheyang&gt;@cheyang&lt;/denchmark-link&gt;
 can I confirm if you are using 2.0.0 or 2.0.0-preview? I just tested a setup and wasn't able to reproduce the issue. I know there have been some metrics fixes in the latest release as well.
		</comment>
		<comment id='3' author='cheyang' date='2019-07-03T07:29:27Z'>
		I'm using the docker image: alluxio/alluxio:2.0.0.
		</comment>
		<comment id='4' author='cheyang' date='2019-07-09T05:25:38Z'>
		What is the root mount ufs address? Seems like the storage is local to the workers if I read it correctly. Instead it should be shared across all workers and master like the oss mount
		</comment>
		<comment id='5' author='cheyang' date='2019-07-09T06:06:28Z'>
		Here is the root mount ufs address. But I think if the data is already in alluxio, it should be read from Alluxio Remote .
&lt;denchmark-code&gt;# /opt/alluxio/bin/alluxio getConf | grep alluxio.master.mount.table.root.ufs
alluxio.master.mount.table.root.ufs=/opt/alluxio-2.0.0/underFSStorage
&lt;/denchmark-code&gt;

		</comment>
		<comment id='6' author='cheyang' date='2019-07-09T18:40:49Z'>
		you're right, the root mount shouldn't matter as you're accessing the nested mount point all along
		</comment>
		<comment id='7' author='cheyang' date='2019-07-09T18:41:21Z'>
		if you read from the same worker node (using posix api) does it read from ufs or alluxio worker storage?
		</comment>
		<comment id='8' author='cheyang' date='2019-07-10T03:22:00Z'>
		
if you read from the same worker node (using posix api) does it read from ufs or alluxio worker storage?
I think it reads from alluxio worker storage.


Check from the master node

&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fsadmin report metrics
Total IO:
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                   593.25GB
    From Remote Instances                                      0B
    Under Filesystem Read                                      0B
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B

Total IO Throughput (Last Minute):
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                   111.21MB
    From Remote Instances                                      0B
    Under Filesystem Read                                      0B
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B
&lt;/denchmark-code&gt;


The time of copying data(144GB) is about 15 mins

&lt;denchmark-code&gt;time cp -r /alluxio-fuse/training-data/images /var/lib/docker/test

real    15m33.446s
user    0m1.083s
sys     2m47.667s
&lt;/denchmark-code&gt;

		</comment>
		<comment id='9' author='cheyang' date='2019-07-10T06:54:00Z'>
		&lt;denchmark-link:https://github.com/cheyang&gt;@cheyang&lt;/denchmark-link&gt;


in 2.0 the client metrics by default is not collected which may lead to inaccurate metrics calculation
I wouldn't trust the metrics reported here as I also see other issues

		</comment>
		<comment id='10' author='cheyang' date='2019-07-10T16:42:38Z'>
		&lt;denchmark-link:https://github.com/cheyang&gt;@cheyang&lt;/denchmark-link&gt;
 same comment as &lt;denchmark-link:https://github.com/Alluxio/alluxio/issues/9409&gt;#9409&lt;/denchmark-link&gt;
:
i notice that the worker hostname is not set to physical host IP in your template. I believe you are using an older version of the template, this was updated just before the 2.0 release
for the worker container set:
&lt;denchmark-code&gt;          - name: ALLUXIO_WORKER_JAVA_OPTS
            value: " -Dalluxio.worker.hostname=$(ALLUXIO_WORKER_HOSTNAME) "
&lt;/denchmark-code&gt;

i see its only set for the job worker container (same pod as worker)
		</comment>
		<comment id='11' author='cheyang' date='2019-08-02T01:02:17Z'>
		cc. any new on this topic ?
		</comment>
		<comment id='12' author='cheyang' date='2019-08-02T01:08:40Z'>
		Thanks, it can be closed.
		</comment>
	</comments>
</bug>