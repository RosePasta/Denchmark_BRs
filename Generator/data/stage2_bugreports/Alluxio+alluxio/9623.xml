<bug id='9623' author='zrss' open_date='2019-08-01T13:09:05Z' closed_time='2019-08-05T15:20:24Z'>
	<summary>alluxio.user.file.passive.cache.enabled=true not work</summary>
	<description>
Alluxio Version:
What version of Alluxio are you using?
tag v2.0.0
Describe the bug
A clear and concise description of what the bug is.
To Reproduce
Steps to reproduce the behavior (as minimally and precisely as possible)
Expected behavior
A clear and concise description of what you expected to happen.
Urgency
Describe the impact and urgency of the bug.
Additional context
Add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='zrss' date='2019-08-01T13:09:21Z'>
		alluxio-fuse as client
		</comment>
		<comment id='2' author='zrss' date='2019-08-01T17:53:20Z'>
		Hi &lt;denchmark-link:https://github.com/zrss&gt;@zrss&lt;/denchmark-link&gt;
 Thanks for reporting this! Could you fill out all the sections of the bug report?
		</comment>
		<comment id='3' author='zrss' date='2019-08-02T00:43:56Z'>
		thx for the reply.
alluxio cluster capacity
&lt;denchmark-code&gt;[root@train-acw7y alluxio-release]# kubectl exec -ti alluxio-master-0 bash
Defaulting container name to alluxio-master.
Use 'kubectl describe pod/alluxio-master-0 -n default' to see all of the containers in this pod.
bash-4.4# /opt/alluxio/bin/alluxio fsadmin report capacity
Capacity information for all workers: 
    Total Capacity: 5.08TB
        Tier: MEM  Size: 80.00GB
        Tier: SSD  Size: 5120.00GB
    Used Capacity: 339B
        Tier: MEM  Size: 339B
        Tier: SSD  Size: 0B
    Used Percentage: 0%
    Free Percentage: 100%

Worker Name      Last Heartbeat   Storage       Total            MEM           SSD           
192.168.1.51     0                capacity      1040.00GB        16.00GB       1024.00GB     
                                  used          0B (0%)          0B            0B            
192.168.0.22     0                capacity      1040.00GB        16.00GB       1024.00GB     
                                  used          0B (0%)          0B            0B            
192.168.0.231    0                capacity      1040.00GB        16.00GB       1024.00GB     
                                  used          0B (0%)          0B            0B            
192.168.1.93     0                capacity      1040.00GB        16.00GB       1024.00GB     
                                  used          0B (0%)          0B            0B            
192.168.1.61     0                capacity      1040.00GB        16.00GB       1024.00GB     
                                  used          339B (0%)        339B          0B            
bash-4.4# 
&lt;/denchmark-code&gt;

and enable the passive.cache, and we know the data is cached in the 192.168.1.61 node, but the used is still not change when i get the data from 192.168.1.93
&lt;denchmark-code&gt;# 192.168.1.61

[root@train-acw7y alluxio-release]# time cat /mnt/alluxio-root-fs/jpc-testxxx/xxx/metric.json 
xxx
real	0m0.010s
user	0m0.000s
sys	0m0.001s

# 192.168.1.93
[root@train-rd9in ~]# time cat /mnt/alluxio-root-fs/jpc-testxxx/xxx/metric.json
xxx
real	0m0.012s
user	0m0.000s
sys	0m0.002s
&lt;/denchmark-code&gt;

and the metric report
&lt;denchmark-code&gt;bash-4.4# /opt/alluxio/bin/alluxio fsadmin report metrics
Total IO: 
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                    10.59KB
    From Remote Instances                                  7.28KB
    Under Filesystem Read                                      0B
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B

Total IO Throughput (Last Minute): 
    Short-circuit Read                                         0B
    Short-circuit Read (Domain Socket)                         4B
    From Remote Instances                                      4B
    Under Filesystem Read                                      0B
    Alluxio Write                                              0B
    Alluxio Write (Domain Socket)                              0B
    Under Filesystem Write                                     0B

Cache Hit Rate (Percentage): 
    Alluxio Local                                            0.00
    Alluxio Remote                                         100.00
    Miss                                                     0.00
&lt;/denchmark-code&gt;

		</comment>
		<comment id='4' author='zrss' date='2019-08-02T00:55:27Z'>
		maybe related to &lt;denchmark-link:https://github.com/Alluxio/alluxio/issues/9459&gt;#9459&lt;/denchmark-link&gt;

		</comment>
		<comment id='5' author='zrss' date='2019-08-02T03:51:37Z'>
		enable the debug log level for all
&lt;denchmark-code&gt;./opt/alluxio/bin/alluxio logLevel --logName=alluxio --level=DEBUG
&lt;/denchmark-code&gt;

and find the the local worker (192.168.1.93) receive any read request
&lt;denchmark-code&gt;2019-08-02 03:46:37,934 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:38,934 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:39,934 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:40,933 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:41,937 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:42,936 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:43,937 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:44,937 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:45,937 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:46,937 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
2019-08-02 03:46:47,936 DEBUG TieredBlockStore - updatePinnedInodes: inodes=[]
&lt;/denchmark-code&gt;

but the remote node 192.168.1.61 does receive it
&lt;denchmark-code&gt;2019-08-02 03:46:37,386 DEBUG AbstractReadHandler - Received read request block_id: 16777216
offset: 0
length: 339
promote: true
chunk_size: 1048576
open_ufs_block_options {
  ufs_path: "obs://jpc-test/xxx/metric.json"
  offset_in_file: 0
  block_size: 339
  maxUfsReadConcurrency: 2147483647
  mountId: 925244114363427728
  no_cache: false
}
.
2019-08-02 03:46:37,387 DEBUG TieredBlockStore - lockBlock: sessionId=5692228211491981976, blockId=16777216
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - getBlockMeta: sessionId=5692228211491981976, blockId=16777216, lockId=256
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - unlockBlock: lockId=256
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - lockBlockNoException: sessionId=5692228211491981976, blockId=16777216
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - getBlockReader: sessionId=5692228211491981976, blockId=16777216, lockId=257
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - accessBlock: sessionId=5692228211491981976, blockId=16777216
2019-08-02 03:46:37,388 DEBUG TieredBlockStore - unlockBlock: sessionId=5692228211491981976, blockId=16777216
2019-08-02 03:46:37,392 DEBUG BlockWorkerImpl - Enter: asyncCache: request=block_id: 16777216
source_host: "192.168.1.61"
source_port: 29999
open_ufs_block_options {
  ufs_path: "obs://jpc-test/xxx/metric.json"
  offset_in_file: 0
  block_size: 339
  maxUfsReadConcurrency: 2147483647
  mountId: 925244114363427728
  no_cache: false
}
length: 339

2019-08-02 03:46:37,392 DEBUG BlockWorkerImpl - Exit (OK): asyncCache: request=block_id: 16777216
source_host: "192.168.1.61"
source_port: 29999
open_ufs_block_options {
  ufs_path: "obs://jpc-test/xxx/metric.json"
  offset_in_file: 0
  block_size: 339
  maxUfsReadConcurrency: 2147483647
  mountId: 925244114363427728
  no_cache: false
}
length: 339
&lt;/denchmark-code&gt;

		</comment>
		<comment id='6' author='zrss' date='2019-08-03T00:51:42Z'>
		&lt;denchmark-link:https://github.com/madanadit&gt;@madanadit&lt;/denchmark-link&gt;
 looks like something local worker is not preferred for some reason. Is there any parameters to help the k8s containers?
		</comment>
		<comment id='7' author='zrss' date='2019-08-03T03:49:33Z'>
		&lt;denchmark-link:https://github.com/apc999&gt;@apc999&lt;/denchmark-link&gt;
 will have to debug this further. the fuse container and the worker container would have different hostnames in k8s.
based on this report, my guess is that this might be a code issue and we might need to change the logic in the alluxio fuse client to map container ip to physical host ip ( = worker hostname) when choosing which worker to read from. what could be happening is that the client thinks there is no local worker and ends up with a remote read
		</comment>
		<comment id='8' author='zrss' date='2019-08-03T07:20:44Z'>
		&lt;denchmark-link:https://github.com/madanadit&gt;@madanadit&lt;/denchmark-link&gt;
  SG. I updated the priority and shoot for an investigation and possibly a fix in 2.1 release
		</comment>
		<comment id='9' author='zrss' date='2019-08-03T19:13:58Z'>
		thx for the reply, and i also notice that the Alluxio Local in metric is always 0, even though i cat the data in the local node 192.168.1.61
and the speed of cat is not much diff between 192.168.1.61 (local) and 192.168.1.93 (remote)
&lt;denchmark-code&gt;# 192.168.1.61

[root@train-acw7y ~]# time cat /mnt/alluxio-root-fs/jpc-testxxx/xxx/metric.json 
xxx
real	0m0.010s
user	0m0.000s
sys	0m0.001s

# 192.168.1.93
[root@train-rd9in ~]# time cat /mnt/alluxio-root-fs/jpc-testxxx/xxx/metric.json
xxx
real	0m0.012s
user	0m0.000s
sys	0m0.002s
&lt;/denchmark-code&gt;

		</comment>
		<comment id='10' author='zrss' date='2019-08-04T15:38:09Z'>
		&lt;denchmark-link:https://github.com/madanadit&gt;@madanadit&lt;/denchmark-link&gt;
, thx for pointing this out, i set the host ip for alluxio-fuse container by (PR: &lt;denchmark-link:https://github.com/Alluxio/alluxio/pull/9635&gt;#9635&lt;/denchmark-link&gt;
 )
&lt;denchmark-code&gt;          env:
          - name: ALLUXIO_CLIENT_HOSTNAME
            valueFrom:
              fieldRef:
                fieldPath: status.hostIP
          - name: ALLUXIO_JAVA_OPTS
            value: " -Dalluxio.user.hostname=$(ALLUXIO_CLIENT_HOSTNAME) "
&lt;/denchmark-code&gt;

it works as expect now
		</comment>
		<comment id='11' author='zrss' date='2019-08-05T15:19:17Z'>
		Thanks &lt;denchmark-link:https://github.com/zrss&gt;@zrss&lt;/denchmark-link&gt;
 for pointing this out and the fix.
		</comment>
	</comments>
</bug>