<bug id='11881' author='jiacheliu3' open_date='2020-08-03T14:07:47Z' closed_time='2020-11-28T13:24:49Z'>
	<summary>Alluxio monitor script does not work for HA on K8s</summary>
	<description>
Alluxio Version:
2.4-SNAPSHOT
Describe the bug
The readiness and liveness probes on K8s are using bin/alluxio-monitor.sh &lt;component&gt;. This is not working as expected for master/job-master in HA configuration.
When the masters are in HA (only embedded journal now on K8s), alluxio-monitor.sh invokes MasterHealthCheckClient.java. MasterHealthCheckClient issues SSH commands to each of the masters and looks for the master/job-master java process. This is done with a command like below:
&lt;denchmark-code&gt;ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 &lt;hostname&gt; ps -ef | grep "alluxio.master.AlluxioMaster$" | grep "java" | awk '{ print $2; }'
&lt;/denchmark-code&gt;

This will give bash: ssh: command not found in the containers, as we don't include ssh executable in our docker image, so MasterHealthCheckClient should return an error and this monitor script should report an issue.
However this output is not checked by MasterHealthCheckClient. It still thinks the SSH command succeeds. The logic in MasterHealthCheckClient is like below: 


alluxio/shell/src/main/java/alluxio/master/MasterHealthCheckClient.java


         Line 211
      in
      d9de9c0






 if (output.isEmpty()) { 





&lt;denchmark-code&gt;            if (output.isEmpty()) {
              throw new IllegalStateException(
                  String.format("Master process is not running on the host %s", host));
            } else if (output.contains("Connection refused")) {
              throw new IllegalStateException(
                  String.format("Connection refused while connecting to the host %s on port %d",
                      host, port));
            }
&lt;/denchmark-code&gt;

Two wrongs made a right.
To Reproduce
Steps to reproduce the behavior (as minimally and precisely as possible)
Expected behavior
Status check on K8s shouldn't rely on SSH.
Urgency
MEDIUM
Additional context
Add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='jiacheliu3' date='2020-11-28T13:24:49Z'>
		Closed as it is resolved by &lt;denchmark-link:https://github.com/Alluxio/alluxio/pull/11900&gt;#11900&lt;/denchmark-link&gt;

		</comment>
	</comments>
</bug>