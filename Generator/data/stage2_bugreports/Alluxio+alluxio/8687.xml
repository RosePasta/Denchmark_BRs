<bug id='8687' author='perrywang' open_date='2019-04-04T12:16:24Z' closed_time='2020-11-20T20:09:39Z'>
	<summary>Single-Tier Storage configuration is not working</summary>
	<description>

1.8.1

following &lt;denchmark-link:https://www.alluxio.org/docs/1.8/en/advanced/Alluxio-Storage-Management.html#single-tier-storage&gt;https://www.alluxio.org/docs/1.8/en/advanced/Alluxio-Storage-Management.html#single-tier-storage&lt;/denchmark-link&gt;

config below in alluxio-site.properties
alluxio.worker.memory.size=16GB
alluxio.worker.tieredstore.level0.dirs.path=/mnt/ramdisk,/home/hdd
alluxio.worker.tieredstore.level0.dirs.quota=16GB,200GB
but the worker create below ramfs mount point

the comma is as part of directory name of 
To Reproduce
config as above and start worker

working consistent with doc
&lt;denchmark-link:https://www.alluxio.org/docs/1.8/en/advanced/Alluxio-Storage-Management.html#single-tier-storage&gt;https://www.alluxio.org/docs/1.8/en/advanced/Alluxio-Storage-Management.html#single-tier-storage&lt;/denchmark-link&gt;

Urgency
intermediate
Additional context
N/A
	</description>
	<comments>
		<comment id='1' author='perrywang' date='2019-04-04T19:49:31Z'>
		&lt;denchmark-link:https://github.com/perrywang&gt;@perrywang&lt;/denchmark-link&gt;
 thanks for reporting this. I tried it out locally and I can reproduce the problem.
There is a check in the start script which reads  and checks that the path exists or the worker will try to mount it. To work around the issue, you can mount the ramdisk beforehand, then start the worker with . For this to work, comment out this check in :
&lt;denchmark-link:https://github.com/Alluxio/alluxio/blob/branch-1.8/bin/alluxio-start.sh#L109&gt;https://github.com/Alluxio/alluxio/blob/branch-1.8/bin/alluxio-start.sh#L109&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='perrywang' date='2019-04-05T09:00:28Z'>
		
@perrywang thanks for reporting this. I tried it out locally and I can reproduce the problem.
There is a check in the start script which reads level0.dirs.path and checks that the path exists or the worker will try to mount it. To work around the issue, you can mount the ramdisk beforehand, then start the worker with bin/alluxio-start.sh worker NoMount. For this to work, comment out this check in alluxio-start.sh:
https://github.com/Alluxio/alluxio/blob/branch-1.8/bin/alluxio-start.sh#L109

I can manually mount ramfs but workaround is not working because NoMount will ignore /home/hdd
		</comment>
		<comment id='3' author='perrywang' date='2019-04-05T18:13:14Z'>
		&lt;denchmark-link:https://github.com/perrywang&gt;@perrywang&lt;/denchmark-link&gt;
 I tried it out locally with this configuration:
&lt;denchmark-code&gt;alluxio.master.hostname=localhost
alluxio.worker.tieredstore.level0.dirs.path=/Volumes/ramdisk,/Users/andrew/hdd
alluxio.worker.tieredstore.level0.dirs.quota=2GB,10GB
&lt;/denchmark-code&gt;

When I write a 10GB file, it puts most of the blocks under /Users/andrew/hdd, and the rest under /Volumes/ramdisk. The alluxio.worker.allocator.class property controls the policy for where to write blocks among the storage tiers.
		</comment>
		<comment id='4' author='perrywang' date='2019-04-06T03:24:38Z'>
		&lt;denchmark-link:https://github.com/aaudiber&gt;@aaudiber&lt;/denchmark-link&gt;
 I will try your test
		</comment>
		<comment id='5' author='perrywang' date='2019-04-08T03:49:17Z'>
		
alluxio.master.hostname=localhost
alluxio.worker.tieredstore.level0.dirs.path=/Volumes/ramdisk,/Users/andrew/hdd
alluxio.worker.tieredstore.level0.dirs.quota=2GB,10GB

&lt;denchmark-link:https://github.com/aaudiber&gt;@aaudiber&lt;/denchmark-link&gt;
 I test below configurations
alluxio.master.hostname=localhost
alluxio.worker.tieredstore.level0.dirs.path=/mnt/ramdisk,/mnt/hdd
alluxio.worker.tieredstore.level0.dirs.quota=1GB,10GB
I pre manually mount ramdisk with command

mount -t ramfs -o size=1GB ramfs /mnt/ramdisk
comment out you mentioned mount check in alluxio-start.sh
run alluxio-start.sh worker NoMount
add some files to alluxio.
result is all the blocks existing under /mnt/hdd but no blocks in /mnt/ramdisk. It is different with you mentioned there are some blocks can be assign under /mnt/ramdisk

		</comment>
		<comment id='6' author='perrywang' date='2019-04-08T04:24:05Z'>
		&lt;denchmark-link:https://github.com/aaudiber&gt;@aaudiber&lt;/denchmark-link&gt;

I find another fact that after the size of files over /mnt/hdd quote, in this case 10G, the new block is indeed allocated at /mnt/ramdisk. So alluxio is prefer to use hdd as lower storage? Need a behavior confirm to explain. If alluxio prefer hdd is it will affect IO performance? Is it because default MaxFreeAllocator class resulting this behavior?
		</comment>
		<comment id='7' author='perrywang' date='2019-04-08T17:43:21Z'>
		&lt;denchmark-link:https://github.com/perrywang&gt;@perrywang&lt;/denchmark-link&gt;
 yes, MaxFreeAllocator will use whichever directory has the most space available. Since the hdd dir is much bigger than the ramdisk, all blocks will go to the hdd until they have the same amount of space left. To prioritize using the ramdisk, try setting  instead of the default
		</comment>
		<comment id='8' author='perrywang' date='2019-04-09T02:35:51Z'>
		
@perrywang yes, MaxFreeAllocator will use whichever directory has the most space available. Since the hdd dir is much bigger than the ramdisk, all blocks will go to the hdd until they have the same amount of space left. To prioritize using the ramdisk, try setting alluxio.worker.allocator.class=alluxio.worker.block.allocator.GreedyAllocator instead of the default

&lt;denchmark-link:https://github.com/aaudiber&gt;@aaudiber&lt;/denchmark-link&gt;
 I have applied GreedyAllocator in an environment. After run a IO intensive jobï¼Œthere is a warning in worker log

And after checking ramdisk with I found it is used over its quote a little bit. I set quote is 13GB, and  show it used 14G. Is this warning related with this ?
		</comment>
		<comment id='9' author='perrywang' date='2020-11-20T20:09:39Z'>
		Addressed by &lt;denchmark-link:https://github.com/Alluxio/alluxio/pull/12182&gt;#12182&lt;/denchmark-link&gt;

		</comment>
		<comment id='10' author='perrywang' date='2020-11-25T19:20:36Z'>
		A test is added &lt;denchmark-link:https://github.com/Alluxio/alluxio/pull/11743&gt;#11743&lt;/denchmark-link&gt;
 to enforce this case working
		</comment>
	</comments>
</bug>