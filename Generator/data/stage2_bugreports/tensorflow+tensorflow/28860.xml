<bug id='28860' author='lgeiger' open_date='2019-05-20T14:05:28Z' closed_time='2019-07-24T16:30:54Z'>
	<summary>tf.data.Dataset::cache files are twice the size compared to original records</summary>
	<description>
System information

Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes
OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04
TensorFlow installed from (source or binary): binary
TensorFlow version (use command below): 1.13.1 / 1.14.1-dev / 2.0.0-nightly
Python version: 3.7.3
CUDA/cuDNN version: -
GPU model and memory: -

Describe the current behavior
Files generated by tf.data.Dataset::cache consume considerably more disk space than the original TFRecord files. E.g. MNIST from tensorflow_datasets uses 21MB split into 10 files.  tf.data.Dataset::cache generates a single file with size 45MB.
Is there a specific reason why tf.data.Dataset::cache files use a lot more disk space and don't split the files into chunks?
This might be acceptable for MNIST size datasets but when using ImageNet tf.data.Dataset::cache will create a single cache file with well above 350GB vs 144GB of original TFRecords.
Describe the expected behavior
tf.data.Dataset::cache should produce a similar file compared to the input TFRecord files.
Code to reproduce the issue
import tensorflow as tf 
import tensorflow_datasets as tfds 

tf.enable_eager_execution() # if version 1.x

data = tfds.load("mnist", split=tfds.Split.TRAIN) 
cached = data.cache("cache/mnist").shuffle(100).repeat().batch(128) 
 
for feat in cached: 
    print("iterating")
Other info / logs
Original TFRecords:
$ ll tensorflow_datasets/mnist/1.0.0/
total 50008
drwxr-xr-x  15 lukasgeiger  staff   480B Mar 26 00:23 .
drwxr-xr-x   3 lukasgeiger  staff    96B Mar 26 00:23 ..
-rw-r--r--@  1 lukasgeiger  staff   2.0K Mar 26 00:23 dataset_info.json
-rw-r--r--   1 lukasgeiger  staff    48B Mar 26 00:23 image.image.json
-rw-r--r--   1 lukasgeiger  staff   3.2M Mar 26 00:23 mnist-test.tfrecord-00000-of-00001
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00000-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00001-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00002-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00003-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00004-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00005-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00006-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00007-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00008-of-00010
-rw-r--r--   1 lukasgeiger  staff   1.9M Mar 26 00:23 mnist-train.tfrecord-00009-of-00010
Cached TFRecords:
$ ll cache/
total 100960
drwxr-xr-x    4 lukasgeiger  staff   128B May 20 09:45 .
drwxr-xr-x@ 113 lukasgeiger  staff   3.5K May 20 10:14 ..
-rw-r--r--    1 lukasgeiger  staff    45M May 20 09:45 mnist.data-00000-of-00001
-rw-r--r--    1 lukasgeiger  staff   3.2M May 20 09:45 mnist.index
	</description>
	<comments>
		<comment id='1' author='lgeiger' date='2019-07-24T16:30:54Z'>
		This is actually not a bug in  but rather a limitation of TensorFlow Datasets. With TensorFlow Datasets version 1.1.0 this can be mitigated by skipping the internal decoding and caching the encoded version of the dataset. For more information see &lt;denchmark-link:https://github.com/tensorflow/datasets/blob/master/docs/decode.md#filtershuffle-dataset-before-images-get-decoded&gt;https://github.com/tensorflow/datasets/blob/master/docs/decode.md#filtershuffle-dataset-before-images-get-decoded&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='lgeiger' date='2019-07-24T16:30:55Z'>
		Are you satisfied with the resolution of your issue?
&lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&amp;entry.2137816233=28860&gt;Yes&lt;/denchmark-link&gt;

&lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&amp;entry.2137816233=28860&gt;No&lt;/denchmark-link&gt;

		</comment>
	</comments>
</bug>