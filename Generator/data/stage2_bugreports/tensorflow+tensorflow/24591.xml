<bug id='24591' author='burui11087' open_date='2018-12-27T02:46:06Z' closed_time='2020-01-09T22:17:05Z'>
	<summary>list index out of range in freeze_graph.py</summary>
	<description>
System information

Have I written custom code (as opposed to using a stock example script provided in TensorFlow):NO
OS Platform and Distribution (e.g., Linux Ubuntu 16.04):Linux Ubuntu 16.04.5
Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:No
TensorFlow installed from (source or binary):binary
TensorFlow version (use command below):1.12.0
Python version:3.5.2
Bazel version (if compiling from source):
GCC/Compiler version (if compiling from source):
CUDA/cuDNN version:9.0/7.0
GPU model and memory:GTX 1080 11GB

Describe the current behavior
I try to freeze graph generated by tf.esitimator. esitimator will generate *.pbtxt and ckpt file automatically, so I use following command:
python freeze_graph.py --input_graph=path/to/.pbtxt --input_checkpoint=path/to/model.ckpt-0 --output_graph=path/to/saved/.pb --output_node_name=OutPutOp
Other info / logs
Traceback (most recent call last): File "model_freeze.py", line 494, in &lt;module&gt; run_main() File "model_freeze.py", line 490, in run_main app.run(main=my_main, argv=[sys.argv[0]] + unparsed) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/platform/app.py", line 125, in run _sys.exit(main(argv)) File "model_freeze.py", line 489, in &lt;lambda&gt; my_main = lambda unused_args: main(unused_args, flags) File "model_freeze.py", line 382, in main flags.saved_model_tags, checkpoint_version) File "model_freeze.py", line 364, in freeze_graph checkpoint_version=checkpoint_version) File "model_freeze.py", line 191, in freeze_graph_with_def_protos var_list=var_list, write_version=checkpoint_version) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1102, in __init__ self.build() File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1114, in build self._build(self._filename, build_save=True, build_restore=True) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1151, in _build build_save=build_save, build_restore=build_restore) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 773, in _build_internal saveables = self._ValidateAndSliceInputs(names_to_saveables) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 680, in _ValidateAndSliceInputs for converted_saveable_object in self.SaveableObjectsForOp(op, name): File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 654, in SaveableObjectsForOp variable, "", name) File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 128, in __init__ self.handle_op = var.op.inputs[0] File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/framework/ops.py", line 2128, in __getitem__ return self._inputs[i] IndexError: list index out of range 
	</description>
	<comments>
		<comment id='1' author='burui11087' date='2019-01-05T01:22:27Z'>
		&lt;denchmark-link:https://github.com/burui11087&gt;@burui11087&lt;/denchmark-link&gt;
,
Could you provide a code to reproduce the issue to find root-cause of the issue?
Thank you
		</comment>
		<comment id='2' author='burui11087' date='2019-01-11T01:13:21Z'>
		&lt;denchmark-link:https://github.com/jvishnuvardhan&gt;@jvishnuvardhan&lt;/denchmark-link&gt;
 Thank you for checking on this.  It links to couple other issues &lt;denchmark-link:https://github.com/tensorflow/tensorflow/issues/22029&gt;#22029&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/tensorflow/tensorflow/pull/5387&gt;#5387&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/tensorflow/tensorflow/issues/4363&gt;#4363&lt;/denchmark-link&gt;

Here I provides a minimal code using tf hub:
import tensorflow as tf
import tensorflow_hub as hub

module = hub.Module("https://tfhub.dev/google/imagenet/resnet_v2_50/classification/1")
saver = tf.train.Saver()
with tf.Session() as sess:
    sess.run(tf.global_variables_initializer())
    tf.train.write_graph(sess.graph, "resnet", "model.pb", as_text=False)
    saver.save(sess,'resnet/model')
Then I encountered the IndexError as I run
python -m tensorflow.python.tools.freeze_graph --input_graph=resnet/model.pb --input_checkpoint=resnet/model --output_graph=resnet/frozen_graph.pb --output_node_names=module/resnet_v2_50/predictions/Reshape_1  --input_binary
At the same time, i have successfully frozen a plain-vanilla single layer CNN.  Could you point some directions to check?
Thanks!
		</comment>
		<comment id='3' author='burui11087' date='2019-03-16T00:08:20Z'>
		I have the same problem when using keras advanced layers.
		</comment>
		<comment id='4' author='burui11087' date='2019-03-21T12:46:39Z'>
		same here.
		</comment>
		<comment id='5' author='burui11087' date='2019-04-09T23:12:17Z'>
		Encountered the same error while freezing transformer from tensorflow official models
		</comment>
		<comment id='6' author='burui11087' date='2019-05-01T20:36:04Z'>
		I'm getting the same error on a keras implementation of yolo.
The error occurs in __init__ of a ResourceVariableSaveable when trying to access var.op.inputs[0] on a tensor:
&lt;denchmark-code&gt;Tensor("batch_normalization_1/beta:0", shape=(), dtype=resource)
&lt;/denchmark-code&gt;

op is a "VarHandleOp" and var.op.inputs is a tensorflow.python.framework.ops.Operation._InputList object.
The input list in this case is empty. Does the resource variable have to have an input? What should handle_op be in this case?
Any suggestions for how to proceed?
		</comment>
		<comment id='7' author='burui11087' date='2019-05-02T18:42:29Z'>
		&lt;denchmark-link:https://github.com/stevehawley&gt;@stevehawley&lt;/denchmark-link&gt;
  - have you tried with the tf.keras rather than the native keras?
		</comment>
		<comment id='8' author='burui11087' date='2019-05-02T18:58:27Z'>
		&lt;denchmark-link:https://github.com/jiayiliu&gt;@jiayiliu&lt;/denchmark-link&gt;
 - yes, I am using the internal .
My workaround has been to use tf.saved_model.simple_save instead of a Saver and have freeze_graph use input_saved_model_dir.
It gets me past this problem but I don't consider the issue resolved. If freeze_graph is not going to support working on normal graphs it should deprecate that api and update the docs, or at least put a note that for keras models you have to used saved_model.
		</comment>
		<comment id='9' author='burui11087' date='2019-05-03T20:24:53Z'>
		Thanks for sharing the workaround &lt;denchmark-link:https://github.com/stevehawley&gt;@stevehawley&lt;/denchmark-link&gt;
 .  I agree with you that the problem is not solved, especially the  is marked as DEPRECATED in the documentation.   I switched to keras.applications rather than using the tf.hub.
		</comment>
		<comment id='10' author='burui11087' date='2019-05-06T08:17:36Z'>
		Unclear why this was assigned to me. TensorFlow Hub was used to produce a failing case, but IIUC the issue exists even without using hub.
		</comment>
		<comment id='11' author='burui11087' date='2019-06-10T18:40:40Z'>
		I am hitting this same problem too.
Is there any updates ?
Is freeze_graph.py still officially supported ?
Is there an alternative way of generating a protobuf out of a tf.graph ?
		</comment>
		<comment id='12' author='burui11087' date='2019-06-14T08:48:05Z'>
		I also meet this porblem when using mnasnet and efficientnet to freeze, where I download models from tensorflow/tpu models: &lt;denchmark-link:https://github.com/tensorflow/tpu/tree/master/models/official&gt;https://github.com/tensorflow/tpu/tree/master/models/official&lt;/denchmark-link&gt;
. I use tensorflow 1.11.0 and I have checked my input/output node names which are right.
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/tools/freeze_graph.py", line 363, in freeze_graph
checkpoint_version=checkpoint_version)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/tools/freeze_graph.py", line 190, in freeze_graph_with_def_protos
var_list=var_list, write_version=checkpoint_version)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1094, in init
self.build()
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1106, in build
self._build(self._filename, build_save=True, build_restore=True)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 1143, in _build
build_save=build_save, build_restore=build_restore)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 765, in _build_internal
saveables = self._ValidateAndSliceInputs(names_to_saveables)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 672, in _ValidateAndSliceInputs
for converted_saveable_object in self.SaveableObjectsForOp(op, name):
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 646, in SaveableObjectsForOp
variable, "", name)
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/training/saver.py", line 128, in init
self.handle_op = var.op.inputs[0]
File "/usr/local/lib/python3.5/dist-packages/tensorflow/python/framework/ops.py", line 2126, in getitem
return self._inputs[i]
IndexError: list index out of range
Can any one help me? Thx!
		</comment>
		<comment id='13' author='burui11087' date='2019-06-14T22:04:45Z'>
		I got same issue. Here is the &lt;denchmark-link:https://gist.github.com/thepulkitagarwal/36bc45aa43ae43f83baa5111a89be73e#file-freezekerasmodel-py.&gt;actual script&lt;/denchmark-link&gt;
 help me to freeze the model. Note that you need to modify the output node name manually.  And I successfully loaded the frozen model onto android.
		</comment>
		<comment id='14' author='burui11087' date='2019-06-26T06:16:17Z'>
		I get the same issue when I try to freeze the bidirectional LSTM network from tensor2tensor (&lt;denchmark-link:https://github.com/tensorflow/tensor2tensor/blob/v.1.12.0/tensor2tensor/models/lstm.py&gt;https://github.com/tensorflow/tensor2tensor/blob/v.1.12.0/tensor2tensor/models/lstm.py&lt;/denchmark-link&gt;
).
		</comment>
		<comment id='15' author='burui11087' date='2019-07-25T20:27:24Z'>
		I managed to freeze my tensorflow model with tf.keras layers in it by using tf.SavedModel in conjuntion with freeze_graph.freeze_graph_with_def_protos. Below is a generic snippet to convert a tf.keras based tensorflow checkpoint into a frozen checkpoint.
I am working in tensorflow==1.13.1
&lt;denchmark-code&gt;&lt;create evaluation graph/model here&gt;

export_dir = &lt;SavedModel serving dir&gt;
with &lt;eval_graph&gt;.as_default() as graph:
    saver = tf.train.Saver()
    init_op = tf.global_variables_initializer()
    
    with tf.Session(graph=graph) as sess:
        sess.run(init_op)
        saver.restore(sess, &lt;checkpoint_path&gt;)

        builder = tf.saved_model.Builder(export_dir)
        builder.add_meta_graph_and_variables(sess,
            [tf.saved_model.tag_constants.SERVING],
            strip_default_attrs=True)
    builder.save()

    from tensorflow.python.tools import freeze_graph
    freeze_graph.freeze_graph_with_def_protos(
        ...
        input_saved_model_dir=export_dir,
        saved_model_tags=[tf.saved_model.tag_constants.SERVING]
    )
&lt;/denchmark-code&gt;

I was able to freeze a SSD model with Keras mobilenet V2 feature extractor from &lt;denchmark-link:https://github.com/tensorflow/models/blob/master/research/object_detection/models/ssd_mobilenet_v2_keras_feature_extractor.py&gt;tensorflow_models&lt;/denchmark-link&gt;

		</comment>
		<comment id='16' author='burui11087' date='2019-10-18T16:22:38Z'>
		&lt;denchmark-link:https://github.com/ymodak&gt;@ymodak&lt;/denchmark-link&gt;
 Should we expect any further updates to graph freezing? freeze_graph.py is still in master. Tensorflow has moved to Keras and the incompatibility should probably be either documented or fixed.
		</comment>
		<comment id='17' author='burui11087' date='2020-01-09T22:17:05Z'>
		Please test with the latest version of tensorflow for using freeze_graph tool.
Thanks!
		</comment>
		<comment id='18' author='burui11087' date='2020-01-09T22:17:07Z'>
		Are you satisfied with the resolution of your issue?
&lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=Yes&amp;entry.2137816233=https://github.com/tensorflow/tensorflow/issues/24591&gt;Yes&lt;/denchmark-link&gt;

&lt;denchmark-link:https://docs.google.com/forms/d/e/1FAIpQLSfaP12TRhd9xSxjXZjcZFNXPGk4kc1-qMdv3gc6bEP90vY1ew/viewform?entry.85265664=No&amp;entry.2137816233=https://github.com/tensorflow/tensorflow/issues/24591&gt;No&lt;/denchmark-link&gt;

		</comment>
		<comment id='19' author='burui11087' date='2020-03-27T14:51:38Z'>
		I believe this is still not working with the latest version of tensorflow 2.1.0. The error becomes: 
&lt;denchmark-link:https://github.com/ymodak&gt;@ymodak&lt;/denchmark-link&gt;
 Any updates on this?
The full stack error is:
&lt;denchmark-code&gt; File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 491, in &lt;module&gt;
    run_main()
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 487, in run_main
    app.run(main=my_main, argv=[sys.argv[0]] + unparsed)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/platform/app.py", line 40, in run
    _run(main=main, argv=argv, flags_parser=_parse_flags_tolerate_undef)
  File "/path/to/python3.6/site-packages/absl/app.py", line 300, in run
    _run_main(main, args)
  File "/path/to/python3.6/site-packages/absl/app.py", line 251, in _run_main
    sys.exit(main(argv))
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 486, in &lt;lambda&gt;
    my_main = lambda unused_args: main(unused_args, flags)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 378, in main
    flags.saved_model_tags, checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 361, in freeze_graph
    checkpoint_version=checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 190, in freeze_graph_with_def_protos
    var_list=var_list, write_version=checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 828, in __init__
    self.build()
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 840, in build
    self._build(self._filename, build_save=True, build_restore=True)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 878, in _build
    build_restore=build_restore)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 482, in _build_internal
    names_to_saveables)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 349, in validate_and_slice_inputs
    for converted_saveable_object in saveable_objects_for_op(op, name):
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 210, in saveable_objects_for_op
    variable, "", name)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 84, in __init__
    self.handle_op = var.op.inputs[0]
IndexError: tuple index out of range
&lt;/denchmark-code&gt;

		</comment>
		<comment id='20' author='burui11087' date='2020-04-28T10:35:42Z'>
		
I believe this is still not working with the latest version of tensorflow 2.1.0. The error becomes: self.handle_op = var.op.inputs[0] IndexError: tuple index out of range
@ymodak Any updates on this?
The full stack error is:
 File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 491, in &lt;module&gt;
    run_main()
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 487, in run_main
    app.run(main=my_main, argv=[sys.argv[0]] + unparsed)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/platform/app.py", line 40, in run
    _run(main=main, argv=argv, flags_parser=_parse_flags_tolerate_undef)
  File "/path/to/python3.6/site-packages/absl/app.py", line 300, in run
    _run_main(main, args)
  File "/path/to/python3.6/site-packages/absl/app.py", line 251, in _run_main
    sys.exit(main(argv))
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 486, in &lt;lambda&gt;
    my_main = lambda unused_args: main(unused_args, flags)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 378, in main
    flags.saved_model_tags, checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 361, in freeze_graph
    checkpoint_version=checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/tools/freeze_graph.py", line 190, in freeze_graph_with_def_protos
    var_list=var_list, write_version=checkpoint_version)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 828, in __init__
    self.build()
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 840, in build
    self._build(self._filename, build_save=True, build_restore=True)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 878, in _build
    build_restore=build_restore)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saver.py", line 482, in _build_internal
    names_to_saveables)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 349, in validate_and_slice_inputs
    for converted_saveable_object in saveable_objects_for_op(op, name):
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 210, in saveable_objects_for_op
    variable, "", name)
  File "/path/to/python3.6/site-packages/tensorflow_core/python/training/saving/saveable_object_util.py", line 84, in __init__
    self.handle_op = var.op.inputs[0]
IndexError: tuple index out of range


Do you have any progress？I have the same problem.
		</comment>
		<comment id='21' author='burui11087' date='2020-05-23T21:27:32Z'>
		Same here. Tensorflow 2.1.0 and keras 2.3.1.
		</comment>
		<comment id='22' author='burui11087' date='2020-05-26T11:04:56Z'>
		&lt;denchmark-link:https://github.com/cmehrshad&gt;@cmehrshad&lt;/denchmark-link&gt;
 Maybe because of TF2.x use resource variables by default. My job is make export_inference_graph.py working in TF_models/slim/ with TF2.x. Then I try print var_list.value before the code line :, the tensor like 'shape=(), dtype=resource' . when I use , error occurs  . so I haven't any solution now.
		</comment>
		<comment id='23' author='burui11087' date='2020-06-11T11:29:32Z'>
		I guess the main reason is because of the use of keras，i change “tf.keras.layers.BatchNormalization ” to "tf.layers.batch_normalization"，and the freeze_graph is work.
		</comment>
		<comment id='24' author='burui11087' date='2020-06-17T08:36:42Z'>
		Any updates on this?
I have the exact same callstack as &lt;denchmark-link:https://github.com/qipengh&gt;@qipengh&lt;/denchmark-link&gt;
.
Any updates on the issue? &lt;denchmark-link:https://github.com/ymodak&gt;@ymodak&lt;/denchmark-link&gt;

		</comment>
		<comment id='25' author='burui11087' date='2020-06-30T17:18:02Z'>
		Same here. Tensorflow 2.2.0
		</comment>
		<comment id='26' author='burui11087' date='2020-07-10T12:19:12Z'>
		Is it fixed? Same here : Tensorflow 2.2
		</comment>
	</comments>
</bug>