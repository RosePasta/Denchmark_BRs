<bug id='1036' author='gregd33' open_date='2020-08-27T15:28:43Z' closed_time='2020-09-13T07:05:27Z'>
	<summary>Pip args in Dockerfile not exposed via containerize command</summary>
	<description>
Describe the bug
I believe this is a bug, but I might just be missing how to properly use the containerize functionality.
The Dockerfile generated by &lt;denchmark-link:https://github.com/bentoml/BentoML/blob/master/bentoml/clipper/__init__.py#L97&gt;https://github.com/bentoml/BentoML/blob/master/bentoml/clipper/__init__.py#L97&lt;/denchmark-link&gt;
 includes two args for PIP repos. However, the containerize  functionality doesn't seem to expose these arguments. The problem is that this will override other pip config in the image (e.g. if I build on a base image that has pip configured with repos I want, these environment variables will override it).
So the containerize function essentially forces the default pip repo.
To Reproduce
Steps to reproduce the behavior:

Use a base image with a custom pip config other than the default
Build a service with this image and containerize

Expected behavior
Your pip config will be be ignored in favour of the default args in the Dockerfile
(logging.DEBUG)
Additional context
This is mostly relevant when building in environments without access to the main pypi repo
Potential fix
Either add args specifically for the PIP build args or allow for an arbitrary list of build args.
	</description>
	<comments>
		<comment id='1' author='gregd33' date='2020-08-27T20:39:31Z'>
		Hey &lt;denchmark-link:https://github.com/gregd33&gt;@gregd33&lt;/denchmark-link&gt;
, thanks for reporting this. Indeed the following line in the generated docker image will override your PyPI config in the base image, and it requires the user to specify the build args again, which is not necessary if it is already specified in the docker base image.
&lt;denchmark-code&gt;ARG PIP_INDEX_URL=https://pypi.python.org/simple/
ARG PIP_TRUSTED_HOST=pypi.python.org
ENV PIP_INDEX_URL $PIP_INDEX_URL
ENV PIP_TRUSTED_HOST $PIP_TRUSTED_HOST
&lt;/denchmark-code&gt;

On a side note, the dockerfile is actually generated from: &lt;denchmark-link:https://github.com/bentoml/BentoML/blob/v0.8.6/bentoml/saved_bundle/templates.py#L79&gt;https://github.com/bentoml/BentoML/blob/v0.8.6/bentoml/saved_bundle/templates.py#L79&lt;/denchmark-link&gt;
 and it is similar to the clipper base image you've pointed to.
We are thinking about making the pip_index_url and pip_trusted_host as two additional arguments passed to the @env decorator, e.g.:
@env(
  auto_pip_dependencies=True,
  pip_index_url='my_pypi_host_url',
  pip_trusted_host='my_pypi_host_url'
)
@artifacts([SklearnModelArtifact('model')])
class IrisClassifier(BentoService):
  ...
This will allow us to move the logic of applying PyPI config from bash script bentoml-init.sh, and avoid the overriding issue.
And yes the suggestion to add arbitrarily --build-args to the bentoml containerize command and pass it down to the docker build API call internally also makes a lot of sense and can be very useful for other build-args provided by the custom docker base image.
As a workaround, for now, you can always build a docker image with the docker build command with the saved bundle directory and pass the --build-arg  to avoid overriding with the default:
docker build --build-arg PIP_INDEX_URL=http://127.0.0.1:8000/pypi --build-arg PIP_TRUSTED_HOST=127.0.0.1:8000 -t myimage:v1  $saved_path 
		</comment>
		<comment id='2' author='gregd33' date='2020-08-28T17:46:42Z'>
		&lt;denchmark-link:https://github.com/parano&gt;@parano&lt;/denchmark-link&gt;
 - thanks, putting them in  makes a lot of sense and would work perfectly.
And thanks for the workaround - that's what I had been doing so far.  But in a long run, being able to use the containerize command would be ideal.
		</comment>
		<comment id='3' author='gregd33' date='2020-09-06T14:16:21Z'>
		&lt;denchmark-link:https://github.com/parano&gt;@parano&lt;/denchmark-link&gt;
 , can you also consider adding  as a list? this will allow users to use a private PyPI for a subset of the packages
		</comment>
		<comment id='4' author='gregd33' date='2020-09-07T08:10:23Z'>
		&lt;denchmark-link:https://github.com/danield137&gt;@danield137&lt;/denchmark-link&gt;
 didn't know that option exists, thanks for the suggestion! we should definitely add that!
		</comment>
		<comment id='5' author='gregd33' date='2020-09-07T08:15:50Z'>
		&lt;denchmark-link:https://github.com/parano&gt;@parano&lt;/denchmark-link&gt;
 didn't know too until I had to use it 
		</comment>
		<comment id='6' author='gregd33' date='2020-09-13T07:05:27Z'>
		Both the original issue and the proposal on adding extra pip index parameters are added in PR &lt;denchmark-link:https://github.com/bentoml/BentoML/pull/1084&gt;#1084&lt;/denchmark-link&gt;

It will be available in the next release 0.9.0
		</comment>
	</comments>
</bug>