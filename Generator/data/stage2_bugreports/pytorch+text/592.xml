<bug id='592' author='wpfnlp' open_date='2019-08-21T13:23:44Z' closed_time='2019-09-03T14:27:25Z'>
	<summary>arr = [[self.vocab.stoi[x] for x in ex] for ex in arr] KeyError: None</summary>
	<description>
torchtext=0.4.0 BUG:
Traceback (most recent call last):
File "/Users/weipengfei/workspaces/FastNLPProjects/research01/Intent+SlotFilling01.py", line 112, in 
for i, batch in enumerate(train_iter):
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/iterator.py", line 156, in iter
yield Batch(minibatch, self.dataset, self.device)
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/batch.py", line 34, in init
setattr(self, name, field.process(batch, device=device))
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/field.py", line 237, in process
tensor = self.numericalize(padded, device=device)
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/field.py", line 336, in numericalize
arr = [[self.vocab.stoi[x] for x in ex] for ex in arr]
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/field.py", line 336, in 
arr = [[self.vocab.stoi[x] for x in ex] for ex in arr]
File "/miniconda3/lib/python3.7/site-packages/torchtext/data/field.py", line 336, in 
arr = [[self.vocab.stoi[x] for x in ex] for ex in arr]
KeyError: None
The same code torchtext=0.3.1 No problem, please tell me what caused it, thank you.
	</description>
	<comments>
		<comment id='1' author='wpfnlp' date='2019-08-21T13:53:13Z'>
		Can you post your script so I could reproduce the case?
		</comment>
		<comment id='2' author='wpfnlp' date='2019-09-03T14:27:44Z'>
		Feel free to re-open the issue if you still have questions.
		</comment>
		<comment id='3' author='wpfnlp' date='2019-10-11T02:29:17Z'>
		I come across the same issue, and it only happen when I define my own unk_token and set min_freq &gt;1 at the same time.
here's the code I use:
SRC = data.Field(lower=True, unk_token="my_unk_token")
TGT = data.Field(lower=True)
train, val, test = datasets.IWSLT.splits(exts=('.de', '.en'), fields=(SRC, TGT))
SRC.build_vocab(train, min_freq=10)
train_iter = data.BucketIterator(dataset=train, batch_size=64,
sort_key=lambda x: data.interleave_keys(len(x.src), len(x.trg)))
batch = next(iter(train_iter))
		</comment>
		<comment id='4' author='wpfnlp' date='2020-06-02T20:50:49Z'>
		I am still getting this issue. As &lt;denchmark-link:https://github.com/TinaChen95&gt;@TinaChen95&lt;/denchmark-link&gt;
 mentioned, min_freq set to 1 works fine. when min_freq &gt; 2, build_vocab(..) builds vocab as per min_freq, but KeyError is thrown while iterating over BucketIterator.
		</comment>
		<comment id='5' author='wpfnlp' date='2020-06-02T21:42:44Z'>
		I think so at least for the issue I am facing I figured out that  needs to be passed in ReversibleField constructor even if you want to use default unk_token. That is because ReversibleField uses  as unk_token, while in Vocab we have  as unk_token. Since there is already open bug &lt;denchmark-link:https://github.com/pytorch/text/issues/706&gt;#706&lt;/denchmark-link&gt;
 so customization is not possible atm.
		</comment>
	</comments>
</bug>