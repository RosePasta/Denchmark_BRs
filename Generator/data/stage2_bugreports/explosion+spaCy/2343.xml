<bug id='2343' author='makcedward' open_date='2018-05-18T20:54:16Z' closed_time='2018-12-10T12:39:55Z'>
	<summary>Using spaCy without GPU but installed cupy</summary>
	<description>
We have a image of VM installed lots of library for both CPU and GPU machine. When invoking
&lt;denchmark-code&gt;nlp = spacy.load('en')
article = 'test test test'
nlp(article)
&lt;/denchmark-code&gt;

It got
&lt;denchmark-code&gt;CUDARuntimeError                          Traceback (most recent call last)
&lt;ipython-input-33-8816fd999472&gt; in &lt;module&gt;()
----&gt; 1 device = cupy.cuda.device.Device(None)
      2 device.use()
      3 # Model.ops = CupyOps()
      4 # Model.Ops = CupyOps

cupy/cuda/device.pyx in cupy.cuda.device.Device.__init__()

cupy/cuda/runtime.pyx in cupy.cuda.runtime.getDevice()

cupy/cuda/runtime.pyx in cupy.cuda.runtime.check_status()

CUDARuntimeError: cudaErrorUnknown: unknown error
&lt;/denchmark-code&gt;

Checked use_gpu function, it seems that spaCy treat the machine has GPU if able to import cupy library. Suggesting that adding a optional parameter to force using cpu.
Current workaround is uninstall cupy library.
&lt;denchmark-code&gt;def use_gpu(gpu_id):
    try:
        import cupy.cuda.device
    except ImportError:
        return None
    from thinc.neural.ops import CupyOps
    device = cupy.cuda.device.Device(gpu_id)
    device.use()
    Model.ops = CupyOps()
    Model.Ops = CupyOps
    return device
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='makcedward' date='2018-05-19T23:38:38Z'>
		Thanks, will fix.
		</comment>
		<comment id='2' author='makcedward' date='2018-05-20T00:50:15Z'>
		Before applying the bug fix, I pull the master branch and executing test case but got several hundred failure. Seems like there is environment issue in my VM.  I give up to fix env in order to execute original test case.
Thank you for your help.
		</comment>
		<comment id='3' author='makcedward' date='2018-12-10T12:39:55Z'>
		I think this is resolved now, since we have the prefer_gpu() and require_gpu() helpers from Thinc.
		</comment>
		<comment id='4' author='makcedward' date='2019-01-09T13:12:42Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>