<bug id='3353' author='Apollo-XI' open_date='2019-03-04T11:23:44Z' closed_time='2019-03-10T10:46:29Z'>
	<summary>Segmentation fault 11 with two NER pipes in 2.0.18</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

Copy, paste and run the following code:
&lt;denchmark-code&gt;#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import spacy
from spacy.pipeline import EntityRecognizer

nlp = spacy.load('es')
_, ner = nlp.remove_pipe('ner')
ner_ser = ner.to_bytes()

ner = EntityRecognizer(nlp.vocab)
ner.from_bytes(ner_ser)
ner.add_label('label1')
ner.add_label('label2')

nlp.add_pipe(ner, name='ner_1')
ner = EntityRecognizer(nlp.vocab)
ner.from_bytes(ner_ser)
ner.add_label('label3')
ner.add_label('label4')

nlp.add_pipe(ner, name='ner_0', last=True)

text = """Apoyo en la gestión de la plataforma de formación online (eCampus MAPFRE).
Colaboración en el diseño de programas online.
Redactar informes y elaborar presentaciones de impacto.
Colaborar en las tareas administrativas propias del departamento.
Participación en las reuniones y videoconferencias del Área, con los equipos de RRHH de todos los países, en inglés y español.
"""

# Segmentation fault: 11
doc = nlp(text)
&lt;/denchmark-code&gt;

It produces "Bus error: 10" or the following message using python -q -X faulthandler spacy-bug.py:
&lt;denchmark-code&gt;Fatal Python error: Segmentation fault

Current thread 0x00007fffb23e4380 (most recent call first):
  File "/Users/vferrer/miniconda3/envs/spacy/lib/python3.7/site-packages/spacy/language.py", line 346 in __call__
  File "spacy-bug.py", line 32 in &lt;module&gt;
Segmentation fault: 11
&lt;/denchmark-code&gt;

Sometimes, it doesn't produce a segmentation fault. If you remove some sentences, it doesn't break.
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


Operating System: macOs High Sierra (10.13.4)
Python Version Used: Python 3.7.1 (installed with anaconda)
spaCy Version Used: 2.0.18
Environment Information:

This sound similar to &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3338&gt;#3338&lt;/denchmark-link&gt;
 and &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3345&gt;#3345&lt;/denchmark-link&gt;
 although happens in spacy stable and not in alpha.
	</description>
	<comments>
		<comment id='1' author='Apollo-XI' date='2019-03-05T12:30:21Z'>
		I am also seeing this issue in spacy stable. I've uploaded example code that produces the error here: &lt;denchmark-link:https://github.com/dado0583/JupyterNotebooks/blob/master/SpacyExamples/Bus10SegmentFault.py&gt;https://github.com/dado0583/JupyterNotebooks/blob/master/SpacyExamples/Bus10SegmentFault.py&lt;/denchmark-link&gt;
.
The difference with mine is that I am using a custom pipeline that is manually adding ents to the doc, instead of using a second EntityRecognizer.
For me there are two key observations:

If I add my custom pipe to the end of the pipeline, everything is okay. If I add it before the 'ner' pipeline it blows up.
If I disable doc.ents = new_tokens in my custom pipeline then everything is okay.

It seems like having doc.ents manually set before the EntityRecognizer gets its hands on the doc instance may be related to the issue. There are comments in the attached github file that will help guide my observations
&lt;denchmark-h:h3&gt;Environment:&lt;/denchmark-h&gt;

MacOS 10.9
Python: 3.6
Spacy: 2.0.18
		</comment>
		<comment id='2' author='Apollo-XI' date='2019-03-06T13:13:03Z'>
		Could you check that the error still occurs on spacy-nightly? I think we might have fixed this.
		</comment>
		<comment id='3' author='Apollo-XI' date='2019-03-10T10:46:29Z'>
		Merging with &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3345&gt;#3345&lt;/denchmark-link&gt;

		</comment>
		<comment id='4' author='Apollo-XI' date='2019-04-09T11:08:22Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>