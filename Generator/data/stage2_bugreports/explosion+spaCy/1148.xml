<bug id='1148' author='jofatmofn' open_date='2017-06-26T03:34:10Z' closed_time='2017-10-20T15:35:21Z'>
	<summary>One-off error with end index when OP "*" ending the pattern</summary>
	<description>
Not authorized to reopen 429, and hence creating a new issue.
&lt;denchmark-code&gt;    document = nlp(input_text)
  File "/usr/local/lib/python2.7/dist-packages/spacy/language.py", line 329, in __call__
    proc(doc)
  File "spacy/syntax/parser.pyx", line 214, in spacy.syntax.parser.Parser.__call__ (spacy/syntax/parser.cpp:7989)
    raise ParserStateError(tokens)
ParserStateError: Error analysing doc -- no valid actions available. This should never happen, so please report the error on the issue tracker. Here's the thread to do so --- reopen it if it's closed:
https://github.com/spacy-io/spaCy/issues/429
Please include the text that the parser failed on, which is:
u'Thanks, can you create a ticket again.'
&lt;/denchmark-code&gt;

This happens only if I add an acceptor. Pattern:
&lt;denchmark-code&gt;                        [
                                {TAG: "NN", 'OP': "*"},
                                {TAG: "RB", LOWER: "again"}
                        ]
&lt;/denchmark-code&gt;

Acceptor method:
&lt;denchmark-code&gt;        count = 0
        while (start + count &lt; end - 1):
                if doc[start + count].tag_ != "NN":
                        break
                count = count + 1
        return (ent_id, label, start, end - count - 1)
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='jofatmofn' date='2017-06-26T04:21:35Z'>
		That doesn't appear to be a bug in spaCy, but in my code. The additional -1s are not required. The corrected acceptor method is
&lt;denchmark-code&gt;        count = 0
        while (start + count &lt; end):
                if doc[start + count].tag_ != "NN":
                        break
                count = count + 1
        if count == 0:
                return False
        else:
                return (ent_id, label, start, start + count)
&lt;/denchmark-code&gt;

The reason I included that -1 is based on the experience with another pattern:
&lt;denchmark-code&gt;                        [
                                {TAG: "JJ", LOWER: "new"},
                                {TAG: "NN", 'OP': "*"}
                        ]

&lt;/denchmark-code&gt;

For the sentence
Could you create a new ticket for me?
spaCy is passing an additional token to the acceptor as
start = 4
end = 7 &lt;== Should be 6
doc[start:end].text = "new ticket for"
Is this a bug then?
		</comment>
		<comment id='2' author='jofatmofn' date='2017-07-19T02:50:44Z'>
		Please let me know if I need to create a separate issue for this.
		</comment>
		<comment id='3' author='jofatmofn' date='2017-10-20T15:35:21Z'>
		I think this was a bug in the v1 Matcher, that should be fixed in v2. Sorry I didn't get to this sooner --- thanks for the report!
		</comment>
		<comment id='4' author='jofatmofn' date='2017-10-23T06:25:33Z'>
		
Python version: 2.7.12
Platform: Linux-4.4.0-91-generic-x86_64-with-Ubuntu-16.04-xenial
spaCy version: 2.0.0a17
Models: en_core_web_sm-2.0.0a7

Tried the following code
&lt;denchmark-code&gt;import spacy
from spacy.matcher import Matcher
from spacy.attrs import *

def on_match_1(matcher, doc, id, matches):
        label, start, end = matches[id]
        print(label, start, end, doc[start:end])

nlp = spacy.load('en_core_web_sm')
matcher = Matcher(nlp.vocab)
matcher.add(
        "TSTEND",
        on_match_1,
        [
                {TAG: "JJ", LOWER: "new"},
                {TAG: "NN", 'OP': "*"}
        ]
)
document = nlp(u'Could you create a new ticket for me?')
matches = matcher(document)

&lt;/denchmark-code&gt;

and got the following output
(8454456681159448349L, 4, 7, new ticket for)
		</comment>
		<comment id='5' author='jofatmofn' date='2017-10-23T06:34:51Z'>
		Am unable to re-open the issue (&lt;denchmark-link:https://github.com/isaacs/github/issues/583&gt;isaacs/github#583&lt;/denchmark-link&gt;
) and hence leaving the current issue closed and opening a fresh one &lt;denchmark-link:https://github.com/explosion/spaCy/issues/1450&gt;#1450&lt;/denchmark-link&gt;
.
		</comment>
		<comment id='6' author='jofatmofn' date='2018-05-08T13:27:37Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>