<bug id='3469' author='tokestermw' open_date='2019-03-23T01:31:21Z' closed_time='2019-03-26T21:24:20Z'>
	<summary>`spacy pretrain` errors when trying to pretrain on a small dataset</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;spacy pretrain ./dummy.jsonl en_core_web_sm here -bs 10
&lt;/denchmark-code&gt;

Let's say I have this file called dummy.jsonl
&lt;denchmark-code&gt;{"text": "Can I ask where you work now and what you do, and if you enjoy it?"}
{"text": "They may just pull out of the Seattle market completely, at least until they have autonomous vehicles."}
{"text": "My cynical view on this is that it will never be free to the public. Reason: what would be the draw of joining the military? Right now their selling point is free Healthcare and Education. Ironically both are run horribly and most, that I've talked to, come out wishing they never went in."}
&lt;/denchmark-code&gt;

I get the following error.
&lt;denchmark-code&gt;  File ".../venv/lib/python3.6/site-packages/thinc/neural/_classes/affine.py", line 67, in finish_update
    self.ops.gemm(grad__BO, input__BI, trans1=True, out=self.d_W)
  File "ops.pyx", line 404, in thinc.neural.ops.NumpyOps.gemm
ValueError: Buffer and memoryview are not contiguous in the same dimension.
&lt;/denchmark-code&gt;

When dummy.jsonl looks like this:
&lt;denchmark-code&gt;{"text": "Hello there"}
&lt;/denchmark-code&gt;

I get this error
&lt;denchmark-code&gt;  File ".../venv/lib/python3.6/site-packages/thinc/neural/_classes/feed_forward.py", line 46, in begin_update
    X, inc_layer_grad = layer.begin_update(X, drop=drop)
  File ".../venv/lib/python3.6/site-packages/thinc/api.py", line 340, in uniqued_fwd
    keys = X[:, column]
IndexError: too many indices for array
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;

spacy==2.1.1
thinc==7.0.4
thinc==0.0.4
	</description>
	<comments>
		<comment id='1' author='tokestermw' date='2019-03-23T10:05:39Z'>
		Thanks. I haven't looked into this but I think there's a bug in the spacy.util.minibatch function. I think it doesn't handle the tail of the sequence properly? We had errors in Prodigy where it was raising an uncaught StopIteration, so I think something's wrong there. Might not be the problem here, but I think it'd make sense as an explanation.
		</comment>
		<comment id='2' author='tokestermw' date='2019-03-25T17:49:52Z'>
		I've tried changing the batch size, changing the size of the data, deduping the data with no luck ðŸ˜…
&lt;denchmark-code&gt;git checkout v2.1.0
python setup.py build_ext --inplace
&lt;/denchmark-code&gt;

I'd love to debug but cythonizing seems to be error-ing out when building from source.
&lt;denchmark-code&gt;Processing matcher.pyx
[Errno 2] No such file or directory: '/Users/mwu/github/spaCy/spacy/matcher.pyx'
Traceback (most recent call last):
  File "/Users/mwu/github/spaCy/bin/cythonize.py", line 169, in &lt;module&gt;
    run(args.root)
  File "/Users/mwu/github/spaCy/bin/cythonize.py", line 158, in run
    process(base, filename, db)
  File "/Users/mwu/github/spaCy/bin/cythonize.py", line 124, in process
    preserve_cwd(base, process_pyx, root + ".pyx", root + ".cpp")
  File "/Users/mwu/github/spaCy/bin/cythonize.py", line 87, in preserve_cwd
    func(*args)
  File "/Users/mwu/github/spaCy/bin/cythonize.py", line 63, in process_pyx
    raise Exception("Cython failed")
Exception: Cython failed
Traceback (most recent call last):
  File "setup.py", line 275, in &lt;module&gt;
    setup_package()
  File "setup.py", line 208, in setup_package
    generate_cython(root, "spacy")
  File "setup.py", line 131, in generate_cython
    raise RuntimeError("Running cythonize failed")
RuntimeError: Running cythonize failed
&lt;/denchmark-code&gt;

		</comment>
		<comment id='3' author='tokestermw' date='2019-03-26T21:24:19Z'>
		Oh I just have to set -nw 1 (or something small) ðŸ˜…
&lt;denchmark-link:https://github.com/explosion/spaCy/issues/3442&gt;#3442&lt;/denchmark-link&gt;

		</comment>
		<comment id='4' author='tokestermw' date='2019-04-12T10:03:41Z'>
		I don't understand why this issue is closed? Adding the command -nw 1 just changes one error message for another. I am still can't get rid of the first error message:
File ".../venv/lib/python3.6/site-packages/thinc/neural/_classes/affine.py", line 67, in finish_update
self.ops.gemm(grad__BO, input__BI, trans1=True, out=self.d_W)
File "ops.pyx", line 404, in thinc.neural.ops.NumpyOps.gemm
ValueError: Buffer and memoryview are not contiguous in the same dimension.
&lt;denchmark-link:https://github.com/tokestermw&gt;@tokestermw&lt;/denchmark-link&gt;
  how did you fix this?
		</comment>
		<comment id='5' author='tokestermw' date='2019-04-17T08:47:37Z'>
		For anybody else that comes across the same error as me. I realised after some testing that the error message came from accidentally trying to pretrain on the "en_core_web_sm" model which fails since since this model does not contain any word vectors...
		</comment>
		<comment id='6' author='tokestermw' date='2019-05-17T09:33:07Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>