<bug id='1562' author='RushiLuhar' open_date='2017-11-13T11:43:34Z' closed_time='2017-11-15T17:21:58Z'>
	<summary>Issue with training multi label TextCategorizer</summary>
	<description>
Hello,
I have been attempting to extend the TextCategorization example &lt;denchmark-link:https://github.com/explosion/spacy/blob/master/examples/training/train_textcat.py&gt;here&lt;/denchmark-link&gt;
 to support a 3 label classifier. My code is &lt;denchmark-link:https://gist.github.com/RushiLuhar/e421113cd8113fe64758292eb4fd6827&gt;here&lt;/denchmark-link&gt;
.
I modified the method to load examples from a file, and added the three labels to the textcat pipe. The data loads but I end up with a numpy error (See &lt;denchmark-link:https://gist.github.com/RushiLuhar/e421113cd8113fe64758292eb4fd6827&gt;Gist&lt;/denchmark-link&gt;
) when attempting to train the classifier.

File "linear.pyx", line 43, in thinc.linear.linear.LinearModel.begin_update
ValueError: Buffer and memoryview are not contiguous in the same dimension.

Each mini batch entry looks like:

&lt;class 'tuple'&gt;: ("The home insurance was taken out online and couldn't have been easier. \n", {'cats': {'__label__neg': False, '__label__neu': False, '__label__pos': True}})

So we have some text, and the gold labels include values for each label. I am not sure if this is an issue with the way I am specifying the training data or with something else.
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;

&lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;


spaCy version: 2.0.2
Platform: Darwin-16.7.0-x86_64-i386-64bit
Python version: 3.6.3
Models: en_core_web_lg

	</description>
	<comments>
		<comment id='1' author='RushiLuhar' date='2017-11-14T10:49:35Z'>
		Could you check that your data doesn't introduce new labels, that you haven't specified at the beginning of training?
That should work --- but it's the part that's most likely to fail here, from what I can see.
		</comment>
		<comment id='2' author='RushiLuhar' date='2017-11-15T16:02:35Z'>
		Hi &lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 ,
Sorry for the late reply. I just checked again and can confirm that no new labels are added during training that weren't specified to the categorizer pipeline before training.
The data passed to the nlp.update(..)method are a tuple of sentences called 'texts' and a tuple of categories called 'annotations'.  Each annotation looks like: {'cats': {'__label__neg': False, '__label__pos': True, '__label__neu': False}}
&lt;denchmark-code&gt;for batch in batches:
                texts, annotations = zip(*batch)
                nlp.update(texts, annotations, sgd=optimizer, drop=0.2,
                           losses=losses)
&lt;/denchmark-code&gt;

The code fails at the very first call to nlp.update (snippet above). I am wondering if the annotations are in the correct format. The code is pretty much identical to the categorization example with only modifications made for multi-label categorization.
		</comment>
		<comment id='3' author='RushiLuhar' date='2017-11-15T16:22:49Z'>
		&lt;denchmark-link:https://github.com/RushiLuhar&gt;@RushiLuhar&lt;/denchmark-link&gt;
 Hm. I don't know why it would matter, but try setting 1.0 and 0.0 instead of True and False?
You can also omit a category from a training example, to indicate unknown values.
		</comment>
		<comment id='4' author='RushiLuhar' date='2017-11-15T17:21:58Z'>
		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
  - this was a bug in my code. As you mentioned earlier, the issue seemed to be around adding all labels to the text categorizer. I will close this issue. Thanks for taking the time to look into it.
		</comment>
		<comment id='5' author='RushiLuhar' date='2017-12-22T12:57:26Z'>
		Hello,
I have the same issue &lt;denchmark-link:https://github.com/RushiLuhar&gt;@RushiLuhar&lt;/denchmark-link&gt;
. Can you tell how you fixed it please?
In , I feed 5 labels for  where
&lt;denchmark-code&gt;cats = { 'label1': True,
'label2': True,
'label3': False,
'label4': True
}
&lt;/denchmark-code&gt;

Thanks :)
		</comment>
		<comment id='6' author='RushiLuhar' date='2017-12-24T02:51:49Z'>
		&lt;denchmark-link:https://github.com/RushiLuhar&gt;@RushiLuhar&lt;/denchmark-link&gt;
 have you try change the order to add labels in ? I met some weird problems. &lt;denchmark-link:https://github.com/explosion/spaCy/issues/1763&gt;#1763&lt;/denchmark-link&gt;

		</comment>
		<comment id='7' author='RushiLuhar' date='2018-05-08T04:55:27Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>