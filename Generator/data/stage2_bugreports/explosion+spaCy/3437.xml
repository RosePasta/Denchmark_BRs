<bug id='3437' author='01alex' open_date='2019-03-19T22:16:19Z' closed_time='2019-03-20T00:00:08Z'>
	<summary>Spacy 2.1 bug when running with GPU: 'gpu_ops' is not defined</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;!pip install -U spacy
!python -m spacy download en

import spacy

gpu = spacy.prefer_gpu()
print('GPU:', gpu)

nlp = spacy.load("en_core_web_sm")

doc = nlp("This is a sentence. This is another sentence.")
for sent in doc.sents:
    print(sent.text)
&lt;/denchmark-code&gt;

&lt;denchmark-h:h3&gt;Output&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;GPU: True
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
&lt;ipython-input-3-1313493bc47b&gt; in &lt;module&gt;()
      6 nlp = spacy.load("en_core_web_sm")
      7 
----&gt; 8 doc = nlp("This is a sentence. This is another sentence.")
      9 for sent in doc.sents:
     10     print(sent.text)

(...)

ops.pyx in thinc.neural.ops.CupyOps.hash()

NameError: name 'gpu_ops' is not defined

&lt;/denchmark-code&gt;

This exact same code worked yesterday with the previous release.
&lt;denchmark-h:h3&gt;Note&lt;/denchmark-h&gt;

If I do:
&lt;denchmark-code&gt;!pip uninstall thinc
!pip install thinc==7.0.3
&lt;/denchmark-code&gt;

It works correctly:
&lt;denchmark-code&gt;GPU: True
This is a sentence.
This is another sentence.
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.1.0
Platform: Linux-4.14.79+-x86_64-with-Ubuntu-18.04-bionic
Python version: 3.6.7
Models: en
Environment Information: Google Colaboratory (Python 3 Google Compute Engine backend (GPU)), CUDA 10.0

	</description>
	<comments>
		<comment id='1' author='01alex' date='2019-03-19T22:40:27Z'>
		Did you install the new version in the same environment as the old one, and did you specify your CUDA version &lt;denchmark-link:https://spacy.io/usage#gpu&gt;as described here&lt;/denchmark-link&gt;
? It's possible that you ended up with stale files or packages in your , or Thinc didn't correctly pull in the .
		</comment>
		<comment id='2' author='01alex' date='2019-03-19T23:47:33Z'>
		So I ran two new Python 3 Google Compute Engine backend (GPU).
The first with the default spaCy 2.0.18.
The example:
&lt;denchmark-code&gt;import spacy

nlp = spacy.load("en_core_web_sm")
doc = nlp("This is a sentence. This is another sentence.")
for sent in doc.sents:
    print(sent.text)
&lt;/denchmark-code&gt;

It works fine. Then I required the gpu after import spacy, it returns true and throws the error.
In another runtime, I started with:
&lt;denchmark-code&gt;!pip install -U spacy[cuda100]
!python -m spacy download en
&lt;/denchmark-code&gt;

The update output:
&lt;denchmark-code&gt;Installing collected packages: srsly, numpy, wasabi, blis, thinc, spacy
  Found existing installation: numpy 1.14.6
    Uninstalling numpy-1.14.6:
      Successfully uninstalled numpy-1.14.6
  Found existing installation: thinc 6.12.1
    Uninstalling thinc-6.12.1:
      Successfully uninstalled thinc-6.12.1
  Found existing installation: spacy 2.0.18
    Uninstalling spacy-2.0.18:
      Successfully uninstalled spacy-2.0.18
Successfully installed blis-0.2.4 numpy-1.16.2 spacy-2.1.0 srsly-0.0.5 thinc-7.0.4 wasabi-0.1.4
&lt;/denchmark-code&gt;

Checked version 2.1.0.  Ran the example snippet. It works fine on cpu. Required gpu and got the same error.
It was working fine yesterday with spaCy 2.0.18.
		</comment>
		<comment id='3' author='01alex' date='2019-03-20T00:03:01Z'>
		Thanks, this was a regression introduced when fixing &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3430&gt;#3430&lt;/denchmark-link&gt;
 .
Thinc v7.0.3 required the thinc_gpu_ops module, which caused problems if CUDA was installed but no GPU was available (or if no compiler was installed).
The fix is to make the thinc_gpu_ops module an extras_require. This was set correctly in Thinc v7.0.4, but I didn't set it in spaCy. Have triggered a build for v2.1.1 to fix this.
		</comment>
		<comment id='4' author='01alex' date='2019-04-19T00:59:02Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>