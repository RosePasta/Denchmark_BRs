<bug id='4604' author='tamuhey' open_date='2019-11-07T11:41:28Z' closed_time='2019-11-11T15:26:47Z'>
	<summary>cymem assersion Error in `retokenizer.split`</summary>
	<description>
text = "Hyperglycemic adverse events following antipsychotic drug administration in"
doc = en(text)

with doc.retokenize() as retokenizer:
    token = doc[0]
    heads = [(token, 0)] * len(token)
    retokenizer.split(doc[token.i], list(token.text), heads=heads)
Error:
&lt;denchmark-code&gt;---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
&lt;ipython-input-75-cf40a2ff9ce8&gt; in &lt;module&gt;
      5     token = doc[0]
      6     heads = [(token,0)] * len(token)
----&gt; 7     retokenizer.split(doc[token.i], list(token.text), heads=heads)

_retokenize.pyx in spacy.tokens._retokenize.Retokenizer.__exit__()

_retokenize.pyx in spacy.tokens._retokenize._split()

doc.pyx in spacy.tokens.doc.Doc._realloc()

cymem.pyx in cymem.cymem.Pool.realloc()

AssertionError:
&lt;/denchmark-code&gt;

spacy version: 2.2.2
	</description>
	<comments>
		<comment id='1' author='tamuhey' date='2019-11-07T11:43:12Z'>
		This dosen't cause error (shorter text than previous example)
text = "Hyperglycemic adverse events following antipsychotic drug administration"
doc = en(text)

with doc.retokenize() as retokenizer:
    token = doc[0]
    heads = [(token,0)] * len(token)
    retokenizer.split(doc[token.i], list(token.text), heads=heads)
		</comment>
		<comment id='2' author='tamuhey' date='2019-11-07T14:26:43Z'>
		Thanks for the report!
This error only happens if you hit the edge case (bug) where the document needs to be resized (from its initial size of 20) and the new tokens outnumber the old tokens:



spaCy/spacy/tokens/_retokenize.pyx


        Lines 331 to 332
      in
      39e79fc






 while doc.length + nb_subtokens - 1 &gt;= doc.max_length: 



     doc._realloc(doc.length * 2) 





I think the fix is doc._realloc(doc.max_length * 2).
		</comment>
		<comment id='3' author='tamuhey' date='2019-12-11T16:05:57Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>