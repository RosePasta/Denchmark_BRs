<bug id='2934' author='arcodergh' open_date='2018-11-16T05:51:18Z' closed_time='2018-12-10T13:37:49Z'>
	<summary>problem training text categorizer on GPU</summary>
	<description>
Great work!
Install spacy in an isolated virtualenv using pip install spacy[cuda90], everything works well and
training starts normally but when GPU memory starts to be used as reported by nvidia-smi I get this error and the process ends, the environment is well configured and I'm able to use my GPUs with tensor flow.
&lt;denchmark-code&gt;Traceback (most recent call last):
  File "core_nlp/spacy/text_categorizer.py", line 168, in &lt;module&gt;
    nlp = TextCategorizer.train(filter_by_support(category_data, 60), model, None, use_averages=True, epochs=50, debug=False)
  File "core_nlp/spacy/text_categorizer.py", line 80, in train
    nlp_.update(texts, annotations, sgd=optimizer, drop=dropout, losses=losses)
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/spacy/language.py", line 421, in update
    proc.update(docs, golds, drop=drop, sgd=get_grads, losses=losses)
  File "pipeline.pyx", line 876, in spacy.pipeline.TextCategorizer.update
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/thinc/api.py", line 61, in begin_update
    X, inc_layer_grad = layer.begin_update(X, drop=drop)
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/thinc/api.py", line 176, in begin_update
    values = [fwd(X, *a, **k) for fwd in forward]
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/thinc/api.py", line 176, in &lt;listcomp&gt;
    values = [fwd(X, *a, **k) for fwd in forward]
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/thinc/api.py", line 258, in wrap
    output = func(*args, **kwargs)
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/thinc/api.py", line 61, in begin_update
    X, inc_layer_grad = layer.begin_update(X, drop=drop)
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/spacy/_ml.py", line 102, in _preprocess_doc
    keys = ops.xp.concatenate(keys)
  File "/home/neo/pyenvs/spacyp3/lib/python3.5/site-packages/cupy/manipulation/join.py", line 49, in concatenate
    return core.concatenate_method(tup, axis)
  File "cupy/core/core.pyx", line 2740, in cupy.core.core.concatenate_method
  File "cupy/core/core.pyx", line 2753, in cupy.core.core.concatenate_method
TypeError: Only cupy arrays can be concatenated
&lt;/denchmark-code&gt;

This is a copy of my requirements.txt
&lt;denchmark-code&gt;certifi==2018.10.15
chardet==3.0.4
cupy-cuda90==5.0.0
cycler==0.10.0
cymem==2.0.2
cytoolz==0.9.0.1
dill==0.2.8.2
fastrlock==0.4
idna==2.7
kiwisolver==1.0.1
matplotlib==3.0.2
msgpack==0.5.6
msgpack-numpy==0.4.3.2
murmurhash==1.0.1
numpy==1.15.4
pandas==0.23.4
plac==0.9.6
preshed==2.0.1
pyparsing==2.3.0
python-dateutil==2.7.5
pytz==2018.7
regex==2018.1.10
requests==2.20.1
scikit-learn==0.20.0
scipy==1.1.0
six==1.11.0
spacy==2.0.16
thinc==6.12.0
thinc-gpu-ops==0.0.3
toolz==0.9.0
tqdm==4.28.1
twitter-text-python==1.1.0
ujson==1.35
urllib3==1.24.1
wrapt==1.10.11
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


Operating System: Ubuntu 16.04
Python Version Used: 3.5.2
spaCy Version Used: 2.0.16
Environment Information: Cuda 90 driver working with tensor flow

	</description>
	<comments>
		<comment id='1' author='arcodergh' date='2019-01-09T14:12:48Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>