<bug id='4120' author='adrianeboyd' open_date='2019-08-14T19:36:34Z' closed_time='2019-08-20T14:42:59Z'>
	<summary>Matches without a final {OP: ?} token are not returned</summary>
	<description>
A match ending with {"OP": "?"} only returns the match with this token, not without, unless the preceding token is the last token in the document.
If you change ? to * all matches are returned as expected.
If there is another matched token after {"OP": "?"} it also works as expected.
I suspect this is related to some of the other OP Matcher bugs, but I hadn't seen this test case yet. The test suite includes * but not ?.
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;import spacy
from spacy.matcher import Matcher
from spacy.tokens import Doc

nlp = spacy.load('en')

matcher = Matcher(nlp.vocab)

pattern = [
    {"ORTH": "a"},
    {"OP": "?"},
]

matcher.add("TEST", None, pattern)

doc = Doc(nlp.vocab, words=["a", "b", "c"])
print(matcher(doc))
# [(1046765068364475028, 0, 2)] # expected match "a" from (0, 1) is missing

doc = Doc(nlp.vocab, words=["a"])
print(matcher(doc))
# [(1046765068364475028, 0, 1)] # but it works at the end of a document

matcher = Matcher(nlp.vocab)

pattern = [
    {"ORTH": "a"},
    {"OP": "?"},
    {"ORTH": "b"},
]

matcher.add("TEST", None, pattern)
doc = Doc(nlp.vocab, words=["a", "b", "b", "c"])
print(matcher(doc))
# [(1046765068364475028, 0, 2), (1046765068364475028, 0, 3)] # good

matcher = Matcher(nlp.vocab)

pattern = [
    {"ORTH": "a"},
    {"OP": "?"},
    {"ORTH": "b", "OP": "?"},
]

matcher.add("TEST", None, pattern)
doc = Doc(nlp.vocab, words=["a", "b", "b", "c"])
print(matcher(doc))
# [(1046765068364475028, 0, 2), (1046765068364475028, 0, 3)] # "a" is missing
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.1.8
Platform: Linux-4.19.0-5-amd64-x86_64-with-debian-10.0
Python version: 3.7.3
Models: xx, en

	</description>
	<comments>
		<comment id='1' author='adrianeboyd' date='2019-08-15T10:50:17Z'>
		Yes, looks like it might have the same root cause as &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3951&gt;#3951&lt;/denchmark-link&gt;
?
		</comment>
		<comment id='2' author='adrianeboyd' date='2019-08-15T10:51:48Z'>
		I'm not totally sure, because it seems to make a difference if it's the last token pattern, which isn't the case there. But maybe it is the same cause...
		</comment>
		<comment id='3' author='adrianeboyd' date='2019-08-15T19:32:17Z'>
		Also reminds me of Issue &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3879&gt;#3879&lt;/denchmark-link&gt;
 ...
		</comment>
		<comment id='4' author='adrianeboyd' date='2019-08-20T14:42:59Z'>
		Merging this with &lt;denchmark-link:https://github.com/explosion/spaCy/issues/4154&gt;#4154&lt;/denchmark-link&gt;
!
		</comment>
		<comment id='5' author='adrianeboyd' date='2019-09-19T15:42:46Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>