<bug id='3087' author='d5555' open_date='2018-12-21T14:44:50Z' closed_time='2019-02-05T11:35:51Z'>
	<summary>train_textcat.py fails on spacy nightly v2.1.0a4</summary>
	<description>
Spacy v2.1.0a4 fails to run train_textcat.py
&lt;denchmark-link:https://github.com/explosion/spacy/blob/master/examples/training/train_textcat.py&gt;https://github.com/explosion/spacy/blob/master/examples/training/train_textcat.py&lt;/denchmark-link&gt;

It doesn't seem to update the model. I get same losses on each iteration. And if I save the model in the end it fails to load with spacy.load(output_dir)
C:\Users\WORK-PC\Desktop&gt;train_textcat.py
Created blank 'en' model
Loading IMDB data...
Using 2000 examples (1600 training, 400 evaluation)
Training the model...
LOSS      P       R       F
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
184.500 0.505   1.000   0.671
This movie sucked {'POSITIVE': 1.0}

Operating System: Windows 10
Python Version Used: 3.6
spaCy Version Used: nightly  v2.1.0a4
Environment Information:

	</description>
	<comments>
		<comment id='1' author='d5555' date='2018-12-27T13:35:48Z'>
		&lt;denchmark-link:https://github.com/d5555&gt;@d5555&lt;/denchmark-link&gt;
 Thanks, this example needs to be updated. The new nightly simplified the textcat architecture, and also switched to mutually exclusive labels by default, since that's what most people usually need.
To adjust the example, we need to have a second class label, NEGATIVE, which should have the value 0.0 when POSITIVE is 1.0, and vice versa. A pull request for this would be appreciated.
		</comment>
		<comment id='2' author='d5555' date='2018-12-28T00:14:52Z'>
		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 Hello, first-timer here.
I have started to do as you requested but I seem to be missing a few things.


So my first question is if I have used the correct format for Language.update() for input variable golds. Like it was previously, it is a tuple (of size batch) of dictionaries. However, each individual dictionary now looks like the following example:
{'cats': {'POSITIVE': False}, 'neg_cats': {'NEGATIVE': True}}


Next, I am wondering why losses still do not seem to be updating correctly. After the changes I made, they do update between each iteration, but they just seem to fluctuate around the same point rather than steadily diminishing.


Here is an example of the first 5 iterations on a sample size of 200 (for speed reasons):
LOSS 	P  	       R  	       F
20.281	0.500	0.500	0.500
19.907	0.600	0.600	0.600
18.956	0.725	0.725	0.725
19.360	0.775	0.775	0.775
19.461	0.725	0.725	0.725
And the same from an earlier version of spaCy (just to illustrate proper movement of loss):
LOSS 	P  	       R  	       F
10.490	0.739	0.773	0.756
5.246	1.000	0.682	0.811
2.637	0.889	0.727	0.800
1.350	0.818	0.818	0.818
0.901	0.760	0.864	0.809
Do you have any advice on how the losses can be made to update correctly. I must be passing something incorrectly to Language.update(). That's why I asked the previous question.
Also, you can see that I haven't completely fixed evaluate() (evidenced by the fact that precision and recall values are always nice fractions while the earlier version has much more randomness) . I've only changed the variable gold so that it contains a dictionary of both POSITIVE and NEGATIVE categories. Previously, it only contained POSITIVE.
gold = {**cats[i], **neg_cats[i]}
Sorry if the solutions to these problems seem obvious to you and others. Not only am I new to this project, but also to neural networks and NLP.
Thank you for your time.
		</comment>
		<comment id='3' author='d5555' date='2018-12-28T01:26:11Z'>
		Also, it seems to me that there is a very small possibility that a zero division error could occur when evaluating for fscore in evaluate(). If there are no true positives then both precision and recall would be 0. In this case, the divisor when calculating for fscore would also be 0. But it won't happen in normal operations. But if one alters n_texts to a much smaller value, the chance of this occurring becomes much higher. This might be done when a person is experimenting or learning how spacy works and doesn't want to wait for the longer periods of time associated with training on greater sample sizes (this is why I encountered the problem). Is it worth including a try/catch on the off-chance that somebody is using a small sample size?
		</comment>
		<comment id='4' author='d5555' date='2018-12-28T17:33:25Z'>
		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 ,
so annotation example should look like this:    'cats': {'POSITIVE': 1.0, 'NEGATIVE': 0.0},  or vise versa
We can just change the line 103 in the example on:
103:     
and add label , line 44:
44:  
Now it worked much better but I'm still getting the error when trying to load the model after I got it saved: "TypeError: Model() takes exactly 2 positional arguments (1 given)"
Using 2000 examples (1600 training, 400 evaluation)
Training the model...
LOSS 	  P  	  R  	  F
175.006	0.710	0.710	0.710
123.369	0.767	0.767	0.767
81.370	0.752	0.752	0.752
55.536	0.747	0.747	0.747
36.055	0.737	0.737	0.737
28.354	0.752	0.752	0.752
15.306	0.757	0.757	0.757
14.713	0.785	0.785	0.785
11.793	0.782	0.782	0.782
16.598	0.775	0.775	0.775
6.870	0.770	0.770	0.770
15.929	0.787	0.787	0.787
15.447	0.772	0.772	0.772
6.359	0.787	0.787	0.787
4.872	0.787	0.787	0.787
9.118	0.785	0.785	0.785
1.966	0.785	0.785	0.785
9.083	0.780	0.780	0.780
2.794	0.785	0.785	0.785
6.683	0.775	0.775	0.775
This movie sucked {'POSITIVE': 1.9875681106351767e-39, 'NEGATIVE': 1.0}
Saved model to C:\Users\WORK-PC\Desktop\NewModel1
Loading from C:\Users\WORK-PC\Desktop\NewModel1
Traceback (most recent call last):
File "C:\Users\WORK-PC\Desktop\train_textcat.py", line 135, in 
plac.call(main)
File "C:\Python36\lib\site-packages\plac_core.py", line 328, in call
cmd, result = parser.consume(arglist)
File "C:\Python36\lib\site-packages\plac_core.py", line 207, in consume
return cmd, self.func(*(args + varargs + extraopts), **kwargs)
File "C:\Users\WORK-PC\Desktop\train_textcat.py", line 90, in main
nlp2 = spacy.load(output_dir)
File "C:\Python36\lib\site-packages\spacy_init_.py", line 22, in load
return util.load_model(name, **overrides)
File "C:\Python36\lib\site-packages\spacy\util.py", line 116, in load_model
return load_model_from_path(name, **overrides)
File "C:\Python36\lib\site-packages\spacy\util.py", line 154, in load_model_from_path
return nlp.from_disk(model_path)
File "C:\Python36\lib\site-packages\spacy\language.py", line 770, in from_disk
util.from_disk(path, deserializers, exclude)
File "C:\Python36\lib\site-packages\spacy\util.py", line 560, in from_disk
reader(path / key)
File "C:\Python36\lib\site-packages\spacy\language.py", line 766, in 
deserializers[name] = lambda p, proc=proc: proc.from_disk(p, vocab=False)
File "pipeline.pyx", line 420, in spacy.pipeline.Pipe.from_disk
File "C:\Python36\lib\site-packages\spacy\util.py", line 560, in from_disk
reader(path / key)
File "pipeline.pyx", line 412, in spacy.pipeline.Pipe.from_disk.load_model
File "pipeline.pyx", line 1131, in spacy.pipeline.TextCategorizer.Model
TypeError: Model() takes exactly 2 positional arguments (1 given)
		</comment>
		<comment id='5' author='d5555' date='2018-12-28T20:17:52Z'>
		&lt;denchmark-link:https://github.com/d5555&gt;@d5555&lt;/denchmark-link&gt;
 That worked much better than the stuff I was doing. So &lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
  can ignore my first post.
The loading error occurs because the TextCategorizer.Model() argument in pipeline.pyx requires an input for argument nr_class because the nightly version does not have a default value. Giving nr_class a default value of 1 fixes the problem.
		</comment>
		<comment id='6' author='d5555' date='2019-01-11T17:04:47Z'>
		&lt;denchmark-link:https://github.com/jhochmuth&gt;@jhochmuth&lt;/denchmark-link&gt;
   - i am facing  similar issue, do you mind sharing your snippet here.
  File "pipeline.pyx", line 420, in spacy.pipeline.Pipe.from_disk.load_model
  File "pipeline.pyx", line 1148, in spacy.pipeline.TextCategorizer.Model
TypeError: Model() takes exactly 2 positional arguments (1 given)
I receive on following , an empty
nlp = spacy.blank('en').from_disk("./model2_1")
doc2 = nlp(test_text)
print(doc2.cats)
Response:
{}
However, the model is trained and in-memory model is used to predict, on same text, predictions are available. But on persisted model, it seems we are missing something on nightly to get it working.
Also, this is not backward compatible, since with Spacy 2.0, everything works fine. but with nighly build we are facing issue as stated above.
Please help !!
&lt;denchmark-link:https://github.com/ines&gt;@ines&lt;/denchmark-link&gt;
 / &lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;

		</comment>
		<comment id='7' author='d5555' date='2019-01-11T20:45:50Z'>
		to make it work I had to change line 1148 in pipeline.pyx  in spacy installer zip file :     def Model(cls, nr_class=1, width=64, **cfg):  in class TextCategorizer
Then install spaCy. Not sure how to make it work without reinstalling spacy as it has to be cyphonized
		</comment>
		<comment id='8' author='d5555' date='2019-01-12T02:46:19Z'>
		Thanks &lt;denchmark-link:https://github.com/d5555&gt;@d5555&lt;/denchmark-link&gt;
.
Not sure, but i couldnt get it working even after it. force reinstallation of Spacy, would override the change.
pip install spacy-nightly --force
&lt;denchmark-code&gt;    def Model(cls, nr_class=1, **cfg):
&lt;/denchmark-code&gt;

&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 / &lt;denchmark-link:https://github.com/ines&gt;@ines&lt;/denchmark-link&gt;
  - As you suggested on another thread for multi-processing we should give a try to spacy nightly. But it seems to be not working as expected. Do we have working example for multi-processing with Spacy nighly latest version ( performing TextCategorizer based predictions) ?
		</comment>
		<comment id='9' author='d5555' date='2019-01-12T13:23:48Z'>
		Are you getting same typeerror? Check pipeline.pyx...does it show nr_class=1 after installation in class TextCategorizer?
You need to make changes in spacy zip installer and then pip install  path/to/spacy...zip
		</comment>
		<comment id='10' author='d5555' date='2019-01-12T13:26:45Z'>
		Same error, indeed it shows the change i did, but if force i re-install spacy after it. This change is being overridden ( expected behavior)
&lt;denchmark-link:https://user-images.githubusercontent.com/3977272/51073746-af66c280-169b-11e9-87c3-258a768ea240.png&gt;&lt;/denchmark-link&gt;

		</comment>
		<comment id='11' author='d5555' date='2019-01-12T14:02:19Z'>
		Of course...you need first download spazy zip installer...
&lt;denchmark-link:https://github.com/explosion/spaCy/archive/v2.1.0a6.dev0.zip&gt;https://github.com/explosion/spaCy/archive/v2.1.0a6.dev0.zip&lt;/denchmark-link&gt;

Correct zip file in pipeline.pyx

		</comment>
		<comment id='12' author='d5555' date='2019-01-12T17:17:47Z'>
		Not sure, but i tried the suggested steps:

Tried both v2.1.0a5.zip and v2.1.0a6.dev0.zip
Modified as suggested
pip install &lt;&gt;.zip
Getting below error, setuptools and pip are latest. Not sure, what is going wrong here ..

&lt;denchmark-link:https://user-images.githubusercontent.com/3977272/51076217-8a824780-16bb-11e9-9ba5-ab26f6b36c23.png&gt;&lt;/denchmark-link&gt;

		</comment>
		<comment id='13' author='d5555' date='2019-01-12T17:27:11Z'>
		What if you try your full path to zip file
pip install C:\Users\My_PC\Desktop\v2.1.0a6.dev0.zip
I did it couple times and it works. Though I didn't use virtual env
		</comment>
		<comment id='14' author='d5555' date='2019-01-12T17:30:01Z'>
		appreciate your prompt response, &lt;denchmark-link:https://github.com/d5555&gt;@d5555&lt;/denchmark-link&gt;
 ,
unfortunately, still getting same.
I am on Mac btw.
&lt;denchmark-link:https://user-images.githubusercontent.com/3977272/51076376-b8688b80-16bd-11e9-98a5-e255fd5c186a.png&gt;&lt;/denchmark-link&gt;

I am using virtualenv , since i have spacy installed, and trying to verify multi-processing around spacy-nightly where an issue seems fixed. But i couldnt manage to get Spacy nightly working for TextCat as expected :(
		</comment>
		<comment id='15' author='d5555' date='2019-01-12T17:47:55Z'>
		I don't  know how it works on Mac .
Are you able to  pip install &lt;&gt;.zip without modification spacy zip ?
If yes then probably you modified it wrongly. It has to be modified without unpacking... I used winrar
		</comment>
		<comment id='16' author='d5555' date='2019-01-12T18:01:41Z'>
		Indeed, i unzipped, modified and zipped it.
However, for original zip file, i am getting diff. issue.
&lt;denchmark-code&gt;  Cythonizing sources
    Traceback (most recent call last):
      File "&lt;string&gt;", line 1, in &lt;module&gt;
      File "/private/var/folders/hk/0ph5xd612fxfmnysh67y2j9h0000gn/T/pip-req-build-fydymsgr/setup.py", line 270, in &lt;module&gt;
        setup_package()
      File "/private/var/folders/hk/0ph5xd612fxfmnysh67y2j9h0000gn/T/pip-req-build-fydymsgr/setup.py", line 206, in setup_package
        generate_cython(root, "spacy")
      File "/private/var/folders/hk/0ph5xd612fxfmnysh67y2j9h0000gn/T/pip-req-build-fydymsgr/setup.py", line 129, in generate_cython
        raise RuntimeError("Running cythonize failed")
    RuntimeError: Running cythonize failed
    

&lt;/denchmark-code&gt;

		</comment>
		<comment id='17' author='d5555' date='2019-02-05T11:35:51Z'>
		See &lt;denchmark-link:https://github.com/explosion/spaCy/issues/3221&gt;#3221&lt;/denchmark-link&gt;
!
		</comment>
		<comment id='18' author='d5555' date='2019-03-07T11:38:22Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>