<bug id='5840' author='mdgilene' open_date='2020-07-29T15:18:08Z' closed_time='2020-07-31T14:09:33Z'>
	<summary>EntityRuler overlapping matches of the same length, the one appearing last in the document is chosen instead of the first</summary>
	<description>
Believe this is caused by the following line using reverse=True for both sort keys. It should be reverse sorted on entity length, then regular sort on start index:



spaCy/spacy/pipeline/entityruler.py


        Lines 98 to 99
      in
      03ab518






 get_sort_key = lambda m: (m[2] - m[1], m[1]) 



 matches = sorted(matches, key=get_sort_key, reverse=True) 





&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;import spacy
from spacy.pipeline import EntityRuler

patterns = [
    {"label": "FOOBAR", "pattern": "foo bar"},
    {"label": "BARBAZ", "pattern": "bar baz"},
]

nlp = spacy.load("en_core_web_sm")
ruler = EntityRuler(nlp)
ruler.add_patterns(patterns)
nlp.add_pipe(ruler, before="ner")

doc = nlp("foo bar baz")

print([(ent.text, ent.label_, ent.ent_id_) for ent in doc.ents])
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.3.2
Platform: Windows-10-10.0.17134-SP0
Python version: 3.7.5

	</description>
	<comments>
		<comment id='1' author='mdgilene' date='2020-07-30T07:21:54Z'>
		Thanks for the report! We'd fixed the same issue in util.filter_spans but missed the same issue here.
		</comment>
	</comments>
</bug>