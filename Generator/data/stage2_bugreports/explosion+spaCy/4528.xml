<bug id='4528' author='pzajec' open_date='2019-10-27T02:32:38Z' closed_time='2019-10-28T15:02:14Z'>
	<summary>DocBin: serialization of user_data</summary>
	<description>
I think the &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/spacy/tokens/_serialize.py#L106&gt;line from the DocBin class&lt;/denchmark-link&gt;
 should be changed from:
doc.user_data.update(srsly.msgpack_loads(self.user_data[i]))
to
doc.user_data.update(srsly.msgpack_loads(self.user_data[i], use_list=False))
to match the &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx#L931&gt;one from the Doc class&lt;/denchmark-link&gt;
.
Consider the following two examples:
&lt;denchmark-h:h3&gt;Using Doc.to_bytes() / Doc.from_bytes()&lt;/denchmark-h&gt;

# file serialize_doc.py
import spacy
from spacy.tokens import Doc

nlp = spacy.load('en')
Doc.set_extension("my_custom_attr", default=None)
text = "Hello from New York!"

doc = nlp(text)
doc._.my_custom_attr = "hello"

with open('test_doc.bin', 'wb') as f:
    f.write(doc.to_bytes())
# file deserialize_doc.py
import spacy
from spacy.tokens import Doc

nlp = spacy.blank("en")
with open('test_doc.bin', 'rb') as f:
    bytes_data = f.read()

doc = Doc(nlp.vocab).from_bytes(bytes_data)
Doc.set_extension("my_custom_attr", default=None)

print(doc._.my_custom_attr)
Output: "hello" as expected
&lt;denchmark-h:h4&gt;Using DocBin.to_bytes() / DocBin.from_bytes()&lt;/denchmark-h&gt;

import spacy
from spacy.tokens import Doc, DocBin

nlp = spacy.load('en')
Doc.set_extension("my_custom_attr", default=None)
text = "Hello from New York!"

doc = nlp(text)
doc._.my_custom_attr = "hello"
doc_bin = DocBin(attrs=None, store_user_data=True)
doc_bin.add(doc)

with open('test_docbin.bin', 'wb') as f:
    f.write(doc_bin.to_bytes())
import spacy
from spacy.tokens import DocBin

nlp = spacy.blank("en")
with open('test_docbin.bin', 'rb') as f:
    bytes_data = f.read()

doc_bin = DocBin(store_user_data=True).from_bytes(bytes_data)
Output: TypeError: unhashable type: 'list'
&lt;denchmark-h:h3&gt;Reason&lt;/denchmark-h&gt;

The following code which reads serialized DocBin first prints the correct output when use_list=False and crashes when use_list=True
import srsly
import zlib

with open('test_docbin.bin', 'rb') as f:
    bytes_data = f.read()

msg = srsly.msgpack_loads(zlib.decompress(bytes_data))
print(srsly.msgpack_loads(msg['user_data'][0], use_list=False))
srsly.msgpack_loads(msg['user_data'][0], use_list=True)
Output:
&lt;denchmark-code&gt;&gt; {('._.', 'my_custom_attr', None, None): 'hello'}
&gt; TypeError: unhashable type: 'list'
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;


First serialize the DocBin instance using:

import spacy
from spacy.tokens import Doc, DocBin

nlp = spacy.load('en')
Doc.set_extension("my_custom_attr", default=None)
text = "Hello from New York!"

doc = nlp(text)
doc._.my_custom_attr = "hello"
doc_bin = DocBin(attrs=None, store_user_data=True)
doc_bin.add(doc)

with open('test_docbin.bin', 'wb') as f:
    f.write(doc_bin.to_bytes())

Then de-serialize using:

import spacy
from spacy.tokens import DocBin

nlp = spacy.blank("en")
with open('test_docbin.bin', 'rb') as f:
    bytes_data = f.read()

doc_bin = DocBin(store_user_data=True).from_bytes(bytes_data)
&lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;


spaCy version: 2.2.1
Platform: Linux-5.0.0-31-generic-x86_64-with-Ubuntu-18.04-bionic
Python version: 3.6.8
Models: en

	</description>
	<comments>
		<comment id='1' author='pzajec' date='2019-10-28T13:42:18Z'>
		Thanks for the super detailed report and analysis â€“ much appreciated!  Fixed in &lt;denchmark-link:https://github.com/explosion/spaCy/pull/4540&gt;#4540&lt;/denchmark-link&gt;
.
		</comment>
		<comment id='2' author='pzajec' date='2019-11-27T15:55:22Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>