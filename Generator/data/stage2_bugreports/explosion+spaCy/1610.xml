<bug id='1610' author='Nicholas-Mitchell' open_date='2017-11-19T14:32:20Z' closed_time='2018-01-15T15:42:39Z'>
	<summary>RuntimeError compiling spaCy -- cannot assign double to int    [BUG]</summary>
	<description>

Operating System: Ubuntu 16.04
Python Version Used: 3.4.5 Continuum Analytics [GCC 4.4.7]
spaCy Version Used: 2.0.x  ??   (the current version that a git clone gets me)
Environment Information: conda environment, spaCy not present.
Cython                    0.26.1                    &lt;pip&gt;

I was trying to compile spacy within an Conda environment, when a (seemingly) simple-to-fix bug was found (see the terminal output below).
There is a double being assigned to an int in the file: _beam_utils.pyx at line 93.
It is coming from beam._state. Looking through the file search.pyx (from site-packages/thinc/extra) from which Beam is imported, I cannot follow exactly which type it is declared as, although many defs use int and the _beam_utils.pyx file does include the cython header:infer_types=True.
If this is indeed a mistake, then lines 94 and 95 look like they must also be changed.
&lt;denchmark-h:h3&gt;Here are some relevant terminal outputs. First the installation of the spacy requirements:&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;pip install -r requirements.txt
Collecting cython&lt;0.27.0,&gt;=0.24 (from -r requirements.txt (line 1))
  Downloading Cython-0.26.1-cp34-cp34m-manylinux1_x86_64.whl (2.9MB)
    100% |████████████████████████████████| 2.9MB 384kB/s 
Requirement already satisfied: pathlib in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 2))
Requirement already satisfied: numpy&gt;=1.7 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 3))
Requirement already satisfied: cymem&lt;1.32,&gt;=1.30 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 4))
Requirement already satisfied: preshed&lt;2.0.0,&gt;=1.0.0 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 5))
Requirement already satisfied: thinc&lt;6.11.0,&gt;=6.10.1 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 6))
Requirement already satisfied: murmurhash&lt;0.29,&gt;=0.28 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 7))
Requirement already satisfied: plac&lt;1.0.0,&gt;=0.9.6 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 8))
Requirement already satisfied: six in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 9))
Requirement already satisfied: ujson&gt;=1.35 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 10))
Requirement already satisfied: dill&lt;0.3,&gt;=0.2 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 11))
Requirement already satisfied: requests&lt;3.0.0,&gt;=2.13.0 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 12))
Requirement already satisfied: regex==2017.4.5 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 13))
Requirement already satisfied: ftfy&lt;5.0.0,&gt;=4.4.2 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 14))
Collecting pytest&lt;4.0.0,&gt;=3.0.6 (from -r requirements.txt (line 15))
  Downloading pytest-3.2.5-py2.py3-none-any.whl (188kB)
    100% |████████████████████████████████| 194kB 5.1MB/s 
Collecting mock&lt;3.0.0,&gt;=2.0.0 (from -r requirements.txt (line 16))
  Using cached mock-2.0.0-py2.py3-none-any.whl
Requirement already satisfied: msgpack-python in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 17))
Requirement already satisfied: msgpack-numpy in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from -r requirements.txt (line 18))
Collecting html5lib==1.0b8 (from -r requirements.txt (line 19))
  Using cached html5lib-1.0b8.tar.gz
Requirement already satisfied: tqdm&lt;5.0.0,&gt;=4.10.0 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from thinc&lt;6.11.0,&gt;=6.10.1-&gt;-r requirements.txt (line 6))
Requirement already satisfied: termcolor in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from thinc&lt;6.11.0,&gt;=6.10.1-&gt;-r requirements.txt (line 6))
Requirement already satisfied: cytoolz&lt;0.9,&gt;=0.8 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from thinc&lt;6.11.0,&gt;=6.10.1-&gt;-r requirements.txt (line 6))
Requirement already satisfied: wrapt in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from thinc&lt;6.11.0,&gt;=6.10.1-&gt;-r requirements.txt (line 6))
Requirement already satisfied: chardet&lt;3.1.0,&gt;=3.0.2 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from requests&lt;3.0.0,&gt;=2.13.0-&gt;-r requirements.txt (line 12))
Requirement already satisfied: urllib3&lt;1.23,&gt;=1.21.1 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from requests&lt;3.0.0,&gt;=2.13.0-&gt;-r requirements.txt (line 12))
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from requests&lt;3.0.0,&gt;=2.13.0-&gt;-r requirements.txt (line 12))
Requirement already satisfied: idna&lt;2.7,&gt;=2.5 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from requests&lt;3.0.0,&gt;=2.13.0-&gt;-r requirements.txt (line 12))
Requirement already satisfied: wcwidth in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from ftfy&lt;5.0.0,&gt;=4.4.2-&gt;-r requirements.txt (line 14))
Collecting py&gt;=1.4.33 (from pytest&lt;4.0.0,&gt;=3.0.6-&gt;-r requirements.txt (line 15))
  Downloading py-1.5.2-py2.py3-none-any.whl (88kB)
    100% |████████████████████████████████| 92kB 3.8MB/s 
Requirement already satisfied: setuptools in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from pytest&lt;4.0.0,&gt;=3.0.6-&gt;-r requirements.txt (line 15))
Collecting pbr&gt;=0.11 (from mock&lt;3.0.0,&gt;=2.0.0-&gt;-r requirements.txt (line 16))
  Using cached pbr-3.1.1-py2.py3-none-any.whl
Requirement already satisfied: toolz&gt;=0.8.0 in /home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages (from cytoolz&lt;0.9,&gt;=0.8-&gt;thinc&lt;6.11.0,&gt;=6.10.1-&gt;-r requirements.txt (line 6))
Building wheels for collected packages: html5lib
  Running setup.py bdist_wheel for html5lib ... done
  Stored in directory: /home/n1k31t4/.cache/pip/wheels/d4/d1/0b/a6b6f9f204af55c9bb8c97eae2a78b690b7150a7b850bb9403
Successfully built html5lib
Installing collected packages: cython, py, pytest, pbr, mock, html5lib
  Found existing installation: html5lib 0.999999999
    Uninstalling html5lib-0.999999999:
      Successfully uninstalled html5lib-0.999999999
Successfully installed cython-0.26.1 html5lib-1.0b8 mock-2.0.0 pbr-3.1.1 py-1.5.2 pytest-3.2.5

&lt;/denchmark-code&gt;

&lt;denchmark-h:h3&gt;Here for the build command, including the error:&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;paCy$ python setup.py build_ext --inplace
Cythonizing sources
Processing attrs.pyx
Processing gold.pyx
Processing lexeme.pyx
Processing matcher.pyx
Processing morphology.pyx
Processing parts_of_speech.pyx
Processing pipeline.pyx
Processing strings.pyx
Processing symbols.pyx
Processing tokenizer.pyx
Processing typedefs.pyx
Processing vectors.pyx
Processing vocab.pyx
Processing _beam_utils.pyx

Error compiling Cython file:
------------------------------------------------------------
...
                for j in range(beam.size):
                    state = StateClass.borrow(&lt;StateC*&gt;beam.at(j))
                    if state.is_final():
                        try:
                            if self.moves.is_gold_parse(state, self.golds[i]):
 #line 93                  beam._states[j].loss = 0.0
                                                      ^
------------------------------------------------------------

_beam_utils.pyx:93:55: Cannot assign type 'double' to 'int'
Traceback (most recent call last):
  File "/home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages/spaCy/bin/cythonize.py", line 157, in &lt;module&gt;
    run(args.root)
  File "/home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages/spaCy/bin/cythonize.py", line 148, in run
    process(base, filename, db)
  File "/home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages/spaCy/bin/cythonize.py", line 114, in process
    preserve_cwd(base, process_pyx, root + '.pyx', root + '.cpp')
  File "/home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages/spaCy/bin/cythonize.py", line 79, in preserve_cwd
    func(*args)
  File "/home/n1k31t4/anaconda3/envs/env-name/lib/python3.4/site-packages/spaCy/bin/cythonize.py", line 61, in process_pyx
    raise Exception('Cython failed')
Exception: Cython failed
Traceback (most recent call last):
  File "setup.py", line 227, in &lt;module&gt;
    setup_package()
  File "setup.py", line 172, in setup_package
    generate_cython(root, 'spacy')
  File "setup.py", line 104, in generate_cython
    raise RuntimeError('Running cythonize failed')
RuntimeError: Running cythonize failed
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='Nicholas-Mitchell' date='2017-11-20T18:09:02Z'>
		Not sure if this is related, but: I forked  then followed the instructions &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/CONTRIBUTING.md#getting-started&gt;here&lt;/denchmark-link&gt;
 to compile from source. Worked fine. After fixing a bug in , however, I tried to re-compile via  and hit a similar exception:
&lt;denchmark-code&gt;spaCy(fix-span-orth)$ python setup.py build_ext --inplace
Cythonizing sources
Processing span.pyx
Traceback (most recent call last):
  File "/Users/burtondewilde/.pyenv/versions/spacy2-bugfix/bin/cython", line 7, in &lt;module&gt;
    from Cython.Compiler.Main import setuptools_main
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/Cython/Compiler/Main.py", line 21, in &lt;module&gt;
    from . import Errors
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/Cython/Compiler/Errors.py", line 14, in &lt;module&gt;
    from ..Utils import open_new_file
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/Cython/Utils.py", line 18, in &lt;module&gt;
    import shutil
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/shutil.py", line 16, in &lt;module&gt;
    import bz2
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/bz2.py", line 19, in &lt;module&gt;
    from threading import RLock
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/threading.py", line 7, in &lt;module&gt;
    from traceback import format_exc as _format_exc
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/traceback.py", line 5, in &lt;module&gt;
    import linecache
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/linecache.py", line 11, in &lt;module&gt;
    import tokenize
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/tokenize.py", line 35, in &lt;module&gt;
    from token import *
  File "__init__.pxd", line 155, in init spacy.tokens.token
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/__init__.py", line 142, in &lt;module&gt;
    from . import add_newdocs
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/add_newdocs.py", line 13, in &lt;module&gt;
    from numpy.lib import add_newdoc
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/lib/__init__.py", line 8, in &lt;module&gt;
    from .type_check import *
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/lib/type_check.py", line 11, in &lt;module&gt;
    import numpy.core.numeric as _nx
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/core/__init__.py", line 74, in &lt;module&gt;
    from numpy.testing.nosetester import _numpy_tester
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/envs/spacy2-bugfix/lib/python3.6/site-packages/numpy/testing/__init__.py", line 10, in &lt;module&gt;
    from unittest import TestCase
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/unittest/__init__.py", line 59, in &lt;module&gt;
    from .case import (TestCase, FunctionTestCase, SkipTest, skip, skipIf,
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/unittest/case.py", line 6, in &lt;module&gt;
    import logging
  File "/Users/burtondewilde/.pyenv/versions/3.6.0/lib/python3.6/logging/__init__.py", line 209, in &lt;module&gt;
    _lock = threading.RLock()
AttributeError: module 'threading' has no attribute 'RLock'
Traceback (most recent call last):
  File "/Users/burtondewilde/Desktop/github/spaCy/bin/cythonize.py", line 157, in &lt;module&gt;
    run(args.root)
  File "/Users/burtondewilde/Desktop/github/spaCy/bin/cythonize.py", line 148, in run
    process(base, filename, db)
  File "/Users/burtondewilde/Desktop/github/spaCy/bin/cythonize.py", line 114, in process
    preserve_cwd(base, process_pyx, root + '.pyx', root + '.cpp')
  File "/Users/burtondewilde/Desktop/github/spaCy/bin/cythonize.py", line 79, in preserve_cwd
    func(*args)
  File "/Users/burtondewilde/Desktop/github/spaCy/bin/cythonize.py", line 61, in process_pyx
    raise Exception('Cython failed')
Exception: Cython failed
Traceback (most recent call last):
  File "setup.py", line 227, in &lt;module&gt;
    setup_package()
  File "setup.py", line 172, in setup_package
    generate_cython(root, 'spacy')
  File "setup.py", line 104, in generate_cython
    raise RuntimeError('Running cythonize failed')
RuntimeError: Running cythonize failed
&lt;/denchmark-code&gt;

		</comment>
		<comment id='2' author='Nicholas-Mitchell' date='2018-01-15T15:42:39Z'>
		Hmm. The loss variable there is defined as a float32 within thinc/extra/search.pxd, so I'm not sure what's going on here. Possibly a different version of thinc was being drawn in for the header?
I don't love closing issues I couldn't reproduce, but I'm not sure there's anything to action here. Please reopen if problems persist.
		</comment>
		<comment id='3' author='Nicholas-Mitchell' date='2018-05-08T02:55:27Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>