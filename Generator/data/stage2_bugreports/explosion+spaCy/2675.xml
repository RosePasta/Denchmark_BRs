<bug id='2675' author='ned2' open_date='2018-08-15T14:38:12Z' closed_time='2018-08-15T15:21:51Z'>
	<summary>on_match function is not firing for Matcher entries in the presence of greedy operators</summary>
	<description>
on_match functions that are supplied to Matcher are not firing for matched of patterns that use * and + OP constraints.  ? seems to be ok. This behaviour is present in both the spacy-nightly and also 2.0.12.
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

import spacy
from spacy.matcher import Matcher
nlp = spacy.load('en_core_web_sm')

def on_match(matcher, doc, id, matches):
    print('Matched!', matches)

matcher = Matcher(nlp.vocab)

matcher.add('JOHN', on_match, [{'LEMMA': 'invest'}, {'OP': '*'}, {'LOWER': 'china'}])
doc = nlp("John Doe invests in one more stock in China.")

for match in matcher(doc):
    print(match)
The above snipped does successfully find a match, printing this:
&lt;denchmark-code&gt;(10603582739829208913, 2, 9)
&lt;/denchmark-code&gt;

However the on_match function does not fire, as nothing is printed.
The following snippet on the other hand, which has the greedy wildcard removed (and an updated string which matches) does cause the on_match function to fire:
import spacy
from spacy.matcher import Matcher
nlp = spacy.load('en_core_web_sm')

def on_match(matcher, doc, id, matches):
    print('Matched!', matches)

matcher = Matcher(nlp.vocab)

matcher.add('JOHN', on_match, [{'LEMMA': 'invest'}, {'LOWER': 'china'}])
doc = nlp("John Doe invests China.")

for match in matcher(doc):
    print(match)
Outputting this:
&lt;denchmark-code&gt;Matched! [(15211191707941042503, 2, 4)]
(15211191707941042503, 2, 4)
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


Operating System: Ubuntu 18.04
Python Version Used: 3.6.6
spaCy Version Used: spacy-nightly and also 2.0.12

	</description>
	<comments>
		<comment id='1' author='ned2' date='2018-08-15T15:17:01Z'>
		This has the same root cause as &lt;denchmark-link:https://github.com/explosion/spaCy/issues/2671&gt;#2671&lt;/denchmark-link&gt;
 --- which I've just fixed. Nice timing!
The problem was that the entity ID was being returned incorrectly in some situations, and it's the entity ID that is used to key the on_match callbacks. With the wrong ID matching, the callback was not called. This should now be fixed.
		</comment>
		<comment id='2' author='ned2' date='2018-09-14T15:22:47Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>