<bug id='1521' author='davidgengenbach' open_date='2017-11-09T00:59:19Z' closed_time='2017-11-09T01:29:25Z'>
	<summary>Doc.to_disk() exception</summary>
	<description>
First of all, thanks for your library!
I have a problem serializing docs. Here is a minimal example of what I want to do:
import spacy
nlp = spacy.load('en')
texts = ['The brown fox jumped over the fence.', 'The fence was not that tall anyways.']
docs = nlp.pipe(texts)
# Here I want to save the docs to the disk
list(docs)[0].to_disk('some_file')
but I get the following exception:
&lt;denchmark-code&gt;---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
&lt;ipython-input-24-449d2fe86bdf&gt; in &lt;module&gt;()
      4 texts = ['The brown fox jumped over the fence.', 'The fence was not that tall anyways.']
      5 docs = nlp.pipe(texts)
----&gt; 6 list(docs)[0].to_disk('some_file')

doc.pyx in spacy.tokens.doc.Doc.to_disk()

AttributeError: 'str' object has no attribute 'open'
&lt;/denchmark-code&gt;

What is the correct way to save multiple documents when using nlp.pipe(texts)? I also tried doing it like this:
import spacy
import pickle

nlp = spacy.load('en')
texts = ['The brown fox jumped over the fence.', 'The fence was not that tall anyways.']
docs = nlp.pipe(texts)
docs_b = [doc.to_bytes() for doc in docs]
with open('some_file', 'wb') as f:
    pickle.dump(docs_b, f)
But this produces quite large files (I assume it also saves the model with it?).
Again, thanks for the library, your work and maybe answering this question! üëç
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.0.2
Platform: Darwin-17.0.0-x86_64-i386-64bit (macOS 10.13)
Python version: 3.6.2
Models: en

	</description>
	<comments>
		<comment id='1' author='davidgengenbach' date='2017-11-09T01:06:27Z'>
		Ah, I am sorry. I just saw that just pickling the Docs now works with spaCy 2.0.
I am leaving this issue nevertheless - maybe somebody also runs into this problem when migrating to spaCy 2.0.
import spacy
import pickle

nlp = spacy.load('en')
texts = ['The brown fox jumped over the fence.', 'The fence was not that tall anyways.']
docs = nlp.pipe(texts)
with open('some_file', 'wb') as f:
    pickle.dump(list(docs), f)
		</comment>
		<comment id='2' author='davidgengenbach' date='2017-11-09T01:23:25Z'>
		Thanks! It looks like there's a bug in doc.to_disk(): it's expecting a pathlib.Path() object, when it should also accept a string.
In general I think you'll find the doc.to_bytes() method to be the best way to serialize Doc objects. It lets you do the i/o, and it should be faster and smaller than pickle. Another option if you're storing large datasets is to use doc.to_array(), picking only the attributes you need.
		</comment>
		<comment id='3' author='davidgengenbach' date='2017-11-09T11:28:22Z'>
		Thanks for answering so quickly and for the quick bug fix!
I still have a little problem with the file size of the serialized docs - here is a graph of what I mean:
&lt;denchmark-link:https://user-images.githubusercontent.com/2621491/32603526-543c9acc-c54a-11e7-9921-8bf1f8654661.png&gt;&lt;/denchmark-link&gt;

Both the doc.to_bytes() and the plain saving with pickle create quite big files! For just 500 documents, the size of the serialized docs is above 400mb! Is there a way to serialize the documents all at once without such big file sizes?
EDIT: I oversaw your other comment about the doc.to_array() way. Thanks a lot for answering!
(&lt;denchmark-link:https://gist.github.com/davidgengenbach/6550d1bf61ee2e400d941f0e496891bf&gt;Here&lt;/denchmark-link&gt;
 is the somewhat verbose code to plot this graph)
		</comment>
		<comment id='4' author='davidgengenbach' date='2017-11-11T04:55:30Z'>
		If I use the doc.to_bytes() to export the doc, do I still have to export the Vocab object separately from the Doc or is it included?
		</comment>
		<comment id='5' author='davidgengenbach' date='2017-11-19T20:46:01Z'>
		fwiw I'm also running into some of the issues described above. Previously, users could write multiple Docs to a single file with
&lt;denchmark-code&gt;with open(filepath, mode='wb') as f:
    for doc in docs:
        f.write(doc.to_bytes())
&lt;/denchmark-code&gt;

then read those docs back in via Doc.read_bytes(), which took care of segmenting the file's bytes into individual Docs:
&lt;denchmark-code&gt;docs = []
with open(filepath, mode='rb') as f:
    for bytes_string in Doc.read_bytes(f):
        docs.append(Doc(Vocab).from_bytes(bytes_string))
&lt;/denchmark-code&gt;

But this no longer works in spacy v2, since Doc.read_bytes() has been removed, and the individual docs' byte strings contain newlines, so this can't be done easily in the style of JSONL files.
Is there a recommended way to save multiple Docs together in the same file? As far as I can tell, the documentation only covers the single Doc case.
		</comment>
		<comment id='6' author='davidgengenbach' date='2017-11-27T03:53:27Z'>
		After looking into the Doc.to_bytes() and Doc.from_bytes() source code, I don't see any decent way to write+read multiple Docs as bytes from the same file. (Full disclosure: I'm not experienced with msgpack, and a couple hours with the docs and examples of its usage in the wild didn't prove particularly insightful.)
As I wrote above, it's straightforward to write multiple docs-as-bytes out to the same file, but the old way of reading the data back in no longer works, and the way the methods are written (with corresponding util.to_bytes(), util.from_bytes() functions) seems to force a one-Doc-per-file use case.
For example, this too-easy option doesn't work:
&lt;denchmark-code&gt;docs = []
with io.open(fname, mode='rb') as f:
    for line in f:
        docs.append(Doc(Vocab()).from_bytes(line))
&lt;/denchmark-code&gt;

Although you can use msgpack.Unpacker to iterate over the stored objects one-by-one, these objects are unpacked dicts incompatible with the expected inputs for the existing Doc methods:
&lt;denchmark-code&gt;with io.open(fname, mode='rb') as f:
    unpacker = msgpack.Unpacker(f)
    for obj in unpacker:
        print(obj.keys())
        break
&lt;/denchmark-code&gt;

Here,  =&gt; . I believe this is equivalent to  in &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx#L803&gt;this line&lt;/denchmark-link&gt;
 midway through , since the deserializers are all null-op lambdas and the docs don't have any user_data. But to initialize new docs from these dicts, I'd have to effectively duplicate much of the code elsewhere in , which seems like a bad idea.
I looked to  &lt;denchmark-link:https://pandas.pydata.org/pandas-docs/stable/io.html#msgpack&gt;for inspiration&lt;/denchmark-link&gt;
, but &lt;denchmark-link:https://github.com/pandas-dev/pandas/tree/master/pandas/io/msgpack&gt;the code&lt;/denchmark-link&gt;
 was sufficiently complicated that I didn't get very far.
I should note that pickling does work, which is great, but you have to write all the docs out at once as a list (load them all into memory...), and the file size is surprisingly large, as somebody pointed out above.
This issue is my last blocker to making textacy compatible with v2, and I haven't found any good options. Maybe (hopefully) I've missed something in the docs, or github, or gitter chat.
&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 , do you have any suggestions? 
		</comment>
		<comment id='7' author='davidgengenbach' date='2018-05-08T06:55:19Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>