<bug id='1554' author='tc64' open_date='2017-11-11T21:54:18Z' closed_time='2018-03-28T21:10:02Z'>
	<summary>Assertion Error using xx_ent_wiki_sm in default pipeline in certain cases</summary>
	<description>
I want to replace the default ner model in en_core_web_sm pipeline, with that of xx_ent_wiki_sm.
When I do this, certain text gives an Assertion error.
I'm assuming I should be able to do this, but of course I could be misunderstanding something.
Details:
&lt;denchmark-code&gt;# Full text
full = """The US command in Saigon initially believed that combat operations around KSCB during 1967 were part of a series of minor North Vietnamese offensives in the border regions. That appraisal was later altered when it was discovered that the NVA was moving major forces into the area. In response, US forces were built up before the NVA isolated the Marine base. Once the base came under siege a series of actions were fought over a period of five months. During this time, KSCB and the hilltop outposts around it were subjected to constant North Vietnamese artillery, mortar, and rocket attacks, and several infantry assaults. To support the Marine base, a massive aerial bombardment campaign (Operation Niagara) was launched by the United States Air Force."""

# Last sentence removed, everything works
short = """The US command in Saigon initially believed that combat operations around KSCB during 1967 were part of a series of minor North Vietnamese offensives in the border regions. That appraisal was later altered when it was discovered that the NVA was moving major forces into the area. In response, US forces were built up before the NVA isolated the Marine base. Once the base came under siege a series of actions were fought over a period of five months. During this time, KSCB and the hilltop outposts around it were subjected to constant North Vietnamese artillery, mortar, and rocket attacks, and several infantry assaults."""

# last sentence, breaks
problem_sent = """To support the Marine base, a massive aerial bombardment campaign (Operation Niagara) was launched by the United States Air Force."""

# problem phrase, breaks
problem_phrase = "(Operation Niagara)"

# replace problem phrase in parens with another entity, works
problem_sent_sub1 = """To support the Marine base, a massive aerial bombardment campaign (Bill Clinton) was launched by the United States Air Force."""

# replace with some other term, breaks
problem_sent_sub2 = """To support the Marine base, a massive aerial bombardment campaign (Something Else) was launched by the United States Air Force."""

def experiment(text):
    # apply default model on text
    nlp = spacy.load('en')
    doc_en_orig = nlp(text)
    ents_en_orig = ["%s/%s" % (e.text, e.label_) for e in doc_en_orig.ents]
    print(ents_en_orig)

    # apply wiki ner model on text
    nlp_xx = spacy.load('xx')
    doc_xx = nlp_xx(text)
    ents_xx = ["%s/%s" % (e.text, e.label_) for e in doc_xx.ents]
    print(ents_xx)

    # replace ner pipe with wiki model
    nlp.replace_pipe('ner', nlp_xx.get_pipe('ner'))

    # apply updated model, after replacing default ner with wiki ner, on text
    doc_en_new = nlp(text)
    ents_en_new = ["%s/%s" % (e.text, e.label_) for e in doc_en_new.ents]
    print(ents_en_new)

    return (ents_en_orig, ents_xx, ents_en_new)
&lt;/denchmark-code&gt;

The following run fine:
experiment(short)
experiment(problem_sent_sub1)
The following break on
ents_en_new = ["%s/%s" % (e.text, e.label_) for e in doc_en_new.ents]
experiment(full)
experiment(problem_sent)
experiment(problem_phrase)
experiment(problem_sent_sub2)
The error is:
&lt;denchmark-code&gt;File "test.py", line 43, in experiment
    ents_en_new = ["%s/%s" % (e.text, e.label_) for e in doc_en_new.ents]
  File "doc.pyx", line 415, in spacy.tokens.doc.Doc.ents.__get__
  File "span.pyx", line 61, in spacy.tokens.span.Span.__cinit__
AssertionError: 7654241940133152407
&lt;/denchmark-code&gt;

Not sure how proceed for this one.
&lt;denchmark-h:h2&gt;Environment&lt;/denchmark-h&gt;


spaCy version: 2.0.2
Platform: Linux-4.10.0-38-generic-x86_64-with-Ubuntu-16.04-xenial
Models: en_core_web_sm, en_core_web_lg, en, xx_ent_wiki_sm, en_core_web_md, xx
Python version: 3.5.2
Both en_core_web_sm and xx_ent_wiki_sm are version 2.0.0

	</description>
	<comments>
		<comment id='1' author='tc64' date='2017-11-11T22:19:18Z'>
		Seems like this could be related to &lt;denchmark-link:https://github.com/explosion/spaCy/issues/1547&gt;#1547&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='tc64' date='2018-05-07T17:53:23Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>