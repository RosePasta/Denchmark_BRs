<bug id='4723' author='JohnGiorgi' open_date='2019-11-27T16:06:50Z' closed_time='2019-12-11T17:19:43Z'>
	<summary>KeyError when trying to follow provided train_entity_linker.py script</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

Simply run the provided &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/examples/training/pretrain_kb.py&gt;pretrain_kb.py&lt;/denchmark-link&gt;
 and &lt;denchmark-link:https://github.com/explosion/spaCy/blob/master/examples/training/train_entity_linker.py&gt;train_entity_linker.py&lt;/denchmark-link&gt;
 scripts. E.g.
&lt;denchmark-code&gt;python pretrain_kb.py -m en_core_web_lg -n 1 -o ./tmp
python train_entity_linker.py ./tmp/kb ./tmp/vocab -o ./tmp -n 1       
&lt;/denchmark-code&gt;

During the execution of the second command, a KeyError is raised with the following traceback
&lt;denchmark-code&gt;Created blank 'en' model with vocab from 'tmp/vocab'
Loaded Knowledge Base from 'tmp/kb'
('Russ Cochran his reprints include EC Comics.', 'Russ Cochran captured his first major title with his son as caddie.', 'Russ Cochran has been publishing comic art.', "Russ Cochran was a member of University of Kentucky's golf team.") ({'links': {(0, 12): {'Q7381115': 1.0, 'Q2146908': 0.0}}}, {'links': {(0, 12): {'Q7381115': 0.0, 'Q2146908': 1.0}}}, {'links': {(0, 12): {'Q7381115': 1.0, 'Q2146908': 0.0}}}, {'links': {(0, 12): {'Q7381115': 0.0, 'Q2146908': 1.0}}})
Traceback (most recent call last):
  File "train_entity_linker.py", line 167, in &lt;module&gt;
    plac.call(main)
  File "/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/plac_core.py", line 367, in call
    cmd, result = parser.consume(arglist)
  File "/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/plac_core.py", line 232, in consume
    return cmd, self.func(*(args + varargs + extraopts), **kwargs)
  File "train_entity_linker.py", line 127, in main
    sgd=optimizer,
  File "/Users/johngiorgi/miniconda3/envs/el/lib/python3.7/site-packages/spacy/language.py", line 515, in update
    proc.update(docs, golds, sgd=get_grads, losses=losses, **kwargs)
  File "pipes.pyx", line 1219, in spacy.pipeline.pipes.EntityLinker.update
KeyError: (0, 12)
&lt;/denchmark-code&gt;

There is another closed issue (&lt;denchmark-link:https://github.com/explosion/spaCy/issues/4469&gt;#4469&lt;/denchmark-link&gt;
) that reports this same problem. Suggestions are to use the latest version of SpaCy (I tried with  and ) and to update the line
&lt;denchmark-code&gt;kb = KnowledgeBase(vocab=nlp.vocab)
&lt;/denchmark-code&gt;

in &lt;denchmark-link:https://github.com/explosion/spaCy/blob/48ea2e8d0ff6e46f65761425c24369c5d4ac30e1/examples/training/pretrain_kb.py#L57&gt;pretrain_kb.py&lt;/denchmark-link&gt;
 with
&lt;denchmark-code&gt;kb = KnowledgeBase(vocab=nlp.vocab, entity_vector_length=64)
&lt;/denchmark-code&gt;

This solution did not work for me (I recieve the same error as above).
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.2.2
Platform: Darwin-19.0.0-x86_64-i386-64bit
Python version: 3.7.5

	</description>
	<comments>
		<comment id='1' author='JohnGiorgi' date='2019-12-10T16:06:16Z'>
		Thanks for the very helpful report, &lt;denchmark-link:https://github.com/JohnGiorgi&gt;@JohnGiorgi&lt;/denchmark-link&gt;
 !
The example scripts got outdated after the last refactor of the EL pipeline, which assumes the entities are properly set in the document. To simulate this, I added an EntityRuler to the example script, but for a realistic case you'd need to have a proper NER module.
I also created a more friendly warning than the one you ran into ...
PR &lt;denchmark-link:https://github.com/explosion/spaCy/pull/4789&gt;#4789&lt;/denchmark-link&gt;
 contains the fixes. Once merged, feel free to try the code again and let me know if there still would be any issues.
		</comment>
		<comment id='2' author='JohnGiorgi' date='2020-01-04T16:58:35Z'>
		Hi &lt;denchmark-link:https://github.com/svlandeg&gt;@svlandeg&lt;/denchmark-link&gt;
,
Thanks for the PR! Sorry, this took a while, but I re-ran the scripts and now face a thinc.exceptions.ShapeMismatchError when running the latest version of the pretrain_kb.py script.
I opened another issue regarding this error (&lt;denchmark-link:https://github.com/explosion/spaCy/issues/4876&gt;#4876&lt;/denchmark-link&gt;
)
		</comment>
		<comment id='3' author='JohnGiorgi' date='2020-02-03T18:46:02Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>