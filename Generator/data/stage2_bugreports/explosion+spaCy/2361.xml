<bug id='2361' author='ansgar-t' open_date='2018-05-24T16:00:48Z' closed_time='2018-05-28T16:36:45Z'>
	<summary>displacy.render produces invalid svg by not escaping "&amp;lt;"</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;import spacy
from spacy import displacy
nlp = spacy.load('de_core_news_sm')

doc = nlp('eins &lt; zwei')
print(displacy.render(doc))
&lt;/denchmark-code&gt;

In the resulting svg code you can see that the "&lt;" is not escaped:
&lt;denchmark-code&gt;...
&lt;text class="displacy-token" fill="currentColor" text-anchor="middle" y="134.5"&gt;
    &lt;tspan class="displacy-word" fill="currentColor" x="225"&gt;&lt;&lt;/tspan&gt;
    &lt;tspan class="displacy-tag" dy="2em" fill="currentColor" x="225"&gt;CONJ&lt;/tspan&gt;
&lt;/text&gt;
...
&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;My Environment&lt;/denchmark-h&gt;


Operating System: Mac OS 10.12.6
Python Version Used: 3.5.1
spaCy Version Used: 2.0.11

	</description>
	<comments>
		<comment id='1' author='ansgar-t' date='2018-05-25T10:52:09Z'>
		Thanks, good point! This should definitely be fixed. I'll also tag this issue help wanted in case someone else wants to take it on in the meantime.
		</comment>
		<comment id='2' author='ansgar-t' date='2018-05-26T13:45:39Z'>
		I've prepared a fix for it and am trying to test everything locally.
However, there are some models referenced in conftest.py that are not available via the download command:
- de_core_news_md
- xx_ent_web_md
Am I missing something?
		</comment>
		<comment id='3' author='ansgar-t' date='2018-05-26T13:58:35Z'>
		Ah, thank you so much! üôè

However, there are some models referenced in conftest.py that are not available via the download command:

Yes, that looks like a typo and should be xx_ent_web_sm and de_core_news_sm. We probably never noticed because the model tests will skip if a model isn't installed (I admit, not the most elegant solution).
Btw, in this case, it's also totally fine if you don't run all the model tests. You didn't edit anything that would make a difference here and the test you added only needs the tokenizer anyways.
		</comment>
		<comment id='4' author='ansgar-t' date='2018-05-26T14:03:45Z'>
		
Btw, in this case, it's also totally fine if you don't run all the model tests. You didn't edit anything that would make a difference here and the test you added only needs the tokenizer anyways.

yeah, the risk seems small... :)
But when I did run them, I saw some failures, which also appeared using the commit before my fix:
&lt;denchmark-code&gt;============================================================================================= FAILURES =============================================================================================
_______________________________________________________________________ test_issue401[en_core_web_sm-Jane's got a new car-1] _______________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text = "Jane's got a new car", i = 1

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text,i', [("Jane's got a new car", 1),
                                        ("Jane thinks that's a nice car", 3)])
    def test_issue401(EN, text, i):
        """Text that 's in contractions is not lemmatized as '."""
        tokens = EN(text)
&gt;       assert tokens[i].lemma_ != "'"
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue401.py:13: AttributeError
__________________________________________________________________ test_issue401[en_core_web_sm-Jane thinks that's a nice car-3] ___________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text = "Jane thinks that's a nice car", i = 3

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text,i', [("Jane's got a new car", 1),
                                        ("Jane thinks that's a nice car", 3)])
    def test_issue401(EN, text, i):
        """Text that 's in contractions is not lemmatized as '."""
        tokens = EN(text)
&gt;       assert tokens[i].lemma_ != "'"
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue401.py:13: AttributeError
___________________________________________________________________________ test_issue686[en_core_web_sm-He is the man] ____________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text = 'He is the man'

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text', ["He is the man", "he is the man"])
    def test_issue686(EN, text):
        """Test that pronoun lemmas are assigned correctly."""
        tokens = EN(text)
&gt;       assert tokens[0].lemma_ == "-PRON-"
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue686.py:12: AttributeError
___________________________________________________________________________ test_issue686[en_core_web_sm-he is the man] ____________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text = 'he is the man'

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text', ["He is the man", "he is the man"])
    def test_issue686(EN, text):
        """Test that pronoun lemmas are assigned correctly."""
        tokens = EN(text)
&gt;       assert tokens[0].lemma_ == "-PRON-"
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue686.py:12: AttributeError
_____________________________________________________________________ test_issue717[en_core_web_sm-You're happy-You are happy] _____________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text1 = "You're happy", text2 = 'You are happy'

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text1,text2',
        [("You're happy", "You are happy"),
         ("I'm happy", "I am happy"),
         ("he's happy", "he's happy")])
    def test_issue717(EN, text1, text2):
        """Test that contractions are assigned the correct lemma."""
        doc1 = EN(text1)
        doc2 = EN(text2)
&gt;       assert doc1[1].lemma_ == doc2[1].lemma_
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue717.py:16: AttributeError
________________________________________________________________________ test_issue717[en_core_web_sm-I'm happy-I am happy] ________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text1 = "I'm happy", text2 = 'I am happy'

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text1,text2',
        [("You're happy", "You are happy"),
         ("I'm happy", "I am happy"),
         ("he's happy", "he's happy")])
    def test_issue717(EN, text1, text2):
        """Test that contractions are assigned the correct lemma."""
        doc1 = EN(text1)
        doc2 = EN(text2)
&gt;       assert doc1[1].lemma_ == doc2[1].lemma_
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue717.py:16: AttributeError
_______________________________________________________________________ test_issue717[en_core_web_sm-he's happy-he's happy] ________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text1 = "he's happy", text2 = "he's happy"

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text1,text2',
        [("You're happy", "You are happy"),
         ("I'm happy", "I am happy"),
         ("he's happy", "he's happy")])
    def test_issue717(EN, text1, text2):
        """Test that contractions are assigned the correct lemma."""
        doc1 = EN(text1)
        doc2 = EN(text2)
&gt;       assert doc1[1].lemma_ == doc2[1].lemma_
E       AttributeError: 'str' object has no attribute 'lemma_'

spacy/tests/regression/test_issue717.py:16: AttributeError
________________________________________________________________________________ test_issue719[en_core_web_sm-s...] ________________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;, text = 's...'

    @pytest.mark.models('en')
    @pytest.mark.parametrize('text', ["s..."])
    def test_issue719(EN, text):
        """Test that the token 's' is not lemmatized into empty string."""
        tokens = EN(text)
&gt;       assert tokens[0].lemma_ != ''
E       IndexError: string index out of range

spacy/tests/regression/test_issue719.py:12: IndexError
__________________________________________________________________________________ test_issue955[en_core_web_sm] ___________________________________________________________________________________

EN = &lt;spacy.lang.en.English object at 0x10f2c6e48&gt;

    @pytest.mark.models('en')
    def test_issue955(EN):
        '''Test that we don't have any nested noun chunks'''
        doc = EN('Does flight number three fifty-four require a connecting flight'
                 ' to get to Boston?')
        seen_tokens = set()
&gt;       for np in doc.noun_chunks:
E       AttributeError: 'str' object has no attribute 'noun_chunks'

spacy/tests/regression/test_issue995.py:12: AttributeError
=========================================================== 9 failed, 1408 passed, 132 skipped, 46 xfailed, 10 xpassed in 250.05 seconds ===========================================================
&lt;/denchmark-code&gt;

		</comment>
		<comment id='5' author='ansgar-t' date='2018-05-26T16:16:20Z'>
		Hmm, this is mysterious! ü§î For some reason, the EN object seems to produce strings instead of tokens... but I don't see why this would only occur with the English model in those particular cases and not with any of the others. Maybe you could open a separate issue for that so we can investigate what's going on?
Feel free to submit the PR btw!
		</comment>
		<comment id='6' author='ansgar-t' date='2018-05-27T10:04:36Z'>
		and here's the separate issue for the failed tests: &lt;denchmark-link:https://github.com/explosion/spaCy/issues/2379&gt;#2379&lt;/denchmark-link&gt;

		</comment>
		<comment id='7' author='ansgar-t' date='2018-06-27T16:42:06Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>