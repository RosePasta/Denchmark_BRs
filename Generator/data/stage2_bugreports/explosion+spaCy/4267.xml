<bug id='4267' author='jenojp' open_date='2019-09-10T14:10:54Z' closed_time='2019-09-18T19:37:18Z'>
	<summary>Different ent_iob behavior after adding EntityRuler to pipeline</summary>
	<description>
I'm not totally sure of the expected behavior but after adding an EntityRuler to a pipeline, non entities seem to get .ent_iob tags of 0 rather than 2 when just using the EntityRecognizer. This affects what doc.is_nered returns.
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

import spacy
from spacy.pipeline import EntityRuler

nlp = spacy.load("en_core_web_sm")
print(nlp.pipe_names)
## ['tagger', 'parser', 'ner']

doc = nlp("fgfgdghgdh")
print(doc.is_nered)
## True

for token in doc:
    print(token.ent_iob)
## 2

#addd entity ruler and run again
ruler = EntityRuler(nlp)
patterns = [{"label":"SOFTWARE", "pattern":"spacy"}]

ruler.add_patterns(patterns)
nlp.add_pipe(ruler)
print(nlp.pipe_names)
## ['tagger', 'parser', 'ner', 'entity_ruler']

doc = nlp("fgfgdghgdh")
print(doc.is_nered)
## False

for token in doc:
    print(token.ent_iob)
## 0
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;

&lt;denchmark-h:h2&gt;Info about spaCy&lt;/denchmark-h&gt;


spaCy version: 2.1.8
Platform: Darwin-18.7.0-x86_64-i386-64bit
Python version: 3.6.8

	</description>
	<comments>
		<comment id='1' author='jenojp' date='2019-09-10T20:07:04Z'>
		Thanks for the report! I do think this is a bug. From the docs about EntityRuler:

If it’s added before the "ner" component, the entity recognizer will respect the existing entity spans and adjust its predictions around it. This can significantly improve accuracy in some cases. If it’s added after the "ner" component, the entity ruler will only add spans to the doc.ents if they don’t overlap with existing entities predicted by the model.

In this case it's added after the ner, and it should respect the NER annotations. Even if there are no entities found by the NER, I would still expect -as a user- that doc.is_nered would have stayed True.
		</comment>
		<comment id='2' author='jenojp' date='2019-09-10T20:20:18Z'>
		Huh, setting doc.ents does this:



spaCy/spacy/tokens/doc.pyx


        Lines 547 to 550
      in
      669a7d3






 for i in range(self.length): 



 self.c[i].ent_type = 0 



 self.c[i].ent_kb_id = 0 



 self.c[i].ent_iob = 0 # Means missing. 





Maybe the resetting loop should preserve 2 in cases where it's 2? I'm not sure if there are some side effects I'm not thinking of...
		</comment>
		<comment id='3' author='jenojp' date='2019-09-10T20:33:16Z'>
		Ha, yea, I was just looking at the same. One approach would be to set the default  to 2 instead of 0 if , see &lt;denchmark-link:https://github.com/svlandeg/spaCy/commit/a6c137f82a68e0fa29a8869ae6c87612e7182e4b&gt;here&lt;/denchmark-link&gt;
, but that makes another unit test fail...
		</comment>
		<comment id='4' author='jenojp' date='2019-09-10T20:39:22Z'>
		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
 : I guess this discussion has been had in the &lt;denchmark-link:https://github.com/explosion/spaCy/commit/7d4687162f1792111902754690297a3b0bc86237#diff-c80066060b9c4b494e7e89fe77fb823b&gt;past &lt;/denchmark-link&gt;
... So it is in fact desired behaviour that the setting of  resets everything to 0 (empty string) ? What about the original case discussed in this topic - would you expect the  to be reset to 0 (empty string) as well?
		</comment>
		<comment id='5' author='jenojp' date='2019-09-10T20:40:46Z'>
		I don't think it's possible to have the behavior in test_doc_add_entities_set_ents_iob and the correct is_nered, at least not without major changes to is_nered. I'm not sure why we would want the behavior in test_doc_add_entities_set_ents_iob, though?
		</comment>
		<comment id='6' author='jenojp' date='2019-09-14T09:36:31Z'>
		Ok it turns out this requires a more in-depth analysis and solution ;-) Will look into it ASAP.
		</comment>
		<comment id='7' author='jenojp' date='2019-10-18T20:08:07Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>