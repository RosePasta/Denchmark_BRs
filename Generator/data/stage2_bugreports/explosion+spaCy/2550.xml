<bug id='2550' author='chandan2495' open_date='2018-07-16T10:18:31Z' closed_time='2018-12-20T11:59:16Z'>
	<summary>Error should be raised if you try to set conflicting doc.ents</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

import spacy
from spacy.tokens import Span
nlp = spacy.load('en_core_web_sm')
doc = nlp(u"Louisiana Office of Conservation")
print(doc.ents[0], doc.ents[0].label_)

entity = Span(doc, 0, 1, label=391L)
print(entity, entity.label_)

doc.ents = list(doc.ents) + [entity]

print(doc.ents[0], doc.ents[0].label_)
&lt;denchmark-h:h2&gt;Output:&lt;/denchmark-h&gt;

(Louisiana Office of Conservation, u'ORG')
(Louisiana, u'MONEY')
(Louisiana Office of Conservation, u'MONEY')
&lt;denchmark-h:h2&gt;Expected Behaviour:&lt;/denchmark-h&gt;

I was expecting MONEY entity to override the ORG entity and end offset of MONEY should have been used after merging. Please let me know if I got this wrong.
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


Operating System:Windows 7
Python Version Used: 2.7.12
spaCy Version Used: 2.0.7
Environment Information: None

	</description>
	<comments>
		<comment id='1' author='chandan2495' date='2018-07-16T10:49:47Z'>
		Thanks a lot for the great and detailed bug report üëç  I just tried the example and I can confirm that it's also reproducible in v2.1.0 nightly. The current behaviour is definitely a bug.
In terms of the expected behaviour: I suggest that spaCy should actually raise an error here. By definition, a token can only be part of one entity. So when the doc.ents are set and an overlapping entity exists, there's no clear answer for how this should be resolved. Which entity should take precedence?
So it's probably more intuitive and logical if spaCy raised with a message like: "Trying to set conflicting doc.ents: (0, 4, 'ORG') and (0, 1, 'MONEY'). A token can only be part of one entity, so make sure the entities you're setting don't overlap."
		</comment>
		<comment id='2' author='chandan2495' date='2018-07-17T07:41:09Z'>
		Thanks for quick reply Ines. I think the new span can take preference on existing one as this will help users to create new derived entities.
		</comment>
		<comment id='3' author='chandan2495' date='2018-12-20T11:59:16Z'>
		This is fixed now in   . See also &lt;denchmark-link:https://github.com/explosion/spaCy/issues/2566&gt;#2566&lt;/denchmark-link&gt;
.
		</comment>
		<comment id='4' author='chandan2495' date='2018-12-21T05:43:14Z'>
		I actually am finding the raising of an error here is causing more problems for me than it is resolving. I have many causes where I have for instance both "Jon" and and "Jon Smith" as NAME entities. I do want both tagged as a NAME. I would prefer instead in such cases to tag whichever entity is longer as this is likely to be more specific rather than raising an error. There are many other instances as well and I do not want to change my setup to exclude overlapping.
		</comment>
		<comment id='5' author='chandan2495' date='2018-12-25T09:17:38Z'>
		I would like spaCy to preserve the longer entity as well.
&lt;denchmark-link:https://github.com/isaacmg&gt;@isaacmg&lt;/denchmark-link&gt;

Both "Jon" and and "Jon Smith" can not be tagged as named since in first case 'Jon' gets a tag of 'U'
whereas in second case a 'B'. Model is bound to be confused.
One way as mentioned already is to take care of the overlaps.
Also there are scenarios where same token / char span is tagged to 2 entities. I guess that comes up as an error now. Not tested.
		</comment>
		<comment id='6' author='chandan2495' date='2019-01-16T20:09:58Z'>
		
This is fixed now in spacy-nightly  . See also #2566.

I still have error with this code even after installing spacy-nightly.

ValueError: [E103] Trying to set conflicting doc.ents: '(9, 11, u'ANIMAL')' and '(10, 11, u'ANIMAL')'. A token can only be part of one entity, so make sure the entities you're setting don't overlap.

		</comment>
		<comment id='7' author='chandan2495' date='2019-01-17T02:54:21Z'>
		&lt;denchmark-link:https://github.com/honnibal&gt;@honnibal&lt;/denchmark-link&gt;
  I would like an answer about how to override this error message at the very least. As this issue is currently blocking me from using the updated version of Spacy. I have tried a variety of solutions but nothing works (note for me eliminating overlapping entities is not an option). I cannot find any easy way to subclass Doc in order to the change the line of code that this PR implemented. What is the best way to override this behavior short of me maintaining my own separate Spacy branch?
Thanks.
		</comment>
		<comment id='8' author='chandan2495' date='2019-02-11T13:16:47Z'>
		There is a way to handle the error here?
Indeed to have the entity with the maximum length as default would be great.
is there a way to get the ID of the entity causing the error to handle the situation?
		</comment>
		<comment id='9' author='chandan2495' date='2019-02-27T16:12:39Z'>
		I am also running into this as a problem, I have a PhraseMatcher finding entities on top of the NER pipeline, but I would like to be able to link both entities. What's the suggested workaround?
		</comment>
		<comment id='10' author='chandan2495' date='2019-03-13T19:24:08Z'>
		Can someone provide sample code illustrating how to make the longer and/or newer span take precedence? &lt;denchmark-link:https://github.com/rbhambriiit&gt;@rbhambriiit&lt;/denchmark-link&gt;
, it sounds like you might know how to do this?
		</comment>
		<comment id='11' author='chandan2495' date='2019-04-12T19:57:34Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>