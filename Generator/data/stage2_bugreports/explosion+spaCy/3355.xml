<bug id='3355' author='Tpt' open_date='2019-03-04T20:37:34Z' closed_time='2019-03-09T17:53:20Z'>
	<summary>TextCategorizer: TypeError: Only cupy arrays can be concatenated on v2.1.0a10</summary>
	<description>
&lt;denchmark-h:h2&gt;How to reproduce the behaviour&lt;/denchmark-h&gt;

With Spacy v2.1.0a10 installed using pip install spacy-nightly[cuda100]==v2.1.0a10 if I try to train the TextCategorizer with gpu backend enabled I get the following error:
&lt;denchmark-code&gt;    nlp.update(texts, annotations, sgd=optimizer, drop=0.5, losses=losses)
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/spacy/language.py", line 449, in update
    proc.update(docs, golds, drop=drop, sgd=get_grads, losses=losses)
  File "pipes.pyx", line 918, in spacy.pipeline.pipes.TextCategorizer.update
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py", line 46, in begin_update
    X, inc_layer_grad = layer.begin_update(X, drop=drop)
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/thinc/api.py", line 132, in begin_update
    values = [fwd(X, *a, **k) for fwd in forward]
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/thinc/api.py", line 132, in &lt;listcomp&gt;
    values = [fwd(X, *a, **k) for fwd in forward]
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/thinc/api.py", line 225, in wrap
    output = func(*args, **kwargs)
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/thinc/neural/_classes/feed_forward.py", line 46, in begin_update
    X, inc_layer_grad = layer.begin_update(X, drop=drop)
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/spacy/_ml.py", line 92, in _preprocess_doc
    keys = ops.xp.concatenate(keys)
  File "/home/lstt/Projects/backend-sagemcom/venv/lib/python3.7/site-packages/cupy/manipulation/join.py", line 49, in concatenate
    return core.concatenate_method(tup, axis)
  File "cupy/core/core.pyx", line 2805, in cupy.core.core.concatenate_method
  File "cupy/core/core.pyx", line 2818, in cupy.core.core.concatenate_method
TypeError: Only cupy arrays can be concatenated
&lt;/denchmark-code&gt;

It seems to be an other occurrence of &lt;denchmark-link:https://github.com/explosion/spaCy/issues/1798&gt;#1798&lt;/denchmark-link&gt;
. I have not experienced this problem with the alpha version v2.1.0a8.
&lt;denchmark-h:h2&gt;Your Environment&lt;/denchmark-h&gt;


spaCy version: 2.1.0a10
Platform: Linux-4.20.11-arch1-1-ARCH-x86_64-with-arch
Python version: 3.7.2

	</description>
	<comments>
		<comment id='1' author='Tpt' date='2019-03-05T10:30:30Z'>
		Thanks! I thought I'd taken care of this. The GPU regressions are much more difficult to prevent, as we don't have automated CI running on GPU yet.
		</comment>
		<comment id='2' author='Tpt' date='2019-03-09T17:53:20Z'>
		Okay, fixed here: &lt;denchmark-link:https://github.com/explosion/spaCy/commit/28c26e212dcd17773209596bedb8d928b2583d84&gt;28c26e2&lt;/denchmark-link&gt;

This fix should be much more reliable than the previous patch in Thinc. We can later move this wrapper to Thinc, but for now it's useful to patch this without requiring a release.
		</comment>
		<comment id='3' author='Tpt' date='2019-04-08T18:04:04Z'>
		This thread has been automatically locked since there has not been any recent activity after it was closed. Please open a new issue for related bugs.
		</comment>
	</comments>
</bug>