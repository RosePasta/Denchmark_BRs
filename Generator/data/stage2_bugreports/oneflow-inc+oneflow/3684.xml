<bug id='3684' author='MARD1NO' open_date='2020-10-15T07:46:39Z' closed_time='2020-10-16T09:36:27Z'>
	<summary>Whether to check the batch axis?</summary>
	<description>
&lt;denchmark-h:h1&gt;é—®é¢˜å¼•å…¥&lt;/denchmark-h&gt;

å½“å¼ é‡ä¸å¼ é‡ä¹‹é—´è¿›è¡Œæ“ä½œï¼Œéœ€è¦å¯¹ batch_axis è¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ä»¥åŠæ¨å¯¼
ä»¥ oneflow.math.add ä¸ºä¾‹å­
&lt;denchmark-code&gt;@oneflow_export("math.add")
def add(
    x: Union[int, float, remote_blob_util.BlobDef],
    y: Union[int, float, remote_blob_util.BlobDef],
    name: Optional[str] = None,
) -&gt; remote_blob_util.BlobDef:
    if isinstance(x, (int, float)):
        return scalar_add(y, x, name)
    elif isinstance(y, (int, float)):
        return scalar_add(x, y, name)
    elif x.shape == y.shape and x.batch_axis == y.batch_axis:
        return element_wise_add(x, y, name)
    elif x.shape == (1,):
        return scalar_add_by_tensor(y, x, name)
    elif y.shape == (1,):
        return scalar_add_by_tensor(x, y, name)
    else:
        return broadcast_add(x, y, name)
&lt;/denchmark-code&gt;

å½“è¿›å…¥åˆ°æœ€åä¸€ä¸ªelseè¯­å¥åæ‰§è¡Œ broadcast_add ä¼šè°ƒç”¨åº•å±‚ç®—å­ 


oneflow/oneflow/user/ops/math_binary_broadcast_ops.cpp


         Line 174
      in
      ff1dcbe






 .SetBatchAxisInferFn(user_op::BatchAxisInferFnUtil::NaiveInferBatchAxis) \ 





ç®—å­ä½¿ç”¨ NaiveInferBatchAxis è¿›è¡ŒBatchAxisæ¨å¯¼
å…·ä½“é—®é¢˜åœ¨è¿™å¥è¯



oneflow/oneflow/core/framework/batch_axis_context.cpp


         Line 46
      in
      4d84afb






 if (cur_in_batch_axis-&gt;has_value() == false) { continue; } 





è¿™å¥è¯continueè·³è¿‡åé¢çš„è¯­å¥ï¼Œå¯¼è‡´æ²¡æœ‰æ£€æŸ¥ cur_in_batch_axis å’Œ batch_axis
&lt;denchmark-h:h1&gt;é—®é¢˜ç¤ºä¾‹&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;# å‡è®¾æœ‰ä¸ª Tensor A ï¼Œå…¶ batchaxis = None


# å¦å¤–æœ‰ä¸ª Tensor Bï¼Œå…¶ batchaxis = 0

Tensor A = oneflow.math.add(Tensor A, Tensor B) 
&lt;/denchmark-code&gt;

ç”±äº 


oneflow/oneflow/core/framework/batch_axis_context.cpp


         Line 46
      in
      4d84afb






 if (cur_in_batch_axis-&gt;has_value() == false) { continue; } 




 çš„å­˜åœ¨ï¼Œå¯¼è‡´ Tensor A è¢«è·³è¿‡äº†
è€Œæœ€ç»ˆ Tensor A çš„ batch_axis æ¥è‡ªäº Tensor Bçš„ã€‚è¿™ä¸€è¿‡ç¨‹æ˜¯ä¸åˆç†çš„
å’Œæ–‡éªçš„åˆæ­¥è®¨è®ºæ˜¯åˆ é™¤ if (cur_in_batch_axis-&gt;has_value() == false) { continue; },ä¸çŸ¥é“æ˜¯å¦ä¼šå¼•å‘å…¶ä»–é—®é¢˜ã€‚
	</description>
	<comments>
		<comment id='1' author='MARD1NO' date='2020-10-15T07:50:19Z'>
		broadcast add op å¯ä»¥ä¸ç”¨NaiveInferBatchAxisè¿™ä¸ªæ¥å£å§ï¼Œè‡ªå·±å†å®ç°ä¸€ä¸ªä¸check batch axisçš„ç‰ˆæœ¬å°±è¡Œäº†ã€‚
		</comment>
		<comment id='2' author='MARD1NO' date='2020-10-15T07:50:43Z'>
		ä½ ç†è§£é”™æˆ‘çš„æ„æ€ ğŸ˜‚ï¼Œä¸æ˜¯åˆ é™¤
&lt;denchmark-code&gt;if (cur_in_batch_axis-&gt;has_value() == false) { continue; }
&lt;/denchmark-code&gt;

è€Œæ˜¯åˆ é™¤æ£€æŸ¥
&lt;denchmark-code&gt;CHECK_EQ_OR_RETURN(batch_axis-&gt;value(), cur_in_batch_axis-&gt;value());
&lt;/denchmark-code&gt;

è€Œä¸”åœ¨è¿™ä¹‹å‰è¿˜éœ€è¦ç¡®å®šä¸‹æ˜¯å“ªä¸ª op infer batch axis è§¦å‘äº†è¿™ä¸ªé—®é¢˜ã€‚
		</comment>
		<comment id='3' author='MARD1NO' date='2020-10-15T07:52:47Z'>
		æˆ‘çš„å»ºè®®æ˜¯ä¸è¦æ”¹NaiveInferBatchAxisé‡Œçš„é€»è¾‘ï¼Œè€Œæ˜¯å†å®ç°ä¸€ä¸ªå¼±åŒ–ç‰ˆæœ¬çš„InferBatchAxisçš„å‡½æ•°ï¼Œé‡Œé¢ä¸åšè¯¥CHECKã€‚
		</comment>
		<comment id='4' author='MARD1NO' date='2020-10-15T07:53:58Z'>
		
æˆ‘çš„å»ºè®®æ˜¯ä¸è¦æ”¹NaiveInferBatchAxisé‡Œçš„é€»è¾‘ï¼Œè€Œæ˜¯å†å®ç°ä¸€ä¸ªå¼±åŒ–ç‰ˆæœ¬çš„InferBatchAxisçš„å‡½æ•°ï¼Œé‡Œé¢ä¸åšè¯¥CHECKã€‚

å…ˆè°ƒè¯•çœ‹çœ‹æ˜¯å“ªä¸ª op å‡ºäº†è¿™ä¸ªé—®é¢˜ï¼Œå†çœ‹ä¸€ä¸‹è¿™æ˜¯ä¸ªæ™®éæ€§é—®é¢˜è¿˜æ˜¯ç‰¹ä¾‹ã€‚
		</comment>
	</comments>
</bug>