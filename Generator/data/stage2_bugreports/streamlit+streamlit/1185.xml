<bug id='1185' author='sergiocalde94' open_date='2020-03-05T23:43:00Z' closed_time='2020-03-16T16:46:20Z'>
	<summary>Cannot cache a sklearn.pipeline.Pipeline fit</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

Error when try to caching sklearn Pipeline fit method (the function I "implemented" has no more methods).
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

What are the steps we should take to reproduce the bug:
from sklearn.preprocessing import OneHotEncoder
from xgboost import XGBClassifier
from sklearn.pipeline import Pipeline

@st.cache
def fit_model(model: Pipeline,
                      features: pd.DataFrame,
                      label: pd.DataFrame) -&gt; Pipeline:
    """Alias for `fit` methods of `Pipeline` object and implements streamlit cachi
    so we haven't to load the data all of the times that we rerun
    """
    model.fit(features, label)
    return model


X, y = make_classification(
    n_informative=5, n_redundant=0, random_state=42
)

enc = OneHotEncoder(drop='first')
xgb = XGBClassifier()
pipeline = Pipeline([('one_hot_encoder', enc),
                               ('xgboost', xgb)])

fit_model(pipeline, X, y)
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

Works perfectly like the non-caching version
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

InternalHashError: unhashable type: 'bytearray'
&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

No, it's the first time I tested it
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: Streamlit, version 0.56.0
Python version: Python 3.6.10 :: Anaconda, Inc.
Using Conda? YES
OS version: NAME="Ubuntu"
VERSION="18.10 (Cosmic Cuttlefish)"
Browser version: Firefox 67.0.4 (64-bit)

PD: Sorry for my english!
	</description>
	<comments>
		<comment id='1' author='sergiocalde94' date='2020-03-09T20:50:44Z'>
		Did you try using the &lt;denchmark-link:https://docs.streamlit.io/advanced_caching.html#the-hash-funcs-parameter&gt;hash_funcs parameter&lt;/denchmark-link&gt;
 in order to letting Streamlit know how to get the hash ?
		</comment>
		<comment id='2' author='sergiocalde94' date='2020-03-09T22:51:50Z'>
		Hi &lt;denchmark-link:https://github.com/sergiocalde94&gt;@sergiocalde94&lt;/denchmark-link&gt;
 , in addition to &lt;denchmark-link:https://github.com/arraydude&gt;@arraydude&lt;/denchmark-link&gt;
 's comment about trying the  parameter, if you provide more of the traceback of the error, it will be easier to help!
		</comment>
		<comment id='3' author='sergiocalde94' date='2020-03-10T22:31:29Z'>
		I can get it with hash params, maybe I'm missing something...
&lt;denchmark-h:h1&gt;Code to reproduce&lt;/denchmark-h&gt;

import streamlit as st
import pandas as pd

from sklearn.preprocessing import OneHotEncoder
from sklearn.datasets import make_classification
from xgboost import XGBClassifier
from sklearn.pipeline import Pipeline


@st.cache(hash_funcs=dict(Pipeline=lambda pipeline: id(pipeline)))
def fit_model(model: Pipeline,
                      features: pd.DataFrame,
                      label: pd.DataFrame) -&gt; Pipeline:
    """Alias for `fit` methods of `Pipeline` object and implements streamlit cachi
    so we haven't to load the data all of the times that we rerun
    """
    model.fit(features, label)
    return model


X, y = make_classification(
    n_informative=5, n_redundant=0, random_state=42
)

enc = OneHotEncoder(drop='first', categories='auto')
xgb = XGBClassifier()
pipeline = Pipeline([('one_hot_encoder', enc),
                     ('xgboost', xgb)])

fit_model(pipeline, X, y)
&lt;denchmark-h:h1&gt;Traceback&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;InternalHashError: unhashable type: 'bytearray'

Usually this means you found a Streamlit bug! If you think that's the case, please file a bug report here.

In the meantime, you can try bypassing this error by registering a custom hash function via the hash_funcs keyword in @st.cache(). For example:

@st.cache(hash_funcs={dict: my_hash_func})
def my_func(...):
    ...

Please see the hash_funcs documentation for more details.
Traceback:

  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/ScriptRunner.py", line 314, in _run_script
    exec(code, module.__dict__)
  File "/home/osboxes/PycharmProjects/Gbm-Default-Parameters-Benchmark/test.py", line 30, in &lt;module&gt;
    fit_model(pipeline, X, y)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/caching.py", line 464, in wrapped_func
    return get_or_set_cache()
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/caching.py", line 457, in get_or_set_cache
    hash_funcs=hash_funcs,
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/caching.py", line 294, in _write_to_cache
    _write_to_mem_cache(key, value, allow_output_mutation, hash_funcs)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/caching.py", line 231, in _write_to_mem_cache
    hash = get_hash(value, hash_funcs=hash_funcs)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 134, in get_hash
    hasher.update(f, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 280, in update
    self._update(self.hasher, obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 494, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 379, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 372, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 372, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 372, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 494, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 379, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 372, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 494, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 307, in to_bytes
    b = self._to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 500, in _to_bytes
    raise InternalHashError(msg).with_traceback(e.__traceback__)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 379, in _to_bytes
    self._update(h, item, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 323, in _update
    b = self.to_bytes(obj, context)
  File "/home/osboxes/anaconda3/envs/aws/lib/python3.6/site-packages/streamlit/hashing.py", line 293, in to_bytes
    if key in self.hashes:
&lt;/denchmark-code&gt;

		</comment>
		<comment id='4' author='sergiocalde94' date='2020-03-16T16:46:20Z'>
		I think it was an error of my side, if you put hash_funcs({Pipeline: lambda _: None}), this works because makes the hash with features and labels, I close ir, sorry!
		</comment>
	</comments>
</bug>