<bug id='843' author='LCorleone' open_date='2019-12-13T08:50:57Z' closed_time='2020-01-10T03:03:18Z'>
	<summary>Bug when loading keras model under keras2.3.0 and TensorFlow2.0</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

Bug when loading keras model under keras2.3.0 and TensorFlow2.0 if using st.button.
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;import keras
import streamlit as st
def main():
    model = keras.applications.mobilenet.MobileNet(input_shape=None, alpha=1.0,
                                                   depth_multiplier=1, dropout=1e-3, include_top=True,
                                                   weights='imagenet', input_tensor=None, pooling=None, classes=1000)
    st.title("test")
    st.subheader(" test")
    st.subheader(" Extract from Your Text ")
    message = st.text_area(" Entre Your Text ", "  ")
    if st.button("Extract"):
        st.write(message)
if __name__ == '__main__':
    main()
&lt;/denchmark-code&gt;

What are the steps we should take to reproduce the bug:

load a keras model under keras2.3.0 and TensorFlow2.0.
streamlit run app.py
input some characters.
click the Extract button.
Error occurs.
Any ideas? Thanks a lot.

AttributeError: '_thread._local' object has no attribute 'value'
Traceback:
File "C:\Users\lxy\AppData\Roaming\Python\Python36\site-packages\streamlit\ScriptRunner.py", line 311, in _run_script
exec(code, module.dict)
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: (get it with $ streamlit version) =&gt; 0.51.0
Python version: (get it with $ python --version) =&gt;  3.6
Using Conda? PipEnv? PyEnv? Pex? =&gt;  Conda
OS version: =&gt;  win10
Browser version:  =&gt; chrome

	</description>
	<comments>
		<comment id='1' author='LCorleone' date='2019-12-13T12:10:38Z'>
		&lt;denchmark-link:https://stackoverflow.com/questions/58015489/flask-and-keras-model-error-thread-local-object-has-no-attribute-value&gt;this stack overflow&lt;/denchmark-link&gt;

It seems the thread cause the problem. In flask, set threaded=False can solve the problem.
For streamlit, any ideas?
		</comment>
		<comment id='2' author='LCorleone' date='2019-12-17T15:56:22Z'>
		Hi &lt;denchmark-link:https://github.com/LCorleone&gt;@LCorleone&lt;/denchmark-link&gt;
,
Looks like you've already tried the suggested workarounds as mentioned in the related Keras issue &lt;denchmark-link:https://github.com/keras-team/keras/issues/13353#issuecomment-565424667&gt;keras-team/keras#13353 (comment)&lt;/denchmark-link&gt;

I'm not aware of any other workarounds at the moment, but I'll leave this issue open for the moment for another Streamlit engineer to take a look.
		</comment>
		<comment id='3' author='LCorleone' date='2019-12-18T07:55:05Z'>
		&lt;denchmark-link:https://github.com/jrhone&gt;@jrhone&lt;/denchmark-link&gt;

Thanks a lot. Hope someone can give me some suggestions!
		</comment>
		<comment id='4' author='LCorleone' date='2020-01-08T22:57:43Z'>
		Do you need to run the model creation every time you press the button? I wonder a solution as follow would be satisfactory:
&lt;denchmark-code&gt;@st.cache
def load_model():
  return keras.applications.mobilenet.MobileNet(...)

def main():
   model = load_model()
    st.title("test")
    st.subheader(" test")
    st.subheader(" Extract from Your Text ")
    message = st.text_area(" Entre Your Text ", "  ")
    if st.button("Extract"):
        st.write(message)
&lt;/denchmark-code&gt;

What it does is that it caches the model, so it does not reload the model on each re-run.
Let me know if this is not what you want.
Matteo
		</comment>
		<comment id='5' author='LCorleone' date='2020-01-09T03:27:30Z'>
		&lt;denchmark-link:https://github.com/monchier&gt;@monchier&lt;/denchmark-link&gt;

Thanks for reply. This solution is ok, but when i load a complex model i trained, another error is occured.

TypeError: object supporting the buffer API required

		</comment>
		<comment id='6' author='LCorleone' date='2020-01-09T21:28:21Z'>
		Any way I can repro the second error myself? This may be related to caching of some specific types, but the error message is quite obscure. &lt;denchmark-link:https://github.com/jrhone&gt;@jrhone&lt;/denchmark-link&gt;
 does it tell you anything?
		</comment>
		<comment id='7' author='LCorleone' date='2020-01-10T01:27:52Z'>
		Hi &lt;denchmark-link:https://github.com/LCorleone&gt;@LCorleone&lt;/denchmark-link&gt;
 ,
Is there any other information in the report?
Usually there's a message above the one that you shared, that says Streamlit cannot hash an object of type X
&lt;denchmark-link:https://user-images.githubusercontent.com/699897/72118232-368e5b00-332f-11ea-995e-b46ad373c82f.png&gt;&lt;/denchmark-link&gt;

		</comment>
		<comment id='8' author='LCorleone' date='2020-01-10T03:03:14Z'>
		&lt;denchmark-link:https://github.com/jrhone&gt;@jrhone&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/monchier&gt;@monchier&lt;/denchmark-link&gt;

Thanks a lot. I think it is a special case I encounted. When i load a simple model, it is all ok. Maybe the complex model structure causes the error. It may be difficult to repro and i will not dig into this error.
Close the issue.
		</comment>
	</comments>
</bug>