<bug id='484' author='knorthover' open_date='2019-10-21T13:49:14Z' closed_time='2019-12-19T05:11:29Z'>
	<summary>Streamlit 404 error in Google Cloud Run</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

Streamlit app deployed in  Google Cloud Run fails with a 404 error "requested URL healthz not found"
&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3751080/cloudtest.zip&gt;cloudtest.zip&lt;/denchmark-link&gt;

&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

See file healthz404.txt in attached example zip.
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

Should show a small dataframe (example from Getting Started page in docs)
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

The browser reports Connecting and "Please wait" from Streamlit so it is seeing the Cloud Run instance, see screenshot in attached.
After a minute or so it throws the 404 error, full text in the healthz404.txt file
&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

That is, did this use to work the way you expected in the past?
no
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;



Streamlit version: 48.1


Python version: 3.7-slim, Docker image


Using pip


OS version:  N/A


Browser version:  Chrome 77.0.x


&lt;denchmark-h:h1&gt;Additional information&lt;/denchmark-h&gt;

If needed, add any other context about the problem here.
	</description>
	<comments>
		<comment id='1' author='knorthover' date='2019-11-07T16:08:05Z'>
		Also occurs with attempts to deploy to Google AppEngine.  streamlit hello displays a st.info("Please wait...") message, hangs there for about a minute then gives the 404 error on the "healthz" URL.
Appengine log and the configuration files for AppEngine and Streamlit attached.
&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3820515/app.yaml.txt&gt;app.yaml.txt&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3820516/appengine.log&gt;appengine.log&lt;/denchmark-link&gt;

&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3820521/config.toml.txt&gt;config.toml.txt&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='knorthover' date='2019-11-08T19:05:19Z'>
		Linking our discourse conversation for context: &lt;denchmark-link:https://discuss.streamlit.io/t/has-anyone-deployed-to-google-cloud-platform/931/2&gt;https://discuss.streamlit.io/t/has-anyone-deployed-to-google-cloud-platform/931/2&lt;/denchmark-link&gt;

		</comment>
		<comment id='3' author='knorthover' date='2019-11-08T19:26:43Z'>
		As I mentioned in the discourse response, we are routinely deploying on GKE, but we haven't tried AppEngine and CloudRun. I suspect there is something going on with the websocket connection, but I will need to dig and debug this more. Thanks for the details in this bug report. Will get this into the pipeline.
		</comment>
		<comment id='4' author='knorthover' date='2019-12-03T21:58:40Z'>
		&lt;denchmark-link:https://github.com/monchier&gt;@monchier&lt;/denchmark-link&gt;


As I mentioned in the discourse response, we are routinely deploying on GKE, but we haven't tried AppEngine and CloudRun. I suspect there is something going on with the websocket connection, but I will need to dig and debug this more. Thanks for the details in this bug report. Will get this into the pipeline.

Are you successfully deploying to GKE?
We are trying to deploy a streamlit app to GKE and have had no luck with any form of ingress, loadbalancer, or service. Regardless of configuration we are unable to get the websocket connections to work.
I would be interested in seeing your configuration.
		</comment>
		<comment id='5' author='knorthover' date='2019-12-04T18:17:42Z'>
		This is a test app that deploys and runs with AppEngine.  See the link in the Dockerfile comments for more details.
&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3923351/app.zip&gt;app.zip&lt;/denchmark-link&gt;

It still doesn't work with CloudRun
		</comment>
		<comment id='6' author='knorthover' date='2019-12-05T06:04:38Z'>
		
This is a test app that deploys and runs with AppEngine. See the link in the Dockerfile comments for more details.
app.zip
It still doesn't work with CloudRun

You saved my life! Thanks!
		</comment>
		<comment id='7' author='knorthover' date='2019-12-18T19:26:05Z'>
		&lt;denchmark-link:https://github.com/MrBradricks&gt;@MrBradricks&lt;/denchmark-link&gt;

Sorry for the delay on this... You should be able to run in GKE using the very same Dockerfile and creating a simple Deployment and Service backed by a Load balancer. These are the relevant Kubernetes files:
deployment.yaml
&lt;denchmark-code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-app
        image: &lt;docker image&gt;:&lt;docker image tag&gt;
        ports:
        - containerPort: 8501
&lt;/denchmark-code&gt;

&lt;denchmark-code&gt;apiVersion: v1
kind: Service
metadata:
  name: my-app
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
  - protocol: TCP
    port: 8501
    targetPort: 8501
&lt;/denchmark-code&gt;

Note that I am exposing port 8501 which is the default Streamlit port, so your app will be available at &lt;load balancer ip&gt;:8501
You can also configure a different port than 8080 with AppEngine as documented here: &lt;denchmark-link:https://cloud.google.com/appengine/docs/flexible/custom-runtimes/configuring-your-app-with-app-yaml&gt;https://cloud.google.com/appengine/docs/flexible/custom-runtimes/configuring-your-app-with-app-yaml&lt;/denchmark-link&gt;
. See .
I believe a similar configuration is needed for CloudRun.
Hope this helps. If you have any more questions, please post in discuss.streamlit.io. I'll keep this open to track the resolution specifically for CloudRun.
Matteo
		</comment>
		<comment id='8' author='knorthover' date='2019-12-19T05:11:29Z'>
		Hey all
I'm not an expect on Cloud Run, but from a quick read it seems to follow the AWS Lambda model where you need your app to be stateless and purely event-based. But that's not how Streamlit works, since it uses a persistent websocket connection.
So I believe it's unlikely Streamlit will work with Cloud Run, no matter what you do. If you're using Google, your best bet is to use something like GCE instead.
So I'll close this issue right now. If you think this is in error, feel free to reopen.
		</comment>
		<comment id='9' author='knorthover' date='2019-12-19T13:36:24Z'>
		By lookinga bit deeper: &lt;denchmark-link:https://cloud.google.com/run/docs/issues#grpc_websocket&gt;https://cloud.google.com/run/docs/issues#grpc_websocket&lt;/denchmark-link&gt;

Seems there is a known issue around Websockets in Cloud Run.
		</comment>
		<comment id='10' author='knorthover' date='2019-12-19T14:53:21Z'>
		Matteo, Thiago
Thank you very much for your work on this and for clarifying and pinpointing the issue.  I'll work on deploying our application into GCP next year after the next Streamlit release. (I'm also constrained by the file upload/download issue[s]).
		</comment>
	</comments>
</bug>