<bug id='1716' author='kush99993s' open_date='2020-07-15T14:30:53Z' closed_time='2020-09-07T23:24:48Z'>
	<summary>Streamlit behind reverse proxy doesnâ€™t work when you change port</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

I am trying to run streamlit behind revese proxy doesn't work when we change port in streamlit.
Type here a clear and concise description of the bug. Aim for 2-3 sentences.
When change port in streamlit, and put it behind reverse proxy, front end try to use default port 8501 rather than changed port.
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

First run streamlit
streamlit hello --server.port=2000
In reverse proxy, if you point to this url. I am seeing almost all calls fails. But Let me show you one example request.
When I look network, I see following request fail. healthz. Issue is, healthz is still ping at original port (8501)
which is seen as following as error:
&lt;denchmark-code&gt;1. Request URL:

http://localhost:8501/healthz

2. Referrer Policy:

no-referrer-when-downgrade
&lt;/denchmark-code&gt;

When I copy request as cURL from browser for that request i see following:
&lt;denchmark-code&gt;  -H 'Accept: application/json, text/plain, */*' \
  -H 'Referer: http://localhost:3000/' \
  -H 'User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Mobile Safari/537.36' \
  --compressed
&lt;/denchmark-code&gt;

As you can see here, It is pointing to original port (8501) not change port 2000.
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

Expected behavior should be that it request should use port that is provided in cmd not original
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

However, it is pointing to default (original port) 8501.
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: 0.63.0
Python version: Python 3.6.9
Using PipEnv
OS version: Ubuntu 18.04.4 LTS
Browser version: brave

	</description>
	<comments>
		<comment id='1' author='kush99993s' date='2020-07-16T02:14:10Z'>
		FYI: Other requests has same problem.
		</comment>
		<comment id='2' author='kush99993s' date='2020-07-22T13:32:09Z'>
		What reverse proxy do you use? When using nginx you need to make sure you enable websocket support like this:
        location /stream {
            proxy_pass       http://streamlit;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
      }
So the issue is probably the reverse proxy and not streamlit.
		</comment>
		<comment id='3' author='kush99993s' date='2020-07-22T15:18:20Z'>
		Reverse proxy work just fine with the default port. When I change the port for streamlit, then Streamlit doesn't work behind the reverse proxy. Streamlit still tries to use the default port (8501), not a new port. It is not the reverse proxy issue. Do you have an example that works different port of streamlit?
		</comment>
		<comment id='4' author='kush99993s' date='2020-07-23T10:57:15Z'>
		That's interesting &lt;denchmark-link:https://github.com/kush99993s&gt;@kush99993s&lt;/denchmark-link&gt;
.
My setup looks like this:
# nginx config

http {

        # ...... some other stuff ....

 	upstream streamlit {
		server 127.0.0.1:56002 fail_timeout=0;
 	}
        server {
            location /stream {
                 proxy_pass       http://streamlit;
                 proxy_http_version 1.1;
                 proxy_set_header Upgrade $http_upgrade;
                 proxy_set_header Connection "Upgrade";
                 proxy_set_header Host $host;
            }

             location / {
                 proxy_pass       http://streamlit;
	         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	         proxy_set_header Host $http_host;
	         proxy_redirect off;
             }
     }
}
streamlit run dashboard.py --server.port 56002
		</comment>
		<comment id='5' author='kush99993s' date='2020-07-23T17:55:33Z'>
		Thanks, I will check it out.
		</comment>
		<comment id='6' author='kush99993s' date='2020-07-24T17:18:02Z'>
		Quick question,
Why do we need following:
&lt;denchmark-code&gt;
 location / {
                 proxy_pass       http://streamlit;
	         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	         proxy_set_header Host $http_host;
	         proxy_redirect off;
             }
&lt;/denchmark-code&gt;

If we have to also forward home dir to streamlit, It will be difficult to host two streamlit application. Am I missing something ?
		</comment>
		<comment id='7' author='kush99993s' date='2020-07-24T17:21:55Z'>
		location / is for everything BUT the websocket stream
location /stream is for the websocket stream
they need a different treatment. I don't think streamlit supports multiple apps on the same domain out of the box. I haven't seen a way to specify the prefix (like /app1/). Maybe subdomains will work.
		</comment>
		<comment id='8' author='kush99993s' date='2020-07-28T09:53:11Z'>
		&lt;denchmark-link:https://github.com/kush99993s&gt;@kush99993s&lt;/denchmark-link&gt;
 any luck so far?
		</comment>
		<comment id='9' author='kush99993s' date='2020-08-04T22:21:58Z'>
		Not yet, I will let you as soon as I have something.
		</comment>
		<comment id='10' author='kush99993s' date='2020-09-07T21:40:18Z'>
		New version of streamlit is working as expected with reverse proxy. Nice works guys. I love this.
		</comment>
		<comment id='11' author='kush99993s' date='2020-09-07T21:42:15Z'>
		&lt;denchmark-link:https://github.com/randyzwitch&gt;@randyzwitch&lt;/denchmark-link&gt;
 , You can close this issue.
		</comment>
	</comments>
</bug>