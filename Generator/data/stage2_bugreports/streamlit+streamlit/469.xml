<bug id='469' author='MarcSkovMadsen' open_date='2019-10-20T04:30:21Z' closed_time='2019-11-19T01:23:38Z'>
	<summary>Streamlit crashes with RuntimeError when using matplotlib with sliders</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

I'm using matplotlib with a few sliders to plot some data. But after having changed the sliders some times streamlit crashes with the a RuntimeError
&lt;denchmark-link:https://user-images.githubusercontent.com/42288570/67154850-06708680-f303-11e9-920d-1adfc411f3cf.png&gt;&lt;/denchmark-link&gt;

I've experienced this in other applications as well.
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

Run the below code and change the sliders until Streamlit crashes with a RuntimeError
import streamlit as st
import numpy as np
from scipy.stats import norm
import pandas as pd
import matplotlib.pyplot as plt


def write():
    plot_section()


def plot_section():
    st.markdown(
        """
## Interactive plot - Streamlit

"""
    )
    x = get_x()
    mu = st.slider(
        "mu", value=float(0), min_value=float(-5), max_value=float(5), step=float(0.1)
    )
    sigma = st.slider(
        "sigma",
        value=float(1),
        min_value=float(0.1),
        max_value=float(5),
        step=float(0.1),
    )
    plot_figure(x, mu, sigma)


@st.cache
def get_x():
    return np.linspace(-10, 10, 200)


def plot_figure(x, mu: float = 0, sigma: float = 1):
    y = norm.pdf(x, mu, sigma)
    title = f"Gaussian Density (mu = {mu} and sigma = {sigma})"
    plt.hist(y, bins=20)
    st.pyplot()


write()
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

No Error
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

Streamlit crashes with this Error
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Exception ignored in: &lt;function Image.__del__ at 0x000000384A5821E0&gt;
Traceback (most recent call last):
  File "C:\Users\masma\AppData\Local\Programs\Python\Python37\lib\tkinter\__init__.py", line 3507, in __del__
    self.tk.call('image', 'delete', self.name)
RuntimeError: main thread is not in main loop
Tcl_AsyncDelete: async handler deleted by the wrong thread
&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

no
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: 0.47.4
Python version: 3.7.2
Not using Conda, PipEnv, PyEnv or Pex. I'm just using python -m venv .venv
OS version: Windows 8.1
Browser version: Chrome
Matplotlib. 3.1.1

	</description>
	<comments>
		<comment id='1' author='MarcSkovMadsen' date='2019-10-21T21:17:22Z'>
		This happens to me as well, with this env:

Streamlit version: 0.48.1
Python version: 3.6.6
Using pyenv
OS version: Ubuntu 18.04.3
Browser version: Chrome
Matplotlib. 3.1.1

I had this issue in a different project (sans streamlit) and I added these lines to the top of various modules
&lt;denchmark-code&gt;import matplotlib
matplotlib.use('TkAgg')
&lt;/denchmark-code&gt;

in this case that did not help my streamlit.
		</comment>
		<comment id='2' author='MarcSkovMadsen' date='2019-10-23T11:30:20Z'>
		I got the same issue with this env :

Streamlit version: 0.48.1
Python version: 3.7.3
Using pyenv
OS version: Kaloi
Browser version: Firefox
Matplotlib. 3.1.1

Was also able to reproduce this error using multi select to plot graphs and sliders :
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

st.markdown("# Exploration Data Analysis")

class Schema:
    data_directory = '../data'
    data_path = data_directory + '/survey_results_public.csv'

@st.cache(ignore_hash=True)
def load_data():
    return pd.read_csv(Schema.data_path)

options = st.multiselect("Which histogram to plot", ("Age", "WorkWeekHrs"))

def write_hist(column):
    st.markdown(f"### {column}")
    plt.hist(df[column], bins=100)
    st.pyplot()
    var_quantile = st.slider(f"{column} quantile", 1, 99, 1)
    st.write(df[column].quantile(q=var_quantile / 100))

for x in options:
    write_hist(x)
Selecting both options and deleting WorkWeekHrs afterwards make the app crash for sure.
Ping me if any information / help is needed
Using stackoverflow survey data.
		</comment>
		<comment id='3' author='MarcSkovMadsen' date='2019-10-27T15:21:24Z'>
		Same error as well when using matplotlib (even without sliders). I'm running Windows 10.
		</comment>
		<comment id='4' author='MarcSkovMadsen' date='2019-10-29T17:51:08Z'>
		I had the same issue but was able to fix it by manually specifying the matplotlib backend
import matplotlib
matplotlib.use('Agg')
from matplotlib import pyplot as plt
See &lt;denchmark-link:https://stackoverflow.com/questions/27147300/matplotlib-tcl-asyncdelete-async-handler-deleted-by-the-wrong-thread&gt;https://stackoverflow.com/questions/27147300/matplotlib-tcl-asyncdelete-async-handler-deleted-by-the-wrong-thread&lt;/denchmark-link&gt;

I was also able to use other backends, e.g. 'svg' so I imagine the problem is specifically the default 'TkAgg'.
Looking at config it seems the backend should be set by default, but it doesn't seem to work properly.
# Sets the MPLBACKEND environment variable to Agg inside Streamlit to prevent Python crashing.
# Default: true
fixMatplotlib = true
I'm on windows 10.
		</comment>
	</comments>
</bug>