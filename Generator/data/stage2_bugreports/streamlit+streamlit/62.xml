<bug id='62' author='monchier' open_date='2019-09-09T23:36:12Z' closed_time='2019-10-02T22:25:29Z'>
	<summary>st.cache hashing fails when script is run from certain folders</summary>
	<description>
Cache issue found with the self-driving car demo
	</description>
	<comments>
		<comment id='1' author='monchier' date='2019-09-09T23:40:48Z'>
		
Unpack the attached folder
create a virtual environment in your current directory: virtualenv .venv
pip install streamlit
streamlit run self_driving/app.py

You should see the error on the UI
If you cd inside self_driving and run from there, the bug does not show up.
If you create a subdirectory and and run from there, the bug does not show up.
&lt;denchmark-link:https://github.com/streamlit/streamlit/files/3592997/bug.zip&gt;bug.zip&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='monchier' date='2019-09-09T23:52:15Z'>
		KeyError: 'start'
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/ScriptRunner.py", line 317, in _run_script exec(code, module.dict)
File "/Users/monchier/projects/test-demo/self_driving/app.py", line 29, in  main()
File "/Users/monchier/projects/test-demo/self_driving/app.py", line 25, in main metadata = load_metadata(LABELS_FILENAME)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/caching.py", line 393, in wrapped_func code_hasher.update(func)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 159, in update self._update(self.hasher, obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 316, in _code_to_bytes self._update(h, ref, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 259, in _to_bytes h.update(self._code_to_bytes(obj.code, context))
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 311, in _code_to_bytes self._update(h, consts, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 215, in _to_bytes self._update(h, e, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 266, in _to_bytes return self._code_to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 311, in _code_to_bytes self._update(h, consts, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 215, in _to_bytes self._update(h, e, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 190, in _update b = self.to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 179, in to_bytes b = self._to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 266, in _to_bytes return self._code_to_bytes(obj, context)
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing.py", line 315, in _code_to_bytes for ref in get_referenced_objects(code, context):
File "/Users/monchier/projects/test-demo/.venv/lib/python3.7/site-packages/streamlit/hashing_py3.py", line 49, in get_referenced_objects set_tos(context.cells[op.argval])
		</comment>
		<comment id='3' author='monchier' date='2019-09-10T00:14:14Z'>
		We root caused it it. The problem is when I have a virtualenv directory in the current working directory. We do this in hashing.py:
&lt;denchmark-code&gt;`# TODO: This may be too restrictive for libraries in development.
           if os.path.abspath(obj.__code__.co_filename).startswith(os.getcwd()):
               context = _get_context(obj)
               if obj.__defaults__:
                   self._update(h, obj.__defaults__, context)
               h.update(self._code_to_bytes(obj.__code__, context))
           else:
               # Don't hash code that is not in the current working directory.
               self._update(h, obj.__module__)
               self._update(h, obj.__name__)
           return h.digest()
&lt;/denchmark-code&gt;

This check will make us match the sources in the virtualenv:
 os.path.abspath(obj.__code__.co_filename).startswith(os.getcwd())
We can change the check. &lt;denchmark-link:https://github.com/tvst&gt;@tvst&lt;/denchmark-link&gt;
 suggested to match anything that is not in the  for example.
		</comment>
		<comment id='4' author='monchier' date='2019-09-10T01:39:55Z'>
		I think there are three issues here.


We are incorrectly hashing code that is not in the user's script because we don't correctly handle virtual environments that are in the CWD. @tvst's suggestion to look at sys.path sounds like a good solution to me but could be problematic if the cwd is in the patch itself.


The hashing code chokes on some code that it shouldn't choke on (would be great to find out what that code is).


If the hashing code chokes, it shouldn't crash the whole script.


		</comment>
		<comment id='5' author='monchier' date='2019-09-10T17:09:05Z'>
		Yes. I definitely agree with &lt;denchmark-link:https://github.com/domoritz&gt;@domoritz&lt;/denchmark-link&gt;
's point number 3 above. If it has problem hashing the code, I think it should issue a warning and either

continue without hashing the code, or
continue hashing the code, but skip that instruction

I think 2 is better, but at this point, whichever is easier is better.
		</comment>
		<comment id='6' author='monchier' date='2019-09-10T17:11:08Z'>
		Side note, I wouldn't mind giving os.path.abspath(obj.__code__.co_filename).startswith(os.getcwd()) (or whatever replaces is) a meaningful variable name, since I can't tell what that code is doing at all.
		</comment>
		<comment id='7' author='monchier' date='2019-09-18T07:06:25Z'>
		
@tvst's suggestion to look at sys.path sounds like a good solution to me but could be problematic if the cwd is in the patch itself.

Good point. We'd have to exclude cwd from the blacklist. But shouldn't complicate the logic much.
		</comment>
		<comment id='8' author='monchier' date='2019-09-18T15:33:20Z'>
		I'd like to fix 2) from my comment above. Let me know if you have a small snippet I can use to reproduce the issue.
		</comment>
	</comments>
</bug>