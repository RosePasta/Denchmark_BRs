<bug id='451' author='isConic' open_date='2019-10-17T21:51:04Z' closed_time='2019-10-30T04:41:51Z'>
	<summary>NSInternalInconsistencyException</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

I have a complicated application with the following involved:

threading
calling several tensorflow models
cv2.imshow() outputing
on a mac

Tried using streamlit to give me live fps performance metrics on a line chart
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;



streamlit run main.py


at the moment the only st code is


import streamlit as st  
  
#... Code  

st.title("FPS Clocking on Project foobar")
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

streamlit displays title.
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

I receive the following error.
&lt;denchmark-code&gt;2019-10-17 17:19:46.665 Python[17038:35913077] *** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'nextEventMatchingMask should only be called from the Main Thread!'
*** First throw call stack:
(
        0   CoreFoundation                      0x00007fff483cfcfd __exceptionPreprocess + 256
        1   libobjc.A.dylib                     0x00007fff72a79a17 objc_exception_throw + 48
        2   AppKit                              0x00007fff4599e222 -[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] + 4180
        3   libSDL-1.2.0.dylib                  0x0000000150af8ee8 QZ_PumpEvents + 231
        4   libSDL-1.2.0.dylib                  0x0000000150ad7dbb SDL_PumpEvents + 35
        5   libSDL-1.2.0.dylib                  0x0000000150ad7fa6 SDL_EventState + 211
        6   libSDL-1.2.0.dylib                  0x0000000150af7878 SDL_JoystickEventState + 41
        7   joystick.cpython-37m-darwin.so      0x0000000150d4bdc2 joy_autoinit + 50
        8   Python                              0x000000010e1bb194 _PyMethodDef_RawFastCallDict + 591
        9   Python                              0x000000010e1ba765 _PyCFunction_FastCallDict + 44
        10  base.cpython-37m-darwin.so          0x0000000150ac889c pg_init + 268
        11  Python                              0x000000010e1bb58e _PyMethodDef_RawFastCallKeywords + 590
        12  Python                              0x000000010e1baab2 _PyCFunction_FastCallKeywords + 44
        13  Python                              0x000000010e24fe82 call_function + 636
        14  Python                              0x000000010e248c70 _PyEval_EvalFrameDefault + 6421
        15  Python                              0x000000010e1bae8c function_code_fastcall + 112
        16  Python                              0x000000010e24fef7 call_function + 753
        17  Python                              0x000000010e248d0b _PyEval_EvalFrameDefault + 6576
        18  Python                              0x000000010e1bae8c function_code_fastcall + 112
        19  Python                              0x000000010e24fef7 call_function + 753
        20  Python                              0x000000010e248d0b _PyEval_EvalFrameDefault + 6576
        21  Python                              0x000000010e2507a6 _PyEval_EvalCodeWithName + 1870
        22  Python                              0x000000010e2472b8 PyEval_EvalCode + 51
        23  Python                              0x000000010e244d1e builtin_exec + 554
        24  Python                              0x000000010e1bb52f _PyMethodDef_RawFastCallKeywords + 495
        25  Python                              0x000000010e1baab2 _PyCFunction_FastCallKeywords + 44
        26  Python                              0x000000010e24fe82 call_function + 636
        27  Python                              0x000000010e248d0b _PyEval_EvalFrameDefault + 6576
        28  Python                              0x000000010e1bae8c function_code_fastcall + 112
        29  Python                              0x000000010e24fef7 call_function + 753
        30  Python                              0x000000010e248c57 _PyEval_EvalFrameDefault + 6396
        31  Python                              0x000000010e1bae8c function_code_fastcall + 112
        32  Python                              0x000000010e1bb829 _PyObject_Call_Prepend + 150
        33  Python                              0x000000010e1babbf PyObject_Call + 136
        34  Python                              0x000000010e248f43 _PyEval_EvalFrameDefault + 7144
        35  Python                              0x000000010e1bae8c function_code_fastcall + 112
        36  Python                              0x000000010e24fef7 call_function + 753
        37  Python                              0x000000010e248c57 _PyEval_EvalFrameDefault + 6396
        38  Python                              0x000000010e1bae8c function_code_fastcall + 112
        39  Python                              0x000000010e24fef7 call_function + 753
        40  Python                              0x000000010e248c57 _PyEval_EvalFrameDefault + 6396
        41  Python                              0x000000010e1bae8c function_code_fastcall + 112
        42  Python                              0x000000010e1bb829 _PyObject_Call_Prepend + 150
        43  Python                              0x000000010e1babbf PyObject_Call + 136
        44  Python                              0x000000010e2b7261 t_bootstrap + 71
        45  Python                              0x000000010e27de95 pythread_wrapper + 25
        46  libsystem_pthread.dylib             0x00007fff7443b2eb _pthread_body + 126
        47  libsystem_pthread.dylib             0x00007fff7443e249 _pthread_start + 66
        48  libsystem_pthread.dylib             0x00007fff7443a40d thread_start + 13
)
libc++abi.dylib: terminating with uncaught exception of type NSException
Abort trap: 6


&lt;/denchmark-code&gt;

&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

No
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;

'Python 3.7.4 (default, Jul  9 2019, 18:13:23) \n[Clang 10.0.1 (clang-1001.0.46.4)]'
&lt;denchmark-h:h1&gt;Additional information&lt;/denchmark-h&gt;

I'm ok with this not working.  I opened this because I have a ticket opening reflex.
	</description>
	<comments>
		<comment id='1' author='isConic' date='2019-10-25T18:47:43Z'>
		Thanks a lot for submitting this bug, &lt;denchmark-link:https://github.com/isConic&gt;@isConic&lt;/denchmark-link&gt;
. Can you provide some more details on the code that you are running?
By doing some internet research I found a very similar signature mentioned in this bug report:
&lt;denchmark-link:https://github.com/deepmind/pysc2/issues/2&gt;deepmind/pysc2#2&lt;/denchmark-link&gt;

Quoting from the discussion

It looks like on OSX OpenCV allows rendering only in main thread. I made a change suggested by error message and moved rendering to main thread...

Does it resonate at all with your stack? I can try to craft a script with some cv2.imshow()  in it and see if this repros.
Matteo
		</comment>
		<comment id='2' author='isConic' date='2019-10-25T19:08:47Z'>
		And I find a repro for this:
&lt;denchmark-code&gt;import numpy as np
import cv2
import streamlit as st
# Load an color image in grayscale
img = cv2.imread('home.jpg',0)
if img is None:
    raise Exception("No image")
cv2.imshow('image',img)
st.pyplot()
&lt;/denchmark-code&gt;

It seems cv2.imshow is enough to trigger this bug.
My stacktrace:
&lt;denchmark-code&gt;Initialized tornado logs
Setting up signal handler
Using selector: KqueueSelector
Server state: None -&gt; State.INITIAL
Starting server...
Serving static content from the Node dev server
Server started on port 8501
Creating new context for ws PREHEATED_REPORT_SESSION
No singleton. Registering one.
Watcher created for /Users/monchier/projects/python/scripts/cv2_test.py
ReportSession initialized (id=0)
Beginning script thread
Running script RerunData(widget_state=None)
OnScriptRunnerEvent: ScriptRunnerEvent.SCRIPT_STARTED
New browser connection: gather_usage_stats=True, sharing_enabled=False, max_cached_message_age=2
Server state: State.INITIAL -&gt; State.WAITING_FOR_FIRST_BROWSER
304 GET /healthz (::1) 1.20ms
304 GET /healthz (::1) 0.28ms
101 GET /stream (::1) 0.63ms
Reusing preheated context for ws &lt;streamlit.server.Server._BrowserWebSocketHandler object at 0x12c3ecb50&gt;
Server state: State.WAITING_FOR_FIRST_BROWSER -&gt; State.ONE_OR_MORE_BROWSERS_CONNECTED
Received the following back message:
update_widgets {
}

Skipping rerun since the preheated run is the same
101 GET /stream (::1) 0.70ms
Creating new context for ws &lt;streamlit.server.Server._BrowserWebSocketHandler object at 0x12f926150&gt;
Watcher created for /Users/monchier/projects/python/scripts/cv2_test.py
ReportSession initialized (id=1)
Server state: State.ONE_OR_MORE_BROWSERS_CONNECTED -&gt; State.ONE_OR_MORE_BROWSERS_CONNECTED
Received the following back message:
update_widgets {
}

Beginning script thread
Running script RerunData(widget_state=)
OnScriptRunnerEvent: ScriptRunnerEvent.SCRIPT_STARTED
New browser connection: gather_usage_stats=True, sharing_enabled=False, max_cached_message_age=2
2019-10-25 12:08:06.178 python[75837:3936006] *** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'NSWindow drag regions should only be invalidated on the Main Thread!'
*** First throw call stack:
(
	0   CoreFoundation                      0x00007fff42337a7d __exceptionPreprocess + 256
	1   libobjc.A.dylib                     0x00007fff6ca09a17 objc_exception_throw + 48
	2   CoreFoundation                      0x00007fff423515d9 -[NSException raise] + 9
	3   AppKit                              0x00007fff3f8f75ca -[NSWindow(NSWindow_Theme) _postWindowNeedsToResetDragMarginsUnlessPostingDisabled] + 317
	4   AppKit                              0x00007fff3f8f49f7 -[NSWindow _initContent:styleMask:backing:defer:contentView:] + 1479
	5   AppKit                              0x00007fff3f9b3d95 -[NSPanel _initContent:styleMask:backing:defer:contentView:] + 50
	6   AppKit                              0x00007fff3f8f442a -[NSWindow initWithContentRect:styleMask:backing:defer:] + 45
	7   AppKit                              0x00007fff3f9b3d4a -[NSPanel initWithContentRect:styleMask:backing:defer:] + 64
	8   QtGui                               0x000000012a9291fc -[QCocoaPanel initWithContentRect:styleMask:backing:defer:] + 76
	9   QtGui                               0x000000012a92fa81 -[NSWindow(QWidgetIntegration) qt_initWithQWidget:contentRect:styleMask:] + 81
	10  QtGui                               0x000000012a9210da _ZL20qt_mac_create_windowP7QWidgetjmRK5QRect + 423
	11  QtGui                               0x000000012a920d6a _ZN14QWidgetPrivate18qt_create_root_winEv + 64
	12  QtGui                               0x000000012a922af3 _ZN14QWidgetPrivate10create_sysElbb + 917
	13  QtGui                               0x000000012a9b27fc _ZN7QWidget6createElbb + 580
	14  QtGui                               0x000000012a9b151c _ZN14QWidgetPrivate4initEP7QWidget6QFlagsIN2Qt10WindowTypeEE + 362
	15  QtGui                               0x000000012a9b1309 _ZN7QWidgetC2EPS_6QFlagsIN2Qt10WindowTypeEE + 121
	16  QtGui                               0x000000012a93ac03 _ZN14QDesktopWidgetC2Ev + 31
	17  QtGui                               0x000000012a97cdd4 _ZN12QApplication7desktopEv + 50
	18  QtGui                               0x000000012a936cae _Z9flipPointRK7CGPoint + 32
	19  QtGui                               0x000000012a916af8 _ZN7QCursor3posEv + 46
	20  QtGui                               0x000000012a98c3f5 _ZN11QMouseEventC2EN6QEvent4TypeERK6QPointN2Qt11MouseButtonE6QFlagsIS6_ES7_INS5_16KeyboardModifierEE + 79
	21  QtGui                               0x000000012ae55204 _ZN20QGraphicsViewPrivateC2Ev + 296
	22  QtGui                               0x000000012ae586c5 _ZN13QGraphicsViewC2EP7QWidget + 37
	23  cv2.cpython-37m-darwin.so           0x000000012509c3ff _ZN15DefaultViewPortC2EP8CvWindowi + 31
	24  cv2.cpython-37m-darwin.so           0x0000000125097a8d _ZN8CvWindowC2E7QStringi + 397
	25  cv2.cpython-37m-darwin.so           0x000000012508f7a3 _ZN11GuiReceiver12createWindowE7QStringi + 227
	26  cv2.cpython-37m-darwin.so           0x000000012508f605 cvNamedWindow + 533
	27  cv2.cpython-37m-darwin.so           0x0000000125091bd8 _ZN11GuiReceiver9showImageE7QStringPv + 168
	28  cv2.cpython-37m-darwin.so           0x0000000125091a8e cvShowImage + 558
	29  cv2.cpython-37m-darwin.so           0x000000012508a45f _ZN2cv6imshowERKNSt3__112basic_stringIcNS0_11char_traitsIcEENS0_9allocatorIcEEEERKNS_11_InputArrayE + 463
	30  cv2.cpython-37m-darwin.so           0x00000001240eba32 _ZL18pyopencv_cv_imshowP7_objectS0_S0_ + 498
	31  Python                              0x000000010a73d560 _PyMethodDef_RawFastCallKeywords + 544
	32  Python                              0x000000010a73cab2 _PyCFunction_FastCallKeywords + 44
	33  Python                              0x000000010a7d1e82 call_function + 636
	34  Python                              0x000000010a7cac70 _PyEval_EvalFrameDefault + 6421
	35  Python                              0x000000010a7d27a6 _PyEval_EvalCodeWithName + 1870
	36  Python                              0x000000010a7c92b8 PyEval_EvalCode + 51
	37  Python                              0x000000010a7c6d1e builtin_exec + 554
	38  Python                              0x000000010a73d52f _PyMethodDef_RawFastCallKeywords + 495
	39  Python                              0x000000010a73cab2 _PyCFunction_FastCallKeywords + 44
	40  Python                              0x000000010a7d1e82 call_function + 636
	41  Python                              0x000000010a7cad0b _PyEval_EvalFrameDefault + 6576
	42  Python                              0x000000010a73ce8c function_code_fastcall + 112
	43  Python                              0x000000010a7d1ef7 call_function + 753
	44  Python                              0x000000010a7cac57 _PyEval_EvalFrameDefault + 6396
	45  Python                              0x000000010a73ce8c function_code_fastcall + 112
	46  Python                              0x000000010a73d829 _PyObject_Call_Prepend + 150
	47  Python                              0x000000010a73cbbf PyObject_Call + 136
	48  Python                              0x000000010a7caf43 _PyEval_EvalFrameDefault + 7144
	49  Python                              0x000000010a73ce8c function_code_fastcall + 112
	50  Python                              0x000000010a7d1ef7 call_function + 753
	51  Python                              0x000000010a7cac57 _PyEval_EvalFrameDefault + 6396
	52  Python                              0x000000010a73ce8c function_code_fastcall + 112
	53  Python                              0x000000010a7d1ef7 call_function + 753
	54  Python                              0x000000010a7cac57 _PyEval_EvalFrameDefault + 6396
	55  Python                              0x000000010a73ce8c function_code_fastcall + 112
	56  Python                              0x000000010a73d829 _PyObject_Call_Prepend + 150
	57  Python                              0x000000010a73cbbf PyObject_Call + 136
	58  Python                              0x000000010a839261 t_bootstrap + 71
	59  Python                              0x000000010a7ffe95 pythread_wrapper + 25
	60  libsystem_pthread.dylib             0x00007fff6e3cb2eb _pthread_body + 126
	61  libsystem_pthread.dylib             0x00007fff6e3ce249 _pthread_start + 66
	62  libsystem_pthread.dylib             0x00007fff6e3ca40d thread_start + 13
)
libc++abi.dylib: terminating with uncaught exception of type NSException
&lt;/denchmark-code&gt;

		</comment>
		<comment id='3' author='isConic' date='2019-10-30T04:41:51Z'>
		Hi &lt;denchmark-link:https://github.com/isConic&gt;@isConic&lt;/denchmark-link&gt;
,
Thanks again for your question. We think this is due to  not being supported in streamlit. Given my understanding  tries to open a Window and show an image. This won't work with Streamlit. We advise to use  to display an image. I guess this means, replacing  in your application manually. I will close this issue.
Best,
Matteo
		</comment>
	</comments>
</bug>