<bug id='1155' author='treuille' open_date='2020-02-27T19:20:47Z' closed_time='2020-03-25T05:08:30Z'>
	<summary>`hash_funcs` should properly handle classes defined in the running app script</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

A class defined in the running app script is redefined every time the script is run, breaking hash_funcs. This is clearer if you look at the example below.
&lt;denchmark-h:h2&gt;Steps to reproduce&lt;/denchmark-h&gt;


Run this:

import streamlit as st

class X:
  def __init__(self):
    self.number = 0

@st.cache(allow_output_mutation=True)
def get_x():
  return X()

@st.cache(hash_funcs={X : id})
def should_only_be_run_once(x):
  x.number += 1
  return x.number

"# Test app 1 for `hash_funcs` issue"

x = get_x()

number = should_only_be_run_once(x)

"x:", id(x), '(singleton, should stay constant)'
'number:', number, '(should not increment on rerun)'

st.button("Rerun")


Click on Rerun


Note that the number keeps incrementing. This is because:



The class X is redefined every time the script is rerun.
The second time we run should_only_be_run_once, x will have a different type from the redefined X.
Therefore x won't be in the cache and should_only_be_run_once will not only be done once.

&lt;denchmark-h:h1&gt;Behavior&lt;/denchmark-h&gt;

&lt;denchmark-h:h2&gt;Actual behavior&lt;/denchmark-h&gt;

Number keeps increasing every time you hit rerun:
&lt;denchmark-link:https://user-images.githubusercontent.com/1673013/75478620-21a76e80-5953-11ea-8dd9-4fca84cff414.png&gt;&lt;/denchmark-link&gt;

&lt;denchmark-h:h2&gt;Expected behavior&lt;/denchmark-h&gt;

Number should always be 1 because should_only_be_run_once should only run once.
&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

No
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;$ streamlit version &amp;&amp; python --version &amp;&amp; pyenv --version &amp;&amp; sw_vers &amp;&amp; "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version

Streamlit, version 0.52.2.post20200225
Python 3.6.3
pyenv 1.2.15
ProductName:    Mac OS X
ProductVersion: 10.15.3
BuildVersion:   19D76
Google Chrome 80.0.3987.122 
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='treuille' date='2020-02-27T19:21:23Z'>
		One solution would be to do lookups by fully qualified type name, rather than by the type object itself.
		</comment>
		<comment id='2' author='treuille' date='2020-03-25T05:08:27Z'>
		Closing this as it was merged in &lt;denchmark-link:https://github.com/streamlit/streamlit/pull/1223&gt;1223&lt;/denchmark-link&gt;
.
		</comment>
	</comments>
</bug>