<bug id='2297' author='hertzmann' open_date='2020-10-30T01:04:52Z' closed_time='2020-11-06T18:17:04Z'>
	<summary>Crashes in simple PyTorch image classifier</summary>
	<description>
&lt;denchmark-h:h1&gt;Summary&lt;/denchmark-h&gt;

Streamlit crashes on a simple test PyTorch image classification app.
&lt;denchmark-h:h1&gt;Steps to reproduce&lt;/denchmark-h&gt;

To reproduce this, run the attached code using streamlit run network_bug.py and put it in a folder with some images.
Note that this uses read_image which was added to PyTorch only a few days ago (so you might need to update), but I saw the same issue with imageio.
&lt;denchmark-h:h2&gt;Expected behavior:&lt;/denchmark-h&gt;

What it should do is print class labels for the image.
&lt;denchmark-h:h2&gt;Actual behavior:&lt;/denchmark-h&gt;

After some computation, it crashes with this error:
&lt;denchmark-code&gt;OMP: Error #15: Initializing libiomp5.dylib, but found libiomp5.dylib already initialized.
OMP: Hint This means that multiple copies of the OpenMP runtime have been linked into the program. That is dangerous, since it can degrade performance or cause incorrect results. The best thing to do is to ensure that only a single OpenMP runtime is linked into the process, e.g. by avoiding static linking of the OpenMP runtime in any library. As an unsafe, unsupported, undocumented workaround you can set the environment variable KMP_DUPLICATE_LIB_OK=TRUE to allow the program to continue to execute, but that may cause crashes or silently produce incorrect results. For more information, please see http://www.intel.com/software/products/support/.
Abort
&lt;/denchmark-code&gt;

Commenting out the st.sidebar or the st.image or the classifyImage causes it to not crash. It seems like an interaction between Streamlit and PyTorch.
&lt;denchmark-h:h2&gt;Is this a regression?&lt;/denchmark-h&gt;

No
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: 0.70.0
Python version: 3.7.4
OS version: OS X 10.15.7
Browser version: Chrome
PyTorch: 0.8.0

&lt;denchmark-h:h1&gt;Source code&lt;/denchmark-h&gt;

&lt;denchmark-code&gt;import torch
import torchvision.models
import torchvision.transforms as T
import os
import streamlit as st
import numpy as np
from torchvision.io import read_image
import pandas as pd

############################

@st.cache
def classifyImage(net, image):
	normalize = T.Normalize(mean=[0.485, 0.456, 0.406],std=[0.229, 0.224, 0.225])
	transforms = T.Compose([T.ConvertImageDtype(torch.float),normalize])

	rawscores = net(transforms(image.unsqueeze(0)))[0]
	ps = torch.nn.Softmax(dim=0)(rawscores)

	return ps

############################

torch.autograd.set_grad_enabled(False)

#net = torchvision.models.resnet101(pretrained=True)
net = torchvision.models.vgg16(pretrained=True)
#net = torchvision.models.alexnet(pretrained=True)
net.eval()

exts = [".jpg",".png",".tif",".jpeg"]

path = "./"

files = list(filter(lambda x:os.path.splitext(x)[1] in exts,
	os.listdir(path) ))
files.sort()

imgfilename = st.sidebar.selectbox("Input file", files)
#imgfilename = 'kitten.jpg'

image = read_image(path + imgfilename)

st.image(image.numpy().transpose((1, 2, 0)), use_column_width=True)

ps = classifyImage(net, image)

st.write(ps)
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='hertzmann' date='2020-11-05T06:45:23Z'>
		Hi &lt;denchmark-link:https://github.com/hertzmann&gt;@hertzmann&lt;/denchmark-link&gt;
 ,
This one seems kind of strange; I'm not familiar with the OpenMP runtime being described, but a quick search for your error message brings up references like this StackOverflow link:
&lt;denchmark-link:https://stackoverflow.com/questions/53014306/error-15-initializing-libiomp5-dylib-but-found-libiomp5-dylib-already-initial&gt;https://stackoverflow.com/questions/53014306/error-15-initializing-libiomp5-dylib-but-found-libiomp5-dylib-already-initial&lt;/denchmark-link&gt;

My guess might be this is not particularly related to Streamlit, but rather it's a configuration issue with your python environment. But let us know if the steps outlined there don't seem to solve it!
		</comment>
		<comment id='2' author='hertzmann' date='2020-11-06T18:17:04Z'>
		That seemed to fix it, thanks. It took a lot of trial-and-error and the first command took 20 hours to run. The steps that seemed to work were:
&lt;denchmark-code&gt;conda install nomkl numpy scipy scikit-learn numexpr
conda remove mkl mkl-service
conda install -c pytorch torchvision
&lt;/denchmark-code&gt;

		</comment>
	</comments>
</bug>