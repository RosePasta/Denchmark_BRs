<bug id='878' author='mohammedayub44' open_date='2019-12-20T06:18:11Z' closed_time='2020-01-08T17:36:25Z'>
	<summary>Keras model errors out on prediction</summary>
	<description>
Hi,
I'm trying to replicate a CSRNET model for counting people in images, it works good for the first input , but errors out when I change to second image.
I did add the allow_mutation_inputs tag to the cache which removed the st.cache warnings
def run_model(path):
    @st.cache(allow_output_mutation=True)
    def load_model():
       # Function to load and return neural network model
        json_file = open('/models/Model.json', 'r')
        loaded_model_json = json_file.read()
        json_file.close()
        loaded_model = model_from_json(loaded_model_json)
        loaded_model.load_weights("CSRNet-keras/weights/weights1.hdf5")
        return loaded_model
Below is the error I get:
&lt;denchmark-link:https://user-images.githubusercontent.com/7122670/71233617-23eeac00-22c4-11ea-836c-7ce059338b70.png&gt;&lt;/denchmark-link&gt;

Output Console Log:
&lt;denchmark-link:https://user-images.githubusercontent.com/7122670/71234335-7a5cea00-22c6-11ea-88e9-73453e46731d.png&gt;&lt;/denchmark-link&gt;

Not sure if this is because of caching or I'm missing something. It works fine separately on a Jupyter Notebook.
&lt;denchmark-h:h1&gt;Debug info&lt;/denchmark-h&gt;


Streamlit version: 0.50.2
Python version: 3.6.5
Using Conda
OS version: Ubuntu 16.04
Browser version: Google Chrome Version 79

Thanks !
	</description>
	<comments>
		<comment id='1' author='mohammedayub44' date='2020-01-06T05:20:08Z'>
		&lt;denchmark-link:https://github.com/jrhone&gt;@jrhone&lt;/denchmark-link&gt;
 or anyone else , any update on this why its happening ?
		</comment>
		<comment id='2' author='mohammedayub44' date='2020-01-08T06:22:32Z'>
		&lt;denchmark-link:https://github.com/mohammedayub44&gt;@mohammedayub44&lt;/denchmark-link&gt;
 I think your issue is closely related to mine. Please see &lt;denchmark-link:https://github.com/streamlit/streamlit/issues/939&gt;#939&lt;/denchmark-link&gt;
.
		</comment>
		<comment id='3' author='mohammedayub44' date='2020-01-08T17:36:25Z'>
		&lt;denchmark-link:https://github.com/carolmanderson&gt;@carolmanderson&lt;/denchmark-link&gt;
  works like a charm. Thanks a lot.
I was trying to reset the session for some reason and that did not work. Just passing the current TF session solved it.
		</comment>
		<comment id='4' author='mohammedayub44' date='2020-01-08T18:05:06Z'>
		Also, somtimes it break giving "Tensor X is not a part of the graph..". Guessing this is because of multi-threading in Keras. Running the loaded_model._make_predict_function() after loading the model helps to avoid the error.
 @st.cache(allow_output_mutation=True)
    def load_model():
        json_file = open('Model.json', 'r')
        loaded_model_json = json_file.read()
        json_file.close()
        loaded_model = model_from_json(loaded_model_json)
        loaded_model.load_weights("weights/epoch200.hdf5")
        loaded_model._make_predict_function() ***
        session = K.get_session()
        return loaded_model, session
		</comment>
		<comment id='5' author='mohammedayub44' date='2020-01-22T04:15:20Z'>
		&lt;denchmark-link:https://github.com/mohammedayub44&gt;@mohammedayub44&lt;/denchmark-link&gt;
 many thanks. I ran into this problem today, and your solution worked!
		</comment>
		<comment id='6' author='mohammedayub44' date='2020-04-11T12:46:28Z'>
		&lt;denchmark-link:https://github.com/mohammedayub44&gt;@mohammedayub44&lt;/denchmark-link&gt;
 finally I found a solution for this issue! tnx!
		</comment>
	</comments>
</bug>