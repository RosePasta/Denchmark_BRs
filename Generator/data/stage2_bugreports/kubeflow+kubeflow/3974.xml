<bug id='3974' author='UrmsOne' open_date='2019-08-22T08:20:41Z' closed_time='2020-03-23T16:06:43Z'>
	<summary>Notebook cannot connect after modifying the default cluster. domain - notebook controller doesn't support custom domains</summary>
	<description>
/kind bug
Hello,
I'm playing around with a Kubeflow installation on local VM following the instructions in
&lt;denchmark-link:https://www.kubeflow.org/docs/started/k8s/kfctl-k8s-istio/&gt;https://www.kubeflow.org/docs/started/k8s/kfctl-k8s-istio/&lt;/denchmark-link&gt;

When I changed the default cluster. domain to 'k8s.xxx.opd.local', I encountered the following problems(It's not found in the default cluster.domain "cluster.local").
&lt;denchmark-link:https://user-images.githubusercontent.com/31981402/63498490-97d89d80-c4f8-11e9-9cf8-36d5e15fbe9d.png&gt;&lt;/denchmark-link&gt;

After I created notebook, it couldn't connect.I'm sure it's working, and notebook controller is working without errors.
&lt;denchmark-link:https://user-images.githubusercontent.com/31981402/63496692-ef750a00-c4f4-11e9-8808-ee5c178be2b7.png&gt;&lt;/denchmark-link&gt;



INGRESS_HOSTÔºö192.168.221.131


INGRESS_PORTÔºö 31380



ingressgateway logsÔºö


&lt;denchmark-code&gt;[2019-08-22T07:38:39.240Z] "GET /notebook/kubeflow/t2/ HTTP/1.1" 503 NR "-" 0 0 0 - "10.244.1.0" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36" "4a0d1d4a-e1d7-9fd7-acb0-8ce6d3b55ba0" "192.168.221.131:31380" "-" - - 10.244.2.226:80 10.244.1.0:6060 -
&lt;/denchmark-code&gt;


istio-ingressgateway  CLUSTER-IP: 10.100.31.25
curl -I http://10.100.31.25/notebook/kubeflow/

&lt;denchmark-code&gt;HTTP/1.1 200 OK
x-powered-by: Express
accept-ranges: bytes
cache-control: public, max-age=0
last-modified: Fri, 21 Jun 2019 14:40:54 GMT
etag: W/"599-16b7a7bacf0"
content-type: text/html; charset=UTF-8
content-length: 1433
date: Thu, 22 Aug 2019 08:04:10 GMT
x-envoy-upstream-service-time: 33
server: istio-envoy
&lt;/denchmark-code&gt;


curl -I http://10.100.31.25/notebook/kubeflow/t2

&lt;denchmark-code&gt;HTTP/1.1 503 Service Unavailable
date: Thu, 22 Aug 2019 08:04:35 GMT
server: istio-envoy
transfer-encoding: chunked
&lt;/denchmark-code&gt;

Environment:

Kubeflow version v0.6.1
kfctl version: kfctl v0.6.1-rc.2-1-g3a37cbc6
Kubernetes platform: VM(kubeadm)
Kubernetes version: v1.10.11
OS: debian9
kubeflow: v0.6.1

Is this a bug?Can anyone help me debug the issue?
Thanks a lot for this project and thank you in advance for your help!
Urmsone
	</description>
	<comments>
		<comment id='1' author='UrmsOne' date='2019-08-22T08:20:43Z'>
		Issue-Label Bot is automatically applying the label kind/bug to this issue, with a confidence of 0.88. Please mark this comment with üëç or üëé to give our bot feedback!
Links: &lt;denchmark-link:https://github.com/marketplace/issue-label-bot&gt;app homepage&lt;/denchmark-link&gt;
, &lt;denchmark-link:https://mlbot.net/data/kubeflow/kubeflow&gt;dashboard&lt;/denchmark-link&gt;
 and &lt;denchmark-link:https://github.com/hamelsmu/MLapp&gt;code&lt;/denchmark-link&gt;
 for this bot.
		</comment>
		<comment id='2' author='UrmsOne' date='2019-08-23T09:57:35Z'>
		Hello,
The problem is that when I create notebook server, VirtualServices resources generated by notebook_controller.go is incorrect.
&lt;denchmark-link:https://user-images.githubusercontent.com/31981402/63582999-b60fcd80-c5cc-11e9-9189-846eb2d9bd58.png&gt;&lt;/denchmark-link&gt;


&lt;denchmark-link:https://user-images.githubusercontent.com/31981402/63583148-06872b00-c5cd-11e9-85dc-6cacada29416.png&gt;&lt;/denchmark-link&gt;

But the code only supports the default clusterDomain ‚Äúcluster.local‚Äù
&lt;denchmark-link:https://user-images.githubusercontent.com/31981402/63583676-0f2c3100-c5ce-11e9-88ad-085c0924d25d.png&gt;&lt;/denchmark-link&gt;

&lt;denchmark-link:&gt;https://github.com/kubeflow/kubeflow/blob/f9ed088da4281b49dbce0043fe13a9681d2c99d6/components/notebook-controller/pkg/controller/notebook/notebook_controller.go&lt;/denchmark-link&gt;

Could you support custom clusterDomain in future versions?
Thanks.
		</comment>
		<comment id='3' author='UrmsOne' date='2019-09-09T13:48:47Z'>
		&lt;denchmark-link:https://github.com/UrmsOne&gt;@UrmsOne&lt;/denchmark-link&gt;
 thanks for reporting this and getting to the root of it.
Any interest in opening a PR to fix this? I think we would need to make two changes

Add a command line argument (or environment variable) to the controller to set what the behavior should be

Whether we use a command line flag or environment variable should be based on what is more consistent with the existing behavior of the controller


Modify the manifest for the notebook controller so that we can set an application parameter to control that suffix

/cc &lt;denchmark-link:https://github.com/gabrielwen&gt;@gabrielwen&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/lluunn&gt;@lluunn&lt;/denchmark-link&gt;

		</comment>
		<comment id='4' author='UrmsOne' date='2019-09-13T03:20:19Z'>
		&lt;denchmark-link:https://github.com/jlewi&gt;@jlewi&lt;/denchmark-link&gt;
 Of course, it's my pleasure.
In the past two months, I came into contact with kubeflow due to work requirements,
and found a lot  of problems in the  process of using it. I am happy to share my work results later.
		</comment>
		<comment id='5' author='UrmsOne' date='2019-12-12T04:01:41Z'>
		This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.
		</comment>
		<comment id='6' author='UrmsOne' date='2019-12-13T18:23:49Z'>
		&lt;denchmark-link:https://github.com/UrmsOne&gt;@UrmsOne&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/kimwnasptd&gt;@kimwnasptd&lt;/denchmark-link&gt;
 &lt;denchmark-link:https://github.com/lluunn&gt;@lluunn&lt;/denchmark-link&gt;
 Do we know if this has been fixed in 0.7?
		</comment>
		<comment id='7' author='UrmsOne' date='2019-12-16T17:13:04Z'>
		It looks like the cluster domain is still hard coded.



kubeflow/components/notebook-controller/controllers/notebook_controller.go


         Line 373
      in
      183919d






 service := fmt.Sprintf("%s.%s.svc.cluster.local", name, namespace) 





So it looks like we need to expose it via a command line flag or environment variable.
		</comment>
		<comment id='8' author='UrmsOne' date='2019-12-17T12:28:32Z'>
		&lt;denchmark-link:https://github.com/jlewi&gt;@jlewi&lt;/denchmark-link&gt;
 Sorry, I have been busy with my graduation project recently, which delayed to fix this bug.
I will try my best to fix this bug by providing a command line flag or environment variableÔºå
and submit the PR within this week.
		</comment>
		<comment id='9' author='UrmsOne' date='2020-03-16T15:06:55Z'>
		This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.
		</comment>
		<comment id='10' author='UrmsOne' date='2020-04-02T06:23:14Z'>
		This is not fixed. Should be reopened.
		</comment>
	</comments>
</bug>