<bug id='23' author='hanshupe' open_date='2018-10-14T08:43:51Z' closed_time='2019-04-30T20:46:51Z'>
	<summary>KNN Mahalanobis distance error</summary>
	<description>
Hi,
When I use the Mahalanobis metric for KNN I always get the error "Must provide either V or VI for Mahalanobis distance" even when I provide V with metric_params. The same request works with sklearn.neighbors.
&lt;denchmark-code&gt;
from pyod.models.knn import KNN  
from pyod.utils.data import generate_data
from sklearn.neighbors import NearestNeighbors
import numpy as np

contamination = 0.1  
n_train = 200  
n_test = 100 

X_train, y_train, X_test, y_test = generate_data(n_train=n_train, n_test=n_test, contamination=contamination)

#Doesn't work (Must provide either V or VI for Mahalanobis distance)
clf = KNN(algorithm='brute', metric='mahalanobis', metric_params={'V': np.cov(X_train)})
clf.fit(X_train)

#Works
nn = NearestNeighbors(algorithm='brute', metric='mahalanobis', metric_params={'V': np.cov(X_train)})
nn.fit(X_train)
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='hanshupe' date='2018-10-14T19:50:18Z'>
		Thanks for reporting this. It is due to the problem of passing parameters into KDTree.
Specifically, it is caused by the difference between the parameters of NearestNeighbors and KDTree...KDTree has a distinct way of using customized distance metrics.
I will fix it in this next few days and update you here.
		</comment>
		<comment id='2' author='hanshupe' date='2018-10-28T12:22:46Z'>
		Any news on this? Thanks.
		</comment>
		<comment id='3' author='hanshupe' date='2018-11-02T17:59:23Z'>
		Sorry for being late on this. I was exploring several options but get stuck by passing in customized metric to sklearn KD_tree. In PyOD, KNN detector uses a KD-tree internally.
I tried one solution to pass in mahalanobis distance:

metric = DistanceMetric.get_metric('mahalanobis', V=np.cov(X_test))
#Doesn't work (Must provide either V or VI for Mahalanobis distance)
clf = KNN(algorithm='brute', metric=metric.pairwise)
clf.fit(X_train)
#scikit-learn/scikit-learn#8890

The reason is that I built a KD-tree and also a NearestNeighbors for KNN, which should be combined into one. Will provide an update later...
As an alternative, I will recommend you to check out MCD model in PyOD that uses Mahalanobis:

First fit a minimum covariance determinant model and then compute the
Mahalanobis distance as the outlier degree of the data


		</comment>
		<comment id='4' author='hanshupe' date='2018-11-23T13:19:03Z'>
		Hi can I ask if there will be a solution for the bug? Thanks
		</comment>
		<comment id='5' author='hanshupe' date='2019-01-23T10:21:51Z'>
		&lt;denchmark-link:https://github.com/yzhao062&gt;@yzhao062&lt;/denchmark-link&gt;
 if you're too busy I could give it a try
		</comment>
		<comment id='6' author='hanshupe' date='2019-01-23T15:41:05Z'>
		&lt;denchmark-link:https://github.com/evanmiller29&gt;@evanmiller29&lt;/denchmark-link&gt;
 that will be perfect!
The current problem is I am using a KD tree and a NearestNeighbors at the same time...which might be consolidated into one with consistent parameters (KD tree has different parameters than NearestNeighbors which makes the fix more complicated).
Let me know if you need any other tips &amp; thanks for the help.
		</comment>
		<comment id='7' author='hanshupe' date='2019-04-18T07:54:04Z'>
		Hello &lt;denchmark-link:https://github.com/evanmiller29&gt;@evanmiller29&lt;/denchmark-link&gt;
, hello &lt;denchmark-link:https://github.com/yzhao062&gt;@yzhao062&lt;/denchmark-link&gt;
,
any news on this issue? Am evaluating pyod and stumbled over this issue. Some update here would be great.
Thanks for your efforts and work.
All the best
		</comment>
		<comment id='8' author='hanshupe' date='2019-04-18T15:03:46Z'>
		&lt;denchmark-link:https://github.com/sdoering&gt;@sdoering&lt;/denchmark-link&gt;
 I am back to fix this one. Someone brought this into my attention yesterday (&lt;denchmark-link:https://stackoverflow.com/q/55728669/4168429?sem=2&gt;https://stackoverflow.com/q/55728669/4168429?sem=2&lt;/denchmark-link&gt;
). I will aim to provide a solution this week (doing some experiments now). Stay tuned :)
		</comment>
		<comment id='9' author='hanshupe' date='2019-04-18T19:11:08Z'>
		The bug is fixed by commit &lt;denchmark-link:https://github.com/yzhao062/pyod/commit/db41e8e03e3901782eb68ff77ab95fc89e82bd92&gt;db41e8e&lt;/denchmark-link&gt;

The latest commit is not yet pushed to master branch but development branch only (&lt;denchmark-link:https://github.com/yzhao062/pyod/tree/development&gt;https://github.com/yzhao062/pyod/tree/development&lt;/denchmark-link&gt;
). The next release V0.7.0 will include this commit. See &lt;denchmark-link:https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py&gt;https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py&lt;/denchmark-link&gt;
 for example.
Before the new version is officially released (by the end of this month), you could overwrite the PyOD source file knn.py by &lt;denchmark-link:https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py&gt;https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py&lt;/denchmark-link&gt;
 . 
First, you need to find the location of pyod installation using 
&lt;denchmark-link:https://user-images.githubusercontent.com/15079146/56385403-045f2b00-61ed-11e9-9428-7872538590f9.png&gt;&lt;/denchmark-link&gt;

Then replace the knn.py file there by &lt;denchmark-link:https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py&gt;https://github.com/yzhao062/pyod/blob/development/pyod/models/knn.py&lt;/denchmark-link&gt;
 .
&lt;denchmark-link:https://user-images.githubusercontent.com/15079146/56385452-2658ad80-61ed-11e9-962a-44bf26c210bd.png&gt;&lt;/denchmark-link&gt;

		</comment>
		<comment id='10' author='hanshupe' date='2019-04-30T20:46:51Z'>
		Closed by &lt;denchmark-link:https://github.com/yzhao062/pyod/pull/84&gt;#84&lt;/denchmark-link&gt;
. Available in the latest version (&lt;denchmark-link:https://pypi.org/project/pyod/&gt;v0.7.0&lt;/denchmark-link&gt;
).
		</comment>
		<comment id='11' author='hanshupe' date='2019-06-21T22:43:51Z'>
		When your using the function np.cov, you need to set the parameter rowvar to False like that :
np.cov(X_train, rowvar =False)
		</comment>
		<comment id='12' author='hanshupe' date='2019-06-23T02:53:07Z'>
		&lt;denchmark-link:https://github.com/lachhebo&gt;@lachhebo&lt;/denchmark-link&gt;
 Yeah I think so. See the example provided here: &lt;denchmark-link:https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py&gt;https://github.com/yzhao062/pyod/blob/development/examples/knn_mahalanobis_example.py&lt;/denchmark-link&gt;

		</comment>
	</comments>
</bug>