<bug id='5187' author='Borda' open_date='2020-12-18T23:28:14Z' closed_time='2021-01-06T16:59:43Z'>
	<summary>fix cache for building docker image with Conda</summary>
	<description>
&lt;denchmark-h:h2&gt;üêõ Bug&lt;/denchmark-h&gt;

actually, three are some problems on master right now
&lt;denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/5170/checks?check_run_id=1571579933&gt;https://github.com/PyTorchLightning/pytorch-lightning/pull/5170/checks?check_run_id=1571579933&lt;/denchmark-link&gt;

&lt;denchmark-code&gt;#6 78.20 Package requests conflicts for:
#6 78.20 torchtext[version='&gt;=0.3.1'] -&gt; requestsThe following specifications were found to be incompatible with your CUDA driver:
#6 78.20 
#6 78.20   - cudatoolkit=10.2.89 -&gt; __cuda[version='&gt;=10.2']
#6 78.20 
#6 78.20 Your installed CUDA driver is: not available
#6 78.20 
#6 78.20 
#6 ERROR: executor failed running [/bin/bash -c conda create -y --name $CONDA_ENV cudatoolkit=${CUDA_VERSION} &amp;&amp;     conda init bash &amp;&amp;     python -c "fname = 'environment.yml' ; req = open(fname).read().replace('pytorch', '${PYTORCH_CHANNEL}', 1) ; open(fname, 'w').write(req)" &amp;&amp;     python -c "import re ; fname = 'environment.yml' ; req = re.sub(r'python[&gt;=]+[\d\.]+', 'python=${PYTHON_VERSION}', open(fname).read()) ; open(fname, 'w').write(req)" &amp;&amp;     python -c "import re ; fname = 'environment.yml' ; req = re.sub(r'torch[&gt;=]+[\d\.]+', 'torch=${PYTORCH_VERSION}', open(fname).read()) ; open(fname, 'w').write(req)" &amp;&amp;     python -c "fname = 'environment.yml' ; req = open(fname).readlines() ; open(fname, 'w').writelines([ln for ln in req if 'horovod' not in ln])" &amp;&amp;     cat environment.yml &amp;&amp;     conda env update --file environment.yml &amp;&amp;     conda clean -ya &amp;&amp;     rm environment.yml]: exit code: 1
&lt;/denchmark-code&gt;

&lt;denchmark-h:h3&gt;Additional context&lt;/denchmark-h&gt;

We need to keep this image updated because it used for our testing...
	</description>
	<comments>
		<comment id='1' author='Borda' date='2020-12-18T23:28:48Z'>
		&lt;denchmark-link:https://github.com/ydcjeff&gt;@ydcjeff&lt;/denchmark-link&gt;
 mind be interested in this one... 
		</comment>
		<comment id='2' author='Borda' date='2020-12-19T13:33:32Z'>
		I will take a look tmr.
		</comment>
		<comment id='3' author='Borda' date='2020-12-19T15:34:20Z'>
		just see it also on other images, it is possible that it is random
&lt;denchmark-link:https://github.com/PyTorchLightning/pytorch-lightning/pull/5172/checks?check_run_id=1581802294&gt;https://github.com/PyTorchLightning/pytorch-lightning/pull/5172/checks?check_run_id=1581802294&lt;/denchmark-link&gt;

on the other hand is rather strange that it building even without change, so it seems that the cache does not work...
Probably we really need to switch to. GH action cache and hope we ll fit into some size limit..
		</comment>
		<comment id='4' author='Borda' date='2020-12-19T16:08:50Z'>
		&lt;denchmark-link:https://github.com/Borda&gt;@Borda&lt;/denchmark-link&gt;
 Instead of using cache, how about we schedule the docker build once a week?
Also shall we use github action  to run only  when docker related files are changed?
WDYT?
		</comment>
		<comment id='5' author='Borda' date='2020-12-19T18:15:20Z'>
		
@Borda Instead of using cache, how about we schedule the docker build once a week?
Also shall we use github action paths to run only CI build docker when docker related files are changed?
WDYT?

we still need to run docker as CI as some PR may edit dockerfiles
but this looks good &lt;denchmark-link:https://github.com/docker/build-push-action#leverage-github-cache&gt;https://github.com/docker/build-push-action#leverage-github-cache&lt;/denchmark-link&gt;

		</comment>
	</comments>
</bug>