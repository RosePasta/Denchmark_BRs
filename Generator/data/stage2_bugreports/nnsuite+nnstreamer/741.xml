<bug id='741' author='myungjoo' open_date='2018-10-31T10:20:28Z' closed_time='2018-11-14T06:25:39Z'>
	<summary>[Converter] Performance Loss after Changing Base Class</summary>
	<description>
&lt;denchmark-link:https://github.com/wooksong&gt;@wooksong&lt;/denchmark-link&gt;
 : Resume when Project:FX is concluded.
&lt;denchmark-link:https://github.com/jaeyun-jung&gt;@jaeyun-jung&lt;/denchmark-link&gt;
 : &lt;denchmark-link:https://github.com/wooksong&gt;@wooksong&lt;/denchmark-link&gt;
 has some clues on this matter. Please share opinions with him for this matter when he's ready after Project:FX.
&lt;denchmark-link:https://github.com/wooksong&gt;@wooksong&lt;/denchmark-link&gt;
 has reported that the performance of  has significantly dropped recently.
First known reason: &lt;denchmark-link:https://github.com/nnstreamer/nnstreamer/issues/735&gt;#735&lt;/denchmark-link&gt;

However, with fixes of &lt;denchmark-link:https://github.com/nnstreamer/nnstreamer/issues/735&gt;#735&lt;/denchmark-link&gt;
, &lt;denchmark-link:https://github.com/wooksong&gt;@wooksong&lt;/denchmark-link&gt;
 has reported that the performance loss still occurs and this loss is not limited to 4N+a width cases.
His conjecture is that this is happening after the change of base class of tensor_converter.
	</description>
	<comments>
		<comment id='1' author='myungjoo' date='2018-10-31T10:20:30Z'>
		 : Thank you for posting issue &lt;denchmark-link:https://github.com/nnstreamer/nnstreamer/issues/741&gt;#741&lt;/denchmark-link&gt;
. The person in charge will reply soon.
		</comment>
		<comment id='2' author='myungjoo' date='2018-11-01T03:31:26Z'>
		In order to reproduce or verify this issue, the following tests are performed.
&lt;denchmark-h:h4&gt;Case 1: Attaching queue - tensor_converter - tensor_sink to the video streamline using tee&lt;/denchmark-h&gt;

gst-launch-1.0 v4l2src ! video/x-raw,format=RGB,framerates=30/1,width=1920,height=1080 ! \
   tee name=t ! queue ! videoconvert ! fpsdisplaysink \
   t. ! queue ! tensor_converter ! tensor_sink


Nothing goes wrong!


&lt;denchmark-link:https://user-images.githubusercontent.com/2772376/47827637-5c7eae00-ddc2-11e8-8d08-f5f7ec622bc7.png&gt;&lt;/denchmark-link&gt;

&lt;denchmark-h:h4&gt;Case 2-1 (1920x1080): Attaching queue - tensor_converter - [tensor_filter: MOBINET] - tensor_sink to the video streamline using tee&lt;/denchmark-h&gt;

gst-launch-1.0 v4l2src ! video/x-raw,format=RGB,framerates=30/1,width=1920,height=1080 ! \
  tee name=t ! queue ! videoconvert ! fpsdisplaysink \
  t. ! queue ! videoscale ! video/x-raw,width=224,height=224 ! tensor_converter ! \
       tensor_filter framework=tensorflow-lite model=./mobilenet_v1_1.0_224_quant.tflite ! tensor_sink


FPS drops to less than a half (13.33).


&lt;denchmark-link:https://user-images.githubusercontent.com/2772376/47827814-4cb39980-ddc3-11e8-83d3-9d2a0b766c2c.png&gt;&lt;/denchmark-link&gt;

&lt;denchmark-h:h4&gt;Case 2-2 (640x480): Attaching queue - tensor_converter - [tensor_filter: MOBINET] - tensor_sink to the video streamline using tee&lt;/denchmark-h&gt;

gst-launch-1.0 v4l2src ! video/x-raw,format=RGB,framerates=30/1,width=640,height=480 ! \
  tee name=t ! queue ! videoconvert ! fpsdisplaysink \
  t. ! queue ! videoscale ! video/x-raw,width=224,height=224 ! tensor_converter ! \
       tensor_filter framework=tensorflow-lite model=./mobilenet_v1_1.0_224_quant.tflite ! tensor_sink


Nothing goes wrong!


&lt;denchmark-link:https://user-images.githubusercontent.com/2772376/47830442-31e72200-ddcf-11e8-949d-09e46806906e.png&gt;&lt;/denchmark-link&gt;

&lt;denchmark-h:h4&gt;Case 3: Attaching queue - tensor_converter - [tensor_filter: custom_passthrough] - tensor_sink to the video streamline using tee&lt;/denchmark-h&gt;

gst-launch-1.0 v4l2src ! video/x-raw,format=RGB,framerates=30/1,width=1920,height=1080 ! \
  tee name=t ! queue ! videoconvert ! fpsdisplaysink \
  t. ! queue ! videoscale ! video/x-raw,width=280,height=40 ! tensor_converter ! \
       tensor_filter framework=custom model=./libnnstreamer_customfilter_passthrough.so silent=false ! tensor_sink


Nothing goes wrong!


&lt;denchmark-link:https://user-images.githubusercontent.com/2772376/47827980-38bc6780-ddc4-11e8-88ca-ef2eacaca1ba.png&gt;&lt;/denchmark-link&gt;

As shown above, although the pipeline is separated into two sub-pipeline, the image stream line and the nueral network line, the performance of the nueral network line affects the performance of the image stream pipeline.
		</comment>
		<comment id='3' author='myungjoo' date='2018-11-01T06:32:48Z'>
		&lt;denchmark-link:https://github.com/nnsuite/nnstreamer/files/2537438/old_converter.zip&gt;old_converter.zip&lt;/denchmark-link&gt;

I tested with attached tensor-converter. (old version, parent base-transform, modified only for video stream test)
This also shows fps drops. (less than 15 fps)
		</comment>
		<comment id='4' author='myungjoo' date='2018-11-02T02:50:59Z'>
		As &lt;denchmark-link:https://github.com/myungjoo&gt;@myungjoo&lt;/denchmark-link&gt;
 pointed out, this issue does not occur when replacing the queue in the NN pipeline with a leaky queue.
gst-launch-1.0 v4l2src ! video/x-raw,format=RGB,framerates=30/1,width=1920,height=1080 ! \
  tee name=t ! queue ! videoconvert ! fpsdisplaysink \
  t. ! queue leaky=2 ! videoscale ! video/x-raw,width=224,height=224 ! tensor_converter ! \
       tensor_filter framework=tensorflow-lite model=./mobilenet_v1_1.0_224_quant.tflite ! tensor_sink
&lt;denchmark-link:https://user-images.githubusercontent.com/2772376/47891143-4ee62880-de95-11e8-8f75-1654301b66b9.png&gt;&lt;/denchmark-link&gt;

IMO, we can close this issue after merging &lt;denchmark-link:https://github.com/nnstreamer/nnstreamer/pull/736&gt;#736&lt;/denchmark-link&gt;
.
		</comment>
		<comment id='5' author='myungjoo' date='2018-11-14T06:25:39Z'>
		We don't have the issue now.
		</comment>
	</comments>
</bug>