<bug id='642' author='tomchen1000' open_date='2018-07-31T16:20:21Z' closed_time='2018-10-06T22:33:49Z'>
	<summary>Carla 0.8.4 server hangs</summary>
	<description>
Start Carla server
&lt;denchmark-code&gt;SDL_VIDEODRIVER=offscreen ./CarlaUE4.sh /Game/Maps/Town02 -carla-server -benchmark -fps=5 -world-port=12000 -carla-no-hud
&lt;/denchmark-code&gt;

Have a a client like client_example.py to run episodes on the server, after 1000 episodes or so.
Server hangs with this error:
&lt;denchmark-code&gt;[2018.07.31-11.11.39:424][ 97]LogCarla: == CARLA Settings ==============================================================
[2018.07.31-11.11.39:424][ 97]LogCarla: Last settings file loaded: &lt;string-provided-by-client&gt;
[2018.07.31-11.11.39:424][ 97]LogCarla: [CARLA/Server]
[2018.07.31-11.11.39:424][ 97]LogCarla: Networking = Enabled
[2018.07.31-11.11.39:424][ 97]LogCarla: World Port = 2000
[2018.07.31-11.11.39:424][ 97]LogCarla: Server Time-out = 10000 ms
[2018.07.31-11.11.39:424][ 97]LogCarla: Synchronous Mode = Enabled
[2018.07.31-11.11.39:424][ 97]LogCarla: Send Non-Player Agents Info = Enabled
[2018.07.31-11.11.39:424][ 97]LogCarla: [CARLA/LevelSettings]
[2018.07.31-11.11.39:424][ 97]LogCarla: Player Vehicle        = Default
[2018.07.31-11.11.39:424][ 97]LogCarla: Number Of Vehicles    = 1
[2018.07.31-11.11.39:424][ 97]LogCarla: Number Of Pedestrians = 0
[2018.07.31-11.11.39:424][ 97]LogCarla: Weather Id = 0
[2018.07.31-11.11.39:424][ 97]LogCarla: Seed Vehicle Spawner = 123456789
[2018.07.31-11.11.39:424][ 97]LogCarla: Seed Pedestrian Spawner = 123456789
[2018.07.31-11.11.39:424][ 97]LogCarla: Two-Wheeled Vehicles = Enabled
[2018.07.31-11.11.39:424][ 97]LogCarla: Found 16 available weather settings.
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 0 - Default
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 1 - ClearNoon
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 2 - CloudyNoon
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 3 - WetNoon
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 4 - WetCloudyNoon
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 5 - MidRainyNoon
[2018.07.31-11.11.39:424][ 97]LogCarla:   * 6 - HardRainNoon
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 7 - SoftRainNoon
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 8 - ClearSunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 9 - CloudySunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 10 - WetSunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 11 - WetCloudySunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 12 - MidRainSunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 13 - HardRainSunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 14 - SoftRainSunset
[2018.07.31-11.11.39:425][ 97]LogCarla:   * 15 - ClearNight
[2018.07.31-11.11.39:425][ 97]LogCarla: [CARLA/QualitySettings]
[2018.07.31-11.11.39:425][ 97]LogCarla: Quality Settings = None
[2018.07.31-11.11.39:425][ 97]LogCarla: [CARLA/Sensor]
[2018.07.31-11.11.39:425][ 97]LogCarla: Added 0 sensors.
[2018.07.31-11.11.39:425][ 97]LogCarla: Semantic Segmentation = Disabled
[2018.07.31-11.11.39:425][ 97]LogCarla: ================================================================================
[2018.07.31-11.11.39:432][ 97]LogWorld: Bringing up level for play took: 0.136663
[2018.07.31-11.11.39:435][ 97]LogCarlaServer: Sending 83 available start positions
[2018.07.31-11.11.39:435][ 97]LogCarlaServer: Sending 0 sensor descriptions
[2018.07.31-11.11.39:435][ 97]LogCarlaServer: Episode start received: { StartIndex = 28 }
[2018.07.31-11.11.39:437][ 97]LogCarla: Changing weather settings to "Default"
[2018.07.31-11.11.39:437][ 97]LogCarlaServer: Ready to play, notifying client
[2018.07.31-11.11.39:439][ 97]LogCarla: Found 83 PlayerStart positions for spawning vehicles
[2018.07.31-11.11.39:463][ 97]LogCarla: Spawned all 1 requested vehicles
[2018.07.31-11.11.39:464][ 97]LogLoad: Took 2.872299 seconds to LoadMap(/Game/Maps/Town02)
ERROR: tcpserver 0 : error reading message: Operation canceled
[2018.07.31-11.19.34:102][199]LogScript: Warning: FLatentActionManager::ProcessLatentActions: CallbackTarget is None.
&lt;/denchmark-code&gt;

Client have a log like this:
&lt;denchmark-code&gt;Traceback (most recent call last):
  File "/home/user/client/carla/tcp.py", line 87, in _read_n
    data = self._socket.recv(length)
socket.timeout: timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/user/client/client_code", line 275, in reset
    self.client.load_settings(settings)
  File "/home/user/client/carla/client.py", line 70, in load_settings
    return self._request_new_episode(carla_settings)
  File "/home/user/client/carla/client.py", line 168, in _request_new_episode
    data = self._world_client.read()
  File "/home/user/client/carla/tcp.py", line 73, in read
    header = self._read_n(4)
  File "/home/user/client/carla/tcp.py", line 89, in _read_n
    self._reraise_exception_as_tcp_error('failed to read data', exception)
  File "/home/user/client/carla/tcp.py", line 97, in _reraise_exception_as_tcp_error
    raise TCPConnectionError('%s%s: %s' % (self._logprefix, message, exception))
carla.tcp.TCPConnectionError: (localhost:2000) failed to read data: timed out
&lt;/denchmark-code&gt;

	</description>
	<comments>
		<comment id='1' author='tomchen1000' date='2018-07-31T16:41:38Z'>
		This is related to SDL solution for running offscreen. It is not working properly.
Try this solution :
&lt;denchmark-link:http://carla.readthedocs.io/en/latest/carla_headless/&gt;http://carla.readthedocs.io/en/latest/carla_headless/&lt;/denchmark-link&gt;

		</comment>
		<comment id='2' author='tomchen1000' date='2018-07-31T17:48:59Z'>
		That solution requires sudo permission, which doesn't work for my environment.
I also try the docker approach (&lt;denchmark-link:http://carla.org/2018/06/08/release-0.8.3/&gt;http://carla.org/2018/06/08/release-0.8.3/&lt;/denchmark-link&gt;
) to workaround the sudo permission requirement. However, docker approach also set SDL_VIDEODRIVER to offscreen, and also has this connection issue.
Does that mean the Carla doesn't really support docker?
Any fix to make this SDL solution for running offscreen to work?
		</comment>
		<comment id='3' author='tomchen1000' date='2018-07-31T18:06:54Z'>
		Hey &lt;denchmark-link:https://github.com/tomchen1000&gt;@tomchen1000&lt;/denchmark-link&gt;

With docker it is working fine for me.
Have you tried already ?
		</comment>
		<comment id='4' author='tomchen1000' date='2018-07-31T19:07:11Z'>
		What could fix the issue by using the docker approach? It set SDL_VIDEODRIVER to offscreen too:
&lt;denchmark-code&gt;ENV SDL_VIDEODRIVER=offscreen
&lt;/denchmark-code&gt;

And I just tried 0.8.4 docker image, it has similar issue: after running for a while, it gives the following message and hangs.
&lt;denchmark-code&gt;[2018.07.31-15.24.36:470][103]LogCarlaServer: Received new episode
[2018.07.31-15.24.36:470][103]LogCarla: Loading CARLA settings from string
[2018.07.31-15.24.36:470][103]LogCarlaServer: Restarting the level...
[2018.07.31-15.24.36:495][104]LogNet: Browse: /Game/Maps/Town02?Name=Player?restart
[2018.07.31-15.24.36:519][104]LogLoad: LoadMap: /Game/Maps/Town02?Name=Player
[2018.07.31-15.24.39:176][104]LogAIModule: Creating AISystem for world Town02
[2018.07.31-15.24.39:551][104]LogLoad: Game class is 'CarlaGameMode_C'
[2018.07.31-15.24.39:701][104]LogWorld: Bringing World /Game/Maps/Town02.Town02 up for play (max tick rate 0) at 2018.07.31-15.24.39
[2018.07.31-15.24.39:701][104]LogCarla: Loading weather description from ../../../CarlaUE4/Config/CarlaWeather.ini
[2018.07.31-15.24.39:703][104]LogCarla: Warning: "../../../CarlaUE4/Config/CarlaWeather.Town02.ini" not found
[2018.07.31-15.24.39:704][104]LogCarla: == CARLA Settings ==============================================================
[2018.07.31-15.24.39:704][104]LogCarla: Last settings file loaded: &lt;string-provided-by-client&gt;
[2018.07.31-15.24.39:704][104]LogCarla: [CARLA/Server]
[2018.07.31-15.24.39:704][104]LogCarla: Networking = Enabled
[2018.07.31-15.24.39:704][104]LogCarla: World Port = 2000
[2018.07.31-15.24.39:704][104]LogCarla: Server Time-out = 10000 ms
[2018.07.31-15.24.39:704][104]LogCarla: Synchronous Mode = Enabled
[2018.07.31-15.24.39:704][104]LogCarla: Send Non-Player Agents Info = Enabled
[2018.07.31-15.24.39:704][104]LogCarla: [CARLA/LevelSettings]
[2018.07.31-15.24.39:704][104]LogCarla: Player Vehicle        = Default
[2018.07.31-15.24.39:704][104]LogCarla: Number Of Vehicles    = 1
[2018.07.31-15.24.39:704][104]LogCarla: Number Of Pedestrians = 0
[2018.07.31-15.24.39:704][104]LogCarla: Weather Id = 0
[2018.07.31-15.24.39:704][104]LogCarla: Seed Vehicle Spawner = 123456789
[2018.07.31-15.24.39:704][104]LogCarla: Seed Pedestrian Spawner = 123456789
[2018.07.31-15.24.39:704][104]LogCarla: Two-Wheeled Vehicles = Enabled
[2018.07.31-15.24.39:704][104]LogCarla: Found 16 available weather settings.
[2018.07.31-15.24.39:704][104]LogCarla:   * 0 - Default
[2018.07.31-15.24.39:704][104]LogCarla:   * 1 - ClearNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 2 - CloudyNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 3 - WetNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 4 - WetCloudyNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 5 - MidRainyNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 6 - HardRainNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 7 - SoftRainNoon
[2018.07.31-15.24.39:704][104]LogCarla:   * 8 - ClearSunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 9 - CloudySunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 10 - WetSunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 11 - WetCloudySunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 12 - MidRainSunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 13 - HardRainSunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 14 - SoftRainSunset
[2018.07.31-15.24.39:704][104]LogCarla:   * 15 - ClearNight
[2018.07.31-15.24.39:704][104]LogCarla: [CARLA/QualitySettings]
[2018.07.31-15.24.39:704][104]LogCarla: Quality Settings = None
[2018.07.31-15.24.39:704][104]LogCarla: [CARLA/Sensor]
[2018.07.31-15.24.39:704][104]LogCarla: Added 0 sensors.
[2018.07.31-15.24.39:704][104]LogCarla: Semantic Segmentation = Disabled
[2018.07.31-15.24.39:704][104]LogCarla: ================================================================================
[2018.07.31-15.24.39:711][104]LogWorld: Bringing up level for play took: 0.156158
[2018.07.31-15.24.39:713][104]LogCarlaServer: Sending 83 available start positions
[2018.07.31-15.24.39:713][104]LogCarlaServer: Sending 0 sensor descriptions
[2018.07.31-15.24.39:715][104]LogCarlaServer: Episode start received: { StartIndex = 28 }
[2018.07.31-15.24.39:718][104]LogCarla: Changing weather settings to "Default"
[2018.07.31-15.24.39:719][104]LogCarlaServer: Ready to play, notifying client
[2018.07.31-15.24.39:723][104]LogCarla: Found 83 PlayerStart positions for spawning vehicles
[ERROR: tcpserver 0 : error reading message: Operation canceled
2018.07.31-15.24.39:756][104]LogCarla: Spawned all 1 requested vehicles
[2018.07.31-15.24.39:758][104]LogLoad: Took 3.238588 seconds to LoadMap(/Game/Maps/Town02)
[2018.07.31-15.24.39:941][105]LogRenderer: Reallocating scene render targets to support 128x128 Format 10 NumSamples 1 (Frame:1).
[2018.07.31-15.24.40:082][106]LogRenderer: Reallocating scene render targets to support 100x100 Format 10 NumSamples 1 (Frame:3).
&lt;/denchmark-code&gt;

		</comment>
		<comment id='5' author='tomchen1000' date='2018-09-29T22:01:34Z'>
		This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.
		</comment>
		<comment id='6' author='tomchen1000' date='2018-12-03T11:00:37Z'>
		Hi &lt;denchmark-link:https://github.com/tomchen1000&gt;@tomchen1000&lt;/denchmark-link&gt;

I'm experiencing the same issue with carla docker 8.2.
Did you find a way to fix it ?
thanks
		</comment>
		<comment id='7' author='tomchen1000' date='2019-02-25T00:40:08Z'>
		Hello, I am experiencing the same issue
		</comment>
	</comments>
</bug>