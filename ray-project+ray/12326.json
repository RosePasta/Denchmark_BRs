{"BR": {"BR_id": "12326", "BR_author": "amogkam", "BRopenT": "2020-11-24T00:57:43Z", "BRcloseT": "2020-11-25T07:15:54Z", "BR_text": {"BRsummary": "[Autoscaler] [Docker] Cluster shutdown fails with `No such container: ray_container`", "BRdescription": "\n I have a AWS cluster using Docker. I try to shut it down with ray down cluster.yaml and it fails with this error:\n <denchmark-code>Loaded cached provider configuration from /var/folders/qt/f7ftj_xs6fn_swc4vn7kx0y80000gn/T/ray-config-a2a9e60572b77712cee83f75d3fb9a7c71fb2fb4\n If you experience issues with the cloud provider, try re-running the command with --no-config-cache.\n Destroying cluster. Confirm [y/N]: y\n Fetched IP: 34.219.19.214\n Running `docker exec -it  ray_container /bin/bash -c 'bash --login -c -i '\"'\"'true && source ~/.bashrc && export OMP_NUM_THREADS=1 PYTHONWARNINGS=ignore && (ray stop)'\"'\"'' `\n Warning: Permanently added '34.219.19.214' (ECDSA) to the list of known hosts.\n Error: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Command failed:\n \n   ssh -tt -i ~/.ssh/amog-anyscale.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -o ExitOnForwardFailure=yes -o ServerAliveInterval=5 -o ServerAliveCountMax=3 -o ControlMaster=auto -o ControlPath=/tmp/ray_ssh_15207363a2/b961348b8b/%C -o ControlPersist=10s -o ConnectTimeout=120s ubuntu@34.219.19.214 bash --login -c -i 'true && source ~/.bashrc && export OMP_NUM_THREADS=1 PYTHONWARNINGS=ignore && (docker exec -it  ray_container /bin/bash -c '\"'\"'bash --login -c -i '\"'\"'\"'\"'\"'\"'\"'\"'true && source ~/.bashrc && export OMP_NUM_THREADS=1 PYTHONWARNINGS=ignore && (ray stop)'\"'\"'\"'\"'\"'\"'\"'\"''\"'\"' )'\n \n Exception occurred when stopping the cluster Ray runtime (use -v to dump teardown exceptions).\n Ignoring the exception and attempting to shut down the cluster nodes anyway.\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Warning: Permanently added '34.219.19.214' (ECDSA) to the list of known hosts.\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-0dc3d73bfd56fd872\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-06fdae5f11ded53cd\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-0043a53e10d32d032\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-0bdb7ec77187c757e\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-07d8ef27afa026bb3\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-0e4b95f27a5c259a4\n Fetched IP: 34.219.19.214\n Running `docker stop ray_container`\n Error response from daemon: No such container: ray_container\n Shared connection to 34.219.19.214 closed.\n Docker stop failed on i-033c3290cbd0a2bca\n </denchmark-code>\n \n The 4 lines from Fetched IP to Docker stop failed continuously gets repeated.\n Here is my YAML file for reference:\n <denchmark-code>cluster_name: amog_xgboost_tune\n min_workers: 1\n max_workers: 200\n initial_workers: 1\n autoscaling_mode: default\n docker:\n     image: 'anyscale/ray-ml:latest'\n     container_name: ray_container\n     pull_before_run: false\n     run_options:\n         - --privileged\n         - --shm-size=510000000000\n target_utilization_fraction: 0.8\n idle_timeout_minutes: 5\n provider:\n     type: aws\n     region: us-west-2\n     availability_zone: us-west-2a\n     cache_stopped_nodes: false\n auth:\n     ssh_user: ubuntu\n     ssh_private_key: ~/.ssh/amog-anyscale.pem\n head_node:\n     # InstanceType: m5.4xlarge\n     InstanceType: r5.16xlarge\n     ImageId: ami-05ac7a76b4c679a79\n     KeyName: amog-anyscale\n worker_nodes:\n     InstanceType: m5.xlarge\n     ImageId: ami-05ac7a76b4c679a79\n     KeyName: amog-anyscale\n     InstanceMarketOptions:\n         MarketType: spot\n initialization_commands: []\n setup_commands:\n     - echo \"hello\"\n     - pip install -U https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-1.1.0.dev0-cp37-cp37m-manylinux2014_x86_64.whl\n     - pip install dask distributed xgboost s3fs\n head_setup_commands: \n     - echo \"hello\"\n     - pip install -U git+https://github.com/ray-project/xgboost_ray@master#xgboost_ray\n worker_setup_commands:\n     - echo \"hello\"\n     - pip install -U git+https://github.com/ray-project/xgboost_ray@master#xgboost_ray\n head_start_ray_commands:\n     - ray stop\n     - \"ulimit -n 65536; ray start --head --port=6379 --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml --object-store-memory=500000000000 --resources='{\\\"actor_cpus\\\": 0}'\"\n worker_start_ray_commands:\n     - ray stop\n     - \"ulimit -n 65536; ray start --address=$RAY_HEAD_IP:6379 --object-manager-port=8076 --resources='{\\\"actor_cpus\\\": 4}'\"\n </denchmark-code>\n \n Is there anyway I can force shutdown of the cluster?\n cc <denchmark-link:https://github.com/ijrsvt>@ijrsvt</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "amogkam", "commentT": "2020-11-24T16:14:56Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/amogkam>@amogkam</denchmark-link>\n , these are wrapped in   blocks, so it should be torn down regardless :) Can you verify this in the AWS console? That being said, you definitely found a bug where we run docker stop against only one node  . Thanks for reporting this!!\n \t\t"}}}, "commit": {"commit_id": "c5845c3a4e290f36808bfc15b667c71b07b608cd", "commit_author": "Ian Rodney", "commitT": "2020-11-24 23:15:53-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\autoscaler\\_private\\commands.py", "file_new_name": "python\\ray\\autoscaler\\_private\\commands.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "367,368,369,370,371,372,373,374,375,376,377,378,379,380,381", "deleted_lines": "367,368,369,370,371,372,373,374,375,376,377", "method_info": {"method_name": "run_docker_stop", "method_params": "node,container_name", "method_startline": "365", "method_endline": "383"}}}}}}}