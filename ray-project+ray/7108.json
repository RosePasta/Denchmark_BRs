{"BR": {"BR_id": "7108", "BR_author": "sven1977", "BRopenT": "2020-02-10T15:54:31Z", "BRcloseT": "2020-02-11T20:51:45Z", "BR_text": {"BRsummary": "[RLlib] AsyncReplayOptimizer should retain good sample_tasks even if other sample_tasks have failed.", "BRdescription": "\n AsyncReplayOptimizer::_step() collects all self.sample_tasks that are completed (including crashed ones), leaving then self.sample_tasks with a count of 0 (empty).\n After that collection step, it calls ray_get_and_free on all these tasks' IDs, which crashes (due to the error'd crashed tasks). This causes even the still-good tasks to not be processed and reinstated, leaving the optimizer in an infinite loop (trying to collect samples w/o any sample_tasks left).\n Ray version and other system information (Python version, TensorFlow version, OS):\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Please provide a script that can be run to reproduce the issue. The script should have no external library dependencies (i.e., use fake or mock data / environments):\n If we cannot run your script, we cannot fix your issue.\n This can be reproduced by debugging the test case rllib/tests/test_ignore_worker_failure.py::testAsyncReplay, stepping through the code and waiting a while in async_replay_optimizer.py::_step before the call to self.sample_tasks.completed() (so that all tasks are completed, the good and the failed ones). This then should make ray_get_and_free error and skip the necessary\n <denchmark-code>               # Kick off another sample request\n                 self.sample_tasks.add(ev, ev.sample_with_count.remote())\n </denchmark-code>\n \n code.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {}}, "commit": {"commit_id": "2a0e4d94aa162feadbd2d4d7ca6b0693d21aa12f", "commit_author": "Sven Mika", "commitT": "2020-02-11 12:51:44-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "rllib\\optimizers\\async_replay_optimizer.py", "file_new_name": "rllib\\optimizers\\async_replay_optimizer.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,234,235,236,238,243,247,257,260,261,262,263,264", "deleted_lines": "209,211,217,221,231", "method_info": {"method_name": "_step", "method_params": "self", "method_startline": "206", "method_endline": "282"}}}}}}}