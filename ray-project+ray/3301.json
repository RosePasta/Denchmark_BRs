{"BR": {"BR_id": "3301", "BR_author": "arcelien", "BRopenT": "2018-11-11T22:28:20Z", "BRcloseT": "2018-11-21T20:26:23Z", "BR_text": {"BRsummary": "[tune] PBT causes task reconstruction messages", "BRdescription": "\n <denchmark-h:h3>System information</denchmark-h>\n \n \n OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Linux Ubuntu 16.04\n Ray installed from (source or binary): binary from latest installed 11/7\n Ray version: 0.5.3\n Python version: 2.7.15\n \n <denchmark-h:h3>Describe the problem</denchmark-h>\n \n Getting excessive ray logging to stdout about reconstructing task ... when running PBT. There seems to be relatively less spam early on, and more as training progresses.\n An example of this line is: I1111 00:40:52.240785 29181 node_manager.cc:1422] Reconstructing task 00000000b85b590f361da6f18d3143dabf82655a on client 94396e7715cc5f95bfbccf545a7e14591dacc7c1\n With 4 trials, 200 total epochs, and a perturb interval of 10 iterations:\n At 0 epochs: 1 line per iteration per trial\n At 10 epochs, 1 checkpoint, 0 perturb: now 2 lines / iter / trial\n At 20 epochs: 3-5 lines\n At 2X epochs: ~10 lines\n At 190 epochs, 27 checkpoints, 25 perturbs: About 100 lines / iter / trial\n The total log size is about 14MB, about 100k total lines.\n With 8 trials running the same thing, size increases to about 48MB, 345K total lines. Also, for some reason there's 47 checkpoints, and 25 perturbs (4 trials had 27 checkpoints, 25 perturbs).\n <denchmark-h:h3>Source code / logs</denchmark-h>\n \n I can attach logs if they would be helpful, but they are very big.\n Saving and restoring is done with a tf.Saver object, calling saver.save() and saver.restore()\n Configs are:\n train_spec = {\n     \"run\": RayModel,\n     \"trial_resources\": {\n         \"cpu\": 8,\n         \"gpu\": 1\n     },\n     \"stop\": {\n         \"training_iteration\": hparams.num_epochs,\n     },\n     \"config\": hparams.values(),\n     \"local_dir\": FLAGS.local_dir,\n     \"checkpoint_freq\": FLAGS.checkpoint_freq,\n     \"num_samples\": FLAGS.num_samples\n }\n ray.init()\n pbt = PopulationBasedTraining(\n     time_attr=\"training_iteration\",\n     reward_attr=\"val_acc\",\n     perturbation_interval=FLAGS.perturbation_interval,\n     m_explore_fn=explore)\n run_experiments({\"autoaug_pbt\": train_spec}, scheduler=pbt, verbose=False)\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "arcelien", "commentT": "2018-11-11T22:59:58Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/richardliaw>@richardliaw</denchmark-link>\n  <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  we shouldn't ever see reconstructing since Tune uses only actor tasks right? Any idea how this could happen?\n This might be an 0.6 bug.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "arcelien", "commentT": "2018-11-11T23:23:38Z", "comment_text": "\n \t\tThis is now a release blocker :), given that PBT shouldn't even be creating tasks.\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "arcelien", "commentT": "2018-11-12T07:36:44Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/arcelien>@arcelien</denchmark-link>\n  could you provide some more details on how to reproduce (for example, does this always happen within a short amount of time? if you run on small scale is it ok?)\n I tried running PBT locally (the pbt_ppo_example.py file), and did not see this.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "arcelien", "commentT": "2018-11-12T08:06:05Z", "comment_text": "\n \t\tLooks like the problem always happens for me with num_workers > 1, with the spam getting progressively more as the number of workers increases.\n I will try an experiment with a toy model later, but the current one is a resnet model from the tensorflow models repo.\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "arcelien", "commentT": "2018-11-12T08:38:36Z", "comment_text": "\n \t\tIt sometimes happens with the Tune Tutorial too:\n <denchmark-link:https://github.com/ray-project/tutorial/tree/master/tune_exercises>https://github.com/ray-project/tutorial/tree/master/tune_exercises</denchmark-link>\n  in the\n Solutions notebook in the section with AsyncHyperBand.\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Mon, Nov 12, 2018 at 12:06 AM Daniel Ho ***@***.***> wrote:\n  Looks like the problem always happens for me with num_workers > 1, with\n  the spam getting progressively more as the number of workers increases.\n \n  I will try an experiment with a toy model later, but the current one is a\n  resnet model from the tensorflow models repo.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#3301 (comment)>,\n  or mute the thread\n  <https://github.com/notifications/unsubscribe-auth/AEUc5ccGeiS5tzyK9qO79kyMEfDV_QZvks5uuSvxgaJpZM4YYuP4>\n  .\n \n \n \n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "arcelien", "commentT": "2018-11-17T21:16:26Z", "comment_text": "\n \t\tRan an ablation test:\n \n original tensorflow wide-resnet model on CIFAR10, using tf.saver to checkpoint, training with tf.optim (adam): reconstructing messages appear after 1st checkpoint\n modified model to much smaller toy-resnet (~1GB, mostly image data) from WRN (8GB+): messages appear, no change\n removed checkpointing (tf.saver calls) entirely, restore starts from random init, - no change, messages appear after 1st dummy \"checkpoint\"\n changed model to only use CPU compute, no GPU in trial resources config - no change, (getting some GPU init errors?)\n changed so that only 1 forward pass runs per ray iteration, instead of 1 epoch, and no validation: no change\n Removed training step entirely - fixed, messages disappear\n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "arcelien", "commentT": "2018-11-18T00:19:47Z", "comment_text": "\n \t\tFYI <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  I was not able to reproduce this on python 2.7 /  master. It could be an environment specific thing.\n \t\t"}, "comments_7": {"comment_id": 8, "comment_author": "arcelien", "commentT": "2018-11-18T00:24:44Z", "comment_text": "\n \t\tI noticed that it doesn't happen when all trials fit inside compute resources and runs don't get paused.\n \t\t"}, "comments_8": {"comment_id": 9, "comment_author": "arcelien", "commentT": "2018-11-18T00:44:44Z", "comment_text": "\n \t\tOk I think I know the proximate cause of this:\n In tune, when we PAUSE a trial, we call runner.save_to_object.remote(): \n \n \n ray/python/ray/tune/ray_trial_executor.py\n \n \n          Line 282\n       in\n       65c27c7\n \n \n \n \n \n \n  trial._checkpoint.value = trial.runner.save_to_object.remote() \n \n \n \n \n \n This is followed up by __ray_terminate__ing the runner.\n Later on, we pass that future returned by save_to_object to restore_from_remote(): \n \n \n ray/python/ray/tune/ray_trial_executor.py\n \n \n          Line 301\n       in\n       65c27c7\n \n \n \n \n \n \n  ray.get(trial.runner.restore_from_object.remote(value)) \n \n \n \n \n \n However that seems to somehow trigger the reconstructing message.\n The message goes away if you add a ray.get() after save_to_object.remote() (i.e. , which forces the ray terminate to occur after the method has completed. Though I'm not sure why that should matter other than there being some bug in the backend about getting items after the actor has terminated, even if the actor did put the object successfully. <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  any ideas ?\n This issue is quite specific though and fairly harmless, so not a release blocker.\n \t\t"}}}, "commit": {"commit_id": "3e33f6f71bb52841127464366dd7922c996d044d", "commit_author": "Stephanie Wang", "commitT": "2018-11-21 12:26:22-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\gcs\\format\\gcs.fbs", "file_new_name": "src\\ray\\gcs\\format\\gcs.fbs", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "167,168,169,170,171,172,173,185,186", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\actor_registration.cc", "file_new_name": "src\\ray\\raylet\\actor_registration.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "40", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::ActorRegistration::ExtendFrontier", "method_params": "handle_id,execution_dependency", "method_startline": "34", "method_endline": "41"}}, "hunk_1": {"Ismethod": 1, "added_lines": "44", "deleted_lines": "44", "method_info": {"method_name": "ray::raylet::ActorRegistration::MarkDead", "method_params": "", "method_startline": "44", "method_endline": "44"}}, "hunk_2": {"Ismethod": 1, "added_lines": "43,44,45", "deleted_lines": "43,44", "method_info": {"method_name": "ray::raylet::ActorRegistration::IsAlive", "method_params": "", "method_startline": "43", "method_endline": "45"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "src\\ray\\raylet\\actor_registration.h", "file_new_name": "src\\ray\\raylet\\actor_registration.h", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "42", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::ActorRegistration::GetTableData", "method_params": "", "method_startline": "42", "method_endline": "42"}}, "hunk_1": {"Ismethod": 1, "added_lines": "80", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::ActorRegistration::GetDummyObjects", "method_params": "", "method_startline": "80", "method_endline": "80"}}, "hunk_2": {"Ismethod": 1, "added_lines": "47", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::ActorRegistration::GetState", "method_params": "", "method_startline": "47", "method_endline": "47"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 17, "file_old_name": "src\\ray\\raylet\\node_manager.cc", "file_new_name": "src\\ray\\raylet\\node_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1054,1055,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091", "deleted_lines": "1074,1075,1076,1077,1078,1079,1080,1081,1084,1085,1086,1087,1088,1089,1090,1091", "method_info": {"method_name": "ray::raylet::NodeManager::TreatTaskAsFailed", "method_params": "task", "method_startline": "1054", "method_endline": "1092"}}, "hunk_1": {"Ismethod": 1, "added_lines": null, "deleted_lines": "1024", "method_info": {"method_name": "ray::raylet::NodeManager::TreatTaskAsFailed", "method_params": "spec", "method_startline": "1024", "method_endline": "1050"}}, "hunk_2": {"Ismethod": 1, "added_lines": "449", "deleted_lines": "437", "method_info": {"method_name": "ray::raylet::NodeManager::HeartbeatAdded", "method_params": "client_id,heartbeat_data", "method_startline": "414", "method_endline": "455"}}, "hunk_3": {"Ismethod": 1, "added_lines": "1434,1435,1436,1437,1439,1440,1441,1445,1446,1447,1448,1449,1450,1451,1452,1453,1474,1475,1476,1477,1478,1479,1480,1481,1482,1483,1484,1486,1487,1488,1489,1490,1491,1492,1493", "deleted_lines": "1450,1451,1476,1477,1479,1480", "method_info": {"method_name": "ray::raylet::NodeManager::FinishAssignedTask", "method_params": "worker", "method_startline": "1419", "method_endline": "1507"}}, "hunk_4": {"Ismethod": 1, "added_lines": "470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500", "deleted_lines": "470,471,472,473,474,475,476,477,478,479,480,481,482", "method_info": {"method_name": "ray::raylet::NodeManager::HandleDisconnectedActor", "method_params": "actor_id,was_local", "method_startline": "470", "method_endline": "500"}}, "hunk_5": {"Ismethod": 1, "added_lines": "502,503,504,505,508,509,510,511,512,514,515,516,517,518,519,520,521,522,523,524,549,550,551,552,553,554,555,556", "deleted_lines": "508,509,510,511,512,513,514,515,516,517,518", "method_info": {"method_name": "ray::raylet::NodeManager::HandleActorStateTransition", "method_params": "actor_id,data", "method_startline": "502", "method_endline": "558"}}, "hunk_6": {"Ismethod": 1, "added_lines": "402,403,404,405,406,407,408,409,410,411", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::NodeManager::ClientRemoved", "method_params": "client_data", "method_startline": "380", "method_endline": "412"}}, "hunk_7": {"Ismethod": 1, "added_lines": "511,512,514,515,516,517,518,519,520", "deleted_lines": "511,512,513,514,515,516,517,518", "method_info": {"method_name": "ray::raylet::NodeManager::CleanUpTasksForDeadActor", "method_params": "actor_id", "method_startline": "511", "method_endline": "520"}}, "hunk_8": {"Ismethod": 1, "added_lines": "1654,1655", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::NodeManager::ForwardTaskOrResubmit", "method_params": "task,node_manager_id", "method_startline": "1622", "method_endline": "1668"}}, "hunk_9": {"Ismethod": 1, "added_lines": "1399", "deleted_lines": "1351,1352,1353,1366,1401,1402,1403,1405,1406,1407,1411,1412", "method_info": {"method_name": "ray::raylet::NodeManager::AssignTask", "method_params": "task", "method_startline": "1309", "method_endline": "1417"}}, "hunk_10": {"Ismethod": 1, "added_lines": "138,139,140,141,142", "deleted_lines": "138,139,140", "method_info": {"method_name": "ray::raylet::NodeManager::RegisterGcs", "method_params": "", "method_startline": "98", "method_endline": "190"}}, "hunk_11": {"Ismethod": 1, "added_lines": "1116,1117,1118,1119,1120,1121,1125,1126,1127,1128,1129,1130,1145", "deleted_lines": "1094,1109", "method_info": {"method_name": "ray::raylet::NodeManager::SubmitTask", "method_params": "task,uncommitted_lineage,forwarded", "method_startline": "1094", "method_endline": "1176"}}, "hunk_12": {"Ismethod": 1, "added_lines": "1535,1536,1537,1538,1539,1540,1541,1542,1543,1544,1545,1546,1547,1548,1549,1550", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::NodeManager::ResubmitTask", "method_params": "task", "method_startline": "1533", "method_endline": "1573"}}, "hunk_13": {"Ismethod": 1, "added_lines": "1284", "deleted_lines": "1248", "method_info": {"method_name": "ray::raylet::NodeManager::HandleTaskUnblocked", "method_params": "client,current_task_id", "method_startline": "1226", "method_endline": "1286"}}, "hunk_14": {"Ismethod": 1, "added_lines": "760,780,781,782", "deleted_lines": "719,721,724,744,745,746,747,748,749,750,751,752", "method_info": {"method_name": "ray::raylet::NodeManager::ProcessDisconnectClientMessage", "method_params": "client,push_warning", "method_startline": "716", "method_endline": "819"}}, "hunk_15": {"Ismethod": 1, "added_lines": "470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,502,503,504,505,508,509", "deleted_lines": "458,459,460,462,463,464,465,466,469,470,471,472,473,474,475,476,477,478,479,480,481,482,508,509", "method_info": {"method_name": "ray::raylet::NodeManager::HandleActorCreation", "method_params": "actor_id,data", "method_startline": "458", "method_endline": "509"}}, "hunk_16": {"Ismethod": 1, "added_lines": "1449,1450,1451,1452,1453", "deleted_lines": "1450,1451", "method_info": {"method_name": "ray::raylet::NodeManager::HandleTaskReconstruction", "method_params": "task_id", "method_startline": "1449", "method_endline": "1473"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\node_manager.h", "file_new_name": "src\\ray\\raylet\\node_manager.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "148,149,150,151,152,153,154,158,264,265,266,269,271,273,275,276,278", "deleted_lines": "148,149,150,151,155,261,264,266,267,269,270,272,274"}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\task_dependency_manager.cc", "file_new_name": "src\\ray\\raylet\\task_dependency_manager.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "173,176,177,178,211,212", "deleted_lines": "173,176", "method_info": {"method_name": "ray::raylet::TaskDependencyManager::UnsubscribeDependencies", "method_params": "task_id", "method_startline": "173", "method_endline": "213"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\task_dependency_manager.h", "file_new_name": "src\\ray\\raylet\\task_dependency_manager.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "64,65", "deleted_lines": "64"}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "test\\actor_test.py", "file_new_name": "test\\actor_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1263,1264,1265,1266,1267,1268,1269,1270,1297,1298,1300,1301", "deleted_lines": "1263,1290,1291,1292,1293", "method_info": {"method_name": "test_exception_raised_when_actor_node_dies", "method_params": "shutdown_only", "method_startline": "1262", "method_endline": "1310"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "test\\component_failures_test.py", "file_new_name": "test\\component_failures_test.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "266,267,268,269,270", "deleted_lines": "265", "method_info": {"method_name": "_test_component_failed", "method_params": "component_type", "method_startline": "257", "method_endline": "307"}}}}}}}