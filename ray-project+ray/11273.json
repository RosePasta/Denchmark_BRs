{"BR": {"BR_id": "11273", "BR_author": "mattearllongshot", "BRopenT": "2020-10-08T11:05:21Z", "BRcloseT": "2020-10-16T00:21:12Z", "BR_text": {"BRsummary": "[autoscaler] 120s timeout in uptime command causes delays when booting", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Ray version: 1.0.0\n Python version: 3.8.1\n OS: Ubuntu 18.04\n Hi all, I noticed a delay on some nodes when booting a cluster.  Specifically, the delay comes between system boot (as reported by psutil) and setup commands executing.  The issue appears to be fixed by changing the timeout parameter when running the uptime command:\n <denchmark-code>diff --git a/python/ray/autoscaler/updater.py b/python/ray/autoscaler/updater.py\n index 8040dbcbd..ccb0d1931 100644\n --- a/python/ray/autoscaler/updater.py\n +++ b/python/ray/autoscaler/updater.py\n @@ -231,7 +231,7 @@ class NodeUpdater:\n                                               self.log_prefix)\n  \n                          # Run outside of the container\n -                        self.cmd_runner.run(\"uptime\", run_env=\"host\")\n +                        self.cmd_runner.run(\"uptime\", timeout=5, run_env=\"host\")\n                          cli_logger.old_debug(logger, \"Uptime succeeded.\")\n                          cli_logger.success(\"Success.\")\n                          return True\n </denchmark-code>\n \n Here's a histogram of the time to setup commands for 64 workers, both with and without the above change:\n <denchmark-link:https://user-images.githubusercontent.com/37295291/95451260-725a5d80-095f-11eb-8ef3-7dd83bd2dcbc.png></denchmark-link>\n \n As you can see, setting timeout=5 gets rid of the second mode around 60s.  I notice that historically the timeout used to be 5s but was reverted as part of this PR, but it's not clear why?  <denchmark-link:https://github.com/ray-project/ray/pull/9322/files#diff-2691ece495b9e3385c14189d8a32b54eL113>https://github.com/ray-project/ray/pull/9322/files#diff-2691ece495b9e3385c14189d8a32b54eL113</denchmark-link>\n \n <denchmark-h:h3>Reproduction</denchmark-h>\n \n Boot a cluster with 64 c5.12xlarge instances, measure the time between the setup commands executing, and that reported by psutil.boot_time().\n If we cannot run your script, we cannot fix your issue.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "mattearllongshot", "commentT": "2020-10-08T18:15:50Z", "comment_text": "\n \t\tcc <denchmark-link:https://github.com/wuisawesome>@wuisawesome</denchmark-link>\n  <denchmark-link:https://github.com/ijrsvt>@ijrsvt</denchmark-link>\n \n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "mattearllongshot", "commentT": "2020-10-08T18:30:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/richardliaw>@richardliaw</denchmark-link>\n   Any reason for this change in <denchmark-link:https://github.com/ray-project/ray/pull/9322>#9322</denchmark-link>\n ?\n <denchmark-link:https://github.com/mattearllongshot>@mattearllongshot</denchmark-link>\n  What does your cluster config look like?\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "mattearllongshot", "commentT": "2020-10-09T03:12:38Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/ijrsvt>@ijrsvt</denchmark-link>\n  probably accidental, we should revert.\n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "mattearllongshot", "commentT": "2020-10-09T04:11:01Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/mattearllongshot>@mattearllongshot</denchmark-link>\n  would you like to contribute the fix =)\n Thanks again for finding this!!\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "mattearllongshot", "commentT": "2020-10-09T07:53:58Z", "comment_text": "\n \t\tI've raised the PR <denchmark-link:https://github.com/ray-project/ray/pull/11300>#11300</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "049985549bf5b2eb8728c0e700ebcca2a4c62009", "commit_author": "mattearllongshot", "commitT": "2020-10-15 17:21:11-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\autoscaler\\_private\\updater.py", "file_new_name": "python\\ray\\autoscaler\\_private\\updater.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "249,250", "deleted_lines": "249", "method_info": {"method_name": "wait_ready", "method_params": "self,deadline", "method_startline": "232", "method_endline": "283"}}}}}}}