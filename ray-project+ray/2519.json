{"BR": {"BR_id": "2519", "BR_author": "robertnishihara", "BRopenT": "2018-07-30T20:41:45Z", "BRcloseT": "2018-08-01T07:23:03Z", "BR_text": {"BRsummary": "Lineage cache bug: uncommitted_ready_children_.count(task_id) == 0.", "BRdescription": "\n The bug occurs when using x-ray (e.g., starting Python with RAY_USE_XRAY=1 ipython) and running the following.\n import ray\n \n @ray.remote\n class Actor(object):\n     def __init__(self):\n         pass\n     def step(self):\n         return\n \n @ray.remote\n def foo(x):\n     return\n \n if __name__ == '__main__':\n     ray.worker._init(use_raylet=True, num_local_schedulers=2, start_ray_local=True, redirect_output=False)\n \n     actors = [Actor.remote() for _ in range(10)]\n     for _ in range(10):\n         for _ in range(100):\n             for actor in actors:\n                 foo.remote(actor.step.remote())\n This fails with\n <denchmark-code>/home/ubuntu/ray/src/ray/raylet/lineage_cache.cc:380 Check failed: uncommitted_ready_children_.count(task_id) == 0\n </denchmark-code>\n \n The check is too strong. Basically, when evicting a remote task from the lineage cache, it may still have \"uncommitted ready\" children (if those children have additional parents), so when we evict a task, we should see if that enables us to begin flushing any of its children.\n cc <denchmark-link:https://github.com/ujvl>@ujvl</denchmark-link>\n  <denchmark-link:https://github.com/ericl>@ericl</denchmark-link>\n  <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n \n \t"}, "comments": {}}, "commit": {"commit_id": "e90ecef2970f6f4bb71ef41376f879fa5eef0bb5", "commit_author": "Stephanie Wang", "commitT": "2018-08-01 00:23:02-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 19, "file_old_name": "src\\ray\\raylet\\lineage_cache.cc", "file_new_name": "src\\ray\\raylet\\lineage_cache.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "92", "deleted_lines": "92", "method_info": {"method_name": "ray::raylet::Lineage::PopEntry", "method_params": "task_id", "method_startline": "92", "method_endline": "101"}}, "hunk_1": {"Ismethod": 1, "added_lines": "400,401,402", "deleted_lines": "411,412,413,414", "method_info": {"method_name": "ray::raylet::LineageCache::EvictRemoteLineage", "method_params": "task_id", "method_startline": "400", "method_endline": "414"}}, "hunk_2": {"Ismethod": 1, "added_lines": "64", "deleted_lines": "64", "method_info": {"method_name": "ray::raylet::Lineage::GetEntryMutable", "method_params": "task_id", "method_startline": "64", "method_endline": "71"}}, "hunk_3": {"Ismethod": 1, "added_lines": "55", "deleted_lines": "55", "method_info": {"method_name": "ray::raylet::Lineage::GetEntry", "method_params": "task_id", "method_startline": "55", "method_endline": "62"}}, "hunk_4": {"Ismethod": 1, "added_lines": "354", "deleted_lines": "354", "method_info": {"method_name": "ray::raylet::LineageCache::UnsubscribeTask", "method_params": "task_id", "method_startline": "354", "method_endline": "366"}}, "hunk_5": {"Ismethod": 1, "added_lines": "416,418", "deleted_lines": "416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433", "method_info": {"method_name": "ray::raylet::LineageCache::HandleEntryCommitted", "method_params": "task_id", "method_startline": "416", "method_endline": "437"}}, "hunk_6": {"Ismethod": 1, "added_lines": "64", "deleted_lines": "64", "method_info": {"method_name": "ray::raylet::Lineage::GetEntryMutable", "method_params": "task_id", "method_startline": "64", "method_endline": "71"}}, "hunk_7": {"Ismethod": 1, "added_lines": "341", "deleted_lines": "341", "method_info": {"method_name": "ray::raylet::LineageCache::SubscribeTask", "method_params": "task_id", "method_startline": "341", "method_endline": "352"}}, "hunk_8": {"Ismethod": 1, "added_lines": "368,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388", "deleted_lines": "368,369,378,379,380,381,382,383", "method_info": {"method_name": "ray::raylet::LineageCache::EvictRemoteLineage", "method_params": "task_id", "method_startline": "368", "method_endline": "388"}}, "hunk_9": {"Ismethod": 1, "added_lines": "92", "deleted_lines": "92", "method_info": {"method_name": "ray::raylet::Lineage::PopEntry", "method_params": "task_id", "method_startline": "92", "method_endline": "101"}}, "hunk_10": {"Ismethod": 1, "added_lines": "341", "deleted_lines": "341", "method_info": {"method_name": "ray::raylet::LineageCache::SubscribeTask", "method_params": "task_id", "method_startline": "341", "method_endline": "352"}}, "hunk_11": {"Ismethod": 1, "added_lines": "140", "deleted_lines": "140", "method_info": {"method_name": "ray::raylet::MergeLineageHelper", "method_params": "task_id,lineage_from,lineage_to,stopping_condition", "method_startline": "140", "method_endline": "165"}}, "hunk_12": {"Ismethod": 1, "added_lines": "390,391,392,393,394,395,396,397,398,399,400,401,402,416,418", "deleted_lines": "390,392,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433", "method_info": {"method_name": "ray::raylet::LineageCache::HandleEntryCommitted", "method_params": "task_id", "method_startline": "390", "method_endline": "434"}}, "hunk_13": {"Ismethod": 1, "added_lines": "30,31", "deleted_lines": "30,31", "method_info": {"method_name": "ray::raylet::LineageEntry::GetParentTaskIds", "method_params": "", "method_startline": "30", "method_endline": "38"}}, "hunk_14": {"Ismethod": 1, "added_lines": "55", "deleted_lines": "55", "method_info": {"method_name": "ray::raylet::Lineage::GetEntry", "method_params": "task_id", "method_startline": "55", "method_endline": "62"}}, "hunk_15": {"Ismethod": 1, "added_lines": "103", "deleted_lines": "103", "method_info": {"method_name": "ray::raylet::Lineage::GetEntries", "method_params": "", "method_startline": "103", "method_endline": "105"}}, "hunk_16": {"Ismethod": 1, "added_lines": "354", "deleted_lines": "354", "method_info": {"method_name": "ray::raylet::LineageCache::UnsubscribeTask", "method_params": "task_id", "method_startline": "354", "method_endline": "366"}}, "hunk_17": {"Ismethod": 1, "added_lines": "368,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398", "deleted_lines": "368,369,378,379,380,381,382,383,390,392", "method_info": {"method_name": "ray::raylet::LineageCache::EvictTask", "method_params": "task_id", "method_startline": "368", "method_endline": "398"}}, "hunk_18": {"Ismethod": 1, "added_lines": "140", "deleted_lines": "140", "method_info": {"method_name": "ray::raylet::MergeLineageHelper", "method_params": "task_id,lineage_from,lineage_to,stopping_condition", "method_startline": "140", "method_endline": "165"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "src\\ray\\raylet\\lineage_cache.h", "file_new_name": "src\\ray\\raylet\\lineage_cache.h", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "116,214,215,216,217,218,219,222,225,228,230", "deleted_lines": "116,216,219,222,224"}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "src\\ray\\raylet\\lineage_cache_test.cc", "file_new_name": "src\\ray\\raylet\\lineage_cache_test.cc", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498", "deleted_lines": null, "method_info": {"method_name": "ray::raylet::TEST_F", "method_params": "LineageCacheTest,TestEvictionUncommittedChildren", "method_startline": "453", "method_endline": "498"}}}}}}}