{"BR": {"BR_id": "10372", "BR_author": "ebilgin", "BRopenT": "2020-08-27T19:51:28Z", "BRcloseT": "2020-09-22T06:03:07Z", "BR_text": {"BRsummary": "KeyError: 'action_logp' while consuming offline data [rllib]", "BRdescription": "\n I am trying to consume offline data using the example <denchmark-link:https://github.com/ray-project/ray/blob/master/rllib/examples/saving_experiences.py>here</denchmark-link>\n . I have the following code:\n <denchmark-code>from ray.tune.logger import pretty_print\n from ray.rllib.agents.dqn.dqn import DEFAULT_CONFIG\n from ray.rllib.agents.dqn.dqn import DQNTrainer\n import numpy as np\n \n config = DEFAULT_CONFIG.copy()\n config[\"env\"] = \"CartPole-v0\"\n config[\"input\"] = {\"demo-out\": 0.3, \"sampler\": 0.7}\n config[\"explore\"] = False\n trainer = DQNTrainer(config=config)\n best_eps_length_avg = np.PINF\n while True:\n     results = trainer.train()\n     print(pretty_print(results))\n </denchmark-code>\n \n I am getting the following error:\n <denchmark-code>Traceback (most recent call last):\n   File \"/home/enes/ws/code/arl/mt/test/consume_experiences.py\", line 16, in <module>\n     results = trainer.train()\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 522, in train\n     raise e\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/agents/trainer.py\", line 508, in train\n     result = Trainable.train(self)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/tune/trainable.py\", line 332, in train\n     result = self.step()\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py\", line 110, in step\n     res = next(self.train_exec_impl)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 758, in __next__\n     return next(self.built_iterator)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 785, in apply_foreach\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 845, in apply_filter\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 845, in apply_filter\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 785, in apply_foreach\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 845, in apply_filter\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 1078, in build_union\n     item = next(it)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 758, in __next__\n     return next(self.built_iterator)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 785, in apply_foreach\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 785, in apply_foreach\n     for item in it:\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/util/iter.py\", line 785, in apply_foreach\n     for item in it:\n   [Previous line repeated 2 more times]\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/execution/replay_ops.py\", line 89, in gen_replay\n     item = local_buffer.replay()\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/execution/replay_buffer.py\", line 331, in replay\n     beta=self.prioritized_replay_beta)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/execution/replay_buffer.py\", line 173, in sample\n     batch = self._encode_sample(idxes)\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/execution/replay_buffer.py\", line 64, in _encode_sample\n     out = SampleBatch.concat_samples([self._storage[i] for i in idxes])\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/policy/sample_batch.py\", line 93, in concat_samples\n     out[k] = concat_aligned([s[k] for s in samples])\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/policy/sample_batch.py\", line 93, in <listcomp>\n     out[k] = concat_aligned([s[k] for s in samples])\n   File \"/home/enes/ws/envs/rlws/lib/python3.7/site-packages/ray/rllib/policy/sample_batch.py\", line 294, in __getitem__\n     return self.data[key]\n KeyError: 'action_logp'\n </denchmark-code>\n \n I am using ray 0.8.7 on Ubuntu 18.04 LTS. Tensorflow 2.3.0.\n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "ebilgin", "commentT": "2020-08-29T05:35:13Z", "comment_text": "\n \t\tIt seems like somehow we're trying to read that key, though action_prob should be enough. As a workaround, you can try also writing action_logp (calling add_values(action_logp=np.log(action_prob))).\n \t\t"}}}, "commit": {"commit_id": "daa03ba6e69b1ff3a2965dda12fc4904f21137af", "commit_author": "Eric Liang", "commitT": "2020-09-21 23:03:06-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\examples\\saving_experiences.py", "file_new_name": "rllib\\examples\\saving_experiences.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "45", "deleted_lines": null}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\execution\\__init__.py", "file_new_name": "rllib\\execution\\__init__.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38", "deleted_lines": null}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\execution\\concurrency_ops.py", "file_new_name": "rllib\\execution\\concurrency_ops.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "16,17,18,19,21,22,24,25,26,30", "deleted_lines": "16,17,18,19,20,22,23,25,26,27"}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\execution\\rollout_ops.py", "file_new_name": "rllib\\execution\\rollout_ops.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "30,31,32,33,34,35,36", "deleted_lines": "30,31,32,33,34,35,36,37"}}}}}}