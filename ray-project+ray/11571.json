{"BR": {"BR_id": "11571", "BR_author": "andrewredd", "BRopenT": "2020-10-23T14:01:25Z", "BRcloseT": "2020-10-24T00:47:10Z", "BR_text": {"BRsummary": "[tune] Pytorch Lightning MIST Example Not Working Due to Validation End MisMatch", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Python 3.6.5\n Pytorch-lightning 1.0.2\n torch 1.6\n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n I ran <denchmark-link:https://github.com/ray-project/ray/blob/master/python/ray/tune/examples/mnist_pytorch_lightning.py>https://github.com/ray-project/ray/blob/master/python/ray/tune/examples/mnist_pytorch_lightning.py</denchmark-link>\n  in the environment above.\n I get the error\n <denchmark-code>Traceback (most recent call last):\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/trial_runner.py\", line 515, in _process_trial\n     result = self.trial_executor.fetch_result(trial)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/ray_trial_executor.py\", line 488, in fetch_result\n     result = ray.get(trial_future[0], timeout=DEFAULT_GET_TIMEOUT)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/worker.py\", line 1428, in get\n     raise value.as_instanceof_cause()\n ray.exceptions.RayTaskError(TuneError): ray::ImplicitFunc.train() (pid=1961, ip=10.235.18.172)\n   File \"python/ray/_raylet.pyx\", line 484, in ray._raylet.execute_task\n   File \"python/ray/_raylet.pyx\", line 438, in ray._raylet.execute_task.function_executor\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/trainable.py\", line 336, in train\n     result = self.step()\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/function_runner.py\", line 340, in step\n     self._report_thread_runner_error(block=True)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/function_runner.py\", line 459, in _report_thread_runner_error\n     .format(err_tb_str)))\n ray.tune.error.TuneError: Trial raised an exception. Traceback:\n ray::ImplicitFunc.train() (pid=1961, ip=10.235.18.172)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/function_runner.py\", line 227, in run\n     self._entrypoint()\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/function_runner.py\", line 290, in entrypoint\n     self._status_reporter.get_checkpoint())\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/function_runner.py\", line 497, in _trainable_func\n     output = train_func(config)\n   File \"ray_tune_example/ray_mnist_example.py\", line 148, in train_mnist_tune\n     trainer.fit(model)\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 440, in fit\n     results = self.accelerator_backend.train()\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/accelerators/cpu_accelerator.py\", line 48, in train\n     results = self.train_or_test()\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/accelerators/accelerator.py\", line 66, in train_or_test\n     results = self.trainer.train()\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 462, in train\n     self.run_sanity_check(self.get_model())\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 648, in run_sanity_check\n     _, eval_results = self.run_evaluation(test_mode=False, max_batches=self.num_sanity_val_batches)\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 572, in run_evaluation\n     self.evaluation_loop.on_evaluation_batch_end(output, batch, batch_idx, dataloader_idx)\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/evaluation_loop.py\", line 310, in on_evaluation_batch_end\n     self.trainer.call_hook('on_validation_batch_end', *args, **kwargs)\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/trainer.py\", line 823, in call_hook\n     trainer_hook(*args, **kwargs)\n   File \"/opt/conda/lib/python3.7/site-packages/pytorch_lightning/trainer/callback_hook.py\", line 157, in on_validation_batch_end\n     callback.on_validation_batch_end(self, self.get_model(), outputs, batch, batch_idx, dataloader_idx)\n TypeError: on_validation_batch_end() takes 6 positional arguments but 7 were given\n </denchmark-code>\n \n Is this something related to the versions of the package? I couldn't find anything related to under what versions this code works.\n Thanks!\n \n [ X] I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "andrewredd", "commentT": "2020-10-23T15:43:58Z", "comment_text": "\n \t\tHi <denchmark-link:https://github.com/andrewredd>@andrewredd</denchmark-link>\n , this should be fixed in the latest Ray wheels. Can you upgrade to the latest Ray wheels (<denchmark-link:https://docs.ray.io/en/master/installation.html#latest-snapshots-nightlies>https://docs.ray.io/en/master/installation.html#latest-snapshots-nightlies</denchmark-link>\n ) and try again?\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "andrewredd", "commentT": "2020-10-23T16:00:54Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/amogkam>@amogkam</denchmark-link>\n  That got past the previous error but on one of the iterations I got the following\n <denchmark-code>  File \"/opt/conda/lib/python3.7/site-packages/ray/tune/trial_runner.py\", line 755, in _process_trial\n     self, trial, flat_result)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/schedulers/pbt.py\", line 391, in on_trial_result\n     lower_quantile)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/schedulers/pbt.py\", line 460, in _perturb_trial\n     self._exploit(trial_runner.trial_executor, trial, trial_to_clone)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/schedulers/pbt.py\", line 509, in _exploit\n     self._custom_explore_fn)\n   File \"/opt/conda/lib/python3.7/site-packages/ray/tune/schedulers/pbt.py\", line 75, in explore\n     distribution, Domain) else distribution()\n   File \"ray_tune_example/ray_mnist_example.py\", line 251, in <lambda>\n     \"lr\": lambda: tune.loguniform(1e-4, 1e-1).func(None),\n AttributeError: 'Float' object has no attribute 'func'\n </denchmark-code>\n \n This is the same environment as above and ran for a period of time before having issues. (i.e. it was on the second iteration of population based tuning)\n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "andrewredd", "commentT": "2020-10-23T16:12:35Z", "comment_text": "\n \t\tOh that's a good catch. Can you try replacing lambda: tune.loguniform(1e-4, 1e-1).func(None) with just tune.loguniform(1e-4, 1e-1).\n cc <denchmark-link:https://github.com/krfricke>@krfricke</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "andrewredd", "commentT": "2020-10-23T17:28:04Z", "comment_text": "\n \t\tAh, we didn't catch this because the hyperparameter mutations are only evaluated after permutations. I pushed a PR to fix this. Let me know if there's still issues, and thanks for catching the bug, <denchmark-link:https://github.com/andrewredd>@andrewredd</denchmark-link>\n !\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "andrewredd", "commentT": "2020-10-23T19:48:31Z", "comment_text": "\n \t\t(keeping this open until <denchmark-link:https://github.com/andrewredd>@andrewredd</denchmark-link>\n  is good to go)\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "andrewredd", "commentT": "2020-10-24T00:36:08Z", "comment_text": "\n \t\tI\u2019m good to go! Thanks all\n <denchmark-link:#>\u2026</denchmark-link>\n \n \n On Fri, Oct 23, 2020 at 3:48 PM Richard Liaw ***@***.***> wrote:\n  Reopened #11571 <#11571>.\n \n  \u2014\n  You are receiving this because you were mentioned.\n  Reply to this email directly, view it on GitHub\n  <#11571 (comment)>, or\n  unsubscribe\n  <https://github.com/notifications/unsubscribe-auth/ALQO4BXLSGKDH6KFBWYGIU3SMHMZ5ANCNFSM4S4TFVYQ>\n  .\n \n \n \n \t\t"}, "comments_6": {"comment_id": 7, "comment_author": "andrewredd", "commentT": "2020-10-24T00:47:10Z", "comment_text": "\n \t\tAwesome!\n \t\t"}}}, "commit": {"commit_id": "8ee4f7eca36100f4c7847c33025aa4fd062493b7", "commit_author": "Kai Fricke", "commitT": "2020-10-23 12:42:13-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "python\\ray\\tune\\examples\\mnist_pytorch_lightning.py", "file_new_name": "python\\ray\\tune\\examples\\mnist_pytorch_lightning.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "251", "deleted_lines": "251", "method_info": {"method_name": "tune_mnist_pbt", "method_params": "num_samples,num_epochs,gpus_per_trial", "method_startline": "234", "method_endline": "275"}}}}}}}