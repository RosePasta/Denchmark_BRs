{"BR": {"BR_id": "3651", "BR_author": "raulchen", "BRopenT": "2018-12-27T10:39:47Z", "BRcloseT": "2019-01-11T07:18:33Z", "BR_text": {"BRsummary": "Issue when calling a remote function in a background thread", "BRdescription": "\n Currently, the following script will fail.\n import ray\n import time\n \n from threading import Thread\n \n @ray.remote\n def foo():\n     return 1\n \n @ray.remote\n class A(object):\n \n     def spawn_thread(self):\n         def f():\n             time.sleep(1)\n             ray.get(foo.remote())\n         Thread(target=f).start()\n \n     def is_alive(self):\n         return True\n \n \n ray.init()\n a = A.remote()\n a.spawn_thread.remote()\n time.sleep(2)\n print(ray.get(a.is_alive.remote()))\n Because, if we call a remote function in a background and the main thread isn't in the middle of a task. This <denchmark-link:https://github.com/ray-project/ray/blob/ac792d70c85d134855485699e5c6f0ee3a10badc/python/ray/worker.py#L620>assert</denchmark-link>\n  will fail. And then when the main thread receives the next task, this <denchmark-link:https://github.com/ray-project/ray/blob/ac792d70c85d134855485699e5c6f0ee3a10badc/python/ray/worker.py#L770>assert</denchmark-link>\n  will fail as well.\n Another multithreading issues:\n \n #3648\n Task id generation is not deterministic because multiple threads may increments task_index in a interleaving manner.\n \n Here's how I think we can improve multithreading support:\n \n Make current_task_id, task_index, and put_index thread local.\n For main thread, current_task_id is the real task id, which gets set/reset before/after each task. For background threads, current_task_id is a fake random id that will be generated when it's used for the first time, and it will never change again.\n task_index and put_index still increments monotonically each time when submit_task and put is called (so task id generation is still deterministic for the main thread).\n state_lock isn't needed anymore (could improve efficiency).\n task_driver_id is still shared among threads. But we don't reset it to NIL for actors (see https://github.com/ray-project/ray/pull/3648/files#r244123522)\n \n I'll work on the fix in a few days.\n cc <denchmark-link:https://github.com/stephanie-wang>@stephanie-wang</denchmark-link>\n  <denchmark-link:https://github.com/robertnishihara>@robertnishihara</denchmark-link>\n  <denchmark-link:https://github.com/guoyuhong>@guoyuhong</denchmark-link>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "raulchen", "commentT": "2018-12-27T20:12:12Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/raulchen>@raulchen</denchmark-link>\n  that proposal makes sense.\n Ultimately, most of this logic should be implemented in the RayletClient C++ class which should be modified to be thread safe. Then we won't have to think about thread safety (as much) in the Python part.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "raulchen", "commentT": "2019-01-11T07:18:33Z", "comment_text": "\n \t\tFixed by <denchmark-link:https://github.com/ray-project/ray/pull/3672>#3672</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "597abb24eaeeed7c9fd9a6142e975f64225f995b", "commit_author": "Hao Chen", "commitT": "2019-01-10 13:58:11-08:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 6, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\AbstractRayRuntime.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\AbstractRayRuntime.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "280,281,306,308,310", "deleted_lines": "280,281,282,307,309,311", "method_info": {"method_name": "AbstractRayRuntime::createTaskSpec", "method_params": "func,actor,args,isActorCreationTask,taskOptions", "method_startline": "278", "method_endline": "322"}}, "hunk_1": {"Ismethod": 1, "added_lines": "119,146,173,174,185,191", "deleted_lines": "111,120,147,174,185,191", "method_info": {"method_name": "AbstractRayRuntime::get", "method_params": "objectIds", "method_startline": "109", "method_endline": "194"}}, "hunk_2": {"Ismethod": 1, "added_lines": "95,96", "deleted_lines": "95,96", "method_info": {"method_name": "AbstractRayRuntime::putSerialized", "method_params": "obj", "method_startline": "93", "method_endline": "100"}}, "hunk_3": {"Ismethod": 1, "added_lines": "74", "deleted_lines": "74", "method_info": {"method_name": "AbstractRayRuntime::start", "method_params": "", "method_startline": "66", "method_endline": "78"}}, "hunk_4": {"Ismethod": 1, "added_lines": "220", "deleted_lines": "220", "method_info": {"method_name": "AbstractRayRuntime::wait", "method_params": "waitList,numReturns,timeoutMs", "method_startline": "218", "method_endline": "221"}}, "hunk_5": {"Ismethod": 1, "added_lines": "81", "deleted_lines": "81", "method_info": {"method_name": "AbstractRayRuntime::put", "method_params": "objectId,obj", "method_startline": "80", "method_endline": "84"}}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 2, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\RayNativeRuntime.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\RayNativeRuntime.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "83", "deleted_lines": "83", "method_info": {"method_name": "RayNativeRuntime::start", "method_params": "", "method_startline": "60", "method_endline": "91"}}, "hunk_1": {"Ismethod": 1, "added_lines": "42", "deleted_lines": "42", "method_info": {"method_name": "RayNativeRuntime::resetLibaryPath", "method_params": "", "method_startline": "34", "method_endline": "57"}}}}, "file_2": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\Worker.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\Worker.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "46,69", "deleted_lines": "46,47", "method_info": {"method_name": "Worker::execute", "method_params": "spec", "method_startline": "36", "method_endline": "72"}}}}, "file_3": {"file_change_type": "MODIFY", "file_Nmethod": 14, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\WorkerContext.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\WorkerContext.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "87,88", "deleted_lines": "87,88", "method_info": {"method_name": "WorkerContext::nextPutIndex", "method_params": "", "method_startline": "86", "method_endline": "89"}}, "hunk_1": {"Ismethod": 1, "added_lines": "114,115", "deleted_lines": "113,114", "method_info": {"method_name": "WorkerContext::setCurrentClassLoader", "method_params": "currentClassLoader", "method_startline": "113", "method_endline": "115"}}, "hunk_2": {"Ismethod": 1, "added_lines": "94,95,96", "deleted_lines": "95,96", "method_info": {"method_name": "WorkerContext::nextTaskIndex", "method_params": "", "method_startline": "94", "method_endline": "97"}}, "hunk_3": {"Ismethod": 1, "added_lines": "87,88", "deleted_lines": "87,88", "method_info": {"method_name": "WorkerContext::getCurrentTask", "method_params": "", "method_startline": "87", "method_endline": "89"}}, "hunk_4": {"Ismethod": 1, "added_lines": "66,67,68,69,70,71,72,73,74,75,76,77,78,79,80", "deleted_lines": "66,67,68,70,71,72,73,74,75,76,78,79,80", "method_info": {"method_name": "WorkerContext::setCurrentTask", "method_params": "task,classLoader", "method_startline": "66", "method_endline": "81"}}, "hunk_5": {"Ismethod": 1, "added_lines": "83,84,85", "deleted_lines": "83,84", "method_info": {"method_name": "WorkerContext::setWorkerId", "method_params": "workerId", "method_startline": "83", "method_endline": "85"}}, "hunk_6": {"Ismethod": 1, "added_lines": "110,111", "deleted_lines": "110", "method_info": {"method_name": "WorkerContext::getCurrentDriverId", "method_params": "", "method_startline": "110", "method_endline": "112"}}, "hunk_7": {"Ismethod": 1, "added_lines": "117,118", "deleted_lines": "117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132", "method_info": {"method_name": "WorkerContext::createDummyTask", "method_params": "workerMode,driverId", "method_startline": "117", "method_endline": "132"}}, "hunk_8": {"Ismethod": 1, "added_lines": "95,96", "deleted_lines": "95,96", "method_info": {"method_name": "WorkerContext::nextCallIndex", "method_params": "", "method_startline": "95", "method_endline": "97"}}, "hunk_9": {"Ismethod": 1, "added_lines": "117,118", "deleted_lines": "117,118,119", "method_info": {"method_name": "WorkerContext::getCurrentClassLoader", "method_params": "", "method_startline": "117", "method_endline": "119"}}, "hunk_10": {"Ismethod": 1, "added_lines": "40,41,42,43,44,45,46,47,49,50", "deleted_lines": "38,39,45,46,47,48,51,52", "method_info": {"method_name": "WorkerContext::WorkerContext", "method_params": "workerMode,driverId", "method_startline": "38", "method_endline": "52"}}, "hunk_11": {"Ismethod": 1, "added_lines": "65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80", "deleted_lines": "65,66,67,68,70,71,72,73,74,75,76,78,79,80", "method_info": {"method_name": "WorkerContext::getCurrentThreadTaskId", "method_params": "", "method_startline": "65", "method_endline": "81"}}, "hunk_12": {"Ismethod": 1, "added_lines": "58,59", "deleted_lines": "58,59,60", "method_info": {"method_name": "WorkerContext::getCurrentTaskId", "method_params": "", "method_startline": "58", "method_endline": "60"}}, "hunk_13": {"Ismethod": 1, "added_lines": "107,108,109,110,111", "deleted_lines": "107,108,109,110", "method_info": {"method_name": "WorkerContext::setCurrentTask", "method_params": "currentTask", "method_startline": "107", "method_endline": "111"}}}}, "file_4": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\objectstore\\MockObjectStore.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\objectstore\\MockObjectStore.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "98", "deleted_lines": "98", "method_info": {"method_name": "MockObjectStore::logPrefix", "method_params": "", "method_startline": "97", "method_endline": "99"}}}}, "file_5": {"file_change_type": "MODIFY", "file_Nmethod": 1, "file_old_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\raylet\\RayletClientImpl.java", "file_new_name": "java\\runtime\\src\\main\\java\\org\\ray\\runtime\\raylet\\RayletClientImpl.java", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "82,83,84", "deleted_lines": null, "method_info": {"method_name": "RayletClientImpl::submitTask", "method_params": "spec", "method_startline": "80", "method_endline": "92"}}}}, "file_6": {"file_change_type": "MODIFY", "file_Nmethod": 3, "file_old_name": "python\\ray\\actor.py", "file_new_name": "python\\ray\\actor.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "534", "deleted_lines": "533,534", "method_info": {"method_name": "_actor_method_call", "method_params": "self,method_name,args,kwargs,num_return_vals,dependency", "method_startline": "529", "method_endline": "534"}}, "hunk_1": {"Ismethod": 1, "added_lines": "229", "deleted_lines": "228,229", "method_info": {"method_name": "_remote", "method_params": "self,args,kwargs,num_return_vals", "method_startline": "221", "method_endline": "229"}}, "hunk_2": {"Ismethod": 1, "added_lines": "534", "deleted_lines": "533,534", "method_info": {"method_name": "_actor_method_call", "method_params": "self,method_name,args,kwargs,num_return_vals", "method_startline": "530", "method_endline": "534"}}}}, "file_7": {"file_change_type": "MODIFY", "file_Nmethod": 9, "file_old_name": "python\\ray\\worker.py", "file_new_name": "python\\ray\\worker.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515", "deleted_lines": "470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511", "method_info": {"method_name": "get_object", "method_params": "self,object_ids", "method_startline": "438", "method_endline": "518"}}, "hunk_1": {"Ismethod": 1, "added_lines": "171", "deleted_lines": "148,149,150,151,152", "method_info": {"method_name": "__init__", "method_params": "self", "method_startline": "148", "method_endline": "171"}}, "hunk_2": {"Ismethod": 1, "added_lines": "2273,2274,2275,2277", "deleted_lines": "2259", "method_info": {"method_name": "put", "method_params": "value,worker", "method_startline": "2258", "method_endline": "2278"}}, "hunk_3": {"Ismethod": 1, "added_lines": "2366,2367,2368,2369,2370,2371", "deleted_lines": "2345,2346,2347,2348,2352,2353", "method_info": {"method_name": "wait", "method_params": "object_ids,num_returns,timeout,worker", "method_startline": "2281", "method_endline": "2372"}}, "hunk_4": {"Ismethod": 1, "added_lines": "945,946,947,948,949,950,951,952", "deleted_lines": "934,935,936,937,938,939,940", "method_info": {"method_name": "_wait_for_and_process_task", "method_params": "self,task", "method_startline": "895", "method_endline": "962"}}, "hunk_5": {"Ismethod": 1, "added_lines": "785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,801", "deleted_lines": "775,776,777,778,779,780,781,782,783,784,785,786,787,788,790", "method_info": {"method_name": "_process_task", "method_params": "self,task,function_execution_info", "method_startline": "775", "method_endline": "868"}}, "hunk_6": {"Ismethod": 1, "added_lines": "185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207", "deleted_lines": "185,186,187,188,189,190,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207", "method_info": {"method_name": "get_current_thread_task_id", "method_params": "self", "method_startline": "185", "method_endline": "207"}}, "hunk_7": {"Ismethod": 1, "added_lines": "213,214", "deleted_lines": null, "method_info": {"method_name": "current_task_id", "method_params": "self", "method_startline": "213", "method_endline": "214"}}, "hunk_8": {"Ismethod": 1, "added_lines": "174,175,176,177,178,179,180,181,182,183,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210", "deleted_lines": "177,178,181,182,183,184,185,186,187,188,189,190,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207", "method_info": {"method_name": "task_context", "method_params": "self", "method_startline": "174", "method_endline": "210"}}}}, "file_8": {"file_change_type": "MODIFY", "file_Nmethod": 20, "file_old_name": "test\\runtest.py", "file_new_name": "test\\runtest.py", "hunks": {"hunk_0": {"Ismethod": 1, "added_lines": "1189,1190,1191,1192,1193,1194,1196", "deleted_lines": "1189,1190,1191,1192,1195,1196", "method_info": {"method_name": "test_multithreading.test_multi_threading", "method_params": "", "method_startline": "1189", "method_endline": "1196"}}, "hunk_1": {"Ismethod": 1, "added_lines": "1306,1307", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.join", "method_params": "self", "method_startline": "1304", "method_endline": "1307"}}, "hunk_2": {"Ismethod": 1, "added_lines": "1206,1207,1208,1209,1210,1211,1212,1213,1214,1215,1216,1217,1218,1219,1220,1221,1222,1223,1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1241,1242,1243,1244,1245,1246,1247,1248,1249,1250", "deleted_lines": "1209,1212,1214,1215,1217,1223,1224,1225,1226,1227,1228,1229,1230,1231", "method_info": {"method_name": "test_multithreading.test_api_in_multi_threads", "method_params": "", "method_startline": "1206", "method_endline": "1250"}}, "hunk_3": {"Ismethod": 1, "added_lines": "1202,1203,1204", "deleted_lines": "1202,1203,1204", "method_info": {"method_name": "test_multithreading.block", "method_params": "args,n", "method_startline": "1202", "method_endline": "1204"}}, "hunk_4": {"Ismethod": 1, "added_lines": "1181,1182,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192,1193", "deleted_lines": "1181,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192", "method_info": {"method_name": "test_multithreading.run_test_in_multi_threads", "method_params": "test_case,num_threads,num_repeats", "method_startline": "1181", "method_endline": "1193"}}, "hunk_5": {"Ismethod": 1, "added_lines": "1228,1229,1230,1231", "deleted_lines": "1228,1229,1230,1231", "method_info": {"method_name": "test_multithreading.test_multithreading.test_api_in_multi_threads.test_put_and_get", "method_params": "", "method_startline": "1228", "method_endline": "1231"}}, "hunk_6": {"Ismethod": 1, "added_lines": "1203,1204", "deleted_lines": "1203,1204", "method_info": {"method_name": "test_multithreading.echo", "method_params": "self,value", "method_startline": "1203", "method_endline": "1204"}}, "hunk_7": {"Ismethod": 1, "added_lines": "1184,1185,1186,1187,1188", "deleted_lines": "1184,1185,1186,1187,1188", "method_info": {"method_name": "test_multithreading.test_multithreading.run_test_in_multi_threads.wrapper", "method_params": "", "method_startline": "1184", "method_endline": "1188"}}, "hunk_8": {"Ismethod": 1, "added_lines": "1196,1197,1198,1199", "deleted_lines": "1196,1199", "method_info": {"method_name": "test_multithreading.echo", "method_params": "value,delay_ms", "method_startline": "1196", "method_endline": "1199"}}, "hunk_9": {"Ismethod": 1, "added_lines": "1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281,1282,1283,1284,1285,1286,1287,1288,1289,1290,1291,1292,1293", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.background_thread", "method_params": "self,wait_objects", "method_startline": "1270", "method_endline": "1293"}}, "hunk_10": {"Ismethod": 1, "added_lines": "1241,1242,1243,1244,1245,1246,1247,1248", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.test_multithreading.test_api_in_multi_threads.test_wait", "method_params": "", "method_startline": "1241", "method_endline": "1248"}}, "hunk_11": {"Ismethod": 1, "added_lines": "1181,1182,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192,1193,1194,1196,1197,1198,1199,1201,1202,1203,1204,1205,1206,1207,1208,1209,1210,1211,1212,1213,1214,1215,1216,1217,1218,1219,1220,1221,1222,1223,1224,1225,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1241,1242,1243,1244,1245,1246,1247,1248,1249,1250,1252,1253,1254,1255,1257,1258,1259,1261,1263,1267,1268,1269,1270,1271,1272,1273,1274,1275,1276,1277,1278,1279,1280,1281,1282,1283,1284,1285,1286,1287,1288,1289,1290,1291,1292,1293,1296,1298,1299,1300,1306,1307,1309,1310,1311", "deleted_lines": "1180,1181,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192,1195,1196,1199,1200,1202,1203,1204,1209,1212,1214,1215,1217,1223,1224,1225,1226,1227,1228,1229,1230,1231", "method_info": {"method_name": "test_multithreading", "method_params": "shutdown_only", "method_startline": "1176", "method_endline": "1311"}}, "hunk_12": {"Ismethod": 1, "added_lines": "1267,1268", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.__init__", "method_params": "self", "method_startline": "1266", "method_endline": "1268"}}, "hunk_13": {"Ismethod": 1, "added_lines": "1296,1298,1299,1300", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.spawn", "method_params": "self", "method_startline": "1295", "method_endline": "1302"}}, "hunk_14": {"Ismethod": 1, "added_lines": "1199", "deleted_lines": "1199,1200", "method_info": {"method_name": "test_multithreading.test_multi_threading_in_worker", "method_params": "", "method_startline": "1199", "method_endline": "1200"}}, "hunk_15": {"Ismethod": 1, "added_lines": "1220,1221,1222,1223", "deleted_lines": "1223", "method_info": {"method_name": "test_multithreading.test_multithreading.test_api_in_multi_threads.test_call_actor", "method_params": "", "method_startline": "1220", "method_endline": "1223"}}, "hunk_16": {"Ismethod": 1, "added_lines": "1181", "deleted_lines": "1180,1181", "method_info": {"method_name": "test_multithreading.f", "method_params": "", "method_startline": "1180", "method_endline": "1181"}}, "hunk_17": {"Ismethod": 1, "added_lines": "1257,1258,1259", "deleted_lines": null, "method_info": {"method_name": "test_multithreading.run_tests_in_worker", "method_params": "", "method_startline": "1257", "method_endline": "1259"}}, "hunk_18": {"Ismethod": 1, "added_lines": "1183,1184,1185,1186,1187", "deleted_lines": "1183,1184,1185,1186,1187", "method_info": {"method_name": "test_multithreading.g", "method_params": "n", "method_startline": "1183", "method_endline": "1187"}}, "hunk_19": {"Ismethod": 1, "added_lines": "1210,1211,1212,1213", "deleted_lines": "1212", "method_info": {"method_name": "test_multithreading.test_multithreading.test_api_in_multi_threads.test_remote_call", "method_params": "", "method_startline": "1210", "method_endline": "1213"}}}}}}}