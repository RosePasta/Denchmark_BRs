{"BR": {"BR_id": "9218", "BR_author": "michaelzhiluo", "BRopenT": "2020-06-30T19:27:18Z", "BRcloseT": "2020-07-17T03:53:26Z", "BR_text": {"BRsummary": "[rllib] num_gpus=0 on a device with GPU uses GPU for Pytorch", "BRdescription": "\n <denchmark-h:h3>What is the problem?</denchmark-h>\n \n Ray will find a GPU and place the model (e.g. FCNet) on the GPU even when num_gpus=0.\n Stack Trace:\n <denchmark-code>../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/trainer.py:520: in train\n     raise e\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/trainer.py:506: in train\n     result = Trainable.train(self)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/tune/trainable.py:260: in train\n     result = self._train()\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py:139: in _train\n     return self._train_exec_impl()\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/trainer_template.py:177: in _train_exec_impl\n     res = next(self.train_exec_impl)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/util/iter.py:731: in __next__\n     return next(self.built_iterator)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/util/iter.py:752: in apply_foreach\n     result = fn(item)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/maml/maml.py:143: in __call__\n     fetches = self.workers.local_worker().learn_on_batch(samples)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/evaluation/rollout_worker.py:742: in learn_on_batch\n     .learn_on_batch(samples)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/policy/torch_policy.py:244: in learn_on_batch\n     self._loss(self, self.model, self.dist_class, train_batch))\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/agents/maml/maml_torch_policy.py:329: in maml_loss\n     logits, state = model.from_batch(train_batch)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/models/modelv2.py:224: in from_batch\n     return self.__call__(input_dict, states, train_batch.get(\"seq_lens\"))\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/models/modelv2.py:181: in __call__\n     res = self.forward(restored, state or [], seq_lens)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/models/torch/fcnet.py:118: in forward\n     self._features = self._hidden_layers(self._last_flat_in)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/module.py:550: in __call__\n     result = self.forward(*input, **kwargs)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/container.py:100: in forward\n     input = module(input)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/module.py:550: in __call__\n     result = self.forward(*input, **kwargs)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/ray/rllib/models/torch/misc.py:110: in forward\n     return self._model(x)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/module.py:550: in __call__\n     result = self.forward(*input, **kwargs)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/container.py:100: in forward\n     input = module(input)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/module.py:550: in __call__\n     result = self.forward(*input, **kwargs)\n ../../miniconda3/envs/ray/lib/python3.7/site-packages/torch/nn/modules/linear.py:87: in forward\n     return F.linear(input, self.weight, self.bias)\n RuntimeError: Expected object of device type cuda but got device type cpu for argument #2 'mat1' in call to _th_addmm\n </denchmark-code>\n \n <denchmark-h:h3>Reproduction (REQUIRED)</denchmark-h>\n \n Run this in ray/rlllib:\n pytest -v -s agents/maml/tests/test_maml.py on a machine with a GPU.\n \n  I have verified my script runs in a clean environment and reproduces the issue.\n  I have verified the issue also occurs with the latest wheels.\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "michaelzhiluo", "commentT": "2020-07-15T17:42:56Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/michaelzhiluo>@michaelzhiluo</denchmark-link>\n  Looking at this now ...\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "michaelzhiluo", "commentT": "2020-07-16T09:09:05Z", "comment_text": "\n \t\tPR: <denchmark-link:https://github.com/ray-project/ray/pull/9516>#9516</denchmark-link>\n \n \t\t"}}}, "commit": {"commit_id": "8204717eed71923f1e14fa6bd17ca4588c140c09", "commit_author": "Sven Mika", "commitT": "2020-07-17 05:53:25+02:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\evaluation\\rollout_worker.py", "file_new_name": "rllib\\evaluation\\rollout_worker.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "21,22,28,29,30,31,42,43,44,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425", "deleted_lines": "12,13,14,24,25,26,27,33,34,402,403,404,405,406,407,408,409,410,411,412,413"}}}, "file_1": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "rllib\\policy\\torch_policy.py", "file_new_name": "rllib\\policy\\torch_policy.py", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "7,102,103,104,105", "deleted_lines": "101,102"}}}}}}