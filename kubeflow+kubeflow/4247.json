{"BR": {"BR_id": "4247", "BR_author": "hemantha-kumara", "BRopenT": "2019-10-07T18:40:24Z", "BRcloseT": "2019-10-22T13:17:24Z", "BR_text": {"BRsummary": "Issue while merging PatchesJson6902 multiple targets with same path file in MergeKustomization", "BRdescription": "\n /kind bug\n \n Issue is extension of <denchmark-link:https://github.com/kubeflow/kubeflow/issues/4136>#4136</denchmark-link>\n \n Added overlay to update multiple ClusterRoles(eg: argo and argo-ui) using PatchesJson6902 using same target.path file\n <denchmark-code>apiVersion: kustomize.config.k8s.io/v1beta1\n kind: Kustomization\n bases:\n - ../../base\n patchesJson6902:\n - target:\n     group: rbac.authorization.k8s.io\n     version: v1beta1\n     kind: ClusterRole\n     name: argo\n   path: patch.yaml\n - target:\n     group: rbac.authorization.k8s.io\n     version: v1beta1\n     kind: ClusterRole\n     name: argo-ui\n   path: patch.yaml\n </denchmark-code>\n \n patch.yaml content is as below\n <denchmark-code>- op: add\n   path: /rules/0\n   value:\n     apiGroups:\n       - extensions\n     resourceNames:\n       - privileged\n     resources:\n       - podsecuritypolicies\n     verbs:\n       - use\n </denchmark-code>\n \n What did you expect to happen:\n After kfctl generate I was expecting two patch files argo-ClusterRole.yaml & argo-ui-ClusterRole.yaml will get created with proper patch link in new kustomization.yaml(kustomize is patching two clusterroles with content from patch.yaml) where as kfctl is ignoring 2nd clusterrole\n Anything else you would like to add:\n I could see problem in these lines - not  sure whether this was done intentionally!\n \n \n \n kubeflow/bootstrap/pkg/kfapp/kustomize/kustomize.go\n \n \n          Line 851\n       in\n       2395c5f\n \n \n \n \n \n \n  if _, ok := kustomizationMaps[patchesJson6902Map][patchJson.Path]; !ok { \n \n \n \n \n \n <denchmark-code>\t\tif _, ok := kustomizationMaps[patchesJson6902Map][patchJson.Path]; !ok {\n \t\t\tparent.PatchesJson6902 = append(parent.PatchesJson6902, *patchJson)\n \t\t\tkustomizationMaps[patchesJson6902Map][patchJson.Path] = true\n \t\t}\n </denchmark-code>\n \n Environment:\n \n Kubeflow version: build version v0.6.2\n kfctl version: kfctl v0.6.2-0-g47a0e4c7\n Kubernetes platform: k8s cluster\n Kubernetes version:\n \n <denchmark-code>Client Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.3\", GitCommit:\"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T01:44:30Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n Server Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.3\", GitCommit:\"5e53fd6bc17c0dec8434817e69b04a25d8ae0ff0\", GitTreeState:\"clean\", BuildDate:\"2019-06-06T01:36:19Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n </denchmark-code>\n \n \n OS :\n \n <denchmark-code>NAME=\"CentOS Linux\"\n VERSION=\"7 (Core)\"\n ID=\"centos\"\n ID_LIKE=\"rhel fedora\"\n VERSION_ID=\"7\"\n PRETTY_NAME=\"CentOS Linux 7 (Core)\"\n ANSI_COLOR=\"0;31\"\n CPE_NAME=\"cpe:/o:centos:centos:7\"\n HOME_URL=\"https://www.centos.org/\"\n BUG_REPORT_URL=\"https://bugs.centos.org/\"\n \n CENTOS_MANTISBT_PROJECT=\"CentOS-7\"\n CENTOS_MANTISBT_PROJECT_VERSION=\"7\"\n REDHAT_SUPPORT_PRODUCT=\"centos\"\n REDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\n </denchmark-code>\n \n \t"}, "comments": {"comments_0": {"comment_id": 1, "comment_author": "hemantha-kumara", "commentT": "2019-10-07T18:40:36Z", "comment_text": "\n \t\tIssue Label Bot is not confident enough to auto-label this issue.\n See <denchmark-link:https://mlbot.net/data/kubeflow/kubeflow>dashboard</denchmark-link>\n  for more details.\n \t\t"}, "comments_1": {"comment_id": 2, "comment_author": "hemantha-kumara", "commentT": "2019-10-07T18:40:48Z", "comment_text": "\n \t\t/cc <denchmark-link:https://github.com/kkasravi>@kkasravi</denchmark-link>\n \n \t\t"}, "comments_2": {"comment_id": 3, "comment_author": "hemantha-kumara", "commentT": "2019-10-08T00:25:40Z", "comment_text": "\n \t\t/cc <denchmark-link:https://github.com/nrchakradhar>@nrchakradhar</denchmark-link>\n \n \t\t"}, "comments_3": {"comment_id": 4, "comment_author": "hemantha-kumara", "commentT": "2019-10-09T00:00:46Z", "comment_text": "\n \t\t<denchmark-link:https://github.com/hemantha-kumara>@hemantha-kumara</denchmark-link>\n  seems like we want the key to be the patch.name + '-' + patch.target\n do you want to make that change?\n \t\t"}, "comments_4": {"comment_id": 5, "comment_author": "hemantha-kumara", "commentT": "2019-10-09T00:45:07Z", "comment_text": "\n \t\traising this to P0\n /priority P0\n \t\t"}, "comments_5": {"comment_id": 6, "comment_author": "hemantha-kumara", "commentT": "2019-10-09T07:28:15Z", "comment_text": "\n \t\t\n do you want to make that change?\n \n Yes, I can make change. I was waiting for your confirmation that mentioned changes were not meant any other usecase.\n \t\t"}}}, "commit": {"commit_id": "0d65cec23bea1ca8da11d1c04d12d4416d23c7b9", "commit_author": "Hemantha kumara M S", "commitT": "2019-10-22 06:17:22-07:00", "changed_files": {"file_0": {"file_change_type": "MODIFY", "file_Nmethod": 0, "file_old_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "file_new_name": "bootstrap\\pkg\\kfapp\\kustomize\\kustomize.go", "hunks": {"hunk_0": {"Ismethod": 0, "added_lines": "715,716,717,719,827,831,832,833,834,835,836,837", "deleted_lines": "715,717,825"}}}}}}